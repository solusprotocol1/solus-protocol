<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <title>S4 Ledger | Live Network Metrics</title>
    <meta name="description" content="Real-time defense logistics analytics — hash anchoring volume, $SLS fee activity, and network stats from the XRP Ledger.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="s4-assets/style.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stat-box{background:linear-gradient(135deg,rgba(0,170,255,0.08),rgba(26,58,92,0.15));border:1px solid rgba(0,170,255,0.2);border-radius:16px;padding:28px 20px;text-align:center;transition:all 0.4s ease;margin-bottom:20px}
        .stat-box:hover{transform:translateY(-5px);border-color:rgba(0,170,255,0.5);box-shadow:0 15px 40px rgba(0,170,255,0.15)}
        .stat-value{font-size:2.5rem;font-weight:800;background:linear-gradient(135deg,#00aaff,#c9a84c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1.1}
        .stat-label{font-size:0.9rem;color:var(--text-secondary);margin-top:8px;font-weight:500}
        .stat-delta{font-size:0.85rem;color:#4ADE80;margin-top:6px;font-weight:600}
        .live-indicator{display:inline-flex;align-items:center;gap:10px;background:rgba(0,170,255,0.1);padding:10px 20px;border-radius:30px;font-size:0.9rem;font-weight:600;color:var(--accent);border:1px solid rgba(0,170,255,0.3);animation:indicatorGlow 2s ease-in-out infinite}
        @keyframes indicatorGlow{0%,100%{box-shadow:0 0 10px rgba(0,170,255,0.2)}50%{box-shadow:0 0 25px rgba(0,170,255,0.4)}}
        .live-dot{width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--accent)}
        .filter-btn{background:rgba(0,170,255,0.08);color:var(--accent);border:1px solid rgba(0,170,255,0.25);border-radius:10px;padding:10px 18px;margin:4px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s;font-family:inherit}
        .filter-btn:hover{background:rgba(0,170,255,0.15);transform:translateY(-2px)}
        .filter-btn.active{background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border-color:transparent;box-shadow:0 5px 20px rgba(0,170,255,0.3)}
        .filter-select{background:rgba(0,170,255,0.08);color:#fff;border:1px solid rgba(0,170,255,0.25);border-radius:10px;padding:10px 15px;font-weight:500;cursor:pointer;font-family:inherit}
        .filter-select:focus{outline:none;border-color:var(--accent)}
        .filter-select option{background:#050810}
        .export-btn{background:rgba(201,168,76,0.1);color:var(--gold);border:1px solid rgba(201,168,76,0.3);border-radius:12px;padding:12px 24px;cursor:pointer;font-weight:600;font-size:0.9rem;transition:all 0.3s;display:inline-flex;align-items:center;gap:8px;font-family:inherit}
        .export-btn:hover{background:rgba(201,168,76,0.2);transform:translateY(-3px);box-shadow:0 10px 30px rgba(201,168,76,0.2)}
        .recent-table{width:100%;margin-top:20px;border-collapse:collapse}
        .recent-table th{color:var(--accent);padding:15px 12px;border-bottom:2px solid rgba(0,170,255,0.2);text-align:left;font-weight:700;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.5px}
        .recent-table td{padding:14px 12px;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.2s;color:var(--text-secondary)}
        .recent-table tr:hover td{background:rgba(0,170,255,0.03)}
        .badge-type{background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;padding:6px 12px;border-radius:8px;font-size:0.75rem;font-weight:600;text-transform:uppercase}
        @media(max-width:768px){.stat-value{font-size:1.8rem}.d-flex.justify-content-between{flex-direction:column;gap:15px}}
    </style>
</head>
<body>
    <div class="scroll-progress" id="scrollProgress"></div>
    <div class="mesh-bg"><div class="gradient-orb orb-1"></div><div class="gradient-orb orb-2"></div><div class="gradient-orb orb-3"></div></div>
    <div id="particles-js"></div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="./"><img src="s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="nav-logo"><span class="brand-text">S4 Ledger</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><i class="fas fa-bars" style="color:#fff"></i></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="./">Home</a></li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Company</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1);"><li><a class="dropdown-item" href="s4-about/" style="color:#fff;">About Us</a></li><li><a class="dropdown-item" href="s4-investors/" style="color:#fff;">Investors</a></li><li><a class="dropdown-item" href="s4-partners/" style="color:#fff;">Partners</a></li></ul></li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">Products</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1);"><li><a class="dropdown-item" href="demo-app/" style="color:#fff;"><i class="fas fa-play-circle" style="width:18px;margin-right:6px;color:#00aaff;"></i>Demo App</a></li><li><a class="dropdown-item" href="sdk-playground/" style="color:#fff;"><i class="fas fa-code" style="width:18px;margin-right:6px;color:#c9a84c;"></i>SDK Playground</a></li><li><a class="dropdown-item" href="metrics.html" style="color:#fff;font-weight:600;"><i class="fas fa-chart-bar" style="width:18px;margin-right:6px;color:#00aaff;"></i>Live Metrics</a></li><li><a class="dropdown-item" href="transactions.html" style="color:#fff;"><i class="fas fa-list" style="width:18px;margin-right:6px;color:#c9a84c;"></i>Transactions</a></li><li><a class="dropdown-item" href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:#fff;"><i class="fab fa-github" style="width:18px;margin-right:6px;"></i>SDK & Docs</a></li></ul></li>
                    <li class="nav-item"><a class="nav-link" href="s4-use-cases/">Use Cases</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-pricing/">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-roadmap/">Roadmap</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-faq/">FAQ</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-contact/">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <div class="page-hero">
        <h1><i class="fas fa-chart-line" style="margin-right:12px;color:var(--accent)"></i><span class="gradient-text">Network Metrics</span> & Activity</h1>
        <p>Real-time defense logistics analytics from the XRP Ledger</p>
    </div>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <span class="live-indicator"><span class="live-dot"></span> Live &mdash; Auto-refreshing every 5s</span>
            <button class="export-btn" onclick="exportCSV()"><i class="fas fa-download"></i> Export Data</button>
        </div>

        <div class="row mb-4">
            <div class="col-md-3 col-6 mb-3"><div class="stat-box"><div class="stat-value" id="totalHashes">&mdash;</div><div class="stat-label">Total Hashes Anchored</div><div class="stat-delta" id="hashesToday">+0 today</div></div></div>
            <div class="col-md-3 col-6 mb-3"><div class="stat-box"><div class="stat-value" id="totalFees">&mdash;</div><div class="stat-label">Total $SLS Fees</div><div class="stat-delta" id="feesToday">+$0 today</div></div></div>
            <div class="col-md-3 col-6 mb-3"><div class="stat-box"><div class="stat-value" id="recordTypes">&mdash;</div><div class="stat-label">Record Types</div></div></div>
            <div class="col-md-3 col-6 mb-3"><div class="stat-box"><div class="stat-value" id="thisMonth">&mdash;</div><div class="stat-label">Records This Month</div><div class="stat-delta" id="monthGrowth"></div></div></div>
        </div>

        <div class="card reveal">
            <h3 style="margin-bottom:5px;"><i class="fas fa-bolt" style="color:var(--accent);margin-right:8px;"></i> Hash Anchoring Over Time</h3>
            <p style="color:var(--text-secondary);font-size:0.9rem;">Each bar represents hashes anchored during that time period</p>
            <div class="mb-3" id="hashBtns">
                <button class="filter-btn active" data-view="minute">Per Minute</button>
                <button class="filter-btn" data-view="hour">Per Hour</button>
                <button class="filter-btn" data-view="day">Daily</button>
                <button class="filter-btn" data-view="week">Weekly</button>
                <button class="filter-btn" data-view="month">Monthly</button>
            </div>
            <canvas id="hashChart" height="100"></canvas>
        </div>

        <div class="card reveal">
            <h3 style="margin-bottom:5px;"><i class="fas fa-shield-halved" style="color:var(--gold);margin-right:8px;"></i> Records Secured Breakdown</h3>
            <p style="color:var(--text-secondary);font-size:0.9rem;">Distribution of record types anchored to XRPL
                <select class="filter-select" id="recordTypeFilter" onchange="filterByRecordType()">
                    <option value="all">All Record Types</option>
                </select>
                <select class="filter-select" id="platformFilter" style="margin-left:8px" onchange="filterByRecordType()">
                    <option value="all">All Platforms</option>
                </select>
            </p>
            <canvas id="recordChart" height="100"></canvas>
        </div>

        <div class="card reveal">
            <h3 style="margin-bottom:5px;"><i class="fas fa-coins" style="color:var(--gold);margin-right:8px;"></i> $SLS Fee Activity</h3>
            <p style="color:var(--text-secondary);font-size:0.9rem;">Fees collected per time period (0.01 $SLS per anchor)</p>
            <div class="mb-3" id="feeBtns">
                <button class="filter-btn active" data-view="minute">Per Minute</button>
                <button class="filter-btn" data-view="hour">Per Hour</button>
                <button class="filter-btn" data-view="day">Daily</button>
                <button class="filter-btn" data-view="week">Weekly</button>
                <button class="filter-btn" data-view="month">Monthly</button>
            </div>
            <canvas id="feeChart" height="100"></canvas>
        </div>

        <div class="card reveal">
            <h3 style="margin-bottom:5px;"><i class="fas fa-arrow-trend-up" style="color:#ff6b6b;margin-right:8px;"></i> XRPL Transaction Volume</h3>
            <p style="color:var(--text-secondary);font-size:0.9rem;">Number of transactions per time period</p>
            <div class="mb-3" id="txBtns">
                <button class="filter-btn active" data-view="minute">Per Minute</button>
                <button class="filter-btn" data-view="hour">Per Hour</button>
                <button class="filter-btn" data-view="day">Daily</button>
                <button class="filter-btn" data-view="week">Weekly</button>
                <button class="filter-btn" data-view="month">Monthly</button>
            </div>
            <canvas id="txChart" height="100"></canvas>
        </div>

        <div class="card reveal">
            <h3 style="margin-bottom:5px;"><i class="fas fa-list-check" style="color:var(--accent);margin-right:8px;"></i> Recent Anchored Records</h3>
            <p style="color:var(--text-secondary);font-size:0.9rem;">Individual records with exact timestamps</p>
            <div style="max-height:400px;overflow-y:auto;border:1px solid rgba(0,170,255,0.2);border-radius:8px;">
                <table class="recent-table" style="display:table;width:100%;">
                    <thead style="position:sticky;top:0;background:#050810;z-index:1;"><tr><th>Timestamp</th><th>Record Type</th><th>Hash (truncated)</th><th>Fee</th></tr></thead>
                    <tbody id="recentBody"><tr><td colspan="4" style="text-align:center;color:var(--text-secondary);">Loading...</td></tr></tbody>
                </table>
            </div>
            <p style="color:var(--text-muted);font-size:0.85rem;text-align:center;margin-top:12px;">Auto-refreshes every 5 seconds | Showing all activity</p>
        </div>

        <div style="text-align:center;padding:30px 20px;margin-top:30px;border-top:1px solid var(--border);color:var(--text-secondary);font-size:0.9rem;">
            <p><i class="fas fa-satellite-dish" style="color:var(--accent);margin-right:6px;"></i> Data sourced from XRPL public ledger via account <a href="https://livenet.xrpl.org/accounts/r95GyZac4butvVcsTWUPpxzekmyzaHsTA5" target="_blank" style="color:var(--accent);font-family:monospace;">r95GyZac...TA5</a></p>
            <p style="margin-top:5px;">All metrics are real-time and verifiable on-chain. <a href="https://xrpl.org" target="_blank" style="color:var(--gold);">Learn about XRPL &rarr;</a></p>
        </div>

        <!-- ILS Workspace Cross-Link -->
        <div class="card reveal" style="border-color:rgba(0,170,255,0.3);background:linear-gradient(135deg,rgba(0,170,255,0.04),rgba(20,241,149,0.02));text-align:center;margin-top:20px;">
            <h3 style="margin-bottom:8px;"><i class="fas fa-brain" style="color:var(--accent);margin-right:8px;"></i> ILS Workspace</h3>
            <p style="color:var(--text-secondary);font-size:0.88rem;margin-bottom:16px;">20-tool ILS command center — gap analysis, DMSMS, readiness, lifecycle cost, ROI, warranty, parts, action items, calendar, audit vault, doc library, compliance scorecard, provisioning, supply chain risk, audit reports, contracts, digital thread, predictive maintenance, defense database import, integrated logistics insights engine (ILIE) &amp; AI agent.</p>
            <div style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;">
                <a href="demo-app/#tabILS" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;padding:10px 22px;border-radius:10px;text-decoration:none;font-weight:700;font-size:0.9rem;transition:all 0.3s;display:inline-flex;align-items:center;gap:6px;"><i class="fas fa-brain"></i> Open ILS Workspace</a>
                <a href="sdk-playground/" style="background:rgba(201,168,76,0.12);color:var(--gold);border:1px solid rgba(201,168,76,0.3);padding:10px 22px;border-radius:10px;text-decoration:none;font-weight:700;font-size:0.9rem;transition:all 0.3s;display:inline-flex;align-items:center;gap:6px;"><i class="fas fa-code"></i> SDK Playground</a>
            </div>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div style="margin-bottom:12px;"><img src="s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="footer-logo"><span style="font-weight:700;font-size:1.1rem;">S4 Ledger</span><span style="color:var(--text-muted);margin-left:5px;">&mdash; Secure Logistics Standard</span></div>
            <p style="font-size:0.82rem;margin-bottom:10px;">Immutable logistics verification for the defense industry. Built on the XRP Ledger.</p>
            <div style="margin-bottom:10px;"><a href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:var(--text-muted);margin:0 10px;text-decoration:none;"><i class="fab fa-github fa-lg"></i></a><a href="https://x.com/S4_Ledger" target="_blank" style="color:var(--text-muted);margin:0 10px;text-decoration:none;"><i class="fab fa-x-twitter fa-lg"></i></a><a href="https://linkedin.com" target="_blank" style="color:var(--text-muted);margin:0 10px;text-decoration:none;"><i class="fab fa-linkedin fa-lg"></i></a></div>
            <div style="margin-bottom:10px;font-size:0.78rem;"><a href="s4-terms/" style="color:var(--text-muted);margin:0 10px;text-decoration:none;">Terms of Service</a><a href="s4-privacy/" style="color:var(--text-muted);margin:0 10px;text-decoration:none;">Privacy Policy</a><a href="security/" style="color:var(--text-muted);margin:0 10px;text-decoration:none;">Security</a></div>
            <p style="font-size:0.75rem;color:var(--text-muted);">$SLS is a utility token &mdash; not equity or an investment contract. &copy; 2026 S4 Ledger.</p>
        </div>
    </footer>

    <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="s4-assets/main.js"></script>
    <script>
        // ── localStorage cross-page record sync ──
        const S4_STORAGE_KEY = 's4_anchored_records';
        function getLocalRecords() { try { return JSON.parse(localStorage.getItem(S4_STORAGE_KEY) || '[]'); } catch { return []; } }

        let metricsData = null;
        let hashChart, recordChart, feeChart, txChart;
        let currentHashView = 'minute', currentFeeView = 'minute', currentTxView = 'minute';
        let selectedRecordType = 'all';

        async function loadMetrics() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                const response = await fetch('/api/metrics', { signal: controller.signal });
                clearTimeout(timeoutId);
                metricsData = await response.json();

                // Merge locally-anchored records from localStorage
                const localRecs = getLocalRecords();
                if (localRecs.length > 0) {
                    metricsData.total_hashes = (metricsData.total_hashes || 0) + localRecs.length;
                    metricsData.total_fees = +((metricsData.total_fees || 0) + localRecs.length * 0.01).toFixed(2);
                    metricsData.individual_records = [...(metricsData.individual_records || []), ...localRecs];
                    if (!metricsData.records_by_type) metricsData.records_by_type = {};
                    if (!metricsData.records_by_branch) metricsData.records_by_branch = {};
                    for (const r of localRecs) {
                        const label = r.record_label || r.record_type || 'Unknown';
                        metricsData.records_by_type[label] = (metricsData.records_by_type[label] || 0) + 1;
                        metricsData.records_by_branch[r.branch || 'JOINT'] = (metricsData.records_by_branch[r.branch || 'JOINT'] || 0) + 1;
                        // Add to time-series for day view
                        try {
                            const ts = new Date(r.timestamp);
                            const dayKey = ts.toLocaleDateString('en-US', { month: 'short', day: '2-digit' });
                            if (!metricsData.hashes_by_day) metricsData.hashes_by_day = {};
                            if (!metricsData.fees_by_day) metricsData.fees_by_day = {};
                            metricsData.hashes_by_day[dayKey] = (metricsData.hashes_by_day[dayKey] || 0) + 1;
                            metricsData.fees_by_day[dayKey] = +((metricsData.fees_by_day[dayKey] || 0) + 0.01).toFixed(4);
                        } catch(e) {}
                    }
                }

                document.getElementById('totalHashes').textContent = metricsData.total_hashes || 0;
                document.getElementById('totalFees').textContent = (metricsData.total_fees || 0).toFixed(2);
                document.getElementById('recordTypes').textContent = Object.keys(metricsData.records_by_type || {}).length;
                const hashesToday = metricsData.hashes_today || 0;
                const feesToday = metricsData.fees_today || 0;
                document.getElementById('hashesToday').textContent = '+' + hashesToday + ' today';
                document.getElementById('feesToday').textContent = '+$' + feesToday.toFixed(2) + ' today';
                const thisMonth = metricsData.this_month || 0;
                document.getElementById('thisMonth').textContent = thisMonth;
                rebuildRecordTypeFilter();
                renderHashChart(currentHashView);
                renderRecordChart();
                renderFeeChart(currentFeeView);
                renderTxChart(currentTxView);
                renderRecentTable();
            } catch (err) {
                console.warn('Metrics load issue, loading from localStorage:', err.message);
                // Fallback: build metrics entirely from localStorage records
                const localRecs = getLocalRecords();
                if (!metricsData) metricsData = { total_hashes: 0, total_fees: 0, records_by_type: {}, records_by_branch: {}, individual_records: [], hashes_today: 0, fees_today: 0, this_month: 0, hashes_by_minute: {}, hashes_by_hour: {}, hashes_by_day: {}, hashes_by_week: {}, hashes_by_month: {}, fees_by_minute: {}, fees_by_hour: {}, fees_by_day: {}, fees_by_week: {}, fees_by_month: {} };
                const now = new Date();
                const todayStr = now.toLocaleDateString('en-US');
                const monthStr = now.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                if (localRecs.length > 0) {
                    metricsData.total_hashes = localRecs.length;
                    metricsData.total_fees = +(localRecs.length * 0.01).toFixed(2);
                    metricsData.individual_records = localRecs;
                    for (const r of localRecs) {
                        const label = r.record_label || r.record_type || 'Unknown';
                        metricsData.records_by_type[label] = (metricsData.records_by_type[label] || 0) + 1;
                        metricsData.records_by_branch[r.branch || 'JOINT'] = (metricsData.records_by_branch[r.branch || 'JOINT'] || 0) + 1;
                        try {
                            const ts = new Date(r.timestamp);
                            const dayKey = ts.toLocaleDateString('en-US', { month: 'short', day: '2-digit' });
                            const hourKey = ts.toLocaleTimeString('en-US', { hour: '2-digit', hour12: false }) + ':00';
                            const minKey = ts.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
                            const weekKey = 'Week ' + Math.ceil(ts.getDate() / 7);
                            const monKey = ts.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                            metricsData.hashes_by_day[dayKey] = (metricsData.hashes_by_day[dayKey] || 0) + 1;
                            metricsData.hashes_by_hour[hourKey] = (metricsData.hashes_by_hour[hourKey] || 0) + 1;
                            metricsData.hashes_by_minute[minKey] = (metricsData.hashes_by_minute[minKey] || 0) + 1;
                            metricsData.hashes_by_week[weekKey] = (metricsData.hashes_by_week[weekKey] || 0) + 1;
                            metricsData.hashes_by_month[monKey] = (metricsData.hashes_by_month[monKey] || 0) + 1;
                            metricsData.fees_by_day[dayKey] = +((metricsData.fees_by_day[dayKey] || 0) + 0.01).toFixed(4);
                            metricsData.fees_by_hour[hourKey] = +((metricsData.fees_by_hour[hourKey] || 0) + 0.01).toFixed(4);
                            metricsData.fees_by_minute[minKey] = +((metricsData.fees_by_minute[minKey] || 0) + 0.01).toFixed(4);
                            metricsData.fees_by_week[weekKey] = +((metricsData.fees_by_week[weekKey] || 0) + 0.01).toFixed(4);
                            metricsData.fees_by_month[monKey] = +((metricsData.fees_by_month[monKey] || 0) + 0.01).toFixed(4);
                            if (ts.toLocaleDateString('en-US') === todayStr) { metricsData.hashes_today++; metricsData.fees_today = +((metricsData.fees_today || 0) + 0.01).toFixed(2); }
                            if (ts.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }) === monthStr) metricsData.this_month++;
                        } catch(e) {}
                    }
                }
                document.getElementById('totalHashes').textContent = metricsData.total_hashes || 0;
                document.getElementById('totalFees').textContent = (metricsData.total_fees || 0).toFixed(2);
                document.getElementById('recordTypes').textContent = Object.keys(metricsData.records_by_type || {}).length;
                document.getElementById('hashesToday').textContent = '+' + (metricsData.hashes_today || 0) + ' today';
                document.getElementById('feesToday').textContent = '+$' + (metricsData.fees_today || 0).toFixed(2) + ' today';
                document.getElementById('thisMonth').textContent = metricsData.this_month || 0;
                rebuildRecordTypeFilter();
                renderHashChart(currentHashView);
                renderRecordChart();
                renderFeeChart(currentFeeView);
                renderTxChart(currentTxView);
                renderRecentTable();
            } finally {
                // Guarantee the "Loading..." text is always cleared
                try {
                    const tbody = document.getElementById('recentBody');
                    if (tbody && tbody.innerHTML.includes('Loading')) {
                        if (!metricsData) metricsData = { individual_records: [] };
                        renderRecentTable();
                    }
                } catch(e) {
                    document.getElementById('recentBody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No records available</td></tr>';
                }
            }
        }

        function filterByRecordType() { selectedRecordType = document.getElementById('recordTypeFilter').value; renderRecordChart(); renderRecentTable(); }

        // Rebuild record type and platform filter dropdowns from current data
        function rebuildRecordTypeFilter() {
            const filterSelect = document.getElementById('recordTypeFilter');
            const prevVal = filterSelect.value;
            // Clear all options except "All Record Types"
            filterSelect.innerHTML = '<option value="all">All Record Types</option>';
            const types = Object.keys(metricsData.records_by_type || {}).sort();
            types.forEach(type => { const o = document.createElement('option'); o.value = type; o.textContent = type; filterSelect.appendChild(o); });
            // Restore previous selection if still valid
            if (types.includes(prevVal)) filterSelect.value = prevVal;
            else { selectedRecordType = 'all'; filterSelect.value = 'all'; }

            // Rebuild platform filter
            const platSelect = document.getElementById('platformFilter');
            const prevPlat = platSelect.value;
            platSelect.innerHTML = '<option value="all">All Platforms</option>';
            const branches = Object.keys(metricsData.records_by_branch || {}).sort();
            branches.forEach(b => { const o = document.createElement('option'); o.value = b; o.textContent = b; platSelect.appendChild(o); });
            if (branches.includes(prevPlat)) platSelect.value = prevPlat;
        }

        function exportCSV() {
            if (!metricsData || !metricsData.individual_records) { alert('No data available to export'); return; }
            const records = metricsData.individual_records;
            const headers = ['Timestamp', 'Record Type', 'Hash', 'Fee ($SLS)', 'TX Hash'];
            const csvRows = [headers.join(',')];
            records.forEach(r => { csvRows.push(['"' + r.timestamp_display + '"', '"' + r.record_type + '"', '"' + r.hash + '"', r.fee, '"' + (r.tx_hash || '') + '"'].join(',')); });
            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 's4_ledger_metrics_' + new Date().toISOString().split('T')[0] + '.csv';
            link.click();
        }

        function getDataForView(baseKey, view) { return metricsData[baseKey + '_by_' + view] || {}; }

        const chartGrid = '#1a2a3a';
        const chartTick = '#6b7d93';

        function renderHashChart(view) {
            const data = getDataForView('hashes', view);
            const labels = Object.keys(data), values = Object.values(data);
            const ctx = document.getElementById('hashChart').getContext('2d');
            if (hashChart) hashChart.destroy();
            hashChart = new Chart(ctx, { type: 'bar', data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: 'Hashes', data: values.length ? values : [0], backgroundColor: '#00aaff', borderRadius: 4 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: chartGrid }, ticks: { color: chartTick } }, y: { grid: { color: chartGrid }, ticks: { color: chartTick, stepSize: 1 }, beginAtZero: true } } } });
        }

        function renderRecordChart() {
            let data = metricsData.records_by_type || {};
            if (selectedRecordType !== 'all') { data = { [selectedRecordType]: data[selectedRecordType] || 0 }; }
            const labels = Object.keys(data), values = Object.values(data);
            const colors = ['#00aaff', '#c9a84c', '#ff6b6b', '#ffa502', '#3742fa', '#2ed573', '#ff6b81', '#70a1ff', '#eccc68', '#a29bfe', '#fd79a8', '#00cec9', '#55efc4', '#74b9ff', '#fab1a0', '#8ea4b8', '#ffeaa7', '#81ecec'];
            const ctx = document.getElementById('recordChart').getContext('2d');
            if (recordChart) recordChart.destroy();
            recordChart = new Chart(ctx, { type: 'doughnut', data: { labels: labels.length ? labels : ['No records'], datasets: [{ data: values.length ? values : [1], backgroundColor: labels.length ? colors.slice(0, labels.length) : ['#333'], borderWidth: 0 }] }, options: { responsive: true, plugins: { legend: { display: true, position: 'right', labels: { color: '#fff' } } } } });
        }

        function renderFeeChart(view) {
            const data = getDataForView('fees', view);
            const labels = Object.keys(data), values = Object.values(data);
            const ctx = document.getElementById('feeChart').getContext('2d');
            if (feeChart) feeChart.destroy();
            feeChart = new Chart(ctx, { type: 'line', data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: '$SLS Fees', data: values.length ? values : [0], borderColor: '#c9a84c', backgroundColor: 'rgba(201,168,76,0.2)', fill: true, tension: 0.3, pointRadius: 6, pointBackgroundColor: '#c9a84c' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: chartGrid }, ticks: { color: chartTick } }, y: { grid: { color: chartGrid }, ticks: { color: chartTick }, beginAtZero: true } } } });
        }

        function renderTxChart(view) {
            const data = getDataForView('hashes', view);
            const labels = Object.keys(data), values = Object.values(data);
            const ctx = document.getElementById('txChart').getContext('2d');
            if (txChart) txChart.destroy();
            txChart = new Chart(ctx, { type: 'line', data: { labels: labels.length ? labels : ['No data'], datasets: [{ label: 'Transactions', data: values.length ? values : [0], borderColor: '#ff6b6b', backgroundColor: 'rgba(255,107,107,0.2)', fill: true, tension: 0.3, pointRadius: 6, pointBackgroundColor: '#ff6b6b' }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { x: { grid: { color: chartGrid }, ticks: { color: chartTick } }, y: { grid: { color: chartGrid }, ticks: { color: chartTick, stepSize: 1 }, beginAtZero: true } } } });
        }

        function renderRecentTable() {
            let records = metricsData.individual_records || [];
            const tbody = document.getElementById('recentBody');
            if (records.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No records found</td></tr>'; return; }
            if (selectedRecordType !== 'all') { records = records.filter(r => (r.record_label || r.record_type) === selectedRecordType); }
            const recent = [...records].reverse().slice(0, 50);
            if (recent.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No records for selected type</td></tr>'; return; }
            tbody.innerHTML = recent.map(r => { const label = r.record_label || r.record_type || 'Unknown'; return '<tr><td style="color:#00aaff;">' + (r.timestamp_display || '') + '</td><td><span class="badge-type">' + label + '</span></td><td style="font-family:monospace;font-size:0.85rem;color:var(--text-secondary);">' + (r.hash || '').substring(0,24) + '...</td><td style="color:#c9a84c;">$' + (r.fee || 0.01).toFixed(2) + '</td></tr>'; }).join('');
        }

        document.getElementById('hashBtns').addEventListener('click', e => { if (e.target.dataset.view) { currentHashView = e.target.dataset.view; document.querySelectorAll('#hashBtns .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentHashView)); renderHashChart(currentHashView); } });
        document.getElementById('feeBtns').addEventListener('click', e => { if (e.target.dataset.view) { currentFeeView = e.target.dataset.view; document.querySelectorAll('#feeBtns .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentFeeView)); renderFeeChart(currentFeeView); } });
        document.getElementById('txBtns').addEventListener('click', e => { if (e.target.dataset.view) { currentTxView = e.target.dataset.view; document.querySelectorAll('#txBtns .filter-btn').forEach(b => b.classList.toggle('active', b.dataset.view === currentTxView)); renderTxChart(currentTxView); } });

        // ── Cross-page sync: instantly update when records are anchored elsewhere ──
        window.addEventListener('storage', (e) => {
            if (e.key === S4_STORAGE_KEY) loadMetrics();
        });

        window.addEventListener('DOMContentLoaded', loadMetrics);
        setInterval(loadMetrics, 5000);
    </script>
<link rel="stylesheet" href="/s4-assets/s4-mobile.css">
<script src="s4-assets/s4-background.js"></script>
</body>
</html>
