<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S4 Ledger | Live XRPL Transactions</title>
    <meta name="description" content="Real-time anchored defense logistics record hashes on the XRP Ledger â€” browse transactions across all military branches.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="s4-assets/style.css">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <style>
        .live-indicator{display:inline-flex;align-items:center;gap:10px;background:rgba(0,170,255,0.1);padding:10px 20px;border-radius:30px;font-size:0.9rem;font-weight:600;color:var(--accent);border:1px solid rgba(0,170,255,0.3);animation:indicatorGlow 2s ease-in-out infinite}
        @keyframes indicatorGlow{0%,100%{box-shadow:0 0 10px rgba(0,170,255,0.2)}50%{box-shadow:0 0 25px rgba(0,170,255,0.4)}}
        .live-dot{width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 10px var(--accent);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .stat-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}
        .stat-box{background:linear-gradient(135deg,rgba(0,170,255,0.08),rgba(26,58,92,0.15));border:1px solid rgba(0,170,255,0.2);border-radius:16px;padding:20px;text-align:center;transition:all 0.3s}
        .stat-box:hover{transform:translateY(-3px);border-color:rgba(0,170,255,0.5)}
        .stat-value{font-size:2rem;font-weight:800;background:linear-gradient(135deg,#00aaff,#c9a84c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .stat-label{font-size:0.82rem;color:var(--text-secondary);margin-top:4px;font-weight:500}
        .filter-bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:20px}
        .filter-select{background:rgba(0,170,255,0.08);color:#fff;border:1px solid rgba(0,170,255,0.25);border-radius:10px;padding:8px 14px;font-weight:500;cursor:pointer;font-family:inherit;font-size:0.85rem}
        .filter-select:focus{outline:none;border-color:var(--accent)}
        .filter-select option,.filter-select optgroup{background:#050810}
        .search-input{background:rgba(0,170,255,0.08);color:#fff;border:1px solid rgba(0,170,255,0.25);border-radius:10px;padding:8px 14px;font-family:inherit;font-size:0.85rem;flex:1;min-width:200px}
        .search-input:focus{outline:none;border-color:var(--accent)}
        .search-input::placeholder{color:var(--text-muted)}
        .tx-table-wrap{border:1px solid rgba(0,170,255,0.15);border-radius:12px;overflow:hidden}
        .tx-table{width:100%;border-collapse:collapse}
        .tx-table thead{background:rgba(0,170,255,0.06);position:sticky;top:0;z-index:1}
        .tx-table th{padding:14px 12px;font-size:0.8rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent);font-weight:700;text-align:left;border-bottom:2px solid rgba(0,170,255,0.2)}
        .tx-table td{padding:12px;border-bottom:1px solid rgba(255,255,255,0.04);font-size:0.88rem;color:var(--text-secondary);transition:background 0.2s}
        .tx-table tr:hover td{background:rgba(0,170,255,0.03)}
        .tx-hash{font-family:'Monaco','Menlo',monospace;font-size:0.78rem;color:var(--accent);cursor:pointer;transition:color 0.2s}
        .tx-hash:hover{color:#fff;text-decoration:underline}
        .branch-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;white-space:nowrap}
        .type-badge{background:rgba(0,170,255,0.12);color:var(--accent);padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;white-space:nowrap}
        .fee-badge{color:#c9a84c;font-weight:700;font-family:monospace}
        .explorer-link{color:var(--accent);text-decoration:none;font-size:0.8rem;transition:color 0.2s}
        .explorer-link:hover{color:#fff}
        .pagination-bar{display:flex;justify-content:center;align-items:center;gap:12px;margin-top:20px;padding:16px 0}
        .page-btn{background:rgba(0,170,255,0.08);color:var(--accent);border:1px solid rgba(0,170,255,0.25);border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.2s;font-family:inherit}
        .page-btn:hover:not(:disabled){background:rgba(0,170,255,0.15);transform:translateY(-1px)}
        .page-btn:disabled{opacity:0.3;cursor:not-allowed}
        .page-info{color:var(--text-muted);font-size:0.85rem}
        .export-btn{background:rgba(201,168,76,0.1);color:var(--gold);border:1px solid rgba(201,168,76,0.3);border-radius:10px;padding:8px 18px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.3s;display:inline-flex;align-items:center;gap:6px;font-family:inherit}
        .export-btn:hover{background:rgba(201,168,76,0.2);transform:translateY(-2px)}
        .no-data{text-align:center;padding:40px 20px;color:var(--text-muted);font-size:1rem}
        .scroll-container{max-height:700px;overflow-y:auto}
        @media(max-width:768px){.stat-value{font-size:1.4rem}.tx-table{font-size:0.82rem}.tx-table th,.tx-table td{padding:8px 6px}}
    </style>
</head>
<body>
    <div class="scroll-progress" id="scrollProgress"></div>
    <div class="mesh-bg"><div class="gradient-orb orb-1"></div><div class="gradient-orb orb-2"></div><div class="gradient-orb orb-3"></div></div>
    <div id="particles-js"></div>

    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="./"><img src="s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="nav-logo"><span class="brand-text">S4 Ledger</span></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><i class="fas fa-bars" style="color:#fff"></i></button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="./">Home</a></li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Company</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1);"><li><a class="dropdown-item" href="s4-about/" style="color:#fff;">About Us</a></li><li><a class="dropdown-item" href="s4-investors/" style="color:#fff;">Investors</a></li><li><a class="dropdown-item" href="s4-partners/" style="color:#fff;">Partners</a></li></ul></li>
                    <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">Products</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1);"><li><a class="dropdown-item" href="demo-app/" style="color:#fff;"><i class="fas fa-play-circle" style="width:18px;margin-right:6px;color:#00aaff;"></i>Demo App</a></li><li><a class="dropdown-item" href="sdk-playground/" style="color:#fff;"><i class="fas fa-code" style="width:18px;margin-right:6px;color:#c9a84c;"></i>SDK Playground</a></li><li><a class="dropdown-item" href="metrics.html" style="color:#fff;"><i class="fas fa-chart-bar" style="width:18px;margin-right:6px;color:#00aaff;"></i>Live Metrics</a></li><li><a class="dropdown-item" href="#" style="color:#fff;font-weight:600;"><i class="fas fa-list" style="width:18px;margin-right:6px;color:#c9a84c;"></i>Transactions</a></li><li><a class="dropdown-item" href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:#fff;"><i class="fab fa-github" style="width:18px;margin-right:6px;"></i>SDK & Docs</a></li></ul></li>
                    <li class="nav-item"><a class="nav-link" href="s4-use-cases/">Use Cases</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-pricing/">Pricing</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-roadmap/">Roadmap</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-faq/">FAQ</a></li>
                    <li class="nav-item"><a class="nav-link" href="s4-contact/">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <div class="page-hero">
        <h1><i class="fas fa-link" style="margin-right:12px;color:var(--accent)"></i><span class="gradient-text">XRPL</span> Transactions</h1>
        <p>Browse every defense record anchored to the XRP Ledger in real time</p>
    </div>

    <div class="container">
        <!-- Live indicator + stats -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <span class="live-indicator"><span class="live-dot"></span> Live &mdash; Auto-refreshing every 30s</span>
            <button class="export-btn" onclick="exportTxCSV()"><i class="fas fa-download"></i> Export CSV</button>
        </div>

        <div class="stat-row">
            <div class="stat-box"><div class="stat-value" id="totalTx">&mdash;</div><div class="stat-label">Total Transactions</div></div>
            <div class="stat-box"><div class="stat-value" id="totalFees">&mdash;</div><div class="stat-label">Total $SLS Fees</div></div>
            <div class="stat-box"><div class="stat-value" id="branchCount">&mdash;</div><div class="stat-label">Military Branches</div></div>
            <div class="stat-box"><div class="stat-value" id="typeCount">&mdash;</div><div class="stat-label">Record Types</div></div>
        </div>

        <!-- Filters -->
        <div class="card reveal">
            <div class="filter-bar">
                <select class="filter-select" id="branchFilter" onchange="applyFilters()">
                    <option value="all">All Branches</option>
                </select>
                <select class="filter-select" id="typeFilter" onchange="applyFilters()">
                    <option value="all">All Record Types</option>
                </select>
                <input type="text" class="search-input" id="searchInput" placeholder="Search by hash, type, or system..." oninput="applyFilters()">
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="card reveal">
            <div class="scroll-container">
                <div class="tx-table-wrap">
                    <table class="tx-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Branch</th>
                                <th>Record Type</th>
                                <th>System</th>
                                <th>Hash</th>
                                <th>TX Hash</th>
                                <th>Fee</th>
                                <th>Explorer</th>
                            </tr>
                        </thead>
                        <tbody id="txBody">
                            <tr><td colspan="8" class="no-data"><i class="fas fa-spinner fa-spin"></i> Loading transactions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="pagination-bar">
                <button class="page-btn" id="prevBtn" onclick="changePage(-1)" disabled><i class="fas fa-chevron-left"></i> Previous</button>
                <span class="page-info" id="pageInfo">Page 1</span>
                <button class="page-btn" id="nextBtn" onclick="changePage(1)">Next <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div style="text-align:center;padding:24px 20px;color:var(--text-secondary);font-size:0.9rem;">
            <p><i class="fas fa-satellite-dish" style="color:var(--accent);margin-right:6px;"></i> Data sourced from XRPL public ledger via account <a href="https://testnet.xrpl.org/accounts/rJPqcx8wUBM58ajPUoz1dReKkTT6hqrqJA" target="_blank" style="color:var(--accent);font-family:monospace;">rJPqcx8w...qJA</a></p>
            <p style="margin-top:5px;">All transactions are verifiable on-chain. <a href="https://xrpl.org" target="_blank" style="color:var(--gold);">Learn about XRPL &rarr;</a></p>
        </div>
    </div>

    <!-- FOOTER -->
    <footer>
        <div class="container">
            <div style="margin-bottom:12px;"><img src="s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="footer-logo"><span style="font-weight:700;font-size:1.1rem;">S4 Ledger</span><span style="color:var(--text-muted);margin-left:5px;">&mdash; Secure Logistics Standard</span></div>
            <p style="font-size:0.82rem;margin-bottom:10px;">Immutable logistics verification for the defense industry. Built on the XRP Ledger.</p>
            <div style="margin-bottom:10px;"><a href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:var(--text-muted);margin:0 10px;text-decoration:none;"><i class="fab fa-github fa-lg"></i></a><a href="https://x.com/S4_Ledger" target="_blank" style="color:var(--text-muted);margin:0 10px;text-decoration:none;"><i class="fab fa-x-twitter fa-lg"></i></a><a href="https://linkedin.com" target="_blank" style="color:var(--text-muted);margin:0 10px;text-decoration:none;"><i class="fab fa-linkedin fa-lg"></i></a></div>
            <div style="margin-bottom:10px;font-size:0.78rem;"><a href="s4-terms/" style="color:var(--text-muted);margin:0 10px;text-decoration:none;">Terms of Service</a><a href="s4-privacy/" style="color:var(--text-muted);margin:0 10px;text-decoration:none;">Privacy Policy</a><a href="security/" style="color:var(--text-muted);margin:0 10px;text-decoration:none;">Security</a></div>
            <p style="font-size:0.75rem;color:var(--text-muted);">$SLS is a utility token &mdash; not equity or an investment contract. &copy; 2026 S4 Ledger.</p>
        </div>
    </footer>

    <button class="back-to-top" id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})">&#8593;</button>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="s4-assets/main.js"></script>
    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  S4 LEDGER â€” LIVE TRANSACTIONS PAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ localStorage cross-page record sync â”€â”€
    const S4_STORAGE_KEY = 's4_anchored_records';
    function getLocalRecords() { try { return JSON.parse(localStorage.getItem(S4_STORAGE_KEY) || '[]'); } catch { return []; } }

    const BRANCH_COLORS = {
        USN:   { bg: 'rgba(0,59,111,0.25)', color: '#66aaff', label: 'Navy' },
        USA:   { bg: 'rgba(75,83,32,0.25)', color: '#9acd32', label: 'Army' },
        USAF:  { bg: 'rgba(0,48,143,0.25)', color: '#6699ff', label: 'Air Force' },
        USMC:  { bg: 'rgba(204,0,0,0.25)',  color: '#ff6666', label: 'Marines' },
        USCG:  { bg: 'rgba(0,51,102,0.25)', color: '#6699cc', label: 'Coast Guard' },
        DLA:   { bg: 'rgba(26,58,92,0.25)', color: '#8ab4d8', label: 'DLA' },
        JOINT: { bg: 'rgba(74,74,74,0.25)', color: '#aaaaaa', label: 'Joint' },
        SOCOM: { bg: 'rgba(45,45,45,0.25)', color: '#999999', label: 'SOCOM' },
    };

    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    const PAGE_SIZE = 50;
    let branchesPopulated = false;

    async function loadTransactions() {
        try {
            const res = await fetch('/api/transactions');
            const data = await res.json();
            allTransactions = data.transactions || [];

            // Merge locally-anchored records from localStorage
            const localRecs = getLocalRecords();
            if (localRecs.length > 0) {
                allTransactions = [...localRecs.map(r => ({...r, _local: true})).reverse(), ...allTransactions];
            }

            // Stats
            document.getElementById('totalTx').textContent = (data.total || allTransactions.length).toLocaleString();
            document.getElementById('totalFees').textContent = '$' + ((data.total || allTransactions.length) * 0.01).toFixed(2);

            const branches = new Set(allTransactions.map(t => t.branch));
            const types = new Set(allTransactions.map(t => t.record_label || t.record_type));
            document.getElementById('branchCount').textContent = branches.size;
            document.getElementById('typeCount').textContent = types.size;

            // Populate filters once
            if (!branchesPopulated) {
                const branchSelect = document.getElementById('branchFilter');
                branches.forEach(b => {
                    const info = BRANCH_COLORS[b] || { label: b };
                    const opt = document.createElement('option');
                    opt.value = b;
                    opt.textContent = info.label;
                    branchSelect.appendChild(opt);
                });

                const typeSelect = document.getElementById('typeFilter');
                const sortedTypes = [...types].sort();
                sortedTypes.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    typeSelect.appendChild(opt);
                });
                branchesPopulated = true;
            }

            applyFilters();
        } catch (err) {
            console.error('Failed to load transactions:', err);
            document.getElementById('txBody').innerHTML = '<tr><td colspan="8" class="no-data"><i class="fas fa-exclamation-triangle" style="color:#ff6b6b;"></i> Failed to load transactions. Check API connection.</td></tr>';
        }
    }

    function applyFilters() {
        const branch = document.getElementById('branchFilter').value;
        const type = document.getElementById('typeFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();

        filteredTransactions = allTransactions.filter(tx => {
            if (branch !== 'all' && tx.branch !== branch) return false;
            const label = tx.record_label || tx.record_type || '';
            if (type !== 'all' && label !== type) return false;
            if (search) {
                const searchable = [
                    tx.hash, tx.tx_hash, label, tx.system, tx.branch, tx.timestamp_display
                ].join(' ').toLowerCase();
                if (!searchable.includes(search)) return false;
            }
            return true;
        });

        currentPage = 1;
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('txBody');
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const pageData = filteredTransactions.slice(start, end);
        const totalPages = Math.max(1, Math.ceil(filteredTransactions.length / PAGE_SIZE));

        if (pageData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="no-data">No transactions match your filters.</td></tr>';
        } else {
            tbody.innerHTML = pageData.map(tx => {
                const bc = BRANCH_COLORS[tx.branch] || { bg: 'rgba(100,100,100,0.2)', color: '#999', label: tx.branch };
                const hashShort = (tx.hash || '').substring(0, 12) + '...';
                const txHashShort = (tx.tx_hash || '').substring(0, 14) + '...';
                const label = tx.record_label || tx.record_type || 'Unknown';
                const icon = tx.icon || 'ðŸ“‹';
                const explorerUrl = 'https://testnet.xrpl.org/transactions/' + (tx.tx_hash || '');
                return `<tr>
                    <td style="color:var(--accent);white-space:nowrap;font-size:0.82rem;">${tx.timestamp_display || ''}</td>
                    <td><span class="branch-badge" style="background:${bc.bg};color:${bc.color};">${icon} ${bc.label}</span></td>
                    <td><span class="type-badge">${label}</span></td>
                    <td style="font-size:0.82rem;color:var(--text-muted);">${tx.system || 'N/A'}</td>
                    <td><span class="tx-hash" title="${tx.hash}" onclick="copyHash('${tx.hash}')">${hashShort}</span></td>
                    <td><span class="tx-hash" title="${tx.tx_hash}" onclick="copyHash('${tx.tx_hash}')">${txHashShort}</span></td>
                    <td><span class="fee-badge">$${(tx.fee || 0.01).toFixed(2)}</span></td>
                    <td><a href="${explorerUrl}" target="_blank" class="explorer-link"><i class="fas fa-external-link-alt"></i></a></td>
                </tr>`;
            }).join('');
        }

        // Pagination
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages} (${filteredTransactions.length} records)`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredTransactions.length / PAGE_SIZE);
        currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
        renderTable();
        // Scroll to top of table
        document.querySelector('.tx-table-wrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function copyHash(hash) {
        navigator.clipboard.writeText(hash).then(() => {
            // Brief visual feedback
            const el = event.target;
            const orig = el.textContent;
            el.textContent = 'Copied!';
            el.style.color = '#14f195';
            setTimeout(() => { el.textContent = orig; el.style.color = ''; }, 1200);
        });
    }

    function exportTxCSV() {
        if (filteredTransactions.length === 0) { alert('No transactions to export.'); return; }
        const headers = ['Timestamp', 'Branch', 'Record Type', 'System', 'Hash', 'TX Hash', 'Fee ($SLS)'];
        const rows = [headers.join(',')];
        filteredTransactions.forEach(tx => {
            rows.push([
                '"' + (tx.timestamp_display || '') + '"',
                '"' + (tx.branch || '') + '"',
                '"' + (tx.record_label || tx.record_type || '') + '"',
                '"' + (tx.system || '') + '"',
                '"' + (tx.hash || '') + '"',
                '"' + (tx.tx_hash || '') + '"',
                (tx.fee || 0.01).toFixed(2)
            ].join(','));
        });
        const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 's4_transactions_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
    }

    // â”€â”€ Init â”€â”€
    window.addEventListener('DOMContentLoaded', loadTransactions);
    setInterval(loadTransactions, 30000);
    </script>
</body>
</html>