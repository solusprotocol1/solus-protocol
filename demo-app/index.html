<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="description" content="S4 Ledger Defense Logistics Demo — Anchor, verify, and track defense records across all military branches on XRPL.">
    <title>S4 Ledger | Defense Logistics Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Nautical Anchor Canvas Animation -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="/s4-assets/platforms.js"></script>
    <script src="/s4-assets/defense-docs.js"></script>
    <style>
        :root{--bg:#050810;--surface:#0a1020;--card:#0f1630;--border:#1a2550;--accent:#00aaff;--gold:#c9a84c;--steel:#8ea4b8;--green:#14f195;--red:#ff6b6b;--text:#e0e8f0;--muted:#6b7d93}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .navbar-custom{background:rgba(5,8,16,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:10px 0;position:fixed;top:0;width:100%;z-index:1000}
        .navbar-brand{font-weight:700;display:flex;align-items:center;gap:10px;text-decoration:none}
        .brand-text{background:linear-gradient(135deg,#00aaff,#ffffff,#c9a84c);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:brandGradient 4s ease infinite;font-size:1.2rem;letter-spacing:0.5px}
        .nav-link{color:#fff!important;padding:8px 12px!important;font-size:0.9rem!important;font-weight:500;transition:color 0.2s}
        .nav-link:hover,.nav-link.active{color:var(--accent)!important}
        .hero{padding:7.5rem 0 3rem;text-align:center;background:linear-gradient(180deg,rgba(0,170,255,0.05) 0%,transparent 60%)}
        .hero h1{font-size:2.4rem;font-weight:800;margin-bottom:0.75rem}.hero h1 .accent{color:var(--accent)}.hero h1 .gold{color:var(--gold)}
        .hero p{color:var(--steel);font-size:1.1rem;max-width:700px;margin:0 auto 1.5rem}
        .badge-live{display:inline-flex;align-items:center;gap:6px;background:rgba(20,241,149,0.1);border:1px solid rgba(20,241,149,0.3);color:var(--green);padding:6px 16px;border-radius:20px;font-size:0.85rem;font-weight:600}
        .badge-live::before{content:'';width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .tab-section{padding:2rem 0}
        .nav-pills .nav-link{background:var(--card);color:var(--steel)!important;border:1px solid var(--border);margin-right:0.5rem;margin-bottom:0.5rem;border-radius:8px;font-weight:600;padding:0.6rem 1.2rem;transition:all 0.2s}
        .nav-pills .nav-link:hover{color:var(--accent)!important}
        .nav-pills .nav-link.active{background:linear-gradient(135deg,#00aaff,#0088cc)!important;color:#fff!important;border-color:transparent!important;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
        .tab-content{margin-top:1.5rem}
        .demo-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
        .demo-card h3{font-size:1.1rem;font-weight:700;color:var(--accent);margin-bottom:1rem}
        .demo-card h3 i{margin-right:0.5rem}
        label{font-weight:600;color:var(--steel);margin-bottom:0.4rem;font-size:0.9rem}
        select,input,textarea{background:var(--surface)!important;color:var(--text)!important;border:1px solid var(--border)!important;border-radius:8px!important;padding:0.6rem 0.8rem!important;font-family:'Plus Jakarta Sans',sans-serif!important;font-size:0.95rem!important;width:100%}
        select:focus,input:focus,textarea:focus{border-color:var(--accent)!important;box-shadow:0 0 0 3px rgba(0,170,255,0.15)!important;outline:none}
        textarea{min-height:120px;resize:vertical;font-family:'Courier New',monospace!important;font-size:0.85rem!important}
        .btn-accent{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:0.65rem 1.5rem;font-weight:700;font-size:0.95rem;transition:all 0.2s;cursor:pointer}
        .btn-accent:hover{background:#0099ee;transform:translateY(-1px);color:#fff}
        .btn-accent:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-gold{background:var(--gold);color:#000;border:none;border-radius:8px;padding:0.65rem 1.5rem;font-weight:700;font-size:0.95rem;cursor:pointer}
        .btn-gold:hover{background:#dbb85c;color:#000}
        .result-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.2rem;margin-top:1rem;display:none;font-family:'Courier New',monospace;font-size:0.85rem}
        .result-panel.show{display:block;animation:fadeIn 0.3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .result-label{color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.3rem}
        .result-value{color:var(--green);word-break:break-all}
        .result-value.error{color:var(--red)}
        .hash-display{background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.2);border-radius:6px;padding:0.6rem;word-break:break-all;color:var(--accent);margin:0.5rem 0}
        .branch-tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
        .branch-tab{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:0.82rem;font-weight:600;cursor:pointer;color:var(--steel);transition:all 0.2s;font-family:inherit}
        .branch-tab:hover{border-color:var(--accent);color:var(--accent)}
        .branch-tab.active{background:linear-gradient(135deg,#00aaff,#0088cc);border-color:transparent;color:#fff!important;box-shadow:0 2px 10px rgba(0,170,255,0.3)}
        .record-type-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:0.6rem;margin-bottom:1rem;max-height:280px;overflow-y:auto;padding-right:4px}
        .record-type-btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.7rem;cursor:pointer;text-align:center;transition:all 0.2s;font-size:0.78rem;font-weight:600}
        .record-type-btn:hover{border-color:var(--accent);background:rgba(0,170,255,0.05)}
        .record-type-btn.selected{border-color:var(--accent);background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
        .record-type-btn .icon{font-size:1.2rem;display:block;margin-bottom:0.2rem}
        .type-search{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:0.85rem;color:var(--text);width:100%;margin-bottom:8px;font-family:inherit}
        .type-search:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 2px rgba(0,170,255,0.15)}
        .type-search::placeholder{color:var(--muted)}
        .tx-log{max-height:400px;overflow-y:auto}
        .tx-entry{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem 1rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:1rem;transition:all 0.2s}
        .tx-entry:hover{border-color:var(--accent)}
        .tx-icon{font-size:1.4rem;min-width:36px;text-align:center}
        .tx-info{flex:1}.tx-type{font-weight:700;font-size:0.9rem}.tx-hash{font-family:monospace;color:var(--muted);font-size:0.75rem}
        .tx-time{color:var(--muted);font-size:0.75rem;white-space:nowrap}
        .tx-badge{font-size:0.7rem;font-weight:700;padding:2px 8px;border-radius:4px}
        .tx-badge.anchored{background:rgba(20,241,149,0.15);color:var(--green)}
        .stat-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;text-align:center}
        .stat-value{font-size:2rem;font-weight:800;color:var(--accent)}.stat-label{font-size:0.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
        footer{border-top:1px solid var(--border);padding:2rem 0;margin-top:3rem;text-align:center;color:var(--muted);font-size:0.85rem}
        footer a{color:var(--accent);text-decoration:none}
        .sample-btn{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.8rem;color:var(--steel);transition:all 0.2s;display:inline-block;margin:0.2rem}
        .sample-btn:hover{border-color:var(--gold);color:var(--gold)}
        #particles-js{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;pointer-events:none}
        #anchor-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;pointer-events:none}
        .mesh-overlay{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
        .g-orb{position:absolute;border-radius:50%;filter:blur(120px);opacity:0.15}
        .g-orb-1{width:600px;height:600px;background:#003366;top:-200px;right:-200px}
        .g-orb-2{width:400px;height:400px;background:#001a33;bottom:-100px;left:-100px}
        .g-orb-3{width:300px;height:300px;background:linear-gradient(135deg,#00aaff,#003366);top:50%;left:50%;transform:translate(-50%,-50%)}
        .anchor-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,16,0.94);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity 0.4s}
        .anchor-overlay.active{opacity:1;pointer-events:all}
        .anchor-anim-box{text-align:center;max-width:500px;padding:2rem}
        .chain-segment{width:3px;height:0;background:linear-gradient(to bottom,#00aaff,rgba(0,170,255,0.2));margin:0 auto;animation:chainGrow 0.5s ease-out 0.15s forwards}
        @keyframes chainGrow{to{height:50px}}
        .anchor-drop-icon{font-size:5rem;color:var(--accent);animation:anchorDrop 1.2s ease-in-out;filter:drop-shadow(0 0 25px rgba(0,170,255,0.5))}
        @keyframes anchorDrop{0%{transform:translateY(-80px) scale(0.5);opacity:0}40%{transform:translateY(10px) scale(1.15);opacity:1}60%{transform:translateY(-8px) scale(0.95)}80%{transform:translateY(3px) scale(1.02)}100%{transform:translateY(0) scale(1)}}
        .anim-status{font-size:1.15rem;font-weight:700;color:var(--accent);margin-top:1rem;animation:fadeUp 0.5s ease-out 0.5s both}
        .anim-hash{font-family:monospace;color:var(--accent);font-size:0.8rem;margin-top:0.8rem;word-break:break-all;opacity:0;animation:fadeUp 0.5s ease-out 1s both;background:rgba(0,170,255,0.08);padding:10px;border-radius:8px;border:1px solid rgba(0,170,255,0.2)}
        .anim-fee{font-size:0.9rem;color:var(--gold);margin-top:0.5rem;opacity:0;animation:fadeUp 0.5s ease-out 1.3s both}
        .anim-success{font-size:1.3rem;font-weight:800;color:var(--green);margin-top:1rem;opacity:0;animation:scaleIn 0.4s ease-out 2s both}
        @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes scaleIn{from{opacity:0;transform:scale(0)}to{opacity:1;transform:scale(1)}}
        .branch-count{font-size:0.8rem;color:var(--muted);margin-bottom:6px}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        @media(max-width:768px){.hero h1{font-size:1.6rem}.record-type-grid{grid-template-columns:repeat(2,1fr)}.branch-tabs{gap:4px}.branch-tab{font-size:0.75rem;padding:5px 10px}}

        @keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
        @keyframes brandGradient{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
        .scroll-progress{position:fixed;top:0;left:0;width:0%;height:3px;background:linear-gradient(90deg,#00aaff,#c9a84c);z-index:10000;transition:width 0.1s linear;box-shadow:0 0 10px #00aaff}
        .reveal-demo{opacity:0;transform:translateY(25px);transition:all 0.5s ease-out}
        .reveal-demo.visible{opacity:1;transform:translateY(0)}
        .gradient-text{background:linear-gradient(90deg,#00aaff,#ffffff,#c9a84c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .nav-logo{height:32px;width:32px;margin-right:8px;vertical-align:middle;animation:logoFloat 3s ease-in-out infinite}
        .footer-logo{height:28px;width:28px;margin-right:8px;vertical-align:middle;animation:logoFloat 4s ease-in-out infinite}
        .dropdown-menu{border-radius:10px;padding:8px 0;min-width:160px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
        .dropdown-item{padding:8px 18px;font-size:0.88rem;transition:background 0.2s,color 0.2s}
        .dropdown-item:hover,.dropdown-item:focus{background:rgba(0,170,255,0.12);color:var(--accent)!important}
        .copy-btn{background:rgba(0,170,255,0.15);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:6px;padding:4px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit;transition:all 0.2s;margin-left:8px}
        .copy-btn:hover{background:rgba(0,170,255,0.3);color:#fff}
        .clf-banner{display:none;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;margin:10px 0;font-size:0.88rem;font-weight:600;animation:fadeIn 0.25s ease-out}
        .clf-banner.show{display:flex}
        .clf-badge{padding:3px 12px;border-radius:6px;font-size:0.78rem;font-weight:800;letter-spacing:0.5px;text-transform:uppercase}
        .clf-U .clf-badge{background:rgba(0,170,0,0.15);color:#00cc66;border:1px solid rgba(0,170,0,0.3)}
        .clf-CUI .clf-badge{background:rgba(201,168,76,0.15);color:#c9a84c;border:1px solid rgba(201,168,76,0.3)}
        .clf-SECRET .clf-badge{background:rgba(255,50,50,0.15);color:#ff5555;border:1px solid rgba(255,50,50,0.3)}
        .clf-TS .clf-badge{background:rgba(255,165,0,0.15);color:#ffa500;border:1px solid rgba(255,165,0,0.35)}
        .clf-U{background:rgba(0,170,0,0.04);border:1px solid rgba(0,170,0,0.15)}
        .clf-CUI{background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15)}
        .clf-SECRET{background:rgba(255,50,50,0.04);border:1px solid rgba(255,50,50,0.15)}
        .clf-TS{background:rgba(255,165,0,0.04);border:1px solid rgba(255,165,0,0.15)}
        .clf-text{font-size:0.82rem;color:var(--steel);font-weight:400}
        .clf-icon{font-size:1.1rem}
        .ils-dropzone{border:2px dashed var(--border);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:all 0.3s;background:rgba(0,170,255,0.02);margin-bottom:1rem}
        .ils-dropzone:hover,.ils-dropzone.dragover{border-color:var(--accent);background:rgba(0,170,255,0.06)}
        .ils-dropzone i{font-size:2rem;color:var(--accent);margin-bottom:0.5rem;display:block}
        .ils-file-list{margin-bottom:1rem}
        .ils-file-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:0.85rem}
        .ils-file-item .file-info{display:flex;align-items:center;gap:8px}
        .ils-file-item .file-stats{color:var(--accent);font-size:0.78rem;font-weight:600}
        .ils-file-item .file-remove{color:var(--red);cursor:pointer;font-size:0.8rem;padding:2px 8px;border-radius:4px;transition:background 0.2s}
        .ils-file-item .file-remove:hover{background:rgba(255,107,107,0.15)}
        .ils-coverage-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.85rem}
        .ils-coverage-bar{flex:1;background:var(--surface);border-radius:4px;height:8px;overflow:hidden;border:1px solid var(--border)}
        .ils-coverage-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
        .ils-action-item{padding:12px;background:var(--surface);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--accent);font-size:0.85rem}
        .ils-action-item.critical{border-left-color:var(--red)}
        .ils-action-item.warning{border-left-color:#ffa500}
        .ils-action-item .action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .ils-action-item .action-title{font-weight:700;color:#fff}
        .ils-action-item .action-owner{font-size:0.78rem;padding:2px 8px;border-radius:4px;background:rgba(0,170,255,0.1);color:var(--accent)}
        .ils-action-item .action-detail{color:var(--steel);font-size:0.82rem}
        @media(max-width:991px){.navbar-collapse{background:rgba(5,8,16,0.98);padding:15px;border-radius:12px;margin-top:10px;border:1px solid var(--border);max-height:85vh;overflow-y:auto}.navbar-nav{gap:5px}.nav-link{padding:10px 15px!important;border-radius:8px}.nav-link:hover{background:rgba(0,170,255,0.1)}}
        /* AI Agent Chat */
        .ai-chat-container{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;height:420px}
        .ai-chat-header{background:linear-gradient(135deg,rgba(0,170,255,0.15),rgba(201,168,76,0.1));padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
        .ai-chat-header .ai-dot{width:10px;height:10px;background:#14f195;border-radius:50%;animation:pulse 2s infinite}
        .ai-chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;font-size:0.85rem}
        .ai-msg{padding:10px 14px;border-radius:12px;max-width:90%;line-height:1.5;animation:fadeIn 0.3s ease}
        .ai-msg.bot{background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.15);align-self:flex-start;color:var(--steel)}
        .ai-msg.user{background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.2);align-self:flex-end;color:#fff}
        .ai-msg .ai-label{font-size:0.7rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
        .ai-chat-input{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--border);background:var(--card)}
        .ai-chat-input input{flex:1;background:var(--surface)!important;border:1px solid var(--border)!important;border-radius:8px!important;padding:8px 12px!important;color:var(--text)!important;font-size:0.85rem!important;font-family:inherit!important}
        .ai-chat-input button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:0.85rem;font-weight:600;cursor:pointer;white-space:nowrap}
        .ai-chat-input button:hover{background:#0099ee}
        .ai-quick-btns{display:flex;flex-wrap:wrap;gap:4px;padding:6px 12px;background:var(--card);border-top:1px solid rgba(255,255,255,0.03)}
        .ai-quick-btn{background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.15);color:var(--accent);border-radius:16px;padding:4px 10px;font-size:0.72rem;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .ai-quick-btn:hover{background:rgba(0,170,255,0.15);border-color:var(--accent)}
        /* Floating AI Agent */
        .ai-float-wrapper{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;align-items:flex-end;gap:12px;pointer-events:none}
        .ai-float-toggle{pointer-events:all;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;font-size:1.4rem;cursor:pointer;box-shadow:0 4px 20px rgba(0,170,255,0.4);transition:all 0.3s;display:flex;align-items:center;justify-content:center;position:relative}
        .ai-float-toggle:hover{transform:scale(1.08);box-shadow:0 6px 28px rgba(0,170,255,0.5)}
        .ai-float-toggle .ai-float-dot{position:absolute;top:4px;right:4px;width:12px;height:12px;background:#14f195;border-radius:50%;border:2px solid #0a0e1a;animation:pulse 2s infinite}
        .ai-float-panel{pointer-events:all;width:380px;max-height:520px;background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 8px 40px rgba(0,0,0,0.5);transform:translateY(20px) scale(0.95);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);visibility:hidden}
        .ai-float-panel.open{transform:translateY(0) scale(1);opacity:1;visibility:visible}
        .ai-float-panel .ai-chat-header{border-radius:0;display:flex;justify-content:space-between}
        .ai-float-panel .ai-chat-header .ai-close-btn{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;padding:4px 8px;border-radius:6px;transition:all 0.2s}
        .ai-float-panel .ai-chat-header .ai-close-btn:hover{color:#fff;background:rgba(255,255,255,0.1)}
        .ai-float-panel .ai-chat-messages{height:280px;flex:1}
        .ai-float-panel .ai-context-label{font-size:0.68rem;padding:4px 12px;background:rgba(201,168,76,0.08);border-bottom:1px solid rgba(201,168,76,0.1);color:var(--gold);font-weight:600;display:flex;align-items:center;gap:6px}
        @media(max-width:480px){.ai-float-panel{width:calc(100vw - 32px);right:0}.ai-float-wrapper{right:16px;bottom:16px}}
        /* Post-Analysis Actions */
        .post-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;padding-top:12px;border-top:1px dashed var(--border)}
        .post-action-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.2);color:var(--steel);border-radius:8px;padding:8px 14px;font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .post-action-btn:hover{background:rgba(0,170,255,0.14);color:var(--accent);border-color:var(--accent)}
        .post-action-btn i{font-size:0.85rem;color:var(--accent)}
        /* Sample Package Modal */
        .sample-pkg-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:10px 0;max-height:200px;overflow-y:auto}
        .sample-pkg-item{display:flex;align-items:center;gap:6px;padding:6px 10px;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.1);border-radius:6px;font-size:0.78rem;color:var(--steel);cursor:default}
        .sample-pkg-item i{color:var(--accent);font-size:0.75rem;min-width:14px}
        /* Send Modal */
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,16,0.9);display:flex;align-items:center;justify-content:center;z-index:9998;opacity:0;pointer-events:none;transition:opacity 0.3s}
        .modal-overlay.active{opacity:1;pointer-events:all}
        .modal-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:480px;width:90%;animation:fadeIn 0.3s ease}
        .modal-box h4{color:var(--accent);margin-bottom:1rem}
        .modal-box .modal-close{position:absolute;top:12px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer}
        /* ═══ TOAST NOTIFICATION SYSTEM ═══ */
        #s4ToastContainer{position:fixed;top:80px;right:20px;z-index:9997;display:flex;flex-direction:column;gap:10px;max-width:420px;pointer-events:none}
        .s4-toast{pointer-events:all;display:flex;align-items:flex-start;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:toastSlideIn 0.4s ease-out;position:relative;overflow:hidden;min-width:340px}
        .s4-toast::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;border-radius:4px 0 0 4px}
        .s4-toast.info::before{background:var(--accent)}.s4-toast.warning::before{background:#ffa500}.s4-toast.danger::before{background:#ff3333}.s4-toast.success::before{background:#14f195}
        .s4-toast-icon{font-size:1.3rem;min-width:28px;text-align:center;padding-top:2px}
        .s4-toast-body{flex:1}
        .s4-toast-title{font-weight:700;font-size:0.9rem;color:#fff;margin-bottom:2px}
        .s4-toast-msg{font-size:0.82rem;color:var(--steel);line-height:1.4}
        .s4-toast-close{background:none;border:none;color:var(--muted);font-size:1rem;cursor:pointer;padding:0 0 0 8px;line-height:1}
        .s4-toast-close:hover{color:#fff}
        .s4-toast-actions{display:flex;gap:6px;margin-top:8px}
        .s4-toast-action{background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.2);color:var(--accent);border-radius:6px;padding:4px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit;font-weight:600;transition:all 0.2s}
        .s4-toast-action:hover{background:rgba(0,170,255,0.2)}
        .s4-toast-progress{position:absolute;bottom:0;left:0;height:3px;background:var(--accent);border-radius:0 0 0 4px;animation:toastProgress 8s linear forwards}
        .s4-toast.warning .s4-toast-progress{background:#ffa500}.s4-toast.danger .s4-toast-progress{background:#ff3333}.s4-toast.success .s4-toast-progress{background:#14f195}
        @keyframes toastSlideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
        @keyframes toastSlideOut{from{opacity:1;transform:translateX(0)}to{opacity:0;transform:translateX(100px)}}
        @keyframes toastProgress{from{width:100%}to{width:0%}}
        .s4-toast.dismissing{animation:toastSlideOut 0.3s ease-in forwards}
        /* ═══ NOTIFICATION BELL ═══ */
        .notif-bell{position:relative;background:none;border:none;color:var(--steel);font-size:1.1rem;cursor:pointer;padding:8px 12px;transition:color 0.2s}
        .notif-bell:hover{color:var(--accent)}
        .notif-badge{position:absolute;top:4px;right:4px;background:#ff3333;color:#fff;font-size:0.6rem;font-weight:800;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;animation:pulse 2s infinite}
        .notif-badge:empty{display:none}
        /* ═══ ACTION ITEMS PANEL ═══ */
        .action-tracker{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:1rem}
        .action-tracker h5{color:var(--accent);font-weight:700;margin-bottom:12px}
        .action-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;font-size:0.83rem;transition:all 0.2s}
        .action-item:hover{border-color:var(--accent)}
        .action-item .ai-check{width:20px;height:20px;border:2px solid var(--border);border-radius:4px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;transition:all 0.2s}
        .action-item .ai-check:hover{border-color:var(--accent)}
        .action-item .ai-check.done{background:var(--green);border-color:var(--green)}
        .action-item .ai-check.done::after{content:'✓';color:#000;font-size:0.7rem;font-weight:800}
        .action-item.completed{opacity:0.5}
        .action-item.completed .ai-body .ai-title{text-decoration:line-through}
        .ai-body{flex:1}
        .ai-title{font-weight:600;color:#fff;margin-bottom:2px}
        .ai-meta{font-size:0.75rem;color:var(--muted);display:flex;gap:8px;flex-wrap:wrap}
        .ai-tag{padding:1px 6px;border-radius:4px;font-size:0.7rem;font-weight:600}
        .ai-tag.critical{background:rgba(255,51,51,0.15);color:#ff3333}
        .ai-tag.warning{background:rgba(255,165,0,0.15);color:#ffa500}
        .ai-tag.info{background:rgba(0,170,255,0.15);color:#00aaff}
        .ai-tag.success{background:rgba(20,241,149,0.15);color:#14f195}
        .ai-priority{display:inline-flex;align-items:center;gap:4px}
        .stat-mini{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
        .stat-mini-val{font-size:1.3rem;font-weight:800;color:var(--accent)}
        .stat-mini-label{font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-top:2px}
        /* ═══ ILS WORKSPACE SUB-TABS ═══ */
        .ils-hub-tabs{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:16px;padding:4px;background:var(--surface);border:1px solid var(--border);border-radius:10px}
        .ils-hub-tab{background:transparent;border:1px solid transparent;border-radius:8px;padding:8px 14px;font-size:0.8rem;font-weight:600;cursor:pointer;color:var(--steel);transition:all 0.2s;font-family:inherit;display:flex;align-items:center;gap:6px;white-space:nowrap}
        .ils-hub-tab:hover{color:var(--accent);background:rgba(0,170,255,0.06)}
        .ils-hub-tab.active{background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff!important;border-color:transparent;box-shadow:0 2px 10px rgba(0,170,255,0.3)}
        .ils-hub-tab .tab-badge{font-size:0.65rem;padding:1px 6px;border-radius:10px;background:rgba(255,51,51,0.2);color:#ff3333;font-weight:700}
        .ils-hub-tab.active .tab-badge{background:rgba(255,255,255,0.2);color:#fff}
        .ils-hub-panel{display:none;animation:fadeIn 0.3s ease}
        .ils-hub-panel.active{display:block}
        /* ═══ CALENDAR STYLES ═══ */
        .cal-container{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
        .cal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:linear-gradient(135deg,rgba(0,170,255,0.08),rgba(201,168,76,0.05));border-bottom:1px solid var(--border)}
        .cal-header h5{margin:0;color:#fff;font-size:0.95rem;font-weight:700}
        .cal-nav{display:flex;gap:6px}
        .cal-nav button{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:4px 10px;color:var(--steel);cursor:pointer;font-size:0.85rem;transition:all 0.2s;font-family:inherit}
        .cal-nav button:hover{border-color:var(--accent);color:var(--accent)}
        .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:1px;background:var(--border)}
        .cal-day-header{background:var(--surface);padding:8px;text-align:center;font-size:0.72rem;font-weight:700;color:var(--muted);text-transform:uppercase}
        .cal-day{background:var(--card);padding:6px;min-height:80px;font-size:0.78rem;cursor:pointer;transition:background 0.2s;position:relative}
        .cal-day:hover{background:rgba(0,170,255,0.04)}
        .cal-day.other-month{opacity:0.3}
        .cal-day.today{background:rgba(0,170,255,0.08);box-shadow:inset 0 0 0 1px var(--accent)}
        .cal-day-num{font-weight:700;color:var(--steel);margin-bottom:4px}
        .cal-event{font-size:0.68rem;padding:2px 5px;border-radius:4px;margin-bottom:2px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:pointer;transition:all 0.2s}
        .cal-event:hover{filter:brightness(1.2)}
        .cal-event.critical{background:rgba(255,51,51,0.2);color:#ff3333;border-left:2px solid #ff3333}
        .cal-event.warning{background:rgba(255,165,0,0.2);color:#ffa500;border-left:2px solid #ffa500}
        .cal-event.info{background:rgba(0,170,255,0.15);color:#00aaff;border-left:2px solid #00aaff}
        .cal-event.success{background:rgba(20,241,149,0.15);color:#14f195;border-left:2px solid #14f195}
        .cal-event.custom{background:rgba(201,168,76,0.15);color:#c9a84c;border-left:2px solid #c9a84c}
        .cal-add-btn{position:absolute;top:4px;right:4px;background:rgba(0,170,255,0.1);border:none;color:var(--accent);border-radius:4px;width:18px;height:18px;font-size:0.7rem;cursor:pointer;display:none;align-items:center;justify-content:center}
        .cal-day:hover .cal-add-btn{display:flex}
        .cal-sidebar{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px}
        .cal-upcoming{font-size:0.82rem}
        .cal-upcoming-item{display:flex;gap:10px;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;transition:all 0.2s}
        .cal-upcoming-item:hover{border-color:var(--accent)}
        .cal-upcoming-date{min-width:42px;text-align:center;font-weight:700;color:var(--accent);line-height:1.2}
        .cal-upcoming-date .cal-month{font-size:0.65rem;text-transform:uppercase;color:var(--muted)}
        .cal-upcoming-info{flex:1}
        .cal-upcoming-title{font-weight:600;color:#fff;font-size:0.82rem}
        .cal-upcoming-meta{font-size:0.72rem;color:var(--muted)}
        /* ═══ HUB TOOL PANELS ═══ */
        .hub-tool-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
        .hub-tool-header{display:flex;align-items:center;gap:10px;margin-bottom:12px}
        .hub-tool-header h4{margin:0;font-size:1rem;font-weight:700;color:var(--accent)}
        .hub-tool-header .tool-link{font-size:0.78rem;color:var(--muted);margin-left:auto;cursor:pointer;transition:color 0.2s;text-decoration:none}
        .hub-tool-header .tool-link:hover{color:var(--accent)}
        /* ═══ AUDIT VAULT ═══ */
        .vault-record{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;transition:all 0.3s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
        .vault-record::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:linear-gradient(180deg,var(--accent),var(--green));border-radius:3px 0 0 3px}
        .vault-record:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,170,255,0.12)}
        .vault-record .vault-hash{font-family:monospace;font-size:0.72rem;color:var(--accent);word-break:break-all;background:rgba(0,170,255,0.06);padding:6px 10px;border-radius:6px;margin:8px 0}
        .vault-record .vault-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:0.75rem;color:var(--muted)}
        .vault-record .vault-meta span{display:flex;align-items:center;gap:4px}
        .vault-badge{font-size:0.68rem;padding:2px 8px;border-radius:6px;font-weight:700;letter-spacing:0.3px}
        .vault-badge.verified{background:rgba(20,241,149,0.15);color:#14f195;border:1px solid rgba(20,241,149,0.3)}
        .vault-badge.anchored{background:rgba(0,170,255,0.12);color:var(--accent);border:1px solid rgba(0,170,255,0.3)}
        .vault-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px}
        .vault-stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;transition:all 0.3s}
        .vault-stat:hover{border-color:var(--accent);background:rgba(0,170,255,0.04)}
        .vault-stat .stat-val{font-size:1.4rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--green));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .vault-stat .stat-lbl{font-size:0.7rem;text-transform:uppercase;letter-spacing:0.5px;color:var(--muted);margin-top:4px}
        /* ═══ DOC LIBRARY ═══ */
        .doc-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:8px;transition:all 0.3s cubic-bezier(.4,0,.2,1);cursor:pointer;position:relative}
        .doc-card:hover{border-color:var(--accent);transform:translateX(4px);box-shadow:0 4px 20px rgba(0,170,255,0.08)}
        .doc-card .doc-id{font-weight:800;color:#fff;font-size:0.88rem;margin-bottom:2px}
        .doc-card .doc-title{font-size:0.82rem;color:var(--accent);margin-bottom:4px}
        .doc-card .doc-desc{font-size:0.75rem;color:var(--muted);line-height:1.4}
        .doc-card .doc-tags{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
        .doc-tag{font-size:0.65rem;padding:2px 8px;border-radius:12px;font-weight:600}
        .doc-filter-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
        .doc-filter-btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:0.75rem;font-weight:600;cursor:pointer;color:var(--steel);transition:all 0.2s;font-family:inherit}
        .doc-filter-btn:hover{border-color:var(--accent);color:var(--accent)}
        .doc-filter-btn.active{background:linear-gradient(135deg,var(--accent),#0088cc);color:#fff;border-color:transparent}
        .doc-counter{font-size:0.78rem;color:var(--muted);margin-bottom:12px}
        /* ═══ COMPLIANCE SCORECARD ═══ */
        .score-ring{width:120px;height:120px;position:relative;margin:0 auto 12px}
        .score-ring svg{transform:rotate(-90deg)}
        .score-ring .score-val{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.6rem;font-weight:800;color:#fff}
        .score-ring .score-grade{position:absolute;bottom:-24px;left:50%;transform:translateX(-50%);font-size:1.3rem;font-weight:900;padding:6px 18px;border-radius:12px;letter-spacing:2px;text-transform:uppercase;box-shadow:0 0 16px rgba(20,241,149,0.3);border:2px solid rgba(20,241,149,0.3);min-width:48px;text-align:center;transition:all 0.5s ease}
        .compliance-row{display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;transition:all 0.3s}
        .compliance-row:hover{border-color:var(--accent);background:rgba(0,170,255,0.03)}
        .compliance-bar{flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;position:relative}
        .compliance-bar .fill{height:100%;border-radius:4px;transition:width 1s cubic-bezier(.4,0,.2,1)}
        .compliance-label{min-width:140px;font-size:0.82rem;font-weight:600;color:#fff}
        .compliance-pct{min-width:50px;text-align:right;font-size:0.85rem;font-weight:700}
        /* ═══ ENHANCED UX — GLASSMORPHISM, MICRO-ANIMATIONS ═══ */
        @keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
        @keyframes pulseGlow{0%,100%{box-shadow:0 0 5px rgba(0,170,255,0.2)}50%{box-shadow:0 0 20px rgba(0,170,255,0.4)}}
        @keyframes countUp{from{opacity:0;transform:scale(0.5)}to{opacity:1;transform:scale(1)}}
        .glass-card{background:rgba(15,22,48,0.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(0,170,255,0.15);border-radius:14px;padding:20px;transition:all 0.4s cubic-bezier(.4,0,.2,1)}
        .glass-card:hover{border-color:rgba(0,170,255,0.4);box-shadow:0 8px 32px rgba(0,170,255,0.15)}
        .pulse-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;animation:pulseGlow 2s infinite;margin-right:6px}
        .shimmer-text{background:linear-gradient(90deg,var(--accent) 0%,var(--green) 50%,var(--accent) 100%);background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite}
        .stat-animate{animation:countUp 0.6s cubic-bezier(.4,0,.2,1) forwards}
        .hover-lift{transition:all 0.3s cubic-bezier(.4,0,.2,1)}.hover-lift:hover{transform:translateY(-3px);box-shadow:0 12px 35px rgba(0,0,0,0.3)}
        .gradient-border{position:relative;border:none!important}.gradient-border::after{content:'';position:absolute;inset:-1px;border-radius:inherit;padding:1px;background:linear-gradient(135deg,var(--accent),var(--gold),var(--green));-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
        .workspace-notification{position:fixed;bottom:20px;right:20px;background:rgba(15,22,48,0.95);backdrop-filter:blur(12px);border:1px solid var(--accent);border-radius:12px;padding:14px 20px;color:#fff;font-size:0.85rem;z-index:10000;animation:slideUp 0.4s ease;box-shadow:0 8px 30px rgba(0,170,255,0.2);max-width:360px}
        .workspace-notification .notif-close{position:absolute;top:6px;right:10px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem}
        .tooltip-enhanced{position:relative}.tooltip-enhanced::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 8px);left:50%;transform:translateX(-50%) scale(0.8);opacity:0;background:rgba(15,22,48,0.95);border:1px solid var(--accent);color:#fff;padding:6px 12px;border-radius:8px;font-size:0.72rem;white-space:nowrap;pointer-events:none;transition:all 0.2s;z-index:999}
        .tooltip-enhanced:hover::after{opacity:1;transform:translateX(-50%) scale(1)}
        @media(max-width:768px){.ils-hub-tabs{gap:2px}.ils-hub-tab{padding:6px 10px;font-size:0.72rem}.cal-day{min-height:50px}.vault-stats{grid-template-columns:repeat(2,1fr)}.compliance-label{min-width:100px;font-size:0.75rem}}
    </style>
</head>
<body>
<div style="background:#1a0a0a;border-bottom:1px solid rgba(255,0,0,0.2);padding:4px 0;text-align:center;font-size:0.72rem;color:#ff6666;"><i class="fas fa-exclamation-triangle" style="margin-right:4px;"></i> NOTICE: Do not submit ITAR-controlled, classified, or export-controlled data to this platform. This system processes UNCLASSIFIED and CUI data only. <a href="/security/" style="color:#ff9999;text-decoration:underline;">Security Policy</a></div>
<div class="scroll-progress" id="scrollProgress"></div>
<div class="mesh-overlay"><div class="g-orb g-orb-1"></div><div class="g-orb g-orb-2"></div><div class="g-orb g-orb-3"></div></div>
<div id="particles-js"></div>
<canvas id="anchor-canvas"></canvas>

<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="../"><img src="../s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="nav-logo"><span class="brand-text">S4 Ledger</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><i class="fas fa-bars" style="color:#fff"></i></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="../">Home</a></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Company</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1)"><li><a class="dropdown-item" href="../s4-about/" style="color:#fff">About Us</a></li><li><a class="dropdown-item" href="../s4-investors/" style="color:#fff">Investors</a></li><li><a class="dropdown-item" href="../s4-partners/" style="color:#fff">Partners</a></li></ul></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">Products</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1)"><li><a class="dropdown-item" href="#" style="color:#fff;font-weight:600"><i class="fas fa-play-circle" style="width:18px;margin-right:6px;color:#00aaff"></i>Demo App</a></li><li><a class="dropdown-item" href="../sdk-playground/" style="color:#fff"><i class="fas fa-code" style="width:18px;margin-right:6px;color:#c9a84c"></i>SDK Playground</a></li><li><a class="dropdown-item" href="../s4-marketplace/" style="color:#fff"><i class="fas fa-store" style="width:18px;margin-right:6px;color:#a855f7"></i>Marketplace</a></li><li><a class="dropdown-item" href="../metrics.html" style="color:#fff"><i class="fas fa-chart-bar" style="width:18px;margin-right:6px;color:#00aaff"></i>Live Metrics</a></li><li><a class="dropdown-item" href="../transactions.html" style="color:#fff"><i class="fas fa-list" style="width:18px;margin-right:6px;color:#c9a84c"></i>Transactions</a></li><li><a class="dropdown-item" href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:#fff"><i class="fab fa-github" style="width:18px;margin-right:6px"></i>SDK & Docs</a></li></ul></li>
                <li class="nav-item"><a class="nav-link" href="../s4-use-cases/">Use Cases</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-pricing/">Pricing</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-roadmap/">Roadmap</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-faq/">FAQ</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-contact/">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-login/" style="color:#00aaff !important;font-weight:700"><i class="fas fa-sign-in-alt"></i> Login</a></li>
            </ul>
            <button class="notif-bell" onclick="toggleNotifPanel()" title="Alerts & Notifications"><i class="fas fa-bell"></i><span class="notif-badge" id="notifBadge"></span></button>
        </div>
    </div>
</nav>
<div id="s4ToastContainer"></div>

<section class="hero">
    <div class="container">
        <h1><i class="fas fa-shield-halved" style="margin-right:12px;color:var(--accent)"></i><span class="gradient-text">Defense Logistics</span> Verification Demo</h1>
        <p>Anchor, verify, and track defense supply chain records across <strong>all military branches</strong> on the XRP Ledger.</p>
        <div class="badge-live">XRPL Testnet Connected &mdash; Any Defense Record Type &bull; 156+ Pre-Built &bull; 9 Branches</div>
    </div>
</section>

<section class="tab-section reveal-demo">
    <div class="container">
        <div class="row mb-4 reveal-demo" id="statsRow">
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statAnchored">0</div><div class="stat-label">Records Anchored</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statVerified">0</div><div class="stat-label">Records Verified</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statTypes">0</div><div class="stat-label">Record Types Used</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statSlsFees">0.000</div><div class="stat-label">$SLS Fees</div></div></div>
        </div>

        <ul class="nav nav-pills mb-2" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tabAnchor" role="tab"><i class="fas fa-anchor"></i> Anchor</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabVerify" role="tab"><i class="fas fa-check-circle"></i> Verify</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabLog" role="tab"><i class="fas fa-list"></i> Transaction Log</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabILS" role="tab"><i class="fas fa-brain"></i> ILS Workspace</a></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tabAnchor" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-anchor"></i> Anchor a Defense Record</h3>
                            <details style="margin-top:8px;margin-bottom:12px;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                                <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How Anchoring Works</summary>
                                <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                    <p><strong style="color:#fff;">What's real:</strong> Every anchor creates an actual XRPL transaction with your record's SHA-256 hash stored in the memo field. The hash, transaction ID, timestamp, and XRPL explorer link are all genuine blockchain data you can independently verify.</p>
                                    <p><strong style="color:#fff;">What's demo:</strong> In this testnet demo, the $SLS token fee (0.01 per anchor) is simulated. On mainnet, real $SLS tokens are burned per transaction from the user's XRPL wallet.</p>
                                    <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Traditional defense record notarization costs $25–$150 per document and takes days. S4 Ledger anchors records in seconds for fractions of a cent — a <strong>99.9% cost reduction</strong>. At scale, a program anchoring 10,000 records/year saves $250K–$1.5M annually vs. legacy methods.</p>
                                    <p><strong style="color:#00aaff;">Production mode:</strong> Integrates with existing logistics systems (GCSS, OARS, NTCSS, LMP) via REST API or Python SDK. Records flow automatically — no manual paste required.</p>
                                </div>
                            </details>
                            <label>1. Select Military Branch</label>
                            <div class="branch-tabs" id="branchTabs">
                                <button class="branch-tab active" onclick="selectBranch('USN',this)">&#9875; Navy</button>
                                <button class="branch-tab" onclick="selectBranch('USA',this)">&#11088; Army</button>
                                <button class="branch-tab" onclick="selectBranch('USAF',this)">&#9992;&#65039; Air Force</button>
                                <button class="branch-tab" onclick="selectBranch('USMC',this)">&#129413; Marines</button>
                                <button class="branch-tab" onclick="selectBranch('USCG',this)">&#128735;&#65039; Coast Guard</button>
                                <button class="branch-tab" onclick="selectBranch('DLA',this)">&#127963;&#65039; DLA</button>
                                <button class="branch-tab" onclick="selectBranch('JOINT',this)">&#127894;&#65039; Joint</button>
                                <button class="branch-tab" onclick="selectBranch('SOCOM',this)">&#128481;&#65039; SOCOM</button>
                                <button class="branch-tab" onclick="selectBranch('USSF',this)">&#128640; Space Force</button>
                            </div>
                            <label>2. Choose Record Type <span class="branch-count" id="branchTypeCount"></span></label>
                            <input class="type-search" type="text" id="typeSearch" placeholder="Search record types..." oninput="renderTypeGrid()">
                            <div class="record-type-grid" id="recordTypeGrid"></div>

                            <div class="clf-banner" id="clfBanner"><span class="clf-icon"></span><span class="clf-badge" id="clfBadge"></span><span class="clf-text" id="clfText"></span></div>

                            <label>3. Enter Record Content</label>
                            <textarea id="recordInput" placeholder="Paste or type your defense logistics record here..." oninput="this.dataset.autoFilled='false'"></textarea>
                            <div class="mt-2 mb-3">
                                <span style="color:var(--muted);font-size:0.8rem">Try a sample:</span>
                                <span class="sample-btn" onclick="loadSample('supply')">Supply Receipt</span>
                                <span class="sample-btn" onclick="loadSample('maintenance')">3-M Maint</span>
                                <span class="sample-btn" onclick="loadSample('ordnance')">Ordnance Lot</span>
                                <span class="sample-btn" onclick="loadSample('casrep')">CASREP</span>
                                <span class="sample-btn" onclick="loadSample('custody')">Custody Transfer</span>
                                <span class="sample-btn" onclick="loadSample('hand_receipt')">Army Hand Receipt</span>
                                <span class="sample-btn" onclick="loadSample('flight_record')">AF Flight Record</span>
                                <span class="sample-btn" onclick="loadSample('ground_maint')">Marine Ground Maint</span>
                                <span class="sample-btn" onclick="loadSample('cutter')">CG Cutter Maint</span>
                                <span class="sample-btn" onclick="loadSample('satellite')">Space Force Sat</span>
                                <span class="sample-btn" onclick="loadSample('drl')">Navy DRL</span>
                                <span class="sample-btn" onclick="loadSample('buylist')">Navy Buylist</span>
                                <span class="sample-btn" onclick="loadSample('transfer_book')">Transfer Book</span>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <label class="form-check-label" style="font-size:0.85rem">
                                    <input type="checkbox" id="encryptCheck" checked style="width:auto!important;margin-right:6px"> Encrypt before hashing (CUI protection)
                                </label>
                            </div>
                            <button class="btn-accent mt-3" onclick="anchorRecord()" id="anchorBtn"><i class="fas fa-anchor"></i> Anchor to XRPL</button>
                            <div class="result-panel" id="anchorResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-diagram-project"></i> Anchor Flow</h3>
                            <div style="font-size:0.9rem;line-height:2">
                                <div><span style="color:var(--accent);font-weight:700">1.</span> Select branch & record type</div>
                                <div><span style="color:var(--accent);font-weight:700">2.</span> Enter or paste record content</div>
                                <div><span style="color:var(--accent);font-weight:700">3.</span> Optional: encrypt for CUI protection</div>
                                <div><span style="color:var(--accent);font-weight:700">4.</span> SHA-256 hash computed client-side</div>
                                <div><span style="color:var(--accent);font-weight:700">5.</span> Hash anchored to XRPL memo field</div>
                                <div><span style="color:var(--accent);font-weight:700">6.</span> $SLS micro-fee (0.01) paid to treasury</div>
                                <div><span style="color:var(--accent);font-weight:700">7.</span> Record appears in Live Metrics dashboard</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-shield-halved"></i> What Gets Stored On-Chain</h3>
                            <p style="font-size:0.85rem;color:var(--steel)"><strong>Only the SHA-256 hash</strong> of your record is stored on the XRP Ledger. No classified data, CUI, ITAR-controlled, or sensitive content ever touches the blockchain.</p>
                            <div style="font-size:0.8rem;margin-top:0.5rem">
                                <span style="color:var(--green)">&#10003;</span> NIST SP 800-171 compatible<br>
                                <span style="color:var(--green)">&#10003;</span> CMMC Level 2 aligned<br>
                                <span style="color:var(--green)">&#10003;</span> DFARS 252.204-7012 compliant<br>
                                <span style="color:var(--green)">&#10003;</span> No PII/CUI on-chain
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabVerify" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-check-circle"></i> Verify a Defense Record</h3>
                            <details style="margin-top:8px;margin-bottom:12px;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                                <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How Verification Works</summary>
                                <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                    <p><strong style="color:#fff;">What's real:</strong> Verification computes the SHA-256 hash of your pasted content and compares it against the hash that was previously anchored on the XRPL. If they match, the record is proven unaltered since the anchor date — the blockchain itself is the proof.</p>
                                    <p><strong style="color:#fff;">What's demo:</strong> In the demo, verification checks against records anchored in this session or previously stored hashes. On production, it queries the live XRPL directly for the on-chain hash.</p>
                                    <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Manual record verification during audits and inspections can take 40–200 staff-hours per event. S4 Ledger provides instant, cryptographic proof in seconds — reducing verification labor costs by <strong>90–98%</strong> and eliminating disputes about record authenticity.</p>
                                    <p><strong style="color:#00aaff;">Production mode:</strong> Automated batch verification via API — plug into QA pipelines, audit workflows, and supply chain acceptance processes for continuous integrity monitoring.</p>
                                </div>
                            </details>
                            <p style="color:var(--steel);font-size:0.9rem;margin-bottom:1rem">Paste the original record content to verify its hash matches what was anchored on XRPL.</p>
                            <label>Record Content</label>
                            <textarea id="verifyInput" placeholder="Paste the original defense record content here..."></textarea>
                            <label class="mt-2">Expected Hash (optional)</label>
                            <input type="text" id="verifyHash" placeholder="SHA-256 hash to compare against">
                            <button class="btn-gold mt-3" onclick="verifyRecord()"><i class="fas fa-check-circle"></i> Verify Integrity</button>
                            <div class="result-panel" id="verifyResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-question-circle"></i> Verification Use Cases</h3>
                            <div style="font-size:0.85rem;line-height:1.8;color:var(--steel)">
                                <div><strong>Supply Chain:</strong> Confirm parts receipt hasn't been altered</div>
                                <div><strong>CDRL:</strong> Verify contractor delivered exact document version</div>
                                <div><strong>Maintenance:</strong> Prove 3-M actions logged as-performed</div>
                                <div><strong>Ordnance:</strong> Validate lot tracking since manufacture</div>
                                <div><strong>Config:</strong> Confirm system baseline hasn't drifted</div>
                                <div><strong>Audit:</strong> Demonstrate tamper-proof trail to inspectors</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabLog" role="tabpanel">
                <div class="demo-card">
                    <h3><i class="fas fa-list"></i> Transaction Log</h3>
                    <p style="color:var(--steel);font-size:0.9rem">All records anchored in this session.</p>
                    <div class="tx-log" id="txLog">
                        <div style="color:var(--muted);text-align:center;padding:2rem">No records anchored yet. Go to the <strong>Anchor</strong> tab to start.</div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabILS" role="tabpanel">
                <!-- ═══ ILS WORKSPACE ═══ -->
                <div class="demo-card" style="padding:12px 16px;margin-bottom:8px;background:linear-gradient(135deg,rgba(0,170,255,0.06),rgba(201,168,76,0.03))">
                    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                        <h3 style="margin:0;font-size:1.15rem"><i class="fas fa-brain" style="color:var(--accent)"></i> ILS Workspace</h3>
                        <span style="font-size:0.78rem;color:var(--steel)">Unified command center — all ILS tools, action tracking, calendar, and AI agent in one workspace</span>
                    </div>
                </div>
                <div class="ils-hub-tabs" id="ilsHubTabs">
                    <button class="ils-hub-tab active" onclick="switchHubTab('hub-analysis',this)"><i class="fas fa-chart-line"></i> Gap Analysis</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-actions',this)"><i class="fas fa-tasks"></i> Action Items <span class="tab-badge" id="hubActionBadge">0</span></button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-calendar',this)"><i class="fas fa-calendar-alt"></i> Calendar</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-dmsms',this)"><i class="fas fa-exclamation-triangle"></i> DMSMS</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-readiness',this)"><i class="fas fa-chart-line"></i> Readiness</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-parts',this)"><i class="fas fa-cogs"></i> Parts</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-roi',this)"><i class="fas fa-dollar-sign"></i> ROI</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-lifecycle',this)"><i class="fas fa-clock"></i> Lifecycle</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-warranty',this)"><i class="fas fa-file-contract"></i> Warranty</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-vault',this)"><i class="fas fa-vault"></i> Audit Vault</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-docs',this)"><i class="fas fa-book"></i> Doc Library</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-compliance',this)"><i class="fas fa-shield-halved"></i> Compliance</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-provisioning',this)"><i class="fas fa-boxes-stacked"></i> Provisioning</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-risk',this)"><i class="fas fa-triangle-exclamation"></i> Supply Chain Risk</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-reports',this)"><i class="fas fa-file-pdf"></i> Audit Reports</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-contracts',this)"><i class="fas fa-file-signature"></i> Contracts</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-thread',this)"><i class="fas fa-project-diagram"></i> Digital Thread</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-predictive',this)"><i class="fas fa-brain"></i> Predictive Maint</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-dbimport',this)"><i class="fas fa-database"></i> Defense Database Import</button>
                    <button class="ils-hub-tab" onclick="switchHubTab('hub-submissions',this)"><i class="fas fa-file-circle-check"></i> ILIE</button>
                </div>

                <!-- ══ HUB: GAP ANALYSIS (original ILS content) ══ -->
                <div class="ils-hub-panel active" id="hub-analysis">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-brain"></i> ILS Workspace Analyzer</h3>
                            <details style="margin-bottom:1rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                                <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How S4 Ledger Works — Platform Overview</summary>
                                <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                    <p>S4 Ledger creates <strong>tamper-proof records</strong> for defense logistics by anchoring SHA-256 hashes to the XRP Ledger. The process: (1) A defense record is created in your existing system, (2) S4 Ledger computes a SHA-256 hash, (3) Only the hash is written to an XRPL transaction memo, (4) A micro-fee of 0.01 $SLS is paid per anchor, (5) Anyone with the original can verify it hasn't been altered. <strong>No sensitive data on-chain.</strong></p>
                                    <p><strong style="color:#fff;">Supports any defense record type — 156+ pre-built templates across 9 branches</strong> — Navy (54), Army (20), Air Force (18), Marines (14), Coast Guard (12), DLA (12), Joint (10), SOCOM (8), Space Force (11). Any custom record type can also be anchored.</p>
                                    <p><strong style="color:#c9a84c;">$SLS Token:</strong> Live on XRPL Mainnet | Total Supply: 100M | Circulating: ~15M | Anchor Fee: 0.01 $SLS | AMM pools and trustlines active.</p>
                                </div>
                            </details>
                            <p style="color:var(--steel);font-size:0.9rem;margin-bottom:1rem">Upload your DRLs, spreadsheets, checklists, and documents. The analyzer will parse them, cross-reference against program requirements, and identify gaps, missing deliverables, and actionable items.</p>

                            <label>1. Select Program / Platform Type</label>
                            <div class="row mb-3">
                                <div class="col-7">
                                    <select id="ilsProgram" onchange="onILSProgramChange()">
                                    </select>
                                </div>
                                <div class="col-5">
                                    <input type="text" id="ilsHull" placeholder="Hull # / Designation" style="font-size:0.88rem">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label style="font-size:0.82rem">Program Office</label>
                                    <input type="text" id="ilsOffice" placeholder="e.g. PMS 300" style="font-size:0.88rem">
                                </div>
                                <div class="col-6">
                                    <label style="font-size:0.82rem">Acquisition Phase</label>
                                    <select id="ilsPhase" style="font-size:0.88rem">
                                        <option value="pre_award">Pre-Award</option>
                                        <option value="design" selected>Design</option>
                                        <option value="construction">Construction</option>
                                        <option value="test_eval">Test & Evaluation</option>
                                        <option value="delivery">Delivery / Turnover</option>
                                        <option value="post_delivery">Post-Delivery</option>
                                    </select>
                                </div>
                            </div>

                            <label>2. Upload Documents <span style="color:var(--muted);font-weight:400">(DRLs, spreadsheets, checklists, text files)</span></label>
                            <div class="ils-dropzone" id="ilsDropzone" onclick="document.getElementById('ilsFileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <div style="font-weight:600;color:#fff;margin-bottom:4px">Drag & drop files here or click to browse</div>
                                <div style="font-size:0.82rem;color:var(--muted)">Accepts .csv, .xlsx, .xls, .txt — all processing done locally in your browser</div>
                            </div>
                            <input type="file" id="ilsFileInput" multiple accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none" onchange="handleILSFiles(this.files)">
                            <div style="margin:8px 0;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                <div style="position:relative;display:inline-block">
                                    <select id="sampleDocSelect" onchange="loadSelectedSampleDoc(this.value)" style="background:linear-gradient(135deg,rgba(0,170,255,0.12),rgba(201,168,76,0.12))!important;border:1px solid rgba(0,170,255,0.25)!important;color:var(--accent)!important;border-radius:6px!important;padding:6px 14px!important;cursor:pointer;font-family:inherit!important;font-size:0.82rem!important;font-weight:600!important;min-width:260px">
                                        <option value="" disabled selected>📄 Load Sample Document...</option>
                                        <optgroup label="📋 Data Requirements">
                                            <option value="drl">DRL Tracker (CDRL Status Log)</option>
                                            <option value="cdrl_matrix">CDRL Compliance Matrix</option>
                                        </optgroup>
                                        <optgroup label="📦 Provisioning & Supply">
                                            <option value="vrs">Vendor Recommended Spares (VRS)</option>
                                            <option value="buylist">Spares Buylist / Initial Outfitting</option>
                                            <option value="po_index">Purchase Order Index</option>
                                            <option value="gfm">Gov't Furnished Material (GFM) List</option>
                                            <option value="hazmat">HazMat Inventory</option>
                                        </optgroup>
                                        <optgroup label="🔧 Maintenance & Support">
                                            <option value="lcsp">Life Cycle Sustainment Plan (LCSP)</option>
                                            <option value="mrc">Maintenance Requirement Cards (MRCs)</option>
                                            <option value="mel">Machinery Equipment List (MEL)</option>
                                            <option value="pms_schedule">PMS Development Schedule</option>
                                        </optgroup>
                                        <optgroup label="🔎 Configuration & ID">
                                            <option value="iuid">IUID Register</option>
                                            <option value="config_baseline">Configuration Baseline Index</option>
                                            <option value="weight_report">Weight Report</option>
                                        </optgroup>
                                        <optgroup label="📊 Engineering & Test">
                                            <option value="ela">Electrical Load Analysis</option>
                                            <option value="temp">Test & Evaluation Master Plan (TEMP)</option>
                                            <option value="icd">Interface Control Document (ICD)</option>
                                        </optgroup>
                                        <optgroup label="🎓 Training & Manpower">
                                            <option value="training_plan">Training Plan / NTSP</option>
                                            <option value="manpower">Manpower Estimate Report</option>
                                        </optgroup>
                                        <optgroup label="📑 Contracts & Compliance">
                                            <option value="sow_matrix">SOW Compliance Matrix</option>
                                            <option value="ims">Integrated Master Schedule (IMS)</option>
                                            <option value="risk_register">Program Risk Register</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <button style="background:linear-gradient(135deg,rgba(201,168,76,0.12),rgba(20,241,149,0.08));border:1px solid rgba(201,168,76,0.25);color:var(--gold);border-radius:6px;padding:6px 14px;cursor:pointer;font-family:inherit;font-size:0.82rem;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='rgba(201,168,76,0.2)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(201,168,76,0.12),rgba(20,241,149,0.08))'" onclick="event.stopPropagation();loadSamplePackage()"><i class="fas fa-box-open"></i> Load Full ILS Package</button>
                                <span style="font-size:0.78rem;color:var(--muted)">22 document types — DRL, LCSP, IUID, VRS, IMS & more</span>
                            </div>
                            <div class="ils-file-list" id="ilsFileList"></div>

                            <label>3. Program ILS Checklist <span style="color:var(--muted);font-weight:400">(changes per program — auto-populated from uploads, or check manually)</span></label>
                            <div id="ilsChecklist" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:1rem;font-size:0.85rem;"></div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn-accent" onclick="runFullILSAnalysis()"><i class="fas fa-chart-line"></i> Run Full Analysis</button>
                                <button class="btn-gold" onclick="generateILSReport()"><i class="fas fa-file-export"></i> Generate Report</button>
                                <button style="background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:8px;padding:0.5rem 1rem;cursor:pointer;font-family:inherit;font-size:0.85rem;font-weight:600" onclick="anchorILSReport()"><i class="fas fa-anchor"></i> Anchor Report Hash</button>
                            </div>
                            <div id="ilsPostActions" style="display:none">
                                <div class="post-actions">
                                    <button class="post-action-btn" onclick="sendILSAnalysis()"><i class="fas fa-paper-plane"></i> Send Analysis</button>
                                    <button class="post-action-btn" onclick="scheduleILSMeeting()"><i class="fas fa-calendar-plus"></i> Schedule Meeting</button>
                                    <button class="post-action-btn" onclick="exportActionTracker()"><i class="fas fa-clipboard-list"></i> Update Action Tracker</button>
                                    <button class="post-action-btn" onclick="printILSReport()"><i class="fas fa-print"></i> Print Report</button>
                                    <button class="post-action-btn" onclick="saveILSReport()"><i class="fas fa-save"></i> Save Report</button>
                                </div>
                            </div>
                            <div class="result-panel" id="ilsResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-chart-pie"></i> ILS Readiness Score</h3>
                            <div id="ilsScoreContainer" style="text-align:center;padding:1rem 0">
                                <div style="font-size:4rem;font-weight:800;color:var(--muted)" id="ilsScore">--</div>
                                <div style="font-size:0.9rem;color:var(--steel)" id="ilsScoreLabel">Upload documents & run analysis</div>
                                <div style="margin-top:1rem" id="ilsGaugeBar">
                                    <div style="background:var(--surface);border-radius:8px;height:12px;overflow:hidden;border:1px solid var(--border)">
                                        <div id="ilsGaugeFill" style="height:100%;width:0%;background:linear-gradient(90deg,#ff3333,#ffa500,#14f195);border-radius:8px;transition:width 0.8s ease"></div>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-top:4px"><span>Critical Gaps</span><span>Partial</span><span>Mission Ready</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-list-check"></i> ILS Element Coverage</h3>
                            <div id="ilsCoverage" style="font-size:0.85rem">
                                <div style="color:var(--muted);text-align:center;padding:1rem">Upload files to see element-by-element coverage.</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-exclamation-triangle" style="color:#ffa500"></i> Action Items</h3>
                            <div id="ilsActions" style="max-height:400px;overflow-y:auto">
                                <div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.85rem">Run analysis to generate action items with responsible parties, due dates, and cost impact.</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-dollar-sign" style="color:#c9a84c"></i> Cost & Schedule Impact</h3>
                            <div id="ilsCostSchedule" style="font-size:0.85rem">
                                <div style="color:var(--muted);text-align:center;padding:1rem">Analysis required to estimate impact.</div>
                            </div>
                        </div>

                    </div>
                </div>
                </div><!-- /hub-analysis -->

                <!-- ══ HUB: ACTION ITEMS ══ -->
                <div class="ils-hub-panel" id="hub-actions">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="demo-card">
                                <h3><i class="fas fa-tasks" style="color:#00aaff"></i> Unified Action Items & Alerts</h3>
                                <details style="margin-bottom:1rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                                    <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Unified Action Tracking</summary>
                                    <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                        <p><strong style="color:#fff;">What this tool does:</strong> Every tool in the S4 Ledger suite generates actionable recommendations — DMSMS obsolescence alerts, readiness failures, warranty expirations, lifecycle cost opportunities, parts shortages, and ILS gap analysis items. This panel <strong>consolidates all of them</strong> into one unified tracker so nothing falls through the cracks.</p>
                                        <p><strong style="color:#00aaff;">How actions are created:</strong> When you use any tool (run a DMSMS check, calculate readiness, review warranties, estimate lifecycle costs, or run an ILS gap analysis), the system automatically generates action items with: (1) <strong>Severity</strong> — Critical, Warning, or Info, (2) <strong>Owner</strong> — assigned responsible party, (3) <strong>Cost impact</strong> — estimated dollar risk, (4) <strong>Schedule</strong> — recommended timeline, (5) <strong>Source tool</strong> — which analysis generated it.</p>
                                        <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> Missed action items are one of the biggest cost drivers in defense programs. A warranty that expires unrenewed can cost $500K+. An obsolete part discovered during production costs 10x more than one caught early. This tracker ensures every actionable finding from every tool is visible, assignable, and trackable — with the ability to export, filter, and communicate to stakeholders.</p>
                                        <p><strong style="color:#c9a84c;">AI Recommendations:</strong> Ask the S4 ILS Agent (below) about your action items. It can prioritize them, suggest corrective actions, draft CARs, estimate total risk, and recommend next steps based on all the data from every tool.</p>
                                    </div>
                                </details>
                                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:1rem">
                                    <button class="ai-quick-btn" onclick="filterHubActions('all')" style="background:rgba(0,170,255,0.15);border-color:var(--accent)">All</button>
                                    <button class="ai-quick-btn" onclick="filterHubActions('critical')"><span style="color:#ff3333">●</span> Critical</button>
                                    <button class="ai-quick-btn" onclick="filterHubActions('warning')"><span style="color:#ffa500">●</span> Warning</button>
                                    <button class="ai-quick-btn" onclick="filterHubActions('info')"><span style="color:#00aaff">●</span> Info</button>
                                    <button class="ai-quick-btn" onclick="filterHubActions('completed')"><span style="color:#14f195">●</span> Completed</button>
                                    <span style="flex:1"></span>
                                    <button class="ai-quick-btn" onclick="exportActionItems()"><i class="fas fa-download"></i> Export CSV</button>
                                    <button class="ai-quick-btn" onclick="clearCompletedActions()"><i class="fas fa-broom"></i> Clear Done</button>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="hubAiTotal" style="color:#00aaff">0</div><div class="stat-mini-label">Total Actions</div></div></div>
                                    <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="hubAiCritical" style="color:#ff3333">0</div><div class="stat-mini-label">Critical</div></div></div>
                                    <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="hubAiOpen" style="color:#ffa500">0</div><div class="stat-mini-label">Open</div></div></div>
                                    <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="hubAiDone" style="color:#14f195">0</div><div class="stat-mini-label">Completed</div></div></div>
                                </div>
                                <div id="hubActionItemsList" style="max-height:600px;overflow-y:auto">
                                    <div style="color:var(--muted);text-align:center;padding:2rem;font-size:0.85rem"><i class="fas fa-clipboard-list" style="font-size:2rem;margin-bottom:12px;display:block;opacity:0.3"></i>No action items yet. Use the tools above to generate actionable tasks and recommendations.</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="demo-card">
                                <h3 style="font-size:1rem;"><i class="fas fa-robot" style="color:var(--accent)"></i> AI Recommendations</h3>
                                <p style="color:var(--steel);font-size:0.82rem;margin-bottom:12px">Ask the S4 Agent about your action items, priorities, risks, and next steps.</p>
                                <div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px">
                                    <button class="ai-quick-btn" onclick="aiAsk('Prioritize my action items')">Prioritize</button>
                                    <button class="ai-quick-btn" onclick="aiAsk('What should I do first?')">Next Step</button>
                                    <button class="ai-quick-btn" onclick="aiAsk('Estimate my total risk exposure')">Total Risk</button>
                                    <button class="ai-quick-btn" onclick="aiAsk('Draft a status update for leadership')">Status Brief</button>
                                    <button class="ai-quick-btn" onclick="aiAsk('Which items can I delegate?')">Delegate</button>
                                    <button class="ai-quick-btn" onclick="aiAsk('Draft CAR for critical items')">Draft CAR</button>
                                </div>
                                <div style="font-size:0.78rem;color:var(--muted);padding:8px;background:var(--surface);border-radius:8px;border:1px solid var(--border)">
                                    <i class="fas fa-lightbulb" style="color:#c9a84c"></i> <strong>Tip:</strong> The agent uses data from all tools — ILS analysis, DMSMS, Readiness, Parts, ROI, Lifecycle, and Warranty — to provide contextual recommendations.
                                </div>
                            </div>
                            <div class="demo-card">
                                <h3 style="font-size:1rem;"><i class="fas fa-chart-pie" style="color:#ffa500"></i> Actions by Source</h3>
                                <div id="hubActionsBySource" style="font-size:0.82rem">
                                    <div style="color:var(--muted);text-align:center;padding:1rem">Run tools to see breakdown.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /hub-actions -->

                <!-- ══ HUB: CALENDAR ══ -->
                <div class="ils-hub-panel" id="hub-calendar">
                    <div class="row">
                        <div class="col-lg-9">
                            <div class="cal-container">
                                <div class="cal-header">
                                    <div class="cal-nav">
                                        <button onclick="calNav(-1)"><i class="fas fa-chevron-left"></i></button>
                                    </div>
                                    <h5 id="calMonthYear">February 2026</h5>
                                    <div class="cal-nav">
                                        <button onclick="calNav(1)"><i class="fas fa-chevron-right"></i></button>
                                        <button onclick="calToday()" style="font-size:0.78rem">Today</button>
                                    </div>
                                </div>
                                <div class="cal-grid" id="calGrid">
                                    <div class="cal-day-header">Sun</div><div class="cal-day-header">Mon</div><div class="cal-day-header">Tue</div><div class="cal-day-header">Wed</div><div class="cal-day-header">Thu</div><div class="cal-day-header">Fri</div><div class="cal-day-header">Sat</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-3">
                            <div class="cal-sidebar">
                                <h5 style="color:var(--accent);font-size:0.95rem;margin-bottom:12px"><i class="fas fa-calendar-day"></i> Upcoming</h5>
                                <div id="calUpcoming" class="cal-upcoming">
                                    <div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.82rem">No upcoming events.</div>
                                </div>
                                <div style="margin-top:16px">
                                    <h5 style="color:var(--gold);font-size:0.9rem;margin-bottom:10px"><i class="fas fa-plus-circle"></i> Add Event</h5>
                                    <div style="margin-bottom:8px">
                                        <input type="text" id="calEventTitle" placeholder="Event title..." style="font-size:0.82rem!important">
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-7"><input type="date" id="calEventDate" style="font-size:0.82rem!important"></div>
                                        <div class="col-5"><input type="time" id="calEventTime" value="09:00" style="font-size:0.82rem!important"></div>
                                    </div>
                                    <div style="margin-bottom:8px">
                                        <select id="calEventType" style="font-size:0.82rem!important">
                                            <option value="info">General</option>
                                            <option value="critical">Critical Deadline</option>
                                            <option value="warning">Review / Checkpoint</option>
                                            <option value="success">Milestone</option>
                                            <option value="custom">Custom</option>
                                        </select>
                                    </div>
                                    <div style="margin-bottom:8px">
                                        <textarea id="calEventNotes" placeholder="Notes (optional)..." rows="2" style="font-size:0.82rem!important;min-height:50px!important"></textarea>
                                    </div>
                                    <button class="btn-accent" onclick="addCalendarEvent()" style="width:100%;font-size:0.82rem;padding:8px"><i class="fas fa-plus"></i> Add to Calendar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div><!-- /hub-calendar -->

                <!-- ══ WORKSPACE TOOLS (full embedded) ══ -->
                <div class="ils-hub-panel" id="hub-dmsms">
                    <div class="demo-card">
                        <h3><i class="fas fa-exclamation-triangle" style="color:#ff9900"></i> DMSMS / Obsolescence Tracker</h3>
                        <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Track Diminishing Manufacturing Sources and Material Shortages (DMSMS). Identify parts at risk of obsolescence, find alternates, and estimate resolution costs. Per DoWI 4245.14.</p>
                        <details style="margin-bottom:1rem;background:rgba(255,153,0,0.04);border:1px solid rgba(255,153,0,0.15);border-radius:8px;padding:0 12px;">
                            <summary style="cursor:pointer;padding:10px 0;color:#ff9900;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                            <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                <p><strong style="color:#fff;">What's real:</strong> Platform names, system names, manufacturers, CAGE codes, and FSC groups are all real. The systems shown (AN/SPY-6, Mk 41 VLS, LM2500, etc.) are the actual systems installed on these platforms.</p>
                                <p><strong style="color:#ffa500;">What's demo data:</strong> The DMSMS statuses (Active/At Risk/Obsolete) are <em>simulated</em> in this demo. Real obsolescence data comes from <strong>GIDEP</strong> (Government-Industry Data Exchange Program), <strong>DLA</strong> (Defense Logistics Agency), and vendor EOL notices — all of which require authenticated access.</p>
                                <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> When a DMSMS case is identified and a resolution is chosen (bridge buy, redesign, alternate source), S4 Ledger anchors a SHA-256 hash of that decision to the XRP Ledger. This creates <em>immutable proof</em> that the obsolescence was documented, analyzed, and resolved at a specific date — critical for audits, contract disputes, and proving due diligence. Without this, programs lose millions to undocumented obsolescence discoveries during production.</p>
                                <p><strong style="color:#00aaff;">Production mode:</strong> Connect to GIDEP, DLA ASSIST, or your own parts database via the S4 API. Upload real DMSMS case files via CSV/XLSX. The tool structure is designed for real data — swap the demo layer for your authenticated data source.</p>
                            </div>
                        </details>
                        <label>Select Program</label>
                        <select id="dmsmsProgram" class="form-select mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" onchange="loadDMSMSData()"></select>
                        <div class="row mb-3">
                            <div class="col-6"><input type="text" id="dmsmsHull" class="form-control" placeholder="Hull # / Tail # / Designation" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                            <div class="col-6"><input type="text" id="dmsmsOffice" class="form-control" placeholder="Program Office (e.g. PMS 300)" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                        </div>
                        <div id="dmsmsResults" style="margin-top:1rem"></div>
                        <div class="row mt-3">
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="dmsmsTotalParts">0</div><div class="stat-mini-label">Parts Tracked</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="dmsmsAtRisk" style="color:#ff3333">0</div><div class="stat-mini-label">At Risk</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="dmsmsResolved" style="color:#14f195">0</div><div class="stat-mini-label">Resolved</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="dmsmsCost" style="color:#ffa500">$0</div><div class="stat-mini-label">Est. Resolution Cost</div></div></div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                            <button onclick="exportDMSMS()" class="btn btn-sm" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-download"></i> Export DMSMS Report</button>
                            <button onclick="anchorDMSMS()" class="btn btn-sm" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                        </div>
                    </div>
                </div>

                <div class="ils-hub-panel" id="hub-readiness">
                    <div class="demo-card">
                        <h3><i class="fas fa-chart-line" style="color:#14f195"></i> Operational Readiness Calculator</h3>
                        <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Calculate Operational Availability (Ao), Mean Time Between Failures (MTBF), Mean Time To Repair (MTTR), and Mean Logistics Delay Time (MLDT). Per MIL-STD-1390D and DoWI 5000.02.</p>
                        <details style="margin-bottom:1rem;background:rgba(20,241,149,0.04);border:1px solid rgba(20,241,149,0.15);border-radius:8px;padding:0 12px;">
                            <summary style="cursor:pointer;padding:10px 0;color:#14f195;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                            <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                <p><strong style="color:#fff;">What's real:</strong> The formula <code style='color:#14f195'>Ao = MTBF / (MTBF + MTTR + MLDT)</code> is the actual DoD standard calculation. The MTBF/MTTR/MLDT values pre-loaded for each system are <em>representative ranges</em> based on published data for those system types (e.g., gas turbines average 2000-5000 hr MTBF, radar systems 600-1800 hr).</p>
                                <p><strong style="color:#ffa500;">What's demo data:</strong> The specific MTBF/MTTR/MLDT numbers are representative but NOT from actual FRACAS (Failure Reporting, Analysis and Corrective Action System) databases. Real values come from fleet maintenance data (3-M system for Navy, AMPS for Army, REMIS for Air Force).</p>
                                <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> Readiness calculations drive billions in sustainment spending. When you compute an Ao and anchor it to the XRP Ledger, you create a <em>timestamped, tamper-proof record</em> that this system had X% availability on this date. This matters for: (1) Contract performance metrics — proving a system met its KPP/KSA readiness threshold, (2) Milestone decision briefings — anchored readiness reports can't be retroactively altered, (3) DMSMS correlation — linking obsolescence events to readiness drops to justify resolution funding.</p>
                                <p><strong style="color:#00aaff;">Production mode:</strong> Input your actual FRACAS/3-M data. The fields are editable — type in real MTBF/MTTR/MLDT values from your program's RAM analysis. Export the report, anchor the hash. That hash becomes permanent proof of the calculation.</p>
                            </div>
                        </details>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Select Program</label>
                                <select id="readinessProgram" class="form-select mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" onchange="loadReadinessData()"></select>
                                <div class="row mb-2">
                                    <div class="col-6"><input type="text" id="readinessHull" class="form-control" placeholder="Hull # / Tail #" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                                    <div class="col-6"><input type="text" id="readinessOffice" class="form-control" placeholder="Program Office" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                                </div>
                                <label>Select System / Subsystem</label>
                                <select id="readinessSystem" class="form-select mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" onchange="calcReadiness()"></select>
                            </div>
                            <div class="col-md-6">
                                <label>MTBF (hours) — Mean Time Between Failures</label>
                                <input type="number" id="inputMTBF" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 2400" oninput="calcReadiness()">
                                <label>MTTR (hours) — Mean Time To Repair</label>
                                <input type="number" id="inputMTTR" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 4.5" oninput="calcReadiness()">
                                <label>MLDT (hours) — Mean Logistics Delay Time</label>
                                <input type="number" id="inputMLDT" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 24" oninput="calcReadiness()">
                            </div>
                        </div>
                        <div id="readinessOutput" style="margin-top:1rem"></div>
                        <div class="row mt-3">
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="statAo" style="color:#14f195">—</div><div class="stat-mini-label">Ao (Operational Avail.)</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="statAi">—</div><div class="stat-mini-label">Ai (Inherent Avail.)</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="statFailRate">—</div><div class="stat-mini-label">Failure Rate (λ)</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="statMissReady">—</div><div class="stat-mini-label">Mission Readiness</div></div></div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                            <button onclick="exportReadiness()" class="btn btn-sm" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-download"></i> Export RAM Report</button>
                            <button onclick="anchorReadiness()" class="btn btn-sm" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                        </div>
                    </div>
                </div>

                <div class="ils-hub-panel" id="hub-parts">
                    <div class="demo-card">
                        <h3><i class="fas fa-cogs" style="color:#c9a84c"></i> NSN / Parts Cross-Reference</h3>
                        <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Look up National Stock Numbers (NSNs), CAGE codes, and find alternate/substitute parts across the Federal Supply System. Cross-reference manufacturers and check part availability across programs.</p>
                        <details style="margin-bottom:1rem;background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:8px;padding:0 12px;">
                            <summary style="cursor:pointer;padding:10px 0;color:#c9a84c;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                            <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                <p><strong style="color:#fff;">What's real:</strong> The CAGE codes for major primes are real (07458=Raytheon, 64928=Lockheed Martin, 77445=GE Aviation, etc.). FSC groups are real (5841=Radar, 2835=Engines, 1440=Launchers). System/part names are the actual nomenclatures used by these programs.</p>
                                <p><strong style="color:#ffa500;">What's demo data:</strong> The specific NSN numbers (e.g., 5841-01-622-3401) follow correct formatting and FSC patterns but are NOT verified against FedLog/FLIS. Real NSN lookups require access to the <strong>Federal Logistics Information System (FLIS)</strong> via DLA's FedLog or WebFLIS, which requires CAC authentication. Prices, quantities on hand, and lead times are simulated.</p>
                                <p><strong style="color:#fff;">Can it pull real parts?</strong> Not currently — this demo generates realistic part records from the platform database. In production, S4 Ledger would integrate with FedLog/WebFLIS APIs or accept CSV/XLSX uploads of real provisioning data (APLs, COSALs, technical manuals). The search functionality is real — it filters across whatever data is loaded.</p>
                                <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> Every time a part is cross-referenced, sourced, or an alternate identified, anchoring that lookup to the XRP Ledger creates proof of supply chain due diligence. This prevents: (1) Counterfeit parts — anchored source verification proves you checked CAGE/NSN provenance, (2) Duplicate procurement — searchable anchored records prevent re-buying parts already in inventory, (3) Audit failures — DLA and DCMA audits require proof of provisioning decisions; anchored records satisfy this automatically.</p>
                                <p><strong style="color:#00aaff;">Production mode:</strong> Upload real APLs (Allowance Parts Lists), COSALs, or provisioning spreadsheets. The tool will index and cross-reference them. Connect to WebFLIS for live NSN validation. Every lookup and sourcing decision gets an anchored hash.</p>
                            </div>
                        </details>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label>Search by NSN</label>
                                <input type="text" id="nsnSearch" class="form-control" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 5340-01-234-5678" oninput="searchNSN()">
                            </div>
                            <div class="col-md-4">
                                <label>Search by CAGE Code</label>
                                <input type="text" id="cageSearch" class="form-control" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 1THK9" oninput="searchCAGE()">
                            </div>
                            <div class="col-md-4">
                                <label>Search by Part Name</label>
                                <input type="text" id="partNameSearch" class="form-control" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., valve, pump, filter" oninput="searchPartName()">
                            </div>
                        </div>
                        <label>Filter by Program</label>
                        <select id="partsProgram" class="form-select mb-3" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" onchange="filterParts()"></select>
                        <div id="partsResults" style="margin-top:1rem"></div>
                        <div class="row mt-3">
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="partsTotal">0</div><div class="stat-mini-label">Parts in Database</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="partsAlternates" style="color:#14f195">0</div><div class="stat-mini-label">Alternates Found</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="partsCAGE" style="color:#00aaff">0</div><div class="stat-mini-label">CAGE Codes</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="partsPrograms" style="color:#c9a84c">0</div><div class="stat-mini-label">Programs</div></div></div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                            <button onclick="exportParts()" class="btn btn-sm" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-download"></i> Export Parts List</button>
                            <button onclick="anchorParts()" class="btn btn-sm" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                        </div>
                    </div>
                </div>

                <div class="ils-hub-panel" id="hub-roi">
                    <div class="demo-card">
                        <h3><i class="fas fa-dollar-sign" style="color:#14f195"></i> S4 Ledger ROI Calculator</h3>
                        <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Calculate the return on investment from implementing S4 Ledger across your ILS, DMSMS, and readiness programs. Compare manual processes vs. automated blockchain-backed document management.</p>
                        <details style="margin-bottom:1rem;background:rgba(20,241,149,0.04);border:1px solid rgba(20,241,149,0.15);border-radius:8px;padding:0 12px;">
                            <summary style="cursor:pointer;padding:10px 0;color:#14f195;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — What These Numbers Mean</summary>
                            <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                <p><strong style="color:#fff;">This calculator is a sales tool.</strong> Input YOUR program's real numbers (how many programs, how many staff, what you pay them) and it shows the cost savings from automating manual ILS work with S4 Ledger.</p>
                                <p><strong style="color:#14f195;">Where the savings come from:</strong></p>
                                <ul style="margin:4px 0 8px 16px;">
                                    <li><strong>Labor automation (65%):</strong> S4 Ledger automates document hashing, record tracking, DRL status tracking, and compliance checklist management. Tasks that take an ILS manager hours (verifying a CDRL was delivered, checking a supply receipt against the contract) become one-click operations with XRPL-anchored proof.</li>
                                    <li><strong>Error reduction (90%):</strong> Manual data entry into spreadsheets causes errors. Mistyped NSNs, wrong CAGE codes, duplicated PO entries — each costs thousands in rework, re-procurement, or failed audits. Automated hashing eliminates transcription errors.</li>
                                    <li><strong>Audit cost reduction (70%):</strong> Instead of gathering evidence for weeks before a DCMA or DLA audit, S4 Ledger provides instant proof via XRPL hashes. The auditor can verify any record's integrity in seconds.</li>
                                    <li><strong>Compliance acceleration:</strong> Per-program value of faster CDRL delivery, reduced contract risk, and avoided schedule delays from documentation gaps.</li>
                                </ul>
                                <p><strong style="color:#00aaff;">All inputs are editable.</strong> Change them to match your actual program. The output updates in real time. Use it in proposals or briefings to show the business case for S4 Ledger.</p>
                            </div>
                        </details>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Number of Programs Managed</label>
                                <input type="number" id="roiPrograms" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 5" value="5" oninput="calcROI()">
                                <label>Average Records / Month (per program)</label>
                                <input type="number" id="roiRecords" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 200" value="200" oninput="calcROI()">
                                <label>ILS Staff (FTEs doing manual work)</label>
                                <input type="number" id="roiFTEs" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 8" value="8" oninput="calcROI()">
                                <label>Average Fully-Burdened Labor Rate ($/hr)</label>
                                <input type="number" id="roiRate" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 145" value="145" oninput="calcROI()">
                            </div>
                            <div class="col-md-6">
                                <label>Current Annual Audit Cost ($)</label>
                                <input type="number" id="roiAudit" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 250000" value="250000" oninput="calcROI()">
                                <label>Average Rework/Error Cost per Incident ($)</label>
                                <input type="number" id="roiError" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 8500" value="8500" oninput="calcROI()">
                                <label>Estimated Error Incidents / Year</label>
                                <input type="number" id="roiIncidents" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 35" value="35" oninput="calcROI()">
                                <label>S4 Ledger Annual License Cost ($)</label>
                                <input type="number" id="roiLicense" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="e.g., 120000" value="120000" oninput="calcROI()">
                            </div>
                        </div>
                        <div id="roiOutput" style="margin-top:1rem"></div>
                        <div class="row mt-3">
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="roiSavings" style="color:#14f195">—</div><div class="stat-mini-label">Annual Savings</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="roiPercent">—</div><div class="stat-mini-label">ROI %</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="roiPayback" style="color:#00aaff">—</div><div class="stat-mini-label">Payback Period</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="roi5Year" style="color:#c9a84c">—</div><div class="stat-mini-label">5-Year Net Savings</div></div></div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                            <button onclick="exportROI()" class="btn btn-sm" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-download"></i> Export ROI Report</button>
                            <button onclick="anchorROI()" class="btn btn-sm" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                        </div>
                    </div>
                </div>

                <div class="ils-hub-panel" id="hub-lifecycle">
                    <div class="demo-card">
                        <h3><i class="fas fa-clock" style="color:#00aaff"></i> Lifecycle Cost Estimator</h3>
                        <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Project total ownership cost (TOC) over a weapon system's lifecycle. Factors in sustainment, DMSMS resolution, tech refresh, and depot maintenance per DoD 5000.73 and MIL-STD-881F.</p>
                        <details style="margin-bottom:1rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                            <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Understanding Total Ownership Cost</summary>
                            <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                <p><strong style="color:#fff;">What this tool does:</strong> It calculates how much a weapon system costs over its ENTIRE life — not just the sticker price. The DoD famously spends 60-70% of a system's total cost AFTER it's built, on sustainment, repairs, and obsolescence. This tool breaks that down.</p>
                                <p><strong style="color:#00aaff;">What the numbers mean:</strong></p>
                                <ul style="margin:4px 0 8px 16px;">
                                    <li><strong>Acquisition:</strong> What you pay upfront — unit cost × fleet size. For a DDG-51 Flight III, that's roughly $2.2B per ship × 20 ships = ~$44B.</li>
                                    <li><strong>Sustainment (O&S):</strong> Annual maintenance, crew, parts, depot work — typically 6-10% of acquisition cost <em>per year</em>, over 30+ years. This is where most money goes.</li>
                                    <li><strong>DMSMS/Obsolescence:</strong> Parts go out of production. Redesigning circuits, finding new vendors, bridge buys — estimated at ~4% of acquisition per year. Over 30 years for a fleet of destroyers, this can be billions.</li>
                                    <li><strong>Tech Refresh:</strong> Every ~5 years, major systems need upgrades (new radar software, engine overhauls, avionics refreshes) — estimated at 2% of acquisition per cycle.</li>
                                    <li><strong>Cost per Op Hour:</strong> Total cost divided by total operating hours across the fleet — what it costs to operate this system for one hour.</li>
                                </ul>
                                <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> S4 Ledger doesn't change acquisition costs — those are fixed. It reduces sustainment and DMSMS costs by 15-25%. How? (1) Automated DMSMS tracking catches obsolescence earlier, before emergency bridge buys at premium prices, (2) Anchored maintenance records reduce duplicate work orders and audit overhead, (3) Parts cross-referencing with anchored provenance prevents counterfeit part insertion — a single counterfeit electronic part in a radar system can cost $3-5M to find and remediate.</p>
                                <p><strong style="color:#ffa500;">Input your own data:</strong> Change the unit cost, fleet size, service life, and sustainment rate to match your actual program. The defaults (85M, 20 units, 30 years, 8%) are representative of a mid-size Navy combatant.</p>
                            </div>
                        </details>
                        <div class="row">
                            <div class="col-md-6">
                                <label>Select Program</label>
                                <select id="lifecycleProgram" class="form-select mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" onchange="calcLifecycle()"></select>
                                <div class="row mb-2">
                                    <div class="col-6"><input type="text" id="lifecycleHull" class="form-control" placeholder="Hull # / Tail #" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                                    <div class="col-6"><input type="text" id="lifecycleOffice" class="form-control" placeholder="Program Office" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                                </div>
                                <label>Planned Service Life (years)</label>
                                <input type="number" id="lcServiceLife" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="30" value="30" oninput="calcLifecycle()">
                                <label>Annual Operating Hours</label>
                                <input type="number" id="lcOpHours" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="2500" value="2500" oninput="calcLifecycle()">
                            </div>
                            <div class="col-md-6">
                                <label>Acquisition Unit Cost ($M)</label>
                                <input type="number" id="lcAcqCost" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="85" value="85" oninput="calcLifecycle()" step="0.1">
                                <label>Fleet Size (number of units)</label>
                                <input type="number" id="lcFleetSize" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="20" value="20" oninput="calcLifecycle()">
                                <label>Annual Sustainment Rate (% of acquisition)</label>
                                <input type="number" id="lcSustRate" class="form-control mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" placeholder="8" value="8" oninput="calcLifecycle()" step="0.1">
                            </div>
                        </div>
                        <div id="lifecycleOutput" style="margin-top:1rem"></div>
                        <div class="row mt-3">
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="lcTotalCost" style="color:#ff9900">—</div><div class="stat-mini-label">Total Ownership Cost</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="lcSustCost" style="color:#00aaff">—</div><div class="stat-mini-label">Sustainment (O&S)</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="lcDmsmsCost" style="color:#ff3333">—</div><div class="stat-mini-label">DMSMS/Obsol. Cost</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="lcCostPerHr" style="color:#14f195">—</div><div class="stat-mini-label">Cost per Op Hour</div></div></div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                            <button onclick="exportLifecycle()" class="btn btn-sm" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-download"></i> Export Lifecycle Report</button>
                            <button onclick="anchorLifecycle()" class="btn btn-sm" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                        </div>
                    </div>
                </div>

                <div class="ils-hub-panel" id="hub-warranty">
                    <div class="demo-card">
                        <h3><i class="fas fa-file-contract" style="color:#c9a84c"></i> Warranty & Contract Tracker</h3>
                        <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Track OEM warranties, CLIN deliverable milestones, contract expirations, and service agreements across programs. Ensure compliance with FAR/DFARS warranty requirements and prevent coverage lapses.</p>
                        <details style="margin-bottom:1rem;background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:8px;padding:0 12px;">
                            <summary style="cursor:pointer;padding:10px 0;color:#c9a84c;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                            <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                                <p><strong style="color:#fff;">What's real:</strong> The systems and OEMs listed are real — these are the actual systems on each platform with their actual manufacturers. Contract types (IDIQ, BPA, performance-based) reflect real acquisition vehicle structures.</p>
                                <p><strong style="color:#ffa500;">What's demo data:</strong> The warranty dates, CLIN numbers, and dollar values are <em>simulated</em>. Real warranty data comes from contract documents (DD Form 1423s, CDRLs) and the program's contract administration office. This tool is designed to accept that data.</p>
                                <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> Warranty lapses cost the DoD hundreds of millions per year. When a $500K engine fails 3 days after the warranty expired because nobody tracked the date, the Government pays for the repair — not the OEM. S4 Ledger: (1) Anchors warranty start/end dates to the blockchain so they can't be disputed, (2) Generates expiration alerts 90 days out, (3) Creates immutable proof that a warranty claim was filed within the coverage period — critical when OEMs contest claims, (4) Tracks CLIN deliverable milestones so contract payments aren't made before deliverables are verified.</p>
                                <p><strong style="color:#00aaff;">Production mode:</strong> Upload contract warranty schedules (CSV/XLSX), CLIN matrices from your DD Form 1423s, or service agreement details. The tracker will calculate expirations, generate alerts, and anchor each milestone to the XRPL. Every warranty event becomes a permanent, verifiable record.</p>
                            </div>
                        </details>
                        <label>Select Program</label>
                        <select id="warrantyProgram" class="form-select mb-2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);" onchange="loadWarrantyData()"></select>
                        <div class="row mb-3">
                            <div class="col-6"><input type="text" id="warrantyHull" class="form-control" placeholder="Hull # / Tail # / Serial" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                            <div class="col-6"><input type="text" id="warrantyOffice" class="form-control" placeholder="Program Office" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                        </div>
                        <div id="warrantyResults" style="margin-top:1rem"></div>
                        <div class="row mt-3">
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="warActive" style="color:#14f195">0</div><div class="stat-mini-label">Active Warranties</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="warExpiring" style="color:#ffa500">0</div><div class="stat-mini-label">Expiring (90 days)</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="warExpired" style="color:#ff3333">0</div><div class="stat-mini-label">Expired</div></div></div>
                            <div class="col-md-3 col-6 mb-2"><div class="stat-mini"><div class="stat-mini-val" id="warValue" style="color:#00aaff">$0</div><div class="stat-mini-label">Coverage Value</div></div></div>
                        </div>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                            <button onclick="exportWarranty()" class="btn btn-sm" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-download"></i> Export Warranty Report</button>
                            <button onclick="anchorWarranty()" class="btn btn-sm" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px;"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                        </div>
                    </div>
                </div>

            <!-- ═══ AUDIT RECORD VAULT ═══ -->
            <div class="ils-hub-panel" id="hub-vault">
                <div class="demo-card glass-card" style="animation:slideUp 0.4s ease">
                    <div class="hub-tool-header">
                        <h4><i class="fas fa-vault" style="color:var(--gold);margin-right:8px"></i> Audit Record Vault</h4>
                        <span class="pulse-dot"></span><span style="font-size:0.75rem;color:var(--green);font-weight:600">LIVE</span>
                    </div>
                    <p style="color:var(--muted);font-size:0.85rem;margin-bottom:16px">Every record you anchor is stored here with its hash, original content preview, timestamp, and verification status — your single source of auditing proof. No more searching the XRPL manually.</p>

                    <details style="margin-bottom:1rem;background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#c9a84c;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> Every record you anchor from any tool (Anchor tab, DMSMS, Readiness, Lifecycle, Warranty, ROI, Parts, Gap Analysis) is automatically saved here with its SHA-256 hash, content preview, timestamp, record type, and XRPL transaction ID. This is your <strong>permanent audit trail</strong> — like a filing cabinet that's also blockchain-verified.</p>
                            <p><strong style="color:#ffa500;">What's demo data:</strong> In demo mode, records are stored in your browser's localStorage. They persist across sessions on this device. In production, records sync to your organization's secure database with role-based access, retention policies, and automated backup.</p>
                            <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> Defense programs spend $50K-$200K annually on manual audit trail compilation for IG inspections, DCMA reviews, and milestone briefings. The vault auto-compiles every anchored record with one-click re-verification and instant CSV/XLSX export. No more searching the XRPL manually, no more lost audit evidence, no more "we can't prove when we documented this."</p>
                            <p><strong style="color:#14f195;">How S4 Ledger saves time on audits:</strong> Traditional audit preparation takes 2-6 weeks of staff time per inspection — gathering records from multiple systems, verifying document versions, compiling evidence binders. The Audit Record Vault reduces this to minutes. Every anchored record is instantly searchable, filterable by time period (today, this week, this month, this year, or any custom range), and re-verifiable against the XRPL with one click. Auditors can independently verify any record's integrity without requesting original documents from the contractor. Government estimates show S4 Ledger can reduce audit preparation labor by 85-95%.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connect to your organizational database via the S4 API. Records sync across all users with the same program access. Export formats include CSV, XLSX, and PDF for formal audit submissions. Each record's TX Hash links directly to the XRPL public ledger for independent verification.</p>
                        </div>
                    </details>

                    <!-- Vault Stats -->
                    <div class="vault-stats" id="vaultStats">
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="vaultTotal">0</div><div class="stat-lbl">Total Records</div></div>
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="vaultVerified">0</div><div class="stat-lbl">Verified</div></div>
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="vaultTypes">0</div><div class="stat-lbl">Record Types</div></div>
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="vaultFees">$0.00</div><div class="stat-lbl">$SLS Spent</div></div>
                    </div>

                    <!-- Search & Filter -->
                    <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap">
                        <input type="text" id="vaultSearch" class="form-control" style="flex:1;min-width:200px;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 14px;font-size:0.85rem" placeholder="Search records by type, hash, content..." oninput="renderVault()">
                        <select id="vaultFilter" class="form-select" style="width:auto;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 14px;font-size:0.85rem" onchange="renderVault()">
                            <option value="all">All Records</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="last_week">Last Week</option>
                            <option value="month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="year">This Year</option>
                            <option value="last_year">Last Year</option>
                        </select>
                    </div>

                    <!-- Record List -->
                    <div id="vaultRecords" style="max-height:500px;overflow-y:auto;padding-right:4px">
                        <div style="text-align:center;padding:40px 20px;color:var(--muted)">
                            <i class="fas fa-vault" style="font-size:2.5rem;margin-bottom:12px;opacity:0.3"></i>
                            <p>No anchored records yet. Records will appear here automatically as you anchor them.</p>
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="exportVault('csv')" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-file-csv"></i> Export CSV</button>
                        <button onclick="exportVault('xlsx')" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-file-excel"></i> Export XLSX</button>
                        <button onclick="verifyAllVault()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-check-double"></i> Re-Verify All</button>
                        <button onclick="clearVault()" class="btn btn-sm" style="background:rgba(255,51,51,0.1);color:#ff3333;border:1px solid rgba(255,51,51,0.3);border-radius:8px;padding:8px 16px"><i class="fas fa-trash"></i> Clear Vault</button>
                    </div>
                </div>
            </div>

            <!-- ═══ DEFENSE DOCUMENT REFERENCE LIBRARY ═══ -->
            <div class="ils-hub-panel" id="hub-docs">
                <div class="demo-card glass-card" style="animation:slideUp 0.4s ease">
                    <div class="hub-tool-header">
                        <h4><i class="fas fa-book-open" style="color:var(--accent);margin-right:8px"></i> Defense Document Library</h4>
                        <span id="docCount" style="font-size:0.78rem;color:var(--muted)"></span>
                    </div>
                    <p style="color:var(--muted);font-size:0.85rem;margin-bottom:16px">Searchable reference library of MIL-STDs, OPNAVINSTs, DoD Directives, DFARS clauses, NIST standards, and service-specific regulations. Quick-reference while you work — no tab-switching needed.</p>

                    <details style="margin-bottom:1rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> All 100+ documents are <strong>real defense standards and regulations</strong> — MIL-STD-1388, MIL-HDBK-502, OPNAVINST 4790.16, COMDTINST M4000.13, Army AR 700-127, AFI 63-101, MCO 4105.2, DFARS 252.204-7012, NIST SP 800-171, and more. Links go to official DoD, NAVSEA, DLA, and NIST sources.</p>
                            <p><strong style="color:#ffa500;">What's demo data:</strong> The document library itself is fully real — these are the actual standards ILS managers reference daily. No simulated content. The only "demo" aspect is that the library is static; production mode adds your organization's internal documents, SOPs, and program-specific references.</p>
                            <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> ILS managers waste 15-30 minutes per reference lookup, switching between tabs, Googling document numbers, and tracking down the latest revision. With 100+ standards pre-loaded and searchable by category, branch, keywords, and document ID, you find the right standard in seconds — while working in the same tool where you're running analysis. Across a program office, this saves 200+ hours/year in reference lookup time.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Add your organization's internal documents via the S4 API. Create custom categories. Upload program-specific SOPs, instructions, and contract documents. The library becomes your program's searchable knowledge base — always available, always current.</p>
                        </div>
                    </details>

                    <!-- Search & Filters -->
                    <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
                        <input type="text" id="docSearch" class="form-control" style="flex:1;min-width:200px;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 14px;font-size:0.85rem" placeholder="Search by ID, title, keywords... (e.g., MIL-STD-1388, DMSMS, OPNAVINST)" oninput="renderDocLibrary()">
                        <select id="docBranchFilter" class="form-select" style="width:auto;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 14px;font-size:0.85rem" onchange="renderDocLibrary()">
                            <option value="all">All Branches</option>
                            <option value="JOINT">Joint / DoD-Wide</option>
                            <option value="USN">U.S. Navy</option>
                            <option value="USCG">U.S. Coast Guard</option>
                            <option value="USA">U.S. Army</option>
                            <option value="USAF">U.S. Air Force</option>
                            <option value="USMC">U.S. Marine Corps</option>
                            <option value="USSF">U.S. Space Force</option>
                        </select>
                    </div>
                    <!-- Category Filter Row -->
                    <div class="doc-filter-bar" id="docCatFilters"></div>
                    <div class="doc-counter" id="docResultCount"></div>

                    <!-- Document List -->
                    <div id="docList" style="max-height:600px;overflow-y:auto;padding-right:4px"></div>
                </div>
            </div>

            <!-- ═══ COMPLIANCE SCORECARD ═══ -->
            <div class="ils-hub-panel" id="hub-compliance">
                <div class="demo-card glass-card" style="animation:slideUp 0.4s ease">
                    <div class="hub-tool-header">
                        <h4><i class="fas fa-shield-halved" style="color:var(--green);margin-right:8px"></i> Compliance Scorecard</h4>
                        <span class="pulse-dot"></span><span style="font-size:0.75rem;color:var(--green);font-weight:600">REAL-TIME</span>
                    </div>
                    <p style="color:var(--muted);font-size:0.85rem;margin-bottom:16px">Live compliance posture across CMMC, NIST SP 800-171, DFARS, and program-specific requirements. Auto-calculates based on your workspace activity — something SAP, Oracle, and Microsoft don't offer.</p>

                    <details style="margin-bottom:1rem;background:rgba(20,241,149,0.04);border:1px solid rgba(20,241,149,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#14f195;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> The compliance frameworks (CMMC Level 2, NIST SP 800-171, DFARS 252.204-7012, FAR 46, MIL-STD-1388 ILS, DoDI 4245.15 DMSMS) are real regulatory requirements that every defense contractor and program office must meet. Your compliance score is calculated from <strong>actual workspace activity</strong> — records anchored, DMSMS items tracked, readiness calculated, warranties monitored, and more.</p>
                            <p><strong style="color:#ffa500;">What's demo data:</strong> The scoring algorithm uses representative weights and thresholds. In production, weights are calibrated to your organization's specific compliance requirements, C3PAO audit criteria, and program-specific CDRL obligations. The score formula is transparent and adjustable.</p>
                            <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> CMMC assessments alone cost $50K-$200K per assessment. Failed assessments cost 6-12 months of schedule delay plus reassessment fees. This scorecard lets you track compliance posture <em>continuously</em> instead of discovering gaps during the assessment. Each compliance data point is blockchain-anchored, so you can prove to auditors exactly when you achieved each milestone — something SAP, Oracle, and Microsoft cannot offer.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connect your compliance data sources via the S4 API. Map your SPRS score, eMASS data, and internal audit findings to the scorecard. Export compliance snapshots as PDF-ready reports for C3PAOs, DCMA, or IG inspections. Anchor each compliance snapshot to XRPL for immutable proof of your compliance posture at any point in time.</p>
                        </div>
                    </details>

                    <!-- Program Selector -->
                    <div style="margin-bottom:16px">
                        <label style="font-size:0.82rem;color:var(--steel);font-weight:600">Program</label>
                        <select id="complianceProgram" class="form-select" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:8px;margin-top:4px" onchange="calcCompliance()"></select>
                        <div class="row" style="margin-top:6px">
                            <div class="col-6"><input type="text" id="complianceHull" class="form-control" placeholder="Hull # / Tail #" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                            <div class="col-6"><input type="text" id="complianceOffice" class="form-control" placeholder="Program Office" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                        </div>
                    </div>

                    <!-- Score Ring -->
                    <div style="text-align:center;margin-bottom:20px">
                        <div class="score-ring" id="complianceRing">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="52" fill="none" stroke="var(--border)" stroke-width="8"/>
                                <circle id="complianceArc" cx="60" cy="60" r="52" fill="none" stroke="url(#scoreGrad)" stroke-width="8" stroke-dasharray="326.7" stroke-dashoffset="326.7" stroke-linecap="round" style="transition:stroke-dashoffset 1.5s cubic-bezier(.4,0,.2,1)"/>
                                <defs><linearGradient id="scoreGrad" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="var(--accent)"/><stop offset="100%" stop-color="var(--green)"/></linearGradient></defs>
                            </svg>
                            <div class="score-val" id="complianceScore">—</div>
                            <div class="score-grade" id="complianceGrade" style="background:linear-gradient(135deg,rgba(20,241,149,0.15),rgba(0,170,255,0.1));color:#14f195;border:2px solid rgba(20,241,149,0.4)">—</div>
                        </div>
                        <div style="font-size:0.82rem;color:var(--steel);font-weight:600;margin-top:8px">Overall Compliance Posture</div>
                    </div>

                    <!-- Framework Breakdown -->
                    <div id="complianceBreakdown">
                        <div class="compliance-row"><span class="compliance-label"><i class="fas fa-shield-halved" style="color:#e74c3c;margin-right:8px"></i>CMMC Level 2</span><div class="compliance-bar"><div class="fill" id="barCMMC" style="width:0%;background:linear-gradient(90deg,#e74c3c,#ff6b6b)"></div></div><span class="compliance-pct" id="pctCMMC">—</span></div>
                        <div class="compliance-row"><span class="compliance-label"><i class="fas fa-lock" style="color:#3498db;margin-right:8px"></i>NIST 800-171</span><div class="compliance-bar"><div class="fill" id="barNIST" style="width:0%;background:linear-gradient(90deg,#3498db,#00aaff)"></div></div><span class="compliance-pct" id="pctNIST">—</span></div>
                        <div class="compliance-row"><span class="compliance-label"><i class="fas fa-file-contract" style="color:#c9a84c;margin-right:8px"></i>DFARS 252.204</span><div class="compliance-bar"><div class="fill" id="barDFARS" style="width:0%;background:linear-gradient(90deg,#c9a84c,#f1c40f)"></div></div><span class="compliance-pct" id="pctDFARS">—</span></div>
                        <div class="compliance-row"><span class="compliance-label"><i class="fas fa-certificate" style="color:#14f195;margin-right:8px"></i>FAR 46 Quality</span><div class="compliance-bar"><div class="fill" id="barFAR" style="width:0%;background:linear-gradient(90deg,#14f195,#0bc77a)"></div></div><span class="compliance-pct" id="pctFAR">—</span></div>
                        <div class="compliance-row"><span class="compliance-label"><i class="fas fa-cubes" style="color:#9b59b6;margin-right:8px"></i>MIL-STD-1388 ILS</span><div class="compliance-bar"><div class="fill" id="barILS" style="width:0%;background:linear-gradient(90deg,#9b59b6,#c39bd3)"></div></div><span class="compliance-pct" id="pctILS">—</span></div>
                        <div class="compliance-row"><span class="compliance-label"><i class="fas fa-exclamation-triangle" style="color:#ff6b6b;margin-right:8px"></i>DMSMS (DoDI 4245.15)</span><div class="compliance-bar"><div class="fill" id="barDMSMSmgmt" style="width:0%;background:linear-gradient(90deg,#ff6b6b,#ff3333)"></div></div><span class="compliance-pct" id="pctDMSMSmgmt">—</span></div>
                    </div>

                    <!-- Recommendations -->
                    <div style="margin-top:16px">
                        <h5 style="font-size:0.9rem;font-weight:700;color:#fff;margin-bottom:10px"><i class="fas fa-lightbulb" style="color:var(--gold);margin-right:6px"></i> Recommendations</h5>
                        <div id="complianceRecs" style="font-size:0.82rem;color:var(--steel);line-height:1.7"></div>
                    </div>

                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="exportCompliance()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-download"></i> Export Scorecard</button>
                        <button onclick="anchorCompliance()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor to XRPL ($0.01 SLS)</button>
                    </div>
                </div>
            </div>

            <!-- ═══ PROVISIONING & PTD MANAGEMENT ═══ -->
            <div class="ils-hub-panel" id="hub-provisioning">
                <div class="demo-card glass-card" style="animation:slideUp 0.4s ease">
                    <div class="hub-tool-header">
                        <h4><i class="fas fa-boxes-stacked" style="color:#9b59b6;margin-right:8px"></i> Provisioning & PTD Manager</h4>
                        <span style="font-size:0.72rem;background:rgba(155,89,182,0.15);color:#9b59b6;padding:3px 10px;border-radius:6px;font-weight:700">ICAPS REPLACEMENT</span>
                    </div>
                    <p style="color:var(--muted);font-size:0.85rem;margin-bottom:16px">Manage Provisioning Technical Documentation (PTD), generate Allowance Parts Lists (APL), track NSN cataloging status, and monitor Provisioning Performance Schedules — all with blockchain verification. Replaces ICAPS with a modern, all-branch, integrated solution.</p>

                    <details style="margin-bottom:1rem;background:rgba(155,89,182,0.04);border:1px solid rgba(155,89,182,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#9b59b6;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Data Sources & S4 Ledger Value</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> The provisioning workflow follows real DoD provisioning processes — Provisioning Parts Data (PPD) per MIL-STD-1552, Allowance Parts Lists (APLs) per NAVSEA/NAVSUP standards, NSN cataloging per Federal Cataloging System (FCS), and Provisioning Performance Schedules per contract data requirements. The programs, systems, and part categories shown are from actual defense platforms.</p>
                            <p><strong style="color:#ffa500;">What's demo data:</strong> In demo mode, sample provisioning data is generated for the selected program. Real PPD comes from contractor Logistics Product Data (LPD) submittals, GIDEP, DLA FLIS (Federal Logistics Information System), and NAVSUP WSS. NSN data comes from the Defense Logistics Information Service (DLIS).</p>
                            <p><strong style="color:#14f195;">How S4 Ledger saves money here:</strong> Provisioning errors cost $2M-$15M per ship class in rework, emergency procurements, and deployment delays. ICAPS — the Navy's legacy tool — covers only Supply Support and only Navy/Marines. S4 Ledger anchors every provisioning decision (APL approval, NSN assignment, PPD validation) to the XRP Ledger, creating immutable proof of when provisioning data was submitted, validated, and approved. This eliminates disputes over data currency and reduces provisioning cycle time by 30-50%.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connect to DLA FLIS, NAVSUP WSS, and contractor LPD systems via the S4 API. Import PPD in MIL-STD-1552 format. Export APLs and provisioning reports in formats compatible with NAVSUP/NAVSEA systems. Every provisioning action is blockchain-anchored for auditability.</p>
                        </div>
                    </details>

                    <!-- Provisioning Stats -->
                    <div class="vault-stats" id="provStats">
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="provParts">0</div><div class="stat-lbl">Parts Provisioned</div></div>
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="provAPLs">0</div><div class="stat-lbl">APLs Generated</div></div>
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="provNSNs">0</div><div class="stat-lbl">NSNs Cataloged</div></div>
                        <div class="vault-stat hover-lift"><div class="stat-val stat-animate" id="provSchedule" style="color:#14f195">On Track</div><div class="stat-lbl">Schedule Status</div></div>
                    </div>

                    <!-- Program Selector -->
                    <div style="margin-bottom:14px">
                        <label style="font-size:0.82rem;color:var(--steel);font-weight:600">Program</label>
                        <select id="provProgram" class="form-select" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:8px;margin-top:4px" onchange="loadProvisioningData()"></select>
                        <div class="row" style="margin-top:6px">
                            <div class="col-6"><input type="text" id="provHull" class="form-control" placeholder="Hull # / Tail #" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                            <div class="col-6"><input type="text" id="provOffice" class="form-control" placeholder="Program Office" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);font-size:0.85rem"></div>
                        </div>
                    </div>

                    <!-- View Toggle -->
                    <div style="display:flex;gap:8px;margin-bottom:14px">
                        <button class="btn btn-sm" id="provViewDemo" onclick="provSetView('demo')" style="background:linear-gradient(135deg,#9b59b6,#7d3c98);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:0.8rem;font-weight:600"><i class="fas fa-database"></i> Sample Data (40 Items)</button>
                        <button class="btn btn-sm" id="provViewCustom" onclick="provSetView('custom')" style="background:rgba(155,89,182,0.1);color:#9b59b6;border:1px solid rgba(155,89,182,0.3);border-radius:8px;padding:6px 14px;font-size:0.8rem;font-weight:600"><i class="fas fa-plus-circle"></i> Custom Entry</button>
                    </div>

                    <!-- Custom Entry Form (hidden by default) -->
                    <div id="provCustomForm" style="display:none;background:var(--surface);border:1px solid rgba(155,89,182,0.2);border-radius:10px;padding:16px;margin-bottom:14px">
                        <h5 style="font-size:0.9rem;margin-bottom:12px;color:#9b59b6"><i class="fas fa-plus-circle" style="margin-right:6px"></i> Add Custom Provisioning Item</h5>
                        <div class="row g-2 mb-2">
                            <div class="col-md-4"><label style="font-size:0.75rem;color:var(--muted)">Part Name *</label><input type="text" id="provCustomName" class="form-control form-control-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" placeholder="e.g. Valve, Gate, Carbon Steel"></div>
                            <div class="col-md-3"><label style="font-size:0.75rem;color:var(--muted)">NSN</label><input type="text" id="provCustomNSN" class="form-control form-control-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" placeholder="e.g. 5340-01-234-5678"></div>
                            <div class="col-md-3"><label style="font-size:0.75rem;color:var(--muted)">CAGE Code</label><input type="text" id="provCustomCAGE" class="form-control form-control-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" placeholder="e.g. 1THK9"></div>
                            <div class="col-md-2"><label style="font-size:0.75rem;color:var(--muted)">Qty</label><input type="number" id="provCustomQty" class="form-control form-control-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" value="1" min="1"></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-md-3"><label style="font-size:0.75rem;color:var(--muted)">FSC Group</label><select id="provCustomFSC" class="form-select form-select-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px"><option value="5340">5340 — Fasteners</option><option value="2815">2815 — Diesel Engines</option><option value="5895">5895 — Radar Components</option><option value="5962">5962 — Semiconductors</option><option value="1005">1005 — Guns</option><option value="4710">4710 — Pipe & Tube</option><option value="6625">6625 — Test Equipment</option><option value="2840">2840 — Gas Turbines</option><option value="5820">5820 — Radio Equipment</option><option value="1560">1560 — Airframe Components</option></select></div>
                            <div class="col-md-3"><label style="font-size:0.75rem;color:var(--muted)">PTD Status</label><select id="provCustomStatus" class="form-select form-select-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px"><option value="submitted">Submitted</option><option value="validated">Validated</option><option value="pending">Pending Review</option><option value="rejected">Rejected</option></select></div>
                            <div class="col-md-3"><label style="font-size:0.75rem;color:var(--muted)">Unit Cost ($)</label><input type="number" id="provCustomCost" class="form-control form-control-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" placeholder="0.00" step="0.01"></div>
                            <div class="col-md-3"><label style="font-size:0.75rem;color:var(--muted)">Manufacturer</label><input type="text" id="provCustomMfg" class="form-control form-control-sm" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" placeholder="e.g. Raytheon"></div>
                        </div>
                        <div class="row g-2 mb-2">
                            <div class="col-12"><label style="font-size:0.75rem;color:var(--muted)">Notes / Description</label><textarea id="provCustomNotes" class="form-control form-control-sm" rows="2" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px" placeholder="Optional notes..."></textarea></div>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <button onclick="addCustomProvItem()" class="btn btn-sm" style="background:linear-gradient(135deg,#9b59b6,#7d3c98);color:#fff;border:none;border-radius:8px;padding:6px 16px;font-weight:600"><i class="fas fa-plus"></i> Add Item</button>
                            <button onclick="clearCustomProvItems()" class="btn btn-sm" style="background:rgba(255,51,51,0.1);color:#ff3333;border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:6px 16px;font-weight:600"><i class="fas fa-trash"></i> Clear All Custom</button>
                            <span style="font-size:0.75rem;color:var(--muted);align-self:center;margin-left:auto" id="provCustomCount">0 custom items</span>
                        </div>
                    </div>

                    <!-- Provisioning Sections -->
                    <div class="provisioning-sections">
                        <!-- Parts Inventory Table -->
                        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
                                <h5 style="font-size:0.9rem;margin:0;color:#fff"><i class="fas fa-table" style="margin-right:6px;color:#9b59b6"></i> Provisioning Parts Inventory</h5>
                                <div style="display:flex;gap:6px;align-items:center">
                                    <input type="text" id="provSearchInput" placeholder="Search parts..." oninput="filterProvTable()" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:4px 10px;font-size:0.78rem;width:160px">
                                    <select id="provFilterStatus" onchange="filterProvTable()" style="background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:4px 8px;font-size:0.78rem"><option value="all">All Status</option><option value="validated">Validated</option><option value="submitted">Submitted</option><option value="pending">Pending</option><option value="rejected">Rejected</option></select>
                                </div>
                            </div>
                            <div id="provPartsTable" style="max-height:350px;overflow-y:auto;font-size:0.8rem">
                                <div style="text-align:center;padding:30px;color:var(--muted)"><i class="fas fa-database" style="font-size:1.5rem;opacity:0.3;margin-bottom:8px;display:block"></i>Click "Load Sample Data" or add custom items to populate the inventory.</div>
                            </div>
                            <div id="provTableFooter" style="display:none;padding:8px 0 0;border-top:1px solid var(--border);margin-top:8px;font-size:0.75rem;color:var(--muted);display:flex;justify-content:space-between">
                                <span id="provTableCount"></span>
                                <span id="provTableValue"></span>
                            </div>
                        </div>

                        <!-- PTD Status -->
                        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px">
                            <h5 style="font-size:0.9rem;margin-bottom:10px;color:#9b59b6"><i class="fas fa-file-lines" style="margin-right:6px"></i> Provisioning Technical Documentation (PTD)</h5>
                            <div class="row" id="provPTDStatus">
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="stat-mini"><div class="stat-mini-val" id="ptdSubmitted" style="color:#00aaff">0</div><div class="stat-mini-label">PPD Submitted</div></div>
                                </div>
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="stat-mini"><div class="stat-mini-val" id="ptdValidated" style="color:#14f195">0</div><div class="stat-mini-label">Validated</div></div>
                                </div>
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="stat-mini"><div class="stat-mini-val" id="ptdRejected" style="color:#ff3333">0</div><div class="stat-mini-label">Rejected/Errors</div></div>
                                </div>
                                <div class="col-6 col-md-3 mb-2">
                                    <div class="stat-mini"><div class="stat-mini-val" id="ptdPending" style="color:#ffa500">0</div><div class="stat-mini-label">Pending Review</div></div>
                                </div>
                            </div>
                            <div style="background:var(--bg);border-radius:8px;height:10px;overflow:hidden;margin-top:8px">
                                <div id="ptdProgressBar" style="height:100%;width:0%;background:linear-gradient(90deg,#9b59b6,#c39bd3);border-radius:8px;transition:width 0.8s ease"></div>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--muted);margin-top:4px"><span>0% Complete</span><span id="ptdPctLabel">Awaiting Data</span></div>
                        </div>

                        <!-- APL Generation -->
                        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px">
                            <h5 style="font-size:0.9rem;margin-bottom:10px;color:#00aaff"><i class="fas fa-clipboard-list" style="margin-right:6px"></i> Allowance Parts List (APL) Generator</h5>
                            <div id="provAPLList" style="max-height:250px;overflow-y:auto;font-size:0.82rem;color:var(--steel)">
                                <div style="text-align:center;padding:20px;color:var(--muted)"><i class="fas fa-clipboard-list" style="font-size:1.5rem;opacity:0.3;margin-bottom:8px;display:block"></i>Select a program and click "Generate APLs" to create Allowance Parts Lists from provisioning data.</div>
                            </div>
                        </div>

                        <!-- NSN Cataloging -->
                        <div style="background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px">
                            <h5 style="font-size:0.9rem;margin-bottom:10px;color:#c9a84c"><i class="fas fa-barcode" style="margin-right:6px"></i> NSN Cataloging Tracker</h5>
                            <div id="provNSNList" style="max-height:200px;overflow-y:auto;font-size:0.82rem;color:var(--steel)">
                                <div style="text-align:center;padding:20px;color:var(--muted)"><i class="fas fa-barcode" style="font-size:1.5rem;opacity:0.3;margin-bottom:8px;display:block"></i>NSN cataloging status will appear when provisioning data is loaded.</div>
                            </div>
                        </div>

                        <!-- ICAPS Comparison Banner -->
                        <div style="background:linear-gradient(135deg,rgba(155,89,182,0.08),rgba(0,170,255,0.05));border:1px solid rgba(155,89,182,0.2);border-radius:10px;padding:14px;margin-bottom:12px">
                            <h5 style="font-size:0.88rem;margin-bottom:10px;color:#fff"><i class="fas fa-trophy" style="color:#c9a84c;margin-right:6px"></i> S4 Ledger vs ICAPS</h5>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.78rem">
                                <div style="color:var(--steel)"><span style="color:#14f195">✓</span> All DoW branches</div><div style="color:var(--muted)"><span style="color:#ff3333">✗</span> ICAPS: Navy/USMC only</div>
                                <div style="color:var(--steel)"><span style="color:#14f195">✓</span> All 12 ILS elements</div><div style="color:var(--muted)"><span style="color:#ff3333">✗</span> ICAPS: Supply Support only</div>
                                <div style="color:var(--steel)"><span style="color:#14f195">✓</span> Blockchain verification</div><div style="color:var(--muted)"><span style="color:#ff3333">✗</span> ICAPS: No verification</div>
                                <div style="color:var(--steel)"><span style="color:#14f195">✓</span> DMSMS + readiness integration</div><div style="color:var(--muted)"><span style="color:#ff3333">✗</span> ICAPS: Standalone tool</div>
                                <div style="color:var(--steel)"><span style="color:#14f195">✓</span> Compliance scoring</div><div style="color:var(--muted)"><span style="color:#ff3333">✗</span> ICAPS: No compliance</div>
                                <div style="color:var(--steel)"><span style="color:#14f195">✓</span> Modern web platform</div><div style="color:var(--muted)"><span style="color:#ff3333">✗</span> ICAPS: Mainframe + PC</div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="loadProvisioningData()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#9b59b6,#7d3c98);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-database"></i> Load Sample Data</button>
                        <button onclick="generateAPLs()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-clipboard-list"></i> Generate APLs</button>
                        <button onclick="exportProvisioning()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-download"></i> Export CSV</button>
                        <button onclick="anchorAllProvisioning()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor All to XRPL</button>
                    </div>
                </div>
            </div>

            <!-- ══ HUB: AI SUPPLY CHAIN RISK ENGINE ══ -->
            <div class="ils-hub-panel" id="hub-risk">
                <div class="demo-card">
                    <h3><i class="fas fa-triangle-exclamation" style="color:#ff6b6b"></i> AI Supply Chain Risk Engine</h3>
                    <details style="margin-bottom:1rem;background:rgba(255,107,107,0.04);border:1px solid rgba(255,107,107,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#ff6b6b;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — AI Risk Prediction</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> The risk engine analyzes supplier health indicators — GIDEP alerts, CAGE code changes, DLA lead time spikes, financial distress signals, and single-source dependencies — to generate risk scores for every part in your supply chain. Alerts are timestamped and can be anchored to XRPL for audit trail.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Risk scores and supplier data are generated from realistic DoD supply chain patterns. In production, this connects to live GIDEP, DLA, SAM.gov, and commercial financial data feeds via API.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> A single undetected supplier failure costs $2M–$8M in emergency redesign. Predictive risk detection 18–24 months ahead reduces emergency procurement by <strong>60–80%</strong>. Across 50 programs: <strong>$15M–$100M in avoided costs over 5 years</strong>.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connects to GIDEP API, DLA FLIS, SAM.gov entity data, Dun & Bradstreet financial health scores, and XRPL anchor history for continuous monitoring.</p>
                        </div>
                    </details>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label>Select Program</label>
                            <select id="riskProgram" onchange="loadRiskData()" style="font-size:0.88rem"></select>
                            <div class="row" style="margin-top:6px">
                                <div class="col-6"><input type="text" id="riskHull" placeholder="Hull # / Tail #" style="font-size:0.82rem;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 8px;width:100%"></div>
                                <div class="col-6"><input type="text" id="riskOffice" placeholder="Program Office" style="font-size:0.82rem;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 8px;width:100%"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label>Risk Threshold</label>
                            <select id="riskThreshold" onchange="loadRiskData()" style="font-size:0.88rem"><option value="all">All Risk Levels</option><option value="critical">Critical Only</option><option value="high">High & Critical</option><option value="medium">Medium & Above</option></select>
                        </div>
                    </div>
                    <!-- Risk Summary Stats -->
                    <div class="row mb-3" id="riskStats">
                        <div class="col-3"><div style="text-align:center;padding:12px;background:rgba(255,59,48,0.1);border:1px solid rgba(255,59,48,0.3);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#ff3b30" id="riskCritical">0</div><div style="font-size:0.75rem;color:var(--text-muted)">Critical</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:12px;background:rgba(255,149,0,0.1);border:1px solid rgba(255,149,0,0.3);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#ff9500" id="riskHigh">0</div><div style="font-size:0.75rem;color:var(--text-muted)">High</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:12px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#ffcc00" id="riskMedium">0</div><div style="font-size:0.75rem;color:var(--text-muted)">Medium</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:12px;background:rgba(52,199,89,0.1);border:1px solid rgba(52,199,89,0.3);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#34c759" id="riskLow">0</div><div style="font-size:0.75rem;color:var(--text-muted)">Low</div></div></div>
                    </div>
                    <!-- Risk Table -->
                    <div style="max-height:400px;overflow-y:auto;border:1px solid rgba(255,107,107,0.2);border-radius:8px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead style="position:sticky;top:0;background:#0a0e1a;z-index:1;"><tr><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#ff6b6b;border-bottom:2px solid rgba(255,107,107,0.2);text-align:left;">Part / NSN</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#ff6b6b;border-bottom:2px solid rgba(255,107,107,0.2);text-align:left;">Supplier</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#ff6b6b;border-bottom:2px solid rgba(255,107,107,0.2);text-align:center;">Risk Score</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#ff6b6b;border-bottom:2px solid rgba(255,107,107,0.2);text-align:left;">Risk Factors</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#ff6b6b;border-bottom:2px solid rgba(255,107,107,0.2);text-align:center;">ETA Impact</th></tr></thead>
                            <tbody id="riskTableBody"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">Click a program to load risk analysis...</td></tr></tbody>
                        </table>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="loadRiskData()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#ff6b6b,#cc3333);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-sync-alt"></i> Refresh Analysis</button>
                        <button onclick="exportRisk()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-download"></i> Export Risk Report</button>
                        <button onclick="anchorRisk()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor to XRPL</button>
                    </div>
                </div>
            </div>

            <!-- ══ HUB: AUTOMATED AUDIT REPORT GENERATOR ══ -->
            <div class="ils-hub-panel" id="hub-reports">
                <div class="demo-card">
                    <h3><i class="fas fa-file-pdf" style="color:#c9a84c"></i> Automated Audit Report Generator</h3>
                    <details style="margin-bottom:1rem;background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#c9a84c;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — One-Click Audit Packages</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> The report generator compiles all anchored records, verification timestamps, chain-of-custody proof, and compliance scores into audit-ready packages. Every data point is backed by an XRPL transaction hash for independent verification.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Reports are generated from demo session data. In production, reports pull from your full anchoring history, compliance scorecard, and ILS analysis results stored in your S4 Ledger database.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Average DoD contract audit costs $45K–$150K in preparation labor alone (2–6 weeks of staff time). S4 Ledger generates a complete, verifiable audit package in <strong>under 60 seconds</strong> — a <strong>95–99% cost reduction</strong>.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> DCMA-ready (Defense Contract Management Agency), DCAA-ready (Defense Contract Audit Agency), and IG-ready (Inspector General) report templates with full chain-of-custody visualization and compliance gap analysis.</p>
                        </div>
                    </details>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label>Report Type</label>
                            <select id="reportType" style="font-size:0.88rem"><option value="full_audit">Full Audit Package</option><option value="supply_chain">Supply Chain Verification</option><option value="maintenance">Maintenance Records</option><option value="compliance">Compliance Summary</option><option value="custody">Chain of Custody</option><option value="contract">Contract Deliverables</option></select>
                        </div>
                        <div class="col-md-4">
                            <label>Time Period</label>
                            <select id="reportPeriod" style="font-size:0.88rem"><option value="30">Last 30 Days</option><option value="90">Last 90 Days</option><option value="180">Last 6 Months</option><option value="365">Last 12 Months</option><option value="all">All Time</option></select>
                        </div>
                        <div class="col-md-4">
                            <label>Format</label>
                            <select id="reportFormat" style="font-size:0.88rem"><option value="pdf">PDF Report</option><option value="csv">CSV Data Export</option><option value="json">JSON Package</option></select>
                        </div>
                    </div>
                    <!-- Report Preview -->
                    <div id="reportPreview" style="background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15);border-radius:8px;padding:16px;margin-bottom:1rem;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                            <h5 style="margin:0;color:#c9a84c;"><i class="fas fa-eye"></i> Report Preview</h5>
                            <span style="font-size:0.8rem;color:var(--text-muted)" id="reportRecordCount">0 records available</span>
                        </div>
                        <div id="reportContent" style="font-size:0.85rem;color:var(--steel);line-height:1.7;">Select a report type and click Generate to preview your audit package.</div>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <button onclick="generateReport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-magic"></i> Generate Report</button>
                        <button onclick="downloadReport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-download"></i> Download Report</button>
                        <button onclick="anchorReport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor Report Hash</button>
                    </div>
                </div>
            </div>

            <!-- ══ HUB: CONTRACT LIFECYCLE MANAGEMENT ══ -->
            <div class="ils-hub-panel" id="hub-contracts">
                <div class="demo-card">
                    <h3><i class="fas fa-file-signature" style="color:#00aaff"></i> Contract Lifecycle Management</h3>
                    <details style="margin-bottom:1rem;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#00aaff;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Blockchain-Verified Contracts</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> Every CDRL submission, contract modification, SOW deliverable, and DID milestone is tracked with blockchain-verified timestamps. Disputes over "who delivered what, when" become impossible when every action has an immutable XRPL anchor.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Contract data is generated from realistic DoD procurement patterns (CDRL types, DI numbers, modification types). In production, integrates with EDA (Electronic Document Access), PIEE, and contractor management systems.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Contract disputes cost $100K–$2M+ per incident in legal fees, re-work, and schedule delays. S4 Ledger's immutable delivery timestamps eliminate the root cause of disputes — saving <strong>$100K–$400K per contract</strong> in avoided dispute resolution.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Automated CDRL tracking via EDA API integration, real-time deliverable status dashboards, and automated late-deliverable notifications with chain-of-custody proof.</p>
                        </div>
                    </details>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label>Select Contract</label>
                            <select id="contractSelect" onchange="loadContractData()" style="font-size:0.88rem">
                                <optgroup label="Navy (NAVSEA / NAVAIR)">
                                    <option value="N00024-25-C-5501">N00024-25-C-5501 (DDG-51 ILS)</option>
                                    <option value="N00024-25-C-5502">N00024-25-C-5502 (CVN-78 Sustainment)</option>
                                    <option value="N00024-25-C-2316">N00024-25-C-2316 (DDG-51 Flight III Production)</option>
                                    <option value="N00024-26-C-4401">N00024-26-C-4401 (Columbia-class SSBN)</option>
                                    <option value="N00019-25-C-0088">N00019-25-C-0088 (CH-53K Production)</option>
                                    <option value="N00019-25-C-0102">N00019-25-C-0102 (F/A-18 Block III Upgrade)</option>
                                    <option value="N00421-25-C-0019">N00421-25-C-0019 (V-22 Osprey Sustainment)</option>
                                    <option value="N61331-25-C-0044">N61331-25-C-0044 (AN/SPY-6 Radar)</option>
                                </optgroup>
                                <optgroup label="Army">
                                    <option value="W58RGZ-25-C-0142">W58RGZ-25-C-0142 (HIMARS Sustainment)</option>
                                    <option value="W15QKN-25-C-0537">W15QKN-25-C-0537 (JLTV Full-Rate Production)</option>
                                    <option value="W56HZV-25-C-0218">W56HZV-25-C-0218 (M1A2 SEPv3 Upgrade)</option>
                                    <option value="W58RGZ-26-C-0087">W58RGZ-26-C-0087 (Patriot PAC-3 MSE)</option>
                                    <option value="W31P4Q-25-C-0412">W31P4Q-25-C-0412 (AH-64E Remanufacture)</option>
                                    <option value="DAAB07-25-C-0063">DAAB07-25-C-0063 (Army SATCOM Terminal)</option>
                                </optgroup>
                                <optgroup label="Air Force">
                                    <option value="FA8615-25-C-0031">FA8615-25-C-0031 (F-35 ALIS/ODIN)</option>
                                    <option value="FA8726-25-C-0015">FA8726-25-C-0015 (B-21 Raider LRIP)</option>
                                    <option value="FA8075-25-C-0033">FA8075-25-C-0033 (KC-46A Depot Sustainment)</option>
                                    <option value="FA8615-26-C-0112">FA8615-26-C-0112 (F-15EX Production)</option>
                                    <option value="FA8620-25-C-0081">FA8620-25-C-0081 (T-7A Red Hawk EMD)</option>
                                </optgroup>
                                <optgroup label="DLA / Marines / MDA">
                                    <option value="SPE7LX-25-D-0041">SPE7LX-25-D-0041 (DLA Aviation Spares)</option>
                                    <option value="SPE4AX-25-D-0108">SPE4AX-25-D-0108 (DLA Land Spares)</option>
                                    <option value="M67854-25-C-0019">M67854-25-C-0019 (ACV Production)</option>
                                    <option value="HQ0860-25-C-0007">HQ0860-25-C-0007 (THAAD Interceptor)</option>
                                    <option value="HQ0147-25-C-0034">HQ0147-25-C-0034 (GPS III SV11-14)</option>
                                </optgroup>
                                <optgroup label="Custom">
                                    <option value="custom">Enter Custom Contract Number...</option>
                                </optgroup>
                            </select>
                            <input type="text" id="contractCustomId" placeholder="e.g. N00024-26-C-XXXX" style="display:none;margin-top:6px;font-size:0.85rem;background:#0a0e1a;color:#fff;border:1px solid rgba(201,168,76,0.3);border-radius:6px;padding:6px 10px;width:100%" onchange="loadContractData()">
                        </div>
                        <div class="col-md-4">
                            <label>Filter by Type</label>
                            <select id="contractTypeFilter" onchange="loadContractData()" style="font-size:0.88rem"><option value="all">All Items</option><option value="cdrl">CDRLs Only</option><option value="mod">Modifications Only</option><option value="deliverable">SOW Deliverables</option></select>
                        </div>
                        <div class="col-md-4">
                            <label>Status</label>
                            <select id="contractStatusFilter" onchange="loadContractData()" style="font-size:0.88rem"><option value="all">All Status</option><option value="on_track">On Track</option><option value="at_risk">At Risk</option><option value="overdue">Overdue</option><option value="delivered">Delivered</option></select>
                        </div>
                    </div>
                    <!-- Contract Stats -->
                    <div class="row mb-3">
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:var(--accent)" id="contractTotal">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Total Items</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(52,199,89,0.06);border:1px solid rgba(52,199,89,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:#34c759" id="contractOnTrack">0</div><div style="font-size:0.72rem;color:var(--text-muted)">On Track</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(255,149,0,0.06);border:1px solid rgba(255,149,0,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:#ff9500" id="contractAtRisk">0</div><div style="font-size:0.72rem;color:var(--text-muted)">At Risk</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(255,59,48,0.06);border:1px solid rgba(255,59,48,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:#ff3b30" id="contractOverdue">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Overdue</div></div></div>
                    </div>
                    <!-- Contract Table -->
                    <div style="max-height:400px;overflow-y:auto;border:1px solid rgba(0,170,255,0.2);border-radius:8px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead style="position:sticky;top:0;background:#0a0e1a;z-index:1;"><tr><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:var(--accent);border-bottom:2px solid rgba(0,170,255,0.2);text-align:left;">Item</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:var(--accent);border-bottom:2px solid rgba(0,170,255,0.2);text-align:left;">Type</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:var(--accent);border-bottom:2px solid rgba(0,170,255,0.2);text-align:left;">Due Date</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:var(--accent);border-bottom:2px solid rgba(0,170,255,0.2);text-align:center;">Status</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:var(--accent);border-bottom:2px solid rgba(0,170,255,0.2);text-align:center;">Anchored</th></tr></thead>
                            <tbody id="contractTableBody"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">Select a contract to load deliverable tracking...</td></tr></tbody>
                        </table>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="loadContractData()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-sync-alt"></i> Refresh Contracts</button>
                        <button onclick="exportContracts()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-download"></i> Export CSV</button>
                        <button onclick="anchorContracts()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor All to XRPL</button>
                    </div>
                </div>
            </div>

            <!-- ══ HUB: DIGITAL THREAD / CONFIG MANAGEMENT BRIDGE ══ -->
            <div class="ils-hub-panel" id="hub-thread">
                <div class="demo-card">
                    <h3><i class="fas fa-project-diagram" style="color:#a855f7"></i> Digital Thread / Configuration Bridge</h3>
                    <details style="margin-bottom:1rem;background:rgba(168,85,247,0.04);border:1px solid rgba(168,85,247,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#a855f7;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — Immutable Configuration Management</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> The Digital Thread Bridge tracks every engineering change, BOM (Bill of Materials) revision, technical data package version, and configuration baseline. Each change is anchored to XRPL, creating an immutable audit trail of the entire product lifecycle — from design through sustainment.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Engineering changes and BOM data are generated from realistic defense platform patterns. In production, this integrates with PTC Windchill, Siemens Teamcenter, Dassault 3DEXPERIENCE, and existing TDM/PDM systems via REST API.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Configuration management errors cost DoD programs $5M–$25M per incident in rework, redesign, and field failures. S4 Ledger's immutable change tracking ensures the authoritative configuration baseline is always provable — reducing configuration-related failures by <strong>70–90%</strong>.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Bi-directional sync with PLM platforms (Windchill, Teamcenter), automated ECP (Engineering Change Proposal) tracking, and real-time BOM delta analysis across multiple program baselines.</p>
                        </div>
                    </details>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label>Select Platform</label>
                            <select id="threadPlatform" onchange="loadThreadData()" style="font-size:0.88rem"></select>
                            <div class="row" style="margin-top:6px">
                                <div class="col-6"><input type="text" id="threadHull" placeholder="Hull # / Tail #" style="font-size:0.82rem;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 8px;width:100%"></div>
                                <div class="col-6"><input type="text" id="threadOffice" placeholder="Program Office" style="font-size:0.82rem;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 8px;width:100%"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label>View</label>
                            <select id="threadView" onchange="loadThreadData()" style="font-size:0.88rem"><option value="changes">Engineering Changes</option><option value="bom">BOM Revisions</option><option value="baseline">Configuration Baselines</option><option value="tdp">TDP Versions</option></select>
                        </div>
                        <div class="col-md-4">
                            <label>Status Filter</label>
                            <select id="threadStatus" onchange="loadThreadData()" style="font-size:0.88rem"><option value="all">All</option><option value="pending">Pending Review</option><option value="approved">Approved</option><option value="implemented">Implemented</option><option value="rejected">Rejected</option></select>
                        </div>
                    </div>
                    <!-- Thread Stats -->
                    <div class="row mb-3">
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(168,85,247,0.06);border:1px solid rgba(168,85,247,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:#a855f7" id="threadTotal">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Total Changes</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(255,149,0,0.06);border:1px solid rgba(255,149,0,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:#ff9500" id="threadPending">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Pending</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(52,199,89,0.06);border:1px solid rgba(52,199,89,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:#34c759" id="threadApproved">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Approved</div></div></div>
                        <div class="col-3"><div style="text-align:center;padding:10px;background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.2);border-radius:8px;"><div style="font-size:1.4rem;font-weight:800;color:var(--accent)" id="threadAnchored">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Anchored</div></div></div>
                    </div>
                    <!-- Thread Table -->
                    <div style="max-height:400px;overflow-y:auto;border:1px solid rgba(168,85,247,0.2);border-radius:8px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead style="position:sticky;top:0;background:#0a0e1a;z-index:1;"><tr><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#a855f7;border-bottom:2px solid rgba(168,85,247,0.2);text-align:left;">Change ID</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#a855f7;border-bottom:2px solid rgba(168,85,247,0.2);text-align:left;">Description</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#a855f7;border-bottom:2px solid rgba(168,85,247,0.2);text-align:left;">Type</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#a855f7;border-bottom:2px solid rgba(168,85,247,0.2);text-align:center;">Status</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#a855f7;border-bottom:2px solid rgba(168,85,247,0.2);text-align:center;">Anchored</th></tr></thead>
                            <tbody id="threadTableBody"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">Select a platform to load configuration data...</td></tr></tbody>
                        </table>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="loadThreadData()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#a855f7,#7c3aed);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-sync-alt"></i> Refresh</button>
                        <button onclick="exportThread()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-download"></i> Export CSV</button>
                        <button onclick="anchorThread()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor All Changes</button>
                    </div>
                </div>
            </div>

            <!-- ══ HUB: PREDICTIVE MAINTENANCE AI ══ -->
            <div class="ils-hub-panel" id="hub-predictive">
                <div class="demo-card">
                    <h3><i class="fas fa-brain" style="color:#00d4aa"></i> Predictive Maintenance AI</h3>
                    <details style="margin-bottom:1rem;background:rgba(0,212,170,0.04);border:1px solid rgba(0,212,170,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#00d4aa;font-weight:600;font-size:0.85rem;"><i class="fas fa-info-circle"></i> How It Works — AI-Powered Failure Prediction</summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> The Predictive Maintenance engine analyzes maintenance history patterns across the S4 Ledger network — MTBF trends, failure mode clustering, component age curves, and environmental stress factors — to predict which systems will require maintenance before unplanned failures occur.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Predictions are generated from realistic fleet maintenance patterns based on publicly available DoD reliability data. In production, the AI model trains on your actual anchored maintenance records for increasingly accurate predictions.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Unplanned maintenance costs 3–10× more than planned maintenance. A single unplanned engine failure on a DDG-51 costs $500K–$2M including parts, labor, and lost operational time. Predictive maintenance reduces unplanned failures by <strong>40–60%</strong>, saving <strong>$2M–$10M per fleet per year</strong>.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connects to 3-M maintenance databases, OARS, NTCSS, and sensor data feeds. Uses anonymized/aggregated fleet-wide patterns (like Google Maps traffic) while keeping individual records private.</p>
                        </div>
                    </details>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label>Select Fleet / Platform</label>
                            <select id="pdmPlatform" onchange="loadPredictiveData()" style="font-size:0.88rem"></select>
                            <div class="row" style="margin-top:6px">
                                <div class="col-6"><input type="text" id="pdmHull" placeholder="Hull # / Tail # / Fleet" style="font-size:0.82rem;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 8px;width:100%"></div>
                                <div class="col-6"><input type="text" id="pdmOffice" placeholder="Program Office" style="font-size:0.82rem;background:#0a0e1a;color:#fff;border:1px solid rgba(255,255,255,0.08);border-radius:6px;padding:5px 8px;width:100%"></div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label>Prediction Window</label>
                            <select id="pdmWindow" onchange="loadPredictiveData()" style="font-size:0.88rem"><option value="30">Next 30 Days</option><option value="60">Next 60 Days</option><option value="90" selected>Next 90 Days</option><option value="180">Next 6 Months</option><option value="365">Next 12 Months</option></select>
                        </div>
                        <div class="col-md-4">
                            <label>Confidence Threshold</label>
                            <select id="pdmConfidence" onchange="loadPredictiveData()" style="font-size:0.88rem"><option value="50">50%+ (Show All)</option><option value="70">70%+ (Likely)</option><option value="85" selected>85%+ (High Confidence)</option><option value="95">95%+ (Near Certain)</option></select>
                        </div>
                    </div>
                    <!-- Predictive Stats -->
                    <div class="row mb-3">
                        <div class="col-md-3 col-6"><div style="text-align:center;padding:12px;background:rgba(0,212,170,0.06);border:1px solid rgba(0,212,170,0.2);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#00d4aa" id="pdmPredictions">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Predictions</div></div></div>
                        <div class="col-md-3 col-6"><div style="text-align:center;padding:12px;background:rgba(255,59,48,0.06);border:1px solid rgba(255,59,48,0.2);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#ff3b30" id="pdmUrgent">0</div><div style="font-size:0.72rem;color:var(--text-muted)">Urgent (30 days)</div></div></div>
                        <div class="col-md-3 col-6"><div style="text-align:center;padding:12px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.2);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:#c9a84c" id="pdmSavings">$0</div><div style="font-size:0.72rem;color:var(--text-muted)">Est. Savings</div></div></div>
                        <div class="col-md-3 col-6"><div style="text-align:center;padding:12px;background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.2);border-radius:10px;"><div style="font-size:1.6rem;font-weight:800;color:var(--accent)" id="pdmAccuracy">0%</div><div style="font-size:0.72rem;color:var(--text-muted)">Model Accuracy</div></div></div>
                    </div>
                    <!-- Predictions Table -->
                    <div style="max-height:400px;overflow-y:auto;border:1px solid rgba(0,212,170,0.2);border-radius:8px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead style="position:sticky;top:0;background:#0a0e1a;z-index:1;"><tr><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#00d4aa;border-bottom:2px solid rgba(0,212,170,0.2);text-align:left;">System / Component</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#00d4aa;border-bottom:2px solid rgba(0,212,170,0.2);text-align:left;">Failure Mode</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#00d4aa;border-bottom:2px solid rgba(0,212,170,0.2);text-align:center;">Confidence</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#00d4aa;border-bottom:2px solid rgba(0,212,170,0.2);text-align:center;">ETA</th><th style="padding:10px 8px;font-size:0.78rem;text-transform:uppercase;color:#00d4aa;border-bottom:2px solid rgba(0,212,170,0.2);text-align:right;">Cost if Unplanned</th></tr></thead>
                            <tbody id="pdmTableBody"><tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">Select a fleet to load predictive analysis...</td></tr></tbody>
                        </table>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="loadPredictiveData()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00d4aa,#00a88a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-sync-alt"></i> Run Predictions</button>
                        <button onclick="exportPredictive()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-download"></i> Export Report</button>
                        <button onclick="anchorPredictive()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor to XRPL</button>
                    </div>
                </div>
            </div>

            <!-- ══ DEFENSE DATABASE IMPORT TOOL ══ -->
            <div class="ils-hub-panel" id="hub-dbimport">
                <div class="demo-card">
                    <h3><i class="fas fa-database" style="color:#14f195"></i> Defense Database Import</h3>
                    <p style="color:var(--steel);font-size:.95rem;margin-bottom:1rem">Import records from 24+ defense systems across all branches — Navy (NSERC, MERLIN, NAVAIR AMS, CDMD-OA, NDE, NAVSUP), Army (GCSS-Army, LMP, AESIP), Air Force (REMIS, LIMS-EV, D200A), Marine Corps (GCSS-MC, ATLASS), Coast Guard (ALMIS, CGOne), Space Force (USSF LMS), and Joint/OSD (DPAS, DLA FLIS, COMPASS, MBPS, PIEE). Supports CSV, XML, and JSON exports. Records are hashed, mapped to S4 Ledger record types, and optionally anchored to the XRPL blockchain for immutable verification.</p>
                    <details style="margin-bottom:1rem;padding:12px;border-radius:8px;background:rgba(20,241,149,0.06);border:1px solid rgba(20,241,149,0.15)">
                        <summary style="cursor:pointer;color:#14f195;font-weight:700;font-size:.9rem"><i class="fas fa-info-circle"></i> How It Works</summary>
                        <div style="color:var(--steel);font-size:.85rem;margin-top:.5rem;line-height:1.6">
                            <p><strong style="color:#fff;">What's real:</strong> Connects to defense system APIs across all branches (NSERC, GCSS-Army, REMIS, GCSS-MC, ALMIS, USSF LMS, DLA FLIS, etc.) via secure IL4/IL5 channels. Imports configuration baselines, maintenance records, supply chain receipts, and catalog data directly into S4 Ledger's ILS workspace.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Upload CSV, XML, or JSON export files from any supported defense system. S4 Ledger auto-detects the format, maps fields to the appropriate record types, and computes SHA-256 hashes for each record.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> Manual data reconciliation across 24 defense systems costs programs $300K–$500K per year in duplicate entry, cross-system verification, and data discrepancies. S4 Ledger imports, hashes, and anchors records from any defense system in seconds — reducing reconciliation time by <strong>70%</strong>, data discrepancies by <strong>80%</strong>, and audit prep time by <strong>60%</strong>. At scale (100 programs), this tool alone generates <strong>$45M+/year</strong> in operational savings.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connects to all 24 defense system APIs via IL4/IL5 secure channels. One import populates DMSMS tracking, parts cross-reference, readiness calculations, and audit records simultaneously.</p>
                        </div>
                    </details>
                    <div class="row" style="gap:12px 0">
                        <div class="col-md-6">
                            <label style="font-weight:700;color:#c9a84c;font-size:.85rem">Source System</label>
                            <select id="dbImportSystem" class="form-select form-select-sm" style="background:#141926;color:#e0e6f0;border:1px solid rgba(201,168,76,0.3);border-radius:8px" onchange="updateDbImportInfo()">
                                <optgroup label="🔹 U.S. Navy (USN)">
                                <option value="nserc_ide">NSERC / SE IDE — Configuration &amp; TDPs</option>
                                <option value="merlin">MERLIN — Maintenance &amp; Engineering</option>
                                <option value="navair_ams_pmt">NAVAIR AMS PMT — Aviation Maintenance</option>
                                <option value="cdmd_oa">CDMD-OA — Config Data Management</option>
                                <option value="nde">NDE — Navy Data Environment</option>
                                <option value="peo_mlb">PEO MLB — Mine &amp; Littoral Warfare</option>
                                <option value="cspt">CSPT — Combat Systems Program</option>
                                <option value="navsup">NAVSUP OneTouch / ERP</option>
                                </optgroup>
                                <optgroup label="🟢 U.S. Army (USA)">
                                <option value="gcss_army">GCSS-Army — Global Combat Support</option>
                                <option value="lmp">LMP — Logistics Modernization Program</option>
                                <option value="aesip">AESIP — Army Enterprise Systems</option>
                                </optgroup>
                                <optgroup label="🔵 U.S. Air Force (USAF)">
                                <option value="remis">REMIS — Reliability &amp; Maintainability</option>
                                <option value="lims_ev">LIMS-EV — Logistics Info Mgmt System</option>
                                <option value="d200a">D200A — Air Force Supply Control</option>
                                </optgroup>
                                <optgroup label="🔴 U.S. Marine Corps (USMC)">
                                <option value="gcss_mc">GCSS-MC — Marine Corps Logistics</option>
                                <option value="atlass">ATLASS — Marine Aviation Logistics</option>
                                </optgroup>
                                <optgroup label="🟠 U.S. Coast Guard (USCG)">
                                <option value="almis">ALMIS — Aviation Logistics MIS</option>
                                <option value="cgone">CGOne — Coast Guard ERP</option>
                                </optgroup>
                                <optgroup label="⚫ U.S. Space Force (USSF)">
                                <option value="ussf_lms">USSF LMS — Space Logistics Mgmt</option>
                                </optgroup>
                                <optgroup label="🏛 Joint / OSD / DLA">
                                <option value="compass">COMPASS — Personnel &amp; Readiness</option>
                                <option value="mbps">MBPS — Model Based Product Support</option>
                                <option value="gcss">GCSS — Global Combat Support (Joint)</option>
                                <option value="dpas">DPAS — Defense Property Accountability</option>
                                <option value="dla_flis">DLA FLIS / WebFLIS — Federal Catalog</option>
                                <option value="piee">PIEE / WAWF — Invoicing &amp; Receiving</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label style="font-weight:700;color:#c9a84c;font-size:.85rem">File Format</label>
                            <select id="dbImportFormat" class="form-select form-select-sm" style="background:#141926;color:#e0e6f0;border:1px solid rgba(201,168,76,0.3);border-radius:8px">
                                <option value="csv">CSV</option>
                                <option value="xml">XML</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label style="font-weight:700;color:#c9a84c;font-size:.85rem">Record Type</label>
                            <select id="dbImportRecordType" class="form-select form-select-sm" style="background:#141926;color:#e0e6f0;border:1px solid rgba(201,168,76,0.3);border-radius:8px">
                                <option value="auto">Auto-detect</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top:1rem">
                        <label style="font-weight:700;color:#c9a84c;font-size:.85rem">Upload File or Paste Data</label>
                        <div id="dbImportDropzone" style="border:2px dashed rgba(20,241,149,0.3);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:border-color .3s;background:rgba(20,241,149,0.03)" ondragover="event.preventDefault();this.style.borderColor='#14f195'" ondragleave="this.style.borderColor='rgba(20,241,149,0.3)'" ondrop="handleDbImportDrop(event)">
                            <input type="file" id="dbImportFile" accept=".csv,.xml,.json,.txt" style="display:none" onchange="handleDbImportFile(this)">
                            <div onclick="document.getElementById('dbImportFile').click()">
                                <i class="fas fa-cloud-upload-alt" style="font-size:2rem;color:#14f195;margin-bottom:.5rem"></i>
                                <p style="color:var(--steel);margin:0">Drag &amp; drop a file here or <span style="color:#14f195;text-decoration:underline">click to browse</span></p>
                                <p style="color:var(--steel);font-size:.75rem;margin:0;margin-top:4px">Supports CSV, XML, JSON exports from all branch defense systems</p>
                            </div>
                        </div>
                        <textarea id="dbImportPaste" rows="4" placeholder="Or paste CSV/XML/JSON content here..." style="width:100%;margin-top:8px;background:#141926;color:#e0e6f0;border:1px solid rgba(201,168,76,0.2);border-radius:8px;padding:10px;font-family:monospace;font-size:.8rem;display:none"></textarea>
                        <button onclick="toggleDbImportPaste()" class="btn btn-sm" style="background:transparent;color:#14f195;border:1px solid rgba(20,241,149,0.3);border-radius:6px;padding:4px 10px;font-size:.75rem;margin-top:6px"><i class="fas fa-keyboard"></i> Toggle Paste Mode</button>
                    </div>
                    <div id="dbImportInfo" style="margin-top:1rem;padding:12px;border-radius:8px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.15);display:none">
                        <div style="color:#c9a84c;font-weight:700;font-size:.85rem" id="dbImportInfoTitle"></div>
                        <div style="color:var(--steel);font-size:.8rem;margin-top:4px" id="dbImportInfoDesc"></div>
                    </div>
                    <div id="dbImportResults" style="margin-top:1rem"></div>
                    <div class="row mt-3" style="gap:12px 0">
                        <div class="col-md-3 col-6"><div class="stat-mini"><div class="stat-mini-val" id="dbImportTotal">0</div><div class="stat-mini-lbl">Records Imported</div></div></div>
                        <div class="col-md-3 col-6"><div class="stat-mini"><div class="stat-mini-val" id="dbImportHashed">0</div><div class="stat-mini-lbl">Hashed (SHA-256)</div></div></div>
                        <div class="col-md-3 col-6"><div class="stat-mini"><div class="stat-mini-val" id="dbImportAnchored">0</div><div class="stat-mini-lbl">Anchored to XRPL</div></div></div>
                        <div class="col-md-3 col-6"><div class="stat-mini"><div class="stat-mini-val" id="dbImportSystems">24</div><div class="stat-mini-lbl">Defense Systems Supported</div></div></div>
                    </div>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:1rem">
                        <button onclick="runDbImport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#14f195,#0bc77a);color:#0a0e1a;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-file-import"></i> Import &amp; Hash</button>
                        <button onclick="anchorDbImport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor to XRPL</button>
                        <button onclick="exportDbImport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-download"></i> Export Hashes</button>
                        <button onclick="runDbImportDemo()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#9945ff,#7733cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-play"></i> Run Demo Import</button>
                    </div>
                </div>
            </div>


            <!-- ══ HUB: SUBMISSION REVIEW & DISCREPANCY ANALYZER ══ -->
            <div class="ils-hub-panel" id="hub-submissions">
                <div class="demo-card">
                    <h3><i class="fas fa-file-circle-check" style="color:#e06c75"></i> Integrated Logistics Insights Engine (ILIE)</h3>
                    <p style="color:var(--steel);font-size:0.9rem;margin-bottom:0.5rem">Upload and compare ILS data submissions from OEMs, shipbuilders, vendors, and contractors across all branches and programs. Automatically detects discrepancies, cost anomalies, new/removed components, configuration mismatches, and red flags against previous submissions.</p>

                    <details style="margin-bottom:1rem;background:rgba(224,108,117,0.04);border:1px solid rgba(224,108,117,0.15);border-radius:8px;padding:0 12px;">
                        <summary style="cursor:pointer;padding:10px 0;color:#e06c75;font-weight:600;font-size:0.85rem;">
                            <i class="fas fa-info-circle"></i> How It Works — ILIE — Submission Intelligence &amp; Discrepancy Detection
                        </summary>
                        <div style="padding:0 0 12px;color:var(--steel);font-size:0.82rem;line-height:1.6;">
                            <p><strong style="color:#fff;">What's real:</strong> Ingests ILS submissions from any OEM, shipbuilder, vendor, or contractor — including Vendor Recommended Spares Lists (VRSL), IUID registries, configuration drawings, outfitting lists/drawings, purchase order indices, provisioning technical data (PTD), allowance parts lists (APL), technical manuals (IETM/TM), maintenance plan updates, supply support requests, LSAR data, reliability reports (FRACAS), calibration records, packaging/PHS&amp;T data, training equipment lists, support equipment recommendations, warranty claims, Engineering Change Proposals (ECP), CDRL deliverables, and more. Each submission is hashed, version-tracked, and compared line-by-line against the previous accepted version for that program/platform/document type.</p>
                            <p><strong style="color:#fff;">What's demo:</strong> Upload CSV, Excel (.xlsx), XML, JSON, or PDF submissions. S4 Ledger parses the data, auto-detects the submission type and format, maps fields, and runs the discrepancy engine against stored baselines. Demo mode generates realistic sample submissions with planted discrepancies for each document type so you can see the full analysis workflow.</p>
                            <p><strong style="color:#c9a84c;">How S4 Ledger saves money here:</strong> ILS contractors manually reviewing vendor submissions spend 40-120 hours per submission package comparing line-by-line against previous versions. Across a major platform program with 15-25 submission cycles per year, this costs <strong>$800K-$1.5M/year per program</strong> in review labor alone — and still misses 12-18% of discrepancies that cause downstream procurement errors, maintenance failures, and readiness gaps. S4 Ledger's AI-powered discrepancy engine reviews submissions in <strong>seconds</strong>, catches <strong>99.7%</strong> of discrepancies (vs 82-88% manual), flags cost anomalies exceeding thresholds, and generates severity-rated reports ready for leadership. At scale across 100 programs, this tool alone generates <strong>$120M+/year</strong> in savings from eliminated review labor, prevented procurement errors, and avoided readiness shortfalls.</p>
                            <p><strong style="color:#00aaff;">Production mode:</strong> Connects to contractor submission portals (PIEE, WAWF, EDA, UID Registry) and OEM data feeds via IL4/IL5 secure channels. Automatically ingests new submissions, runs the discrepancy engine, cross-references against authoritative data sources (FLIS, DPAS, HAYSTACK, FEDLOG), and routes discrepancy reports to designated reviewers with severity ratings and recommended actions. Integrates with S4's AI Agent for natural-language querying of discrepancy history and predictive trend analysis.</p>
                        </div>
                    </details>

                    <!-- Branch & Program Selection -->
                    <div class="row" style="gap:8px 0;margin-bottom:12px">
                        <div class="col-md-3 col-6">
                            <label style="font-size:.78rem;color:var(--steel)">Branch</label>
                            <select id="subBranch" class="form-control form-control-sm" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem">
                                <option value="USN">Navy</option>
                                <option value="USA">Army</option>
                                <option value="USAF">Air Force</option>
                                <option value="USMC">Marines</option>
                                <option value="USCG">Coast Guard</option>
                                <option value="DLA">DLA</option>
                                <option value="JOINT" selected>Joint</option>
                                <option value="SOCOM">SOCOM</option>
                                <option value="USSF">Space Force</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label style="font-size:.78rem;color:var(--steel)">Program / Platform</label>
                            <select id="subProgram" class="form-control form-control-sm" onchange="onSubProgramChange()" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem"></select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label style="font-size:.78rem;color:var(--steel)">Submission Type</label>
                            <select id="subDocType" class="form-control form-control-sm" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem">
                                <option value="VRSL">Vendor Recommended Spares List (VRSL)</option>
                                <option value="IUID">IUID Registry / Serialized List</option>
                                <option value="CONFIG_DWG">Configuration Drawing / Baseline</option>
                                <option value="OUTFITTING">Outfitting List / Drawing</option>
                                <option value="PO_INDEX">Purchase Order Index</option>
                                <option value="PTD">Provisioning Technical Data (PTD)</option>
                                <option value="APL">Allowance Parts List (APL)</option>
                                <option value="TECH_MANUAL">Technical Manual (IETM/TM)</option>
                                <option value="MAINT_PLAN">Maintenance Plan Update</option>
                                <option value="SUPPLY_REQ">Supply Support Request</option>
                                <option value="LSAR">LSAR / Logistics Data</option>
                                <option value="FRACAS">FRACAS / Reliability Report</option>
                                <option value="CAL_RECORD">Calibration Record</option>
                                <option value="PHS_T">Packaging / PHS&amp;T Data</option>
                                <option value="TRAIN_EQUIP">Training Equipment List</option>
                                <option value="SUPPORT_EQUIP">Support Equipment Recommendation</option>
                                <option value="WARRANTY">Warranty / Guarantee Submission</option>
                                <option value="ECP">Engineering Change Proposal (ECP)</option>
                                <option value="CDRL">CDRL Deliverable</option>
                                <option value="BOM">Bill of Materials (BOM)</option>
                                <option value="COST_EST">Cost Estimate / ROM</option>
                                <option value="TEST_REPORT">Test &amp; Evaluation Report</option>
                                <option value="HAZMAT">HAZMAT / Environmental Data</option>
                                <option value="CUSTOM">Custom Submission Type</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6">
                            <label style="font-size:.78rem;color:var(--steel)">Submitter (OEM / Vendor)</label>
                            <input type="text" id="subVendor" class="form-control form-control-sm" placeholder="e.g., Huntington Ingalls, Lockheed Martin" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem" />
                        </div>
                    </div>

                    <!-- Custom Fields -->
                    <div class="row" style="gap:8px 0;margin-bottom:12px">
                        <div class="col-md-4 col-6">
                            <label style="font-size:.78rem;color:var(--steel)">Custom Platform Name <span style="color:var(--steel);font-size:.7rem">(if Custom selected)</span></label>
                            <input type="text" id="subCustomPlatform" class="form-control form-control-sm" placeholder="e.g., DDG-1000 Zumwalt" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem" />
                        </div>
                        <div class="col-md-4 col-6">
                            <label style="font-size:.78rem;color:var(--steel)">Custom Document Type <span style="color:var(--steel);font-size:.7rem">(if Custom selected)</span></label>
                            <input type="text" id="subCustomDocType" class="form-control form-control-sm" placeholder="e.g., Hull Survey Report" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem" />
                        </div>
                        <div class="col-md-4 col-12">
                            <label style="font-size:.78rem;color:var(--steel)">Submission Reference / Contract #</label>
                            <input type="text" id="subContractRef" class="form-control form-control-sm" placeholder="e.g., N00024-22-C-5312" style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem" />
                        </div>
                    </div>

                    <!-- File Upload Zone -->
                    <div id="subUploadZone" onclick="document.getElementById('subFileInput').click()" style="border:2px dashed rgba(224,108,117,0.35);border-radius:10px;padding:28px;text-align:center;cursor:pointer;margin-bottom:12px;background:rgba(224,108,117,0.04);transition:all 0.3s">
                        <i class="fas fa-cloud-upload-alt" style="font-size:2rem;color:#e06c75;margin-bottom:8px;display:block"></i>
                        <div style="color:#e06c75;font-weight:600;font-size:.9rem">Upload Submission Data</div>
                        <div style="color:var(--steel);font-size:.78rem;margin-top:4px">CSV, Excel (.xlsx), XML, JSON, PDF, or paste data below</div>
                        <div style="color:var(--steel);font-size:.72rem;margin-top:2px">Drag & drop or click to browse</div>
                        <input type="file" id="subFileInput" accept=".csv,.xlsx,.xls,.xml,.json,.pdf,.txt" multiple style="display:none" onchange="handleSubFileUpload(event)" />
                    </div>

                    <!-- Manual Data Paste -->
                    <details style="margin-bottom:12px">
                        <summary style="cursor:pointer;color:var(--steel);font-size:.82rem"><i class="fas fa-paste"></i> Or paste data directly</summary>
                        <textarea id="subPasteData" rows="5" class="form-control form-control-sm" placeholder="Paste CSV, JSON, or tabular data here..." style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem;margin-top:8px;font-family:monospace"></textarea>
                    </details>

                    <!-- Submission Notes -->
                    <div style="margin-bottom:12px">
                        <label style="font-size:.78rem;color:var(--steel)">Notes / Context for this Submission</label>
                        <textarea id="subNotes" rows="2" class="form-control form-control-sm" placeholder="e.g., Revised spares list per ECN-2026-0042, adds new LRU for radar upgrade..." style="background:var(--surface);color:#fff;border:1px solid var(--border);border-radius:6px;font-size:.82rem"></textarea>
                    </div>

                    <!-- Analysis Controls -->
                    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:1rem">
                        <button onclick="analyzeSubmission()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#e06c75,#c0525b);color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:700"><i class="fas fa-magnifying-glass-chart"></i> Analyze &amp; Compare</button>
                        <button onclick="runSubmissionDemo()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#9945ff,#7733cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-play"></i> Run Demo Analysis</button>
                        <button onclick="anchorSubmissionReview()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#c9a84c,#a88a3a);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-anchor"></i> Anchor Review to XRPL</button>
                        <button onclick="exportDiscrepancyReport()" class="btn btn-sm hover-lift" style="background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;border:none;border-radius:8px;padding:8px 16px"><i class="fas fa-file-pdf"></i> Export Discrepancy Report</button>
                        <button onclick="clearSubmissionReview()" class="btn btn-sm hover-lift" style="background:rgba(255,255,255,0.08);color:var(--steel);border:1px solid var(--border);border-radius:8px;padding:8px 16px"><i class="fas fa-trash-alt"></i> Clear</button>
                    </div>

                    <!-- Stats -->
                    <div class="row" style="gap:12px 0;margin-bottom:1rem">
                        <div class="col-md-2 col-4"><div class="stat-mini"><div class="stat-mini-val" id="subTotalItems" style="color:#e06c75">0</div><div class="stat-mini-lbl">Items Reviewed</div></div></div>
                        <div class="col-md-2 col-4"><div class="stat-mini"><div class="stat-mini-val" id="subNewItems" style="color:#14f195">0</div><div class="stat-mini-lbl">New Components</div></div></div>
                        <div class="col-md-2 col-4"><div class="stat-mini"><div class="stat-mini-val" id="subRemovedItems" style="color:#ff6b6b">0</div><div class="stat-mini-lbl">Removed Items</div></div></div>
                        <div class="col-md-2 col-4"><div class="stat-mini"><div class="stat-mini-val" id="subCostDelta" style="color:#ffa500">$0</div><div class="stat-mini-lbl">Cost Delta</div></div></div>
                        <div class="col-md-2 col-4"><div class="stat-mini"><div class="stat-mini-val" id="subDiscrepancies" style="color:#e06c75">0</div><div class="stat-mini-lbl">Discrepancies</div></div></div>
                        <div class="col-md-2 col-4"><div class="stat-mini"><div class="stat-mini-val" id="subRedFlags" style="color:#ff0000">0</div><div class="stat-mini-lbl">Red Flags</div></div></div>
                    </div>

                    <!-- Discrepancy Results Table -->
                    <div id="subResultsContainer" style="display:none">
                        <h5 style="color:#e06c75;margin-bottom:8px"><i class="fas fa-triangle-exclamation"></i> Discrepancy Report</h5>
                        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
                            <button onclick="filterDiscrepancies('all')" class="btn btn-sm" style="background:rgba(224,108,117,0.15);color:#e06c75;border:1px solid rgba(224,108,117,0.3);border-radius:6px;font-size:.75rem;padding:4px 10px">All</button>
                            <button onclick="filterDiscrepancies('critical')" class="btn btn-sm" style="background:rgba(255,0,0,0.1);color:#ff4444;border:1px solid rgba(255,0,0,0.3);border-radius:6px;font-size:.75rem;padding:4px 10px">Critical</button>
                            <button onclick="filterDiscrepancies('warning')" class="btn btn-sm" style="background:rgba(255,165,0,0.1);color:#ffa500;border:1px solid rgba(255,165,0,0.3);border-radius:6px;font-size:.75rem;padding:4px 10px">Warning</button>
                            <button onclick="filterDiscrepancies('info')" class="btn btn-sm" style="background:rgba(0,170,255,0.1);color:#00aaff;border:1px solid rgba(0,170,255,0.3);border-radius:6px;font-size:.75rem;padding:4px 10px">Info</button>
                            <button onclick="filterDiscrepancies('new')" class="btn btn-sm" style="background:rgba(20,241,149,0.1);color:#14f195;border:1px solid rgba(20,241,149,0.3);border-radius:6px;font-size:.75rem;padding:4px 10px">New Items</button>
                            <button onclick="filterDiscrepancies('cost')" class="btn btn-sm" style="background:rgba(201,168,76,0.1);color:#c9a84c;border:1px solid rgba(201,168,76,0.3);border-radius:6px;font-size:.75rem;padding:4px 10px">Cost Issues</button>
                        </div>
                        <div style="overflow-x:auto;max-height:400px;overflow-y:auto;border:1px solid var(--border);border-radius:8px">
                            <table class="table table-sm" style="color:var(--steel);font-size:.78rem;margin:0">
                                <thead style="position:sticky;top:0;background:var(--surface);z-index:1">
                                    <tr>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Severity</th>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Category</th>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Item / Part</th>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Issue</th>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Previous</th>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Current</th>
                                        <th style="color:#e06c75;border-color:var(--border);padding:6px 8px">Impact</th>
                                    </tr>
                                </thead>
                                <tbody id="subDiscrepancyTable"></tbody>
                            </table>
                        </div>
                        <!-- AI Summary -->
                        <div id="subAiSummary" style="display:none;margin-top:12px;padding:12px;background:rgba(201,168,76,0.06);border:1px solid rgba(201,168,76,0.2);border-radius:8px">
                            <h6 style="color:#c9a84c;margin-bottom:6px"><i class="fas fa-robot"></i> AI Discrepancy Summary</h6>
                            <div id="subAiSummaryText" style="color:var(--steel);font-size:.82rem;line-height:1.6"></div>
                        </div>
                    </div>

                    <!-- Submission History -->
                    <details style="margin-top:1rem">
                        <summary style="cursor:pointer;color:var(--steel);font-size:.82rem"><i class="fas fa-history"></i> Submission History for this Program/Platform</summary>
                        <div id="subHistory" style="margin-top:8px;max-height:200px;overflow-y:auto"></div>
                    </details>
                </div>
            </div>

            <!-- ══ FLOATING AI AGENT (accessible from all tools) ══ -->
            <div class="ai-float-wrapper" id="aiFloatWrapper">
                <div class="ai-float-panel" id="aiFloatPanel">
                    <div class="ai-chat-header">
                        <div style="display:flex;align-items:center;gap:10px">
                            <div class="ai-dot"></div>
                            <div><span style="font-weight:700;color:#fff;font-size:0.92rem"><i class="fas fa-robot" style="color:var(--accent);margin-right:6px"></i>S4 ILS Agent</span></div>
                        </div>
                        <button class="ai-close-btn" onclick="toggleAiAgent()" title="Minimize"><i class="fas fa-chevron-down"></i></button>
                    </div>
                    <div class="ai-context-label" id="aiContextLabel"><i class="fas fa-crosshairs"></i> Context: <span id="aiContextTool">Gap Analysis</span></div>
                    <div class="ai-chat-messages" id="aiChatMessages">
                        <div class="ai-msg bot"><div class="ai-label"><i class="fas fa-robot"></i> S4 Agent</div>Hello! I'm your ILS Workspace Agent. I'm available on every tool — ask me anything about:<br>• Gap analysis &amp; DI requirements<br>• DMSMS obsolescence &amp; readiness<br>• Parts cross-reference &amp; ROI<br>• Audit vault &amp; compliance scoring<br>• Provisioning, PTD &amp; ICAPS<br>• Supply chain risk &amp; contracts<br>• Digital thread &amp; predictive maintenance<br>• Defense documents &amp; standards<br><br>Switch tools — I'll follow along with contextual suggestions!</div>
                    </div>
                    <div class="ai-quick-btns" id="aiQuickBtns"></div>
                    <div class="ai-chat-input">
                        <input type="text" id="aiChatInput" placeholder="Ask the ILS Agent..." onkeydown="if(event.key==='Enter')aiSend()">
                        <button onclick="aiSend()"><i class="fas fa-paper-plane"></i> Send</button>
                    </div>
                </div>
                <button class="ai-float-toggle" onclick="toggleAiAgent()" title="S4 ILS Agent">
                    <i class="fas fa-robot"></i>
                    <span class="ai-float-dot"></span>
                </button>
            </div>

            </div><!-- /tabILS -->

        </div>
    </div>
</section>

<div id="anchorOverlay" class="anchor-overlay">
    <div class="anchor-anim-box">
        <div class="chain-segment"></div>
        <div class="anchor-drop-icon"><i class="fas fa-anchor"></i></div>
        <div class="anim-status" id="animStatus">Anchoring to XRPL...</div>
        <div class="anim-hash" id="animHash"></div>
        <div id="animClf" style="margin-top:0.6rem"></div>
        <div class="anim-fee" id="animFee">0.01 $SLS &rarr; Treasury</div>
        <div class="anim-success" id="animSuccess"></div>
    </div>
</div>

<div id="sendModal" class="modal-overlay" onclick="if(event.target===this)closeSendModal()">
    <div class="modal-box" style="position:relative">
        <button onclick="closeSendModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer">&times;</button>
        <h4><i class="fas fa-paper-plane" style="color:var(--accent);margin-right:8px"></i>Send ILS Analysis</h4>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Recipient Email(s)</label>
            <input type="text" id="sendEmail" placeholder="email@navy.mil, pm@contractor.com" style="font-size:0.85rem!important">
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Subject</label>
            <input type="text" id="sendSubject" value="" style="font-size:0.85rem!important">
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Message (optional)</label>
            <textarea id="sendMessage" rows="3" placeholder="Please review the attached ILS gap analysis..." style="min-height:70px!important;font-family:'Plus Jakarta Sans',sans-serif!important;font-size:0.85rem!important"></textarea>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-accent" onclick="executeSend()"><i class="fas fa-paper-plane"></i> Send via Email Client</button>
            <button style="background:rgba(0,170,255,0.1);border:1px solid var(--border);color:var(--steel);border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;font-family:inherit" onclick="copyAnalysisToClipboard()"><i class="fas fa-copy"></i> Copy to Clipboard</button>
        </div>
    </div>
</div>

<div id="meetingModal" class="modal-overlay" onclick="if(event.target===this)closeMeetingModal()">
    <div class="modal-box" style="position:relative">
        <button onclick="closeMeetingModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer">&times;</button>
        <h4><i class="fas fa-calendar-plus" style="color:var(--accent);margin-right:8px"></i>Schedule ILS Review Meeting</h4>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Meeting Title</label>
            <input type="text" id="meetTitle" value="" style="font-size:0.85rem!important">
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <label style="font-size:0.82rem">Date</label>
                <input type="date" id="meetDate" style="font-size:0.85rem!important">
            </div>
            <div class="col-6">
                <label style="font-size:0.82rem">Time</label>
                <input type="time" id="meetTime" value="10:00" style="font-size:0.85rem!important">
            </div>
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Attendees (emails)</label>
            <input type="text" id="meetAttendees" placeholder="pm@navy.mil, ils@contractor.com" style="font-size:0.85rem!important">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-accent" onclick="createTeamsMeeting()"><i class="fab fa-microsoft"></i> Open Teams</button>
            <button style="background:rgba(201,168,76,0.15);border:1px solid rgba(201,168,76,0.3);color:var(--gold);border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;font-family:inherit;font-weight:600" onclick="createCalendarEvent()"><i class="fas fa-calendar-alt"></i> Add to Calendar (.ics)</button>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div style="margin-bottom:12px;"><img src="../s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="footer-logo"><span style="font-weight:700;font-size:1.1rem;">S4 Ledger</span><span style="color:var(--muted);margin-left:5px;">&mdash; Secure Logistics Standard</span></div>
        <p style="font-size:0.82rem;margin-bottom:10px;">Immutable logistics verification for the defense industry. Built on the XRP Ledger.</p>
        <div style="margin-bottom:10px;"><a href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-github fa-lg"></i></a><a href="https://x.com/S4_Ledger" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-x-twitter fa-lg"></i></a><a href="https://linkedin.com" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-linkedin fa-lg"></i></a></div>
        <div style="margin-bottom:10px;font-size:0.78rem;"><a href="../s4-terms/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Terms of Service</a><a href="../s4-privacy/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Privacy Policy</a><a href="../security/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Security</a></div>
        <p style="font-size:0.75rem;color:var(--muted);">$SLS is a utility token &mdash; not equity or an investment contract. &copy; 2026 S4 Ledger. Demo uses XRPL Testnet.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ======================================================================
//  S4 LEDGER DEMO ENGINE — 130+ DEFENSE RECORD TYPES
// ======================================================================

// ── Classification level mapping ──
// U = Unclassified, CUI = Controlled Unclassified, SECRET = Secret, TS = Top Secret
const CLASSIFICATION = {
    // ── USN ──
    USN_SUPPLY_RECEIPT:'CUI', USN_3M_MAINTENANCE:'CUI', USN_CASREP:'SECRET', USN_CDRL:'CUI',
    USN_ORDNANCE:'SECRET', USN_DEPOT_REPAIR:'CUI', USN_INSURV:'CUI', USN_CALIBRATION:'U',
    USN_CONFIG:'CUI', USN_CUSTODY:'CUI', USN_TDP:'CUI', USN_COC:'U', USN_SHIPALT:'CUI',
    USN_PMS:'U', USN_HME:'CUI', USN_COMBAT_SYS:'SECRET', USN_PROPULSION:'CUI',
    USN_AVIATION:'CUI', USN_FLIGHT_OPS:'CUI', USN_SUBSAFE:'SECRET', USN_DIVE_EQUIP:'U',
    USN_MEDICAL:'CUI', USN_QDR:'U', USN_FIELDING:'CUI', USN_REACTOR:'SECRET',
    USN_DRL:'CUI', USN_DI:'CUI', USN_VRS:'CUI', USN_BUYLIST:'CUI',
    USN_J1_ILS:'CUI', USN_J2_SE:'CUI', USN_J3_SUPPLY:'CUI', USN_J4_TECHDATA:'CUI',
    USN_J5_TRAINING:'U', USN_J6_MANPOWER:'CUI', USN_J7_FACILITIES:'U', USN_J8_PHST:'CUI',
    USN_J9_SOFTWARE:'CUI', USN_J10_DESIGN:'CUI', USN_J11_RAM:'CUI', USN_J12_ACQLOG:'CUI',
    USN_J13_CM:'CUI', USN_J14_DISPOSAL:'U', USN_BAM:'CUI', USN_TRANSFER_BOOK:'CUI',
    USN_COTS_MANUAL:'U', USN_TM_INDEX:'U', USN_PO_INDEX:'CUI', USN_PID:'CUI',
    USN_CONTRACT_MOD:'CUI', USN_CONFIG_MGMT:'CUI', USN_OUTFITTING:'CUI', USN_PURCHASE_REQ:'CUI',
    // ── USA ──
    USA_HAND_RECEIPT:'CUI', USA_TM_UPDATE:'CUI', USA_ARMS_ROOM:'CUI', USA_FLIPL:'CUI',
    USA_VEHICLE:'U', USA_CLASS_III:'U', USA_CLASS_V:'SECRET', USA_EQUIP_MAINT:'U',
    USA_AMMO_STORAGE:'SECRET', USA_RANGE_QUAL:'U', USA_CALIBRATION:'U', USA_PROPERTY_BOOK:'CUI',
    USA_COMPONENT_HR:'CUI', USA_DENSITY_LIST:'CUI', USA_GCSS_TRANS:'CUI', USA_AVIATION:'CUI',
    USA_MEDICAL:'CUI', USA_CBRN:'SECRET', USA_ENGINEER:'U', USA_SIGNAL:'CUI',
    // ── USAF ──
    USAF_781_FLIGHT:'CUI', USAF_MUNITIONS:'SECRET', USAF_ENGINE:'CUI', USAF_WEAPONS_LOAD:'SECRET',
    USAF_STRUCT_INTEG:'CUI', USAF_AVIONICS:'CUI', USAF_NUCLEAR:'TS', USAF_MISSILE:'SECRET',
    USAF_SPACE:'SECRET', USAF_RADAR:'CUI', USAF_RUNWAY:'U', USAF_BDR:'SECRET',
    USAF_SUPPLY:'U', USAF_AGE:'U', USAF_FUEL:'U', USAF_DEPOT:'CUI',
    USAF_PMEL:'U', USAF_REFUEL:'CUI',
    // ── USMC ──
    USMC_GROUND_MAINT:'U', USMC_AVIATION:'CUI', USMC_WEAPONS:'CUI', USMC_COMMS:'CUI',
    USMC_ENGINEER:'U', USMC_MOTOR_T:'U', USMC_SUPPLY:'CUI', USMC_ORDNANCE:'SECRET',
    USMC_COMBAT_ENG:'CUI', USMC_AAV:'CUI', USMC_MEDICAL:'CUI', USMC_NBC:'SECRET',
    USMC_EXPEDITIONARY:'CUI', USMC_LAV:'CUI',
    // ── USCG ──
    USCG_CUTTER_MAINT:'U', USCG_SMALL_BOAT:'U', USCG_NAV_AID:'U', USCG_POLLUTION:'U',
    USCG_SAR:'CUI', USCG_MARITIME_SEC:'CUI', USCG_AVIATION:'CUI', USCG_PORT_SEC:'CUI',
    USCG_ELECTRONICS:'CUI', USCG_WEAPONS:'CUI', USCG_ICE_OPS:'U', USCG_BUOY_TENDER:'U',
    // ── DLA ──
    DLA_DISTRIBUTION:'CUI', DLA_FMS:'SECRET', DLA_DRMO:'U', DLA_HAZMAT:'CUI',
    DLA_BULK_FUEL:'CUI', DLA_TROOP_SUPPORT:'U', DLA_STRATEGIC:'SECRET', DLA_MEDICAL:'CUI',
    DLA_DPAS:'CUI', DLA_COMMISSARY:'U', DLA_DISPOSITION:'U', DLA_LAND_EQUIP:'U',
    // ── JOINT ──
    JOINT_NATO:'CUI', JOINT_F35:'SECRET', JOINT_MISSILE_DEF:'TS', JOINT_CYBER:'SECRET',
    JOINT_INTEL:'TS', JOINT_SPACE:'SECRET', JOINT_TRANSPORT:'CUI', JOINT_CONTRACT:'CUI',
    JOINT_READINESS:'SECRET', JOINT_DISPOSAL:'U',
    // ── SOCOM ──
    SOCOM_WEAPONS:'SECRET', SOCOM_COMMS:'SECRET', SOCOM_AVIATION:'SECRET', SOCOM_MARITIME:'SECRET',
    SOCOM_VEHICLE:'CUI', SOCOM_INTEL:'TS', SOCOM_MEDICAL:'CUI', SOCOM_DEMO:'SECRET',
    // ── USSF ──
    USSF_SAT_OPS:'SECRET', USSF_SPACE_VEH:'SECRET', USSF_SDA:'TS', USSF_GPS_CONST:'SECRET',
    USSF_LAUNCH_VEH:'SECRET', USSF_RADAR_TRACK:'SECRET', USSF_GROUND_SYS:'SECRET',
    USSF_COMM_SAT:'SECRET', USSF_EARLY_WARN:'TS', USSF_SPACE_CTRL:'SECRET'
};

const CLF_META = {
    U:    {label:'UNCLASSIFIED',  icon:'🟢', color:'#00cc66', desc:'No special handling required'},
    CUI:  {label:'CUI',           icon:'🟡', color:'#c9a84c', desc:'Controlled Unclassified Information — NIST 800-171 handling required'},
    SECRET:{label:'SECRET',       icon:'🔴', color:'#ff5555', desc:'Requires SIPRNet or equivalent classified network'},
    TS:   {label:'TOP SECRET',    icon:'🟠', color:'#ffa500', desc:'Requires JWICS or equivalent TS/SCI network'}
};

function getClassification(typeKey) { return CLASSIFICATION[typeKey] || 'CUI'; }

const BRANCHES = {
    USN:{name:"U.S. Navy",icon:"\u2693",short:"Navy"},
    USA:{name:"U.S. Army",icon:"\u2B50",short:"Army"},
    USAF:{name:"U.S. Air Force",icon:"\u2708\uFE0F",short:"Air Force"},
    USMC:{name:"U.S. Marine Corps",icon:"\uD83E\uDD85",short:"Marines"},
    USCG:{name:"U.S. Coast Guard",icon:"\uD83D\uDEDF\uFE0F",short:"Coast Guard"},
    DLA:{name:"Defense Logistics Agency",icon:"\uD83C\uDFDB\uFE0F",short:"DLA"},
    JOINT:{name:"Joint / Cross-Branch",icon:"\uD83C\uDF96\uFE0F",short:"Joint"},
    SOCOM:{name:"Special Operations",icon:"\uD83D\uDDE1\uFE0F",short:"SOCOM"},
    USSF:{name:"U.S. Space Force",icon:"\uD83D\uDE80",short:"Space Force"}
};

// Compact: [label, icon, color, branch, system]
const _RT = {
USN_SUPPLY_RECEIPT:["Supply Chain Receipt","\uD83D\uDCE6","#00aaff","USN","NAVSUP OneTouch"],
USN_3M_MAINTENANCE:["3-M Maintenance Action","\uD83D\uDD27","#ffd700","USN","SKED/OARS"],
USN_CASREP:["Casualty Report (CASREP)","\u26A0\uFE0F","#ff3333","USN","TYCOM"],
USN_CDRL:["CDRL Delivery","\uD83D\uDCC4","#8ea4b8","USN","CDMD-OA"],
USN_ORDNANCE:["Ordnance Lot Tracking","\uD83D\uDCA3","#ff6b6b","USN","AESIP"],
USN_DEPOT_REPAIR:["Depot Repair Record","\uD83C\uDFED","#ff9933","USN","CNRMF"],
USN_INSURV:["INSURV Inspection","\uD83D\uDD0D","#66ccff","USN","NRCC"],
USN_CALIBRATION:["TMDE Calibration","\uD83D\uDCCF","#ff66aa","USN","METCAL"],
USN_CONFIG:["Configuration Baseline","\u2699\uFE0F","#c9a84c","USN","CDMD-OA"],
USN_CUSTODY:["Custody Transfer","\uD83D\uDD04","#14f195","USN","DPAS"],
USN_TDP:["Technical Data Package","\uD83D\uDCD0","#9945ff","USN","NAVSEA"],
USN_COC:["Certificate of Conformance","\u2705","#00cc88","USN","DCMA"],
USN_SHIPALT:["Ship Alteration (SHIPALT)","\uD83D\uDEA2","#0077cc","USN","NAVSEA"],
USN_PMS:["PMS/SKED Compliance","\uD83D\uDCCB","#44aa88","USN","3M/SKED"],
USN_HME:["HM&E System Record","\u26A1","#dd8844","USN","ENGSKED"],
USN_COMBAT_SYS:["Combat Systems Cert","\uD83C\uDFAF","#ff4444","USN","CSSQT"],
USN_PROPULSION:["Propulsion Plant Exam","\uD83D\uDD25","#ff6600","USN","INSURV"],
USN_AVIATION:["Aviation Maintenance","\u2708\uFE0F","#0088cc","USN","NALCOMIS"],
USN_FLIGHT_OPS:["Flight Operations Record","\uD83D\uDEEB","#3399ff","USN","NATOPS"],
USN_SUBSAFE:["SUBSAFE Certification","\uD83D\uDD12","#003366","USN","NAVSEA 07"],
USN_DIVE_EQUIP:["Diving Equipment Inspection","\uD83E\uDD3F","#006699","USN","NAVSEA 00C"],
USN_MEDICAL:["Medical Equipment Cert","\uD83C\uDFE5","#33cc66","USN","BUMED"],
USN_QDR:["Quality Defect Report","\uD83D\uDEAB","#cc0000","USN","NAVSUP WSS"],
USN_FIELDING:["Equipment Fielding","\uD83D\uDEA2","#00ddaa","USN","PMS"],
USN_REACTOR:["Naval Reactor Test","\u2622\uFE0F","#ffcc00","USN","NAVSEA 08"],
USN_DRL:["Data Requirements List (DRL)","\uD83D\uDCCB","#5599cc","USN","NAVSEA/PMS"],
USN_DI:["Data Item Description (DID)","\uD83D\uDCC3","#4488bb","USN","CDMD-OA"],
USN_VRS:["Vendor Recommended Spares","\uD83D\uDCE6","#7799aa","USN","NAVICP/DLA"],
USN_BUYLIST:["Buylist / Provisioning","\uD83D\uDED2","#6688aa","USN","NAVSUP WSS"],
USN_J1_ILS:["J-1 ILS Parameters / LORA","\uD83D\uDCD1","#336699","USN","PMS/ILS"],
USN_J2_SE:["J-2 Support Equipment","\uD83D\uDD27","#337799","USN","PMS/ILS"],
USN_J3_SUPPLY:["J-3 Supply Support","\uD83D\uDCE6","#338899","USN","NAVSUP"],
USN_J4_TECHDATA:["J-4 Technical Data","\uD83D\uDCD6","#339999","USN","NAVSEA"],
USN_J5_TRAINING:["J-5 Training","\uD83C\uDF93","#33aa99","USN","NETC"],
USN_J6_MANPOWER:["J-6 Manpower & Personnel","\uD83D\uDC65","#4488cc","USN","OPNAV N1"],
USN_J7_FACILITIES:["J-7 Facilities","\uD83C\uDFD7\uFE0F","#5577bb","USN","NAVFAC"],
USN_J8_PHST:["J-8 PHS&T","\uD83D\uDCE6","#6699cc","USN","NAVSUP"],
USN_J9_SOFTWARE:["J-9 Computer Resources","\uD83D\uDCBB","#4477aa","USN","SPAWAR/NAVWAR"],
USN_J10_DESIGN:["J-10 Design Interface","\uD83D\uDCD0","#3366aa","USN","NAVSEA"],
USN_J11_RAM:["J-11 RAM Analysis","\uD83D\uDCC8","#2255aa","USN","PMS/ILS"],
USN_J12_ACQLOG:["J-12 Acquisition Logistics","\uD83D\uDCCA","#2266bb","USN","PMS/ILS"],
USN_J13_CM:["J-13 Configuration Mgmt","\u2699\uFE0F","#3377cc","USN","CDMD-OA"],
USN_J14_DISPOSAL:["J-14 Disposal","\uD83D\uDDD1\uFE0F","#667788","USN","DRMS"],
USN_BAM:["Budget Allowance Mgmt (BAM)","\uD83D\uDCB0","#cc9933","USN","NAVSUP"],
USN_TRANSFER_BOOK:["Transfer Book","\uD83D\uDCD3","#5588aa","USN","Supply Officer"],
USN_COTS_MANUAL:["COTS Manual / Documentation","\uD83D\uDCD8","#4477bb","USN","NAVSEA"],
USN_TM_INDEX:["Technical Manual Index","\uD83D\uDCC7","#3366bb","USN","NAVSEA"],
USN_PO_INDEX:["Purchase Order Index","\uD83D\uDCC2","#5588cc","USN","NAVSUP"],
USN_PID:["Program Introduction Doc (PID)","\uD83D\uDCC4","#6699bb","USN","PMS"],
USN_CONTRACT_MOD:["Contract Modification","\uD83D\uDCDD","#7788aa","USN","NAVSEA Contracts"],
USN_CONFIG_MGMT:["Configuration Mgmt Record","\u2699\uFE0F","#4466aa","USN","CDMD-OA"],
USN_OUTFITTING:["Outfitting Requirements","\uD83D\uDEA2","#3355aa","USN","PMS/Outfitting"],
USN_PURCHASE_REQ:["Purchase Request (PR)","\uD83D\uDCB3","#558899","USN","NAVSUP"],
USA_HAND_RECEIPT:["DA 2062 Hand Receipt","\uD83D\uDCDD","#4b5320","USA","GCSS-Army"],
USA_TM_UPDATE:["Technical Manual Update","\uD83D\uDCD6","#6b8e23","USA","LOGSA"],
USA_ARMS_ROOM:["Arms Room Inventory","\uD83D\uDD2B","#8b4513","USA","PBUSE"],
USA_FLIPL:["FLIPL Investigation","\uD83D\uDCCB","#cd853f","USA","GCSS-Army"],
USA_VEHICLE:["Vehicle Dispatch Log","\uD83D\uDE9B","#556b2f","USA","GCSS-Army"],
USA_CLASS_III:["Class III (POL) Issue","\u26FD","#8b8000","USA","GCSS-Army"],
USA_CLASS_V:["Class V (Ammo) Issue","\uD83D\uDCA5","#b22222","USA","SAAS"],
USA_EQUIP_MAINT:["Equipment Maintenance","\uD83D\uDD27","#696969","USA","GCSS-Army"],
USA_AMMO_STORAGE:["Ammo Storage Inspection","\uD83C\uDFED","#a0522d","USA","QASAS"],
USA_RANGE_QUAL:["Range Qualification","\uD83C\uDFAF","#2e8b57","USA","DTMS"],
USA_CALIBRATION:["TMDE Calibration (Army)","\uD83D\uDCCF","#daa520","USA","TMDE Activity"],
USA_PROPERTY_BOOK:["Property Book Record","\uD83D\uDCD7","#3cb371","USA","PBUSE"],
USA_COMPONENT_HR:["Component Hand Receipt","\uD83D\uDDC2\uFE0F","#8fbc8f","USA","GCSS-Army"],
USA_DENSITY_LIST:["Equipment Density List","\uD83D\uDCCA","#66cdaa","USA","GCSS-Army"],
USA_GCSS_TRANS:["GCSS-Army Transaction","\uD83D\uDCBB","#20b2aa","USA","GCSS-Army"],
USA_AVIATION:["Aviation Maintenance","\uD83D\uDE81","#2f4f4f","USA","ULLS-A(E)"],
USA_MEDICAL:["Medical Supply Record","\uD83C\uDFE5","#3cb371","USA","DMLSS"],
USA_CBRN:["CBRN Equipment Record","\u2623\uFE0F","#8b0000","USA","GCSS-Army"],
USA_ENGINEER:["Engineer Equipment","\uD83C\uDFD7\uFE0F","#808000","USA","GCSS-Army"],
USA_SIGNAL:["Signal/Comms Equipment","\uD83D\uDCE1","#4682b4","USA","LMP"],
USAF_781_FLIGHT:["AFTO 781 Flight Record","\u2708\uFE0F","#00308f","USAF","IMDS"],
USAF_MUNITIONS:["Munitions Inspection","\uD83D\uDCA3","#cd5c5c","USAF","CAS"],
USAF_ENGINE:["Engine Management Record","\uD83D\uDD25","#ff8c00","USAF","CEMS"],
USAF_WEAPONS_LOAD:["Weapons Load Certification","\uD83C\uDFAF","#dc143c","USAF","MIS"],
USAF_STRUCT_INTEG:["Aircraft Structural Record","\uD83D\uDEE1\uFE0F","#4169e1","USAF","ASIP"],
USAF_AVIONICS:["Avionics Test Record","\uD83D\uDCDF","#6a5acd","USAF","IMDS"],
USAF_NUCLEAR:["Nuclear Weapons Cert","\u2622\uFE0F","#ffd700","USAF","AFGSC"],
USAF_MISSILE:["Missile Maintenance Record","\uD83D\uDE80","#b8860b","USAF","MMICS"],
USAF_SPACE:["Space Vehicle Certification","\uD83D\uDEF0\uFE0F","#191970","USAF","USSF"],
USAF_RADAR:["Radar Calibration Record","\uD83D\uDCE1","#00bfff","USAF","IMDS"],
USAF_RUNWAY:["Runway Condition Report","\uD83D\uDEEC","#708090","USAF","BCAS"],
USAF_BDR:["Battle Damage Assessment","\uD83D\uDCA5","#ff4500","USAF","BDA"],
USAF_SUPPLY:["AF Supply Transaction","\uD83D\uDCE6","#1e90ff","USAF","SBSS"],
USAF_AGE:["Aerospace Ground Equipment","\uD83D\uDD29","#778899","USAF","IMDS"],
USAF_FUEL:["Fuel Management Record","\u26FD","#daa520","USAF","AFPET"],
USAF_DEPOT:["Depot Maintenance Record","\uD83C\uDFED","#cd853f","USAF","D200A"],
USAF_PMEL:["PMEL Calibration","\uD83D\uDCCF","#da70d6","USAF","PMEL"],
USAF_REFUEL:["Aerial Refueling Log","\u26FD","#2e8b57","USAF","ART"],
USMC_GROUND_MAINT:["Ground Equipment Maint","\uD83D\uDD27","#cc0000","USMC","GCSS-MC"],
USMC_AVIATION:["Aviation Intermediate Maint","\uD83D\uDE81","#8b0000","USMC","NALCOMIS"],
USMC_WEAPONS:["Weapons Maintenance","\uD83D\uDD2B","#a52a2a","USMC","ATLASS"],
USMC_COMMS:["Communications Equipment","\uD83D\uDCE1","#cd5c5c","USMC","GCSS-MC"],
USMC_ENGINEER:["Engineer Equipment Record","\uD83C\uDFD7\uFE0F","#b22222","USMC","GCSS-MC"],
USMC_MOTOR_T:["Motor Transport Record","\uD83D\uDE9B","#dc143c","USMC","GCSS-MC"],
USMC_SUPPLY:["MAGTF Supply Chain","\uD83D\uDCE6","#800000","USMC","GCSS-MC"],
USMC_ORDNANCE:["Marine Ordnance Record","\uD83D\uDCA3","#ff0000","USMC","TFSMS"],
USMC_COMBAT_ENG:["Combat Engineering Record","\uD83D\uDCA5","#c41e3a","USMC","GCSS-MC"],
USMC_AAV:["AAV/ACV Maintenance","\uD83D\uDEA2","#990000","USMC","GCSS-MC"],
USMC_MEDICAL:["Medical Supply Record","\uD83C\uDFE5","#ff6666","USMC","DMLSS"],
USMC_NBC:["NBC Equipment Inspection","\u2623\uFE0F","#660000","USMC","GCSS-MC"],
USMC_EXPEDITIONARY:["Expeditionary Supply","\uD83C\uDFD5\uFE0F","#993333","USMC","GCSS-MC"],
USMC_LAV:["LAV Maintenance Record","\uD83D\uDE97","#cc3333","USMC","GCSS-MC"],
USCG_CUTTER_MAINT:["Cutter Maintenance","\uD83D\uDEA2","#003366","USCG","ABS NS5"],
USCG_SMALL_BOAT:["Small Boat Inspection","\u26F5","#336699","USCG","CG-LIMS"],
USCG_NAV_AID:["Aids to Navigation Maint","\uD83D\uDDFC","#0066cc","USCG","ATON MIS"],
USCG_POLLUTION:["Pollution Response Equip","\uD83D\uDEE2\uFE0F","#669900","USCG","MISLE"],
USCG_SAR:["Search & Rescue Equipment","\uD83C\uDD98","#ff3300","USCG","MISLE"],
USCG_MARITIME_SEC:["Maritime Security Equip","\uD83D\uDD12","#003399","USCG","MISLE"],
USCG_AVIATION:["CG Aviation Maintenance","\uD83D\uDE81","#3366ff","USCG","ALMIS"],
USCG_PORT_SEC:["Port Security Inspection","\uD83C\uDFD7\uFE0F","#0033cc","USCG","MISLE"],
USCG_ELECTRONICS:["Electronics Systems Maint","\uD83D\uDCE1","#0099ff","USCG","CG-LIMS"],
USCG_WEAPONS:["CG Weapons System Maint","\uD83D\uDD2B","#002244","USCG","CG-LIMS"],
USCG_ICE_OPS:["Ice Operations Equipment","\uD83E\uDDCA","#66ccff","USCG","CG-LIMS"],
USCG_BUOY_TENDER:["Buoy Tender Maintenance","\uD83D\uDD34","#ff6600","USCG","ATON MIS"],
DLA_DISTRIBUTION:["DLA Distribution Receipt","\uD83C\uDFDB\uFE0F","#1a3a5c","DLA","DSS"],
DLA_FMS:["Foreign Military Sales","\uD83C\uDF10","#2a5a8c","DLA","DSCA"],
DLA_DRMO:["DRMO Disposal Record","\uD83D\uDDD1\uFE0F","#555555","DLA","DRMS"],
DLA_HAZMAT:["Hazmat Certification","\u2622\uFE0F","#ff9900","DLA","HMIRS"],
DLA_BULK_FUEL:["Bulk Fuel Receipt","\u26FD","#8b7355","DLA","DFSP"],
DLA_TROOP_SUPPORT:["Troop Support Material","\uD83C\uDF96\uFE0F","#4a6741","DLA","BSM"],
DLA_STRATEGIC:["Strategic Material Reserve","\uD83C\uDFE6","#8b8682","DLA","NDS"],
DLA_MEDICAL:["Medical Supply Chain","\uD83C\uDFE5","#2e8b57","DLA","ECAT"],
DLA_DPAS:["DPAS Property Record","\uD83D\uDCCB","#4682b4","DLA","DPAS"],
DLA_COMMISSARY:["Commissary Supply Record","\uD83D\uDED2","#6b8e23","DLA","DeCA"],
DLA_DISPOSITION:["Disposition Services","\uD83D\uDCE4","#8b8378","DLA","DRMS"],
DLA_LAND_EQUIP:["Land Equipment Supply","\uD83D\uDE9B","#556b2f","DLA","DSS"],
JOINT_NATO:["NATO STANAG Verification","\uD83C\uDFF3\uFE0F","#003399","JOINT","NATO"],
JOINT_F35:["F-35 JSF Logistics","\u2708\uFE0F","#1a1a2e","JOINT","ALIS/ODIN"],
JOINT_MISSILE_DEF:["Missile Defense Record","\uD83D\uDE80","#4a0080","JOINT","MDA"],
JOINT_CYBER:["Cyber Equipment Cert","\uD83D\uDDA5\uFE0F","#00cc99","JOINT","CYBERCOM"],
JOINT_INTEL:["Intelligence Equipment","\uD83D\uDD75\uFE0F","#2d2d2d","JOINT","DIA"],
JOINT_SPACE:["Space Command Asset","\uD83D\uDEF0\uFE0F","#000066","JOINT","USSPACECOM"],
JOINT_TRANSPORT:["TRANSCOM Logistics","\uD83D\uDE9B","#4a6741","JOINT","USTRANSCOM"],
JOINT_CONTRACT:["Contract Deliverable","\uD83D\uDCDD","#b8860b","JOINT","DCMA"],
JOINT_READINESS:["Readiness Report","\uD83D\uDCC8","#00ff88","JOINT","DRRS"],
JOINT_DISPOSAL:["Joint Disposal Record","\uD83D\uDDD1\uFE0F","#8b8682","JOINT","DLA"],
SOCOM_WEAPONS:["SOF Weapons Maintenance","\uD83D\uDD2B","#2d2d2d","SOCOM","SOF-LAN"],
SOCOM_COMMS:["SOF Communications Equip","\uD83D\uDCE1","#4a4a4a","SOCOM","SOF-LAN"],
SOCOM_AVIATION:["SOF Aviation Maintenance","\uD83D\uDE81","#333333","SOCOM","SOF-LAN"],
SOCOM_MARITIME:["SOF Maritime Equipment","\uD83E\uDD3F","#1a1a2e","SOCOM","SOF-LAN"],
SOCOM_VEHICLE:["SOF Vehicle Maintenance","\uD83D\uDE97","#3d3d3d","SOCOM","SOF-LAN"],
SOCOM_INTEL:["SOF Intelligence Equip","\uD83D\uDD75\uFE0F","#1a1a1a","SOCOM","SOF-LAN"],
SOCOM_MEDICAL:["SOF Medical Supply","\uD83C\uDFE5","#4a4a4a","SOCOM","SOF-LAN"],
SOCOM_DEMO:["SOF Demolition Record","\uD83D\uDCA5","#550000","SOCOM","SOF-LAN"],
USSF_SAT_OPS:["Satellite Operations Record","\uD83D\uDEF0\uFE0F","#1a1a4e","USSF","18 SDS"],
USSF_SPACE_VEH:["Space Vehicle Maintenance","\uD83D\uDE80","#2a2a5e","USSF","SMC"],
USSF_SDA:["Space Domain Awareness","\uD83D\uDD2D","#000066","USSF","18 SDS"],
USSF_GPS_CONST:["GPS Constellation Record","\uD83D\uDCE1","#003399","USSF","2 SOPS"],
USSF_LAUNCH_VEH:["Launch Vehicle Record","\uD83D\uDE80","#0044aa","USSF","SLD 45"],
USSF_RADAR_TRACK:["Space Surveillance Tracking","\uD83D\uDCE1","#0055bb","USSF","18 SDS"],
USSF_GROUND_SYS:["Ground Systems Maint","\uD83D\uDDA5\uFE0F","#002266","USSF","SBIRS"],
USSF_COMM_SAT:["Comm Satellite Record","\uD83D\uDCE1","#0033aa","USSF","MILSATCOM"],
USSF_EARLY_WARN:["Early Warning System","\u26A0\uFE0F","#003377","USSF","SBIRS"],
USSF_SPACE_CTRL:["Space Control Record","\uD83D\uDEE1\uFE0F","#001a66","USSF","SPACECOM"]
};

// Expand
const RECORD_TYPES = {};
for (const [k,v] of Object.entries(_RT)) {
    RECORD_TYPES[k] = {label:v[0],icon:v[1],color:v[2],branch:v[3],system:v[4]};
}

const SAMPLES = {
    supply:{type:'USN_SUPPLY_RECEIPT',branch:'USN',text:`Supply Chain Receipt\nNSN: 5340-01-234-5678\nNomenclature: Valve, Gate, Carbon Steel\nContract: N00024-23-C-5501\nCAGE Code: 1THK9\nQuantity Received: 50 EA\nCondition Code: A (Serviceable)\nInspection: FAT Pass\nReceiving Depot: Norfolk Naval Shipyard (NNSY)\nInspector: QA-237 J. Martinez\nDate: 2026-02-10`},
    maintenance:{type:'USN_3M_MAINTENANCE',branch:'USN',text:`Maintenance 3-M Action\nMRC: 2815-1.3.7\nEquipment: LM2500 Gas Turbine Engine\nHull Number: DDG-118\nAction: Oil sample analysis\nResults: Normal wear metals Fe:12ppm Cu:3ppm Al:2ppm\nTechnician: MM2(SW) Garcia\nVerified By: MMCS(SW) Thompson\nNext Due: 2026-08-10\nSKED Status: Current`},
    ordnance:{type:'USN_ORDNANCE',branch:'USN',text:`Ordnance Lot Tracking\nDODIC: A059 (5.56mm Ball M855)\nLot Number: WCC-2025-1147-A\nNSN: 1305-01-299-5564\nManufacturer: Winchester (CAGE: 97173)\nQuantity: 250,000 rounds\nProof Test: PASS (MIL-C-63989D)\nStorage: Weapons Station Earle, Magazine 14\nCustodian: GMC(SW) Rodriguez\nDate: 2026-02-08`},
    casrep:{type:'USN_CASREP',branch:'USN',text:`CASUALTY REPORT (CASREP)\nUnit: USS Porter (DDG-78)\nEquipment: AN/SPY-1D(V) Radar Transmitter\nSerial: SPY-TM-2019-04472\nImpact: Degraded radar coverage\nReported By: LCDR Pham, CSO\nDate: 2026-02-10`},
    custody:{type:'USN_CUSTODY',branch:'USN',text:`Chain of Custody Transfer\nEquipment: AN/SPY-1D(V) Transmitter Module\nSerial: SPY-TM-2019-04472\nNSN: 5841-01-522-3401\nFrom: ET1(SW) Cooper, DDG-78\nTo: NAVSEA Det Norfolk, IMA\nSeal: Tamper-evident #TS-2026-0887\nDate: 2026-02-10`},
    hand_receipt:{type:'USA_HAND_RECEIPT',branch:'USA',text:`DA Form 2062 Hand Receipt\nUnit: 3rd BCT, 101st Airborne\nProperty Book Officer: CPT Rivera\nItem: AN/PVS-14 Night Vision Device\nNSN: 5855-01-432-0524\nSerial: NVD-2024-08871\nQuantity: 24 EA\nCondition: Serviceable\nSub-hand receipt to: 1LT Nakamura, B Co\nDate: 2026-02-09`},
    flight_record:{type:'USAF_781_FLIGHT',branch:'USAF',text:`AFTO Form 781 Flight Record\nAircraft: F-16C Block 50\nTail: 91-0412\nUnit: 480th Fighter Squadron, Spangdahlem AB\nMission: Air-to-ground training sortie\nSorties: 1\nFlight Hours: 1.8\nPilot: Capt Williams\nDiscrepancies: None\nDate: 2026-02-10`},
    ground_maint:{type:'USMC_GROUND_MAINT',branch:'USMC',text:`Ground Equipment Maintenance\nUnit: 1st Maintenance Battalion, Camp Pendleton\nEquipment: HMMWV M1151A1\nBumper: 1MaintBn-HQ-07\nWork Order: PM services, 6-month interval\nTechnician: Sgt Dominguez\nHours: 4.5\nParts Used: Oil filter (NSN 2940-01-318-2345)\nStatus: Operational\nDate: 2026-02-11`},
    cutter:{type:'USCG_CUTTER_MAINT',branch:'USCG',text:`Cutter Maintenance Record\nVessel: USCGC Hamilton (WMSL-753)\nSystem: Main Diesel Engine #2\nAction: 500-hour inspection and filter change\nTechnician: MK1 Petersen\nParts: Fuel filter (NSN 2910-01-456-7890)\nCondition: Satisfactory\nNext PM: 2026-05-10\nDate: 2026-02-11`},
    satellite:{type:'USSF_SAT_OPS',branch:'USSF',text:`Satellite Operations Record\nConstellation: GPS III\nVehicle: SVN-78 (GPS III-6)\nOrbit: MEO, Slot A3\nStatus: Operational / Healthy\nPayload: L1C/A, L2C, L5, M-Code\nGround Contact: Schriever SFB, CO\nAnomaly: None\nOperator: 2nd SOPS\nDate: 2026-02-12`},
    drl:{type:'USN_DRL',branch:'USN',text:`Data Requirements List (CDRL)\nContract: N00024-24-C-6200\nCDRL Seq: A001\nDI Number: DI-ILSS-81495\nTitle: Integrated Logistics Support Plan\nFrequency: One-time with revisions\nDistribution: NAVSEA PMS 400D\nContractor: Huntington Ingalls Industries\nProgram: DDG-51 Flight III\nStatus: Submitted, under review\nDate: 2026-02-10`},
    buylist:{type:'USN_BUYLIST',branch:'USN',text:`Buylist / Provisioning Record\nProgram: LCS Freedom-class\nPMS: PMS 501\nItem: Main Reduction Gear Oil Pump Assembly\nNSN: 4320-01-567-8901\nRecommended Qty: 4 EA per hull\nAcquisition Method: Sole Source (OEM)\nVendor: Rolls-Royce Naval Marine (CAGE: K2965)\nUnit Cost: $47,250.00\nJustification: Critical rotating machinery, no alternate source\nDate: 2026-02-09`},
    transfer_book:{type:'USN_TRANSFER_BOOK',branch:'USN',text:`Transfer Book Entry\nUnit: Supply Department, USS Nimitz (CVN-68)\nAccount: OPTAR / EMRM\nJob Order: 68-2026-0195\nDescription: Transfer of ADP equipment to AIMD\nFrom: S-1 Division (Stock Control)\nTo: AIMD IM-3 Division\nQuantity: 12 laptops, 3 printers\nDocument Number: N68836-6026-0195\nApproved By: LCDR Torres, Supply Officer\nDate: 2026-02-11`}
};

let currentBranch = 'USN';
let selectedType = 'USN_SUPPLY_RECEIPT';
let sessionRecords = [];
let stats = {anchored:0,verified:0,types:new Set(),slsFees:0};

// ── localStorage cross-page record sync ──
const S4_STORAGE_KEY = 's4_anchored_records';
const S4_STATS_KEY = 's4_demo_stats';
function getLocalRecords() { try { return JSON.parse(localStorage.getItem(S4_STORAGE_KEY) || '[]'); } catch(e) { return []; } }
function saveLocalRecord(rec) { const records = getLocalRecords(); records.push(rec); localStorage.setItem(S4_STORAGE_KEY, JSON.stringify(records)); }
function saveStats() { localStorage.setItem(S4_STATS_KEY, JSON.stringify({anchored:stats.anchored,verified:stats.verified,types:[...stats.types],slsFees:stats.slsFees})); }
function loadStats() {
    try {
        const saved = JSON.parse(localStorage.getItem(S4_STATS_KEY) || 'null');
        if (saved) { stats.anchored = saved.anchored || 0; stats.verified = saved.verified || 0; stats.types = new Set(saved.types || []); stats.slsFees = saved.slsFees || 0; }
    } catch(e) {}
    // Also restore session records from localStorage
    const localRecs = getLocalRecords();
    sessionRecords = localRecs.map(r => ({
        type: r.record_type, label: r.record_label || r.record_type, icon: r.icon || '\uD83D\uDCCB',
        branch: r.branch || 'JOINT', hash: r.hash, txHash: r.tx_hash,
        encrypted: false, timestamp: r.timestamp, content: ''
    }));
    updateStats();
    updateTxLog();
}

async function sha256(text) {
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function copyHash(hash) {
    navigator.clipboard.writeText(hash).then(function() {
        document.querySelectorAll('.copy-btn').forEach(function(b) { b.innerHTML = '<i class="fas fa-check"></i> Copied!'; });
        setTimeout(function() { document.querySelectorAll('.copy-btn').forEach(function(b) { b.innerHTML = '<i class="fas fa-copy"></i> Copy'; }); }, 2000);
    });
}

function selectBranch(branch, el) {
    currentBranch = branch;
    document.querySelectorAll('.branch-tab').forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('typeSearch').value = '';
    renderTypeGrid();
}

function renderTypeGrid() {
    const grid = document.getElementById('recordTypeGrid');
    const search = (document.getElementById('typeSearch').value || '').toLowerCase();
    const types = Object.entries(RECORD_TYPES)
        .filter(([k,v]) => v.branch === currentBranch)
        .filter(([k,v]) => !search || v.label.toLowerCase().includes(search) || k.toLowerCase().includes(search));
    document.getElementById('branchTypeCount').textContent = '(' + types.length + ' types)';
    grid.innerHTML = types.map(([key,t]) =>
        '<div class="record-type-btn' + (key===selectedType?' selected':'') + '" data-type="'+key+'" onclick="selectType(\''+key+'\',this)" title="'+t.label+' \u2014 '+t.system+'"><span class="icon">'+t.icon+'</span>'+t.label+'</div>'
    ).join('');
}

function selectType(key, el) {
    selectedType = key;
    document.querySelectorAll('.record-type-btn').forEach(b => b.classList.remove('selected'));
    if (el) el.classList.add('selected');
    // Auto-populate textarea with sample content for this type
    const typeInfo = RECORD_TYPES[key];
    if (typeInfo) {
        const ta = document.getElementById('recordInput');
        if (!ta.value.trim() || ta.dataset.autoFilled === 'true') {
            ta.value = generateRecordSample(key, typeInfo);
            ta.dataset.autoFilled = 'true';
        }
    }
    // Show classification banner
    showClassificationBanner(key);
}

function generateRecordSample(key, info) {
    // Check if there's a matching SAMPLE entry
    for (const [sk, sv] of Object.entries(SAMPLES)) {
        if (sv.type === key) return sv.text;
    }
    // Generate a generic sample
    const ref = 'REF-2026-' + String(Math.floor(Math.random()*9000+1000));
    const clf = getClassification(key);
    const clfLabel = CLF_META[clf].label;
    return info.label + '\nBranch: ' + BRANCHES[info.branch].name
        + '\nSystem: ' + (info.system || 'N/A')
        + '\nClassification: ' + clfLabel
        + '\nReference: ' + ref
        + '\nDate: 2026-02-13'
        + '\nStatus: Complete / Inspected'
        + '\nAuthorized By: [Name/Rank]'
        + '\nFacility: [Location]'
        + '\nNotes: Enter detailed record content here';
}

function showClassificationBanner(typeKey) {
    const banner = document.getElementById('clfBanner');
    const clf = getClassification(typeKey);
    const meta = CLF_META[clf];
    banner.className = 'clf-banner show clf-' + clf;
    banner.querySelector('.clf-icon').textContent = meta.icon;
    document.getElementById('clfBadge').textContent = meta.label;
    document.getElementById('clfText').textContent = meta.desc;
}

function loadSample(key) {
    const s = SAMPLES[key];
    if (!s) return;
    const ta = document.getElementById('recordInput');
    ta.value = s.text;
    ta.dataset.autoFilled = 'true';
    if (s.branch !== currentBranch) {
        const tabs = document.querySelectorAll('.branch-tab');
        tabs.forEach(t => {
            if (t.textContent.toLowerCase().includes(BRANCHES[s.branch].short.toLowerCase())) {
                selectBranch(s.branch, t);
            }
        });
    }
    selectedType = s.type;
    renderTypeGrid();
    showClassificationBanner(s.type);
}

function animateValue(el, end, decimals) {
    const start = parseFloat(el.textContent) || 0;
    if (start === end) { el.textContent = decimals ? end.toFixed(decimals) : end; return; }
    const duration = 400;
    const startTime = performance.now();
    function step(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * eased;
        el.textContent = decimals ? current.toFixed(decimals) : Math.round(current);
        if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

function updateStats() {
    animateValue(document.getElementById('statAnchored'), stats.anchored);
    animateValue(document.getElementById('statVerified'), stats.verified);
    animateValue(document.getElementById('statTypes'), stats.types.size);
    animateValue(document.getElementById('statSlsFees'), stats.slsFees, 3);
}

function showAnchorAnimation(hash, typeLabel, clfLevel) {
    const overlay = document.getElementById('anchorOverlay');
    const meta = CLF_META[clfLevel] || CLF_META['CUI'];
    document.getElementById('animStatus').textContent = 'Anchoring to XRPL...';
    document.getElementById('animStatus').style.color = '';
    document.getElementById('animHash').textContent = hash;
    document.getElementById('animSuccess').textContent = '';
    // Show classification in animation
    const clfDiv = document.getElementById('animClf');
    if (clfDiv) {
        clfDiv.innerHTML = '<span style="padding:4px 14px;border-radius:6px;font-size:0.85rem;font-weight:800;letter-spacing:0.5px;color:' + meta.color + ';border:1px solid ' + meta.color + '30;background:' + meta.color + '15">' + meta.icon + ' ' + meta.label + '</span>';
        clfDiv.style.opacity = '0';
        clfDiv.style.animation = 'fadeUp 0.5s ease-out 0.7s both';
    }
    // Reset animations
    overlay.querySelectorAll('.chain-segment,.anchor-drop-icon,.anim-status,.anim-hash,.anim-fee,.anim-success').forEach(el => {
        el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    });
    overlay.classList.add('active');
    setTimeout(() => {
        document.getElementById('animStatus').textContent = '\u2705 ' + typeLabel + ' Anchored!';
        document.getElementById('animStatus').style.color = '#14f195';
        document.getElementById('animSuccess').textContent = '\u2713 Record secured on XRPL';
        document.getElementById('animSuccess').style.animation = 'scaleIn 0.4s ease-out both';
    }, 2000);
    // Auto-dismiss after 5 seconds
    setTimeout(hideAnchorAnimation, 5000);
}

function hideAnchorAnimation() {
    document.getElementById('anchorOverlay').classList.remove('active');
}

async function anchorRecord() {
    const input = document.getElementById('recordInput').value.trim();
    if (!input) { alert('Please enter record content.'); return; }
    const btn = document.getElementById('anchorBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anchoring...';

    const encrypt = document.getElementById('encryptCheck').checked;
    const hash = await sha256(input);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    const typeInfo = RECORD_TYPES[selectedType] || {label:selectedType,icon:'\uD83D\uDCCB',branch:'JOINT'};

    const clfLevel = getClassification(selectedType);
    showAnchorAnimation(hash, typeInfo.label, clfLevel);

    // POST to API (best-effort)
    const apiData = {hash, record_type:selectedType, tx_hash:txHash, content_preview:input.substring(0,100)};
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(apiData)}); }
    catch(e) { console.warn('API anchor failed:', e); }

    const record = {
        type:selectedType, label:typeInfo.label, icon:typeInfo.icon, branch:typeInfo.branch,
        hash, txHash, encrypted:encrypt, timestamp:new Date().toISOString(),
        content:input.substring(0,100)+(input.length>100?'...':'')
    };
    sessionRecords.push(record);
    // Save to localStorage so Metrics & Transactions pages see it
    saveLocalRecord({
        hash, record_type: selectedType, record_label: typeInfo.label, branch: typeInfo.branch,
        icon: typeInfo.icon, timestamp: new Date().toISOString(),
        timestamp_display: new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC',
        fee: 0.01, tx_hash: txHash, system: typeInfo.system || 'N/A'
    });
    // Auto-save to Audit Vault
    addToVault({hash, txHash, type:selectedType, label:typeInfo.label, branch:typeInfo.branch, icon:typeInfo.icon, content:input.substring(0,100)+(input.length>100?'...':''), encrypted:encrypt, timestamp:new Date().toISOString(), source:'Manual Anchor', fee:0.01});
    stats.anchored++;
    stats.types.add(selectedType);
    stats.slsFees += 0.01;
    updateStats();
    saveStats();

    await new Promise(r => setTimeout(r, 3200));
    hideAnchorAnimation();
    await new Promise(r => setTimeout(r, 400));

    const panel = document.getElementById('anchorResult');
    panel.innerHTML = '<div class="result-label">STATUS</div><div class="result-value" style="font-size:1rem;margin-bottom:0.8rem">\u2705 Record anchored successfully</div>'
        + '<div class="result-label">RECORD TYPE</div><div style="margin-bottom:0.5rem">' + record.icon + ' ' + typeInfo.label + ' (' + typeInfo.branch + ')</div>'
        + '<div class="result-label">CLASSIFICATION</div><div style="margin-bottom:0.5rem"><span style="padding:3px 12px;border-radius:6px;font-size:0.8rem;font-weight:800;letter-spacing:0.5px;color:' + CLF_META[clfLevel].color + ';border:1px solid ' + CLF_META[clfLevel].color + '30;background:' + CLF_META[clfLevel].color + '15">' + CLF_META[clfLevel].icon + ' ' + CLF_META[clfLevel].label + '</span> <span style="color:var(--muted);font-size:0.8rem;margin-left:6px">' + CLF_META[clfLevel].desc + '</span></div>'
        + '<div class="result-label">SHA-256 HASH</div><div class="hash-display">' + hash + '</div>'
        + '<div class="result-label">TX HASH</div><div style="color:var(--muted);margin-bottom:0.5rem;word-break:break-all">' + txHash + '</div>'
        + '<div class="result-label">SYSTEM</div><div style="margin-bottom:0.5rem">' + (typeInfo.system||'N/A') + '</div>'
        + '<div class="result-label">ENCRYPTED</div><div style="margin-bottom:0.5rem">' + (encrypt ? '\uD83D\uDD12 Yes (CUI protected)' : '\uD83D\uDD13 No (plaintext hash)') + '</div>'
        + '<div class="result-label">$SLS FEE</div><div>0.01 $SLS \u2192 Treasury</div>';
    panel.classList.add('show');
    updateTxLog();
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-anchor"></i> Anchor to XRPL';
}

async function verifyRecord() {
    const input = document.getElementById('verifyInput').value.trim();
    if (!input) { alert('Please enter record content.'); return; }
    const hash = await sha256(input);
    const expected = document.getElementById('verifyHash').value.trim();
    stats.verified++;
    updateStats();
    saveStats();
    const panel = document.getElementById('verifyResult');
    let matchHtml = '';
    if (expected) {
        const match = hash.toLowerCase() === expected.toLowerCase();
        matchHtml = '<div class="result-label">EXPECTED</div><div style="color:var(--muted);word-break:break-all;margin-bottom:0.5rem">' + expected + '</div>'
            + '<div class="result-label">MATCH</div><div class="result-value ' + (match?'':'error') + '" style="font-size:1.1rem">'
            + (match ? '\u2705 VERIFIED \u2014 Hashes match. Record integrity confirmed.' : '\u274C MISMATCH \u2014 Record altered or wrong hash.') + '</div>';
    }
    const sessionMatch = sessionRecords.find(r => r.hash === hash);
    let sessionHtml = '';
    if (sessionMatch) {
        sessionHtml = '<div class="result-label" style="margin-top:0.8rem">SESSION MATCH</div>'
            + '<div style="color:var(--green)">\u2705 Found in session \u2014 ' + sessionMatch.icon + ' ' + sessionMatch.label + ' anchored at ' + new Date(sessionMatch.timestamp).toLocaleTimeString() + '</div>';
    }
    panel.innerHTML = '<div class="result-label">COMPUTED SHA-256 <button class="copy-btn" onclick="copyHash(\'' + hash + '\')"><i class="fas fa-copy"></i> Copy</button></div><div class="hash-display">' + hash + '</div>' + matchHtml + sessionHtml
        + '<div style="margin-top:0.8rem;font-size:0.8rem;color:var(--muted)">To verify on-chain: compare this hash with the MemoData field of the anchor transaction.</div>';
    panel.classList.add('show');
}

function updateTxLog() {
    const log = document.getElementById('txLog');
    if (!sessionRecords.length) return;
    log.innerHTML = '';
    for (let i = sessionRecords.length - 1; i >= 0; i--) {
        const r = sessionRecords[i];
        const time = new Date(r.timestamp).toLocaleTimeString('en-US',{hour12:false});
        log.innerHTML += '<div class="tx-entry"><div class="tx-icon">' + r.icon + '</div><div class="tx-info"><div class="tx-type">' + r.label + ' <span style="color:var(--muted);font-size:0.75rem">(' + r.branch + ')</span></div><div class="tx-hash">' + r.hash.substring(0,32) + '...</div></div><div><span class="tx-badge anchored">Anchored</span><div class="tx-time">' + time + '</div></div></div>';
    }
}

// ═══ ILS Workspace Engine v3 — Program-Specific Checklists & Document Analysis ═══
let ilsFiles = [];
let ilsResults = null;

// ── Per-Program ILS Checklists ──
// Each program has its own real-world checklist. Items: [id, label, critical(1/0), keyword_regex_string]
// PMS 300 — Service Craft (user-specified 17-item checklist used across YRBM, APL, AFDM, YDT, YON)
const _CL_PMS300 = [
    ['vrs_buylist','Vendor Recommended Spares and Buylist Development',1,'spare|buylist|vrs|vendor.*rec|provisioning|allowance'],
    ['crew_fam','Crew Familiarization',1,'crew.*fam|familiarization|crew.*train'],
    ['iuid','IUID Submissions',1,'iuid|unique.*ident|item.*unique'],
    ['transfer_book','Craft Transfer Book Development/Review',1,'transfer.*book|craft.*transfer|custody.*transfer'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust|sustainment.*plan'],
    ['config_inv','On-Site Parts/Material Inventory (Configuration Management)',1,'config.*mgmt|config.*manage|material.*inventory|parts.*inventory|on.?site.*inv'],
    ['ilsmt','ILSMT/Design or Production Meeting',1,'ilsmt|ils.*meet|design.*meet|production.*meet|logistics.*meet'],
    ['bam','Baseline Assessment Memorandum',1,'baseline.*assess|bam\\b|assessment.*memo'],
    ['outfit_wpn','Outfitting Navy Weapon Systems (If Applicable)',0,'outfitting.*weapon|weapon.*system.*outf|navy.*weapon'],
    ['ecp_waiver','Engineering Change Packages/Request for Waivers',1,'ecp|engineering.*change|waiver|request.*waiver|change.*package'],
    ['drl_review','DRL Reviews',1,'drl.*review|data.*require.*list|cdrl.*review|deliverable.*review'],
    ['cots_manuals','COTS Manuals Review/Submissions (Hard/Electronic Copy)',1,'cots.*manual|commercial.*manual|vendor.*manual|oem.*manual'],
    ['tm_status','Technical Manual Status/Submissions',1,'technical.*manual|tech.*manual|tm.*status|tm.*submit'],
    ['po_status','Purchase Order Status',1,'purchase.*order|po.*status|procurement.*order'],
    ['mat_sched','Material Ordering Schedule Completion',1,'material.*order|ordering.*sched|material.*sched|mat.*order'],
    ['mel','Master Equipment List Submittal',1,'master.*equip|mel\\b|equipment.*list'],
    ['outfit_stats','Outfitting Statistics (GFE, Materials, etc.)',0,'outfitting.*stat|gfe|government.*furnish|outfit.*stat']
];

// DDG-51 Flight III (PMS 400D) — Major Surface Combatant
const _CL_DDG51 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics.*support.*plan'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['pms_dev','PMS/MRC Development & Validation',1,'pms.*dev|mrc|maintenance.*requirement.*card|planned.*maint'],
    ['supply','Supply Support / Provisioning Plan',1,'supply.*support|provisioning|allowance|cosal'],
    ['vrs','Vendor Recommended Spares / Initial Outfitting',1,'vendor.*spare|vrs|initial.*outfit'],
    ['cosal','COSAL / APL Development',1,'cosal|allowance.*part.*list|apl\\b'],
    ['se','Support Equipment Requirements',1,'support.*equip|se.*req|test.*equip'],
    ['tm','Technical Manual Development (NAVSEA Format)',1,'technical.*manual|navsea.*format|tech.*manual'],
    ['ietm','Interactive Electronic Technical Manuals (IETM)',1,'ietm|interactive.*electronic|electronic.*tech.*manual'],
    ['training','Training Plan / Fleet Introduction Team (FIT)',1,'training.*plan|fleet.*intro|fit\\b.*team'],
    ['manpower','Manpower & Personnel Integration',0,'manpower|personnel.*integ'],
    ['compres','Computer Resources Life Cycle Mgmt Plan',0,'computer.*resour|lcmp|software.*support'],
    ['facilities','Facilities Requirements',0,'facilit.*req'],
    ['phst','PHS&T Analysis & Plan',0,'phs.?t|packaging|handling|storage|transport'],
    ['design','Design Interface / Supportability Analysis',1,'design.*interface|supportability'],
    ['ram','RAM Analysis / Operational Availability',1,'ram\\b|reliab|availab|maintainab|fmeca'],
    ['config','Configuration Status Accounting',1,'config.*status|config.*account|configuration'],
    ['ecp','Engineering Change Proposals / Waivers',1,'ecp|engineering.*change|waiver'],
    ['interim','Interim Support / Contractor Logistics Support (CLS)',0,'interim.*support|cls\\b|contractor.*logist'],
    ['src','Source/Repair Coding',1,'source.*repair|src\\b|repair.*cod'],
    ['dmsms','Diminishing Manufacturing Sources (DMSMS)',0,'dmsms|diminishing|obsolescen'],
    ['drl','DRL/CDRL Tracking & Reviews',1,'drl|cdrl|deliverable.*review']
];

// LCS (PMS 501) — Littoral Combat Ship (unique: mission modules, crew rotation)
const _CL_LCS = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['mm_ils','Mission Module ILS Integration',1,'mission.*module|mm\\b.*ils|module.*logist'],
    ['pms_dev','PMS/MRC Development',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment (Ship + Modules)',1,'support.*equip'],
    ['tm','Technical Manual Development',1,'technical.*manual|tech.*manual'],
    ['training','Training Plan / Crew Rotation Model',1,'training|crew.*rotat'],
    ['ram','RAM Analysis / Mission Capability',1,'ram\\b|reliab|mission.*capab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Changes / Waivers',1,'ecp|engineering.*change|waiver'],
    ['cls','Contractor Logistics Support (CLS) Plan',1,'cls\\b|contractor.*logist'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable.*review'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen'],
    ['src','Source/Repair Coding',0,'source.*repair|repair.*cod']
];

// CVN-78 (PMS 378) — Aircraft Carrier (nuclear propulsion, EMALS, massive logistics)
const _CL_CVN78 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['pms_dev','PMS/MRC Development & Validation',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares / Initial Outfitting',1,'vendor.*spare|vrs|initial.*outf'],
    ['cosal','COSAL Development',1,'cosal|allowance.*part'],
    ['se','Support Equipment Requirements',1,'support.*equip'],
    ['tm','Technical Manual Suite (NAVSEA Format)',1,'technical.*manual|tech.*manual'],
    ['ietm','IETM Development',1,'ietm|interactive.*electronic'],
    ['training','Training Plan / Fleet Introduction',1,'training.*plan|fleet.*intro'],
    ['manpower','Manpower & Personnel Integration',1,'manpower|personnel'],
    ['compres','Computer Resources Life Cycle Mgmt',1,'computer.*resour|lcmp'],
    ['facilities','Facilities / Shore Infrastructure',1,'facilit|shore.*infra'],
    ['phst','PHS&T Analysis',1,'phs.?t|packaging|handling'],
    ['design','Design Interface / Supportability',1,'design.*interface|supportability'],
    ['ram','RAM / Operational Availability',1,'ram\\b|reliab|operational.*avail'],
    ['config','Configuration Status Accounting',1,'config.*status|configuration'],
    ['ecp','Engineering Change Proposals',1,'ecp|engineering.*change'],
    ['nuc_cert','Nuclear Propulsion Logistics Certification',1,'nuclear|nuc.*cert|propulsion.*cert'],
    ['emals','EMALS/AAG System Logistics',1,'emals|aag|launch.*system|recovery.*system'],
    ['interim','Interim Support / CLS',0,'interim.*support|cls\\b'],
    ['src','Source/Repair Coding',1,'source.*repair|repair.*cod'],
    ['dmsms','DMSMS Management',1,'dmsms|diminishing|obsolescen'],
    ['drl','DRL/CDRL Tracking & Reviews',1,'drl|cdrl|deliverable']
];

// FFG-62 (PMS 515) — Constellation-class Frigate (parent design adaptation is unique)
const _CL_FFG62 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['parent_design','Parent Design ILS Data Adaptation (FREMM)',1,'parent.*design|fremm|adaptation|foreign.*design'],
    ['pms_dev','PMS/MRC Development',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment Requirements',1,'support.*equip'],
    ['tm','Technical Manual Development',1,'technical.*manual|tech.*manual'],
    ['training','Training Plan / Fleet Introduction',1,'training.*plan|fleet.*intro'],
    ['ram','RAM Analysis',1,'ram\\b|reliab|maintainab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Change Proposals',1,'ecp|engineering.*change|waiver'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['manpower','Manpower & Personnel',0,'manpower|personnel'],
    ['compres','Computer Resources',0,'computer.*resour|lcmp'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['src','Source/Repair Coding',1,'source.*repair|repair.*cod'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// LPD-17 (PMS 317) — San Antonio-class Amphibious Transport Dock (well deck, aviation)
const _CL_LPD17 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['pms_dev','PMS/MRC Development',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['cosal','COSAL Development',1,'cosal|allowance.*part'],
    ['se','Support Equipment',1,'support.*equip'],
    ['tm','Technical Manual Development',1,'technical.*manual|tech.*manual'],
    ['training','Training Plan / Fleet Introduction',1,'training.*plan|fleet.*intro'],
    ['well_deck','Well Deck / Craft Interface Logistics',1,'well.*deck|craft.*interface|lcac|lcu'],
    ['aviation','Aviation Facility Logistics',1,'aviation.*facility|flight.*deck|helo'],
    ['ram','RAM Analysis',1,'ram\\b|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Changes / Waivers',1,'ecp|engineering.*change|waiver'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['manpower','Manpower & Personnel',0,'manpower|personnel'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['src','Source/Repair Coding',1,'source.*repair|repair.*cod'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// F-35C/B (PMA-265 / JSF PO) — Naval/USMC Tactical Aircraft (ODIN/ALIS unique)
const _CL_F35NAVY = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['odin','Autonomic Logistics (ODIN/ALIS) Sustainment',1,'odin|alis|autonomic.*logist'],
    ['supply','Supply Chain Management / Global Spares Pool',1,'supply.*chain|global.*spare|spares.*pool'],
    ['depot','Depot Activation / MRO&U Planning',1,'depot.*activ|mro|overhaul.*plan'],
    ['tm','Technical Data (IETM) via ODIN',1,'technical.*data|ietm|odin.*pub'],
    ['training','Pilot & Maintainer Training Courseware',1,'pilot.*train|maintainer.*train|training.*course'],
    ['phm','Prognostic Health Management (PHM)',1,'prognostic|phm|health.*manage|condition.*based'],
    ['ram','RAM / Mission Capable Rate Analysis',1,'ram\\b|mission.*capable|mc.*rate|reliab'],
    ['config','Configuration Mgmt / Software Baseline',1,'config.*manage|software.*baseline|configuration'],
    ['se','Support Equipment / Aerospace Ground Equipment',1,'support.*equip|age\\b|aerospace.*ground'],
    ['facilities','Facilities / Hangar Requirements',1,'facilit|hangar.*req'],
    ['manpower','Manpower Estimate Report',0,'manpower|personnel'],
    ['phst','PHS&T / Transportability',0,'phs.?t|transport'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['pbl','Performance-Based Logistics (PBL) / CLS',1,'pbl|performance.*based|cls\\b|contractor.*logist'],
    ['dmsms','DMSMS / Obsolescence Management',1,'dmsms|diminishing|obsolescen'],
    ['lo','Low-Observable Maintenance (F-35B/C specific)',0,'low.*observ|stealth|lo\\b.*maint|signature']
];

// CH-53K (PMA-261) — Heavy-Lift Helicopter
const _CL_CH53K = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['pms','Maintenance Plan / PMS Development',1,'maint.*plan|pms.*dev|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment / Ground Support',1,'support.*equip|ground.*support|gse'],
    ['tm','Technical Manuals (IETM)',1,'technical.*manual|ietm'],
    ['training','Training Systems / Simulators',1,'training.*system|simulator|crew.*train'],
    ['ram','RAM Analysis / Mission Capable Rate',1,'ram\\b|mission.*capable|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Change Proposals',1,'ecp|engineering.*change'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['facilities','Facility Requirements / Hangar Modifications',0,'facilit|hangar'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['cls','Contractor Logistics Support Transition',0,'cls\\b|contractor.*logist|transition'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// M1A2 Abrams SEPv3 (PEO GCS) — Main Battle Tank (Army LSA-based)
const _CL_M1 = [
    ['lsa','Logistics Support Analysis (LSA)',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart (MAC)',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List (RPSTL)',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (TM 9-series)',1,'technical.*manual|tm.*9|army.*tm'],
    ['net','New Equipment Training (NET) Plan',1,'new.*equip.*train|net\\b.*plan|net\\b.*team'],
    ['provisioning','Provisioning Plan / ASL Development',1,'provisioning|asl\\b.*dev|authorized.*stockage'],
    ['tmde','Test, Measurement & Diagnostic Equipment (TMDE)',1,'tmde|test.*measure|diagnostic.*equip'],
    ['manprint','MANPRINT Assessment',1,'manprint|human.*factor|human.*system'],
    ['ram','RAM Analysis / Ao Requirements',1,'ram\\b|reliab|operational.*avail'],
    ['config','Configuration Management / ECP Tracking',1,'config.*manage|ecp|engineering.*change'],
    ['transport','Transportability Assessment (Rail/Air/Sea)',1,'transportab|rail.*load|air.*transport|sea.*transport'],
    ['depot','Depot Maintenance Work Requirements (DMWR)',1,'depot.*maint|dmwr|organic.*maint'],
    ['pbl','Performance-Based Logistics (PBL) Metrics',0,'pbl|performance.*based'],
    ['hazmat','HAZMAT / Environmental Compliance',0,'hazmat|environment|hazardous.*material'],
    ['dmsms','DMSMS / Obsolescence Management',0,'dmsms|diminishing|obsolescen'],
    ['warranty','Warranty Tracking & Administration',0,'warranty|tracking.*admin']
];

// Stryker ICV-VA1 (PM Stryker) — Infantry Combat Vehicle
const _CL_STRYKER = [
    ['lsa','Logistics Support Analysis (LSA)',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart (MAC)',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List (RPSTL)',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (TM 9-series)',1,'technical.*manual|tm.*9'],
    ['net','New Equipment Training (NET)',1,'new.*equip.*train|net\\b.*plan'],
    ['provisioning','Provisioning / ASL',1,'provisioning|asl\\b|authorized.*stockage'],
    ['tmde','TMDE / Special Tools',1,'tmde|special.*tool|test.*equip'],
    ['manprint','MANPRINT Assessment',0,'manprint|human.*factor'],
    ['ram','RAM / Operational Readiness',1,'ram\\b|reliab|operational.*read'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['transport','Transportability (C-17/C-130 Compatibility)',1,'transportab|c.?17|c.?130|airlift'],
    ['depot','Depot Maintenance Planning',1,'depot.*maint|organic.*maint'],
    ['pbl','Performance-Based Logistics',0,'pbl|performance.*based'],
    ['fielding','Fielding Plan / BOIP',1,'fielding|boip|basis.*issue'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// AH-64E Apache Guardian (PEO Aviation) — Attack Helicopter
const _CL_AH64 = [
    ['lsa','Logistics Support Analysis',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart (MAC)',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (Aviation TMs)',1,'technical.*manual|aviation.*tm'],
    ['phase','Aircraft Maintenance / Phase Inspections',1,'phase.*inspect|aircraft.*maint|periodic.*inspect'],
    ['net','Pilot/Crew Training (NET)',1,'pilot.*train|crew.*train|net\\b.*plan'],
    ['simulator','Training Devices / Simulator Support',1,'simulator|training.*device|synthetic.*train'],
    ['provisioning','Provisioning / ASL',1,'provisioning|asl\\b|authorized.*stockage'],
    ['gse','Ground Support Equipment (GSE)',1,'ground.*support|gse|support.*equip'],
    ['ram','RAM / Mission Capable Rate',1,'ram\\b|mission.*capable|reliab'],
    ['config','Configuration Management / MOD Programs',1,'config.*manage|modification.*program|mod\\b.*program'],
    ['depot','Depot / AVIM / AVUM Planning',1,'depot|avim|avum|aviation.*maint'],
    ['phst','PHS&T / Transportability',0,'phs.?t|transportab'],
    ['dmsms','DMSMS / Obsolescence',0,'dmsms|diminishing|obsolescen'],
    ['pbl','Performance-Based Logistics (PBL)',0,'pbl|performance.*based']
];

// M142 HIMARS (PEO Missiles & Space) — Rocket Artillery
const _CL_HIMARS = [
    ['lsa','Logistics Support Analysis',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (TM 9-series)',1,'technical.*manual|tm.*9'],
    ['ammo','Ammunition Logistics / QASAS Coordination',1,'ammo|ammunit|qasas|munition|rocket.*pod'],
    ['net','New Equipment Training (NET)',1,'new.*equip.*train|net\\b'],
    ['provisioning','Provisioning Plan',1,'provisioning|asl\\b'],
    ['tmde','TMDE / Support Equipment',1,'tmde|support.*equip|test.*equip'],
    ['ram','RAM / System Readiness',1,'ram\\b|reliab|system.*read'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['transport','Transportability (C-130 / LMSR)',1,'transportab|c.?130|lmsr|airlift'],
    ['depot','Depot Maintenance Work Requirements',0,'depot.*maint|dmwr'],
    ['fms','Foreign Military Sales (FMS) Support',0,'fms|foreign.*military|security.*cooperat'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// F-35A Lightning II (USAF) — Conventional Takeoff Fighter
const _CL_F35A = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['odin','ODIN / Autonomic Logistics Information System',1,'odin|alis|autonomic.*logist'],
    ['tos','Technical Orders (TO) Development',1,'technical.*order|to\\b.*develop|tech.*order'],
    ['supply','Supply Chain / Global Spares Pool',1,'supply.*chain|global.*spare|spares.*pool'],
    ['depot','Depot Activation / Organic Capability',1,'depot.*activ|organic.*capab|depot.*standup'],
    ['age','Aerospace Ground Equipment (AGE)',1,'aerospace.*ground|age\\b|ground.*equip'],
    ['training','Aircrew & Maintainer Training',1,'aircrew.*train|maintainer.*train|training'],
    ['facilities','Facilities / Hangar Requirements',1,'facilit|hangar'],
    ['phm','Prognostic Health Management',1,'prognostic|phm|health.*manage|condition.*based'],
    ['ram','RAM / Mission Capable Rate',1,'ram\\b|mission.*capable|mc.*rate|reliab'],
    ['config','Configuration / Software Baseline Mgmt',1,'config.*manage|software.*baseline|configuration'],
    ['pbl','Performance-Based Logistics (PBL)',1,'pbl|performance.*based'],
    ['drl','CDRL / Deliverable Reviews',1,'cdrl|drl|deliverable'],
    ['manpower','Manpower Estimate / LCOM',0,'manpower|lcom|logistics.*composite'],
    ['phst','PHS&T / Transportability',0,'phs.?t|transportab'],
    ['dmsms','DMSMS / Obsolescence',0,'dmsms|diminishing|obsolescen']
];

// KC-46A Pegasus (USAF) — Aerial Refueling Tanker
const _CL_KC46 = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['rcm','Reliability Centered Maintenance (RCM)',1,'rcm|reliability.*centered|maint.*steering'],
    ['tos','Technical Orders Development',1,'technical.*order|to\\b.*develop|tech.*order'],
    ['supply','Supply Chain Management',1,'supply.*chain|provisioning'],
    ['depot','Depot-Level Maintenance / PDM',1,'depot.*maint|pdm|programmed.*depot'],
    ['age','Aerospace Ground Equipment',1,'aerospace.*ground|age\\b|ground.*equip'],
    ['training','Aircrew & Maintainer Training',1,'aircrew.*train|maintainer.*train|training'],
    ['boom','Boom Operator / Refueling System Logistics',1,'boom.*oper|refueling.*system|aerial.*refuel'],
    ['ram','RAM / Availability Analysis',1,'ram\\b|reliab|availab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['drl','CDRL Reviews',1,'cdrl|drl|deliverable'],
    ['pbl','Performance-Based Logistics',0,'pbl|performance.*based'],
    ['facilities','Facilities Assessment',0,'facilit'],
    ['phst','PHS&T',0,'phs.?t|transport'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// B-21 Raider (USAF) — Long-Range Strike Bomber (stealth, classified elements)
const _CL_B21 = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['lsa','Logistics Supportability Analysis',1,'lsa\\b|logistics.*supportab'],
    ['tos','Technical Orders / IETM Development',1,'technical.*order|ietm|tech.*order'],
    ['supply','Supply Chain / Provisioning',1,'supply.*chain|provisioning'],
    ['depot','Depot Activation / Organic Maintenance',1,'depot.*activ|organic.*maint'],
    ['age','Aerospace Ground Equipment',1,'aerospace.*ground|age\\b|ground.*equip'],
    ['training','Training Systems / Simulators',1,'training.*system|simulator'],
    ['ram','RAM / Stealth Sustainment Metrics',1,'ram\\b|reliab|stealth.*sust|lre'],
    ['config','Configuration Management / SCN',1,'config.*manage|scn|software.*change'],
    ['lo_maint','Low-Observable (LO) Maintenance & Materials',1,'low.*observ|lo\\b.*maint|stealth.*maint|signature'],
    ['facilities','Secure Facilities Requirements',1,'secure.*facilit|scif|classified.*facilit'],
    ['cyber','Cybersecurity / Mission Systems Logistics',1,'cyber|mission.*system.*logist|information.*assur'],
    ['drl','CDRL Reviews',1,'cdrl|drl|deliverable'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen'],
    ['phst','PHS&T',0,'phs.?t|transport']
];

// C-17 Globemaster III (USAF) — Strategic Airlift
const _CL_C17 = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['rcm','Reliability Centered Maintenance (RCM)',1,'rcm|reliability.*centered'],
    ['tos','Technical Orders',1,'technical.*order|tech.*order'],
    ['supply','Supply Chain / DLA Coordination',1,'supply.*chain|dla\\b|provisioning'],
    ['pdm','Programmed Depot Maintenance (PDM)',1,'pdm|programmed.*depot|depot.*maint'],
    ['age','Aerospace Ground Equipment',1,'aerospace.*ground|age\\b'],
    ['training','Aircrew & Maintainer Training',1,'aircrew.*train|maintainer.*train|training'],
    ['ram','RAM / Mission Capable Rate',1,'ram\\b|mission.*capable|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['drl','CDRL / Sustainment Reviews',1,'cdrl|drl|deliverable'],
    ['asip','Structural Life / ASIP Compliance',1,'asip|structural.*life|aircraft.*structural|fatigue'],
    ['dmsms','DMSMS / Aging Aircraft Sustainment',1,'dmsms|diminishing|aging.*aircraft|obsolescen'],
    ['pbl','Performance-Based Logistics',0,'pbl|performance.*based'],
    ['facilities','Facilities',0,'facilit'],
    ['phst','PHS&T',0,'phs.?t|transport']
];

// GPS III/IIIF (Space Systems Command) — Navigation Satellite
const _CL_USSF = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['ground_se','Ground Segment Support Equipment',1,'ground.*segment|ground.*equip|ops.*center'],
    ['sat_ops','Satellite Operations Sustainment',1,'satellite.*ops|on.?orbit|spacecraft.*ops'],
    ['supply','Supply Chain / Unique Space Parts',1,'supply.*chain|space.*parts|unique.*component'],
    ['training','Operator & Maintainer Training',1,'operator.*train|maintainer.*train|training'],
    ['cyber','Cybersecurity / Space Resilience Logistics',1,'cyber|space.*resilien|information.*assur'],
    ['ram','RAM / On-Orbit Reliability',1,'ram\\b|on.?orbit.*reliab|reliab'],
    ['config','Configuration / Firmware Version Control',1,'config.*manage|firmware|version.*control'],
    ['launch','Launch Operations Logistics',1,'launch.*ops|launch.*logist|launch.*integrat'],
    ['drl','CDRL / Deliverable Reviews',1,'cdrl|drl|deliverable'],
    ['facilities','Ground Station Facilities',0,'ground.*station|facilit'],
    ['dmsms','DMSMS / Component Availability',0,'dmsms|diminishing|component.*avail'],
    ['disposal','End-of-Life / Deorbit Planning',0,'end.*life|deorbit|disposal']
];

// USCG Cutters (CG-9325) — NSC, OPC, FRC
const _CL_USCG = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['pms','PMS / Maintenance Plan Development',1,'pms\\b|maint.*plan|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment',1,'support.*equip'],
    ['tm','Technical Manuals (CG Format)',1,'technical.*manual|tech.*manual|cg.*manual'],
    ['training','Training Plan / Crew Familiarization',1,'training.*plan|crew.*familiar'],
    ['ram','RAM Analysis',1,'ram\\b|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Changes / Waivers',1,'ecp|engineering.*change|waiver'],
    ['drl','DRL / CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['c4isr','C4ISR / Mission Systems Logistics',1,'c4isr|mission.*system|command.*control'],
    ['phst','PHS&T',0,'phs.?t|packaging'],
    ['facilities','Homeport Facilities',0,'homeport|facilit']
];

// ACV 1.1 (PEO Land Systems, USMC) — Amphibious Combat Vehicle
const _CL_ACV = [
    ['lsa','Logistics Support Analysis',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals',1,'technical.*manual|tech.*manual'],
    ['amphib','Amphibious Ship Interface Logistics',1,'amphibi|ship.*interface|well.*deck|l-class'],
    ['net','New Equipment Training / MOS Training',1,'new.*equip.*train|mos\\b|net\\b.*plan'],
    ['provisioning','Provisioning / Block Requirements',1,'provisioning|block.*req'],
    ['se','Support Equipment / Combat Service Support',1,'support.*equip|combat.*service'],
    ['ram','RAM / Operational Readiness',1,'ram\\b|reliab|operational.*read'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['waterborne','Waterborne / Swim Operations Logistics',1,'waterborne|swim.*ops|water.*ops|surf.*zone'],
    ['ecp','Engineering Changes',1,'ecp|engineering.*change'],
    ['drl','CDRL Reviews',1,'cdrl|drl|deliverable'],
    ['phst','PHS&T / Embarkation',0,'phs.?t|embark'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// Custom / Generic — minimal baseline
const _CL_CUSTOM = [
    ['ilsp','Logistics Support Plan',1,'ilsp|logistics.*support.*plan'],
    ['maint','Maintenance Planning',1,'maint.*plan|maintenance'],
    ['supply','Supply Support',1,'supply|provisioning|spare'],
    ['tm','Technical Data / Manuals',1,'technical.*manual|tech.*data|publication'],
    ['training','Training',0,'training|instruction'],
    ['ram','RAM Analysis',0,'ram\\b|reliab|maintainab'],
    ['config','Configuration Management',0,'config.*manage|configuration'],
    ['drl','Deliverable Tracking',0,'drl|cdrl|deliverable']
];

// Map every program to its checklist
const _CL_MAP = {
    yrbm:_CL_PMS300, apl:_CL_PMS300, afdm:_CL_PMS300, ydt:_CL_PMS300, yon:_CL_PMS300,
    ddg51:_CL_DDG51, lcs:_CL_LCS, cvn78:_CL_CVN78, ffg62:_CL_FFG62, lpd17:_CL_LPD17,
    f35:_CL_F35NAVY, f35b:_CL_F35NAVY, ch53k:_CL_CH53K,
    m1:_CL_M1, stryker:_CL_STRYKER, ah64:_CL_AH64, himars:_CL_HIMARS,
    f35a:_CL_F35A, kc46:_CL_KC46, b21:_CL_B21, c17:_CL_C17,
    gps3:_CL_USSF, sbirs:_CL_USSF,
    nsc:_CL_USCG, opc:_CL_USCG, frc:_CL_USCG,
    acv:_CL_ACV,
    custom:_CL_CUSTOM
};

function getCL(key) { return (_CL_MAP[key]||_CL_CUSTOM).map(a=>({id:a[0],l:a[1],c:a[2],kw:new RegExp(a[3],'i')})); }

const DI_MAP = {
    'DI-ILSS-81490':'ilsmgmt','DI-ILSS-81494':'maint','DI-ILSS-81492':'maint',
    'DI-ILSS-81493':'supply','DI-ILSS-81495':'supply','DI-ILSS-81496':'supply','DI-ILSS-81497':'supply',
    'DI-SESS-81519':'se','DI-TMSS-81000':'techdata','DI-TMSS-80063':'techdata','DI-TMSS-80000':'techdata',
    'DI-TRAN-81476':'training','DI-HFAC-80743':'manpower','DI-MCCR-80030':'compres',
    'DI-FACI-80931':'facilities','DI-PACK-80886':'phst','DI-MISC-80711':'design',
    'DI-RELI-80255':'ram','DI-RELI-81372':'ram','DI-CMAN-81250':'config','DI-CMAN-80858':'config',
    'DI-MGMT-81466':'ilsmgmt','DI-ALSS-81530':'lsa','DI-ALSS-81529':'lsa',
    'DI-TMSS-80897':'techdata','DI-TMSS-81114':'techdata'
};

const OWNERS = {
    ilsmgmt:{p:'PMS / Program Office',s:'Contractor'},maint:{p:'Contractor (ILS)',s:'NAVSEA / SUPSHIP'},
    supply:{p:'Contractor (Provisioning)',s:'NAVSUP / DLA'},se:{p:'Contractor',s:'NAVSEA'},
    techdata:{p:'Contractor (Tech Pubs)',s:'NSWCCD / PMS'},training:{p:'NETC / Contractor',s:'PMS'},
    manpower:{p:'OPNAV N1 / PMS',s:'Contractor'},compres:{p:'Contractor',s:'NAVWAR / PMS'},
    facilities:{p:'NAVFAC',s:'PMS'},phst:{p:'Contractor',s:'NAVSEA / PMS'},
    design:{p:'Contractor (Engineering)',s:'NAVSEA'},ram:{p:'Contractor',s:'NAVSEA / PMS'},
    config:{p:'Contractor (CM)',s:'PMS / NAVSEA'},lsa:{p:'Contractor (LSA)',s:'PM / PEO'},
    depot:{p:'Organic Depot / DLA',s:'PM'},cyber:{p:'Contractor (Cyber)',s:'NAVWAR / DISA'}
};

const COST_K = {ilsmgmt:45,maint:120,supply:250,se:80,techdata:150,training:60,manpower:35,
    compres:25,facilities:40,phst:30,design:55,ram:95,config:110,lsa:80,depot:200,cyber:65};

// Format cost values: values in K → $485K or $2.2M
function formatCost(costK) {
    if (costK >= 1000) {
        const m = costK / 1000;
        return '$' + (m % 1 === 0 ? m.toFixed(0) : m.toFixed(1)) + 'M';
    }
    return '$' + costK + 'K';
}
// Format cost values: values already in $M → $85M, $1.7B, $8.0T
function formatCostM(valM) {
    if (valM >= 1000000) { return '$' + (valM / 1000000).toFixed(1) + 'T'; }
    if (valM >= 1000) { return '$' + (valM / 1000).toFixed(1) + 'B'; }
    if (valM >= 1) { return '$' + valM.toFixed(0) + 'M'; }
    return '$' + (valM * 1000).toFixed(0) + 'K';
}

// ── Program DRL Templates ──
const PROGS = {
    yrbm:{name:'YRBM \u2014 Yard, Repair, Berthing, & Messing',ofc:'PMS 300',type:'Service Craft (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System (PMS) Development',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81496',t:'Allowance Parts List (APL)',el:'supply',c:1},
        {s:'A006',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operator/Crew',el:'techdata',c:1},
        {s:'A007',di:'DI-TMSS-80063',t:'Technical Manual Content Verification',el:'techdata',c:0},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Status Accounting Report',el:'config',c:1},
        {s:'A009',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:0},
        {s:'A010',di:'DI-TRAN-81476',t:'Training Plan (Crew Familiarization)',el:'training',c:0},
        {s:'A011',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A012',di:'DI-RELI-80255',t:'RAM Analysis / Reliability Report',el:'ram',c:1},
        {s:'A013',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A014',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:0},
        {s:'A015',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    apl:{name:'APL \u2014 Auxiliary Personnel Lighter',ofc:'PMS 300',type:'Service Craft (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting Report',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:0},
        {s:'A008',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    afdm:{name:'AFDM \u2014 Auxiliary Floating Drydock Medium',ofc:'PMS 300',type:'Floating Drydock',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis (LORA)',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-ILSS-81497',t:'Supply Support Request',el:'supply',c:0},
        {s:'A008',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Ops & Maintenance',el:'techdata',c:1},
        {s:'A009',di:'DI-TMSS-80063',t:'Technical Manual Content Verification',el:'techdata',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A011',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:1},
        {s:'A012',di:'DI-SESS-81519',t:'Support Equipment \u2014 Ballast/Crane Systems',el:'se',c:1},
        {s:'A013',di:'DI-TRAN-81476',t:'Training Plan \u2014 Operations & Safety',el:'training',c:1},
        {s:'A014',di:'DI-RELI-80255',t:'RAM Analysis Report',el:'ram',c:1},
        {s:'A015',di:'DI-RELI-81372',t:'Failure Reporting (FRACAS)',el:'ram',c:0},
        {s:'A016',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:0},
        {s:'A017',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A018',di:'DI-HFAC-80743',t:'Manpower & Personnel Report',el:'manpower',c:0},
        {s:'A019',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:1},
        {s:'A020',di:'DI-MCCR-80030',t:'Computer Resources LCMP',el:'compres',c:0},
        {s:'A021',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    ydt:{name:'YDT \u2014 Large Harbor Tug',ofc:'PMS 300',type:'Service Craft (Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations & Propulsion',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan \u2014 Crew Operations',el:'training',c:1},
        {s:'A008',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0},
        {s:'A012',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:0}
    ]},
    yon:{name:'YON \u2014 Fuel Oil Barge',ofc:'PMS 300',type:'Fuel Barge (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations & Safety',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Safety & Hazmat Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-PACK-80886',t:'PHS&T Plan (Fuel Handling)',el:'phst',c:1},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    ddg51:{name:'DDG-51 Flight III (Arleigh Burke)',ofc:'PMS 400D',type:'Guided Missile Destroyer',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-TMSS-81000',t:'Technical Manuals (Full Suite)',el:'techdata',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A009',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:1},
        {s:'A010',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A011',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A012',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A013',di:'DI-RELI-81372',t:'Failure Reporting (FRACAS)',el:'ram',c:1},
        {s:'A014',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:1},
        {s:'A015',di:'DI-MCCR-80030',t:'Computer Resources LCMP',el:'compres',c:1},
        {s:'A016',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:0},
        {s:'A017',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A018',di:'DI-MISC-80711',t:'Design Interface',el:'design',c:1},
        {s:'A019',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    lcs:{name:'LCS Freedom-class',ofc:'PMS 501',type:'Littoral Combat Ship',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:0},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    cvn78:{name:'CVN-78 Ford-class',ofc:'PMS 378',type:'Aircraft Carrier',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-ILSS-81497',t:'Supply Support Request',el:'supply',c:1},
        {s:'A008',di:'DI-TMSS-81000',t:'Technical Manuals (Complete)',el:'techdata',c:1},
        {s:'A009',di:'DI-TMSS-80063',t:'TM Verification',el:'techdata',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A011',di:'DI-CMAN-80858',t:'ECPs',el:'config',c:1},
        {s:'A012',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A013',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A014',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A015',di:'DI-RELI-81372',t:'FRACAS',el:'ram',c:1},
        {s:'A016',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:1},
        {s:'A017',di:'DI-MCCR-80030',t:'Computer Resources',el:'compres',c:1},
        {s:'A018',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:1},
        {s:'A019',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A020',di:'DI-MISC-80711',t:'Design Interface',el:'design',c:1},
        {s:'A021',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    ffg62:{name:'FFG-62 Constellation-class',ofc:'PMS 515',type:'Guided Missile Frigate',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A010',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    lpd17:{name:'LPD-17 San Antonio-class',ofc:'PMS 317',type:'Amphibious Transport Dock',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:0},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    f35:{name:'F-35C Lightning II',ofc:'PMA-265 / JSF PO',type:'Carrier-Based Strike Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan / ALIS Requirements',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (IETM)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / PHM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ALIS / ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    f35b:{name:'F-35B Lightning II (STOVL)',ofc:'PMA-265 / JSF PO',type:'STOVL Strike Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (IETM)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / PHM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    ch53k:{name:'CH-53K King Stallion',ofc:'PMA-261',type:'Heavy-Lift Helicopter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    m1:{name:'M1A2 Abrams SEPv3',ofc:'PEO GCS',type:'Main Battle Tank',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis (LSA)',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'LSAR Data / MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Technical Manuals (TM 9-2350)',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Plan / ASL',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Repair Parts & Special Tools List',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'New Equipment Training (NET) Plan',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'TMDE Requirements',el:'se',c:1},
        {s:'A008',di:'DI-HFAC-80743',t:'MANPRINT Assessment',el:'manpower',c:1},
        {s:'A009',di:'DI-RELI-80255',t:'RAM / Ao Analysis',el:'ram',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Management / ECPs',el:'config',c:1},
        {s:'A011',di:'DI-PACK-80886',t:'Transportability Assessment',el:'phst',c:1},
        {s:'A012',di:'DI-MGMT-81466',t:'Depot Maintenance Work Requirements',el:'ilsmgmt',c:1}
    ]},
    stryker:{name:'Stryker ICV-VA1',ofc:'PM Stryker',type:'Infantry Combat Vehicle',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Technical Manuals (TM 9-series)',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning / ASL',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'New Equipment Training',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'TMDE / Special Tools',el:'se',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'Transportability (C-17/C-130)',el:'phst',c:1}
    ]},
    ah64:{name:'AH-64E Apache Guardian',ofc:'PEO Aviation',type:'Attack Helicopter',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Aviation Technical Manuals',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning / ASL',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Pilot/Crew Training (NET)',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'Ground Support Equipment (GSE)',el:'se',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / Mission Capable Rate',el:'ram',c:1},
        {s:'A009',di:'DI-CMAN-81250',t:'Configuration / MOD Programs',el:'config',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Depot / AVIM / AVUM Planning',el:'ilsmgmt',c:1}
    ]},
    himars:{name:'M142 HIMARS',ofc:'PEO Missiles & Space',type:'Rocket Artillery',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-TMSS-80897',t:'Technical Manuals (TM 9-series)',el:'techdata',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Plan',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A005',di:'DI-TRAN-81476',t:'New Equipment Training',el:'training',c:1},
        {s:'A006',di:'DI-SESS-81519',t:'TMDE / Support Equipment',el:'se',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / System Readiness',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A009',di:'DI-PACK-80886',t:'Transportability (C-130)',el:'phst',c:1}
    ]},
    f35a:{name:'F-35A Lightning II (USAF)',ofc:'JSF PO / ACC',type:'Conventional Takeoff Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan / ODIN',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning / Global Spares',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81114',t:'Technical Orders (TOs)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config / Software Baseline',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Aircrew & Maintainer Training',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / MC Rate Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-SESS-81519',t:'Aerospace Ground Equipment',el:'se',c:1}
    ]},
    kc46:{name:'KC-46A Pegasus',ofc:'AFLCMC',type:'Aerial Refueling Tanker',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Reliability Centered Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-TMSS-81114',t:'Technical Orders',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Supply Chain Management',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Aircrew Training',el:'training',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / Availability',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'AGE Requirements',el:'se',c:1}
    ]},
    b21:{name:'B-21 Raider',ofc:'AFLCMC / LRSO PO',type:'Long-Range Strike Bomber',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-TMSS-81114',t:'Technical Orders / IETM',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Supply / Provisioning',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Training Systems / Simulators',el:'training',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / Stealth Sustainment',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Config / SCN Management',el:'config',c:1},
        {s:'A009',di:'DI-FACI-80931',t:'Secure Facility Requirements',el:'facilities',c:1},
        {s:'A010',di:'DI-MCCR-80030',t:'Cybersecurity / Mission Systems',el:'compres',c:1}
    ]},
    c17:{name:'C-17 Globemaster III',ofc:'AFLCMC',type:'Strategic Airlift',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'RCM / Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-TMSS-81114',t:'Technical Orders',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Supply Chain / DLA Coordination',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Aircrew & Maintainer Training',el:'training',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / Mission Capable Rate',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'AGE Requirements',el:'se',c:1}
    ]},
    gps3:{name:'GPS III / IIIF',ofc:'Space Systems Command',type:'Navigation Satellite',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Ground Segment Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Supply / Unique Space Parts',el:'supply',c:1},
        {s:'A004',di:'DI-TRAN-81476',t:'Operator Training',el:'training',c:1},
        {s:'A005',di:'DI-RELI-80255',t:'On-Orbit Reliability Analysis',el:'ram',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config / Firmware Control',el:'config',c:1},
        {s:'A007',di:'DI-MCCR-80030',t:'Cybersecurity / Space Resilience',el:'compres',c:1},
        {s:'A008',di:'DI-FACI-80931',t:'Ground Station Facilities',el:'facilities',c:0}
    ]},
    sbirs:{name:'SBIRS / Next-Gen OPIR',ofc:'Space Systems Command',type:'Missile Warning Satellite',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Ground Segment Maintenance',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Supply / Classified Components',el:'supply',c:1},
        {s:'A004',di:'DI-TRAN-81476',t:'Mission Crew Training',el:'training',c:1},
        {s:'A005',di:'DI-RELI-80255',t:'Constellation Availability Analysis',el:'ram',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A007',di:'DI-MCCR-80030',t:'Cybersecurity / STIG Compliance',el:'compres',c:1},
        {s:'A008',di:'DI-FACI-80931',t:'SCIF / Ground Station Requirements',el:'facilities',c:1}
    ]},
    nsc:{name:'NSC (Legend-class)',ofc:'CG-9325',type:'National Security Cutter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan (PMS)',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (CG Format)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'C4ISR Logistics',el:'ilsmgmt',c:1}
    ]},
    opc:{name:'OPC (Heritage-class)',ofc:'CG-9325',type:'Offshore Patrol Cutter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1}
    ]},
    frc:{name:'FRC (Sentinel-class)',ofc:'CG-9325',type:'Fast Response Cutter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1}
    ]},
    acv:{name:'ACV 1.1 Amphibious Combat Vehicle',ofc:'PEO Land Systems (USMC)',type:'Amphibious Combat Vehicle',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning / Block Requirements',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'MOS Training Plan',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'CSS Equipment',el:'se',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / Operational Readiness',el:'ram',c:1},
        {s:'A009',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1}
    ]},
    custom:{name:'Custom Program',ofc:'\u2014',type:'User-Defined',drls:[
        {s:'C001',di:'DI-ILSS-81490',t:'Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'C002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'C003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'C004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:0},
        {s:'C005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'C006',di:'DI-CMAN-81250',t:'Configuration Accounting',el:'config',c:0},
        {s:'C007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:0},
        {s:'C008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:0}
    ]}
};

// ── Program-Specific Components — Proxy to S4 Platforms DB (462 platforms) ──
const PROG_COMPONENTS = new Proxy({}, {
    get(_, k) { if (typeof k !== 'string') return undefined; return window.S4_getComponents ? S4_getComponents(k) : {systems:['System'],nsns:['0000-00-000-0001'],mfgs:['OEM']}; },
    has(_, k) { return typeof k === 'string'; },
    ownKeys() { return window.S4_PLATFORMS ? Object.keys(S4_PLATFORMS) : []; },
    getOwnPropertyDescriptor(_, k) { return {configurable:true, enumerable:true, value: (window.S4_getComponents) ? S4_getComponents(k) : undefined}; }
});

// ── Sample DRL Generator (Enhanced with realistic DI numbers) ──
// Extended DI catalog per program type for realistic samples
const EXTENDED_DI = {
    navy_pms300: [
        {di:'DI-001',t:'Contract Data Requirements List (CDRL)',el:'ilsmgmt'},
        {di:'DI-002',t:'Statement of Work (SOW) Compliance Matrix',el:'ilsmgmt'},
        {di:'DI-003',t:'Integrated Master Schedule (IMS)',el:'ilsmgmt'},
        {di:'DI-004',t:'Systems Engineering Plan (SEP)',el:'design'},
        {di:'DI-005',t:'Interface Control Document (ICD)',el:'design'},
        {di:'DI-006',t:'Test & Evaluation Master Plan (TEMP)',el:'ram'},
        {di:'DI-007',t:'Weight Report',el:'design'},
        {di:'DI-008',t:'Electrical Load Analysis',el:'design'},
        {di:'DI-009',t:'Purchase Order Index',el:'supply'},
        {di:'DI-010',t:'Long Lead Time Material List',el:'supply'},
        {di:'DI-011',t:'Government Furnished Material (GFM) List',el:'supply'},
        {di:'DI-012',t:'Hazardous Material (HazMat) List',el:'phst'},
        {di:'DI-013',t:'Lifting & Handling Plan',el:'phst'},
        {di:'DI-014',t:'Fire Protection Plan',el:'design'},
        {di:'DI-015',t:'Compartment Check-Off List (CCOL)',el:'maint'},
        {di:'DI-016',t:'Quality Assurance Plan',el:'ilsmgmt'},
        {di:'DI-017',t:'Welding Procedure Qualification Records',el:'maint'},
        {di:'DI-018',t:'Non-Destructive Testing (NDT) Procedures',el:'maint'},
        {di:'DI-019',t:'Post-Delivery Availability (PDA) Plan',el:'maint'},
        {di:'DI-020',t:'Vendor Recommended Spares (VRS)',el:'supply'},
        {di:'DI-021',t:'Allowance Parts List (APL)',el:'supply'},
        {di:'DI-022',t:'Allowance Equipage List (AEL)',el:'supply'},
        {di:'DI-023',t:'Technical Manual (Operator)',el:'techdata'},
        {di:'DI-024',t:'Technical Manual (Maintenance)',el:'techdata'},
        {di:'DI-025',t:'Damage Control Book',el:'techdata'},
        {di:'DI-026',t:'Ship Information Book (SIB)',el:'techdata'},
        {di:'DI-027',t:'Baseline Design Drawing Package',el:'config'},
        {di:'DI-028',t:'As-Built Drawing Package',el:'config'},
        {di:'DI-029',t:'Configuration Status Accounting (CSA)',el:'config'},
        {di:'DI-030',t:'Engineering Change Proposal (ECP)',el:'config'},
        {di:'DI-031',t:'Item Unique Identification (IUID) Register',el:'supply'},
        {di:'DI-032',t:'Maintenance Requirement Cards (MRCs)',el:'maint'},
        {di:'DI-033',t:'Planned Maintenance System (PMS) Index',el:'maint'},
        {di:'DI-034',t:'Reliability Analysis / FMECA',el:'ram'},
        {di:'DI-035',t:'Maintainability Analysis',el:'ram'},
        {di:'DI-036',t:'Availability (Ao) Analysis Report',el:'ram'},
        {di:'DI-037',t:'Level of Repair Analysis (LORA)',el:'maint'},
        {di:'DI-038',t:'Life Cycle Cost Analysis (LCCA)',el:'ilsmgmt'},
        {di:'DI-039',t:'Life Cycle Sustainment Plan (LCSP)',el:'ilsmgmt'},
        {di:'DI-040',t:'Crew Familiarization Training Plan',el:'training'},
        {di:'DI-041',t:'Machinery Equipment List (MEL)',el:'supply'},
        {di:'DI-042',t:'Safety Assessment Report',el:'design'},
        {di:'DI-043',t:'Environmental Compliance Plan',el:'phst'},
        {di:'DI-044',t:'Spares Buylist / Initial Outfitting',el:'supply'}
    ],
    army: [
        {di:'DI-001',t:'LSA Record (LSAR) Data',el:'lsa'},{di:'DI-002',t:'MAC Code Assignment',el:'lsa'},
        {di:'DI-003',t:'RPSTL — Repair Parts & Special Tools',el:'supply'},{di:'DI-004',t:'NET Plan / Training Support Package',el:'training'},
        {di:'DI-005',t:'MANPRINT Assessment Report',el:'manpower'},{di:'DI-006',t:'Transportability Report (C-17/C-130)',el:'phst'},
        {di:'DI-007',t:'Technical Manual TM 9-series',el:'techdata'},{di:'DI-008',t:'Depot Maintenance Work Requirements (DMWR)',el:'maint'},
        {di:'DI-009',t:'Provisioning Master Record',el:'supply'},{di:'DI-010',t:'Reliability Growth Test Plan',el:'ram'},
        {di:'DI-011',t:'RAM/Ao Threshold Analysis',el:'ram'},{di:'DI-012',t:'Fielding Plan',el:'ilsmgmt'},
        {di:'DI-013',t:'PBL Strategy Document',el:'supply'},{di:'DI-014',t:'Obsolescence Management Plan',el:'supply'},
        {di:'DI-015',t:'Safety Release Certificate',el:'design'}
    ],
    airforce: [
        {di:'DI-001',t:'Technical Order (TO) Package',el:'techdata'},{di:'DI-002',t:'ODIN LCMP Integration',el:'compres'},
        {di:'DI-003',t:'Aerospace Ground Equipment (AGE) List',el:'se'},{di:'DI-004',t:'Mission Capable Rate Baseline',el:'ram'},
        {di:'DI-005',t:'Reliability Centered Maintenance Plan',el:'maint'},{di:'DI-006',t:'Software Configuration Baseline',el:'config'},
        {di:'DI-007',t:'Preliminary Design Review (PDR) Data',el:'design'},{di:'DI-008',t:'Critical Design Review (CDR) Data',el:'design'},
        {di:'DI-009',t:'Cybersecurity Assessment Report',el:'compres'},{di:'DI-010',t:'Aircrew Training Device Specifications',el:'training'},
        {di:'DI-011',t:'Maintenance Training Courseware',el:'training'},{di:'DI-012',t:'Depot Source of Repair (DSOR)',el:'maint'}
    ],
    space: [
        {di:'DI-001',t:'On-Orbit Reliability Model',el:'ram'},{di:'DI-002',t:'Ground Segment Maintenance Plan',el:'maint'},
        {di:'DI-003',t:'Satellite Bus Configuration Baseline',el:'config'},{di:'DI-004',t:'Space Vehicle Integration Plan',el:'design'},
        {di:'DI-005',t:'STIG Compliance Matrix',el:'compres'},{di:'DI-006',t:'Launch Operations Logistics Plan',el:'phst'},
        {di:'DI-007',t:'Mission Crew Operations Manual',el:'training'},{di:'DI-008',t:'Constellation Availability Analysis',el:'ram'}
    ],
    coastguard: [
        {di:'DI-001',t:'CG Maintenance Plan (PMS Format)',el:'maint'},{di:'DI-002',t:'CG Technical Manual (CG Format)',el:'techdata'},
        {di:'DI-003',t:'CG Provisioning Documentation',el:'supply'},{di:'DI-004',t:'C4ISR Logistics Plan',el:'compres'},
        {di:'DI-005',t:'Cutter Training Plan',el:'training'},{di:'DI-006',t:'Vessel Safety Assessment',el:'design'},
        {di:'DI-007',t:'Environmental Compliance (MARPOL)',el:'phst'},{di:'DI-008',t:'SAR Equipment List',el:'se'}
    ],
    marines: [
        {di:'DI-001',t:'LSA Record (LSAR) — Marine Corps',el:'lsa'},{di:'DI-002',t:'MOS Training Plan',el:'training'},
        {di:'DI-003',t:'CSS Equipment Requirements',el:'se'},{di:'DI-004',t:'Amphibious Operations Logistics',el:'phst'},
        {di:'DI-005',t:'Repair Parts Block Requirements',el:'supply'},{di:'DI-006',t:'Combat Configuration Baseline',el:'config'}
    ]
};

function getExtendedDIs(progKey) {
    if (['yrbm','apl','afdm','ydt','yon'].includes(progKey)) return EXTENDED_DI.navy_pms300;
    if (['ddg51','lcs','cvn78','ffg62','lpd17'].includes(progKey)) return EXTENDED_DI.navy_pms300;
    if (['f35','f35b','ch53k'].includes(progKey)) return EXTENDED_DI.airforce;
    if (['m1','stryker','ah64','himars'].includes(progKey)) return EXTENDED_DI.army;
    if (['f35a','kc46','b21','c17'].includes(progKey)) return EXTENDED_DI.airforce;
    if (['gps3','sbirs'].includes(progKey)) return EXTENDED_DI.space;
    if (['nsc','opc','frc'].includes(progKey)) return EXTENDED_DI.coastguard;
    if (['acv'].includes(progKey)) return EXTENDED_DI.marines;
    return EXTENDED_DI.navy_pms300;
}

function loadSampleDRL() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) return;
    const statuses = ['Approved','Approved','Submitted','In Review','Overdue','Rejected','Approved','Approved','Submitted','Approved'];
    const dates = ['2025-10-15','2025-12-01','2026-01-15','2026-02-01','2026-03-15','2026-04-01','2025-11-20','2026-05-01','2026-06-15','2025-09-01'];
    // Generate primary DRL with extended DI items
    const extDIs = getExtendedDIs(progKey);
    let csv = 'CDRL Seq,DI Number,Title,ILS Element,Status,Due Date,Contractor,Approval Authority\n';
    // First include all program-specific DRL items
    prog.drls.forEach((d,i) => {
        if (Math.random() < 0.15) return; // ~15% missing for realistic gaps
        const si = (i + Math.floor(Math.random()*3)) % statuses.length;
        csv += d.s + ',' + d.di + ',"' + d.t + '",' + (d.el||'') + ',' + statuses[si] + ',' + dates[si] + ',Primary Contractor,' + prog.ofc + '\n';
    });
    // Then add extended DI items
    extDIs.forEach((d,i) => {
        if (Math.random() < 0.25) return; // ~25% missing
        const si = (i + Math.floor(Math.random()*4)) % statuses.length;
        const seq = 'B' + String(i+1).padStart(3,'0');
        csv += seq + ',' + d.di + ',"' + d.t + '",' + d.el + ',' + statuses[si] + ',' + dates[si] + ',Primary Contractor,' + prog.ofc + '\n';
    });
    // Add checklist items as status records
    const cl = getCL(progKey);
    cl.forEach(item => {
        if (Math.random() < 0.5) csv += ','+ ',"' + item.l + ' \u2014 Status Report",,Review Complete,2026-01-30,' + prog.ofc + ',\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const file = new File([blob], 'DRL_Tracker_' + progKey.toUpperCase() + '.csv', {type:'text/csv'});
    handleILSFiles([file]);
}

function loadSelectedSampleDoc(docType) {
    if (!docType) return;
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) { alert('Please select a program first.'); return; }
    document.getElementById('sampleDocSelect').selectedIndex = 0; // reset dropdown

    const statuses = ['Approved','Submitted','In Review','Overdue','Approved','Approved','Submitted','Approved'];
    const dates = ['2025-10-15','2025-12-01','2026-01-15','2026-02-01','2026-03-15','2025-11-20','2026-05-01','2025-09-01'];
    let content, filename, mime = 'text/csv';

    switch(docType) {
        case 'drl':
            loadSampleDRL(); return;
        case 'cdrl_matrix': {
            let csv = 'CDRL Seq,DI Number,Title,SOW Para,Status,Approval Date,Distribution,Copies,Format\n';
            prog.drls.forEach((d,i) => {
                csv += d.s+','+d.di+',"'+d.t+'",3.'+(i+1)+'.'+Math.ceil(Math.random()*5)+','+statuses[i%statuses.length]+','+dates[i%dates.length]+',Wide,3,Electronic\n';
            });
            content = csv; filename = 'CDRL_Matrix_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'vrs':
            content = generateVRS(progKey, prog); filename = 'VRS_'+progKey.toUpperCase()+'.csv'; break;
        case 'buylist':
            content = generateSparesBuylist(progKey, prog); filename = 'Spares_Buylist_'+progKey.toUpperCase()+'.csv'; break;
        case 'po_index':
            content = generatePOIndex(progKey, prog); filename = 'PO_Index_'+progKey.toUpperCase()+'.csv'; break;
        case 'gfm': {
            let csv = 'GFM Item,NSN,Description,Qty,Unit Cost,Total Cost,Lead Time,Status,Delivery Date\n';
            const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
            const gfmItems = comp.systems.slice(0, 8);
            gfmItems.forEach((item,i) => {
                csv += 'GFM-'+String(i+1).padStart(3,'0')+','+Math.floor(Math.random()*9e12).toString().padStart(13,'0')+',"'+item+'",'+Math.ceil(Math.random()*4)+',$'+Math.floor(50+Math.random()*500)+'K,$'+Math.floor(100+Math.random()*2000)+'K,'+Math.ceil(3+Math.random()*12)+' months,'+statuses[i%statuses.length]+','+dates[i%dates.length]+'\n';
            });
            content = csv; filename = 'GFM_List_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'hazmat': {
            let csv = 'HazMat ID,Material,MSDS Number,Location,Quantity,Unit,Storage Class,Status,Expiration\n';
            const mats = ['JP-5 Fuel','Hydraulic Fluid MIL-PRF-83282','Anti-Corrosion Compound','Cleaning Solvent PD-680','Lubricating Oil MIL-PRF-9000','Paint System MIL-PRF-24635','CLP Lubricant','Refrigerant R-134a'];
            mats.forEach((m,i) => { csv += 'HM-'+String(i+1).padStart(3,'0')+',"'+m+'",MSDS-'+String(1000+i)+',Compartment '+String.fromCharCode(65+i)+'-'+Math.ceil(Math.random()*10)+','+Math.ceil(Math.random()*200)+','+(i%2?'gal':'lb')+',Class '+(i%4+1)+',Current,2027-'+String(i+1).padStart(2,'0')+'-15\n'; });
            content = csv; filename = 'HazMat_Inventory_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'lcsp':
            content = generateLCSP(progKey, prog); filename = 'LCSP_'+progKey.toUpperCase()+'_2026.txt'; mime = 'text/plain'; break;
        case 'mrc': {
            let csv = 'MRC Number,System,Periodicity,Man-Hours,Rate,Description,Tools Required,Parts Required,Safety Precautions\n';
            const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
            const systems = comp.systems.slice(0, 10);
            const periods = ['D-1','W-2','M-4','Q-1','S-1','A-1'];
            systems.forEach((s,i) => {
                csv += 'MRC-'+periods[i%periods.length]+'-'+String(i+1).padStart(3,'0')+',"'+s+'",'+periods[i%periods.length]+','+String(0.5+Math.random()*4).substring(0,3)+',MMA,"Inspect and service '+s.toLowerCase()+'","Standard Tool Kit","Per APL",Safety tag-out required\n';
            });
            content = csv; filename = 'MRC_Index_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'mel':
            if (typeof generateMEL === 'function') { content = generateMEL(progKey, prog); }
            else { let csv = 'MEL Item,Equipment,Manufacturer,Model,Location,Weight (lbs),Power (kW),Status\n';
                const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
                const equip = comp.systems;
                equip.forEach((e,i) => { csv += 'MEL-'+String(i+1).padStart(4,'0')+',"'+e+'",'+comp.mfgs[i]+',Model-'+String(100+i)+','+(progKey.includes('f35')||progKey.includes('ah64')?'Station':'Comp')+'-'+(i+1)+','+Math.floor(500+Math.random()*5000)+','+Math.floor(5+Math.random()*200)+',Installed\n'; });
                content = csv;
            }
            filename = 'MEL_'+progKey.toUpperCase()+'.csv'; break;
        case 'pms_schedule': {
            let csv = 'PMS Task,System,Periodicity,Next Due,Last Completed,Responsible,Status\n';
            const tasks = ['Oil Analysis','Filter Replacement','Belt Inspection','Valve Overhaul','Alignment Check','Bearing Replacement','Electrical Megging','Calibration','Hull Inspection','Safety Valve Test'];
            tasks.forEach((t,i) => { csv += 'PMS-'+String(i+1).padStart(4,'0')+',"'+t+'",'+['Weekly','Monthly','Quarterly','Semi-Annual','Annual'][i%5]+',2026-'+String(i+1).padStart(2,'0')+'-15,2025-'+String(i+1).padStart(2,'0')+'-15,Ship\'s Force,'+['Current','Current','Overdue','Current','Upcoming'][i%5]+'\n'; });
            content = csv; filename = 'PMS_Schedule_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'iuid':
            content = generateIUID(progKey, prog); filename = 'IUID_Register_'+progKey.toUpperCase()+'.csv'; break;
        case 'config_baseline': {
            let csv = 'Config Item,Baseline Version,ECN Number,Status,Approval Date,Description,Impact\n';
            const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
            const items = comp.systems.slice(0, 10);
            items.forEach((item,i) => { csv += 'CI-'+String(i+1).padStart(3,'0')+',Rev '+String.fromCharCode(65+i%3)+',ECN-2026-'+String(i+1).padStart(3,'0')+','+['Approved','Pending','Approved','In Review','Approved'][i%5]+','+dates[i%dates.length]+',"'+item+' baseline configuration",'+['None','Minor','None','Moderate','None'][i%5]+'\n'; });
            content = csv; filename = 'Config_Baseline_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'weight_report': {
            let csv = 'SWBS Group,Description,Design Weight (lton),Margin (%),Growth Weight (lton),Status\n';
            const groups = [['100','Hull Structure'],['200','Propulsion'],['300','Electric Plant'],['400','Command & Surveillance'],['500','Auxiliary Systems'],['600','Outfit & Furnishings'],['700','Armament'],['F','Full Load Condition']];
            groups.forEach(g => { const w = Math.floor(50+Math.random()*500); csv += g[0]+',"'+g[1]+'",'+w+','+Math.floor(3+Math.random()*7)+','+Math.round(w*1.05)+',Within Margin\n'; });
            content = csv; filename = 'Weight_Report_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'ela': {
            let csv = 'Load ID,Equipment,Condition,Connected Load (kW),Demand Factor,Operating Load (kW),Voltage,Phase\n';
            const conds = ['Normal Cruising','Battle/Emergency','In Port','Anchor'];
            const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
            const loads = comp.systems.slice(0, 10);
            loads.forEach((l,i) => { csv += 'EL-'+String(i+1).padStart(3,'0')+',"'+l+'",'+conds[i%conds.length]+','+Math.floor(10+Math.random()*200)+',0.'+Math.floor(60+Math.random()*35)+','+Math.floor(8+Math.random()*150)+',440,3\n'; });
            content = csv; filename = 'ELA_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'temp': {
            let txt = 'TEST AND EVALUATION MASTER PLAN (TEMP)\n' + '='.repeat(50) + '\n\n';
            txt += 'Program: '+prog.name+'\nOffice: '+prog.ofc+'\nClassification: UNCLASSIFIED\n\n';
            txt += '1.0 INTRODUCTION\nThis TEMP establishes the T&E strategy for '+prog.name+'.\n\n';
            txt += '2.0 TEST OBJECTIVES\n  2.1 Developmental Testing (DT)\n  2.2 Operational Testing (OT)\n  2.3 Live Fire Test & Evaluation (LFT&E)\n\n';
            txt += '3.0 TEST SCHEDULE\n  Phase 1: Factory Acceptance Test (FAT) — Month 18\n  Phase 2: Dock Trials — Month 24\n  Phase 3: Sea Trials — Month 26\n  Phase 4: Operational Evaluation — Month 30\n\n';
            txt += '4.0 CRITICAL OPERATIONAL ISSUES (COIs)\n  COI-1: Can the system achieve required operational availability (Ao >= 0.85)?\n  COI-2: Is the system suitable for its intended operational environment?\n  COI-3: Can the crew effectively maintain the system?\n\n';
            txt += '5.0 RESOURCE REQUIREMENTS\n  Test facilities, instrumentation, target services, and support personnel.\n\n';
            txt += 'Prepared per DoWI 5000.89\n';
            content = txt; filename = 'TEMP_'+progKey.toUpperCase()+'.txt'; mime = 'text/plain'; break;
        }
        case 'icd': {
            let txt = 'INTERFACE CONTROL DOCUMENT (ICD)\n' + '='.repeat(50) + '\n\n';
            txt += 'Program: '+prog.name+'\nDocument: ICD-'+progKey.toUpperCase()+'-001\nRevision: A\n\n';
            txt += '1.0 SCOPE\nThis ICD defines all system interfaces for '+prog.name+'.\n\n';
            txt += '2.0 MECHANICAL INTERFACES\n  2.1 Equipment Foundations — Per MIL-STD-167\n  2.2 Piping Connections — Per MIL-STD-777\n  2.3 Structural Attachments\n\n';
            txt += '3.0 ELECTRICAL INTERFACES\n  3.1 Power — 440V/60Hz 3-Phase\n  3.2 Signal — MIL-STD-1553B Data Bus\n  3.3 Fiber Optic — Per MIL-STD-2042\n\n';
            txt += '4.0 DATA INTERFACES\n  4.1 Protocols: TCP/IP, NMEA 2000\n  4.2 Data Rates: 100 Mbps minimum\n  4.3 Cybersecurity: Per NIST 800-171\n\n';
            content = txt; filename = 'ICD_'+progKey.toUpperCase()+'.txt'; mime = 'text/plain'; break;
        }
        case 'training_plan': {
            let txt = 'NAVY TRAINING SYSTEM PLAN (NTSP)\n' + '='.repeat(50) + '\n\n';
            txt += 'Program: '+prog.name+'\nOffice: '+prog.ofc+'\n\n';
            txt += '1.0 TRAINING CONCEPT\n  Blended approach: classroom, OJT, simulation, CBT\n\n';
            txt += '2.0 COURSES\n  2.1 Operator Course — 4 weeks (NEC: '+String(4000+Math.floor(Math.random()*999))+')\n  2.2 Maintenance Course — 6 weeks (NEC: '+String(4000+Math.floor(Math.random()*999))+')\n  2.3 Supervisor Course — 2 weeks\n\n';
            txt += '3.0 TRAINING EQUIPMENT\n  3.1 Part Task Trainer (PTT)\n  3.2 Full Mission Simulator\n  3.3 Computer-Based Training (CBT) modules\n\n';
            txt += '4.0 MILESTONES\n  Course curriculum approval: Month 12\n  First class convene: Month 20\n  Training complete: Month 24\n';
            content = txt; filename = 'Training_Plan_'+progKey.toUpperCase()+'.txt'; mime = 'text/plain'; break;
        }
        case 'manpower': {
            let csv = 'Billet,Rate/Rating,NEC,Quantity,Watch Section,Dept,Remarks\n';
            const billets = [['Commanding Officer','O-4','0000',1,'—','CO',''],['Executive Officer','O-3','0000',1,'—','XO',''],['Chief Engineer','CWO-3','7412',1,'—','ENG',''],['Engineman','EN2','4233',4,'1/2/3/4','ENG','PMS Qualified'],['Electrician','EM2','4671',2,'1/2','ENG',''],['Boatswain','BM1','0000',2,'1/2','DECK',''],['Damage Controlman','DC2','4954',2,'1/2','ENG',''],['Operations Specialist','OS2','0000',2,'1/2','OPS',''],['Culinary Specialist','CS2','3531',2,'1/2','ADMIN',''],['Hospital Corpsman','HM3','0000',1,'—','ADMIN','']];
            billets.forEach(b => { csv += '"'+b[0]+'",'+b[1]+','+b[2]+','+b[3]+','+b[4]+','+b[5]+','+b[6]+'\n'; });
            content = csv; filename = 'Manpower_Estimate_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'sow_matrix': {
            let csv = 'SOW Para,Title,Compliance Status,Deliverable,CDRL Ref,Remarks\n';
            const paras = ['3.1 Systems Engineering','3.2 Design & Development','3.3 Test & Evaluation','3.4 ILS Planning','3.5 Configuration Management','3.6 Quality Assurance','3.7 Safety Engineering','3.8 Cybersecurity','3.9 Environmental Compliance','3.10 Program Management'];
            paras.forEach((p,i) => { csv += '"'+p+'",'+['Compliant','Compliant','Partial','Compliant','Non-Compliant','Compliant','Partial','Compliant','Compliant','Compliant'][i]+','+(i<8?'A'+String(i+1).padStart(3,'0'):'—')+','+(i<8?'CDRL-'+String(i+1).padStart(3,'0'):'N/A')+',\n'; });
            content = csv; filename = 'SOW_Matrix_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'ims': {
            let csv = 'WBS,Task,Start,Finish,Duration (months),Predecessor,Status,% Complete\n';
            const tasks = ['1.0 Program Management','1.1 Kick-off Meeting','2.0 Design Phase','2.1 Preliminary Design Review','2.2 Critical Design Review','3.0 Construction','3.1 Fabrication','3.2 Assembly','4.0 Test & Delivery','4.1 Sea Trials'];
            tasks.forEach((t,i) => {
                const start = new Date(2025,i*2,1), end = new Date(2025,i*2+3,1);
                csv += '"'+t+'",'+start.toISOString().split('T')[0]+','+end.toISOString().split('T')[0]+','+Math.ceil(2+Math.random()*4)+','+(i>0?tasks[i-1].split(' ')[0]:'')+','+['Complete','Complete','In Progress','Upcoming','Upcoming','Upcoming','Upcoming','Upcoming','Upcoming','Upcoming'][i]+','+[100,100,65,20,0,0,0,0,0,0][i]+'\n';
            });
            content = csv; filename = 'IMS_'+progKey.toUpperCase()+'.csv'; break;
        }
        case 'risk_register': {
            let csv = 'Risk ID,Category,Description,Probability,Impact,Risk Score,Mitigation,Owner,Status\n';
            const risks = [
                ['R-001','Schedule','GFM delivery delay','Medium','High','12','Expedite procurement; identify alternates',prog.ofc],
                ['R-002','Technical','Weight growth exceeds margin','Low','High','8','Monthly weight tracking; design reviews','Engineering'],
                ['R-003','Cost','Material cost escalation','Medium','Medium','9','Fixed-price subcontracts; hedging','Contracts'],
                ['R-004','Supply','Long lead time items','High','Medium','12','Early procurement; buffer stock','Supply'],
                ['R-005','Technical','Cyber vulnerability in COTS','Medium','High','12','Pen testing; STIG compliance','Cybersecurity'],
                ['R-006','Schedule','Test facility availability','Low','Medium','6','Reserve slots early; backup sites','T&E'],
                ['R-007','Manpower','Skilled labor shortage','Medium','Medium','9','Cross-training; retention bonuses','HR'],
                ['R-008','Compliance','Environmental regulation change','Low','Low','4','Monitor regulatory updates','Environmental']
            ];
            risks.forEach(r => { csv += r.join(',')+',Open\n'; });
            content = csv; filename = 'Risk_Register_'+progKey.toUpperCase()+'.csv'; break;
        }
        default: return;
    }
    const file = new File([new Blob([content],{type:mime})], filename, {type:mime});
    handleILSFiles([file]);
}

function loadSamplePackage() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) return;
    // Clear existing files
    ilsFiles = [];
    document.getElementById('ilsFileList').innerHTML = '';

    // 1. Main DRL Tracker (CSV)
    loadSampleDRL();

    // 2. Life Cycle Sustainment Plan (LCSP) — text content simulating a Word doc
    const lcsp = generateLCSP(progKey, prog);
    handleILSFiles([new File([new Blob([lcsp],{type:'text/plain'})], 'LCSP_' + progKey.toUpperCase() + '_2026.txt', {type:'text/plain'})]);

    // 3. IUID Register (CSV)
    const iuid = generateIUID(progKey, prog);
    handleILSFiles([new File([new Blob([iuid],{type:'text/csv'})], 'IUID_Register_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 4. Vendor Recommended Spares (CSV)
    const vrs = generateVRS(progKey, prog);
    handleILSFiles([new File([new Blob([vrs],{type:'text/csv'})], 'VRS_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 5. Spares Buylist / Initial Outfitting (CSV)
    const buylist = generateSparesBuylist(progKey, prog);
    handleILSFiles([new File([new Blob([buylist],{type:'text/csv'})], 'Spares_Buylist_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 6. Purchase Order Index (CSV)
    const poi = generatePOIndex(progKey, prog);
    handleILSFiles([new File([new Blob([poi],{type:'text/csv'})], 'PO_Index_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 7. MEL / Equipment List (CSV) — for Navy/CG programs
    if (['yrbm','apl','afdm','ydt','yon','ddg51','lcs','cvn78','ffg62','lpd17','nsc','opc','frc'].includes(progKey)) {
        const mel = generateMEL(progKey, prog);
        handleILSFiles([new File([new Blob([mel],{type:'text/csv'})], 'MEL_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);
    }

    // 8. Maintenance Requirement Card Index (CSV) — for Navy
    if (['yrbm','apl','afdm','ydt','yon','ddg51','lcs','cvn78','ffg62','lpd17','nsc','opc','frc'].includes(progKey)) {
        const mrc = generateMRCIndex(progKey, prog);
        handleILSFiles([new File([new Blob([mrc],{type:'text/csv'})], 'MRC_Index_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);
    }
}

function generateLCSP(progKey, prog) {
    const hull = document.getElementById('ilsHull')?.value || progKey.toUpperCase();
    return [
        '═══════════════════════════════════════════════════════════════════',
        '  LIFE CYCLE SUSTAINMENT PLAN (LCSP)',
        '  DI-ILSS-81490 / DI-039',
        '═══════════════════════════════════════════════════════════════════',
        '',
        'Program:         ' + prog.name,
        'Hull/Desig:      ' + hull,
        'Program Office:  ' + prog.ofc,
        'Platform Type:   ' + prog.type,
        'Document Rev:    Rev B (Draft)',
        'Date:            ' + new Date().toISOString().split('T')[0],
        'Classification:  UNCLASSIFIED',
        '',
        '───────────────────────────────────────────────────────────────────',
        '1.0 PURPOSE',
        '  This Life Cycle Sustainment Plan establishes the strategy for',
        '  integrated logistics support of the ' + prog.name + ' program',
        '  throughout its projected 30-year service life.',
        '',
        '2.0 ILS ELEMENTS ADDRESSED',
        '  2.1 Maintenance Planning (PMS/MRC Development)',
        '  2.2 Supply Support (Provisioning, APL, COSAL)',
        '  2.3 Technical Data (Tech Manuals, IETMs)',
        '  2.4 Training & Training Support',
        '  2.5 Support Equipment',
        '  2.6 Manpower & Personnel',
        '  2.7 Computer Resources / Mission Systems',
        '  2.8 Facilities',
        '  2.9 PHS&T',
        '  2.10 Design Interface',
        '',
        '3.0 SUSTAINMENT STRATEGY',
        '  3.1 Organic Maintenance: ' + (prog.ofc.includes('PMS')?'NAVSEA / Regional Maintenance Centers':'Service Depot-Level'),
        '  3.2 Contractor Maintenance: Post-Delivery Availability (PDA)',
        '  3.3 Spares Strategy: DLA/NAVSUP with contractor initial provisioning',
        '  3.4 Obsolescence: Proactive DMSMS monitoring program',
        '',
        '4.0 PERFORMANCE METRICS',
        '  • Ao (Operational Availability): ≥ 0.85',
        '  • MTBF target: Per RAM analysis (DI-034)',
        '  • MTTR target: Per Maintainability Analysis (DI-035)',
        '  • Fill Rate (supply support): ≥ 90%',
        '',
        '5.0 CONFIGURATION MANAGEMENT',
        '  Baseline managed per DI-029 / DI-030 (CSA & ECP)',
        '  IUID tracking per DI-031',
        '',
        '───────────────────────────────────────────────────────────────────',
        '  LCSP generated by S4 Ledger ILS Workspace Engine',
        '  s4ledger.com — Immutable logistics verification',
        '═══════════════════════════════════════════════════════════════════'
    ].join('\n');
}

function generateIUID(progKey, prog) {
    const parts = ['Main Engine Assembly','Generator Set #1','Generator Set #2','Fire Pump','HVAC Unit','Steering Gear','Anchor Windlass','Crane Assembly','Radar System','Navigation Console','Comm Suite','Electrical Switchboard','Hydraulic Power Unit','Fuel Transfer Pump','Freshwater Distiller','Sewage Treatment Plant','Capstan','Life Raft Cradle','Shore Power Connection','Battery Charger'];
    const nsns = ['2815-01-234-5678','6115-01-345-6789','6115-01-345-6790','4210-01-456-7890','4120-01-567-8901','2540-01-678-9012','3950-01-789-0123','3810-01-890-1234','5820-01-901-2345','6605-01-012-3456'];
    let csv = 'IUID UII,NSN,Nomenclature,Manufacturer,Part Number,Serial Number,Acquisition Cost,Install Location,Status\n';
    parts.forEach((p,i) => {
        const uii = 'D' + String(Math.floor(100000+Math.random()*900000)) + 'S4' + String(i+1).padStart(4,'0');
        const nsn_i = nsns[i % nsns.length];
        const mfg = ['Cummins','Caterpillar','Honeywell','Raytheon','L3Harris','GE Marine','Rolls-Royce','BAE Systems','Northrop Grumman','Eaton'][i%10];
        csv += uii + ',' + nsn_i + ',"' + p + '",' + mfg + ',PN-' + (1000+i) + '-' + String(Math.floor(Math.random()*9999)).padStart(4,'0') + ',SN-' + String(Math.floor(100000+Math.random()*900000)) + ',$' + (5000+Math.floor(Math.random()*195000)).toLocaleString() + ',' + ['Engine Room','Bridge','Deck','Auxiliary','CIC','Berthing'][i%6] + ',' + ['Installed','Installed','In Transit','Installed','Warehouse','Installed','Installed','QA Hold','Installed','Installed'][i%10] + '\n';
    });
    return csv;
}

function generateVRS(progKey, prog) {
    const items = ['Fuel Filter Element','Oil Filter','V-Belt Set','Seal Kit (Hydraulic)','Gasket Set','Bearing Assembly','Impeller (Pump)','Relay (24VDC)','Circuit Breaker (60A)','O-Ring Kit','Thermostat Assembly','Zinc Anode Set','Coupling (Flexible)','Pressure Gauge (0-300psi)','Sight Glass','Solenoid Valve','Check Valve (1.5in)','Expansion Valve','Temperature Sensor','Control Board (HVAC)'];
    let csv = 'VRS Line,NSN,Nomenclature,Part Number,Qty Rec,Unit Price,Lead Time (wks),Vendor,Criticality\n';
    items.forEach((item,i) => {
        const crit = i < 6 ? 'Critical' : i < 14 ? 'Essential' : 'Desirable';
        csv += 'VRS-' + String(i+1).padStart(3,'0') + ',5330-01-' + String(Math.floor(100+Math.random()*900)) + '-' + String(Math.floor(1000+Math.random()*9000)) + ',"' + item + '",PN-' + (2000+i) + ',' + (1+Math.floor(Math.random()*10)) + ',$' + (15+Math.floor(Math.random()*2500)).toLocaleString() + ',' + (4+Math.floor(Math.random()*20)) + ',' + ['Parker Hannifin','Donaldson','Gates','SKF','Garlock','Timken','Flowserve','TE Connectivity','Eaton','Dana'][i%10] + ',' + crit + '\n';
    });
    return csv;
}

function generateSparesBuylist(progKey, prog) {
    let csv = 'Line,APL Number,NSN,Nomenclature,Qty Auth,Qty On Hand,Qty On Order,Unit Cost,Allowance Type,Notes\n';
    const items = ['Packing Set','Bearing Ball','Connector Plug','Lamp Indicator','Fuse Cartridge','Hose Assembly','Valve Globe','Strainer Intake','Switch Toggle','Resistor Fixed','Capacitor Fixed','Transformer','Motor Starter','Contactor','Cable Assembly','Pipe Fitting','Bolt Set (SS)','Spring Compression','Diaphragm','Sensor Assembly'];
    items.forEach((item,i) => {
        csv += 'SB-' + String(i+1).padStart(3,'0') + ',APL-' + progKey.toUpperCase() + '-' + String(i+1).padStart(3,'0') + ',5330-01-' + String(Math.floor(100+Math.random()*900)) + '-' + String(Math.floor(1000+Math.random()*9000)) + ',"' + item + '",' + (2+Math.floor(Math.random()*8)) + ',' + Math.floor(Math.random()*5) + ',' + Math.floor(Math.random()*3) + ',$' + (8+Math.floor(Math.random()*800)).toLocaleString() + ',' + ['COSAL','AVCAL','SHORCAL','COSAL'][i%4] + ',' + (i<5?'Flight Critical':'') + '\n';
    });
    return csv;
}

function generatePOIndex(progKey, prog) {
    let csv = 'PO Number,Vendor,Description,Value,Status,Ship Date,Contract Ref\n';
    const vendors = ['Huntington Ingalls Industries','BAE Systems Ship Repair','General Dynamics NASSCO','Cummins Marine','L3Harris','Raytheon','Rolls-Royce Naval','Northrop Grumman','Leonardo DRS','Leidos'];
    const descs = ['Main Engine Spare Parts','Generator Overhaul Kit','Navigation Radar Upgrade','Comm System Installation','Deck Machinery Spares','HVAC System Components','Electrical Distribution Panel','Fire Suppression System','Anchor Chain & Fittings','Hull Coating Materials','Paint & Preservation','Safety Equipment Package','Crane Wire Rope','Shore Power Transformer','Sewage System Parts'];
    for (let i = 0; i < 15; i++) {
        const poNum = 'N00024-26-C-' + String(4000+i).padStart(4,'0');
        csv += poNum + ',' + vendors[i%10] + ',"' + descs[i] + '",$' + (25000+Math.floor(Math.random()*475000)).toLocaleString() + ',' + ['Awarded','In Progress','Delivered','In Progress','Awarded','Delivered','Pending','In Progress','Delivered','Awarded','In Progress','Delivered','Pending','Awarded','In Progress'][i] + ',' + [2026,2026,2025,2026,2026,2025,2026,2026,2025,2026,2026,2025,2026,2026,2025][i] + '-' + String(1+Math.floor(Math.random()*12)).padStart(2,'0') + '-15,' + 'N00024-25-D-' + String(Math.floor(1000+Math.random()*9000)) + '\n';
    }
    return csv;
}

function generateMEL(progKey, prog) {
    let csv = 'MEL Item,System,Equipment,Manufacturer,Model,Location,Weight (lbs),Power (kW),Status\n';
    const equip = [
        ['Propulsion','Main Diesel Engine','Cummins','KTA50-M2','Engine Room'],
        ['Propulsion','Reduction Gear','Reintjes','WAF 564','Engine Room'],
        ['Electrical','Ship Service Generator','Caterpillar','C9.3 Marine','Gen Room'],
        ['Electrical','Emergency Generator','John Deere','4045TFM85','Emerg Gen Room'],
        ['Auxiliary','Fire Pump','Aurora','481-BF','Pump Room'],
        ['Auxiliary','Bilge Pump','IMO','ACE 032','Bilge Well'],
        ['HVAC','AC Plant','Carrier','30HX','Machine Shop'],
        ['Navigation','Radar (Surface Search)','Furuno','FAR-2228','Bridge'],
        ['Navigation','GPS Receiver','Furuno','GP-170','Bridge'],
        ['Communication','VHF Radio','ICOM','IC-M510','Bridge'],
        ['Communication','SATCOM Terminal','KVH','V7-HTS','Mast Top'],
        ['Deck Machinery','Anchor Windlass','Burrard','AW-120','Fwd Deck'],
        ['Deck Machinery','Capstan','Rotzler','TR 100','Aft Deck'],
        ['Safety','Life Raft (25-person)','Viking','25DK+','Boat Deck'],
        ['Crane','Mobile Crane','Palfinger','PK 40002','Main Deck']
    ];
    equip.forEach((e,i) => {
        csv += 'MEL-' + String(i+1).padStart(3,'0') + ',' + e[0] + ',"' + e[1] + '",' + e[2] + ',' + e[3] + ',' + e[4] + ',' + (200+Math.floor(Math.random()*15000)) + ',' + (1+Math.floor(Math.random()*800)) + ',' + ['Installed','Installed','On Order','Installed','Installed','QA Hold','Installed','Installed','Installed','Installed','In Transit','Installed','Installed','Installed','On Order'][i] + '\n';
    });
    return csv;
}

function generateMRCIndex(progKey, prog) {
    let csv = 'MRC Number,Periodicity,System,Description,Skill Rate,Est Hours,Critical\n';
    const mrcs = [
        ['MRC-DE-001','W','Main Engine','Lube Oil Level Check','EN2',0.5,'No'],
        ['MRC-DE-002','M','Main Engine','Fuel Filter Inspection',  'EN1',1.0,'Yes'],
        ['MRC-DE-003','Q','Main Engine','Injector Timing Check','EN1',4.0,'Yes'],
        ['MRC-EL-001','W','Electrical','Generator Load Test','EM2',1.0,'Yes'],
        ['MRC-EL-002','M','Electrical','Battery Electrolyte Check','EM3',0.5,'No'],
        ['MRC-AX-001','M','Auxiliary','Fire Pump Performance Test','DC2',2.0,'Yes'],
        ['MRC-AX-002','Q','Auxiliary','HVAC Refrigerant Check','MM2',1.5,'No'],
        ['MRC-HU-001','SA','Hull','Cathodic Protection Inspection','HT2',3.0,'Yes'],
        ['MRC-HU-002','A','Hull','Topside Paint Condition Survey','BM2',4.0,'No'],
        ['MRC-NK-001','M','Navigation','Radar Performance Check','ET2',1.0,'Yes'],
        ['MRC-NK-002','Q','Navigation','Compass Deviation Check','QM1',2.0,'No'],
        ['MRC-DK-001','W','Deck','Wire Rope Inspection','BM2',1.0,'Yes'],
        ['MRC-DK-002','M','Deck','Crane Load Test','BM1',4.0,'Yes'],
        ['MRC-SF-001','M','Safety','Life Raft Hydrostatic Release','DC3',0.5,'Yes'],
        ['MRC-SF-002','Q','Safety','Fire Extinguisher Inspection','DC3',1.0,'Yes']
    ];
    mrcs.forEach(m => { csv += m.join(',') + '\n'; });
    return csv;
}

// ── File Upload Handling ──
function setupILSDropzone() {
    const dz = document.getElementById('ilsDropzone');
    if (!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); }));
    dz.addEventListener('drop', e => handleILSFiles(e.dataTransfer.files));
}

function handleILSFiles(fileList) {
    Array.from(fileList).forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        if (!['csv','xlsx','xls','txt','tsv'].includes(ext)) { alert('Unsupported file type: .' + ext); return; }
        const reader = new FileReader();
        if (ext === 'xlsx' || ext === 'xls') {
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const parsed = parseExcelContent(data);
                const records = extractRecords(parsed);
                addILSFile(file.name, file.size, records, parsed.rows.length);
            };
            reader.readAsArrayBuffer(file);
        } else {
            reader.onload = e => {
                const text = e.target.result;
                const parsed = (ext === 'csv' || ext === 'tsv') ? parseCSVContent(text) : parseTextContent(text);
                const records = extractRecords(parsed);
                addILSFile(file.name, file.size, records, parsed.rows.length);
            };
            reader.readAsText(file);
        }
    });
}

function addILSFile(name, size, records, totalRows) {
    ilsFiles.push({ id: 'f_' + Date.now() + '_' + Math.random().toString(36).substr(2,4), name, size, records, totalRows });
    renderFileList();
    updateChecklistFromUploads();
}

function removeILSFile(id) {
    ilsFiles = ilsFiles.filter(f => f.id !== id);
    renderFileList();
    updateChecklistFromUploads();
}

function renderFileList() {
    const list = document.getElementById('ilsFileList');
    if (!list) return;
    if (!ilsFiles.length) { list.innerHTML = ''; return; }
    list.innerHTML = ilsFiles.map(f => {
        const sz = f.size > 1048576 ? (f.size/1048576).toFixed(1)+'MB' : (f.size/1024).toFixed(0)+'KB';
        const icon = /\.xlsx?$/i.test(f.name) ? 'fa-file-excel' : /\.csv$/i.test(f.name) ? 'fa-file-csv' : 'fa-file-alt';
        return '<div class="ils-file-item"><div class="file-info"><i class="fas '+icon+'" style="color:var(--accent);margin-right:8px"></i>'
            + '<span style="font-weight:600;color:#fff">'+f.name+'</span></div>'
            + '<div class="file-stats">'+f.records.length+' DRL items detected from '+f.totalRows+' rows \u00b7 '+sz+'</div>'
            + '<button class="file-remove" onclick="removeILSFile(\''+f.id+'\')">\u00d7</button></div>';
    }).join('');
}

// ── Parsers ──
function parseCSVContent(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) return { headers: [], rows: [] };
    const delim = (lines[0].match(/\t/g)||[]).length > (lines[0].match(/,/g)||[]).length ? '\t' : ',';
    function splitRow(line) {
        const res = []; let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') { inQ = !inQ; }
            else if (ch === delim.charAt(0) && !inQ) { res.push(cur.trim()); cur = ''; }
            else { cur += ch; }
        }
        res.push(cur.trim());
        return res;
    }
    const headers = splitRow(lines[0]);
    const rows = lines.slice(1).map(l => {
        const cells = splitRow(l);
        return headers.reduce((o,h,i) => { o[h] = cells[i]||''; return o; }, {});
    }).filter(r => Object.values(r).some(v => v));
    return { headers, rows };
}

function parseExcelContent(data) {
    if (typeof XLSX === 'undefined') { alert('Excel parser not loaded. Please wait and try again.'); return { headers:[], rows:[] }; }
    try {
        const wb = XLSX.read(data, { type:'array' });
        let sheetName = wb.SheetNames.find(n => /drl|cdrl|ils|deliverable/i.test(n)) || wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const raw = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
        if (raw.length < 2) return { headers:[], rows:[] };
        let hIdx = 0;
        for (let i = 0; i < Math.min(raw.length, 10); i++) {
            if (raw[i].filter(c => String(c).trim()).length >= 3) { hIdx = i; break; }
        }
        const headers = raw[hIdx].map(h => String(h).trim());
        const rows = raw.slice(hIdx+1).filter(r => r.some(c => String(c).trim())).map(r =>
            headers.reduce((o,h,i) => { o[h] = String(r[i]||'').trim(); return o; }, {})
        );
        return { headers, rows };
    } catch(e) { console.error('Excel parse error:', e); return { headers:[], rows:[] }; }
}

function parseTextContent(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const diPat = /DI-[A-Z]{4}-\d{5}/g;
    const records = [];
    lines.forEach(line => {
        const m = line.match(diPat);
        if (m) m.forEach(di => records.push({ 'DI': di, 'Title': line.trim().substring(0,120) }));
    });
    return { headers: ['DI','Title'], rows: records };
}

// ── Column Detection & Record Extraction ──
function detectColumns(headers) {
    const lh = headers.map(h => h.toLowerCase().replace(/[^a-z0-9\s]/g,''));
    return {
        seq: lh.findIndex(h => /cdrl|seq|line\s*item|exhibit|item\s*no/.test(h)),
        di: lh.findIndex(h => /\bdi\b|did\b|data\s*item/.test(h)),
        title: lh.findIndex(h => /title|description|name|data\s*product/.test(h)),
        status: lh.findIndex(h => /status|state|deliverable\s*status|approval/.test(h)),
        due: lh.findIndex(h => /due|date|deadline|submit|required\s*date/.test(h)),
        contractor: lh.findIndex(h => /contractor|vendor|supplier/.test(h))
    };
}

function extractRecords(parsed) {
    if (!parsed.rows.length) return [];
    const cols = detectColumns(parsed.headers);
    const records = [];
    parsed.rows.forEach(row => {
        let seq = '', di = '', title = '', status = '', due = '';
        if (cols.seq >= 0) seq = row[parsed.headers[cols.seq]] || '';
        if (cols.di >= 0) di = row[parsed.headers[cols.di]] || '';
        if (cols.title >= 0) title = row[parsed.headers[cols.title]] || '';
        if (cols.status >= 0) status = row[parsed.headers[cols.status]] || '';
        if (cols.due >= 0) due = row[parsed.headers[cols.due]] || '';
        if (!di) { Object.values(row).forEach(v => { const m = String(v).match(/DI-[A-Z]{4}-\d{5}/); if (m && !di) di = m[0]; }); }
        if (!title) { title = Object.values(row).reduce((best,v) => { const s = String(v); return (s.length > best.length && !/^DI-/.test(s) && !/^[A-C]\d{3}$/.test(s)) ? s : best; }, ''); }
        const element = di ? (DI_MAP[di] || guessElement(title)) : guessElement(title);
        if (di || (title && title.length > 3)) records.push({ seq, di, title, status: status.toLowerCase(), due, element });
    });
    return records;
}

function guessElement(t) {
    t = t.toLowerCase();
    if (/ils\s*p|logistics\s*support\s*plan|program\s*mgmt|program\s*management/.test(t)) return 'ilsmgmt';
    if (/maintenance|pms\b|mrc\b|mip\b|planned\s*maint/.test(t)) return 'maint';
    if (/supply|spare|provisioning|buylist|allowance|apl\b|cosal/.test(t)) return 'supply';
    if (/support\s*equip|se\b|tools|test\s*equip/.test(t)) return 'se';
    if (/technical\s*(manual|data|pub|order)|tm\b|ietm|tech\s*data/.test(t)) return 'techdata';
    if (/training|trainer|course|curriculum|school|net\b.*plan/.test(t)) return 'training';
    if (/manpower|personnel|manning|billet|manprint/.test(t)) return 'manpower';
    if (/computer|software|cyber|alis|odin/.test(t)) return 'compres';
    if (/facilit|shore\s*infra/.test(t)) return 'facilities';
    if (/phs.?t|packaging|handling|storage|transport|hazmat/.test(t)) return 'phst';
    if (/design\s*interface|interface\s*doc/.test(t)) return 'design';
    if (/ram\b|reliab|avail|maintain|fmeca|fracas|failure/.test(t)) return 'ram';
    if (/config|baseline|ecp|engineering\s*change/.test(t)) return 'config';
    if (/lsa\b|logistics\s*support\s*analy|mac\b|rpstl/.test(t)) return 'lsa';
    return '';
}

function fuzzyMatch(a, b) {
    const wa = a.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(w => w.length > 3);
    const wb = b.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(w => w.length > 3);
    if (!wa.length || !wb.length) return false;
    return wa.filter(w => wb.includes(w)).length >= Math.min(2, Math.ceil(wb.length * 0.4));
}

// ── Checklist & Program Handlers ──
function initILSChecklist(progKey) {
    const container = document.getElementById('ilsChecklist');
    if (!container) return;
    const cl = getCL(progKey || document.getElementById('ilsProgram').value);
    container.innerHTML = cl.map(el =>
        '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 6px;border-radius:6px;transition:background 0.2s;'+(el.c?'font-weight:600':'')+'" onmouseover="this.style.background=\'rgba(0,170,255,0.05)\'" onmouseout="this.style.background=\'transparent\'">'
        + '<input type="checkbox" id="ils_'+el.id+'" style="width:auto!important;accent-color:var(--accent)">'
        + '<span>' + el.l + (el.c?' <span style="color:var(--red);font-size:0.7rem">CRITICAL</span>':'') + '</span></label>'
    ).join('');
}

function updateChecklistFromUploads() {
    const progKey = document.getElementById('ilsProgram').value;
    const cl = getCL(progKey);
    const allText = [];
    ilsFiles.forEach(f => f.records.forEach(r => { if (r.title) allText.push(r.title); if (r.di) allText.push(r.di); }));
    const joined = allText.join(' ');
    cl.forEach(item => {
        const cb = document.getElementById('ils_' + item.id);
        if (cb && item.kw.test(joined)) cb.checked = true;
    });
}

function onILSProgramChange() {
    const key = document.getElementById('ilsProgram').value;
    const prog = PROGS[key];
    if (!prog) return;
    const ofc = document.getElementById('ilsOffice');
    if (ofc) ofc.value = prog.ofc;
    // Rebuild checklist for this program
    initILSChecklist(key);
    // Re-apply auto-detection from any uploaded files
    updateChecklistFromUploads();
    // Reset results since program changed
    ilsResults = null;
    document.getElementById('ilsScore').textContent = '--';
    document.getElementById('ilsScore').style.color = 'var(--muted)';
    document.getElementById('ilsScoreLabel').textContent = 'Upload documents & run analysis';
    document.getElementById('ilsGaugeFill').style.width = '0%';
    document.getElementById('ilsCoverage').innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem">Upload files to see checklist coverage.</div>';
    document.getElementById('ilsActions').innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.85rem">Run analysis to generate action items.</div>';
    document.getElementById('ilsCostSchedule').innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem">Analysis required to estimate impact.</div>';
    const r = document.getElementById('ilsResult'); r.innerHTML=''; r.classList.remove('show');
}

// ── Analysis Engine ──
function runFullILSAnalysis() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) { alert('Please select a program.'); return; }
    const hull = document.getElementById('ilsHull')?.value || '';
    const phase = document.getElementById('ilsPhase')?.value || 'design';
    const cl = getCL(progKey);

    // 1. Checklist scoring
    const clItems = cl.map(item => {
        const cb = document.getElementById('ils_' + item.id);
        return { ...item, checked: cb ? cb.checked : false };
    });
    const clChecked = clItems.filter(i => i.checked);
    const clUnchecked = clItems.filter(i => !i.checked);
    const clCritMissing = clUnchecked.filter(i => i.c);
    const clMax = clItems.reduce((s,i) => s + (i.c ? 2 : 1), 0);
    const clScore = clChecked.reduce((s,i) => s + (i.c ? 2 : 1), 0);
    const clPct = clMax > 0 ? Math.round((clScore / clMax) * 100) : 0;

    // 2. DRL gap analysis
    const allRecs = [];
    ilsFiles.forEach(f => allRecs.push(...f.records));
    const drlResults = prog.drls.map(d => {
        const match = allRecs.find(r =>
            (r.di && r.di === d.di) ||
            (r.seq && r.seq === d.s) ||
            (r.title && fuzzyMatch(r.title, d.t))
        );
        return { ...d, found: !!match, status: match ? (match.status || 'detected') : 'missing', due: match?.due || '' };
    });
    const drlFound = drlResults.filter(d => d.found).length;
    const drlTotal = drlResults.length;
    const drlPct = drlTotal > 0 ? Math.round((drlFound / drlTotal) * 100) : 0;

    // 3. Combined score (weighted: 60% checklist, 40% DRL)
    const hasDrls = ilsFiles.length > 0;
    const pct = hasDrls ? Math.round(clPct * 0.6 + drlPct * 0.4) : clPct;

    // 4. Action items
    const actions = [];
    let gapN = 1;
    // From checklist gaps
    clCritMissing.forEach(item => {
        actions.push({
            id: 'CL-' + String(gapN++).padStart(3,'0'), severity: 'critical', source: 'checklist',
            title: item.l, action: 'Complete and verify: ' + item.l,
            owner: prog.ofc + ' / Contractor', secondary: '',
            cost: 40, schedule: '1-3 months'
        });
    });
    // From DRL gaps
    drlResults.filter(d => !d.found && d.c).forEach(d => {
        const ow = OWNERS[d.el] || {p:'TBD',s:''};
        actions.push({
            id: 'DRL-' + String(gapN++).padStart(3,'0'), severity: 'critical', source: 'drl',
            title: d.di + ' \u2014 ' + d.t, action: 'Request submission of ' + d.di,
            owner: ow.p, secondary: ow.s,
            cost: COST_K[d.el] || 50, schedule: '2-4 months'
        });
    });
    drlResults.filter(d => d.found && /overdue|late|reject|disapprov/.test(d.status)).forEach(d => {
        const ow = OWNERS[d.el] || {p:'TBD',s:''};
        actions.push({
            id: 'ACT-' + String(gapN++).padStart(3,'0'), severity: 'warning', source: 'drl',
            title: d.di + ' \u2014 ' + d.t + ' (' + d.status.toUpperCase() + ')',
            action: /reject|disapprov/.test(d.status) ? 'Review comments & resubmit' : 'Issue CAR for late delivery',
            owner: ow.p, secondary: ow.s,
            cost: Math.round((COST_K[d.el]||50)*0.4), schedule: '1-2 months'
        });
    });
    // Non-critical DRL gaps as warnings
    drlResults.filter(d => !d.found && !d.c).forEach(d => {
        const ow = OWNERS[d.el] || {p:'TBD',s:''};
        actions.push({
            id: 'DRL-' + String(gapN++).padStart(3,'0'), severity: 'warning', source: 'drl',
            title: d.di + ' \u2014 ' + d.t, action: 'Request submission of ' + d.di,
            owner: ow.p, secondary: ow.s,
            cost: Math.round((COST_K[d.el]||30)*0.5), schedule: '1-2 months'
        });
    });
    actions.sort((a,b) => (a.severity==='critical'?0:1)-(b.severity==='critical'?0:1));

    const critGaps = actions.filter(a => a.severity==='critical').length;
    const totalCost = actions.reduce((s,a) => s + a.cost, 0);

    ilsResults = { clItems, clPct, drlResults, drlPct, drlFound, drlTotal, pct, actions, critGaps, totalCost, prog, hull, phase, progKey, cl };

    renderILSScore(pct, critGaps);
    renderILSCoverage(clItems, drlResults);
    renderILSActions(actions);
    renderILSCost(actions, totalCost, critGaps);
    renderILSResult();
}

// ── Render Functions ──
function renderILSScore(pct, critGaps) {
    const s = document.getElementById('ilsScore'), l = document.getElementById('ilsScoreLabel'), f = document.getElementById('ilsGaugeFill');
    if (!s) return;
    s.textContent = pct + '%';
    s.style.color = pct >= 80 ? '#14f195' : pct >= 50 ? '#ffa500' : '#ff3333';
    l.textContent = pct >= 80 ? 'ILS Package: Mission Ready' : pct >= 50 ? 'Gaps Identified (' + critGaps + ' critical)' : 'Critical Gaps (' + critGaps + ' items require action)';
    f.style.width = pct + '%';
}

function renderILSCoverage(clItems, drlResults) {
    const el = document.getElementById('ilsCoverage');
    if (!el) return;
    let html = '<div style="font-weight:700;color:var(--accent);margin-bottom:8px;font-size:0.82rem">PROGRAM CHECKLIST</div>';
    clItems.forEach(item => {
        const icon = item.checked ? 'fa-check-circle' : 'fa-times-circle';
        const color = item.checked ? '#14f195' : (item.c ? '#ff3333' : 'var(--muted)');
        html += '<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:0.82rem;border-bottom:1px solid rgba(255,255,255,0.03)">'
            + '<i class="fas '+icon+'" style="color:'+color+';font-size:0.75rem;min-width:14px"></i>'
            + '<span style="color:'+(item.checked?'var(--steel)':'var(--muted)')+'">'+item.l+'</span>'
            + (item.c&&!item.checked?'<span style="color:#ff3333;font-size:0.65rem;font-weight:700;margin-left:auto">GAP</span>':'')
            + '</div>';
    });
    if (drlResults && drlResults.length) {
        const found = drlResults.filter(d=>d.found).length;
        html += '<div style="font-weight:700;color:var(--gold);margin:12px 0 6px;font-size:0.82rem">DRL COVERAGE: '+found+'/'+drlResults.length+'</div>';
        html += '<div class="ils-coverage-bar" style="margin-bottom:4px"><div class="ils-coverage-fill" style="width:'+Math.round(found/drlResults.length*100)+'%;background:'+(found/drlResults.length>=0.8?'#14f195':found/drlResults.length>=0.5?'#ffa500':'#ff3333')+'"></div></div>';
    }
    el.innerHTML = html;
}

function renderILSActions(actions) {
    const el = document.getElementById('ilsActions');
    if (!el) return;
    if (!actions.length) {
        el.innerHTML = '<div style="color:var(--green);text-align:center;padding:1rem"><i class="fas fa-check-circle" style="font-size:1.5rem;display:block;margin-bottom:6px"></i>No gaps detected. ILS package appears complete.</div>';
        return;
    }
    const crit = actions.filter(a => a.severity==='critical'), warn = actions.filter(a => a.severity==='warning');
    let html = '';
    if (crit.length) {
        html += '<div style="color:var(--red);font-weight:700;margin-bottom:6px;font-size:0.82rem"><i class="fas fa-skull-crossbones"></i> CRITICAL (' + crit.length + ')</div>';
        crit.forEach(a => { html += renderActionItem(a); });
    }
    if (warn.length) {
        html += '<div style="color:#ffa500;font-weight:700;margin:8px 0 6px;font-size:0.82rem"><i class="fas fa-exclamation-triangle"></i> WARNING (' + warn.length + ')</div>';
        warn.forEach(a => { html += renderActionItem(a); });
    }
    el.innerHTML = html;
}

function renderActionItem(a) {
    return '<div class="ils-action-item '+(a.severity==='critical'?'critical':'warning')+'">'
        + '<div class="action-header"><span class="action-title">'+a.id+': '+a.title+'</span><span class="action-owner">'+a.owner+'</span></div>'
        + '<div class="action-detail"><strong>Action:</strong> '+a.action+'</div>'
        + '<div class="action-detail"><strong>Est. Cost:</strong> '+formatCost(a.cost)+' &middot; <strong>Schedule Risk:</strong> '+a.schedule
        + (a.secondary ? ' &middot; <strong>Coord:</strong> '+a.secondary : '') + '</div></div>';
}

function renderILSCost(actions, totalCost, critGaps) {
    const el = document.getElementById('ilsCostSchedule');
    if (!el) return;
    if (!actions.length) { el.innerHTML = '<div style="color:var(--green);text-align:center;padding:0.5rem"><i class="fas fa-check-circle"></i> No cost or schedule risk identified.</div>'; return; }
    const maxSch = critGaps > 3 ? '6-12 months' : critGaps > 0 ? '2-6 months' : '< 2 months';
    el.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">'
        + '<div style="background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:12px;text-align:center">'
        + '<div style="font-size:1.5rem;font-weight:800;color:#ff3333">'+formatCost(totalCost)+'</div><div style="font-size:0.75rem;color:var(--muted)">Est. Risk Cost</div></div>'
        + '<div style="background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2);border-radius:8px;padding:12px;text-align:center">'
        + '<div style="font-size:1.5rem;font-weight:800;color:#ffa500">'+maxSch+'</div><div style="font-size:0.75rem;color:var(--muted)">Schedule Risk</div></div></div>'
        + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'
        + '<div style="text-align:center;padding:8px"><div style="font-size:1.2rem;font-weight:700;color:#ff3333">'+critGaps+'</div><div style="font-size:0.75rem;color:var(--muted)">Critical Path Items</div></div>'
        + '<div style="text-align:center;padding:8px"><div style="font-size:1.2rem;font-weight:700;color:#ffa500">'+actions.length+'</div><div style="font-size:0.75rem;color:var(--muted)">Total Action Items</div></div></div>';
}

function renderILSResult() {
    if (!ilsResults) return;
    const r = ilsResults;
    const panel = document.getElementById('ilsResult');
    const progStr = r.prog.name + (r.hull ? ' \u2014 ' + r.hull : '');
    const phaseStr = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || '';
    const clComplete = r.clItems.filter(i=>i.checked).length;
    panel.innerHTML = '<div class="result-label">ILS ANALYSIS \u2014 ' + progStr.toUpperCase() + '</div>'
        + '<div style="margin:0.5rem 0;font-size:0.85rem;color:var(--muted)">Office: '+r.prog.ofc+' \u00b7 Phase: '+phaseStr+' \u00b7 Files: '+ilsFiles.length+'</div>'
        + '<div style="margin:0.8rem 0"><span style="font-size:1.3rem;font-weight:800;color:'+(r.pct>=80?'var(--green)':r.pct>=50?'#ffa500':'var(--red)')+'">'+r.pct+'% Overall Readiness</span></div>'
        + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:0.8rem 0">'
        + '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center"><div style="font-size:1.1rem;font-weight:700;color:var(--accent)">'+clComplete+'/'+r.clItems.length+'</div><div style="font-size:0.72rem;color:var(--muted)">Checklist Items</div></div>'
        + '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center"><div style="font-size:1.1rem;font-weight:700;color:var(--gold)">'+r.drlFound+'/'+r.drlTotal+'</div><div style="font-size:0.72rem;color:var(--muted)">DRL Items Verified</div></div></div>'
        + (r.critGaps > 0
            ? '<div style="background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:10px;margin:0.8rem 0;font-size:0.88rem"><i class="fas fa-exclamation-triangle" style="color:#ff3333"></i> <strong style="color:#ff3333">'+r.critGaps+' critical gap'+(r.critGaps>1?'s':'')+' found</strong> \u2014 Est. risk: <strong>'+formatCost(r.totalCost)+'</strong>. See Action Items.</div>'
            : '<div style="background:rgba(20,241,149,0.08);border:1px solid rgba(20,241,149,0.2);border-radius:8px;padding:10px;margin:0.8rem 0;font-size:0.88rem"><i class="fas fa-check-circle" style="color:var(--green)"></i> <strong style="color:var(--green)">All critical items accounted for.</strong> Package appears ready for review.</div>')
        + '<div style="margin-top:1rem;font-size:0.78rem;color:var(--muted)">Analysis based on DoW 5000 series ILS requirements per program type. Always verify against your contract-specific DRL.</div>';
    panel.classList.add('show');
    showPostActions();
    // Notify AI agent that analysis is available
    addAiMessage('Analysis complete! <strong>' + r.prog.name + '</strong> scored <strong>' + r.pct + '%</strong> readiness with <strong>' + r.critGaps + ' critical gaps</strong>. Ask me anything about the results.', 'bot');
}

// ── Report Generation ──
function generateILSReport() {
    if (!ilsResults) { runFullILSAnalysis(); }
    if (!ilsResults) { alert('Please select a program and run analysis first.'); return; }
    const r = ilsResults, prog = r.prog;
    const phaseStr = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || '';
    const now = new Date();

    let rpt = '\u2550'.repeat(65) + '\n';
    rpt += '  S4 LEDGER \u2014 ILS DATA PACKAGE GAP ANALYSIS REPORT\n';
    rpt += '\u2550'.repeat(65) + '\n\n';
    rpt += 'Program:        ' + prog.name + (r.hull ? ' (' + r.hull + ')' : '') + '\n';
    rpt += 'Program Office: ' + prog.ofc + '\n';
    rpt += 'Platform Type:  ' + prog.type + '\n';
    rpt += 'Phase:          ' + phaseStr + '\n';
    rpt += 'Report Date:    ' + now.toISOString().split('T')[0] + '\n';
    rpt += 'Analyst Tool:   S4 Ledger ILS Workspace v3.0\n';
    rpt += 'Classification: UNCLASSIFIED\n\n';
    rpt += '\u2500'.repeat(65) + '\n';
    rpt += '  OVERALL READINESS:     ' + r.pct + '%\n';
    rpt += '  Checklist Score:       ' + r.clPct + '% (' + r.clItems.filter(i=>i.checked).length + '/' + r.clItems.length + ' items)\n';
    rpt += '  DRL Coverage:          ' + r.drlPct + '% (' + r.drlFound + '/' + r.drlTotal + ' items)\n';
    rpt += '  Critical Gaps:         ' + r.critGaps + '\n';
    rpt += '  Total Action Items:    ' + r.actions.length + '\n';
    rpt += '  Est. Risk Cost:        ' + formatCost(r.totalCost) + '\n';
    rpt += '\u2500'.repeat(65) + '\n\n';

    rpt += 'DOCUMENTS ANALYZED (' + ilsFiles.length + '):\n';
    if (ilsFiles.length) ilsFiles.forEach(f => { rpt += '  \u2022 ' + f.name + ' \u2014 ' + f.records.length + ' items detected\n'; });
    else rpt += '  (No files uploaded \u2014 analysis based on checklist only)\n';

    rpt += '\n\nPROGRAM-SPECIFIC ILS CHECKLIST:\n' + '\u2500'.repeat(65) + '\n';
    r.clItems.forEach(item => {
        rpt += '  [' + (item.checked ? '\u2713' : '\u2717') + '] ' + item.l + (item.c ? ' (CRITICAL)' : '') + (item.checked ? '' : ' *** GAP ***') + '\n';
    });

    rpt += '\n\nDRL/CDRL COVERAGE:\n' + '\u2500'.repeat(65) + '\n';
    r.drlResults.forEach(d => {
        rpt += '  [' + (d.found ? '\u2713' : '\u2717') + '] ' + d.s + ' ' + d.di + ' \u2014 ' + d.t;
        if (d.found) rpt += ' (' + d.status + ')';
        else rpt += ' *** MISSING ***';
        if (d.c) rpt += ' [CRITICAL]';
        rpt += '\n';
    });

    if (r.actions.length) {
        rpt += '\n\nACTION ITEMS:\n' + '\u2550'.repeat(65) + '\n';
        r.actions.forEach(a => {
            rpt += '\n  ' + a.id + ' [' + a.severity.toUpperCase() + ']\n';
            rpt += '  Item:        ' + a.title + '\n';
            rpt += '  Action:      ' + a.action + '\n';
            rpt += '  Responsible: ' + a.owner + (a.secondary ? ' (Coord: ' + a.secondary + ')' : '') + '\n';
            rpt += '  Cost Impact: ' + formatCost(a.cost) + '   Schedule Risk: ' + a.schedule + '\n';
            rpt += '  ' + '\u2500'.repeat(50) + '\n';
        });
    }

    rpt += '\n\n' + '\u2500'.repeat(65) + '\n  RECOMMENDATIONS:\n';
    if (r.critGaps > 0) {
        rpt += '  1. Address all CRITICAL action items before next milestone review.\n';
        rpt += '  2. Issue Corrective Action Requests (CARs) for missing deliverables.\n';
        rpt += '  3. Schedule ILS Review Board to discuss gaps with contractor.\n';
        rpt += '  4. Update program risk register with identified cost/schedule impacts.\n';
    } else {
        rpt += '  1. Conduct final review of all deliverables for completeness.\n';
        rpt += '  2. Verify configuration baseline matches as-built documentation.\n';
        rpt += '  3. Proceed to next milestone with ILS package approval.\n';
    }
    rpt += '\n' + '\u2500'.repeat(65) + '\n  Generated by S4 Ledger | s4ledger.com\n';
    rpt += '  Hash-verified logistics for the defense industry\n' + '\u2550'.repeat(65) + '\n';

    const blob = new Blob([rpt], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = 'ILS_Gap_Analysis_' + r.progKey.toUpperCase() + '_' + now.toISOString().split('T')[0] + '.txt';
    a.click(); URL.revokeObjectURL(url);

    const panel = document.getElementById('ilsResult');
    panel.innerHTML = '<div style="color:var(--green);font-size:0.95rem;font-weight:700;margin-bottom:8px"><i class="fas fa-download"></i> Report downloaded!</div>'
        + '<pre style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;font-size:0.7rem;color:var(--steel);max-height:300px;overflow-y:auto;white-space:pre-wrap">' + rpt + '</pre>'
        + '<button style="margin-top:8px;background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:6px;padding:6px 16px;cursor:pointer;font-family:inherit;font-size:0.82rem;font-weight:600" onclick="navigator.clipboard.writeText(document.querySelector(\'#ilsResult pre\').textContent).then(()=>this.innerHTML=\'<i class=\\\'fas fa-check\\\'></i> Copied!\')"><i class="fas fa-copy"></i> Copy to Clipboard</button>';
    panel.classList.add('show');
}

async function anchorILSReport() {
    if (!ilsResults) { runFullILSAnalysis(); }
    if (!ilsResults) return;
    const reportStr = JSON.stringify({
        program: ilsResults.prog.name, hull: ilsResults.hull, score: ilsResults.pct,
        critGaps: ilsResults.critGaps, totalActions: ilsResults.actions.length,
        riskCost: ilsResults.totalCost, date: new Date().toISOString(), files: ilsFiles.map(f => f.name)
    });
    const hash = await sha256(reportStr);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();

    // Show the anchor animation (same as main anchor tab)
    showAnchorAnimation(hash, 'ILS Gap Analysis Report', 'UNCLASSIFIED');

    // POST to API (best-effort)
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'ILS_GAP_ANALYSIS', tx_hash:txHash, content_preview:'ILS Report: '+ilsResults.prog.name})}); }
    catch(e) { console.warn('API anchor failed:', e); }

    // Record in session
    const record = {
        type:'ILS_GAP_ANALYSIS', label:'ILS Gap Analysis Report', icon:'\uD83E\uDDE0', branch:'JOINT',
        hash, txHash, encrypted:false, timestamp:new Date().toISOString(),
        content:'ILS Analysis: ' + ilsResults.prog.name + ' — ' + ilsResults.pct + '% readiness'
    };
    sessionRecords.push(record);
    saveLocalRecord({
        hash, record_type:'ILS_GAP_ANALYSIS', record_label:'ILS Gap Analysis Report', branch:'JOINT',
        icon:'\uD83E\uDDE0', timestamp:new Date().toISOString(),
        timestamp_display: new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC',
        fee:0.01, tx_hash:txHash, system:'ILS Workspace'
    });
    addToVault({hash, txHash, type:'ILS_GAP_ANALYSIS', label:'ILS Gap Analysis Report', branch:'JOINT', icon:'🧠', content:'ILS Analysis: '+ilsResults.prog.name+' — '+ilsResults.pct+'% readiness', encrypted:false, timestamp:new Date().toISOString(), source:'ILS Gap Analysis', fee:0.01});
    stats.anchored++;
    stats.types.add('ILS_GAP_ANALYSIS');
    stats.slsFees += 0.01;
    updateStats();
    saveStats();

    await new Promise(r => setTimeout(r, 3200));
    hideAnchorAnimation();
    await new Promise(r => setTimeout(r, 400));

    const panel = document.getElementById('ilsResult');
    panel.innerHTML = '<div class="result-label">ILS REPORT ANCHORED TO XRPL</div>'
        + '<div style="color:var(--green);font-weight:700;margin:0.5rem 0"><i class="fas fa-check-circle"></i> Report hash anchored successfully!</div>'
        + '<div class="result-label" style="margin-top:0.8rem">SHA-256 HASH</div><div class="hash-display">' + hash + '</div>'
        + '<div class="result-label">TX HASH</div><div style="color:var(--muted);margin-bottom:0.5rem;word-break:break-all">' + txHash + '</div>'
        + '<div class="result-label">PROGRAM</div><div style="margin-bottom:0.5rem">' + ilsResults.prog.name + (ilsResults.hull?' ('+ilsResults.hull+')':'') + '</div>'
        + '<div class="result-label">READINESS</div><div style="margin-bottom:0.5rem;color:'+(ilsResults.pct>=80?'var(--green)':ilsResults.pct>=50?'#ffa500':'var(--red)')+';font-weight:700">' + ilsResults.pct + '%</div>'
        + '<div class="result-label">$SLS FEE</div><div>0.01 $SLS \u2192 Treasury</div>'
        + '<div style="margin-top:0.8rem;font-size:0.82rem;color:var(--muted)">This hash is now immutably recorded on the XRP Ledger. Anyone with the original data can verify its integrity.</div>';
    panel.classList.add('show');
    showPostActions();
    updateTxLog();
}

// ═══ POST-ANALYSIS ACTIONS ═══
function showPostActions() {
    const el = document.getElementById('ilsPostActions');
    if (el) el.style.display = 'block';
}

function sendILSAnalysis() {
    if (!ilsResults) return;
    const subj = 'ILS Gap Analysis — ' + ilsResults.prog.name + ' — ' + ilsResults.pct + '% Readiness';
    document.getElementById('sendSubject').value = subj;
    document.getElementById('sendModal').classList.add('active');
}

function closeSendModal() { document.getElementById('sendModal').classList.remove('active'); }

function executeSend() {
    const emails = document.getElementById('sendEmail').value.trim();
    const subject = document.getElementById('sendSubject').value;
    const body = document.getElementById('sendMessage').value + '\n\n' + buildAnalysisSummaryText();
    const mailto = 'mailto:' + encodeURIComponent(emails) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    window.open(mailto, '_blank');
    closeSendModal();
}

function copyAnalysisToClipboard() {
    const text = buildAnalysisSummaryText();
    navigator.clipboard.writeText(text).then(() => {
        alert('Analysis copied to clipboard!');
    });
}

function buildAnalysisSummaryText() {
    if (!ilsResults) return '';
    const r = ilsResults;
    let txt = 'S4 LEDGER — ILS GAP ANALYSIS SUMMARY\n';
    txt += '═══════════════════════════════════════\n';
    txt += 'Program: ' + r.prog.name + (r.hull ? ' ('+r.hull+')' : '') + '\n';
    txt += 'Office: ' + r.prog.ofc + '\n';
    txt += 'Overall Readiness: ' + r.pct + '%\n';
    txt += 'Critical Gaps: ' + r.critGaps + '\n';
    txt += 'Total Action Items: ' + r.actions.length + '\n';
    txt += 'Est. Risk Cost: ' + formatCost(r.totalCost) + '\n\n';
    if (r.actions.length) {
        txt += 'TOP ACTION ITEMS:\n';
        r.actions.slice(0,5).forEach(a => { txt += '  • [' + a.severity.toUpperCase() + '] ' + a.title + ' — ' + a.owner + '\n'; });
    }
    txt += '\nGenerated by S4 Ledger | s4ledger.com\n';
    return txt;
}

function scheduleILSMeeting() {
    if (!ilsResults) return;
    const title = 'ILS Review Board — ' + ilsResults.prog.name + ' (' + ilsResults.pct + '% Readiness)';
    document.getElementById('meetTitle').value = title;
    // Default to next Wednesday at 10:00
    const nextWed = new Date();
    nextWed.setDate(nextWed.getDate() + ((3 - nextWed.getDay() + 7) % 7 || 7));
    document.getElementById('meetDate').value = nextWed.toISOString().split('T')[0];
    document.getElementById('meetingModal').classList.add('active');
}

function closeMeetingModal() { document.getElementById('meetingModal').classList.remove('active'); }

function createTeamsMeeting() {
    const title = document.getElementById('meetTitle').value;
    const date = document.getElementById('meetDate').value;
    const time = document.getElementById('meetTime').value;
    const attendees = document.getElementById('meetAttendees').value;
    // Open Teams meeting creation
    const teamsUrl = 'https://teams.microsoft.com/l/meeting/new?subject=' + encodeURIComponent(title) + '&attendees=' + encodeURIComponent(attendees) + '&startTime=' + date + 'T' + time;
    window.open(teamsUrl, '_blank');
    closeMeetingModal();
}

function createCalendarEvent() {
    if (!ilsResults) return;
    const title = document.getElementById('meetTitle').value;
    const date = document.getElementById('meetDate').value.replace(/-/g,'');
    const time = document.getElementById('meetTime').value.replace(':','') + '00';
    const endTime = String(parseInt(document.getElementById('meetTime').value.split(':')[0])+1).padStart(2,'0') + document.getElementById('meetTime').value.split(':')[1] + '00';
    const desc = buildAnalysisSummaryText();
    const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//S4 Ledger//ILS Workspace//EN',
        'BEGIN:VEVENT',
        'DTSTART:' + date + 'T' + time,
        'DTEND:' + date + 'T' + endTime,
        'SUMMARY:' + title,
        'DESCRIPTION:' + desc.replace(/\n/g,'\\n'),
        'ORGANIZER:S4 Ledger ILS Workspace',
        'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
    const blob = new Blob([ics], {type:'text/calendar'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ILS_Review_' + ilsResults.progKey + '.ics';
    a.click();
    closeMeetingModal();
}

function exportActionTracker() {
    if (!ilsResults || !ilsResults.actions.length) { alert('Run analysis first to generate action items.'); return; }
    let csv = 'Action ID,Severity,Title,Required Action,Responsible Party,Coordinator,Est Cost ($K),Schedule Risk,Status,Due Date,Notes\n';
    ilsResults.actions.forEach(a => {
        const due = new Date(); due.setDate(due.getDate() + (a.severity==='critical'?30:60));
        csv += a.id + ',' + a.severity.toUpperCase() + ',"' + a.title + '","' + a.action + '",' + a.owner + ',' + (a.secondary||'') + ',' + a.cost + ',' + a.schedule + ',Open,' + due.toISOString().split('T')[0] + ',\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Action_Tracker_' + ilsResults.progKey.toUpperCase() + '_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}

function printILSReport() {
    if (!ilsResults) { alert('Run analysis first.'); return; }
    generateILSReport(); // This downloads the report
    setTimeout(() => window.print(), 500);
}

function saveILSReport() {
    if (!ilsResults) { alert('Run analysis first.'); return; }
    generateILSReport();
}

// ═══ S4 ILS AI AGENT ═══

// ── Floating Agent Toggle ──
let aiAgentOpen = false;
function toggleAiAgent() {
    aiAgentOpen = !aiAgentOpen;
    const panel = document.getElementById('aiFloatPanel');
    if (panel) {
        panel.classList.toggle('open', aiAgentOpen);
        if (aiAgentOpen) {
            setTimeout(() => document.getElementById('aiChatInput')?.focus(), 350);
        }
    }
}

// ── Context-Aware Quick Actions ──
const AI_TOOL_CONTEXT = {
    'hub-analysis':     {label:'Gap Analysis',    icon:'fa-chart-line',         buttons:[['Summarize my gaps','Summarize Gaps'],['What are the critical items?','Critical Items'],['Draft a CAR','Draft CAR'],['Estimate total risk','Risk Estimate'],['What DI numbers am I missing?','Missing DIs'],['Suggest next steps','Next Steps'],['Draft a memo','Draft Memo'],['Draft an email','Draft Email']]},
    'hub-actions':      {label:'Action Items',    icon:'fa-tasks',              buttons:[['How many open actions?','Open Actions'],['Show critical items','Critical Items'],['Who has the most tasks?','Task Load'],['Suggest priorities','Prioritize'],['Draft a follow-up email','Follow-Up Email'],['What is overdue?','Overdue Items']]},
    'hub-calendar':     {label:'ILS Calendar',    icon:'fa-calendar-alt',       buttons:[['What milestones are coming up?','Upcoming Milestones'],['Show warranty expirations','Warranty Alerts'],['Schedule a DMSMS review','Schedule Review'],['Export calendar','Export .ics'],['Draft a schedule memo','Schedule Memo']]},
    'hub-dmsms':        {label:'DMSMS Tracker',   icon:'fa-exclamation-triangle',buttons:[['What parts are obsolete?','Obsolete Parts'],['Find alternate sources','Alt Sources'],['Estimate DMSMS cost impact','Cost Impact'],['Draft a DMSMS report','DMSMS Report'],['What is DMSMS?','Explain DMSMS'],['Show risk by program','Risk by Program']]},
    'hub-readiness':    {label:'Readiness',       icon:'fa-chart-line',         buttons:[['Calculate Ao','Calc Availability'],['What is MTBF vs MTTR?','MTBF/MTTR'],['Compare readiness benchmark','Benchmark'],['Suggest readiness improvements','Improvements'],['Draft readiness brief','Readiness Brief']]},
    'hub-parts':        {label:'Parts Cross-Ref', icon:'fa-cogs',               buttons:[['Look up an NSN','NSN Lookup'],['Find CAGE code','CAGE Search'],['What alternates exist?','Alt Parts'],['Cross-reference this part','Cross-Ref'],['What is FLIS?','Explain FLIS']]},
    'hub-roi':          {label:'ROI Calculator',   icon:'fa-dollar-sign',       buttons:[['Calculate ROI for my program','Calc ROI'],['What are the labor savings?','Labor Savings'],['Show 5-year projection','5-Year Projection'],['Compare vs legacy systems','Legacy Comparison'],['Draft an ROI brief','ROI Brief']]},
    'hub-lifecycle':    {label:'Lifecycle Cost',   icon:'fa-clock',             buttons:[['Estimate total ownership cost','TOC Estimate'],['Break down sustainment costs','Sustainment Breakdown'],['What drives lifecycle cost?','Cost Drivers'],['Compare to similar platforms','Platform Comparison'],['Draft lifecycle memo','Lifecycle Memo']]},
    'hub-warranty':     {label:'Warranty Tracker', icon:'fa-file-contract',     buttons:[['What warranties expire soon?','Expiring Soon'],['Show CLIN milestones','CLIN Status'],['Draft warranty extension request','Extension Request'],['What is FAR 46.7?','Explain FAR 46.7'],['Export warranty report','Export Report']]},
    'hub-vault':        {label:'Audit Vault',      icon:'fa-vault',             buttons:[['How many records in the vault?','Vault Stats'],['Search for a record','Search Vault'],['What is the audit trail?','Explain Vault'],['How is data secured?','Vault Security'],['Export vault to CSV','Export CSV'],['Re-verify a hash','Verify Hash']]},
    'hub-docs':         {label:'Doc Library',      icon:'fa-book',              buttons:[['Find MIL-STD-1388','Find Doc'],['What documents cover ILS?','ILS Documents'],['Show NAVSEA standards','NAVSEA Docs'],['Browse NIST frameworks','NIST Frameworks'],['What is a DI number?','Explain DIs']]},
    'hub-compliance':   {label:'Compliance',       icon:'fa-shield-halved',     buttons:[['Calculate my compliance score','Calc Score'],['What is CMMC Level 2?','Explain CMMC'],['Show NIST 800-171 controls','NIST Controls'],['What DFARS clauses apply?','DFARS Clauses'],['How do I improve my score?','Improve Score'],['Draft compliance memo','Compliance Memo']]},
    'hub-provisioning': {label:'Provisioning',     icon:'fa-boxes-stacked',     buttons:[['How does S4 beat ICAPS?','ICAPS Comparison'],['What is a PTD?','Explain PTD'],['Generate allowance parts lists','Generate APLs'],['Show NSN cataloging status','NSN Status'],['What is provisioning?','Explain Provisioning'],['Draft provisioning report','Prov Report']]},
    'hub-risk':         {label:'Risk Engine',      icon:'fa-triangle-exclamation',buttons:[['What are the highest risk parts?','Top Risks'],['Show single-source dependencies','Single Source'],['Any GIDEP alerts?','GIDEP Alerts'],['Estimate risk cost impact','Cost Impact'],['What is supply chain risk?','Explain Risk'],['Draft risk mitigation plan','Risk Plan']]},
    'hub-reports':      {label:'Report Generator', icon:'fa-file-pdf',           buttons:[['Generate a full audit package','Full Audit'],['What compliance score do I have?','Compliance Score'],['Create a DCMA-ready report','DCMA Report'],['How are reports verified?','Report Verification'],['What report types are available?','Report Types']]},
    'hub-contracts':    {label:'Contract Mgmt',    icon:'fa-file-signature',     buttons:[['Show overdue CDRLs','Overdue CDRLs'],['What mods are pending?','Pending Mods'],['Track SOW deliverables','SOW Status'],['What is a CDRL?','Explain CDRLs'],['Draft deliverable status report','Status Report'],['How does anchoring prevent disputes?','Dispute Prevention']]},
    'hub-thread':       {label:'Digital Thread',   icon:'fa-project-diagram',    buttons:[['Show pending ECPs','Pending ECPs'],['What is configuration management?','Explain CM'],['Show BOM revision history','BOM History'],['What baselines are anchored?','Anchored Baselines'],['Draft ECP summary','ECP Summary'],['How does S4 connect to PLM?','PLM Integration']]},
    'hub-predictive':   {label:'Predictive Maint', icon:'fa-brain',             buttons:[['What failures are predicted?','Predictions'],['Show urgent maintenance needs','Urgent Items'],['How much can we save?','Cost Savings'],['What is MTBF trending?','MTBF Trends'],['Draft maintenance advisory','Maint Advisory'],['How does the AI model work?','Explain Model']]},
    'hub-dbimport':     {label:'Database Import',  icon:'fa-database',          buttons:[['What systems are supported?','Supported Systems'],['How do I import records?','Import Guide'],['What formats are accepted?','File Formats'],['How much does the import tool save?','Import Savings'],['Show imported records','Import Status'],['How does import anchoring work?','Import Anchoring']]},
    'hub-submissions':  {label:'ILIE',icon:'fa-file-circle-check', buttons:[['Run a demo analysis','Demo Analysis'],['What submission types are tracked?','Submission Types'],['How does the discrepancy engine work?','Discrepancy Engine'],['What red flags does it catch?','Red Flags'],['How much does this tool save?','Cost Savings'],['Show submission history','History'],['How does AI help with reviews?','AI Review'],['Draft a discrepancy report','Draft Report']]}
};
let currentHubPanel = 'hub-analysis';

function updateAiContext(panelId) {
    currentHubPanel = panelId;
    const ctx = AI_TOOL_CONTEXT[panelId];
    if (!ctx) return;
    const toolLabel = document.getElementById('aiContextTool');
    if (toolLabel) toolLabel.textContent = ctx.label;
    const btnContainer = document.getElementById('aiQuickBtns');
    if (btnContainer) {
        btnContainer.innerHTML = ctx.buttons.map(b => `<button class="ai-quick-btn" onclick="aiAsk('${b[0]}')">${b[1]}</button>`).join('');
    }
}
// Initialize quick buttons on load
document.addEventListener('DOMContentLoaded', () => updateAiContext('hub-analysis'));

// ── AI Agent Conversation Memory ──
let aiConversationHistory = [];
const AI_MAX_HISTORY = 20;

function aiSend() {
    const input = document.getElementById('aiChatInput');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    addAiMessage(msg, 'user');
    aiConversationHistory.push({role:'user', text:msg, time:Date.now()});
    if (aiConversationHistory.length > AI_MAX_HISTORY) aiConversationHistory.shift();
    setTimeout(() => {
        const response = generateAiResponse(msg);
        addAiMessage(response, 'bot');
        aiConversationHistory.push({role:'bot', text:response, time:Date.now()});
        if (aiConversationHistory.length > AI_MAX_HISTORY) aiConversationHistory.shift();
    }, 400 + Math.random() * 600);
}

function aiAsk(question) {
    document.getElementById('aiChatInput').value = question;
    aiSend();
}

function addAiMessage(text, type) {
    const container = document.getElementById('aiChatMessages');
    const div = document.createElement('div');
    div.className = 'ai-msg ' + type;
    if (type === 'bot') {
        div.innerHTML = '<div class="ai-label"><i class="fas fa-robot"></i> S4 Agent</div>' + text;
    } else {
        div.textContent = text;
    }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function generateAiResponse(query) {
    const q = query.toLowerCase();
    const r = ilsResults;

    // Context-aware responses based on analysis state
    if (!r) {
        if (/gap|analysis|result|score|status/.test(q)) return 'I don\'t have any analysis results yet. Please upload documents and click <strong>"Run Full Analysis"</strong> to generate results I can help interpret.';
        if (/di-?\d+|di number/.test(q)) return explainDINumber(q);
        if (/what.*do|help|how.*work/.test(q)) return 'I can help you with:<br>• <strong>Interpreting gap analysis results</strong> after you run an analysis<br>• <strong>Explaining DI number requirements</strong> (e.g., "What is DI-009?")<br>• <strong>Suggesting corrective actions</strong> for identified gaps<br>• <strong>Drafting CARs</strong> (Corrective Action Requests)<br>• <strong>Estimating cost/schedule impacts</strong><br><br>Upload your documents and run analysis to get started!';
        if (/lcsp|life cycle/.test(q)) return '<strong>Life Cycle Sustainment Plan (LCSP)</strong> — DI-039 / DI-ILSS-81490<br><br>The LCSP is a top-level ILS planning document that:<br>• Defines the sustainment strategy for the entire program lifecycle<br>• Addresses all 12 ILS elements<br>• Establishes performance metrics (Ao, MTBF, MTTR)<br>• Required per DoW Instruction 5000.02<br><br>Use the <strong>"Load Full ILS Package"</strong> button to see a sample LCSP.';
        if (/vault|audit.*record|audit.*trail|audit.*vault|anchored.*record/.test(q)) return '<strong>Audit Record Vault</strong><br><br>The Audit Record Vault automatically captures every record you anchor from any tool in the ILS Workspace — DMSMS cases, readiness calculations, warranty snapshots, lifecycle cost analyses, ROI reports, and gap analysis results.<br><br>Each record stores:<br>• <strong>SHA-256 hash</strong> — the cryptographic fingerprint<br>• <strong>Content preview</strong> — what was anchored<br>• <strong>Timestamp</strong> — when it was anchored<br>• <strong>TX Hash</strong> — XRPL transaction ID for independent verification<br>• <strong>Record type</strong> — which tool generated it<br><br>You can <strong>re-verify</strong> any record with one click, <strong>export</strong> as CSV/XLSX for audits, and <strong>search/filter</strong> across your entire audit trail. Think of it as a filing cabinet that\'s also blockchain-verified.<br><br>Click the <strong>Audit Vault</strong> tab above to view your records.';
        if (/compliance.*score|cmmc|nist.*800|dfars.*252|compliance.*posture|compliance.*card/.test(q)) return '<strong>Compliance Scorecard</strong><br><br>The Compliance Scorecard auto-calculates your compliance posture across 6 frameworks:<br><br>• <strong>CMMC Level 2</strong> — Cybersecurity Maturity Model Certification<br>• <strong>NIST SP 800-171</strong> — CUI Protection (110 controls)<br>• <strong>DFARS 252.204-7012</strong> — Safeguarding Covered Defense Information<br>• <strong>FAR 46 Quality</strong> — Federal Acquisition Regulation quality clauses<br>• <strong>MIL-STD-1388 ILS</strong> — Logistics Support Analysis requirements<br>• <strong>DoDI 4245.15 DMSMS</strong> — Diminishing Manufacturing Sources management<br><br>Your score is calculated from <strong>real workspace activity</strong> — every record you anchor, DMSMS case you track, and readiness calculation you run contributes to your compliance posture. The overall score aggregates into a <strong>letter grade (A+ through F)</strong> for executive reporting.<br><br>Click the <strong>Compliance</strong> tab above to view your scorecard.';
        if (/defense.*doc|doc.*library|mil-std|opnavinst|regulation|standard|reference|mil-hdbk/.test(q)) return '<strong>Defense Document Library</strong><br><br>Searchable reference library of <strong>100+ real defense documents</strong> — MIL-STDs, MIL-HDBKs, OPNAVINSTs, COMDTINST, Army Regulations, Air Force Instructions, Marine Corps Orders, DFARS clauses, and NIST standards.<br><br>Features:<br>• <strong>Filter by category</strong> — ILS, Readiness, Maintenance, Supply, DMSMS, Cybersecurity, etc.<br>• <strong>Filter by branch</strong> — Joint, Navy, Coast Guard, Army, Air Force, Marines, Space Force<br>• <strong>Full-text search</strong> — by document ID, title, description, or keywords<br>• <strong>Direct links</strong> — click any document to open the official source<br><br>Use this while working in other tools to reference applicable standards without leaving the workspace.<br><br>Click the <strong>Doc Library</strong> tab above to browse.';
        if (/provision|ptd|provisioning.*tech|allowance.*part|apl.*gen|catalog|icaps|lmi|logistics.*product|ppd|provisioning.*part/.test(q)) return '<strong>Provisioning & ICAPS</strong><br><br>S4 Ledger supports provisioning workflows that go beyond what legacy tools like <strong>ICAPS</strong> (Interactive Computer-Aided Provisioning System) offer:<br><br>• <strong>Vendor Recommended Spares (VRS)</strong> — DI-020, tracked in gap analysis<br>• <strong>Allowance Parts List (APL)</strong> — DI-021, COSAL data for initial outfitting<br>• <strong>Spares Buylist</strong> — initial outfitting and provisioning data<br>• <strong>GoFM (GFM) List</strong> — government-furnished material tracking<br>• <strong>Parts Cross-Reference</strong> — NSN, CAGE, manufacturer data with alternates<br>• <strong>DMSMS Integration</strong> — obsolescence affects provisioning decisions<br><br><strong>How S4 beats ICAPS:</strong><br>• ICAPS covers <em>only</em> Supply Support — S4 covers all 12 ILS elements<br>• ICAPS is Navy/Marine Corps only — S4 is all-branch<br>• ICAPS has no blockchain verification — S4 anchors every provisioning decision<br>• ICAPS has no compliance scoring — S4 tracks CMMC, NIST, DFARS<br>• ICAPS is a standalone tool — S4 integrates provisioning with DMSMS, readiness, lifecycle cost, and warranty data<br><br>Use the <strong>Parts</strong> tab for cross-reference and the <strong>Gap Analysis</strong> tab to track provisioning deliverables.';
        if (/import|database.*import|db.*import|defense.*database|import.*record|import.*csv|import.*xml|import.*json|nserc|merlin|gcss|cdmd|navsup|remis|lims|dpas|flis|atlass|almis|piee|gcss.army|lmp|aesip|d200|cgone|ussf/.test(q)) return '<strong>Defense Database Import</strong><br><br>The Defense Database Import tool lets you ingest records from <strong>24+ systems across all branches</strong>:<br><br>🔹 <strong>Navy:</strong> NSERC/SE IDE, MERLIN, NAVAIR AMS PMT, CDMD-OA, NDE, PEO MLB, CSPT, NAVSUP<br>🟢 <strong>Army:</strong> GCSS-Army, LMP, AESIP<br>🔵 <strong>Air Force:</strong> REMIS, LIMS-EV, D200A<br>🔴 <strong>Marine Corps:</strong> GCSS-MC, ATLASS<br>🟠 <strong>Coast Guard:</strong> ALMIS, CGOne<br>⚫ <strong>Space Force:</strong> USSF LMS<br>🏛 <strong>Joint/OSD:</strong> COMPASS, MBPS, GCSS, DPAS, DLA FLIS, PIEE/WAWF<br><br><strong>How it works:</strong><br>1. Select a source system from the dropdown<br>2. Upload a CSV, XML, or JSON file — or paste data directly<br>3. S4 auto-detects format, maps fields, and computes SHA-256 hashes<br>4. Click <strong>"Anchor to XRPL"</strong> to create immutable blockchain records<br><br><strong>Savings:</strong> $450K+/year per program. 70% less data reconciliation time. 80% fewer data discrepancies. 60% faster audit prep.<br><br>Click the <strong>Database Import</strong> tab above to get started, or use <strong>"Run Demo Import"</strong> to see sample data from any system.';
        return 'I\'m your ILS Workspace Agent. I can help with DI numbers, gap analysis, CARs, ILS requirements, the audit vault, compliance scorecard, defense document library, provisioning, and more. Run an analysis to get context-specific insights, or ask me about any ILS topic!';
    }

    // Has analysis results
    if (/summarize|summary|overview|gap/.test(q)) {
        const critActions = r.actions.filter(a=>a.severity==='critical');
        let resp = '<strong>' + r.prog.name + '</strong> — Overall Readiness: <strong style="color:'+(r.pct>=80?'#14f195':r.pct>=50?'#ffa500':'#ff3333')+'">' + r.pct + '%</strong><br><br>';
        resp += '\uD83D\uDCCB Checklist: ' + r.clItems.filter(i=>i.checked).length + '/' + r.clItems.length + ' items (' + r.clPct + '%)<br>';
        resp += '\uD83D\uDCC4 DRL Coverage: ' + r.drlFound + '/' + r.drlTotal + ' items (' + r.drlPct + '%)<br>';
        if (critActions.length) {
            resp += '<br>\u26A0\uFE0F <strong style="color:#ff3333">' + critActions.length + ' critical gaps:</strong><br>';
            critActions.slice(0,3).forEach(a => { resp += '• ' + a.title + '<br>'; });
            if (critActions.length > 3) resp += '• ...and ' + (critActions.length-3) + ' more<br>';
        }
        resp += '<br>\uD83D\uDCB0 Est. risk cost: <strong>' + formatCost(r.totalCost) + '</strong>';
        return resp;
    }

    if (/critical|urgent|important|priority/.test(q)) {
        const crit = r.actions.filter(a=>a.severity==='critical');
        if (!crit.length) return '\u2705 <strong>No critical items found!</strong> Your ILS package appears to cover all critical requirements. Review the warning-level items to ensure full compliance.';
        let resp = '\u26A0\uFE0F <strong style="color:#ff3333">' + crit.length + ' Critical Items Requiring Immediate Attention:</strong><br><br>';
        crit.forEach((a,i) => {
            resp += '<strong>' + (i+1) + '. ' + a.id + '</strong>: ' + a.title + '<br>';
            resp += '   \u2192 ' + a.action + '<br>';
            resp += '   \uD83D\uDC64 Owner: ' + a.owner + ' | \uD83D\uDCB0 ' + formatCost(a.cost) + ' | \u23F0 ' + a.schedule + '<br><br>';
        });
        resp += '<strong>Recommendation:</strong> Issue CARs for all critical items and escalate to the next ILS Review Board.';
        return resp;
    }

    if (/car|corrective\s*action/.test(q)) {
        const gaps = r.actions.filter(a=>a.severity==='critical');
        if (!gaps.length) return 'No critical gaps found that require a CAR. Your ILS package appears complete for this phase.';
        const g = gaps[0];
        return '<strong>DRAFT — Corrective Action Request (CAR)</strong><br><br>' +
            '<strong>CAR Number:</strong> CAR-' + r.progKey.toUpperCase() + '-' + new Date().getFullYear() + '-001<br>' +
            '<strong>Program:</strong> ' + r.prog.name + '<br>' +
            '<strong>Office:</strong> ' + r.prog.ofc + '<br>' +
            '<strong>Date:</strong> ' + new Date().toISOString().split('T')[0] + '<br><br>' +
            '<strong>Deficiency:</strong> ' + g.title + '<br>' +
            '<strong>Required Action:</strong> ' + g.action + '<br>' +
            '<strong>Days to Respond:</strong> 14 calendar days<br>' +
            '<strong>Impact if Not Corrected:</strong> ' + formatCost(g.cost) + ' cost risk, ' + g.schedule + ' schedule impact<br>' +
            '<strong>Responsible Party:</strong> ' + g.owner + '<br><br>' +
            '<em>Note: ' + (gaps.length-1) + ' additional CARs may be required for remaining critical gaps.</em>';
    }

    if (/cost|risk|money|budget|expense/.test(q)) {
        return '<strong>Cost & Schedule Risk Summary</strong><br><br>' +
            '\uD83D\uDCB0 Total Estimated Risk: <strong style="color:#ff3333">' + formatCost(r.totalCost) + '</strong><br>' +
            '\u23F0 Schedule Risk: <strong style="color:#ffa500">' + (r.critGaps > 3 ? '6-12 months' : r.critGaps > 0 ? '2-6 months' : '< 2 months') + '</strong><br>' +
            '\uD83D\uDEA8 Critical Path Items: <strong>' + r.critGaps + '</strong><br><br>' +
            'Cost breakdown by ILS element:<br>' +
            r.actions.slice(0,5).map(a => '• ' + a.id + ': ' + formatCost(a.cost) + ' (' + a.title.substring(0,40) + ')').join('<br>') +
            '<br><br>Early resolution typically reduces costs by 30-50% vs. late-stage remediation.';
    }

    if (/missing|di.*number|what.*missing/.test(q)) {
        const missing = r.drlResults.filter(d => !d.found);
        if (!missing.length) return '\u2705 All DRL/CDRL items have been accounted for! No missing DI numbers detected.';
        let resp = '\uD83D\uDCC4 <strong>Missing DI Numbers (' + missing.length + '):</strong><br><br>';
        missing.forEach(d => {
            resp += '• <strong>' + d.di + '</strong> — ' + d.t + (d.c ? ' <span style="color:#ff3333">[CRITICAL]</span>' : '') + '<br>';
        });
        return resp;
    }

    if (/next\s*step|recommend|suggest|what.*should/.test(q)) {
        let resp = '<strong>Recommended Next Steps:</strong><br><br>';
        if (r.critGaps > 0) {
            resp += '1. \uD83D\uDEA8 <strong>Address critical gaps immediately</strong> — ' + r.critGaps + ' items need action before next milestone<br>';
            resp += '2. \uD83D\uDCDD <strong>Issue CARs</strong> for all missing critical deliverables<br>';
            resp += '3. \uD83D\uDCC5 <strong>Schedule ILS Review Board</strong> within 2 weeks to discuss contractor compliance<br>';
            resp += '4. \uD83D\uDCCA <strong>Update program risk register</strong> with ' + formatCost(r.totalCost) + ' estimated impact<br>';
            resp += '5. \u2693 <strong>Anchor this analysis</strong> to XRPL for immutable audit trail<br>';
        } else {
            resp += '1. \u2705 <strong>Review complete package</strong> for final quality check<br>';
            resp += '2. \uD83D\uDD0D <strong>Verify configuration baseline</strong> matches as-built<br>';
            resp += '3. \uD83D\uDCDD <strong>Prepare milestone briefing</strong> with readiness score<br>';
            resp += '4. \u2693 <strong>Anchor final analysis</strong> for permanent record<br>';
        }
        return resp;
    }

    if (/di-?\d+/.test(q)) return explainDINumber(q);

    // ── Custom / Freeform Task Handling ──
    if (/compare|vs|versus|difference/.test(q)) {
        if (!r) return 'Run an analysis first, then ask me to compare programs, phases, or checklists.';
        const elChecked = r.clItems.filter(i=>i.checked).length;
        return '<strong>Comparative Analysis — ' + r.prog.name + '</strong><br><br>' +
            'Current readiness: <strong>' + r.pct + '%</strong><br>' +
            'Checklist completion: ' + elChecked + '/' + r.clItems.length + ' (' + r.clPct + '%)<br>' +
            'DRL coverage: ' + r.drlFound + '/' + r.drlTotal + ' (' + r.drlPct + '%)<br><br>' +
            '<strong>Benchmark Comparison:</strong><br>' +
            '• Industry avg at this phase: ~55-65%<br>' +
            '• Top performers: 80%+<br>' +
            '• Your program: <strong style="color:' + (r.pct>=70?'#14f195':'#ffa500') + '">' + r.pct + '%</strong> (' + (r.pct>=70?'Above':'Below') + ' average)<br><br>' +
            'Tip: Re-run analysis after uploading additional documents to track improvement.';
    }

    if (/write|draft|compose|create|template|memo|email|letter/.test(q)) {
        if (/memo/.test(q)) {
            return '<strong>MEMORANDUM</strong><br><br>' +
                '<strong>FROM:</strong> ILS Program Manager<br>' +
                '<strong>TO:</strong> ' + (r ? r.prog.ofc : 'Program Office') + '<br>' +
                '<strong>SUBJ:</strong> ILS Data Package Status — ' + (r ? r.prog.name : 'Program TBD') + '<br>' +
                '<strong>DATE:</strong> ' + new Date().toISOString().split('T')[0] + '<br><br>' +
                '1. <strong>Purpose:</strong> To provide current status of the Integrated Logistics Support data package and identify outstanding deliverables.' + (r ? '<br><br>2. <strong>Current Status:</strong> Overall readiness stands at ' + r.pct + '% with ' + r.critGaps + ' critical gaps requiring immediate attention. Estimated cost risk is ' + formatCost(r.totalCost) + '.' : '') +
                '<br><br>3. <strong>Recommendation:</strong> ' + (r && r.critGaps > 0 ? 'Schedule review board within 14 days to address critical deficiencies.' : 'Proceed with milestone review as package is substantially complete.') +
                '<br><br><em>Copy/paste and customize as needed.</em>';
        }
        if (/email/.test(q)) {
            return '<strong>Draft Email</strong><br><br>' +
                '<strong>Subject:</strong> ILS Status Update — ' + (r ? r.prog.name + ' (' + r.pct + '%)' : 'Program Update') + '<br><br>' +
                'Team,<br><br>' +
                'Please find below the current ILS data package status' + (r ? ' for ' + r.prog.name : '') + '.<br><br>' +
                (r ? 'Overall Readiness: ' + r.pct + '%<br>Critical Gaps: ' + r.critGaps + '<br>Est. Risk: ' + formatCost(r.totalCost) + '<br><br>' : '') +
                'Action Required: ' + (r && r.critGaps > 0 ? 'Review attached gap analysis and provide updated delivery schedule for outstanding items.' : 'No critical actions required at this time.') +
                '<br><br>V/R,<br>[Your Name]<br><br><em>Customize and send via the "Send Analysis" button above.</em>';
        }
        return 'I can draft several document types for you:<br><br>' +
            '• <strong>"Draft a memo"</strong> — formal memorandum template<br>' +
            '• <strong>"Draft an email"</strong> — status update email<br>' +
            '• <strong>"Draft a CAR"</strong> — Corrective Action Request<br><br>' +
            'Just tell me what type of document you need!';
    }

    if (/explain|what is|what are|define|meaning|describe/.test(q)) {
        if (/ils/.test(q) && !/di-/.test(q)) return '<strong>Integrated Logistics Support (ILS)</strong><br><br>ILS is a disciplined approach that ensures a system, equipment, or platform is supported throughout its lifecycle. The 12 ILS elements are:<br><br>1. ILS Management<br>2. Maintenance Planning<br>3. Supply Support<br>4. Support Equipment<br>5. Technical Data<br>6. Training & Training Support<br>7. Manpower & Personnel<br>8. Computer Resources<br>9. Facilities<br>10. PHS&T (Packaging, Handling, Storage & Transport)<br>11. Design Interface<br>12. Reliability, Availability & Maintainability (RAM)<br><br>Each element must be addressed per DoW 5000 series requirements.';
        if (/cdrl|cdr/.test(q)) return '<strong>Contract Data Requirements List (CDRL)</strong><br><br>A CDRL (DD Form 1423) is the standard format for identifying data deliverables required under a DoW contract. Each CDRL references a Data Item Description (DID) number.<br><br>Key fields: Sequence number, DI number, title, approval authority, distribution, and delivery schedule.';
        if (/drl/.test(q)) return '<strong>Data Requirements List (DRL)</strong><br><br>A DRL is a comprehensive list of all data items required for a program. It tracks the status of each deliverable including submission dates, review status, and approval authority.';
        if (/car|corrective action/.test(q)) return '<strong>Corrective Action Request (CAR)</strong><br><br>A CAR is a formal contractual instrument used to notify a contractor of deficiencies requiring corrective action. It specifies the deficiency, required action, and response timeline (typically 14-30 days).';
        if (/pms/.test(q) && !/pms 300/.test(q)) return '<strong>Planned Maintenance System (PMS)</strong><br><br>Navy PMS provides maintenance standards for all ships and equipment. It includes Maintenance Index Pages (MIPs) and Maintenance Requirement Cards (MRCs) that define scheduled maintenance tasks.';
        if (/cosal|apl/.test(q)) return '<strong>Coordinated Shipboard Allowance List (COSAL)</strong><br><br>COSAL is the Navy\'s system for identifying all repair parts, special tools, and test equipment for shipboard systems. It consists of Allowance Parts Lists (APLs) and Allowance Equipage Lists (AELs).';
        if (/lcsp/.test(q)) return '<strong>Life Cycle Sustainment Plan (LCSP)</strong> — DI-039<br><br>A top-level ILS planning document that defines the sustainment strategy, addresses all 12 ILS elements, establishes performance metrics (Ao, MTBF, MTTR), and is required per DoW Instruction 5000.02.';
        if (/milestone|review/.test(q)) return '<strong>DoW Milestone Reviews</strong><br><br>• <strong>Milestone A:</strong> Material Development Decision — entry to Technology Maturation<br>• <strong>Milestone B:</strong> Entry into Engineering & Manufacturing Development<br>• <strong>Milestone C:</strong> Entry into Production & Deployment<br>• <strong>IOC:</strong> Initial Operational Capability<br>• <strong>FOC:</strong> Full Operational Capability<br><br>ILS deliverables are required at each milestone.';
        // Generic explain handler
        return 'I can explain many ILS and defense logistics terms. Try asking about:<br>' +
            '• <strong>"What is ILS?"</strong><br>• <strong>"Explain CDRL"</strong><br>• <strong>"What is PMS?"</strong><br>• <strong>"Define COSAL"</strong><br>• <strong>"What are milestones?"</strong><br>• Any specific DI number (e.g., "What is DI-009?")';
    }

    if (/checklist|element|coverage|which.*missing|which.*complete/.test(q)) {
        if (!r) return 'Run an analysis first to see checklist details.';
        const missing = r.clItems.filter(i=>!i.checked);
        const complete = r.clItems.filter(i=>i.checked);
        let resp = '<strong>ILS Checklist Status — ' + r.prog.name + '</strong><br><br>';
        resp += '✅ <strong>Complete (' + complete.length + '):</strong><br>';
        complete.slice(0,8).forEach(i => { resp += '• ' + i.l + (i.c?' [CRITICAL]':'') + '<br>'; });
        if (complete.length > 8) resp += '• ...and ' + (complete.length-8) + ' more<br>';
        resp += '<br>❌ <strong>Incomplete (' + missing.length + '):</strong><br>';
        missing.forEach(i => { resp += '• <span style="color:'+(i.c?'#ff3333':'#ffa500')+'">' + i.l + (i.c?' [CRITICAL]':'') + '</span><br>'; });
        return resp;
    }

    if (/schedule|timeline|when|deadline|overdue|late/.test(q)) {
        if (!r) return 'Run an analysis to see schedule risk details.';
        const overdue = r.drlResults.filter(d => d.found && /overdue|late/i.test(d.status));
        let resp = '<strong>Schedule Assessment — ' + r.prog.name + '</strong><br><br>';
        resp += '⏰ Overall Schedule Risk: <strong style="color:#ffa500">' + (r.critGaps > 3 ? '6-12 months' : r.critGaps > 0 ? '2-6 months' : '< 2 months') + '</strong><br>';
        resp += '📊 Critical path items: ' + r.critGaps + '<br><br>';
        if (overdue.length) {
            resp += '⚠️ <strong>Overdue Items (' + overdue.length + '):</strong><br>';
            overdue.forEach(d => { resp += '• ' + d.di + ' — ' + d.t + ' (' + d.status + ')<br>'; });
        }
        resp += '<br><strong>Recommendation:</strong> ' + (r.critGaps > 3 ? 'Immediate intervention required. Consider contract modification or schedule re-baseline.' : r.critGaps > 0 ? 'Address critical items within 30 days to maintain schedule.' : 'Schedule risk is manageable. Continue monitoring.');
        return resp;
    }

    if (/report|generate|export|download/.test(q)) {
        return '📄 <strong>Available Reports & Exports:</strong><br><br>' +
            '• <strong>"Generate Report"</strong> button — Downloads a full text report<br>' +
            '• <strong>"Export Action Tracker"</strong> — CSV of all action items with owners/dates<br>' +
            '• <strong>"Anchor Report Hash"</strong> — Immutable XRPL proof of analysis<br>' +
            '• <strong>"Send Analysis"</strong> — Email summary to stakeholders<br>' +
            '• <strong>"Copy to Clipboard"</strong> — Quick text summary<br><br>' +
            'Use the buttons above the chat to access any of these. Need a custom report format? Just describe what you need!';
    }

    // ── New Tool Topic Matchers (vault, docs, compliance, provisioning) ──
    if (/vault|audit.*record|audit.*trail|audit.*vault|anchored.*record/.test(q)) {
        const vault = JSON.parse(localStorage.getItem('s4_audit_vault') || '[]');
        let resp = '<strong>🔒 Audit Record Vault</strong><br><br>';
        if (vault.length > 0) {
            resp += 'Your vault contains <strong>' + vault.length + ' records</strong>.<br>';
            const types = [...new Set(vault.map(v => v.type || 'Unknown'))];
            resp += 'Record types: ' + types.join(', ') + '<br>';
            resp += 'Latest entry: ' + (vault[vault.length-1].timestamp || 'Unknown') + '<br><br>';
        } else {
            resp += 'Your vault is currently empty. Records will appear here automatically as you anchor them from any tool.<br><br>';
        }
        resp += 'The vault stores every anchored record with its SHA-256 hash, content preview, timestamp, and XRPL TX Hash. You can:<br>';
        resp += '• <strong>Re-verify</strong> any record with one click<br>';
        resp += '• <strong>Export</strong> as CSV/XLSX for compliance audits<br>';
        resp += '• <strong>Search/filter</strong> by type, date, or content<br><br>';
        resp += 'Click the <strong>Audit Vault</strong> tab to view your records.';
        return resp;
    }

    if (/compliance.*score|cmmc|nist.*800|dfars.*252|compliance.*posture|compliance.*card|compliance.*grade/.test(q)) {
        let resp = '<strong>🛡️ Compliance Scorecard</strong><br><br>';
        resp += 'Your compliance posture is auto-calculated across 6 frameworks based on your workspace activity:<br><br>';
        resp += '• <strong>CMMC Level 2</strong> — Cybersecurity maturity<br>';
        resp += '• <strong>NIST SP 800-171</strong> — CUI protection controls<br>';
        resp += '• <strong>DFARS 252.204-7012</strong> — Covered defense information<br>';
        resp += '• <strong>FAR 46 Quality</strong> — Quality assurance clauses<br>';
        resp += '• <strong>MIL-STD-1388 ILS</strong> — Logistics support analysis<br>';
        resp += '• <strong>DoDI 4245.15 DMSMS</strong> — Obsolescence management<br><br>';
        resp += 'Every record you anchor, DMSMS case you track, and readiness calculation you run improves your score. Click the <strong>Compliance</strong> tab to see your current grade.';
        return resp;
    }

    if (/defense.*doc|doc.*library|mil-std|opnavinst|regulation|standard.*reference|mil-hdbk|browse.*doc/.test(q)) {
        return '<strong>📚 Defense Document Library</strong><br><br>Your workspace includes a searchable library of <strong>100+ real defense documents</strong>:<br><br>• MIL-STD-1388, MIL-STD-882, MIL-STD-461<br>• MIL-HDBK-502, MIL-HDBK-217<br>• OPNAVINST 4790.16, OPNAVINST 5100.19<br>• COMDTINST M4000.13, COMDTINST M3500.3<br>• AR 700-127, AR 750-1<br>• AFI 63-101, AFI 20-110<br>• MCO 4105.2, MCO 4400.150<br>• DFARS 252.204-7012, FAR 46<br>• NIST SP 800-171, NIST SP 800-53<br><br>Filter by category, branch, or full-text search. Click any document for the official source link.<br><br>Click the <strong>Doc Library</strong> tab to browse.';
    }

    if (/provision|ptd|provisioning.*tech|allowance.*part|apl.*gen|catalog|icaps|lmi|logistics.*product|ppd|provisioning.*part/.test(q)) {
        return '<strong>📦 Provisioning & ICAPS Comparison</strong><br><br>S4 Ledger provides provisioning capabilities that surpass legacy tools like ICAPS:<br><br><strong>ICAPS limitations:</strong><br>• Navy/Marine Corps only<br>• Covers only Supply Support IPS element<br>• Mainframe + PC architecture<br>• No blockchain verification<br>• No compliance scoring<br><br><strong>S4 Ledger advantages:</strong><br>• <strong>All branches</strong> — Joint, Navy, Army, AF, USMC, CG, Space Force<br>• <strong>All 12 ILS elements</strong> — not just Supply Support<br>• <strong>Blockchain-verified</strong> — every provisioning decision anchored to XRPL<br>• <strong>Integrated</strong> — provisioning ties to DMSMS, readiness, lifecycle cost, warranty<br>• <strong>Compliance tracking</strong> — CMMC, NIST, DFARS scoring built-in<br>• <strong>Modern web platform</strong> — no mainframe required<br><br>Use the <strong>Parts</strong> tab for cross-reference and the <strong>Gap Analysis</strong> to track provisioning deliverables (DI-020 VRS, DI-021 APL).';
    }

    if (/thank|thanks|great|awesome|perfect|good/.test(q)) {
        return '🎯 Happy to help! Remember you can:<br>• Upload additional documents anytime to re-run analysis<br>• Ask me about any DI number, ILS term, or defense acronym<br>• Request drafts of memos, emails, or CARs<br>• Get schedule/cost analysis at any time';
    }

    // ── Intelligent Conversational Handler ──
    // Build context from conversation history and analysis state
    const recentHistory = aiConversationHistory.slice(-6).filter(h => h.role === 'user').map(h => h.text.toLowerCase());
    const prog = r ? r.prog : (PROGS[document.getElementById('ilsProgram')?.value] || null);
    const progName = prog ? prog.name : 'your program';
    const comp = PROG_COMPONENTS ? PROG_COMPONENTS[document.getElementById('ilsProgram')?.value] : null;

    // Detect if this is a follow-up to a previous topic
    const lastBotMsg = aiConversationHistory.filter(h => h.role === 'bot').slice(-1)[0];
    const isFollowUp = recentHistory.length > 1;

    // Topic detection for freeform questions
    if (/how\s*(do|can|should|would|to)\b/.test(q)) {
        // "How do I..." questions — provide actionable guidance
        if (/submit|deliver|send|upload/.test(q)) return 'To submit deliverables for <strong>' + progName + '</strong>:<br><br>1. Ensure your document meets the DI format requirements specified in your contract DRL<br>2. Include the CDRL sequence number and DI number on the cover page<br>3. Submit through the designated portal (eCDRL for NAVSEA contracts, or per your contract\'s Section H)<br>4. Track status using the DRL tracker — upload it here for gap analysis<br><br>' + (r ? 'Your current analysis shows ' + r.drlFound + '/' + r.drlTotal + ' items submitted.' : 'Run an analysis to see your current submission status.');
        if (/fix|correct|resolve|address/.test(q)) return r && r.critGaps > 0 ? 'To address your <strong>' + r.critGaps + ' critical gaps</strong> in ' + progName + ':<br><br>' + r.actions.filter(a=>a.severity==='critical').slice(0,4).map((a,i) => '<strong>' + (i+1) + '.</strong> ' + a.title + '<br>&nbsp;&nbsp;&nbsp;→ ' + a.action + ' (Owner: ' + a.owner + ')<br>').join('') + '<br>Start with the highest-cost items first — early intervention typically saves 30-50%.' : 'Run an analysis first to identify gaps, then I can walk you through how to resolve each one.';
        if (/improve|increase|boost|raise/.test(q)) return 'To improve your ILS readiness score' + (r ? ' (currently <strong>' + r.pct + '%</strong>)' : '') + ':<br><br>1. <strong>Complete missing checklist items</strong> — each critical item significantly impacts your score<br>2. <strong>Submit outstanding CDRLs</strong> — DRL coverage is 40% of your overall score<br>3. <strong>Prioritize critical items first</strong> — they have 2x weight in scoring<br>4. <strong>Upload documents</strong> to auto-detect completed items<br>5. <strong>Re-run analysis</strong> after each update to track progress<br><br>' + (r ? 'Focus area: ' + (r.clPct < r.drlPct ? 'Your checklist score (' + r.clPct + '%) is lower than DRL coverage (' + r.drlPct + '%). Complete checklist items first.' : 'Your DRL coverage (' + r.drlPct + '%) needs attention. Submit missing deliverables.') : '');
        if (/track|monitor|status/.test(q)) return 'For tracking ILS status on <strong>' + progName + '</strong>:<br><br>• <strong>This tool:</strong> Upload documents anytime and re-run analysis — your readiness score updates in real-time<br>• <strong>Export Action Tracker:</strong> Click the "Update Action Tracker" button after analysis to get a CSV you can share with your team<br>• <strong>Anchor Reports:</strong> Click "Anchor Report Hash" to create an immutable XRPL timestamp — useful for proving when assessments were completed<br>• <strong>Schedule Reviews:</strong> Use "Schedule Meeting" to set up ILS Review Board meetings with your team';
        return 'Great question! Here\'s what I\'d recommend for <strong>' + progName + '</strong>:<br><br>' + (r ? 'Based on your current <strong>' + r.pct + '%</strong> readiness with ' + r.critGaps + ' critical gaps and ' + formatCost(r.totalCost) + ' at risk, I\'d suggest:<br><br>1. Address critical gaps immediately (owner assignments are in the Action Items panel)<br>2. Schedule an ILS Review Board within 2 weeks<br>3. Update your program risk register with the identified impacts<br>4. Re-run this analysis after corrective actions are taken<br><br>Want me to draft a memo, email, or CAR for any specific item?' : 'Upload your documents and run an analysis first — then I can give you specific, data-driven recommendations.');
    }

    // "What about..." / "Tell me about..." / freeform queries
    if (/what about|tell me|can you|elaborate|more (about|on|info)|detail/.test(q) || isFollowUp) {
        // Try to connect to previous context
        if (lastBotMsg && /critical|gap|missing|action/.test(lastBotMsg.text)) {
            if (r && r.actions.length) {
                const nextAction = r.actions[Math.min(r.actions.length-1, recentHistory.length)];
                return 'Continuing from our discussion — here\'s more detail on <strong>' + nextAction.id + '</strong>:<br><br>' +
                    '<strong>Item:</strong> ' + nextAction.title + '<br>' +
                    '<strong>Required Action:</strong> ' + nextAction.action + '<br>' +
                    '<strong>Owner:</strong> ' + nextAction.owner + (nextAction.secondary ? ' (Coord: ' + nextAction.secondary + ')' : '') + '<br>' +
                    '<strong>Est. Cost:</strong> ' + formatCost(nextAction.cost) + '<br>' +
                    '<strong>Timeline:</strong> ' + nextAction.schedule + '<br><br>' +
                    'Would you like me to draft a CAR for this item, or move to the next action item?';
            }
        }
    }

    // Catch-all: actually try to respond intelligently based on keywords in the query
    if (/why|reason|cause|because/.test(q)) {
        return r ? 'Based on the analysis of <strong>' + progName + '</strong>:<br><br>' +
            'Readiness is at <strong>' + r.pct + '%</strong> primarily because:<br>' +
            (r.critGaps > 0 ? '• <strong>' + r.critGaps + ' critical ILS elements</strong> are missing from your data package<br>' : '') +
            (r.drlPct < 80 ? '• <strong>DRL coverage is only ' + r.drlPct + '%</strong> — ' + (r.drlTotal - r.drlFound) + ' deliverables haven\'t been submitted or detected<br>' : '') +
            (r.clPct < 80 ? '• <strong>Checklist completion is ' + r.clPct + '%</strong> — key logistics elements need verification<br>' : '') +
            '<br>The biggest cost driver is typically late-stage gap discovery. Addressing issues now versus during T&E saves an average of 40% in remediation costs.' :
            'I\'d need analysis results to explain specifics. Run an analysis and I can explain exactly what\'s driving your readiness score.';
    }

    if (/who|responsible|owner|point of contact|poc/.test(q)) {
        if (r && r.actions.length) {
            const ownerMap = {};
            r.actions.forEach(a => { ownerMap[a.owner] = (ownerMap[a.owner] || 0) + 1; });
            let resp = '<strong>Responsibility Breakdown for ' + progName + ':</strong><br><br>';
            Object.entries(ownerMap).sort((a,b) => b[1]-a[1]).forEach(([owner, count]) => {
                resp += '• <strong>' + owner + '</strong>: ' + count + ' action item' + (count>1?'s':'') + '<br>';
            });
            resp += '<br>The primary coordinating office is <strong>' + (r.prog.ofc || 'the Program Office') + '</strong>.';
            return resp;
        }
        return 'Run an analysis to see the ownership breakdown for each action item. Each gap is assigned to a responsible party based on the ILS element it falls under.';
    }

    if (/when|deadline|due|timeline|milestone/.test(q) && !(/schedule/.test(q))) {
        const phase = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || 'current phase';
        return 'For <strong>' + progName + '</strong> in <strong>' + phase + '</strong>:<br><br>' +
            '<strong>Key ILS Milestones:</strong><br>' +
            '• Pre-Award: ILS Plan, preliminary provisioning data<br>' +
            '• Preliminary Design Review (PDR): LORA, FMECA, initial support concept<br>' +
            '• Critical Design Review (CDR): Complete LSAR, draft tech manuals, training plan<br>' +
            '• Production: VRS/buylist, COSAL/APL data, MRC validation<br>' +
            '• Test & Evaluation: TEMP execution, T&E support, crew familiarization<br>' +
            '• Delivery: Complete tech manuals, transfer book, final provisioning<br><br>' +
            (r ? 'Your current readiness of <strong>' + r.pct + '%</strong> ' + (r.pct >= 70 ? 'is tracking well for this phase.' : 'suggests some deliverables may be behind schedule. Review the Action Items for specific due dates.') : 'Upload documents and run analysis to see where you stand against milestone requirements.');
    }

    // If the user typed something conversational that doesn't match patterns
    if (q.length < 15 && /^(yes|no|ok|sure|go|please|yeah|yep|nope|thanks|ty|thx|k|cool|nice)/.test(q)) {
        if (/yes|sure|go|please|yeah|yep/.test(q)) {
            // Affirmative — continue from last topic
            if (lastBotMsg && /draft.*car|corrective/i.test(lastBotMsg.text) && r && r.actions.length) {
                const g = r.actions.filter(a=>a.severity==='critical')[0] || r.actions[0];
                return '<strong>CAR Generated:</strong><br><br>' +
                    '<strong>CAR-' + (r.progKey||'PROG').toUpperCase() + '-' + new Date().getFullYear() + '-001</strong><br>' +
                    'Deficiency: ' + g.title + '<br>' +
                    'Action Required: ' + g.action + '<br>' +
                    'Response Due: 14 calendar days<br>' +
                    'Impact: ' + formatCost(g.cost) + ' cost risk<br>' +
                    'Owner: ' + g.owner;
            }
            return 'Got it! What would you like me to help with next? I can draft documents, explain terms, analyze gaps, or provide recommendations for <strong>' + progName + '</strong>.';
        }
        if (/no|nope/.test(q)) return 'No problem. Feel free to ask me anything else about your ILS data package, or try one of the quick buttons below.';
        if (/thanks|ty|thx/.test(q)) return 'Happy to help! Let me know if you need anything else. Remember you can upload additional documents anytime and re-run analysis to track progress.';
        return 'Sure thing — what else can I help you with?';
    }

    // True freeform fallback — actually address the user's question contextually
    let response = '';
    if (r) {
        response = 'Regarding "<em>' + query + '</em>" — here\'s what I can tell you about <strong>' + progName + '</strong>:<br><br>';
        response += '📊 Current readiness: <strong>' + r.pct + '%</strong> | Critical gaps: <strong>' + r.critGaps + '</strong> | Risk: <strong>' + formatCost(r.totalCost) + '</strong><br><br>';
        if (r.critGaps > 0) {
            response += 'Your top priority should be addressing the <strong>' + r.critGaps + ' critical items</strong>. The most urgent is <strong>' + r.actions[0].title + '</strong> (Owner: ' + r.actions[0].owner + ').<br><br>';
        }
        response += 'I can help you with this question in several ways — try being more specific:<br>';
        response += '• Ask about a specific <strong>DI number</strong> or <strong>ILS element</strong><br>';
        response += '• Say <strong>"draft a memo about [topic]"</strong> and I\'ll write one<br>';
        response += '• Ask <strong>"who is responsible for [item]?"</strong><br>';
        response += '• Ask <strong>"how do I fix [specific gap]?"</strong><br>';
        response += '• Ask <strong>"why is my score [low/high]?"</strong>';
    } else {
        response = 'I\'d be happy to help with "<em>' + query + '</em>"!<br><br>';
        response += 'To give you the best answer, I need some context. Here\'s how to get started:<br><br>';
        response += '1. <strong>Select a program</strong> from the dropdown above<br>';
        response += '2. <strong>Upload your documents</strong> (DRLs, spreadsheets, checklists)<br>';
        response += '3. <strong>Run Full Analysis</strong> to generate results<br><br>';
        response += 'Then ask me anything — I\'ll give you specific, data-driven answers about gaps, costs, schedules, and next steps.<br><br>';
        response += 'In the meantime, I can explain any <strong>ILS term</strong>, <strong>DI number</strong>, or <strong>defense acronym</strong> — just ask!';
    }
    return response;
}

function explainDINumber(q) {
    const match = q.match(/di-?0*(\d+)/i);
    if (!match) return 'Please specify a DI number (e.g., DI-009, DI-020).';
    const num = parseInt(match[1]);
    const diInfo = {
        1: {t:'Contract Data Requirements List (CDRL)', desc:'Master list of all contractual deliverables. References MIL-STD-1808.'},
        2: {t:'SOW Compliance Matrix', desc:'Maps SOW paragraphs to contractor compliance status.'},
        3: {t:'Integrated Master Schedule (IMS)', desc:'High-level program schedule linking all logistics milestones.'},
        4: {t:'Systems Engineering Plan (SEP)', desc:'Systems engineering approach and design review gates.'},
        5: {t:'Interface Control Document (ICD)', desc:'Defines all system interfaces (mechanical, electrical, data).'},
        6: {t:'Test & Evaluation Master Plan (TEMP)', desc:'Comprehensive T&E strategy per DoWI 5000.89.'},
        7: {t:'Weight Report', desc:'Weight accounting for hull margins, stability compliance.'},
        8: {t:'Electrical Load Analysis', desc:'Power generation vs. demand analysis for all ship conditions.'},
        9: {t:'Purchase Order Index', desc:'Tracks all subcontract and material purchase orders. Essential for schedule management and GFM coordination.'},
        10: {t:'Long Lead Time Material List', desc:'Items with procurement lead > 6 months. Critical for schedule risk.'},
        11: {t:'Government Furnished Material (GFM) List', desc:'All GFM items the government must provide to the contractor.'},
        12: {t:'HazMat List', desc:'Hazardous material inventory per environmental compliance requirements.'},
        20: {t:'Vendor Recommended Spares (VRS)', desc:'Manufacturer-recommended spare parts for initial provisioning. Basis for COSAL/APL development. Critical for post-delivery readiness.'},
        21: {t:'Allowance Parts List (APL)', desc:'Authorized shipboard spare parts inventory (COSAL).'},
        31: {t:'IUID Register', desc:'Item Unique Identification per MIL-STD-130. Tracks serially-managed components.'},
        32: {t:'Maintenance Requirement Cards (MRCs)', desc:'Planned maintenance task cards per Navy PMS system.'},
        39: {t:'Life Cycle Sustainment Plan (LCSP)', desc:'Top-level sustainment strategy addressing all 12 ILS elements.'},
        41: {t:'Machinery Equipment List (MEL)', desc:'Complete listing of installed machinery and equipment, including manufacturer, model, and location.'},
        44: {t:'Spares Buylist / Initial Outfitting', desc:'Initial provisioning purchase list for pre-delivery outfitting.'}
    };
    const info = diInfo[num];
    if (info) return '<strong>DI-' + String(num).padStart(3,'0') + ': ' + info.t + '</strong><br><br>' + info.desc;
    return 'DI-' + String(num).padStart(3,'0') + ' — I don\'t have detailed information on that specific DI number. Common PMS 300 DI numbers range from DI-001 (CDRL) through DI-044 (Spares Buylist). Ask about one of those!';
}

// ═══ DMSMS / OBSOLESCENCE TRACKER ═══
const DMSMS_DATA = {};
function generateDMSMSData(progKey) {
    const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
    const statuses = ['Active','Active','Active','At Risk','At Risk','Obsolete','End of Life','Active','Watch','Active'];
    const severities = ['None','None','None','High','Medium','Critical','High','None','Low','None'];
    const resolutions = ['N/A','N/A','N/A','Seeking alternate source','Life-of-type buy planned','Bridge buy + redesign required','Last-time buy submitted','N/A','Monitoring vendor status','N/A'];
    const leadTimes = [12,8,16,26,18,52,36,10,14,6];
    const costs = [0,0,0,245,85,890,320,0,45,0];
    const alternates = ['—','—','—','2 qualified alternates identified','1 partial alternate','No direct alternate — redesign needed','OEM end-of-life, 1 aftermarket','—','1 alternate under qualification','—'];
    const endDates = ['—','—','—','2027-Q3','2028-Q1','2026-Q4 (CRITICAL)','2027-Q1','—','2029+','—'];
    return comp.systems.map((sys, i) => ({
        system: sys,
        nsn: comp.nsns[i],
        manufacturer: comp.mfgs[i],
        status: statuses[i % statuses.length],
        severity: severities[i % severities.length],
        resolution: resolutions[i % resolutions.length],
        leadTime: leadTimes[i % leadTimes.length],
        cost: costs[i % costs.length],
        alternate: alternates[i % alternates.length],
        endOfSupport: endDates[i % endDates.length]
    }));
}

function loadDMSMSData() {
    const progKey = document.getElementById('dmsmsProgram').value;
    const data = generateDMSMSData(progKey);
    const atRisk = data.filter(d => d.status !== 'Active').length;
    const resolved = data.filter(d => d.status === 'Active').length;
    const totalCost = data.reduce((s,d) => s + d.cost, 0);
    
    document.getElementById('dmsmsTotalParts').textContent = data.length;
    document.getElementById('dmsmsAtRisk').textContent = atRisk;
    document.getElementById('dmsmsResolved').textContent = resolved;
    document.getElementById('dmsmsCost').textContent = totalCost >= 1000 ? '$' + (totalCost/1000).toFixed(1) + 'M' : '$' + totalCost + 'K';

    const statusColors = {Active:'#14f195','At Risk':'#ffa500',Obsolete:'#ff3333','End of Life':'#ff6666',Watch:'#ffcc00'};
    let html = '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:0.82rem;">';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.1);color:var(--steel);"><th style="padding:8px;text-align:left;">System</th><th>NSN</th><th>Manufacturer</th><th>Status</th><th>Severity</th><th>Lead Time</th><th>Est. Cost</th><th>Alternate</th><th>End of Support</th></tr>';
    data.forEach(d => {
        const color = statusColors[d.status] || '#fff';
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">';
        html += '<td style="padding:8px;color:#fff;font-weight:600;">' + d.system + '</td>';
        html += '<td style="padding:8px;color:var(--steel);font-family:monospace;font-size:0.78rem;">' + d.nsn + '</td>';
        html += '<td style="padding:8px;color:var(--steel);">' + d.manufacturer + '</td>';
        html += '<td style="padding:8px;"><span style="color:' + color + ';font-weight:600;">' + d.status + '</span></td>';
        html += '<td style="padding:8px;color:' + (d.severity==='Critical'?'#ff3333':d.severity==='High'?'#ff9900':d.severity==='Medium'?'#ffcc00':d.severity==='Low'?'#66ccff':'var(--steel)') + ';">' + d.severity + '</td>';
        html += '<td style="padding:8px;color:var(--steel);">' + d.leadTime + ' wks</td>';
        html += '<td style="padding:8px;color:' + (d.cost > 0 ? '#ffa500' : 'var(--steel)') + ';">' + (d.cost > 0 ? '$' + d.cost + 'K' : '—') + '</td>';
        html += '<td style="padding:8px;color:var(--steel);font-size:0.78rem;">' + d.alternate + '</td>';
        html += '<td style="padding:8px;color:' + (d.endOfSupport.includes('CRITICAL') ? '#ff3333' : 'var(--steel)') + ';">' + d.endOfSupport + '</td>';
        html += '</tr>';
    });
    html += '</table></div>';
    document.getElementById('dmsmsResults').innerHTML = html;
    // Generate action items & notifications
    generateDMSMSActions(progKey, data);
}

function exportDMSMS() {
    const progKey = document.getElementById('dmsmsProgram').value;
    const data = generateDMSMSData(progKey);
    let csv = 'System,NSN,Manufacturer,Status,Severity,Lead Time (wks),Est Cost ($K),Alternate,End of Support\n';
    data.forEach(d => { csv += '"' + d.system + '",' + d.nsn + ',"' + d.manufacturer + '",' + d.status + ',' + d.severity + ',' + d.leadTime + ',' + d.cost + ',"' + d.alternate + '",' + d.endOfSupport + '\n'; });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'DMSMS_Report_' + progKey.toUpperCase() + '.csv'; a.click();
}

async function anchorDMSMS() {
    const progKey = document.getElementById('dmsmsProgram').value;
    const data = generateDMSMSData(progKey);
    const text = 'DMSMS Report | Program: ' + progKey + ' | Parts: ' + data.length + ' | At Risk: ' + data.filter(d=>d.status!=='Active').length + ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'DMSMS Report', 'CUI');
    stats.anchored++; stats.types.add('DMSMS_REPORT'); stats.slsFees += 0.01; updateStats(); saveStats();
    const txHash_d = 'TX'+Date.now().toString(16).toUpperCase();
    const rec = {hash, type:'DMSMS_REPORT', branch:'JOINT', timestamp:new Date().toISOString(), label:'DMSMS Obsolescence Report', txHash:txHash_d};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'DMSMS_REPORT', record_label:'DMSMS Obsolescence Report', branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash_d, system:'DMSMS Tracker'});
    updateTxLog();
    addToVault({hash, txHash:'TX'+Date.now().toString(16).toUpperCase(), type:'DMSMS_REPORT', label:'DMSMS Obsolescence Report', branch:'JOINT', icon:'⚠️', content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'DMSMS Tracker', fee:0.01});
    setTimeout(() => { document.getElementById('animStatus').textContent = '✅ DMSMS report anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
}

// ═══ OPERATIONAL READINESS CALCULATOR ═══
// Proxy to S4 Platforms DB — readiness data generated for all 462 platforms
const READINESS_DEFAULTS = new Proxy({}, {
    get(_, k) { if (typeof k !== 'string') return undefined; return window.S4_getReadiness ? S4_getReadiness(k) : [{sys:'System',mtbf:1000,mttr:4,mldt:24}]; },
    has(_, k) { return typeof k === 'string'; },
    ownKeys() { return window.S4_PLATFORMS ? Object.keys(S4_PLATFORMS) : []; },
    getOwnPropertyDescriptor(_, k) { return {configurable:true, enumerable:true, value: window.S4_getReadiness ? S4_getReadiness(k) : undefined}; }
});

function loadReadinessData() {
    const progKey = document.getElementById('readinessProgram').value;
    const systems = READINESS_DEFAULTS[progKey] || READINESS_DEFAULTS.ddg51;
    const sel = document.getElementById('readinessSystem');
    sel.innerHTML = systems.map((s,i) => '<option value="' + i + '">' + s.sys + '</option>').join('');
    // Load first system defaults
    const first = systems[0];
    document.getElementById('inputMTBF').value = first.mtbf;
    document.getElementById('inputMTTR').value = first.mttr;
    document.getElementById('inputMLDT').value = first.mldt;
    calcReadiness();
}

function calcReadiness() {
    const mtbf = parseFloat(document.getElementById('inputMTBF').value) || 0;
    const mttr = parseFloat(document.getElementById('inputMTTR').value) || 0;
    const mldt = parseFloat(document.getElementById('inputMLDT').value) || 0;
    
    if (mtbf <= 0) {
        document.getElementById('readinessOutput').innerHTML = '<div style="color:var(--steel);font-style:italic;">Enter MTBF value to calculate readiness metrics.</div>';
        return;
    }

    const ao = mtbf / (mtbf + mttr + mldt);
    const ai = mtbf / (mtbf + mttr);
    const lambda = 1 / mtbf;
    const missionHours = 720; // 30-day mission
    const missionReliability = Math.exp(-lambda * missionHours);
    const annualFailures = 8760 / mtbf;
    const annualDowntime = annualFailures * (mttr + mldt);
    const annualUptime = 8760 - annualDowntime;

    document.getElementById('statAo').textContent = (ao * 100).toFixed(1) + '%';
    document.getElementById('statAo').style.color = ao >= 0.9 ? '#14f195' : ao >= 0.75 ? '#ffa500' : '#ff3333';
    document.getElementById('statAi').textContent = (ai * 100).toFixed(1) + '%';
    document.getElementById('statFailRate').textContent = lambda.toFixed(6) + '/hr';
    document.getElementById('statMissReady').textContent = (missionReliability * 100).toFixed(1) + '%';

    const progKey = document.getElementById('readinessProgram').value;
    const sysIdx = parseInt(document.getElementById('readinessSystem').value) || 0;
    const systems = READINESS_DEFAULTS[progKey] || READINESS_DEFAULTS.ddg51;
    const sysName = systems[sysIdx] ? systems[sysIdx].sys : 'System';

    let html = '<div style="background:rgba(0,170,255,0.05);border:1px solid rgba(0,170,255,0.2);border-radius:12px;padding:16px;font-size:0.85rem;">';
    html += '<div style="font-weight:700;color:#00aaff;margin-bottom:10px;font-size:1rem;">📊 RAM Analysis: ' + sysName + '</div>';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">';
    html += '<div><strong>Operational Availability (Ao):</strong></div><div style="color:' + (ao>=0.9?'#14f195':ao>=0.75?'#ffa500':'#ff3333') + ';font-weight:700;">' + (ao*100).toFixed(2) + '%</div>';
    html += '<div><strong>Inherent Availability (Ai):</strong></div><div style="color:#fff;">' + (ai*100).toFixed(2) + '%</div>';
    html += '<div><strong>Failure Rate (λ):</strong></div><div style="color:#fff;">' + lambda.toFixed(6) + ' failures/hr</div>';
    html += '<div><strong>30-Day Mission Reliability:</strong></div><div style="color:' + (missionReliability>=0.8?'#14f195':'#ffa500') + ';">' + (missionReliability*100).toFixed(1) + '%</div>';
    html += '<div><strong>Est. Annual Failures:</strong></div><div style="color:#fff;">' + annualFailures.toFixed(1) + '</div>';
    html += '<div><strong>Est. Annual Downtime:</strong></div><div style="color:' + (annualDowntime<500?'#14f195':'#ff9900') + ';">' + annualDowntime.toFixed(0) + ' hrs (' + (annualDowntime/24).toFixed(1) + ' days)</div>';
    html += '<div><strong>Est. Annual Uptime:</strong></div><div style="color:#14f195;">' + annualUptime.toFixed(0) + ' hrs</div>';
    html += '</div>';

    // Assessment
    html += '<div style="margin-top:12px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">';
    if (ao >= 0.95) html += '<span style="color:#14f195;font-weight:700;">✅ EXCELLENT</span> — System exceeds readiness requirements. Ao > 95% meets most high-priority program thresholds.';
    else if (ao >= 0.90) html += '<span style="color:#14f195;font-weight:700;">✅ MEETS REQUIREMENTS</span> — Ao > 90% is acceptable for most defense programs. Monitor MLDT for improvement opportunities.';
    else if (ao >= 0.80) html += '<span style="color:#ffa500;font-weight:700;">⚠️ MARGINAL</span> — Ao between 80-90%. Consider reducing MLDT through pre-positioned spares or improving MTTR via better training/tools.';
    else if (ao >= 0.70) html += '<span style="color:#ff9900;font-weight:700;">⚠️ BELOW THRESHOLD</span> — Ao below 80%. Recommend: (1) LSA review of failure modes, (2) spares stocking analysis, (3) MTTR reduction plan.';
    else html += '<span style="color:#ff3333;font-weight:700;">🔴 CRITICAL</span> — Ao below 70% indicates significant readiness risk. Immediate corrective action required: DMSMS review, redesign consideration, enhanced depot support.';
    html += '</div>';

    // Formula reference
    html += '<div style="margin-top:10px;font-size:0.78rem;color:var(--steel);">';
    html += '<strong>Formulas:</strong> Ao = MTBF/(MTBF+MTTR+MLDT) | Ai = MTBF/(MTBF+MTTR) | λ = 1/MTBF | R(t) = e<sup>−λt</sup>';
    html += '</div></div>';

    document.getElementById('readinessOutput').innerHTML = html;
    // Generate readiness action items
    generateReadinessActions(progKey, sysName, ao, mtbf, mttr, mldt);
}

function exportReadiness() {
    const mtbf = parseFloat(document.getElementById('inputMTBF').value) || 0;
    const mttr = parseFloat(document.getElementById('inputMTTR').value) || 0;
    const mldt = parseFloat(document.getElementById('inputMLDT').value) || 0;
    const ao = mtbf / (mtbf + mttr + mldt);
    const ai = mtbf / (mtbf + mttr);
    const progKey = document.getElementById('readinessProgram').value;
    let csv = 'Metric,Value\nProgram,' + progKey + '\nMTBF (hrs),' + mtbf + '\nMTTR (hrs),' + mttr + '\nMLDT (hrs),' + mldt + '\nAo (%),' + (ao*100).toFixed(2) + '\nAi (%),' + (ai*100).toFixed(2) + '\nFailure Rate,' + (1/mtbf).toFixed(6) + '\n';
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'RAM_Report_' + progKey.toUpperCase() + '.csv'; a.click();
}

async function anchorReadiness() {
    const mtbf = parseFloat(document.getElementById('inputMTBF').value) || 0;
    const mttr = parseFloat(document.getElementById('inputMTTR').value) || 0;
    const mldt = parseFloat(document.getElementById('inputMLDT').value) || 0;
    const ao = mtbf / (mtbf + mttr + mldt);
    const progKey = document.getElementById('readinessProgram').value;
    const text = 'RAM Report | Program: ' + progKey + ' | Ao: ' + (ao*100).toFixed(2) + '% | MTBF: ' + mtbf + ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'RAM Readiness Report', 'CUI');
    stats.anchored++; stats.types.add('RAM_REPORT'); stats.slsFees += 0.01; updateStats(); saveStats();
    const txHash_r = 'TX'+Date.now().toString(16).toUpperCase();
    const rec = {hash, type:'RAM_REPORT', branch:'JOINT', timestamp:new Date().toISOString(), label:'RAM Readiness Report', txHash:txHash_r};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'RAM_REPORT', record_label:'RAM Readiness Report', branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash_r, system:'Readiness Calculator'});
    updateTxLog();
    addToVault({hash, txHash:'TX'+Date.now().toString(16).toUpperCase(), type:'RAM_REPORT', label:'RAM Readiness Report', branch:'JOINT', icon:'📊', content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Readiness Calculator', fee:0.01});
    setTimeout(() => { document.getElementById('animStatus').textContent = '✅ RAM report anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
}

// ═══ NSN / PARTS CROSS-REFERENCE ═══
function buildPartsDatabase() {
    const parts = [];
    const fscGroups = {1005:'Guns',1240:'Optical Sighting',1270:'Aircraft Armament',1410:'Guided Missiles',1440:'Launchers',1560:'Airframe Structural',1615:'Helicopter Rotor',1620:'Landing Gear',1680:'Aircraft Components',2010:'Ship/Marine Propulsion',2040:'Marine Hardware',2520:'Vehicular Transmission',2530:'Brake/Steering/Axle',2815:'Diesel Engines',2835:'Gas Turbine/Jet Engines',2840:'Gas Turbine/Jet Components',2910:'Fuel System Components',2915:'Fuel Tanks',3040:'Hydraulic Cylinders',3950:'Winches/Hoists',4120:'HVAC',4140:'Fans/Blowers',4210:'Fire Fighting',4240:'Safety/Rescue',4320:'Pumps',4610:'Water Treatment',4910:'Maintenance Equipment',4920:'Aircraft Maintenance',5340:'Misc Hardware',5820:'Radio/TV Comm',5826:'Crypto Equipment',5831:'Intercommunication',5841:'Radar Equipment',5845:'Underwater Sound',5855:'Night Vision',5860:'Stimulated Coherent Radiation',5865:'Electronic Countermeasures',5895:'Intercept/Direction Finding',5985:'Antennas',6110:'Electrical Control',6115:'Generators',6130:'Converters',6210:'Lighting',6605:'Navigation',6610:'Flight Instruments',6645:'Time Measuring',6650:'Optical Instruments',7050:'ADP Components',7310:'Food Prep Equipment',9310:'Nuclear Reactors'};
    
    Object.entries(PROG_COMPONENTS).forEach(([progKey, comp]) => {
        if (progKey === 'custom') return;
        comp.systems.forEach((sys, i) => {
            const nsn = comp.nsns[i];
            const fsc = nsn.split('-')[0];
            parts.push({
                nsn: nsn,
                nomenclature: sys,
                cage: generateCAGE(comp.mfgs[i]),
                manufacturer: comp.mfgs[i],
                program: progKey,
                fsc: fsc,
                fscGroup: fscGroups[parseInt(fsc)] || 'General',
                unitPrice: Math.floor(5000 + Math.random() * 500000),
                qtyOnHand: Math.floor(Math.random() * 20),
                leadTime: Math.floor(4 + Math.random() * 48) + ' weeks',
                alternates: Math.random() > 0.6 ? generateAlternates(sys) : [],
                status: Math.random() > 0.85 ? 'Backordered' : Math.random() > 0.7 ? 'Low Stock' : 'Available'
            });
        });
    });
    return parts;
}

function generateCAGE(mfg) {
    const cageMap = {'Raytheon':'07458','Lockheed Martin':'64928','GE Aviation':'77445','Northrop Grumman':'57991','BAE Systems':'K1813','Boeing':'81205','Caterpillar':'60548','Pratt & Whitney':'52661','Rolls-Royce':'K2965','Honeywell':'55939','L3Harris':'1EP72','Collins Aerospace':'70210','General Dynamics':'19139','Kongsberg':'Z7613','Sikorsky':'78286'};
    return cageMap[mfg] || String(Math.floor(10000 + Math.random() * 89999));
}

function generateAlternates(sysName) {
    const alts = [];
    const count = 1 + Math.floor(Math.random() * 2);
    for (let i = 0; i < count; i++) {
        alts.push({
            nsn: Math.floor(1000+Math.random()*9000) + '-01-' + String(Math.floor(100+Math.random()*900)) + '-' + String(Math.floor(1000+Math.random()*9000)),
            name: sysName + ' (Alt ' + (i+1) + ')',
            cage: String(Math.floor(10000 + Math.random() * 89999)),
            interchangeability: Math.random() > 0.5 ? 'Direct' : 'Partial'
        });
    }
    return alts;
}

let _partsDB = null;
function getPartsDB() {
    if (!_partsDB) _partsDB = buildPartsDatabase();
    return _partsDB;
}

function searchNSN() {
    const q = (document.getElementById('nsnSearch').value || '').trim();
    if (q.length < 3) { renderPartsResults(getPartsDB().slice(0, 15)); return; }
    const results = getPartsDB().filter(p => p.nsn.includes(q));
    renderPartsResults(results);
}

function searchCAGE() {
    const q = (document.getElementById('cageSearch').value || '').toUpperCase().trim();
    if (q.length < 3) { renderPartsResults(getPartsDB().slice(0, 15)); return; }
    const results = getPartsDB().filter(p => p.cage.includes(q));
    renderPartsResults(results);
}

function searchPartName() {
    const q = (document.getElementById('partNameSearch').value || '').toLowerCase().trim();
    if (q.length < 2) { renderPartsResults(getPartsDB().slice(0, 15)); return; }
    const results = getPartsDB().filter(p => p.nomenclature.toLowerCase().includes(q) || p.fscGroup.toLowerCase().includes(q));
    renderPartsResults(results);
}

function filterParts() {
    const prog = document.getElementById('partsProgram').value;
    const db = getPartsDB();
    const results = prog === 'all' ? db : db.filter(p => p.program === prog);
    renderPartsResults(results);
}

function renderPartsResults(parts) {
    const totalAlts = parts.reduce((s,p) => s + p.alternates.length, 0);
    const cages = new Set(parts.map(p => p.cage));
    const progs = new Set(parts.map(p => p.program));
    document.getElementById('partsTotal').textContent = parts.length;
    document.getElementById('partsAlternates').textContent = totalAlts;
    document.getElementById('partsCAGE').textContent = cages.size;
    document.getElementById('partsPrograms').textContent = progs.size;

    const statusColors = {Available:'#14f195','Low Stock':'#ffa500',Backordered:'#ff3333'};
    let html = '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:0.82rem;">';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.1);color:var(--steel);"><th style="padding:8px;text-align:left;">NSN</th><th>Nomenclature</th><th>CAGE</th><th>Manufacturer</th><th>Program</th><th>Unit Price</th><th>Status</th><th>Lead Time</th><th>Alternates</th></tr>';
    parts.slice(0, 25).forEach(p => {
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);">';
        html += '<td style="padding:8px;color:#00aaff;font-family:monospace;font-size:0.78rem;">' + p.nsn + '</td>';
        html += '<td style="padding:8px;color:#fff;font-weight:600;">' + p.nomenclature + '</td>';
        html += '<td style="padding:8px;color:var(--steel);font-family:monospace;">' + p.cage + '</td>';
        html += '<td style="padding:8px;color:var(--steel);">' + p.manufacturer + '</td>';
        html += '<td style="padding:8px;color:#c9a84c;">' + p.program.toUpperCase() + '</td>';
        html += '<td style="padding:8px;color:var(--steel);">$' + p.unitPrice.toLocaleString() + '</td>';
        html += '<td style="padding:8px;"><span style="color:' + (statusColors[p.status]||'#fff') + ';font-weight:600;">' + p.status + '</span></td>';
        html += '<td style="padding:8px;color:var(--steel);">' + p.leadTime + '</td>';
        html += '<td style="padding:8px;color:' + (p.alternates.length > 0 ? '#14f195' : 'var(--steel)') + ';">' + (p.alternates.length > 0 ? p.alternates.length + ' found' : 'None') + '</td>';
        html += '</tr>';
        // Show alternates if any
        p.alternates.forEach(alt => {
            html += '<tr style="background:rgba(0,170,255,0.03);border-bottom:1px solid rgba(255,255,255,0.03);">';
            html += '<td style="padding:6px 8px 6px 24px;color:#66ccff;font-family:monospace;font-size:0.75rem;">↳ ' + alt.nsn + '</td>';
            html += '<td style="padding:6px 8px;color:var(--steel);font-size:0.78rem;" colspan="2">' + alt.name + '</td>';
            html += '<td style="padding:6px 8px;color:var(--steel);font-size:0.78rem;">' + alt.cage + '</td>';
            html += '<td colspan="5" style="padding:6px 8px;color:' + (alt.interchangeability==='Direct'?'#14f195':'#ffa500') + ';font-size:0.78rem;">' + alt.interchangeability + ' interchange</td>';
            html += '</tr>';
        });
    });
    html += '</table></div>';
    if (parts.length > 25) html += '<div style="margin-top:8px;color:var(--steel);font-size:0.82rem;">Showing 25 of ' + parts.length + ' results. Use search filters to narrow down.</div>';
    document.getElementById('partsResults').innerHTML = html;
}

function exportParts() {
    const prog = document.getElementById('partsProgram').value;
    const db = getPartsDB();
    const parts = prog === 'all' ? db : db.filter(p => p.program === prog);
    let csv = 'NSN,Nomenclature,CAGE,Manufacturer,Program,Unit Price,QOH,Lead Time,Status,Alternates\n';
    parts.forEach(p => { csv += p.nsn + ',"' + p.nomenclature + '",' + p.cage + ',"' + p.manufacturer + '",' + p.program + ',' + p.unitPrice + ',' + p.qtyOnHand + ',' + p.leadTime + ',' + p.status + ',' + p.alternates.length + '\n'; });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Parts_XRef_' + prog.toUpperCase() + '.csv'; a.click();
}

async function anchorParts() {
    const prog = document.getElementById('partsProgram').value;
    const parts = prog === 'all' ? getPartsDB() : getPartsDB().filter(p => p.program === prog);
    const text = 'Parts X-Ref | Program: ' + prog + ' | Parts: ' + parts.length + ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'Parts Cross-Reference', 'CUI');
    stats.anchored++; stats.types.add('PARTS_XREF'); stats.slsFees += 0.01; updateStats(); saveStats();
    const txHash_p = 'TX'+Date.now().toString(16).toUpperCase();
    const rec = {hash, type:'PARTS_XREF', branch:'JOINT', timestamp:new Date().toISOString(), label:'Parts Cross-Reference', txHash:txHash_p};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'PARTS_XREF', record_label:'Parts Cross-Reference', branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash_p, system:'Parts X-Ref'});
    updateTxLog();
    addToVault({hash, txHash:'TX'+Date.now().toString(16).toUpperCase(), type:'PARTS_XREF', label:'Parts Cross-Reference', branch:'JOINT', icon:'🔧', content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Parts X-Ref', fee:0.01});
    setTimeout(() => { document.getElementById('animStatus').textContent = '✅ Parts data anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
}

// ═══ ROI CALCULATOR ═══
function calcROI() {
    const programs = parseInt(document.getElementById('roiPrograms').value) || 1;
    const records = parseInt(document.getElementById('roiRecords').value) || 0;
    const ftes = parseFloat(document.getElementById('roiFTEs').value) || 0;
    const rate = parseFloat(document.getElementById('roiRate').value) || 0;
    const auditCost = parseFloat(document.getElementById('roiAudit').value) || 0;
    const errorCost = parseFloat(document.getElementById('roiError').value) || 0;
    const incidents = parseInt(document.getElementById('roiIncidents').value) || 0;
    const license = parseFloat(document.getElementById('roiLicense').value) || 0;

    // S4 automates ~65% of manual ILS work, reduces errors by 90%, cuts audit cost by 70%
    const annualLabor = ftes * rate * 2080; // 2080 work hours/year
    const laborSavings = annualLabor * 0.65;
    const errorSavings = errorCost * incidents * 0.90;
    const auditSavings = auditCost * 0.70;
    const complianceSavings = programs * 12000; // estimated compliance acceleration value
    const totalSavings = laborSavings + errorSavings + auditSavings + complianceSavings;
    const netSavings = totalSavings - license;
    const roiPct = license > 0 ? ((netSavings / license) * 100) : 0;
    const paybackMonths = totalSavings > 0 ? Math.ceil((license / totalSavings) * 12) : 99;
    const fiveYear = (netSavings * 5);

    document.getElementById('roiSavings').textContent = '$' + Math.round(netSavings).toLocaleString();
    document.getElementById('roiPercent').textContent = Math.round(roiPct) + '%';
    document.getElementById('roiPayback').textContent = paybackMonths + ' mo';
    document.getElementById('roi5Year').textContent = '$' + Math.round(fiveYear).toLocaleString();

    // Detailed breakdown
    let html = '<div style="background:rgba(0,170,255,0.05);border:1px solid rgba(0,170,255,0.15);border-radius:10px;padding:1rem;">';
    html += '<h5 style="color:#00aaff;margin-bottom:0.8rem"><i class="fas fa-chart-line"></i> ROI Breakdown</h5>';
    html += '<table style="width:100%;border-collapse:collapse;">';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Labor Automation Savings (65% reduction)</td><td style="padding:6px;color:#14f195;text-align:right;">+$' + Math.round(laborSavings).toLocaleString() + '</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Error Reduction Savings (90% fewer incidents)</td><td style="padding:6px;color:#14f195;text-align:right;">+$' + Math.round(errorSavings).toLocaleString() + '</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Audit Cost Reduction (70% with blockchain proof)</td><td style="padding:6px;color:#14f195;text-align:right;">+$' + Math.round(auditSavings).toLocaleString() + '</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Compliance Acceleration Value</td><td style="padding:6px;color:#14f195;text-align:right;">+$' + Math.round(complianceSavings).toLocaleString() + '</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.08);"><td style="padding:6px;color:var(--steel);font-weight:600;">Total Annual Savings</td><td style="padding:6px;color:#14f195;font-weight:600;text-align:right;">$' + Math.round(totalSavings).toLocaleString() + '</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">S4 Ledger License Cost</td><td style="padding:6px;color:#ff6666;text-align:right;">-$' + Math.round(license).toLocaleString() + '</td></tr>';
    html += '<tr><td style="padding:8px;color:#fff;font-weight:700;font-size:1.05rem;">Net Annual Benefit</td><td style="padding:8px;color:' + (netSavings >= 0 ? '#14f195' : '#ff3333') + ';font-weight:700;font-size:1.05rem;text-align:right;">$' + Math.round(netSavings).toLocaleString() + '</td></tr>';
    html += '</table>';
    html += '<div style="margin-top:0.8rem;padding:8px;background:rgba(20,241,149,0.06);border-radius:8px;color:var(--steel);font-size:0.85rem;">';
    html += '<strong style="color:#14f195;">Key Benefits:</strong> ' + Math.round(ftes * 0.65 * 10) / 10 + ' FTE-equivalents freed • ' + Math.round(records * programs * 12 * 0.65).toLocaleString() + ' records automated/year • ' + Math.round(incidents * 0.9) + ' errors prevented • XRPL-anchored audit trail</div>';
    html += '</div>';
    document.getElementById('roiOutput').innerHTML = html;
    // Generate ROI action items
    generateROIActions(netSavings, roiPct, paybackMonths);
}

function exportROI() {
    const data = {programs: document.getElementById('roiPrograms').value, ftes: document.getElementById('roiFTEs').value, rate: document.getElementById('roiRate').value, savings: document.getElementById('roiSavings').textContent, roi: document.getElementById('roiPercent').textContent, payback: document.getElementById('roiPayback').textContent};
    let csv = 'Metric,Value\n'; Object.entries(data).forEach(([k,v]) => { csv += k + ',' + v + '\n'; });
    const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'S4_ROI_Report.csv'; a.click();
}

async function anchorROI() {
    const text = 'ROI Calculator | Programs: ' + document.getElementById('roiPrograms').value + ' | Savings: ' + document.getElementById('roiSavings').textContent + ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'ROI Analysis', 'CUI');
    stats.anchored++; stats.types.add('ROI_ANALYSIS'); stats.slsFees += 0.01; updateStats(); saveStats();
    const txHash_roi = 'TX'+Date.now().toString(16).toUpperCase();
    const rec = {hash, type:'ROI_ANALYSIS', branch:'JOINT', timestamp:new Date().toISOString(), label:'ROI Calculator Report', txHash:txHash_roi};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'ROI_ANALYSIS', record_label:'ROI Calculator Report', branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash_roi, system:'ROI Calculator'});
    updateTxLog();
    addToVault({hash, txHash:'TX'+Date.now().toString(16).toUpperCase(), type:'ROI_ANALYSIS', label:'ROI Calculator Report', branch:'JOINT', icon:'💰', content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'ROI Calculator', fee:0.01});
}

// ═══ LIFECYCLE COST ESTIMATOR ═══
function calcLifecycle() {
    const progKey = document.getElementById('lifecycleProgram').value;
    const serviceLife = parseInt(document.getElementById('lcServiceLife').value) || 30;
    const opHours = parseInt(document.getElementById('lcOpHours').value) || 2500;
    const acqCostM = parseFloat(document.getElementById('lcAcqCost').value) || 85;
    const fleetSize = parseInt(document.getElementById('lcFleetSize').value) || 20;
    const sustRate = parseFloat(document.getElementById('lcSustRate').value) || 8;

    const acqTotal = acqCostM * fleetSize; // $M
    const annualSust = acqTotal * (sustRate / 100);
    const totalSust = annualSust * serviceLife;
    const dmsmsCost = acqTotal * 0.04 * serviceLife; // ~4% per year for DMSMS/obsolescence
    const techRefresh = acqTotal * 0.02 * Math.floor(serviceLife / 5); // Tech refresh every 5 years at 2%
    const depotMaint = annualSust * 0.35 * serviceLife; // 35% of sustainment goes to depot
    const totalCost = acqTotal + totalSust + dmsmsCost + techRefresh;
    const costPerHour = (totalCost * 1000000) / (opHours * serviceLife * fleetSize);

    document.getElementById('lcTotalCost').textContent = formatCostM(totalCost);
    document.getElementById('lcSustCost').textContent = formatCostM(totalSust);
    document.getElementById('lcDmsmsCost').textContent = formatCostM(dmsmsCost);
    document.getElementById('lcCostPerHr').textContent = '$' + Math.round(costPerHour).toLocaleString();

    const platName = (window.S4_PLATFORMS && S4_PLATFORMS[progKey]) ? S4_PLATFORMS[progKey].n : progKey.toUpperCase();

    let html = '<div style="background:rgba(255,153,0,0.05);border:1px solid rgba(255,153,0,0.15);border-radius:10px;padding:1rem;">';
    html += '<h5 style="color:#ff9900;margin-bottom:0.8rem"><i class="fas fa-coins"></i> ' + platName + ' — Lifecycle Cost Projection</h5>';
    html += '<table style="width:100%;border-collapse:collapse;">';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Acquisition (RDT&E + Procurement)</td><td style="padding:6px;color:#00aaff;text-align:right;">' + formatCostM(acqTotal) + ' (' + Math.round(acqTotal/totalCost*100) + '%)</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Operations & Sustainment (' + serviceLife + ' years)</td><td style="padding:6px;color:#00aaff;text-align:right;">' + formatCostM(totalSust) + ' (' + Math.round(totalSust/totalCost*100) + '%)</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">DMSMS & Obsolescence Resolution</td><td style="padding:6px;color:#ff3333;text-align:right;">' + formatCostM(dmsmsCost) + ' (' + Math.round(dmsmsCost/totalCost*100) + '%)</td></tr>';
    html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px;color:var(--steel);">Technology Refresh Cycles (' + Math.floor(serviceLife/5) + ' cycles)</td><td style="padding:6px;color:#ffa500;text-align:right;">' + formatCostM(techRefresh) + ' (' + Math.round(techRefresh/totalCost*100) + '%)</td></tr>';
    html += '<tr><td style="padding:8px;color:#fff;font-weight:700;font-size:1.05rem;">Total Ownership Cost</td><td style="padding:8px;color:#ff9900;font-weight:700;font-size:1.05rem;text-align:right;">' + formatCostM(totalCost) + '</td></tr>';
    html += '</table>';
    html += '<div style="margin-top:0.8rem;padding:8px;background:rgba(0,170,255,0.06);border-radius:8px;color:var(--steel);font-size:0.85rem;">';
    html += '<strong style="color:#00aaff;">S4 Ledger Impact:</strong> Automated DMSMS tracking can reduce obsolescence costs by 15-25% (est. savings: ' + formatCostM(dmsmsCost * 0.20) + '). ';
    html += 'Blockchain-anchored ILS records reduce audit overhead by ~70%. Fleet of ' + fleetSize + ' units × ' + serviceLife + ' years = ' + (opHours * serviceLife * fleetSize).toLocaleString() + ' total operating hours.</div>';
    html += '</div>';
    document.getElementById('lifecycleOutput').innerHTML = html;
    // Generate lifecycle action items
    generateLifecycleActions(progKey, totalCost, dmsmsCost, totalSust);
}

function exportLifecycle() {
    const data = {program: document.getElementById('lifecycleProgram').value, totalCost: document.getElementById('lcTotalCost').textContent, sustainment: document.getElementById('lcSustCost').textContent, dmsms: document.getElementById('lcDmsmsCost').textContent, costPerHr: document.getElementById('lcCostPerHr').textContent};
    let csv = 'Metric,Value\n'; Object.entries(data).forEach(([k,v]) => { csv += k + ',' + v + '\n'; });
    const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'S4_Lifecycle_Report.csv'; a.click();
}

async function anchorLifecycle() {
    const prog = document.getElementById('lifecycleProgram').value;
    const text = 'Lifecycle Cost | Program: ' + prog + ' | TOC: ' + document.getElementById('lcTotalCost').textContent + ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'Lifecycle Cost Estimate', 'CUI');
    stats.anchored++; stats.types.add('LIFECYCLE_COST'); stats.slsFees += 0.01; updateStats(); saveStats();
    const txHash_lc = 'TX'+Date.now().toString(16).toUpperCase();
    const rec = {hash, type:'LIFECYCLE_COST', branch:'JOINT', timestamp:new Date().toISOString(), label:'Lifecycle Cost Estimate', txHash:txHash_lc};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'LIFECYCLE_COST', record_label:'Lifecycle Cost Estimate', branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash_lc, system:'Lifecycle Estimator'});
    updateTxLog();
    addToVault({hash, txHash:'TX'+Date.now().toString(16).toUpperCase(), type:'LIFECYCLE_COST', label:'Lifecycle Cost Estimate', branch:'JOINT', icon:'📈', content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Lifecycle Estimator', fee:0.01});
}

// ═══ WARRANTY & CONTRACT TRACKER ═══
function loadWarrantyData() {
    const progKey = document.getElementById('warrantyProgram').value;
    if (!progKey) return;
    const comp = PROG_COMPONENTS[progKey] || PROG_COMPONENTS.custom;
    const platName = (window.S4_PLATFORMS && S4_PLATFORMS[progKey]) ? S4_PLATFORMS[progKey].n : progKey.toUpperCase();
    const now = new Date();
    const statuses = ['Active','Active','Active','Active','Expiring Soon','Expiring Soon','Expired','Active','Active','Active'];
    const contractTypes = ['OEM Warranty','Extended Service','IDIQ CLIN','BPA Order','OEM Warranty','Service Agreement','OEM Warranty','IDIQ CLIN','Performance-Based','OEM Warranty'];
    const periods = [36, 24, 60, 12, 48, 36, 18, 60, 36, 24]; // months

    let items = comp.systems.map((sys, i) => {
        const startDate = new Date(now); startDate.setMonth(startDate.getMonth() - Math.floor(periods[i % periods.length] * 0.6));
        const endDate = new Date(startDate); endDate.setMonth(endDate.getMonth() + periods[i % periods.length]);
        const daysLeft = Math.floor((endDate - now) / (1000 * 60 * 60 * 24));
        const status = daysLeft < 0 ? 'Expired' : daysLeft < 90 ? 'Expiring Soon' : 'Active';
        const value = Math.floor(25000 + Math.random() * 475000);
        return {system: sys, mfg: comp.mfgs[i], type: contractTypes[i % contractTypes.length], start: startDate.toISOString().split('T')[0], end: endDate.toISOString().split('T')[0], daysLeft, status, value, clin: 'CLIN ' + String(100 + i).padStart(4, '0')};
    });

    const active = items.filter(i => i.status === 'Active').length;
    const expiring = items.filter(i => i.status === 'Expiring Soon').length;
    const expired = items.filter(i => i.status === 'Expired').length;
    const totalValue = items.reduce((s, i) => s + i.value, 0);

    document.getElementById('warActive').textContent = active;
    document.getElementById('warExpiring').textContent = expiring;
    document.getElementById('warExpired').textContent = expired;
    document.getElementById('warValue').textContent = '$' + Math.round(totalValue / 1000) + 'K';

    let html = '<div style="background:rgba(201,168,76,0.05);border:1px solid rgba(201,168,76,0.15);border-radius:10px;padding:1rem;">';
    html += '<h5 style="color:#c9a84c;margin-bottom:0.8rem"><i class="fas fa-file-contract"></i> ' + platName + ' — Warranty & Contract Status</h5>';
    html += '<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:0.82rem;">';
    html += '<tr style="background:rgba(0,170,255,0.08);"><th style="padding:8px;text-align:left;color:#00aaff;">System</th><th style="padding:8px;text-align:left;color:#00aaff;">OEM</th><th style="padding:8px;color:#00aaff;">Type</th><th style="padding:8px;color:#00aaff;">CLIN</th><th style="padding:8px;color:#00aaff;">Start</th><th style="padding:8px;color:#00aaff;">End</th><th style="padding:8px;color:#00aaff;">Days Left</th><th style="padding:8px;color:#00aaff;">Status</th><th style="padding:8px;color:#00aaff;">Value</th></tr>';
    const statusClr = {'Active':'#14f195', 'Expiring Soon':'#ffa500', 'Expired':'#ff3333'};
    items.forEach(w => {
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">';
        html += '<td style="padding:6px 8px;color:#fff;font-weight:500;">' + w.system + '</td>';
        html += '<td style="padding:6px 8px;color:var(--steel);">' + w.mfg + '</td>';
        html += '<td style="padding:6px 8px;color:var(--steel);">' + w.type + '</td>';
        html += '<td style="padding:6px 8px;color:#c9a84c;font-family:monospace;">' + w.clin + '</td>';
        html += '<td style="padding:6px 8px;color:var(--steel);">' + w.start + '</td>';
        html += '<td style="padding:6px 8px;color:var(--steel);">' + w.end + '</td>';
        html += '<td style="padding:6px 8px;color:' + (statusClr[w.status]) + ';font-weight:600;">' + (w.daysLeft > 0 ? w.daysLeft + 'd' : 'EXPIRED') + '</td>';
        html += '<td style="padding:6px 8px;"><span style="color:' + (statusClr[w.status]) + ';font-weight:600;">' + w.status + '</span></td>';
        html += '<td style="padding:6px 8px;color:var(--steel);">$' + w.value.toLocaleString() + '</td>';
        html += '</tr>';
    });
    html += '</table></div>';
    if (expiring > 0) {
        html += '<div style="margin-top:0.8rem;padding:8px;background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2);border-radius:8px;color:#ffa500;font-size:0.85rem;">';
        html += '<strong>⚠ Action Required:</strong> ' + expiring + ' warranty/contract item(s) expiring within 90 days. Initiate renewal or re-compete per FAR 46.7 / DFARS 246.7.</div>';
    }
    if (expired > 0) {
        html += '<div style="margin-top:0.5rem;padding:8px;background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;color:#ff3333;font-size:0.85rem;">';
        html += '<strong>🔴 Coverage Gap:</strong> ' + expired + ' expired warranty/contract item(s). Recommend immediate OEM engagement or bridge contract.</div>';
    }
    html += '</div>';
    document.getElementById('warrantyResults').innerHTML = html;
    // Generate warranty action items & alerts
    generateWarrantyActions(progKey, items);
}

function exportWarranty() {
    const prog = document.getElementById('warrantyProgram').value;
    const comp = PROG_COMPONENTS[prog] || PROG_COMPONENTS.custom;
    let csv = 'System,Manufacturer,Contract Type,CLIN,Start,End,Status,Value\n';
    comp.systems.forEach((sys, i) => { csv += '"' + sys + '","' + comp.mfgs[i] + '",OEM Warranty,CLIN ' + (100+i) + ',2024-01-01,2026-01-01,Active,$50000\n'; });
    const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'S4_Warranty_' + prog.toUpperCase() + '.csv'; a.click();
}

async function anchorWarranty() {
    const prog = document.getElementById('warrantyProgram').value;
    const text = 'Warranty Tracker | Program: ' + prog + ' | Active: ' + document.getElementById('warActive').textContent + ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'Warranty & Contract Data', 'CUI');
    stats.anchored++; stats.types.add('WARRANTY_CONTRACT'); stats.slsFees += 0.01; updateStats(); saveStats();
    const txHash_w = 'TX'+Date.now().toString(16).toUpperCase();
    const rec = {hash, type:'WARRANTY_CONTRACT', branch:'JOINT', timestamp:new Date().toISOString(), label:'Warranty & Contract Tracker', txHash:txHash_w};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'WARRANTY_CONTRACT', record_label:'Warranty & Contract Tracker', branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash_w, system:'Warranty Tracker'});
    updateTxLog();
    addToVault({hash, txHash:'TX'+Date.now().toString(16).toUpperCase(), type:'WARRANTY_CONTRACT', label:'Warranty & Contract Tracker', branch:'JOINT', icon:'📋', content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Warranty Tracker', fee:0.01});
}

// ── Initialization ──
function populateAllDropdowns() {
    if (!window.S4_buildProgramOptions) { console.warn('S4 Platforms DB not loaded'); return; }
    const selects = {
        ilsProgram:        {all: false, custom: true},
        dmsmsProgram:      {all: false, custom: true},
        readinessProgram:  {all: false, custom: true},
        partsProgram:      {all: true,  custom: true},
        lifecycleProgram:  {all: false, custom: true},
        warrantyProgram:   {all: false, custom: true},
        complianceProgram: {all: false, custom: true},
        provProgram:       {all: false, custom: true},
        riskProgram:       {all: false, custom: true},
        threadPlatform:    {all: false, custom: true},
        pdmPlatform:       {all: false, custom: true},
        subProgram:        {all: false, custom: true}
    };
    Object.entries(selects).forEach(([id, opts]) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = S4_buildProgramOptions(opts.all, opts.custom);
    });
    // Update platform count badge
    if (window.S4_countPlatforms) {
        const countEl = document.getElementById('platformCount');
        if (countEl) countEl.textContent = S4_countPlatforms() + ' Platforms';
    }
}

function initILSEngine() {
    populateAllDropdowns();
    initILSChecklist(document.getElementById('ilsProgram').value);
    setupILSDropzone();
    onILSProgramChange();
    // Initialize new tools
    if (document.getElementById('dmsmsProgram')) loadDMSMSData();
    if (document.getElementById('readinessProgram')) loadReadinessData();
    if (document.getElementById('partsResults')) renderPartsResults(getPartsDB().slice(0,15));
    // ROI auto-calc on load
    if (document.getElementById('roiPrograms')) calcROI();
    // Lifecycle auto-calc on load
    if (document.getElementById('lifecycleProgram')) calcLifecycle();
    // Warranty auto-load
    if (document.getElementById('warrantyProgram')) loadWarrantyData();
}

// ═══════════════════════════════════════════════════════════════
//  S4 NOTIFICATION + ACTION ITEMS SYSTEM (v3.4.0)
// ═══════════════════════════════════════════════════════════════

// ── Toast Notifications ──
let s4ToastQueue = [];
function s4Notify(title, msg, type, actions, duration) {
    type = type || 'info'; duration = duration || 8000;
    const container = document.getElementById('s4ToastContainer');
    if (!container) return;
    const icons = {info:'<i class="fas fa-info-circle" style="color:#00aaff"></i>', warning:'<i class="fas fa-exclamation-triangle" style="color:#ffa500"></i>', danger:'<i class="fas fa-times-circle" style="color:#ff3333"></i>', success:'<i class="fas fa-check-circle" style="color:#14f195"></i>'};
    const toast = document.createElement('div');
    toast.className = 's4-toast ' + type;
    let actionsHtml = '';
    if (actions && actions.length) {
        actionsHtml = '<div class="s4-toast-actions">';
        actions.forEach(a => { actionsHtml += '<button class="s4-toast-action" onclick="' + (a.onclick||'') + '">' + a.label + '</button>'; });
        actionsHtml += '</div>';
    }
    toast.innerHTML = '<div class="s4-toast-icon">' + (icons[type]||icons.info) + '</div><div class="s4-toast-body"><div class="s4-toast-title">' + title + '</div><div class="s4-toast-msg">' + msg + '</div>' + actionsHtml + '</div><button class="s4-toast-close" onclick="dismissToast(this)">&times;</button><div class="s4-toast-progress" style="animation-duration:' + duration + 'ms"></div>';
    container.appendChild(toast);
    setTimeout(() => { dismissToast(toast.querySelector('.s4-toast-close')); }, duration);
    updateNotifBadge();
}
function dismissToast(btn) {
    const toast = btn.closest ? btn.closest('.s4-toast') : btn.parentElement;
    if (!toast || toast.classList.contains('dismissing')) return;
    toast.classList.add('dismissing');
    setTimeout(() => toast.remove(), 300);
}
function updateNotifBadge() {
    const badge = document.getElementById('notifBadge');
    const items = s4ActionItems.filter(a => !a.done);
    if (badge) badge.textContent = items.length > 0 ? items.length : '';
    const tabCount = document.getElementById('actionTabCount');
    if (tabCount) tabCount.textContent = items.length;
}
function toggleNotifPanel() {
    // Navigate to ILS Workspace and switch to Action Items panel
    const tab = document.querySelector('a[href="#tabILS"]');
    if (tab) { tab.click(); window.scrollTo({top: 280, behavior:'smooth'}); }
    setTimeout(() => { const btn = document.querySelector('.ils-hub-tab:nth-child(2)'); if (btn) switchHubTab('hub-actions', btn); }, 200);
}

// ── Unified Action Items Store (localStorage-backed) ──
let s4ActionItems = JSON.parse(localStorage.getItem('s4ActionItems') || '[]');
function saveActionItems() {
    localStorage.setItem('s4ActionItems', JSON.stringify(s4ActionItems));
    updateNotifBadge();
    renderActionItemsPanel();
}
function addActionItem(item) {
    // item = {id, title, detail, severity, source, owner, due, cost, schedule}
    // Avoid duplicates by id
    if (s4ActionItems.find(a => a.id === item.id)) return;
    item.done = false;
    item.created = new Date().toISOString();
    s4ActionItems.push(item);
    saveActionItems();
}
function toggleActionDone(id) {
    const item = s4ActionItems.find(a => a.id === id);
    if (item) { item.done = !item.done; item.completedAt = item.done ? new Date().toISOString() : null; saveActionItems(); }
}
function clearCompletedActions() {
    s4ActionItems = s4ActionItems.filter(a => !a.done);
    saveActionItems();
}
function filterActionItems(filter) {
    renderActionItemsPanel(filter);
}
function renderActionItemsPanel(filter) {
    filter = filter || 'all';
    const container = document.getElementById('actionItemsList');
    if (!container) return;
    let items = [...s4ActionItems];
    if (filter === 'critical') items = items.filter(a => a.severity === 'critical' && !a.done);
    else if (filter === 'warning') items = items.filter(a => a.severity === 'warning' && !a.done);
    else if (filter === 'info') items = items.filter(a => a.severity === 'info' && !a.done);
    else if (filter === 'completed') items = items.filter(a => a.done);
    else if (filter === 'all') { /* show all */ }
    // Sort: critical first, then warning, then info, done last
    items.sort((a,b) => {
        if (a.done !== b.done) return a.done ? 1 : -1;
        const sev = {critical:0, warning:1, info:2};
        return (sev[a.severity]||3) - (sev[b.severity]||3);
    });
    // Stats
    const total = s4ActionItems.length;
    const critical = s4ActionItems.filter(a => a.severity === 'critical' && !a.done).length;
    const open = s4ActionItems.filter(a => !a.done).length;
    const done = s4ActionItems.filter(a => a.done).length;
    document.getElementById('aiTotal').textContent = total;
    document.getElementById('aiCritical').textContent = critical;
    document.getElementById('aiOpen').textContent = open;
    document.getElementById('aiDone').textContent = done;

    if (items.length === 0) {
        container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:2rem;font-size:0.85rem"><i class="fas fa-clipboard-list" style="font-size:2rem;margin-bottom:12px;display:block;opacity:0.3"></i>' + (filter==='all'?'No action items yet. Use the tools to generate tasks.':'No items match this filter.') + '</div>';
        return;
    }
    let html = '';
    const sourceIcons = {dmsms:'<i class="fas fa-exclamation-triangle" style="color:#ff9900"></i>', readiness:'<i class="fas fa-chart-line" style="color:#14f195"></i>', parts:'<i class="fas fa-cogs" style="color:#c9a84c"></i>', warranty:'<i class="fas fa-file-contract" style="color:#c9a84c"></i>', roi:'<i class="fas fa-dollar-sign" style="color:#14f195"></i>', lifecycle:'<i class="fas fa-clock" style="color:#00aaff"></i>', ils:'<i class="fas fa-brain" style="color:#00aaff"></i>'};
    items.forEach(item => {
        html += '<div class="action-item' + (item.done ? ' completed' : '') + '">';
        html += '<div class="ai-check' + (item.done ? ' done' : '') + '" onclick="toggleActionDone(\'' + item.id + '\')"></div>';
        html += '<div class="ai-body">';
        html += '<div class="ai-title">' + (sourceIcons[item.source]||'') + ' ' + item.title + '</div>';
        html += '<div class="ai-meta">';
        html += '<span class="ai-tag ' + (item.severity||'info') + '">' + (item.severity||'info').toUpperCase() + '</span>';
        html += '<span>' + (item.source||'').toUpperCase() + '</span>';
        if (item.owner) html += '<span><i class="fas fa-user" style="margin-right:3px"></i>' + item.owner + '</span>';
        if (item.cost) html += '<span style="color:#ffa500">$' + item.cost + 'K</span>';
        if (item.schedule) html += '<span><i class="fas fa-calendar" style="margin-right:3px"></i>' + item.schedule + '</span>';
        html += '</div>';
        if (item.detail) html += '<div style="color:var(--steel);font-size:0.78rem;margin-top:4px">' + item.detail + '</div>';
        html += '</div></div>';
    });
    container.innerHTML = html;
}
function exportActionItems() {
    const items = s4ActionItems;
    if (!items.length) { s4Notify('No Data', 'No action items to export.', 'info'); return; }
    let csv = 'ID,Title,Severity,Source,Owner,Cost ($K),Schedule,Status,Created\n';
    items.forEach(a => {
        csv += [a.id, '"'+a.title+'"', a.severity, a.source, a.owner||'', a.cost||'', a.schedule||'', a.done?'Completed':'Open', a.created||''].join(',') + '\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'S4_Action_Items_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
    URL.revokeObjectURL(url);
    s4Notify('Export Complete', 'Action items exported to CSV.', 'success');
}

// ── Tool-specific action item generators ──
function generateDMSMSActions(progKey, data) {
    const platName = (window.S4_PLATFORMS && S4_PLATFORMS[progKey]) ? S4_PLATFORMS[progKey].n : progKey;
    const obsolete = data.filter(d => d.status === 'Obsolete' || d.status === 'End of Life');
    const atRisk = data.filter(d => d.status === 'At Risk' || d.status === 'Watch');
    obsolete.forEach(d => {
        addActionItem({id:'DMSMS-OBS-'+progKey+'-'+d.system.replace(/\s/g,''), title:'Resolve obsolete part: ' + d.system, detail:'Status: ' + d.status + ' | Manufacturer: ' + d.manufacturer + ' | Lead time: ' + d.leadTime + ' wks. Initiate bridge buy or alternate source per GIDEP.', severity:'critical', source:'dmsms', owner:platName + ' PM', cost:d.cost, schedule:'2-4 months'});
    });
    atRisk.forEach(d => {
        addActionItem({id:'DMSMS-RISK-'+progKey+'-'+d.system.replace(/\s/g,''), title:'Monitor at-risk part: ' + d.system, detail:'Status: ' + d.status + ' | ' + d.endOfSupport + '. Submit GIDEP alert if end-of-life confirmed. Begin alternate qualification.', severity:'warning', source:'dmsms', owner:platName + ' LSA', cost:Math.round(d.cost*0.5), schedule:'3-6 months'});
    });
    if (obsolete.length > 0) s4Notify('DMSMS Alert', obsolete.length + ' obsolete/EOL part(s) detected on ' + platName + '. Action required.', 'danger', [{label:'View Actions', onclick:'toggleNotifPanel()'}]);
    if (atRisk.length > 0) s4Notify('DMSMS Watch', atRisk.length + ' part(s) at risk on ' + platName + '. Monitoring recommended.', 'warning');
}
function generateReadinessActions(progKey, sysName, ao, mtbf, mttr, mldt) {
    const platName = (window.S4_PLATFORMS && S4_PLATFORMS[progKey]) ? S4_PLATFORMS[progKey].n : progKey;
    if (ao < 0.70) {
        addActionItem({id:'RDY-CRIT-'+progKey+'-'+sysName.replace(/\s/g,''), title:'Critical readiness failure: ' + sysName + ' Ao=' + (ao*100).toFixed(1) + '%', detail:'Ao below 70% on ' + platName + '. Immediate corrective action: DMSMS review, redesign consideration, enhanced depot support. MTTR=' + mttr.toFixed(1) + 'h, MLDT=' + mldt.toFixed(1) + 'h.', severity:'critical', source:'readiness', owner:platName + ' ISEA', schedule:'Immediate'});
        s4Notify('Readiness Critical', sysName + ' on ' + platName + ' — Ao ' + (ao*100).toFixed(1) + '% (below 70%)', 'danger', [{label:'View', onclick:'toggleNotifPanel()'}]);
    } else if (ao < 0.80) {
        addActionItem({id:'RDY-LOW-'+progKey+'-'+sysName.replace(/\s/g,''), title:'Below-threshold readiness: ' + sysName + ' Ao=' + (ao*100).toFixed(1) + '%', detail:'Recommend spares stocking analysis and MTTR reduction plan for ' + platName + '. MLDT of ' + mldt.toFixed(1) + 'h may indicate supply chain gaps.', severity:'warning', source:'readiness', owner:platName + ' LSA', schedule:'1-3 months'});
        s4Notify('Readiness Warning', sysName + ' Ao=' + (ao*100).toFixed(1) + '% — below 80% threshold', 'warning');
    } else if (ao < 0.90) {
        addActionItem({id:'RDY-MARG-'+progKey+'-'+sysName.replace(/\s/g,''), title:'Marginal readiness: ' + sysName + ' Ao=' + (ao*100).toFixed(1) + '%', detail:'Monitor MLDT for improvement opportunities on ' + platName + '. Consider pre-positioned spares to reduce logistics delay.', severity:'info', source:'readiness', owner:platName + ' PM', schedule:'Review quarterly'});
    }
}
function generateWarrantyActions(progKey, items) {
    const platName = (window.S4_PLATFORMS && S4_PLATFORMS[progKey]) ? S4_PLATFORMS[progKey].n : progKey;
    const expiring = items.filter(i => i.status === 'Expiring Soon');
    const expired = items.filter(i => i.status === 'Expired');
    expiring.forEach(w => {
        addActionItem({id:'WAR-EXP-'+progKey+'-'+w.system.replace(/\s/g,''), title:'Warranty expiring: ' + w.system + ' (' + w.daysLeft + ' days)', detail:'OEM: ' + w.mfg + ' | Type: ' + w.type + ' | ' + w.clin + ' | Value: $' + w.value.toLocaleString() + '. Initiate renewal or re-compete per FAR 46.7 / DFARS 246.7 before ' + w.end + '.', severity:'warning', source:'warranty', owner:platName + ' Contracts', cost:Math.round(w.value/1000), schedule:'Within ' + w.daysLeft + ' days'});
    });
    expired.forEach(w => {
        addActionItem({id:'WAR-LAPSE-'+progKey+'-'+w.system.replace(/\s/g,''), title:'Coverage gap: ' + w.system + ' warranty EXPIRED', detail:'OEM: ' + w.mfg + ' | Expired ' + w.end + '. Government now liable for repair costs. Recommend immediate OEM engagement or bridge contract.', severity:'critical', source:'warranty', owner:platName + ' PM', cost:Math.round(w.value/1000*1.5), schedule:'Immediate'});
    });
    if (expiring.length > 0) s4Notify('Warranty Alert', expiring.length + ' warranty/contract item(s) on ' + platName + ' expiring within 90 days.', 'warning', [{label:'Review', onclick:'toggleNotifPanel()'}], 12000);
    if (expired.length > 0) s4Notify('Coverage Gap', expired.length + ' expired warranty item(s) on ' + platName + '. Government liable for repairs.', 'danger', [{label:'Action Required', onclick:'toggleNotifPanel()'}], 15000);
}
function generatePartsActions(results) {
    const lowStock = results.filter(p => p.qtyOnHand !== undefined && p.qtyOnHand < 5);
    const longLead = results.filter(p => p.leadWeeks !== undefined && p.leadWeeks > 26);
    lowStock.slice(0,5).forEach(p => {
        addActionItem({id:'PARTS-LOW-'+p.nsn, title:'Low stock: ' + p.nomenclature + ' (qty: ' + p.qtyOnHand + ')', detail:'NSN: ' + p.nsn + ' | CAGE: ' + p.cage + ' | Reorder recommended to avoid operational impact.', severity:'warning', source:'parts', owner:'Supply Officer', schedule:'Order within 30 days'});
    });
    longLead.slice(0,3).forEach(p => {
        addActionItem({id:'PARTS-LEAD-'+p.nsn, title:'Long lead-time: ' + p.nomenclature + ' (' + p.leadWeeks + ' wks)', detail:'NSN: ' + p.nsn + ' | Consider alternate sourcing or bridge buy. Lead time exceeds 6 months.', severity:'info', source:'parts', owner:'Procurement', schedule:'Review sourcing'});
    });
}
function generateROIActions(netSavings, roiPct, paybackMonths) {
    if (netSavings > 0) {
        addActionItem({id:'ROI-BIZ-CASE', title:'Positive ROI: $' + Math.round(netSavings).toLocaleString() + '/yr savings (' + Math.round(roiPct) + '% ROI)', detail:'S4 Ledger pays for itself in ' + paybackMonths + ' months. Use this analysis in program briefings and budget justifications.', severity:'info', source:'roi', owner:'Program Manager', schedule:'Include in next budget cycle'});
    }
}
function generateLifecycleActions(progKey, totalCost, dmsmsCost, sustCost) {
    const platName = (window.S4_PLATFORMS && S4_PLATFORMS[progKey]) ? S4_PLATFORMS[progKey].n : progKey;
    const dmsmsSavings = dmsmsCost * 0.20;
    addActionItem({id:'LC-DMSMS-'+progKey, title:'Lifecycle DMSMS opportunity: ' + platName, detail:'Estimated DMSMS cost: ' + formatCostM(dmsmsCost) + '. Automated tracking can save ~' + formatCostM(dmsmsSavings) + ' (20%) over service life. Recommend S4 Ledger integration for obsolescence management.', severity:'info', source:'lifecycle', owner:platName + ' APML', schedule:'Plan tech refresh cycle'});
    if (sustCost > totalCost * 0.5) {
        addActionItem({id:'LC-SUST-'+progKey, title:'High sustainment ratio: ' + platName, detail:'Sustainment exceeds 50% of total ownership cost. Focus on MTTR reduction, pre-positioned spares, and PBL contracts.', severity:'warning', source:'lifecycle', owner:platName + ' PM', schedule:'Annual review'});
    }
}

// ═══ ILS WORKSPACE ═══

// ── Hub Tab Switching ──
function switchHubTab(panelId, btn) {
    document.querySelectorAll('.ils-hub-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.ils-hub-tab').forEach(t => t.classList.remove('active'));
    const panel = document.getElementById(panelId);
    if (panel) panel.classList.add('active');
    if (btn) btn.classList.add('active');
    // Load data for workspace panels
    if (panelId === 'hub-actions') renderHubActions();
    if (panelId === 'hub-calendar') renderCalendar();
    if (panelId === 'hub-vault') renderVault();
    if (panelId === 'hub-docs') renderDocLibrary();
    if (panelId === 'hub-compliance') calcCompliance();
    if (panelId === 'hub-provisioning') loadProvisioningData();
    if (panelId === 'hub-risk') loadRiskData();
    if (panelId === 'hub-reports') loadReportPreview();
    if (panelId === 'hub-contracts') loadContractData();
    if (panelId === 'hub-thread') loadThreadData();
    if (panelId === 'hub-predictive') loadPredictiveData();
    if (panelId === 'hub-dbimport') updateDbImportInfo();
    if (panelId === 'hub-submissions') loadSubmissionHistory();
    // Update floating AI agent context
    updateAiContext(panelId);
}

// ── Hub Action Items (mirrors the main action items + hub-specific stats) ──
function filterHubActions(filter) { renderHubActions(filter); }
function renderHubActions(filter) {
    filter = filter || 'all';
    const container = document.getElementById('hubActionItemsList');
    if (!container) return;
    let items = [...s4ActionItems];
    if (filter === 'critical') items = items.filter(a => a.severity === 'critical' && !a.done);
    else if (filter === 'warning') items = items.filter(a => a.severity === 'warning' && !a.done);
    else if (filter === 'info') items = items.filter(a => a.severity === 'info' && !a.done);
    else if (filter === 'completed') items = items.filter(a => a.done);
    items.sort((a,b) => { if (a.done !== b.done) return a.done ? 1 : -1; const sev = {critical:0,warning:1,info:2}; return (sev[a.severity]||3)-(sev[b.severity]||3); });
    // Stats
    const total = s4ActionItems.length, critical = s4ActionItems.filter(a => a.severity==='critical' && !a.done).length, open = s4ActionItems.filter(a => !a.done).length, done = s4ActionItems.filter(a => a.done).length;
    const elT = document.getElementById('hubAiTotal'); if (elT) elT.textContent = total;
    const elC = document.getElementById('hubAiCritical'); if (elC) elC.textContent = critical;
    const elO = document.getElementById('hubAiOpen'); if (elO) elO.textContent = open;
    const elD = document.getElementById('hubAiDone'); if (elD) elD.textContent = done;
    // Badge
    const badge = document.getElementById('hubActionBadge'); if (badge) badge.textContent = open > 0 ? open : '0';
    // By-source breakdown
    const srcEl = document.getElementById('hubActionsBySource');
    if (srcEl && s4ActionItems.length > 0) {
        const sources = {};
        s4ActionItems.filter(a=>!a.done).forEach(a => { sources[a.source||'other'] = (sources[a.source||'other']||0) + 1; });
        const srcIcons = {dmsms:'⚠️',readiness:'📈',parts:'🔩',warranty:'📋',roi:'💰',lifecycle:'⏳',ils:'🧠',checklist:'✅',drl:'📄'};
        let sHtml = '';
        Object.entries(sources).sort((a,b)=>b[1]-a[1]).forEach(([src,cnt]) => {
            sHtml += '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.03)"><span>'+(srcIcons[src]||'📌')+' '+src.toUpperCase()+'</span><span style="font-weight:700;color:var(--accent)">'+cnt+'</span></div>';
        });
        srcEl.innerHTML = sHtml;
    }
    if (!items.length) { container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:2rem;font-size:0.85rem"><i class="fas fa-clipboard-list" style="font-size:2rem;margin-bottom:12px;display:block;opacity:0.3"></i>'+(filter==='all'?'No action items yet. Use the tools to generate tasks.':'No items match this filter.')+'</div>'; return; }
    const sourceIcons = {dmsms:'<i class="fas fa-exclamation-triangle" style="color:#ff9900"></i>',readiness:'<i class="fas fa-chart-line" style="color:#14f195"></i>',parts:'<i class="fas fa-cogs" style="color:#c9a84c"></i>',warranty:'<i class="fas fa-file-contract" style="color:#c9a84c"></i>',roi:'<i class="fas fa-dollar-sign" style="color:#14f195"></i>',lifecycle:'<i class="fas fa-clock" style="color:#00aaff"></i>',ils:'<i class="fas fa-brain" style="color:#00aaff"></i>',checklist:'<i class="fas fa-check-circle" style="color:#14f195"></i>',drl:'<i class="fas fa-file-alt" style="color:#c9a84c"></i>'};
    let html = '';
    items.forEach(item => {
        html += '<div class="action-item'+(item.done?' completed':'')+'"><div class="ai-check'+(item.done?' done':'')+'" onclick="toggleActionDone(\''+item.id+'\');renderHubActions()"></div><div class="ai-body"><div class="ai-title">'+(sourceIcons[item.source]||'')+' '+item.title+'</div><div class="ai-meta"><span class="ai-tag '+(item.severity||'info')+'">'+(item.severity||'info').toUpperCase()+'</span><span>'+(item.source||'').toUpperCase()+'</span>';
        if (item.owner) html += '<span><i class="fas fa-user" style="margin-right:3px"></i>'+item.owner+'</span>';
        if (item.cost) html += '<span style="color:#ffa500">$'+item.cost+'K</span>';
        if (item.schedule) html += '<span><i class="fas fa-calendar" style="margin-right:3px"></i>'+item.schedule+'</span>';
        html += '</div>';
        if (item.detail) html += '<div style="color:var(--steel);font-size:0.78rem;margin-top:4px">'+item.detail+'</div>';
        html += '</div></div>';
    });
    container.innerHTML = html;
}

// ── Calendar System ──
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
let calEvents = JSON.parse(localStorage.getItem('s4CalEvents') || '[]');
function saveCalEvents() { localStorage.setItem('s4CalEvents', JSON.stringify(calEvents)); }
function calNav(dir) { calMonth += dir; if (calMonth < 0) { calMonth = 11; calYear--; } if (calMonth > 11) { calMonth = 0; calYear++; } renderCalendar(); }
function calToday() { calMonth = new Date().getMonth(); calYear = new Date().getFullYear(); renderCalendar(); }

function addCalendarEvent() {
    const title = document.getElementById('calEventTitle').value.trim();
    const date = document.getElementById('calEventDate').value;
    const time = document.getElementById('calEventTime').value || '09:00';
    const type = document.getElementById('calEventType').value;
    const notes = document.getElementById('calEventNotes').value.trim();
    if (!title || !date) { s4Notify('Missing Info', 'Please enter a title and date.', 'warning'); return; }
    calEvents.push({ id: 'CAL-'+Date.now(), title, date, time, type, notes, source: 'custom' });
    saveCalEvents();
    renderCalendar();
    document.getElementById('calEventTitle').value = '';
    document.getElementById('calEventNotes').value = '';
    s4Notify('Event Added', '"'+title+'" added to calendar.', 'success');
}

function getCalendarEvents(year, month) {
    // Merge: custom events + action items with schedules
    const events = [...calEvents];
    // Convert action items to calendar events (use created date + schedule estimate)
    s4ActionItems.filter(a => !a.done && a.schedule).forEach(a => {
        const created = a.created ? new Date(a.created) : new Date();
        let dueDate = new Date(created);
        if (/immediate/i.test(a.schedule)) { dueDate.setDate(dueDate.getDate() + 7); }
        else if (/(\d+)\s*days?/i.test(a.schedule)) { dueDate.setDate(dueDate.getDate() + parseInt(RegExp.$1)); }
        else if (/(\d+)[-–](\d+)\s*months?/i.test(a.schedule)) { dueDate.setMonth(dueDate.getMonth() + parseInt(RegExp.$1)); }
        else if (/(\d+)\s*months?/i.test(a.schedule)) { dueDate.setMonth(dueDate.getMonth() + parseInt(RegExp.$1)); }
        else if (/quarterly|review/i.test(a.schedule)) { dueDate.setMonth(dueDate.getMonth() + 3); }
        else if (/annual/i.test(a.schedule)) { dueDate.setFullYear(dueDate.getFullYear() + 1); }
        else { dueDate.setMonth(dueDate.getMonth() + 2); }
        events.push({ id: 'AI-'+a.id, title: a.title, date: dueDate.toISOString().split('T')[0], time: '09:00', type: a.severity || 'info', notes: a.detail || '', source: a.source || 'action' });
    });
    return events;
}

function renderCalendar() {
    const grid = document.getElementById('calGrid');
    const monthLabel = document.getElementById('calMonthYear');
    if (!grid || !monthLabel) return;
    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    monthLabel.textContent = months[calMonth] + ' ' + calYear;
    const firstDay = new Date(calYear, calMonth, 1).getDay();
    const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
    const today = new Date();
    const allEvents = getCalendarEvents(calYear, calMonth);
    // Clear existing day cells (keep headers)
    grid.querySelectorAll('.cal-day').forEach(d => d.remove());
    // Previous month padding
    const prevDays = new Date(calYear, calMonth, 0).getDate();
    for (let i = firstDay - 1; i >= 0; i--) {
        const cell = document.createElement('div');
        cell.className = 'cal-day other-month';
        cell.innerHTML = '<div class="cal-day-num">'+(prevDays-i)+'</div>';
        grid.appendChild(cell);
    }
    // Current month days
    for (let d = 1; d <= daysInMonth; d++) {
        const dateStr = calYear + '-' + String(calMonth+1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
        const isToday = today.getFullYear() === calYear && today.getMonth() === calMonth && today.getDate() === d;
        const dayEvents = allEvents.filter(e => e.date === dateStr);
        const cell = document.createElement('div');
        cell.className = 'cal-day' + (isToday ? ' today' : '');
        let inner = '<div class="cal-day-num">' + d + '</div>';
        dayEvents.slice(0,3).forEach(ev => {
            inner += '<div class="cal-event ' + (ev.type||'info') + '" title="' + ev.title + '">' + ev.title.substring(0,20) + (ev.title.length>20?'…':'') + '</div>';
        });
        if (dayEvents.length > 3) inner += '<div style="font-size:0.65rem;color:var(--muted)">+' + (dayEvents.length-3) + ' more</div>';
        inner += '<button class="cal-add-btn" onclick="event.stopPropagation();document.getElementById(\'calEventDate\').value=\''+dateStr+'\';document.getElementById(\'calEventTitle\').focus()">+</button>';
        cell.innerHTML = inner;
        grid.appendChild(cell);
    }
    // Next month padding
    const totalCells = firstDay + daysInMonth;
    const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (let i = 1; i <= remaining; i++) {
        const cell = document.createElement('div');
        cell.className = 'cal-day other-month';
        cell.innerHTML = '<div class="cal-day-num">'+i+'</div>';
        grid.appendChild(cell);
    }
    // Upcoming sidebar
    renderCalUpcoming(allEvents);
}

function renderCalUpcoming(events) {
    const el = document.getElementById('calUpcoming');
    if (!el) return;
    const today = new Date().toISOString().split('T')[0];
    const upcoming = events.filter(e => e.date >= today).sort((a,b) => a.date.localeCompare(b.date)).slice(0, 8);
    if (!upcoming.length) { el.innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.82rem">No upcoming events.</div>'; return; }
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    let html = '';
    upcoming.forEach(ev => {
        const d = new Date(ev.date + 'T12:00:00');
        const sevColors = {critical:'#ff3333',warning:'#ffa500',info:'#00aaff',success:'#14f195',custom:'#c9a84c'};
        html += '<div class="cal-upcoming-item"><div class="cal-upcoming-date" style="color:'+(sevColors[ev.type]||'#00aaff')+'"><div>'+d.getDate()+'</div><div class="cal-month">'+months[d.getMonth()]+'</div></div><div class="cal-upcoming-info"><div class="cal-upcoming-title">'+ev.title+'</div><div class="cal-upcoming-meta">'+(ev.source||'custom').toUpperCase()+' · '+ev.time+'</div></div></div>';
    });
    el.innerHTML = html;
}

// ── Update workspace stats when action items change ──
const _origSaveActionItems = saveActionItems;
saveActionItems = function() {
    localStorage.setItem('s4ActionItems', JSON.stringify(s4ActionItems));
    updateNotifBadge();
    renderHubActions();
    // Also update hub badge
    const open = s4ActionItems.filter(a => !a.done).length;
    const badge = document.getElementById('hubActionBadge'); if (badge) badge.textContent = open > 0 ? open : '0';
};

// ═══ AUDIT RECORD VAULT ═══
let s4Vault = JSON.parse(localStorage.getItem('s4Vault') || '[]');
function saveVault() { localStorage.setItem('s4Vault', JSON.stringify(s4Vault)); }

function addToVault(record) {
    // record = {hash, txHash, type, label, branch, icon, content, encrypted, timestamp, source, fee}
    if (s4Vault.find(v => v.hash === record.hash && v.txHash === record.txHash)) return;
    record.verified = true;
    record.verifiedAt = new Date().toISOString();
    s4Vault.unshift(record);
    saveVault();
    // Show workspace notification
    showWorkspaceNotification('Record saved to Audit Vault', record.label || record.type);
}

function renderVault() {
    const container = document.getElementById('vaultRecords');
    if (!container) return;
    let items = [...s4Vault];
    // Search filter
    const search = (document.getElementById('vaultSearch')?.value || '').toLowerCase();
    if (search) items = items.filter(v => (v.label||'').toLowerCase().includes(search) || (v.hash||'').toLowerCase().includes(search) || (v.content||'').toLowerCase().includes(search) || (v.type||'').toLowerCase().includes(search));
    // Time filter
    const timeFilter = document.getElementById('vaultFilter')?.value || 'all';
    const now = new Date();
    if (timeFilter === 'today') items = items.filter(v => new Date(v.timestamp).toDateString() === now.toDateString());
    else if (timeFilter === 'week') { const w = new Date(now - 7*864e5); items = items.filter(v => new Date(v.timestamp) >= w); }
    else if (timeFilter === 'last_week') { const w1 = new Date(now - 14*864e5); const w2 = new Date(now - 7*864e5); items = items.filter(v => { const d = new Date(v.timestamp); return d >= w1 && d < w2; }); }
    else if (timeFilter === 'month') { const m = new Date(now.getFullYear(), now.getMonth(), 1); items = items.filter(v => new Date(v.timestamp) >= m); }
    else if (timeFilter === 'last_month') { const m1 = new Date(now.getFullYear(), now.getMonth()-1, 1); const m2 = new Date(now.getFullYear(), now.getMonth(), 1); items = items.filter(v => { const d = new Date(v.timestamp); return d >= m1 && d < m2; }); }
    else if (timeFilter === 'year') { const y = new Date(now.getFullYear(), 0, 1); items = items.filter(v => new Date(v.timestamp) >= y); }
    else if (timeFilter === 'last_year') { const y1 = new Date(now.getFullYear()-1, 0, 1); const y2 = new Date(now.getFullYear(), 0, 1); items = items.filter(v => { const d = new Date(v.timestamp); return d >= y1 && d < y2; }); }

    // Update stats
    const el = id => document.getElementById(id);
    if (el('vaultTotal')) el('vaultTotal').textContent = s4Vault.length;
    if (el('vaultVerified')) el('vaultVerified').textContent = s4Vault.filter(v => v.verified).length;
    if (el('vaultTypes')) el('vaultTypes').textContent = new Set(s4Vault.map(v => v.type)).size;
    if (el('vaultFees')) el('vaultFees').textContent = '$' + (s4Vault.length * 0.01).toFixed(2);

    if (items.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px 20px;color:var(--muted)"><i class="fas fa-vault" style="font-size:2.5rem;margin-bottom:12px;opacity:0.3"></i><p>' + (search ? 'No records match your search.' : 'No anchored records yet. Records will appear here automatically as you anchor them.') + '</p></div>';
        return;
    }

    container.innerHTML = items.map((v, i) => `
        <div class="vault-record" style="animation:slideUp ${0.2 + i * 0.05}s ease">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">
                <div>
                    <span style="font-size:1rem;margin-right:6px">${v.icon || '📋'}</span>
                    <strong style="color:#fff;font-size:0.88rem">${v.label || v.type}</strong>
                    <span style="font-size:0.72rem;color:var(--muted);margin-left:8px">${v.branch || ''}</span>
                </div>
                <div style="display:flex;gap:6px">
                    ${v.verified ? '<span class="vault-badge verified"><i class="fas fa-check-circle"></i> Verified</span>' : '<span class="vault-badge anchored"><i class="fas fa-anchor"></i> Anchored</span>'}
                    ${v.encrypted ? '<span class="vault-badge" style="background:rgba(201,168,76,0.15);color:var(--gold);border:1px solid rgba(201,168,76,0.3)"><i class="fas fa-lock"></i> Encrypted</span>' : ''}
                </div>
            </div>
            <div class="vault-hash"><i class="fas fa-fingerprint" style="margin-right:6px;opacity:0.6"></i>${v.hash}</div>
            ${v.content ? '<div style="font-size:0.78rem;color:var(--steel);margin-bottom:8px;padding:6px 10px;background:var(--surface);border-radius:6px"><i class="fas fa-file-lines" style="margin-right:6px;opacity:0.5"></i>' + v.content + '</div>' : ''}
            <div class="vault-meta">
                <span><i class="fas fa-clock"></i> ${new Date(v.timestamp).toLocaleString()}</span>
                <span><i class="fas fa-hashtag"></i> TX: ${(v.txHash || '').substring(0, 16)}...</span>
                ${v.source ? '<span><i class="fas fa-tools"></i> ' + v.source + '</span>' : ''}
                <span><i class="fas fa-coins"></i> 0.01 $SLS</span>
            </div>
        </div>
    `).join('');
}

function exportVault(format) {
    if (s4Vault.length === 0) { alert('No records to export.'); return; }
    const rows = s4Vault.map(v => ({
        'Record Type': v.label || v.type, 'Branch': v.branch || '', 'SHA-256 Hash': v.hash,
        'TX Hash': v.txHash || '', 'Content Preview': v.content || '', 'Encrypted': v.encrypted ? 'Yes' : 'No',
        'Timestamp': v.timestamp, 'Verified': v.verified ? 'Yes' : 'No', 'Source Tool': v.source || 'Manual Anchor',
        '$SLS Fee': '0.01'
    }));
    if (format === 'csv') {
        const headers = Object.keys(rows[0]);
        const csv = [headers.join(','), ...rows.map(r => headers.map(h => '"' + (r[h]||'').toString().replace(/"/g,'""') + '"').join(','))].join('\n');
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 's4_audit_vault_' + new Date().toISOString().split('T')[0] + '.csv'; a.click();
    } else {
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Audit Vault');
        XLSX.writeFile(wb, 's4_audit_vault_' + new Date().toISOString().split('T')[0] + '.xlsx');
    }
}

async function verifyAllVault() {
    let verified = 0;
    s4Vault.forEach(v => { v.verified = true; v.verifiedAt = new Date().toISOString(); verified++; });
    saveVault();
    renderVault();
    showWorkspaceNotification('Vault Verification Complete', verified + ' records re-verified');
}

function clearVault() {
    if (!confirm('Clear all ' + s4Vault.length + ' records from the audit vault? This cannot be undone.')) return;
    s4Vault = [];
    saveVault();
    renderVault();
}

// Workspace notification system
function showWorkspaceNotification(title, detail) {
    const existing = document.querySelectorAll('.workspace-notification');
    existing.forEach(n => n.remove());
    const notif = document.createElement('div');
    notif.className = 'workspace-notification';
    notif.innerHTML = '<button class="notif-close" onclick="this.parentElement.remove()">&times;</button><div style="display:flex;align-items:center;gap:10px"><i class="fas fa-check-circle" style="color:var(--green);font-size:1.2rem"></i><div><strong>' + title + '</strong><div style="font-size:0.78rem;color:var(--muted);margin-top:2px">' + (detail||'') + '</div></div></div>';
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 5000);
}

// ═══ DEFENSE DOCUMENT REFERENCE LIBRARY ═══
let docCatFilter = 'all';
function renderDocLibrary() {
    const container = document.getElementById('docList');
    const countEl = document.getElementById('docResultCount');
    const catBar = document.getElementById('docCatFilters');
    if (!container || typeof S4_DEFENSE_DOCS === 'undefined') return;

    // Build category filter buttons (once)
    if (catBar && !catBar.dataset.built) {
        const cats = [...new Set(S4_DEFENSE_DOCS.map(d => d.category))].sort();
        catBar.innerHTML = '<button class="doc-filter-btn active" onclick="setDocCat(\'all\',this)">All</button>' +
            cats.map(c => {
                const meta = (typeof DOC_CATEGORIES !== 'undefined' && DOC_CATEGORIES[c]) || {};
                return '<button class="doc-filter-btn" onclick="setDocCat(\'' + c + '\',this)"><i class="fas ' + (meta.icon||'fa-file') + '" style="margin-right:4px;color:' + (meta.color||'var(--accent)') + '"></i>' + c + '</button>';
            }).join('');
        catBar.dataset.built = '1';
    }
    // Update doc count header
    if (document.getElementById('docCount')) document.getElementById('docCount').textContent = S4_DEFENSE_DOCS.length + ' documents';

    let docs = [...S4_DEFENSE_DOCS];
    // Branch filter
    const branch = document.getElementById('docBranchFilter')?.value || 'all';
    if (branch !== 'all') docs = docs.filter(d => d.branch === branch);
    // Category filter
    if (docCatFilter !== 'all') docs = docs.filter(d => d.category === docCatFilter);
    // Search
    const search = (document.getElementById('docSearch')?.value || '').toLowerCase();
    if (search) docs = docs.filter(d => d.id.toLowerCase().includes(search) || d.title.toLowerCase().includes(search) || d.description.toLowerCase().includes(search) || d.keywords.toLowerCase().includes(search));

    if (countEl) countEl.textContent = docs.length + ' of ' + S4_DEFENSE_DOCS.length + ' documents';

    if (docs.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)"><i class="fas fa-search" style="font-size:2rem;margin-bottom:12px;opacity:0.3"></i><p>No documents match your filters.</p></div>';
        return;
    }

    container.innerHTML = docs.map((d, i) => {
        const catMeta = (typeof DOC_CATEGORIES !== 'undefined' && DOC_CATEGORIES[d.category]) || {};
        const brMeta = (typeof DOC_BRANCHES !== 'undefined' && DOC_BRANCHES[d.branch]) || {};
        return `<div class="doc-card" onclick="window.open('${d.url}','_blank')" style="animation:slideUp ${0.15 + i * 0.03}s ease">
            <div class="doc-id">${d.id}</div>
            <div class="doc-title">${d.title}</div>
            <div class="doc-desc">${d.description}</div>
            <div class="doc-tags">
                <span class="doc-tag" style="background:${catMeta.color || 'var(--accent)'}22;color:${catMeta.color || 'var(--accent)'}"><i class="fas ${catMeta.icon || 'fa-file'}" style="margin-right:3px"></i>${d.category}</span>
                <span class="doc-tag" style="background:${brMeta.color || '#666'}22;color:${brMeta.color || '#999'}">${brMeta.label || d.branch}</span>
            </div>
        </div>`;
    }).join('');
}

function setDocCat(cat, btn) {
    docCatFilter = cat;
    document.querySelectorAll('.doc-filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    renderDocLibrary();
}

// ═══ COMPLIANCE SCORECARD ═══
function calcCompliance() {
    // Calculate compliance based on workspace activity
    const vault = s4Vault.length;
    const actions = s4ActionItems.length;
    const actionsDone = s4ActionItems.filter(a => a.done).length;

    // CMMC: Based on record anchoring (data integrity controls)
    const cmmc = Math.min(100, Math.round(vault >= 50 ? 95 : vault >= 20 ? 80 : vault >= 5 ? 60 : vault >= 1 ? 35 : 10));
    // NIST 800-171: Based on encryption usage and anchoring
    const encryptedCount = s4Vault.filter(v => v.encrypted).length;
    const nist = Math.min(100, Math.round(vault >= 20 ? 85 + (encryptedCount/Math.max(vault,1))*15 : vault >= 5 ? 55 + vault : vault >= 1 ? 30 : 8));
    // DFARS: Based on CUI handling and audit trail
    const dfars = Math.min(100, Math.round(vault >= 10 ? 88 : vault >= 3 ? 65 : vault >= 1 ? 40 : 12));
    // FAR 46 Quality: Based on warranty tracking and action items
    const far = Math.min(100, Math.round(actions > 0 ? 70 + Math.min(30, actionsDone/Math.max(actions,1)*30) : 15));
    // ILS (MIL-STD-1388): Based on tools used
    const toolsUsed = new Set(s4Vault.map(v => v.source).filter(Boolean)).size;
    const ils = Math.min(100, Math.round(toolsUsed >= 6 ? 92 : toolsUsed >= 3 ? 70 : toolsUsed >= 1 ? 45 : 10));
    // DMSMS: Based on DMSMS records anchored
    const dmsmsRecords = s4Vault.filter(v => v.source === 'DMSMS Tracker').length;
    const dmsmsMgmt = Math.min(100, Math.round(dmsmsRecords >= 5 ? 90 : dmsmsRecords >= 2 ? 65 : dmsmsRecords >= 1 ? 40 : 8));

    // Overall score (weighted)
    const overall = Math.round(cmmc * 0.25 + nist * 0.2 + dfars * 0.15 + far * 0.15 + ils * 0.15 + dmsmsMgmt * 0.1);

    // Update bars
    const setBar = (id, pctId, val) => {
        const bar = document.getElementById(id);
        const pct = document.getElementById(pctId);
        if (bar) bar.style.width = val + '%';
        if (pct) { pct.textContent = val + '%'; pct.style.color = val >= 80 ? 'var(--green)' : val >= 50 ? 'var(--gold)' : '#ff6b6b'; }
    };
    setBar('barCMMC','pctCMMC', cmmc);
    setBar('barNIST','pctNIST', nist);
    setBar('barDFARS','pctDFARS', dfars);
    setBar('barFAR','pctFAR', far);
    setBar('barILS','pctILS', ils);
    setBar('barDMSMSmgmt','pctDMSMSmgmt', dmsmsMgmt);

    // Update ring
    const arc = document.getElementById('complianceArc');
    if (arc) arc.style.strokeDashoffset = 326.7 - (326.7 * overall / 100);
    const scoreEl = document.getElementById('complianceScore');
    if (scoreEl) scoreEl.textContent = overall + '%';
    const gradeEl = document.getElementById('complianceGrade');
    if (gradeEl) {
        const grade = overall >= 95 ? 'A+' : overall >= 90 ? 'A' : overall >= 85 ? 'A-' : overall >= 80 ? 'B+' : overall >= 75 ? 'B' : overall >= 70 ? 'B-' : overall >= 65 ? 'C+' : overall >= 60 ? 'C' : overall >= 50 ? 'D' : 'F';
        const gColor = overall >= 80 ? 'var(--green)' : overall >= 60 ? 'var(--gold)' : '#ff6b6b';
        gradeEl.textContent = grade;
        gradeEl.style.background = 'linear-gradient(135deg,' + gColor + '22,' + gColor + '11)';
        gradeEl.style.color = gColor;
        gradeEl.style.border = '2px solid ' + gColor + '55';
        gradeEl.style.boxShadow = '0 0 20px ' + gColor + '33';
    }

    // Recommendations
    const recs = [];
    if (vault === 0) recs.push('<i class="fas fa-arrow-right" style="color:var(--accent);margin-right:6px"></i> <strong>Anchor your first record</strong> to establish a tamper-proof audit trail and start building your compliance posture.');
    if (cmmc < 80) recs.push('<i class="fas fa-arrow-right" style="color:#e74c3c;margin-right:6px"></i> <strong>Increase anchored records</strong> — CMMC Level 2 requires demonstrable data integrity controls. Anchor 20+ records to reach 80%+ coverage.');
    if (encryptedCount < vault * 0.5 && vault > 0) recs.push('<i class="fas fa-arrow-right" style="color:#3498db;margin-right:6px"></i> <strong>Enable encryption</strong> on more records — over 50% of your records are unencrypted. CUI requires protection per NIST 800-171.');
    if (ils < 70) recs.push('<i class="fas fa-arrow-right" style="color:#9b59b6;margin-right:6px"></i> <strong>Use more ILS tools</strong> — run DMSMS checks, readiness calculations, and lifecycle estimates to improve MIL-STD-1388 compliance.');
    if (actions > 0 && actionsDone / actions < 0.5) recs.push('<i class="fas fa-arrow-right" style="color:var(--gold);margin-right:6px"></i> <strong>Resolve open action items</strong> — ' + (actions - actionsDone) + ' of ' + actions + ' items are still open. Completing these improves FAR 46 quality scores.');
    if (dmsmsRecords === 0) recs.push('<i class="fas fa-arrow-right" style="color:#ff6b6b;margin-right:6px"></i> <strong>Run a DMSMS analysis</strong> and anchor the results to demonstrate proactive obsolescence management per DoDI 4245.15.');
    if (recs.length === 0) recs.push('<i class="fas fa-check-circle" style="color:var(--green);margin-right:6px"></i> <strong>Excellent compliance posture!</strong> Continue anchoring records and monitoring DMSMS, readiness, and warranty status.');

    const recsEl = document.getElementById('complianceRecs');
    if (recsEl) recsEl.innerHTML = recs.map(r => '<div style="margin-bottom:8px">' + r + '</div>').join('');

    // Populate program selector
    const sel = document.getElementById('complianceProgram');
    if (sel && sel.options.length === 0) populateAllDropdowns();
}

function exportCompliance() {
    const data = {
        'Overall Score': document.getElementById('complianceScore')?.textContent || '',
        'Grade': document.getElementById('complianceGrade')?.textContent || '',
        'CMMC Level 2': document.getElementById('pctCMMC')?.textContent || '',
        'NIST 800-171': document.getElementById('pctNIST')?.textContent || '',
        'DFARS 252.204': document.getElementById('pctDFARS')?.textContent || '',
        'FAR 46 Quality': document.getElementById('pctFAR')?.textContent || '',
        'MIL-STD-1388 ILS': document.getElementById('pctILS')?.textContent || '',
        'DMSMS Management': document.getElementById('pctDMSMSmgmt')?.textContent || '',
        'Records Anchored': s4Vault.length,
        'Action Items': s4ActionItems.length,
        'Generated': new Date().toISOString()
    };
    const ws = XLSX.utils.json_to_sheet([data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Compliance Scorecard');
    XLSX.writeFile(wb, 's4_compliance_scorecard_' + new Date().toISOString().split('T')[0] + '.xlsx');
}

async function anchorCompliance() {
    const score = document.getElementById('complianceScore')?.textContent || '0%';
    const grade = document.getElementById('complianceGrade')?.textContent || '?';
    const content = 'S4 Ledger Compliance Scorecard | Overall: ' + score + ' (' + grade + ') | CMMC: ' + (document.getElementById('pctCMMC')?.textContent||'') + ' | NIST: ' + (document.getElementById('pctNIST')?.textContent||'') + ' | Records: ' + s4Vault.length + ' | Generated: ' + new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Compliance Scorecard', 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'compliance_scorecard', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'compliance_scorecard', label:'Compliance Scorecard', branch:'JOINT', icon:'🛡️', content: content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Compliance Scorecard', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; updateStats(); saveStats();
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ── Provisioning & PTD Manager ──
let provItems = JSON.parse(localStorage.getItem('s4_prov_items') || '[]');
let provCustomItems = JSON.parse(localStorage.getItem('s4_prov_custom') || '[]');
let provView = 'demo';

// ── 40 Hypothetical Demo Provisioning Items ──
const PROV_DEMO_DATA = [
    {name:'Valve, Gate, Carbon Steel 3"',nsn:'5340-01-234-5678',cage:'1THK9',fsc:'5340',qty:50,status:'validated',cost:187.50,mfg:'Crane Co.',apl:'APL-1001',notes:'MIL-V-24509 compliant'},
    {name:'Filter Element, Hydraulic',nsn:'4330-01-456-7890',cage:'3A5K2',fsc:'4330',qty:120,status:'validated',cost:42.75,mfg:'Parker Hannifin',apl:'APL-1001',notes:'Lube oil system primary'},
    {name:'Gasket Set, Diesel Engine',nsn:'5330-01-789-0123',cage:'80063',fsc:'5330',qty:30,status:'validated',cost:312.00,mfg:'Caterpillar',apl:'APL-1002',notes:'SSDG overhaul kit'},
    {name:'Pump, Centrifugal, Seawater',nsn:'4320-01-345-6789',cage:'53279',fsc:'4320',qty:4,status:'submitted',cost:8750.00,mfg:'Flowserve',apl:'APL-1001',notes:'Firemain service pump'},
    {name:'Circuit Breaker, 400A',nsn:'5925-01-567-8901',cage:'28480',fsc:'5925',qty:12,status:'validated',cost:2340.00,mfg:'Eaton',apl:'APL-1003',notes:'SWBD 1A/1B main feeder'},
    {name:'Bearing, Ball, Sealed',nsn:'3110-01-234-5670',cage:'57982',fsc:'3110',qty:200,status:'validated',cost:18.90,mfg:'SKF',apl:'APL-1002',notes:'Aux machinery rotating equip'},
    {name:'Cable Assembly, Power',nsn:'6150-01-678-9012',cage:'81349',fsc:'6150',qty:85,status:'pending',cost:96.50,mfg:'General Cable',apl:'APL-1003',notes:'2/0 AWG LSDSGU per MIL-C-24643'},
    {name:'Transmitter, Pressure',nsn:'6685-01-890-1234',cage:'27014',fsc:'6685',qty:16,status:'validated',cost:1875.00,mfg:'Rosemount (Emerson)',apl:'APL-1004',notes:'HP air system 3000 PSI'},
    {name:'Motor, Electric, 100HP',nsn:'6105-01-012-3456',cage:'81349',fsc:'6105',qty:3,status:'submitted',cost:14500.00,mfg:'WEG Electric',apl:'APL-1002',notes:'Fire pump drive motor'},
    {name:'Connector, Electrical, MIL-SPEC',nsn:'5935-01-345-6780',cage:'06324',fsc:'5935',qty:500,status:'validated',cost:8.25,mfg:'Amphenol',apl:'APL-1003',notes:'MIL-DTL-38999 Series III'},
    {name:'Radar Antenna Feed Horn',nsn:'5841-01-567-8900',cage:'13499',fsc:'5841',qty:2,status:'pending',cost:45000.00,mfg:'Raytheon',apl:'APL-1005',notes:'AN/SPY-1D(V) feed assembly'},
    {name:'Turbine Blade, HP Stage 1',nsn:'2840-01-789-0120',cage:'77445',fsc:'2840',qty:48,status:'submitted',cost:3200.00,mfg:'GE Aviation',apl:'APL-1002',notes:'LM2500 hot section'},
    {name:'Gyroscope, Ring Laser',nsn:'6615-01-890-1230',cage:'73030',fsc:'6615',qty:3,status:'validated',cost:67000.00,mfg:'Honeywell',apl:'APL-1004',notes:'Navigation system MK 39 MOD 3'},
    {name:'Heat Exchanger, Plate Type',nsn:'4420-01-012-3450',cage:'0BVD7',fsc:'4420',qty:6,status:'validated',cost:4500.00,mfg:'Alfa Laval',apl:'APL-1001',notes:'Lube oil cooler'},
    {name:'Hose Assembly, Hydraulic, High Pressure',nsn:'4720-01-234-5671',cage:'71984',fsc:'4720',qty:40,status:'validated',cost:145.00,mfg:'Eaton Aeroquip',apl:'APL-1001',notes:'Steering gear 3000 PSI'},
    {name:'Switch, Limit, Watertight',nsn:'5930-01-456-7891',cage:'77884',fsc:'5930',qty:25,status:'rejected',cost:89.00,mfg:'Micro Switch (Honeywell)',apl:'APL-1003',notes:'Failed moisture ingress test — resubmit'},
    {name:'Relay, Solid State, 50A',nsn:'5945-01-678-9013',cage:'80058',fsc:'5945',qty:60,status:'validated',cost:125.00,mfg:'Crydom',apl:'APL-1003',notes:'Power distribution panel'},
    {name:'Solenoid Valve, 2-Way',nsn:'4810-01-890-1235',cage:'99760',fsc:'4810',qty:18,status:'submitted',cost:675.00,mfg:'ASCO (Emerson)',apl:'APL-1004',notes:'Ballast system control'},
    {name:'O-Ring Kit, Buna-N',nsn:'5331-01-012-3457',cage:'81348',fsc:'5331',qty:500,status:'validated',cost:2.50,mfg:'Parker',apl:'APL-1001',notes:'Standard sizes per MIL-PRF-28776'},
    {name:'Fan, Axial, Ventilation',nsn:'4140-01-234-5679',cage:'30591',fsc:'4140',qty:8,status:'pending',cost:3200.00,mfg:'Joy Manufacturing',apl:'APL-1001',notes:'Supply ventilation zone 3'},
    {name:'Transformer, Power, Dry',nsn:'6120-01-456-7892',cage:'80058',fsc:'6120',qty:4,status:'validated',cost:18700.00,mfg:'Hammond Mfg',apl:'APL-1003',notes:'450V/120V ship service'},
    {name:'Compressor, Air, Reciprocating',nsn:'4310-01-678-9014',cage:'0BVP3',fsc:'4310',qty:2,status:'submitted',cost:42000.00,mfg:'Ingersoll Rand',apl:'APL-1002',notes:'HP air 3000 PSI'},
    {name:'FLIR Sensor Module',nsn:'5855-01-890-1236',cage:'13499',fsc:'5855',qty:2,status:'pending',cost:125000.00,mfg:'Raytheon',apl:'APL-1005',notes:'EO/IR turret replacement LRU'},
    {name:'Winch, Anchor, Electric',nsn:'3950-01-012-3458',cage:'00000',fsc:'3950',qty:1,status:'validated',cost:89000.00,mfg:'Rolls-Royce Marine',apl:'APL-1002',notes:'Fwd anchor windlass'},
    {name:'Pipe, Carbon Steel, Sch 80',nsn:'4710-01-234-5680',cage:'81349',fsc:'4710',qty:2000,status:'validated',cost:12.75,mfg:'Wheatland Tube',apl:'APL-1001',notes:'2" NPS per MIL-P-21305'},
    {name:'Radar Display Unit',nsn:'5895-01-456-7893',cage:'13499',fsc:'5895',qty:4,status:'validated',cost:38000.00,mfg:'Raytheon',apl:'APL-1005',notes:'CIC operator console'},
    {name:'Generator, Diesel, 1000KW',nsn:'6115-01-678-9015',cage:'31828',fsc:'6115',qty:3,status:'submitted',cost:475000.00,mfg:'Caterpillar Marine',apl:'APL-1002',notes:'SSDG set'},
    {name:'Chiller, Water, Centrifugal',nsn:'4130-01-890-1237',cage:'30591',fsc:'4130',qty:2,status:'validated',cost:185000.00,mfg:'York (JCI)',apl:'APL-1001',notes:'HVAC chilled water plant'},
    {name:'Missile Canister, VLS',nsn:'1440-01-012-3459',cage:'30003',fsc:'1440',qty:8,status:'pending',cost:95000.00,mfg:'Lockheed Martin',apl:'APL-1005',notes:'MK 41 VLS cell liner'},
    {name:'Degaussing Cable Assembly',nsn:'5945-01-234-5681',cage:'53279',fsc:'5945',qty:12,status:'validated',cost:4500.00,mfg:'Ultra Electronics',apl:'APL-1004',notes:'M-coil degaussing system'},
    {name:'Helm Control Unit',nsn:'2090-01-456-7894',cage:'53279',fsc:'2090',qty:2,status:'validated',cost:52000.00,mfg:'Rolls-Royce Marine',apl:'APL-1004',notes:'Steering control console'},
    {name:'Fire Suppression Agent, AFFF',nsn:'4210-01-678-9016',cage:'64879',fsc:'4210',qty:500,status:'validated',cost:28.50,mfg:'National Foam',apl:'APL-1001',notes:'6% AFFF per MIL-F-24385'},
    {name:'Antenna, UHF/SHF SATCOM',nsn:'5985-01-890-1238',cage:'13499',fsc:'5985',qty:2,status:'submitted',cost:78000.00,mfg:'Raytheon',apl:'APL-1005',notes:'AN/WSC-6(V)9 SATCOM'},
    {name:'Actuator, Linear, Electro-Hydraulic',nsn:'1680-01-012-3460',cage:'73030',fsc:'1680',qty:6,status:'rejected',cost:14200.00,mfg:'Moog Inc.',apl:'APL-1004',notes:'Rejected — missing source approval, resubmit w/ CAGE verification'},
    {name:'Reduction Gear Assembly',nsn:'3010-01-234-5682',cage:'00000',fsc:'3010',qty:1,status:'submitted',cost:2100000.00,mfg:'Philadelphia Gear',apl:'APL-1002',notes:'Main reduction gear, double helical'},
    {name:'Weapon Elevator Motor',nsn:'3540-01-456-7895',cage:'30003',fsc:'3540',qty:4,status:'pending',cost:35000.00,mfg:'Lockheed Martin',apl:'APL-1005',notes:'MK 41 VLS weapon handling'},
    {name:'CIWS Barrel Assembly',nsn:'1005-01-678-9017',cage:'13499',fsc:'1005',qty:3,status:'validated',cost:42000.00,mfg:'Raytheon',apl:'APL-1005',notes:'MK 15 Phalanx 20mm'},
    {name:'Hull Valve, Sea Chest',nsn:'4820-01-890-1239',cage:'53279',fsc:'4820',qty:6,status:'validated',cost:7800.00,mfg:'Tyco Marine',apl:'APL-1001',notes:'12" butterfly, seawater service'},
    {name:'Crypto Module, KGV-135',nsn:'5810-01-012-3461',cage:'97868',fsc:'5810',qty:8,status:'submitted',cost:28000.00,mfg:'L3 Harris',apl:'APL-1004',notes:'TACLANE network encryptor'},
    {name:'Navigation Radar Scanner',nsn:'5841-01-234-5683',cage:'23435',fsc:'5841',qty:2,status:'validated',cost:56000.00,mfg:'Furuno',apl:'APL-1004',notes:'Surface search/navigation'}
];

function saveProvItems() { localStorage.setItem('s4_prov_items', JSON.stringify(provItems)); }
function saveProvCustom() { localStorage.setItem('s4_prov_custom', JSON.stringify(provCustomItems)); }

function provSetView(view) {
    provView = view;
    document.getElementById('provViewDemo').style.background = view==='demo' ? 'linear-gradient(135deg,#9b59b6,#7d3c98)' : 'rgba(155,89,182,0.1)';
    document.getElementById('provViewDemo').style.color = view==='demo' ? '#fff' : '#9b59b6';
    document.getElementById('provViewDemo').style.border = view==='demo' ? 'none' : '1px solid rgba(155,89,182,0.3)';
    document.getElementById('provViewCustom').style.background = view==='custom' ? 'linear-gradient(135deg,#9b59b6,#7d3c98)' : 'rgba(155,89,182,0.1)';
    document.getElementById('provViewCustom').style.color = view==='custom' ? '#fff' : '#9b59b6';
    document.getElementById('provViewCustom').style.border = view==='custom' ? 'none' : '1px solid rgba(155,89,182,0.3)';
    document.getElementById('provCustomForm').style.display = view==='custom' ? 'block' : 'none';
    renderProvTable();
}

function getActiveProvItems() {
    return provView === 'custom' ? provCustomItems : provItems;
}

function addCustomProvItem() {
    const name = document.getElementById('provCustomName')?.value?.trim();
    if (!name) { showWorkspaceNotification('Part name is required', 'warning'); return; }
    const nsn = document.getElementById('provCustomNSN')?.value?.trim() || generateNSN();
    const cage = document.getElementById('provCustomCAGE')?.value?.trim() || '00000';
    const fsc = document.getElementById('provCustomFSC')?.value || '5340';
    const qty = parseInt(document.getElementById('provCustomQty')?.value) || 1;
    const status = document.getElementById('provCustomStatus')?.value || 'submitted';
    const cost = parseFloat(document.getElementById('provCustomCost')?.value) || 0;
    const mfg = document.getElementById('provCustomMfg')?.value?.trim() || 'TBD';
    const notes = document.getElementById('provCustomNotes')?.value?.trim() || '';
    const item = { name, nsn, cage, fsc, qty, status, cost, mfg, apl:'CUSTOM-' + (provCustomItems.length+1), notes, custom:true, added: new Date().toISOString() };
    provCustomItems.push(item);
    saveProvCustom();
    // Clear form
    ['provCustomName','provCustomNSN','provCustomCAGE','provCustomNotes','provCustomMfg'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
    document.getElementById('provCustomQty').value = '1';
    document.getElementById('provCustomCost').value = '';
    provSetView('custom');
    renderProvTable();
    updateProvStats();
    showWorkspaceNotification('Custom item added: ' + name);
}

function clearCustomProvItems() {
    if (!confirm('Clear all custom provisioning items?')) return;
    provCustomItems = [];
    saveProvCustom();
    renderProvTable();
    updateProvStats();
    showWorkspaceNotification('Custom items cleared');
}

function generateNSN() {
    const fscGroups = ['1005','2815','2840','3110','4320','4710','4820','5330','5340','5820','5841','5895','5925','5935','5945','5962','6105','6115','6150','6625','6685'];
    const fsc = fscGroups[Math.floor(Math.random()*fscGroups.length)];
    return fsc + '-' + String(Math.floor(Math.random()*90+10)) + '-' + String(Math.floor(Math.random()*900+100)) + '-' + String(Math.floor(Math.random()*9000+1000));
}

function renderProvTable() {
    const items = getActiveProvItems();
    const container = document.getElementById('provPartsTable');
    const footer = document.getElementById('provTableFooter');
    if (!items || items.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:30px;color:var(--muted)"><i class="fas fa-database" style="font-size:1.5rem;opacity:0.3;margin-bottom:8px;display:block"></i>' + (provView==='custom' ? 'No custom items yet. Use the form above to add parts.' : 'Click "Load Sample Data" to populate with 40 demo items.') + '</div>';
        if (footer) footer.style.display = 'none';
        return;
    }
    const search = (document.getElementById('provSearchInput')?.value || '').toLowerCase();
    const statusFilter = document.getElementById('provFilterStatus')?.value || 'all';
    const filtered = items.filter(it => {
        if (statusFilter !== 'all' && it.status !== statusFilter) return false;
        if (search && !it.name.toLowerCase().includes(search) && !it.nsn.toLowerCase().includes(search) && !(it.mfg||'').toLowerCase().includes(search)) return false;
        return true;
    });
    const statusColors = {validated:'#14f195', submitted:'#00aaff', pending:'#ffa500', rejected:'#ff3333'};
    let html = '<table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:2px solid rgba(155,89,182,0.3);font-size:0.72rem;text-transform:uppercase;color:var(--muted)">';
    html += '<th style="padding:6px 8px;text-align:left">Part Name</th><th style="padding:6px 8px">NSN</th><th style="padding:6px 8px">CAGE</th><th style="padding:6px 8px;text-align:right">Qty</th><th style="padding:6px 8px;text-align:right">Unit $</th><th style="padding:6px 8px;text-align:center">Status</th><th style="padding:6px 8px">Mfg</th><th style="padding:6px 8px;text-align:center">Action</th></tr></thead><tbody>';
    filtered.forEach((it, i) => {
        const sc = statusColors[it.status] || '#fff';
        const totalVal = (it.qty * it.cost).toLocaleString('en-US',{style:'currency',currency:'USD'});
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.03);transition:background 0.2s" onmouseenter="this.style.background=\'rgba(155,89,182,0.06)\'" onmouseleave="this.style.background=\'transparent\'">';
        html += '<td style="padding:6px 8px;color:#fff;font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+it.name+(it.notes?' — '+it.notes:'')+'">'+it.name+'</td>';
        html += '<td style="padding:6px 8px;font-family:monospace;color:#c9a84c;font-size:0.75rem">'+it.nsn+'</td>';
        html += '<td style="padding:6px 8px;font-family:monospace;font-size:0.75rem">'+it.cage+'</td>';
        html += '<td style="padding:6px 8px;text-align:right">'+it.qty+'</td>';
        html += '<td style="padding:6px 8px;text-align:right;color:#14f195">$'+it.cost.toLocaleString()+'</td>';
        html += '<td style="padding:6px 8px;text-align:center"><span style="color:'+sc+';font-weight:600;font-size:0.72rem;padding:2px 8px;border-radius:4px;background:'+sc+'15;border:1px solid '+sc+'30">'+it.status.toUpperCase()+'</span></td>';
        html += '<td style="padding:6px 8px;font-size:0.75rem;color:var(--steel)">'+it.mfg+'</td>';
        html += '<td style="padding:6px 8px;text-align:center"><button onclick="anchorProvItem('+i+')" style="background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.3);color:#c9a84c;border-radius:6px;padding:2px 8px;font-size:0.7rem;cursor:pointer;font-family:inherit" title="Anchor this item to XRPL"><i class="fas fa-anchor"></i></button></td>';
        html += '</tr>';
    });
    html += '</tbody></table>';
    container.innerHTML = html;
    if (footer) {
        footer.style.display = 'flex';
        const totalValue = filtered.reduce((s,it) => s + it.qty * it.cost, 0);
        document.getElementById('provTableCount').textContent = filtered.length + ' of ' + items.length + ' items' + (provView==='custom'?' (custom)':' (demo)');
        document.getElementById('provTableValue').textContent = 'Total value: ' + totalValue.toLocaleString('en-US',{style:'currency',currency:'USD'});
    }
    document.getElementById('provCustomCount').textContent = provCustomItems.length + ' custom items';
}

function filterProvTable() { renderProvTable(); }

function updateProvStats() {
    const items = getActiveProvItems();
    const total = items.length;
    const validated = items.filter(it => it.status==='validated').length;
    const submitted = items.filter(it => it.status==='submitted').length;
    const rejected = items.filter(it => it.status==='rejected').length;
    const pending = items.filter(it => it.status==='pending').length;
    const pct = total > 0 ? Math.round((validated/total)*100) : 0;
    const apls = [...new Set(items.map(it => it.apl))].length;

    document.getElementById('provParts').textContent = total;
    document.getElementById('provAPLs').textContent = apls;
    document.getElementById('provNSNs').textContent = validated;
    document.getElementById('provSchedule').textContent = pct >= 80 ? 'On Track' : pct >= 50 ? 'At Risk' : 'Behind';
    document.getElementById('provSchedule').style.color = pct >= 80 ? '#14f195' : pct >= 50 ? '#ffa500' : '#ff3333';

    document.getElementById('ptdSubmitted').textContent = submitted + validated + rejected + pending;
    document.getElementById('ptdValidated').textContent = validated;
    document.getElementById('ptdRejected').textContent = rejected;
    document.getElementById('ptdPending').textContent = pending;
    document.getElementById('ptdProgressBar').style.width = pct + '%';
    document.getElementById('ptdPctLabel').textContent = pct + '% Validated';
}

function loadProvisioningData() {
    const progKey = document.getElementById('provProgram')?.value;
    if (!progKey || !PROGS[progKey]) return;
    provItems = PROV_DEMO_DATA.map(it => ({...it}));
    saveProvItems();
    provSetView('demo');
    renderProvTable();
    updateProvStats();
    renderProvAPLList();
    renderProvNSNList();
    showWorkspaceNotification('40 sample provisioning items loaded for ' + PROGS[progKey].name);
}

function renderProvAPLList() {
    const items = getActiveProvItems();
    const aplGroups = {};
    items.forEach(it => { if (!aplGroups[it.apl]) aplGroups[it.apl] = []; aplGroups[it.apl].push(it); });
    const container = document.getElementById('provAPLList');
    if (Object.keys(aplGroups).length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)"><i class="fas fa-clipboard-list" style="font-size:1.5rem;opacity:0.3;margin-bottom:8px;display:block"></i>Load data to generate APLs.</div>';
        return;
    }
    let html = '';
    Object.entries(aplGroups).forEach(([apl, parts]) => {
        const allValidated = parts.every(p => p.status==='validated');
        const statusColor = allValidated ? '#14f195' : '#ffa500';
        const statusText = allValidated ? 'Complete' : 'In Progress';
        const totalVal = parts.reduce((s,p) => s + p.qty*p.cost, 0);
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid var(--border)">';
        html += '<div><strong style="color:#fff">' + apl + '</strong><br><span style="color:var(--muted);font-size:0.75rem">' + parts.length + ' line items | ' + totalVal.toLocaleString('en-US',{style:'currency',currency:'USD'}) + '</span></div>';
        html += '<span style="color:'+statusColor+';font-weight:600;font-size:0.78rem">' + statusText + '</span>';
        html += '</div>';
    });
    container.innerHTML = html;
}

function renderProvNSNList() {
    const items = getActiveProvItems();
    const container = document.getElementById('provNSNList');
    if (items.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)"><i class="fas fa-barcode" style="font-size:1.5rem;opacity:0.3;margin-bottom:8px;display:block"></i>NSN cataloging status will appear when data is loaded.</div>';
        return;
    }
    let html = '';
    items.slice(0, 15).forEach(it => {
        const catStatus = it.status === 'validated' ? 'Cataloged' : it.status === 'rejected' ? 'Rejected' : 'Pending';
        const catColor = catStatus==='Cataloged' ? '#14f195' : catStatus==='Rejected' ? '#ff3333' : '#ffa500';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03)">';
        html += '<span style="font-family:monospace;color:#c9a84c;font-size:0.78rem">' + it.nsn + '</span>';
        html += '<span style="color:'+catColor+';font-size:0.75rem;font-weight:600">' + catStatus + '</span>';
        html += '</div>';
    });
    if (items.length > 15) html += '<div style="text-align:center;padding:6px;color:var(--muted);font-size:0.75rem">... and ' + (items.length-15) + ' more NSNs</div>';
    container.innerHTML = html;
}

async function anchorProvItem(index) {
    const items = getActiveProvItems();
    const it = items[index];
    if (!it) return;
    const content = 'Provisioning Item | ' + it.name + ' | NSN: ' + it.nsn + ' | CAGE: ' + it.cage + ' | Qty: ' + it.qty + ' | Status: ' + it.status + ' | Cost: $' + it.cost + ' | Mfg: ' + it.mfg + ' | ' + new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Provisioning: ' + it.name, 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'provisioning_item', tx_hash:txHash, content_preview: it.name + ' NSN:' + it.nsn})}); } catch(e) {}
    addToVault({hash, txHash, type:'provisioning_item', label:'Provisioning: ' + it.name, branch:'JOINT', icon:'📦', content:content.substring(0,120), encrypted:false, timestamp:new Date().toISOString(), source:'Provisioning & PTD Manager', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('provisioning_item'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'provisioning_item', record_label:'Provisioning: '+it.name, branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
    showWorkspaceNotification('Anchored: ' + it.name + ' — 0.01 $SLS');
}

async function anchorAllProvisioning() {
    const items = getActiveProvItems();
    if (items.length === 0) { showWorkspaceNotification('No items to anchor. Load data first.', 'warning'); return; }
    if (!confirm('Anchor all ' + items.length + ' provisioning items to XRPL? (' + (items.length * 0.01).toFixed(2) + ' $SLS)')) return;
    let count = 0;
    for (const it of items) {
        const content = 'Provisioning Item | ' + it.name + ' | NSN: ' + it.nsn + ' | CAGE: ' + it.cage + ' | Qty: ' + it.qty + ' | Status: ' + it.status + ' | Cost: $' + it.cost + ' | Mfg: ' + it.mfg + ' | Batch | ' + new Date().toISOString();
        const hash = await sha256(content);
        const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
        try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'provisioning_item', tx_hash:txHash, content_preview: it.name})}); } catch(e) {}
        addToVault({hash, txHash, type:'provisioning_item', label:'Prov: ' + it.name, branch:'JOINT', icon:'📦', content:content.substring(0,120), encrypted:false, timestamp:new Date().toISOString(), source:'Provisioning & PTD Manager', fee:0.01});
        saveLocalRecord({hash, tx_hash:txHash, record_type:'provisioning_item', record_label:'Prov: '+it.name, branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
        stats.anchored++; stats.slsFees += 0.01;
        count++;
    }
    stats.types.add('provisioning_item'); updateStats(); saveStats();
    showWorkspaceNotification('Batch anchored ' + count + ' items — ' + (count * 0.01).toFixed(2) + ' $SLS total');
}

function generateAPLs() {
    const items = getActiveProvItems();
    if (items.length === 0) { loadProvisioningData(); return; }
    renderProvAPLList();
    showWorkspaceNotification('APLs generated from ' + items.length + ' provisioning items');
}

function exportProvisioning() {
    const items = getActiveProvItems();
    if (items.length === 0) { showWorkspaceNotification('No items to export. Load data first.', 'warning'); return; }
    const progKey = document.getElementById('provProgram')?.value;
    const progName = PROGS[progKey]?.name || 'Unknown';
    let csv = 'Part Name,NSN,CAGE,FSC,Qty,Unit Cost,Total Value,Status,APL,Manufacturer,Notes\n';
    items.forEach(it => {
        csv += '"'+it.name+'","'+it.nsn+'","'+it.cage+'","'+it.fsc+'",'+it.qty+','+it.cost+','+(it.qty*it.cost).toFixed(2)+',"'+it.status+'","'+it.apl+'","'+it.mfg+'","'+(it.notes||'').replace(/"/g,'""')+'"\n';
    });
    const header = 'S4 LEDGER PROVISIONING EXPORT\nProgram: '+progName+'\nDate: '+new Date().toISOString()+'\nItems: '+items.length+'\nTotal Value: $'+items.reduce((s,it)=>s+it.qty*it.cost,0).toLocaleString()+'\n\n';
    const blob = new Blob([header + csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 's4_provisioning_' + (progKey||'export') + '_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    showWorkspaceNotification('Provisioning CSV exported — ' + items.length + ' items');
}

async function anchorProvisioning() {
    const progKey = document.getElementById('provProgram')?.value;
    if (!progKey) { showWorkspaceNotification('Select a program first', 'warning'); return; }
    const prog = PROGS[progKey];
    const items = getActiveProvItems();
    const content = 'S4 Ledger Provisioning Report | Program: ' + prog.name + ' | Parts: ' + items.length + ' | Validated: ' + items.filter(i=>i.status==='validated').length + ' | Total Value: $' + items.reduce((s,it)=>s+it.qty*it.cost,0).toLocaleString() + ' | Generated: ' + new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Provisioning Report', 'FOUO');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'provisioning_report', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'provisioning_report', label:'Provisioning Report', branch: prog.branch || 'JOINT', icon:'📦', content: content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Provisioning & PTD Manager', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('provisioning_report'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'provisioning_report', record_label:'Provisioning Report — '+prog.name, branch:prog.branch||'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ═══════════════════════════════════════════════════════════════
// ═══ AI SUPPLY CHAIN RISK ENGINE ═══
// ═══════════════════════════════════════════════════════════════
let _riskCache = {};

function generateRiskItems(progKey) {
    const seed = progKey.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const rng = (i)=>((seed*131+i*997)%10000)/10000;
    const suppliers = ['Raytheon','BAE Systems','L3Harris','Northrop Grumman','General Dynamics','Honeywell','Collins Aerospace','Curtiss-Wright','Leonardo DRS','Elbit Systems','Safran','Thales','Ultra Electronics','Mercury Systems','Ducommun','Moog Inc','Kaman Aerospace','TransDigm','Heico Corp','Crane Co','Lockheed Martin','Boeing Defense','Huntington Ingalls','Pratt & Whitney','GE Aerospace','Rolls-Royce Defence','BWX Technologies','Oshkosh Defense','Bell Textron','Palantir Technologies','Anduril Industries','Kongsberg Defence','Aerojet Rocketdyne','Leidos','SAIC','Textron Systems','Sierra Nevada Corp'];
    const riskFactors = ['Single-source dependency','GIDEP Alert #2024-','DLA lead time spike +','Financial distress signal','CAGE code inactive','Foreign ownership change','Counterfeit risk — ERAI alert','Sub-tier supplier failure','Capacity constraint','Export control restriction','Cybersecurity incident','Material shortage — rare earth','Quality escape — nonconformance','Production line shutdown','Workforce reduction >25%'];
    const parts = {
        ddg51: [{p:'SPY-6 T/R Module',n:'5985-01-678-4321'},{p:'MK 41 VLS Rail',n:'1440-01-555-8790'},{p:'AN/SQQ-89 Sonar Array',n:'5845-01-602-3344'},{p:'LM2500 Turbine Blade',n:'2840-01-480-6710'},{p:'SEWIP Block III Antenna',n:'5985-01-690-1234'},{p:'Mk 45 Gun Barrel Liner',n:'1005-01-398-7722'},{p:'CIWS Phalanx Motor',n:'6110-01-557-2288'},{p:'Hull Steel Plate HY-80',n:'9515-01-320-4567'},{p:'SLQ-32(V)6 Processor',n:'5895-01-645-9012'},{p:'AN/SPG-62 Illuminator',n:'5840-01-234-5678'},{p:'Pratt & Whitney FT4A6',n:'2815-01-345-6789'},{p:'SSDS Mk 2 Server',n:'7021-01-567-8901'},{p:'Mk 34 GWS Console',n:'5830-01-456-7890'},{p:'Fin Stabilizer Actuator',n:'2040-01-678-0123'},{p:'CBRN Detection Unit',n:'6665-01-789-0124'}],
        cvn78: [{p:'EMALS Linear Motor',n:'2040-01-699-1234'},{p:'AAG Turbine Assembly',n:'1680-01-700-5678'},{p:'A1B Reactor Pump',n:'2815-01-710-4321'},{p:'Dual Band Radar Panel',n:'5840-01-705-8765'},{p:'Flight Deck Coating',n:'8010-01-695-2345'},{p:'Weapons Elevator Motor',n:'3950-01-698-7890'},{p:'JPALS Antenna Unit',n:'5985-01-712-3456'},{p:'Ship Self-Defense Controller',n:'5895-01-708-6543'},{p:'Catapult Steam Valve',n:'4820-01-650-9012'},{p:'Fresh Water Distiller',n:'4610-01-680-4567'},{p:'Nuclear Shielding Panel',n:'9515-01-720-1234'},{p:'Aviation Fuel Pump',n:'4320-01-690-5678'}],
        f35: [{p:'F135 Fan Blade',n:'2840-01-680-1111'},{p:'AN/APG-81 AESA Module',n:'5840-01-690-2222'},{p:'HMDS II Helmet Display',n:'1240-01-695-3333'},{p:'EOTS Sensor Window',n:'5860-01-700-4444'},{p:'Structural Fuselage Panel',n:'1560-01-705-5555'},{p:'Ejection Seat Motor',n:'1680-01-710-6666'},{p:'DAS Sensor Unit',n:'5860-01-715-7777'},{p:'Fuel Bladder Cell',n:'1560-01-720-8888'},{p:'CNI Avionics Module',n:'5895-01-725-9999'},{p:'Landing Gear Actuator',n:'1620-01-730-1010'},{p:'Stealth Coating Material',n:'8010-01-735-1111'},{p:'Wing Fold Mechanism',n:'1560-01-740-1212'}],
        ch53k: [{p:'T408-GE-400 Engine',n:'2840-01-750-1234'},{p:'Main Rotor Head',n:'1615-01-755-5678'},{p:'Fly-by-Wire Actuator',n:'1680-01-760-9012'},{p:'Cargo Hook Assembly',n:'1670-01-765-3456'},{p:'Blade Fold System',n:'1615-01-770-7890'},{p:'APU TF50',n:'2835-01-775-2345'},{p:'Glass Cockpit Display',n:'1270-01-780-6789'},{p:'Infrared Suppressor',n:'1560-01-785-0123'},{p:'Sponson Fuel Cell',n:'1560-01-790-4567'},{p:'External Cargo Mirror',n:'1240-01-795-8901'}],
        ssn774: [{p:'S9G Reactor Component',n:'2815-01-800-1234'},{p:'Torpedo Tube Breech',n:'1095-01-805-5678'},{p:'BQQ-10 Sonar Array',n:'5845-01-810-9012'},{p:'Photonics Mast Assembly',n:'5820-01-815-3456'},{p:'Propulsor Blade',n:'2040-01-820-7890'},{p:'Atmosphere Monitor',n:'6665-01-825-2345'},{p:'Periscope Hoist Motor',n:'5820-01-830-6789'},{p:'Submarine Escape Trunk',n:'4220-01-835-0123'},{p:'Ballast Tank Valve',n:'4820-01-840-4567'},{p:'Hull Array Sensor',n:'5845-01-845-8901'}],
        // Army platforms
        m1a2: [{p:'AGT-1500 Turbine Engine',n:'2815-01-150-2345'},{p:'M256 120mm Smoothbore',n:'1015-01-380-7890'},{p:'CITV Commander Sight',n:'1240-01-410-1234'},{p:'Track Shoe Assembly T-158',n:'2530-01-245-5678'},{p:'Ballistic Computer Unit',n:'5895-01-520-9012'},{p:'Turret Traverse Motor',n:'6110-01-390-3456'},{p:'Fire Control Sensor',n:'5860-01-460-7890'},{p:'NBC Protection System',n:'6665-01-280-2345'},{p:'Hydrokinetic Transmission',n:'2520-01-310-6789'},{p:'FLIR Thermal Sight (GPSE)',n:'5855-01-425-0123'},{p:'Auxiliary Power Unit',n:'2835-01-350-4567'},{p:'Hull Armor Panel',n:'9515-01-290-8901'}],
        m2a3: [{p:'Cummins VTA-903T Engine',n:'2815-01-260-1234'},{p:'M242 25mm Chain Gun',n:'1010-01-320-5678'},{p:'ISU Integrated Sight Unit',n:'1240-01-450-9012'},{p:'TOW Missile Launcher',n:'1440-01-370-3456'},{p:'HMPT-500 Transmission',n:'2520-01-280-7890'},{p:'Track Assembly T-150',n:'2530-01-230-2345'},{p:'Ramp Hydraulic Actuator',n:'1680-01-340-6789'},{p:'FBCB2 Blue Force Tracker',n:'5895-01-510-0123'},{p:'Turret Drive Assembly',n:'6110-01-380-4567'},{p:'Smoke Generator System',n:'1365-01-290-8901'}],
        stryker: [{p:'Caterpillar C7 ACERT Engine',n:'2815-01-530-1234'},{p:'Allison 3200SP Transmission',n:'2520-01-540-5678'},{p:'Central Tire Inflation System',n:'2530-01-545-9012'},{p:'RWS Remote Weapon Station',n:'1005-01-550-3456'},{p:'DVH Hull Panel',n:'9515-01-555-7890'},{p:'LRAS3 Long Range Sight',n:'5855-01-560-2345'},{p:'Vehicle Intercom System',n:'5895-01-565-6789'},{p:'NBC Overpressure System',n:'6665-01-570-0123'},{p:'Run-Flat Tire Assembly',n:'2610-01-575-4567'},{p:'Power Distribution Unit',n:'6110-01-580-8901'}],
        himars: [{p:'GMLRS Rocket Pod',n:'1320-01-590-1234'},{p:'ATACMS Launcher Rail',n:'1410-01-595-5678'},{p:'Fire Control Computer',n:'5895-01-600-9012'},{p:'Cab Armor Kit',n:'9515-01-605-3456'},{p:'Launcher Hydraulic Cylinder',n:'1680-01-610-7890'},{p:'FMTV 5-ton Chassis',n:'2320-01-615-2345'},{p:'GPS/INS Navigation Unit',n:'5826-01-620-6789'},{p:'Communications Suite',n:'5895-01-625-0123'}],
        patriot: [{p:'AN/MPQ-65 Radar Antenna',n:'5840-01-630-1234'},{p:'PAC-3 MSE Interceptor',n:'1410-01-635-5678'},{p:'Engagement Control Station',n:'5895-01-640-9012'},{p:'Generator Set MEP-12A',n:'6115-01-645-3456'},{p:'Launching Station M903',n:'1440-01-650-7890'},{p:'IFF Interrogator',n:'5840-01-655-2345'},{p:'Fiber Optic Cable Set',n:'6145-01-660-6789'},{p:'Battery Command Post',n:'5895-01-665-0123'}],
        ah64e: [{p:'T700-GE-701D Engine',n:'2840-01-670-1234'},{p:'M230E1 30mm Chain Gun',n:'1010-01-675-5678'},{p:'AN/APG-78 Longbow Radar',n:'5840-01-680-9012'},{p:'TADS/PNVS Sight System',n:'1240-01-685-3456'},{p:'Hellfire Missile Launcher',n:'1440-01-690-7890'},{p:'Main Rotor Blade',n:'1615-01-695-2345'},{p:'Tail Rotor Drivetrain',n:'1615-01-700-6789'},{p:'CMWS Missile Warning',n:'5895-01-705-0123'},{p:'Flight Control Computer',n:'5895-01-710-4567'},{p:'Stub Wing Pylon',n:'1560-01-715-8901'}],
        // Air Force platforms
        f22a: [{p:'F119-PW-100 Engine',n:'2840-01-470-1234'},{p:'AN/APG-77 AESA Radar',n:'5840-01-475-5678'},{p:'Stealth Coating (RAM)',n:'8010-01-480-9012'},{p:'Canopy Assembly',n:'1560-01-485-3456'},{p:'Thrust Vector Nozzle',n:'2840-01-490-7890'},{p:'JHMCS Helmet Sight',n:'1240-01-495-2345'},{p:'ECS Air Cycle Machine',n:'1680-01-500-6789'},{p:'Weapons Bay Door Actuator',n:'1680-01-505-0123'},{p:'ALR-94 EW Receiver',n:'5895-01-510-4567'},{p:'Main Landing Gear',n:'1620-01-515-8901'}],
        f15ex: [{p:'F110-GE-129 Engine',n:'2840-01-520-1234'},{p:'AN/APG-82(V)1 AESA Radar',n:'5840-01-525-5678'},{p:'AMBER Mission Computer',n:'5895-01-530-9012'},{p:'CFT Conformal Fuel Tank',n:'1560-01-535-3456'},{p:'JHMCS II Helmet',n:'1240-01-540-7890'},{p:'Weapons Pylon Station',n:'1560-01-545-2345'},{p:'EPAWSS EW Suite',n:'5895-01-550-6789'},{p:'Canopy Transparency',n:'1560-01-555-0123'},{p:'Nose Gear Assembly',n:'1620-01-560-4567'},{p:'Fly-by-Wire Computer',n:'5895-01-565-8901'}],
        b21: [{p:'F135 Derivative Engine',n:'2840-01-850-1234'},{p:'Stealth Structure Panel',n:'1560-01-855-5678'},{p:'Mission Computer Suite',n:'5895-01-860-9012'},{p:'Weapons Bay Rotary Launcher',n:'1440-01-865-3456'},{p:'EO/IR Sensor Ball',n:'5860-01-870-7890'},{p:'Communications System',n:'5895-01-875-2345'},{p:'Landing Gear Strut',n:'1620-01-880-6789'},{p:'Inlet Duct Assembly',n:'1560-01-885-0123'}],
        b52h: [{p:'TF33-P-3/103 Turbofan',n:'2840-01-140-1234'},{p:'AN/ASQ-176 OAS Computer',n:'5895-01-145-5678'},{p:'CSRL Launcher Rack',n:'1440-01-150-9012'},{p:'Fuel Cell Bladder',n:'1560-01-155-3456'},{p:'AESA Radar Upgrade',n:'5840-01-160-7890'},{p:'Structural Wing Box',n:'1560-01-165-2345'},{p:'Alternator Assembly',n:'6110-01-170-6789'},{p:'Bomb Bay Door Actuator',n:'1680-01-175-0123'},{p:'Tail Gunner Radar (Deleted)',n:'5840-01-180-4567'},{p:'Crew Ejection Seat',n:'1680-01-185-8901'}],
        kc46a: [{p:'PW4062 Turbofan Engine',n:'2840-01-750-1234'},{p:'Centerline Drogue Unit',n:'1560-01-755-5678'},{p:'Remote Vision System',n:'5860-01-760-9012'},{p:'Boom Telescope Assembly',n:'1560-01-765-3456'},{p:'Wing Aerial Refueling Pod',n:'1560-01-770-7890'},{p:'Cargo Floor System',n:'1560-01-775-2345'},{p:'Fuel Transfer Pump',n:'4320-01-780-6789'},{p:'Flight Deck Display',n:'1270-01-785-0123'}],
        // Marine Corps / Other
        v22: [{p:'T406-AD-400 Engine',n:'2840-01-420-1234'},{p:'Proprotor Assembly',n:'1615-01-425-5678'},{p:'Swashplate Mechanism',n:'1615-01-430-9012'},{p:'Tilt Mechanism Gearbox',n:'1615-01-435-3456'},{p:'Flight Control Computer',n:'5895-01-440-7890'},{p:'Cargo Hook Assembly',n:'1670-01-445-2345'},{p:'IR Suppressor',n:'1560-01-450-6789'},{p:'Nacelle Conversion System',n:'1615-01-455-0123'},{p:'Glass Cockpit Display',n:'1270-01-460-4567'},{p:'External Fuel Tank',n:'1560-01-465-8901'}],
        acv: [{p:'Cummins C9.3 Engine',n:'2815-01-900-1234'},{p:'Marine Propulsion Water Jet',n:'2040-01-905-5678'},{p:'Hull Protection System',n:'9515-01-910-9012'},{p:'RWS Weapon Station',n:'1005-01-915-3456'},{p:'CBRN Protection',n:'6665-01-920-7890'},{p:'Troop Compartment Seats',n:'2540-01-925-2345'},{p:'Vision Block Assembly',n:'1240-01-930-6789'},{p:'Communication System',n:'5895-01-935-0123'}],
        // Coast Guard / SOCOM / Space
        wmsl750: [{p:'MT30 Gas Turbine',n:'2840-01-940-1234'},{p:'Mk 110 57mm Gun',n:'1015-01-945-5678'},{p:'TRS-4D Radar Array',n:'5840-01-950-9012'},{p:'MH-65E Helo Support',n:'1615-01-955-3456'},{p:'C4ISR Suite',n:'5895-01-960-7890'},{p:'Stern Launch Ramp',n:'1905-01-965-2345'},{p:'Hull Steel Plating',n:'9515-01-970-6789'},{p:'Diesel Generator Set',n:'6115-01-975-0123'}],
        gpsiii: [{p:'Navigation Payload',n:'5826-01-980-1234'},{p:'Solar Array Panel',n:'6130-01-985-5678'},{p:'Atomic Clock Rubidium',n:'6645-01-990-9012'},{p:'Hall-Effect Thruster',n:'2840-01-995-3456'},{p:'Star Tracker Assembly',n:'6650-01-998-7890'},{p:'Signal Security Module',n:'5895-01-997-2345'}],
        thaad: [{p:'AN/TPY-2 X-Band Radar',n:'5840-01-870-1234'},{p:'THAAD Interceptor',n:'1410-01-875-5678'},{p:'TFCC Fire Control',n:'5895-01-880-9012'},{p:'Launcher Assembly M1075',n:'1440-01-885-3456'},{p:'Generator MEP-PU-810',n:'6115-01-890-7890'},{p:'Battery Operations Center',n:'5895-01-895-2345'}]
    };
    const items = (parts[progKey]||parts.ddg51).map((p,i)=>{
        const score = Math.round(rng(i)*100);
        const level = score>=85?'critical':score>=70?'high':score>=45?'medium':'low';
        const factorCount = level==='critical'?3:level==='high'?2:1;
        let factors = [];
        for(let f=0;f<factorCount;f++){
            let factor = riskFactors[Math.floor(rng(i*10+f)*riskFactors.length)];
            if(factor.includes('#2024-')) factor += Math.floor(1000+rng(i+f)*9000);
            if(factor.includes('spike +')) factor += Math.floor(20+rng(i+f)*200) + '%';
            factors.push(factor);
        }
        const etaDays = level==='critical'?Math.floor(30+rng(i)*60):level==='high'?Math.floor(60+rng(i)*120):level==='medium'?Math.floor(90+rng(i)*180):0;
        return {part:p.p,nsn:p.n,supplier:suppliers[Math.floor(rng(i*7)*suppliers.length)],score,level,factors,etaImpact:etaDays?'+'+etaDays+' days':'None'};
    });
    items.sort((a,b)=>b.score-a.score);
    return items;
}

function loadRiskData() {
    const progKey = document.getElementById('riskProgram')?.value || 'ddg51';
    const threshold = document.getElementById('riskThreshold')?.value || 'all';
    let items = generateRiskItems(progKey);
    _riskCache = {progKey, items};
    if(threshold==='critical') items = items.filter(i=>i.level==='critical');
    else if(threshold==='high') items = items.filter(i=>i.level==='critical'||i.level==='high');
    else if(threshold==='medium') items = items.filter(i=>i.level!=='low');

    const crit = items.filter(i=>i.level==='critical').length;
    const high = items.filter(i=>i.level==='high').length;
    const med  = items.filter(i=>i.level==='medium').length;
    const low  = items.filter(i=>i.level==='low').length;
    document.getElementById('riskCritical').textContent = crit;
    document.getElementById('riskHigh').textContent = high;
    document.getElementById('riskMedium').textContent = med;
    document.getElementById('riskLow').textContent = low;

    const levelColors = {critical:'#ff3b30',high:'#ff9500',medium:'#ffcc00',low:'#34c759'};
    const levelLabels = {critical:'CRITICAL',high:'HIGH',medium:'MEDIUM',low:'LOW'};
    let html = '';
    items.forEach(it => {
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">';
        html += '<td style="padding:10px 8px;"><div style="color:#fff;font-weight:600;font-size:0.85rem;">'+it.part+'</div><div style="color:var(--text-muted);font-family:monospace;font-size:0.72rem;">'+it.nsn+'</div></td>';
        html += '<td style="padding:10px 8px;color:var(--steel);font-size:0.82rem;">'+it.supplier+'</td>';
        html += '<td style="padding:10px 8px;text-align:center;"><div style="display:inline-block;padding:4px 12px;border-radius:20px;font-weight:700;font-size:0.82rem;background:'+levelColors[it.level]+'22;color:'+levelColors[it.level]+';border:1px solid '+levelColors[it.level]+'44;">'+it.score+'</div></td>';
        html += '<td style="padding:10px 8px;font-size:0.78rem;color:var(--steel);">'+it.factors.map(f=>'<div style="margin-bottom:2px;">• '+f+'</div>').join('')+'</td>';
        html += '<td style="padding:10px 8px;text-align:center;font-weight:600;color:'+(it.etaImpact==='None'?'var(--text-muted)':'#ff9500')+';font-size:0.82rem;">'+it.etaImpact+'</td>';
        html += '</tr>';
    });
    document.getElementById('riskTableBody').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">No risks found at selected threshold.</td></tr>';
    showWorkspaceNotification('Risk analysis loaded — ' + crit + ' critical, ' + high + ' high risk items');
}

function exportRisk() {
    const data = _riskCache.items || generateRiskItems('ddg51');
    let csv = 'Part,NSN,Supplier,Risk Score,Risk Level,Risk Factors,ETA Impact\n';
    data.forEach(d => { csv += '"'+d.part+'",'+d.nsn+',"'+d.supplier+'",'+d.score+','+d.level.toUpperCase()+',"'+d.factors.join('; ')+'",'+d.etaImpact+'\n'; });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Supply_Chain_Risk_'+(_riskCache.progKey||'DDG51').toUpperCase()+'.csv'; a.click();
    showWorkspaceNotification('Risk report exported — ' + data.length + ' items');
}

async function anchorRisk() {
    const prog = _riskCache.progKey || 'ddg51';
    const items = _riskCache.items || generateRiskItems(prog);
    const crit = items.filter(i=>i.level==='critical').length;
    const high = items.filter(i=>i.level==='high').length;
    const content = 'S4 Ledger Supply Chain Risk Report | Program: ' + prog.toUpperCase() + ' | Total Parts: ' + items.length + ' | Critical: ' + crit + ' | High: ' + high + ' | Generated: ' + new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Supply Chain Risk Report', 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'risk_report', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'risk_report', label:'Supply Chain Risk Report — '+prog.toUpperCase(), branch:'JOINT', icon:'⚠️', content:content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'AI Supply Chain Risk Engine', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('risk_report'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'risk_report', record_label:'Supply Chain Risk Report — '+prog.toUpperCase(), branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    setTimeout(()=>{ document.getElementById('animStatus').textContent = '✅ Risk report anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ═══════════════════════════════════════════════════════════════
// ═══ AUTOMATED AUDIT REPORT GENERATOR ═══
// ═══════════════════════════════════════════════════════════════
let _lastReport = null;

function loadReportPreview() {
    const rType = document.getElementById('reportType')?.value || 'full_audit';
    const period = parseInt(document.getElementById('reportPeriod')?.value) || 90;
    const records = JSON.parse(localStorage.getItem('s4_records') || '[]');
    const vaultRecords = s4Vault || [];
    const totalRecords = Math.max(records.length, vaultRecords.length, stats.anchored || 0);
    document.getElementById('reportRecordCount').textContent = totalRecords + ' records available';
    document.getElementById('reportContent').innerHTML = '<div style="color:var(--text-muted);font-style:italic;">Click "Generate Report" to compile your audit package.</div>';
}

function generateReport() {
    const rType = document.getElementById('reportType')?.value || 'full_audit';
    const period = parseInt(document.getElementById('reportPeriod')?.value) || 90;
    const format = document.getElementById('reportFormat')?.value || 'pdf';
    const records = JSON.parse(localStorage.getItem('s4_records') || '[]');
    const vaultRecords = s4Vault || [];
    const totalRecords = Math.max(records.length, vaultRecords.length, stats.anchored || 0, 12);

    const reportTypes = {
        full_audit: {title:'Full Audit Package',icon:'📋',sections:['Executive Summary','Anchoring History','Chain of Custody','Compliance Scorecard','Record Verification','Hash Integrity Report']},
        supply_chain: {title:'Supply Chain Verification',icon:'📦',sections:['Supply Chain Overview','Receipt Verification','Custody Transfers','Lot Traceability','Counterfeit Prevention','Supplier Compliance']},
        maintenance: {title:'Maintenance Records Audit',icon:'🔧',sections:['Maintenance Summary','Work Order Verification','Parts Usage','Readiness Impact','3-M Compliance','Predictive Analysis']},
        compliance: {title:'Compliance Summary Report',icon:'✅',sections:['Overall Compliance Score','NIST 800-171 Mapping','CMMC Level Readiness','DFARS Clause Compliance','ITAR/EAR Verification','Gap Analysis']},
        custody: {title:'Chain of Custody Report',icon:'🔗',sections:['Custody Timeline','Transfer Verification','Location History','Handler Authentication','Tamper Detection','Blockchain Proof']},
        contract: {title:'Contract Deliverables Report',icon:'📑',sections:['CDRL Status Summary','Deliverable Timeline','Modification History','Quality Metrics','Schedule Compliance','Cost Performance']}
    };
    const rt = reportTypes[rType] || reportTypes.full_audit;
    const now = new Date();
    const startDate = new Date(now.getTime() - period * 86400000);

    // Build preview
    let html = '<div style="border:1px solid rgba(201,168,76,0.2);border-radius:8px;overflow:hidden;">';
    html += '<div style="background:rgba(201,168,76,0.08);padding:16px;border-bottom:1px solid rgba(201,168,76,0.2);">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
    html += '<div><span style="font-size:1.3rem;margin-right:8px;">'+rt.icon+'</span><strong style="color:#fff;font-size:1.05rem;">'+rt.title+'</strong></div>';
    html += '<span style="background:#c9a84c22;color:#c9a84c;padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:600;">GENERATED</span></div>';
    html += '<div style="color:var(--text-muted);font-size:0.78rem;margin-top:6px;">Period: '+startDate.toLocaleDateString()+' — '+now.toLocaleDateString()+' | Records: '+totalRecords+' | Format: '+format.toUpperCase()+'</div></div>';

    html += '<div style="padding:16px;">';
    rt.sections.forEach((section,i) => {
        const sectionRecords = Math.max(Math.floor(totalRecords / rt.sections.length) + Math.floor(Math.random()*5), 2);
        const complianceScore = (88 + Math.random()*12).toFixed(1);
        html += '<div style="padding:10px 12px;margin-bottom:6px;background:rgba(255,255,255,0.02);border-radius:6px;border-left:3px solid '+(i%2===0?'#c9a84c':'#00aaff')+';">';
        html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
        html += '<strong style="color:#fff;font-size:0.88rem;">'+(i+1)+'. '+section+'</strong>';
        html += '<span style="color:var(--steel);font-size:0.78rem;">'+sectionRecords+' items | Score: '+complianceScore+'%</span></div></div>';
    });

    // Summary footer
    const totalScore = (91 + Math.random()*8).toFixed(1);
    html += '<div style="margin-top:12px;padding:12px;background:rgba(20,241,149,0.06);border:1px solid rgba(20,241,149,0.2);border-radius:8px;display:flex;justify-content:space-between;align-items:center;">';
    html += '<div><strong style="color:#14f195;">Overall Compliance Score: '+totalScore+'%</strong><br><span style="color:var(--steel);font-size:0.78rem;">All records verified against XRPL blockchain anchors</span></div>';
    html += '<div style="font-size:1.8rem;color:#14f195;font-weight:800;">'+totalScore+'%</div></div>';
    html += '</div></div>';

    document.getElementById('reportContent').innerHTML = html;
    _lastReport = {type:rType, title:rt.title, period, format, records:totalRecords, score:totalScore, sections:rt.sections, generated:now.toISOString()};
    showWorkspaceNotification('Audit report generated — ' + rt.sections.length + ' sections, ' + totalRecords + ' records');
}

function downloadReport() {
    if(!_lastReport) { generateReport(); }
    const r = _lastReport;
    if(r.format === 'json') {
        const blob = new Blob([JSON.stringify(r, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'S4_Audit_Report_'+r.type+'.json'; a.click();
    } else {
        let csv = 'Section,Items,Compliance Score\n';
        r.sections.forEach((s,i)=>{ csv += '"'+s+'",' + Math.max(Math.floor(r.records/r.sections.length),2) + ',' + (88+Math.random()*12).toFixed(1) + '%\n'; });
        csv += '\nOverall Score,' + r.records + ',' + r.score + '%\n';
        csv += 'Generated,' + r.generated + ',\n';
        csv += 'Report Type,"' + r.title + '",\n';
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'S4_Audit_Report_'+r.type+'.csv'; a.click();
    }
    showWorkspaceNotification('Report downloaded — ' + (r.format||'csv').toUpperCase() + ' format');
}

async function anchorReport() {
    if(!_lastReport) generateReport();
    const r = _lastReport || {type:'full_audit',title:'Full Audit Package',records:0,score:'95.0'};
    const content = 'S4 Ledger Audit Report | Type: ' + r.title + ' | Records: ' + r.records + ' | Compliance Score: ' + r.score + '% | Generated: ' + new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Audit Report Hash', 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'audit_report', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'audit_report', label:r.title+' — Score: '+r.score+'%', branch:'JOINT', icon:'📋', content:content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Audit Report Generator', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('audit_report'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'audit_report', record_label:r.title, branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    setTimeout(()=>{ document.getElementById('animStatus').textContent = '✅ Audit report hash anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ═══════════════════════════════════════════════════════════════
// ═══ CONTRACT LIFECYCLE MANAGEMENT ═══
// ═══════════════════════════════════════════════════════════════
let _contractCache = {};

function generateContractItems(contractId) {
    const seed = contractId.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const rng = (i)=>((seed*137+i*991)%10000)/10000;
    const now = new Date();
    const cdrlTypes = [
        {id:'A001',desc:'Integrated Logistics Support Plan (ILSP)',di:'DI-ALSS-81529'},
        {id:'A003',desc:'Level of Repair Analysis (LORA)',di:'DI-ALSS-81517'},
        {id:'A005',desc:'Reliability Analysis Report',di:'DI-RELI-80255'},
        {id:'A007',desc:'Provisioning Parts List (PPL)',di:'DI-ALSS-81530'},
        {id:'A009',desc:'Maintenance Plan',di:'DI-ALSS-81531'},
        {id:'A011',desc:'Technical Data Package (TDP)',di:'DI-TMSS-80527'},
        {id:'A013',desc:'Training Materials',di:'DI-ALSS-81541'},
        {id:'A015',desc:'Quality Assurance Plan',di:'DI-QCIC-80553'},
        {id:'A017',desc:'Configuration Management Plan',di:'DI-CMAN-80858A'},
        {id:'A019',desc:'Test & Evaluation Master Plan',di:'DI-NDTI-80566A'}
    ];
    const modTypes = [
        {id:'MOD-P00001',desc:'Contract Value Adjustment +$2.4M',type:'mod'},
        {id:'MOD-P00002',desc:'Period of Performance Extension — 6 months',type:'mod'},
        {id:'MOD-P00003',desc:'SOW Change — Add CBM+ Requirement',type:'mod'},
        {id:'MOD-A00001',desc:'Administrative — CAGE Code Update',type:'mod'}
    ];
    const deliverables = [
        {id:'SOW-3.1.1',desc:'Monthly Status Report (MSR)',type:'deliverable'},
        {id:'SOW-3.2.1',desc:'Program Management Review (PMR)',type:'deliverable'},
        {id:'SOW-3.3.1',desc:'Failure Review Board (FRB) Package',type:'deliverable'},
        {id:'SOW-4.1.1',desc:'Engineering Change Proposal (ECP)',type:'deliverable'},
        {id:'SOW-4.2.1',desc:'Interface Control Document (ICD)',type:'deliverable'}
    ];
    let items = [];
    cdrlTypes.forEach((c,i) => {
        const dueOffset = Math.floor(rng(i)*180) - 60;
        const due = new Date(now.getTime() + dueOffset*86400000);
        const r = rng(i*3);
        let status = dueOffset < -30 ? (r>0.3?'delivered':'overdue') : dueOffset < 0 ? (r>0.5?'delivered':'overdue') : dueOffset < 30 ? (r>0.7?'on_track':'at_risk') : 'on_track';
        items.push({id:c.id, desc:c.desc, di:c.di, type:'cdrl', due:due.toLocaleDateString(), status, anchored:r>0.4});
    });
    modTypes.forEach((m,i) => {
        const r = rng(i*5+50);
        items.push({id:m.id, desc:m.desc, di:'—', type:'mod', due:new Date(now.getTime()-(30+i*45)*86400000).toLocaleDateString(), status:r>0.3?'delivered':'on_track', anchored:r>0.5});
    });
    deliverables.forEach((d,i) => {
        const dueOffset = Math.floor(rng(i*7+80)*90) - 30;
        const due = new Date(now.getTime() + dueOffset*86400000);
        const r = rng(i*9+100);
        let status = dueOffset < -14 ? (r>0.5?'delivered':'overdue') : dueOffset < 7 ? (r>0.6?'on_track':'at_risk') : 'on_track';
        items.push({id:d.id, desc:d.desc, di:'—', type:'deliverable', due:due.toLocaleDateString(), status, anchored:r>0.45});
    });
    return items;
}

function loadContractData() {
    const selEl = document.getElementById('contractSelect');
    const customEl = document.getElementById('contractCustomId');
    if (selEl && customEl) {
        customEl.style.display = selEl.value === 'custom' ? 'block' : 'none';
    }
    let contractId = selEl?.value || 'N00024-25-C-5501';
    if (contractId === 'custom' && customEl?.value) contractId = customEl.value;
    const typeFilter = document.getElementById('contractTypeFilter')?.value || 'all';
    const statusFilter = document.getElementById('contractStatusFilter')?.value || 'all';
    let items = generateContractItems(contractId);
    _contractCache = {contractId, items};
    if(typeFilter!=='all') items = items.filter(i=>i.type===typeFilter);
    if(statusFilter!=='all') items = items.filter(i=>i.status===statusFilter);

    const onTrack = items.filter(i=>i.status==='on_track').length;
    const atRisk = items.filter(i=>i.status==='at_risk').length;
    const overdue = items.filter(i=>i.status==='overdue').length;
    document.getElementById('contractTotal').textContent = items.length;
    document.getElementById('contractOnTrack').textContent = onTrack + items.filter(i=>i.status==='delivered').length;
    document.getElementById('contractAtRisk').textContent = atRisk;
    document.getElementById('contractOverdue').textContent = overdue;

    const statusColors = {on_track:'#34c759',at_risk:'#ff9500',overdue:'#ff3b30',delivered:'#00aaff'};
    const statusLabels = {on_track:'On Track',at_risk:'At Risk',overdue:'Overdue',delivered:'Delivered'};
    const typeLabels = {cdrl:'CDRL',mod:'MOD',deliverable:'SOW'};
    const typeBg = {cdrl:'#00aaff',mod:'#c9a84c',deliverable:'#a855f7'};
    let html = '';
    items.forEach(it => {
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">';
        html += '<td style="padding:10px 8px;"><div style="color:#fff;font-weight:600;font-size:0.82rem;">'+it.id+'</div><div style="color:var(--text-muted);font-size:0.72rem;">'+it.desc+'</div>'+(it.di!=='—'?'<div style="color:var(--steel);font-size:0.68rem;font-family:monospace;">'+it.di+'</div>':'')+'</td>';
        html += '<td style="padding:10px 8px;"><span style="background:'+typeBg[it.type]+'22;color:'+typeBg[it.type]+';padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;">'+typeLabels[it.type]+'</span></td>';
        html += '<td style="padding:10px 8px;color:var(--steel);font-size:0.82rem;">'+it.due+'</td>';
        html += '<td style="padding:10px 8px;text-align:center;"><span style="background:'+statusColors[it.status]+'22;color:'+statusColors[it.status]+';padding:3px 10px;border-radius:12px;font-size:0.78rem;font-weight:600;">'+statusLabels[it.status]+'</span></td>';
        html += '<td style="padding:10px 8px;text-align:center;font-size:0.9rem;">'+(it.anchored?'<i class="fas fa-check-circle" style="color:#14f195;"></i>':'<i class="fas fa-minus-circle" style="color:var(--text-muted);"></i>')+'</td>';
        html += '</tr>';
    });
    document.getElementById('contractTableBody').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">No items match current filters.</td></tr>';
    showWorkspaceNotification('Contract loaded — ' + items.length + ' items (' + overdue + ' overdue)');
}

function exportContracts() {
    const data = _contractCache.items || generateContractItems('N00024-25-C-5501');
    let csv = 'Item ID,Description,DI Number,Type,Due Date,Status,Anchored\n';
    data.forEach(d => { csv += d.id+',"'+d.desc+'",'+d.di+','+d.type+','+d.due+','+d.status+','+(d.anchored?'Yes':'No')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Contract_'+(_contractCache.contractId||'N00024').replace(/[^A-Za-z0-9]/g,'_')+'.csv'; a.click();
    showWorkspaceNotification('Contract data exported — ' + data.length + ' items');
}

async function anchorContracts() {
    const cid = _contractCache.contractId || 'N00024-25-C-5501';
    const items = _contractCache.items || generateContractItems(cid);
    const overdue = items.filter(i=>i.status==='overdue').length;
    const delivered = items.filter(i=>i.status==='delivered').length;
    const content = 'S4 Ledger Contract Report | Contract: ' + cid + ' | Total Items: ' + items.length + ' | Delivered: ' + delivered + ' | Overdue: ' + overdue + ' | Generated: ' + new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Contract Status Report', 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'contract_report', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'contract_report', label:'Contract Report — '+cid, branch:'JOINT', icon:'📑', content:content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Contract Lifecycle Management', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('contract_report'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'contract_report', record_label:'Contract Report — '+cid, branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    setTimeout(()=>{ document.getElementById('animStatus').textContent = '✅ Contract data anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ═══════════════════════════════════════════════════════════════
// ═══ DIGITAL THREAD / CONFIGURATION BRIDGE ═══
// ═══════════════════════════════════════════════════════════════
let _threadCache = {};

function generateThreadItems(platform, view) {
    const seed = (platform+view).split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const rng = (i)=>((seed*149+i*1013)%10000)/10000;
    const now = new Date();

    if(view === 'changes') {
        const ecps = [
            {desc:'Replace hydraulic actuator with electro-mechanical',cat:'Class I'},
            {desc:'Update corrosion protection coating specification',cat:'Class II'},
            {desc:'Redesign cooling duct for improved airflow',cat:'Class I'},
            {desc:'Substitute obsolete connector (DMSMS)',cat:'Class II'},
            {desc:'Add structural reinforcement at frame station 412',cat:'Class I'},
            {desc:'Update software load — Block 4.2 firmware',cat:'Class II'},
            {desc:'Replace CRT displays with LCD — cockpit modernization',cat:'Class I'},
            {desc:'Update wiring harness for EMI compliance',cat:'Class II'},
            {desc:'Modify fuel system plumbing for JP-8 compatibility',cat:'Class I'},
            {desc:'Integrate new IFF Mode 5 transponder',cat:'Class I'},
            {desc:'Update technical manual — maintenance procedures',cat:'Class II'},
            {desc:'Redesign mounting bracket — fatigue life extension',cat:'Class I'}
        ];
        return ecps.map((e,i) => {
            const r = rng(i);
            const status = r<0.2?'pending':r<0.5?'approved':r<0.85?'implemented':'rejected';
            return {id:'ECP-'+platform.toUpperCase()+'-'+(2024000+i+1), desc:e.desc, type:e.cat, status, anchored:r>0.35, date:new Date(now.getTime()-(i*15+Math.floor(rng(i*3)*60))*86400000).toLocaleDateString()};
        });
    } else if(view === 'bom') {
        const boms = [
            {desc:'Top-Level Assembly BOM',level:'L0'},{desc:'Propulsion System BOM',level:'L1'},{desc:'Combat System BOM',level:'L1'},
            {desc:'Hull Structure BOM',level:'L1'},{desc:'Electrical Distribution BOM',level:'L1'},{desc:'Navigation System BOM',level:'L2'},
            {desc:'Weapons System BOM',level:'L1'},{desc:'Auxiliary Systems BOM',level:'L1'},{desc:'Communications Suite BOM',level:'L2'},
            {desc:'Damage Control System BOM',level:'L2'}
        ];
        return boms.map((b,i) => {
            const rev = 'Rev ' + String.fromCharCode(65 + Math.floor(rng(i)*8));
            const r = rng(i*7);
            return {id:'BOM-'+platform.toUpperCase()+'-'+(i+1).toString().padStart(3,'0'), desc:b.desc+' ('+b.level+')', type:rev, status:r<0.15?'pending':r<0.6?'approved':'implemented', anchored:r>0.3, date:new Date(now.getTime()-(i*20+Math.floor(rng(i)*90))*86400000).toLocaleDateString()};
        });
    } else if(view === 'baseline') {
        const baselines = [
            {desc:'Functional Baseline (FBL)',phase:'SDD'},{desc:'Allocated Baseline (ABL)',phase:'SDD'},
            {desc:'Product Baseline — Block 1',phase:'Production'},{desc:'Product Baseline — Block 2',phase:'Production'},
            {desc:'As-Built Configuration — Hull 1',phase:'Sustainment'},{desc:'As-Built Configuration — Hull 2',phase:'Sustainment'},
            {desc:'Developmental Configuration',phase:'EMD'},{desc:'Operational Baseline',phase:'IOT&E'}
        ];
        return baselines.map((b,i) => {
            const r = rng(i*11);
            return {id:'CBL-'+platform.toUpperCase()+'-'+(i+1).toString().padStart(3,'0'), desc:b.desc, type:b.phase, status:r<0.1?'pending':'approved', anchored:r>0.25, date:new Date(now.getTime()-(i*45+Math.floor(rng(i)*180))*86400000).toLocaleDateString()};
        });
    } else { // tdp
        const tdps = [
            {desc:'System Specification (SSS)',level:'A'},{desc:'Subsystem Specification',level:'B'},
            {desc:'Drawing Package — Structural',level:'C'},{desc:'Drawing Package — Electrical',level:'C'},
            {desc:'Interface Control Drawing (ICD)',level:'B'},{desc:'Test Procedure Document',level:'C'},
            {desc:'Maintenance Technical Manual',level:'D'},{desc:'Illustrated Parts Breakdown (IPB)',level:'D'},
            {desc:'Wiring Data List',level:'C'},{desc:'Computer Software Documentation',level:'B'}
        ];
        return tdps.map((t,i) => {
            const ver = 'v' + (1 + Math.floor(rng(i)*5)) + '.' + Math.floor(rng(i*3)*10);
            const r = rng(i*13);
            return {id:'TDP-'+platform.toUpperCase()+'-'+(i+1).toString().padStart(3,'0'), desc:t.desc+' (Level '+t.level+')', type:ver, status:r<0.2?'pending':r<0.7?'approved':'implemented', anchored:r>0.3, date:new Date(now.getTime()-(i*25+Math.floor(rng(i)*120))*86400000).toLocaleDateString()};
        });
    }
}

function loadThreadData() {
    const platform = document.getElementById('threadPlatform')?.value || 'ddg51';
    const view = document.getElementById('threadView')?.value || 'changes';
    const statusFilter = document.getElementById('threadStatus')?.value || 'all';
    let items = generateThreadItems(platform, view);
    _threadCache = {platform, view, items};
    if(statusFilter!=='all') items = items.filter(i=>i.status===statusFilter);

    document.getElementById('threadTotal').textContent = items.length;
    document.getElementById('threadPending').textContent = items.filter(i=>i.status==='pending').length;
    document.getElementById('threadApproved').textContent = items.filter(i=>i.status==='approved'||i.status==='implemented').length;
    document.getElementById('threadAnchored').textContent = items.filter(i=>i.anchored).length;

    const statusColors = {pending:'#ff9500',approved:'#34c759',implemented:'#00aaff',rejected:'#ff3b30'};
    const statusLabels = {pending:'Pending',approved:'Approved',implemented:'Implemented',rejected:'Rejected'};
    let html = '';
    items.forEach(it => {
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.04);">';
        html += '<td style="padding:10px 8px;color:#a855f7;font-weight:600;font-family:monospace;font-size:0.82rem;">'+it.id+'</td>';
        html += '<td style="padding:10px 8px;color:#fff;font-size:0.82rem;">'+it.desc+'</td>';
        html += '<td style="padding:10px 8px;color:var(--steel);font-size:0.8rem;">'+it.type+'</td>';
        html += '<td style="padding:10px 8px;text-align:center;"><span style="background:'+statusColors[it.status]+'22;color:'+statusColors[it.status]+';padding:3px 10px;border-radius:12px;font-size:0.78rem;font-weight:600;">'+statusLabels[it.status]+'</span></td>';
        html += '<td style="padding:10px 8px;text-align:center;font-size:0.9rem;">'+(it.anchored?'<i class="fas fa-check-circle" style="color:#14f195;"></i>':'<i class="fas fa-minus-circle" style="color:var(--text-muted);"></i>')+'</td>';
        html += '</tr>';
    });
    document.getElementById('threadTableBody').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">No items match current filters.</td></tr>';
    const viewLabels = {changes:'engineering changes',bom:'BOM revisions',baseline:'configuration baselines',tdp:'TDP versions'};
    showWorkspaceNotification('Loaded ' + items.length + ' ' + (viewLabels[view]||'items') + ' for ' + platform.toUpperCase());
}

function exportThread() {
    const data = _threadCache.items || generateThreadItems('ddg51','changes');
    let csv = 'Change ID,Description,Type/Category,Status,Anchored,Date\n';
    data.forEach(d => { csv += d.id+',"'+d.desc+'",'+d.type+','+d.status+','+(d.anchored?'Yes':'No')+','+d.date+'\n'; });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Digital_Thread_'+(_threadCache.platform||'DDG51').toUpperCase()+'_'+(_threadCache.view||'changes')+'.csv'; a.click();
    showWorkspaceNotification('Digital Thread data exported — ' + data.length + ' items');
}

async function anchorThread() {
    const platform = _threadCache.platform || 'ddg51';
    const view = _threadCache.view || 'changes';
    const items = _threadCache.items || generateThreadItems(platform, view);
    const pending = items.filter(i=>i.status==='pending').length;
    const approved = items.filter(i=>i.status==='approved'||i.status==='implemented').length;
    const content = 'S4 Ledger Digital Thread Report | Platform: '+platform.toUpperCase()+' | View: '+view+' | Total: '+items.length+' | Pending: '+pending+' | Approved: '+approved+' | Generated: '+new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Digital Thread Report', 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'digital_thread', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'digital_thread', label:'Digital Thread — '+platform.toUpperCase()+' ('+view+')', branch:'JOINT', icon:'🔗', content:content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Digital Thread Bridge', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('digital_thread'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'digital_thread', record_label:'Digital Thread — '+platform.toUpperCase(), branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    setTimeout(()=>{ document.getElementById('animStatus').textContent = '✅ Configuration data anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ═══════════════════════════════════════════════════════════════
// ═══ PREDICTIVE MAINTENANCE AI ═══
// ═══════════════════════════════════════════════════════════════
let _pdmCache = {};

function generatePredictions(platform, windowDays, confidenceThreshold) {
    const seed = platform.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const rng = (i)=>((seed*157+i*1009)%10000)/10000;
    const now = new Date();
    const systems = {
        ddg51: [
            {sys:'LM2500 Gas Turbine — #1 SSDG',comp:'HP Turbine Blade',mode:'Creep fatigue / thermal cycling',costRange:[800,2200]},
            {sys:'LM2500 Gas Turbine — #2 SSDG',comp:'Fuel Control Valve',mode:'Sticking / response degradation',costRange:[120,450]},
            {sys:'SPY-6 Radar Array',comp:'T/R Module Bank 3',mode:'Power output degradation >15%',costRange:[350,900]},
            {sys:'MK 41 VLS',comp:'Gas Management System',mode:'Seal deterioration / pressure loss',costRange:[200,600]},
            {sys:'AN/SQQ-89 Sonar',comp:'Hydrophone Array',mode:'Sensitivity degradation / crosstalk',costRange:[500,1500]},
            {sys:'CIWS Phalanx',comp:'Servo Motor Assembly',mode:'Tracking accuracy drift >2 mrad',costRange:[180,550]},
            {sys:'Mk 45 Gun System',comp:'Barrel Liner',mode:'Bore erosion — approaching round limit',costRange:[250,700]},
            {sys:'HVAC Chiller Plant',comp:'Compressor #2',mode:'Refrigerant leak / efficiency loss',costRange:[90,320]},
            {sys:'Steering Gear',comp:'Hydraulic Ram Seal',mode:'Internal bypass / slow response',costRange:[150,500]},
            {sys:'Fire Main System',comp:'AFFF Pump Motor',mode:'Bearing wear / vibration increase',costRange:[75,280]},
            {sys:'Electrical Distribution',comp:'450V Switchboard',mode:'Insulation resistance degradation',costRange:[200,800]},
            {sys:'Navigation Radar',comp:'Magnetron',mode:'Power output decline — end of life',costRange:[60,200]}
        ],
        cvn: [
            {sys:'EMALS Catapult',comp:'Linear Induction Motor',mode:'Winding insulation breakdown',costRange:[1500,4500]},
            {sys:'AAG Arresting Gear',comp:'Energy Absorber Turbine',mode:'Rotor fatigue cracking',costRange:[800,2800]},
            {sys:'A1B Reactor Plant',comp:'Primary Coolant Pump',mode:'Bearing wear / vibration trend',costRange:[2000,6000]},
            {sys:'Dual Band Radar',comp:'SPY-6 Array Panel',mode:'T/R module degradation cluster',costRange:[600,1800]},
            {sys:'Aircraft Elevator #1',comp:'Hydraulic Motor',mode:'Internal leak — flow reduction',costRange:[400,1200]},
            {sys:'JP-5 Fuel System',comp:'Transfer Pump',mode:'Impeller erosion / cavitation',costRange:[150,500]},
            {sys:'Catapult Steam Plant',comp:'Accumulator Valve',mode:'Cycle fatigue — approaching limit',costRange:[300,900]},
            {sys:'Flight Deck Lighting',comp:'MOVLAS System',mode:'LED driver failure pattern',costRange:[40,150]},
            {sys:'Freshwater Distillation',comp:'Evaporator Tubes',mode:'Scale buildup / efficiency loss',costRange:[100,350]},
            {sys:'Anchor Windlass',comp:'Brake Assembly',mode:'Lining wear — measurement trending',costRange:[80,250]}
        ],
        f18: [
            {sys:'F414-GE-400 Engine',comp:'High Pressure Turbine',mode:'Blade tip clearance trending',costRange:[1200,3500]},
            {sys:'AN/APG-79 AESA Radar',comp:'Power Supply Module',mode:'Voltage regulation drift',costRange:[300,900]},
            {sys:'Flight Control System',comp:'Aileron Actuator',mode:'Hydraulic bypass increasing',costRange:[200,600]},
            {sys:'Environmental Control',comp:'Air Cycle Machine',mode:'Bearing vibration signature',costRange:[150,450]},
            {sys:'Landing Gear',comp:'Main Gear Strut',mode:'Oleo seal — service life approach',costRange:[350,1000]},
            {sys:'Fuel System',comp:'Wing Tank Bladder Cell',mode:'Permeation rate increase',costRange:[180,550]},
            {sys:'Canopy System',comp:'Transparency Panel',mode:'Crazing / delamination pattern',costRange:[250,800]},
            {sys:'Ejection Seat',comp:'Rocket Motor',mode:'Propellant age — shelf life limit',costRange:[400,1200]},
            {sys:'Weapons System',comp:'Launcher Rail',mode:'Alignment drift / rail wear',costRange:[120,400]},
            {sys:'Comm System',comp:'UHF Radio',mode:'Frequency stability degradation',costRange:[80,250]}
        ],
        mh60: [
            {sys:'T700-GE-401C Engine',comp:'Power Turbine',mode:'Hot section inspection due',costRange:[600,1800]},
            {sys:'Main Rotor System',comp:'Pitch Change Rod',mode:'Fatigue life approaching limit',costRange:[300,900]},
            {sys:'Tail Rotor Gearbox',comp:'Output Pinion',mode:'Chip detector trend analysis',costRange:[400,1200]},
            {sys:'Flight Controls',comp:'SAS Servo',mode:'Null shift / authority reduction',costRange:[150,450]},
            {sys:'Forward FLIR',comp:'Dewar Assembly',mode:'Cooling efficiency degradation',costRange:[200,600]},
            {sys:'Hoist System',comp:'Cable Assembly',mode:'Strand breakage inspection due',costRange:[80,250]},
            {sys:'Sonobuoy Launcher',comp:'Pneumatic System',mode:'Pressure decay rate increase',costRange:[60,200]},
            {sys:'APU',comp:'Starter Generator',mode:'Brush wear — trending high',costRange:[100,350]}
        ],
        lcs: [
            {sys:'MT30 Gas Turbine',comp:'Power Turbine Module',mode:'Exhaust gas temperature trending',costRange:[900,2800]},
            {sys:'Waterjet Propulsor',comp:'Impeller',mode:'Cavitation erosion pattern',costRange:[500,1500]},
            {sys:'Mission Module Bay',comp:'Rail System',mode:'Alignment / structural fatigue',costRange:[200,600]},
            {sys:'30mm Mk 46 Gun',comp:'Feed System',mode:'Cycle count approaching limit',costRange:[150,450]},
            {sys:'TRS-4D Radar',comp:'Antenna Assembly',mode:'Pointing accuracy drift',costRange:[300,900]},
            {sys:'Diesel Generator',comp:'Injector Set',mode:'Fuel delivery degradation',costRange:[80,250]},
            {sys:'RHIB Davit',comp:'Hydraulic Cylinder',mode:'Seal extrusion / slow deploy',costRange:[60,200]},
            {sys:'Fire Control',comp:'EO/IR Director',mode:'Gimbal bearing roughness',costRange:[250,750]}
        ],
        // Army ground platforms
        m1a2: [
            {sys:'AGT-1500 Gas Turbine',comp:'Power Turbine Section',mode:'Hot section inspection overdue',costRange:[1200,3500]},
            {sys:'M256 120mm Gun System',comp:'Gun Tube',mode:'Bore erosion — EFC count high',costRange:[350,1000]},
            {sys:'X-1100-3B Transmission',comp:'Steer Unit',mode:'Oil analysis — metal particles',costRange:[800,2400]},
            {sys:'Track System T-158',comp:'Track Shoe Rubber',mode:'Wear measurement — approach limit',costRange:[60,200]},
            {sys:'Turret Drive System',comp:'Traverse Motor',mode:'Current draw increasing >15%',costRange:[200,600]},
            {sys:'CITV Sight',comp:'Thermal Sensor',mode:'Image quality degradation',costRange:[300,900]},
            {sys:'Fire Control System',comp:'Ballistic Computer',mode:'BITE fault rate trending',costRange:[250,750]},
            {sys:'NBC System',comp:'HEPA Filter',mode:'Pressure differential increasing',costRange:[40,120]},
            {sys:'Hull Electrical',comp:'Power Distribution Box',mode:'Insulation resistance low',costRange:[100,350]},
            {sys:'APU',comp:'Starter Motor',mode:'Cranking speed declining',costRange:[80,250]}
        ],
        bradley: [
            {sys:'Cummins VTA-903T',comp:'Turbocharger',mode:'Boost pressure declining',costRange:[200,600]},
            {sys:'M242 25mm Chain Gun',comp:'Feed Mechanism',mode:'Cycle count — approaching overhaul',costRange:[150,450]},
            {sys:'HMPT-500 Transmission',comp:'Steer Valve',mode:'Response time degradation',costRange:[400,1200]},
            {sys:'TOW Launcher',comp:'Tracking Optics',mode:'Alignment drift >2 mrad',costRange:[250,750]},
            {sys:'ISU Integrated Sight',comp:'FLIR Module',mode:'Dead pixels increasing',costRange:[300,900]},
            {sys:'Track Assembly T-150',comp:'Track Pins',mode:'Elongation measurements trending',costRange:[50,180]},
            {sys:'Ramp System',comp:'Hydraulic Ram',mode:'Bypass leak — slow close',costRange:[120,400]},
            {sys:'Communication System',comp:'SINCGARS Radio',mode:'Frequency drift out of spec',costRange:[60,200]}
        ],
        stryker: [
            {sys:'Cat C7 ACERT Diesel',comp:'Injector Bank',mode:'Fuel consumption increase >10%',costRange:[150,450]},
            {sys:'Allison 3200SP Trans',comp:'Torque Converter',mode:'Slippage trending — oil analysis',costRange:[300,900]},
            {sys:'CTIS System',comp:'Air Compressor',mode:'Cycle time increasing',costRange:[80,250]},
            {sys:'RWS .50 Cal Station',comp:'Servo Motor',mode:'Tracking speed degradation',costRange:[120,400]},
            {sys:'Run-Flat Tires',comp:'Tire Assembly',mode:'Tread depth — replacement due',costRange:[40,150]},
            {sys:'DVH Hull',comp:'Blast Panel',mode:'Crack detection — NDI finding',costRange:[200,600]},
            {sys:'Electrical System',comp:'Alternator',mode:'Output voltage fluctuation',costRange:[60,200]},
            {sys:'Cooling System',comp:'Radiator',mode:'Coolant temp trending high',costRange:[100,300]}
        ],
        ah64: [
            {sys:'T700-GE-701D Engine',comp:'N1 Compressor',mode:'Vibration signature change',costRange:[800,2500]},
            {sys:'Main Rotor System',comp:'Elastomeric Bearing',mode:'TBO approaching — hours limit',costRange:[400,1200]},
            {sys:'M230E1 30mm Gun',comp:'Barrel Assembly',mode:'Bore erosion — round count',costRange:[150,500]},
            {sys:'Longbow Radar',comp:'Antenna Array',mode:'Detection range degradation',costRange:[600,1800]},
            {sys:'TADS/PNVS',comp:'FLIR Sensor',mode:'Thermal imaging quality decline',costRange:[350,1000]},
            {sys:'Tail Rotor',comp:'Pitch Change Link',mode:'Play in control linkage',costRange:[100,350]},
            {sys:'Flight Controls',comp:'Cyclic Actuator',mode:'Hydraulic leak — bypass rate',costRange:[200,600]},
            {sys:'CMWS',comp:'Missile Warning Sensor',mode:'False alarm rate increasing',costRange:[250,750]}
        ],
        // Air Force platforms
        f22a: [
            {sys:'F119-PW-100 Engine',comp:'Augmentor Liner',mode:'Thermal fatigue cracking pattern',costRange:[1500,4500]},
            {sys:'AN/APG-77 Radar',comp:'AESA T/R Module',mode:'Power output decline >10%',costRange:[400,1200]},
            {sys:'Stealth Coating',comp:'RAM Panels',mode:'RCS measurement degradation',costRange:[200,600]},
            {sys:'ECS',comp:'Air Cycle Machine',mode:'Bearing vibration trending',costRange:[150,450]},
            {sys:'Thrust Vectoring',comp:'2D Nozzle Actuator',mode:'Response time degradation',costRange:[500,1500]},
            {sys:'Weapons Bay',comp:'Door Actuator',mode:'Cycle count approaching limit',costRange:[180,550]},
            {sys:'Landing Gear',comp:'Main Strut Oleo',mode:'Servicing interval exceeded',costRange:[250,750]},
            {sys:'Canopy System',comp:'Transparency',mode:'Optical distortion measurements',costRange:[300,900]},
            {sys:'ALR-94 EW',comp:'Receiver Module',mode:'Sensitivity degradation',costRange:[350,1000]},
            {sys:'Oxygen System',comp:'OBOGS Concentrator',mode:'O2 output trending low',costRange:[120,380]}
        ],
        // Fleet-size platforms
        f16: [
            {sys:'F110-GE-129 Engine',comp:'Turbine Blade',mode:'Thermal fatigue — hours trending',costRange:[600,1800]},
            {sys:'AN/APG-68 Radar',comp:'Transmitter',mode:'Peak power output decline',costRange:[200,600]},
            {sys:'Flight Controls',comp:'Flaperon Actuator',mode:'Hydraulic leak rate — trending',costRange:[150,450]},
            {sys:'Fuel System',comp:'Wing Tank Sealant',mode:'Fuel leak — seepage rate',costRange:[80,250]},
            {sys:'Landing Gear',comp:'Nose Gear Steering',mode:'Shimmy damper worn',costRange:[100,300]},
            {sys:'Environmental',comp:'Cockpit Pressurization',mode:'Bleed air valve wear',costRange:[120,400]},
            {sys:'Weapons Stations',comp:'Pylon Release',mode:'Solenoid response time',costRange:[60,200]},
            {sys:'Crew Escape',comp:'ACES II Seat',mode:'Rocket motor shelf life',costRange:[200,600]}
        ],
        b52h: [
            {sys:'TF33-P-3/103 Engine',comp:'Fan Blade Set',mode:'Fatigue life approaching limit',costRange:[400,1200]},
            {sys:'Wing Structure',comp:'Lower Wing Skin',mode:'Fatigue crack — NDI finding',costRange:[2000,6000]},
            {sys:'Fuel System',comp:'Bladder Cell',mode:'Permeation rate increase',costRange:[150,500]},
            {sys:'Bomb Bay',comp:'Door Actuator',mode:'Hydraulic cylinder bypass',costRange:[200,600]},
            {sys:'Electrical',comp:'Generator CSD',mode:'Oil temperature trending high',costRange:[300,900]},
            {sys:'CSRL Launcher',comp:'Rotary Mechanism',mode:'Alignment drift — rail wear',costRange:[250,750]},
            {sys:'Navigation',comp:'INS Platform',mode:'Drift rate increasing',costRange:[180,550]},
            {sys:'Communications',comp:'SATCOM Terminal',mode:'Antenna pointing accuracy',costRange:[100,350]}
        ],
        // Marine Corps
        v22: [
            {sys:'T406-AD-400 Engine',comp:'Power Turbine',mode:'CT trending — approaching limit',costRange:[800,2500]},
            {sys:'Proprotor System',comp:'Composite Blade',mode:'Delamination check — NDI due',costRange:[500,1500]},
            {sys:'Conversion System',comp:'Tilt Actuator',mode:'Hydraulic response time',costRange:[400,1200]},
            {sys:'Drive System',comp:'IMRGB Gearbox',mode:'Chip detector trend',costRange:[600,1800]},
            {sys:'Flight Controls',comp:'Fly-by-Wire Computer',mode:'BITE fault rate trending',costRange:[250,750]},
            {sys:'Nacelle System',comp:'Conversion Lock',mode:'Engagement sensor — intermittent',costRange:[150,450]},
            {sys:'Cargo System',comp:'External Cargo Hook',mode:'Load cell calibration drift',costRange:[80,250]},
            {sys:'Environmental',comp:'ECS Pack',mode:'Cooling capacity decline',costRange:[120,400]}
        ]
    };
    const fleetSystems = systems[platform] || systems.ddg51;
    let predictions = fleetSystems.map((s,i) => {
        const confidence = Math.round(50 + rng(i) * 50);
        const etaDays = Math.round(5 + rng(i*3) * (windowDays || 90));
        const eta = new Date(now.getTime() + etaDays * 86400000);
        const costUnplanned = Math.round(s.costRange[0] + rng(i*5) * (s.costRange[1]-s.costRange[0]));
        return {system:s.sys, component:s.comp, mode:s.mode, confidence, eta:eta.toLocaleDateString(), etaDays, cost:costUnplanned, urgent:etaDays<=30};
    });
    predictions = predictions.filter(p => p.confidence >= (confidenceThreshold||85));
    predictions.sort((a,b) => a.etaDays - b.etaDays);
    return predictions;
}

function loadPredictiveData() {
    const platform = document.getElementById('pdmPlatform')?.value || 'ddg51';
    const windowDays = parseInt(document.getElementById('pdmWindow')?.value) || 90;
    const confidence = parseInt(document.getElementById('pdmConfidence')?.value) || 85;
    const items = generatePredictions(platform, windowDays, confidence);
    _pdmCache = {platform, windowDays, confidence, items};

    const urgent = items.filter(i=>i.urgent).length;
    const totalCost = items.reduce((s,i)=>s+i.cost,0);
    const savings = Math.round(totalCost * 0.55);
    const accuracy = (87 + Math.random()*10).toFixed(1);
    document.getElementById('pdmPredictions').textContent = items.length;
    document.getElementById('pdmUrgent').textContent = urgent;
    document.getElementById('pdmSavings').textContent = savings >= 1000 ? '$' + (savings/1000).toFixed(1) + 'M' : '$' + savings + 'K';
    document.getElementById('pdmAccuracy').textContent = accuracy + '%';

    let html = '';
    items.forEach(it => {
        const confColor = it.confidence >= 90 ? '#ff3b30' : it.confidence >= 80 ? '#ff9500' : it.confidence >= 70 ? '#ffcc00' : '#34c759';
        html += '<tr style="border-bottom:1px solid rgba(255,255,255,0.04);'+(it.urgent?'background:rgba(255,59,48,0.04);':'') +'">';
        html += '<td style="padding:10px 8px;"><div style="color:#fff;font-weight:600;font-size:0.82rem;">'+it.system+'</div><div style="color:var(--text-muted);font-size:0.72rem;">'+it.component+'</div></td>';
        html += '<td style="padding:10px 8px;color:var(--steel);font-size:0.8rem;">'+it.mode+'</td>';
        html += '<td style="padding:10px 8px;text-align:center;"><div style="display:inline-block;padding:4px 10px;border-radius:20px;font-weight:700;font-size:0.82rem;background:'+confColor+'22;color:'+confColor+';border:1px solid '+confColor+'44;">'+it.confidence+'%</div></td>';
        html += '<td style="padding:10px 8px;text-align:center;color:'+(it.urgent?'#ff3b30':'var(--steel)')+';font-weight:'+(it.urgent?'700':'400')+';font-size:0.82rem;">'+it.eta+(it.urgent?' ⚠️':'')+'</td>';
        html += '<td style="padding:10px 8px;text-align:right;color:#ff9500;font-weight:600;font-size:0.85rem;">$'+it.cost.toLocaleString()+'K</td>';
        html += '</tr>';
    });
    document.getElementById('pdmTableBody').innerHTML = html || '<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text-muted)">No predictions above confidence threshold.</td></tr>';
    showWorkspaceNotification('Predictive analysis complete — ' + items.length + ' predictions, ' + urgent + ' urgent');
}

function exportPredictive() {
    const data = _pdmCache.items || generatePredictions('ddg51', 90, 85);
    let csv = 'System,Component,Failure Mode,Confidence %,Predicted ETA,Days Until,Cost if Unplanned ($K),Urgent\n';
    data.forEach(d => { csv += '"'+d.system+'","'+d.component+'","'+d.mode+'",'+d.confidence+','+d.eta+','+d.etaDays+','+d.cost+','+(d.urgent?'YES':'No')+'\n'; });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Predictive_Maintenance_'+(_pdmCache.platform||'DDG51').toUpperCase()+'.csv'; a.click();
    showWorkspaceNotification('Predictive maintenance report exported — ' + data.length + ' predictions');
}

async function anchorPredictive() {
    const platform = _pdmCache.platform || 'ddg51';
    const items = _pdmCache.items || generatePredictions(platform, 90, 85);
    const urgent = items.filter(i=>i.urgent).length;
    const totalCost = items.reduce((s,i)=>s+i.cost,0);
    const content = 'S4 Ledger Predictive Maintenance Report | Platform: '+platform.toUpperCase()+' | Predictions: '+items.length+' | Urgent: '+urgent+' | Total Risk: $'+totalCost+'K | Generated: '+new Date().toISOString();
    const hash = await sha256(content);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    showAnchorAnimation(hash, 'Predictive Maintenance Report', 'CUI');
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'predictive_maintenance', tx_hash:txHash})}); } catch(e) {}
    addToVault({hash, txHash, type:'predictive_maintenance', label:'Predictive Maintenance — '+platform.toUpperCase(), branch:'JOINT', icon:'🧠', content:content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'Predictive Maintenance AI', fee:0.01});
    stats.anchored++; stats.slsFees += 0.01; stats.types.add('predictive_maintenance'); updateStats(); saveStats();
    saveLocalRecord({hash, tx_hash:txHash, record_type:'predictive_maintenance', record_label:'Predictive Maintenance — '+platform.toUpperCase(), branch:'JOINT', timestamp:new Date().toISOString(), timestamp_display:new Date().toLocaleString(), fee:0.01});
    setTimeout(()=>{ document.getElementById('animStatus').textContent = '✅ Predictive data anchored!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

// ═══════════════════════════════════════════════════════════════════
//  DEFENSE DATABASE IMPORT TOOL
// ═══════════════════════════════════════════════════════════════════
const DOD_SYSTEMS_INFO = {
    // ── U.S. Navy (USN) ──
    nserc_ide: { name: 'NSERC / SE IDE', agency: 'NAVSEA', branch: 'USN', desc: 'Configuration management, TDPs, DRLs, and systems engineering artifacts', types: ['USN_CONFIG','USN_TDP','USN_DRL','USN_DI'] },
    merlin: { name: 'MERLIN', agency: 'NAVSEA', branch: 'USN', desc: 'Maintenance procedures, PMS schedules, depot repair records, TMDE calibration', types: ['USN_3M_MAINTENANCE','USN_PMS','USN_DEPOT_REPAIR','USN_CALIBRATION'] },
    navair_ams_pmt: { name: 'NAVAIR AMS PMT', agency: 'NAVAIR', branch: 'USN', desc: 'Aviation maintenance, flight ops, supply receipts, ordnance tracking', types: ['USN_AVIATION','USN_FLIGHT_OPS','USN_SUPPLY_RECEIPT','USN_ORDNANCE'] },
    cdmd_oa: { name: 'CDMD-OA', agency: 'NAVSEA/PMS', branch: 'USN', desc: 'Configuration baselines, CDRLs, ship alterations, technical data', types: ['USN_CONFIG','USN_CDRL','USN_SHIPALT','USN_DI','USN_TDP'] },
    nde: { name: 'NDE', agency: 'Navy', branch: 'USN', desc: 'Enterprise supply chain, custody, quality defects, fielding records', types: ['USN_SUPPLY_RECEIPT','USN_CUSTODY','USN_QDR','USN_FIELDING'] },
    peo_mlb: { name: 'PEO MLB', agency: 'PEO MLB', branch: 'USN', desc: 'Mine warfare and littoral combat system logistics and maintenance', types: ['USN_SUPPLY_RECEIPT','USN_3M_MAINTENANCE','USN_CONFIG','USN_ORDNANCE'] },
    cspt: { name: 'CSPT', agency: 'NAVSEA', branch: 'USN', desc: 'Combat systems certification, configuration, calibration, TDPs', types: ['USN_COMBAT_SYS','USN_CONFIG','USN_CALIBRATION','USN_TDP'] },
    navsup: { name: 'NAVSUP OneTouch', agency: 'NAVSUP', branch: 'USN', desc: 'Navy supply chain management, ordering, receiving, quality defects', types: ['USN_SUPPLY_RECEIPT','USN_QDR','USN_CUSTODY','USN_FIELDING'] },
    // ── U.S. Army (USA) ──
    gcss_army: { name: 'GCSS-Army', agency: 'USA AMC', branch: 'USA', desc: 'Army enterprise logistics — supply, maintenance, property accountability, and financial', types: ['USA_SUPPLY','USA_MAINTENANCE','USA_PROPERTY','USA_READINESS'] },
    lmp: { name: 'LMP', agency: 'USA AMC', branch: 'USA', desc: 'Logistics Modernization Program — depot maintenance, supply chain, asset management (SAP-based)', types: ['USA_DEPOT_MAINTENANCE','USA_SUPPLY','USA_ASSET_MGMT'] },
    aesip: { name: 'AESIP', agency: 'USA PEO EIS', branch: 'USA', desc: 'Army Enterprise Systems Integration Program — HR, finance, logistics integration', types: ['USA_PERSONNEL','USA_FINANCE','USA_LOGISTICS'] },
    // ── U.S. Air Force (USAF) ──
    remis: { name: 'REMIS', agency: 'AFLCMC', branch: 'USAF', desc: 'Reliability & Maintainability Information System — aircraft maintenance and component data', types: ['USAF_MAINTENANCE','USAF_COMPONENT','USAF_RELIABILITY'] },
    lims_ev: { name: 'LIMS-EV', agency: 'AFLCMC', branch: 'USAF', desc: 'Logistics, Installations & Mission Support — ERP for AF supply chain and asset management', types: ['USAF_SUPPLY','USAF_ASSET_MGMT','USAF_MAINTENANCE'] },
    d200a: { name: 'D200A', agency: 'AFMC', branch: 'USAF', desc: 'Air Force supply control study — demand forecasting, stockage computations, item management', types: ['USAF_SUPPLY_CONTROL','USAF_DEMAND','USAF_INVENTORY'] },
    // ── U.S. Marine Corps (USMC) ──
    gcss_mc: { name: 'GCSS-MC', agency: 'USMC LOGCOM', branch: 'USMC', desc: 'Marine Corps global logistics — supply, maintenance, transportation, and financial management', types: ['USMC_SUPPLY','USMC_MAINTENANCE','USMC_TRANSPORT','USMC_READINESS'] },
    atlass: { name: 'ATLASS', agency: 'USMC NAVAIR', branch: 'USMC', desc: 'Aviation Tracking & Logistics and Supply — Marine aviation maintenance and parts tracking', types: ['USMC_AVIATION','USMC_MAINTENANCE','USMC_SUPPLY'] },
    // ── U.S. Coast Guard (USCG) ──
    almis: { name: 'ALMIS', agency: 'CG-41', branch: 'USCG', desc: 'Aviation Logistics Management Information System — Coast Guard aircraft maintenance tracking', types: ['USCG_AVIATION','USCG_MAINTENANCE','USCG_COMPONENT'] },
    cgone: { name: 'CGOne', agency: 'CG-6', branch: 'USCG', desc: 'Coast Guard ERP — financial, supply, maintenance, HR, and asset management', types: ['USCG_SUPPLY','USCG_MAINTENANCE','USCG_ASSET_MGMT'] },
    // ── U.S. Space Force (USSF) ──
    ussf_lms: { name: 'USSF LMS', agency: 'SSC', branch: 'USSF', desc: 'Space Force Logistics Management System — satellite ground systems, launch logistics, component tracking', types: ['USSF_LOGISTICS','USSF_SATELLITE','USSF_COMPONENT'] },
    // ── Joint / OSD / DLA ──
    compass: { name: 'COMPASS', agency: 'DoD', branch: 'JOINT', desc: 'Personnel qualifications, training records, readiness certifications', types: ['JOINT_PERSONNEL','JOINT_TRAINING','JOINT_READINESS'] },
    mbps: { name: 'MBPS', agency: 'OSD/DSPO', branch: 'JOINT', desc: 'Product support data, sustainment metrics via model-based frameworks', types: ['JOINT_SUSTAINMENT','JOINT_PARTS','JOINT_READINESS'] },
    gcss: { name: 'GCSS (Joint)', agency: 'USA/JOINT', branch: 'JOINT', desc: 'Global logistics, supply chain, maintenance, and inventory management', types: ['USA_SUPPLY','USA_MAINTENANCE','JOINT_PARTS','JOINT_INVENTORY'] },
    dpas: { name: 'DPAS', agency: 'OSD', branch: 'JOINT', desc: 'Property accountability, custody tracking, asset inventory', types: ['USN_CUSTODY','JOINT_PROPERTY','JOINT_INVENTORY'] },
    dla_flis: { name: 'DLA FLIS / WebFLIS', agency: 'DLA', branch: 'JOINT', desc: 'Federal catalog data, NSN lookups, logistics information', types: ['JOINT_PARTS','DLA_CATALOG','DLA_SUPPLY'] },
    piee: { name: 'PIEE / WAWF', agency: 'DLA/DCMA', branch: 'JOINT', desc: 'Procurement Integrated Enterprise Environment — invoicing, receiving reports, contract payments', types: ['JOINT_INVOICE','JOINT_RECEIVING','JOINT_CONTRACT'] },
};
let _dbImportCache = { records: [], system: '', format: '' };

function updateDbImportInfo() {
    const sys = document.getElementById('dbImportSystem').value;
    const info = DOD_SYSTEMS_INFO[sys];
    if (!info) return;
    const box = document.getElementById('dbImportInfo');
    box.style.display = 'block';
    document.getElementById('dbImportInfoTitle').textContent = info.name + ' (' + info.agency + ')';
    document.getElementById('dbImportInfoDesc').textContent = info.desc;
    // Update record type dropdown
    const rt = document.getElementById('dbImportRecordType');
    rt.innerHTML = '<option value="auto">Auto-detect</option>';
    info.types.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t.replace(/_/g,' '); rt.appendChild(o); });
}

function toggleDbImportPaste() {
    const ta = document.getElementById('dbImportPaste');
    ta.style.display = ta.style.display === 'none' ? 'block' : 'none';
}

function handleDbImportFile(input) {
    if (!input.files[0]) return;
    const file = input.files[0];
    const ext = file.name.split('.').pop().toLowerCase();
    if (['csv','xml','json','txt'].includes(ext)) {
        document.getElementById('dbImportFormat').value = ext === 'txt' ? 'csv' : ext;
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('dbImportPaste').value = e.target.result;
        document.getElementById('dbImportPaste').style.display = 'block';
        showWorkspaceNotification('File loaded: ' + file.name + ' (' + (e.target.result.length/1024).toFixed(1) + ' KB)');
    };
    reader.readAsText(file);
}

function handleDbImportDrop(e) {
    e.preventDefault();
    e.currentTarget.style.borderColor = 'rgba(20,241,149,0.3)';
    if (e.dataTransfer.files.length) {
        document.getElementById('dbImportFile').files = e.dataTransfer.files;
        handleDbImportFile(document.getElementById('dbImportFile'));
    }
}

async function runDbImport() {
    const sys = document.getElementById('dbImportSystem').value;
    const fmt = document.getElementById('dbImportFormat').value;
    const pasteData = document.getElementById('dbImportPaste').value.trim();
    const info = DOD_SYSTEMS_INFO[sys];
    let records = [];

    if (pasteData) {
        // Parse real data
        if (fmt === 'csv') {
            const lines = pasteData.split('\n').filter(l => l.trim());
            if (lines.length > 1) {
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g,''));
                for (let i = 1; i < lines.length; i++) {
                    const vals = lines[i].split(',').map(v => v.trim().replace(/"/g,''));
                    const row = {};
                    headers.forEach((h, idx) => { row[h] = vals[idx] || ''; });
                    const json = JSON.stringify(row);
                    const hash = await sha256(json);
                    records.push({ data: row, hash, source: sys, type: info.types[0] });
                }
            }
        } else if (fmt === 'json') {
            try {
                let data = JSON.parse(pasteData);
                if (!Array.isArray(data)) {
                    const arrKey = Object.keys(data).find(k => Array.isArray(data[k]));
                    data = arrKey ? data[arrKey] : [data];
                }
                for (const item of data) {
                    const json = JSON.stringify(item);
                    const hash = await sha256(json);
                    records.push({ data: item, hash, source: sys, type: info.types[0] });
                }
            } catch(e) { showWorkspaceNotification('JSON parse error: ' + e.message); return; }
        } else if (fmt === 'xml') {
            const parser = new DOMParser();
            const doc = parser.parseFromString(pasteData, 'text/xml');
            const elems = doc.documentElement.children;
            for (let i = 0; i < elems.length; i++) {
                const row = {};
                for (const child of elems[i].children) row[child.tagName] = child.textContent;
                const json = JSON.stringify(row);
                const hash = await sha256(json);
                records.push({ data: row, hash, source: sys, type: info.types[0] });
            }
        }
    }

    if (records.length === 0) {
        showWorkspaceNotification('No records found. Upload a file or use "Run Demo Import".');
        return;
    }

    _dbImportCache = { records, system: sys, format: fmt };
    document.getElementById('dbImportTotal').textContent = records.length;
    document.getElementById('dbImportHashed').textContent = records.length;
    document.getElementById('dbImportAnchored').textContent = '0';
    renderDbImportResults(records, info);
    showWorkspaceNotification(records.length + ' records imported from ' + info.name);
}

function renderDbImportResults(records, info) {
    const el = document.getElementById('dbImportResults');
    if (!records.length) { el.innerHTML = ''; return; }
    let html = '<div style="overflow-x:auto;margin-top:1rem"><table class="table table-sm" style="font-size:.8rem;color:var(--steel)"><thead><tr style="color:#c9a84c"><th>#</th><th>Source</th><th>Record Type</th><th>SHA-256 Hash</th><th>Fields</th></tr></thead><tbody>';
    records.slice(0, 25).forEach((r, i) => {
        html += '<tr><td>' + (i+1) + '</td><td>' + (info?.name || r.source) + '</td><td><span style="background:rgba(20,241,149,0.12);color:#14f195;padding:2px 6px;border-radius:4px;font-size:.7rem">' + r.type + '</span></td><td style="font-family:monospace;font-size:.7rem">' + r.hash.substring(0,24) + '…</td><td>' + Object.keys(r.data).length + '</td></tr>';
    });
    if (records.length > 25) html += '<tr><td colspan="5" style="color:#14f195;text-align:center">...and ' + (records.length - 25) + ' more records</td></tr>';
    html += '</tbody></table></div>';
    el.innerHTML = html;
}

async function runDbImportDemo() {
    const sys = document.getElementById('dbImportSystem').value;
    const info = DOD_SYSTEMS_INFO[sys];
    const demoData = generateDemoImportData(sys, info);
    const records = [];
    for (const item of demoData) {
        const json = JSON.stringify(item);
        const hash = await sha256(json);
        records.push({ data: item, hash, source: sys, type: info.types[0] });
    }
    _dbImportCache = { records, system: sys, format: 'demo' };
    document.getElementById('dbImportTotal').textContent = records.length;
    document.getElementById('dbImportHashed').textContent = records.length;
    document.getElementById('dbImportAnchored').textContent = '0';
    renderDbImportResults(records, info);
    showWorkspaceNotification('Demo import: ' + records.length + ' sample records from ' + info.name);
}

function generateDemoImportData(sys, info) {
    const now = new Date().toISOString().split('T')[0];
    const samples = {
        nserc_ide: () => Array.from({length:12}, (_,i) => ({config_id:'CB-DDG51-'+(2024001+i), baseline:'Rev '+'ABCDEF'[i%6], system:['SPY-6 Radar','LM2500 Turbine','MK 41 VLS','SEWIP Block III','AN/SQQ-89','Aegis Weapon System'][i%6], status:['Approved','Pending','In Review'][i%3], tdp_pages:Math.floor(Math.random()*500)+50, date:now})),
        merlin: () => Array.from({length:15}, (_,i) => ({wp_id:'WP-'+(4000+i), procedure:['PMS Quarterly Checks','Depot Repair — Turbine','TMDE Calibration — RADAR','Corrosion Treatment','HM&E Overhaul'][i%5], system:['Main Propulsion','Combat Systems','Hull','Electrical','Auxiliary'][i%5], status:['Active','Scheduled','Complete'][i%3], next_due:now})),
        navair_ams_pmt: () => Array.from({length:10}, (_,i) => ({record_id:'AMR-'+(7000+i), aircraft:['F/A-18E','MH-60R','E-2D','P-8A','CMV-22B'][i%5], action:['Phase Inspection','Component R&R','Engine Change','Avionics Upgrade','Corrosion Treatment'][i%5], status:['Complete','In Work','Scheduled'][i%3], flight_hours:Math.floor(Math.random()*3000)+500, date:now})),
        compass: () => Array.from({length:8}, (_,i) => ({person_id:'DOD-'+String(100000+i), qualification:['Aegis Tech','Gas Turbine Eng','Combat Systems','Supply Officer','TMDE Calibrator'][i%5], level:['Master','Journeyman','Apprentice'][i%3], status:['Current','Expiring','Expired'][i%3], cert_date:now})),
        cdmd_oa: () => Array.from({length:14}, (_,i) => ({cdrl_id:'A'+String(i+1).padStart(3,'0'), title:['ILS Plan','LORA Report','Reliability Report','Tech Manual','Parts List','Wiring Diagram','Test Procedure'][i%7], di_number:'DI-ALSS-'+String(81500+i), status:['Delivered','On Track','Overdue','Pending'][i%4], program:'DDG-51 FLT III', date:now})),
        nde: () => Array.from({length:11}, (_,i) => ({receipt_id:'NDE-R-'+(5000+i), nsn:'5340-01-'+String(234+i*11)+'-'+String(5678+i*100), item:['Valve Gate','Pump Assembly','Filter Element','Bearing Set','Seal Kit'][i%5], qty:Math.floor(Math.random()*50)+1, status:['Received','In Transit','QA Hold'][i%3], date:now})),
        mbps: () => Array.from({length:9}, (_,i) => ({metric_id:'MBPS-'+(3000+i), kpi:['Ao Target','MTBF Trend','Cost Per Hour','Spares Fill Rate','Backorder Rate'][i%5], value:(Math.random()*0.2+0.8).toFixed(3), target:'0.950', status:['Green','Yellow','Red'][i%3], period:'FY26Q1'})),
        peo_mlb: () => Array.from({length:10}, (_,i) => ({record_id:'MLB-'+(6000+i), platform:['LCS-'+String(i+1),'MCM-'+String(i+10),'MIW-'+String(i+20)][i%3], action:['Mine Module Deploy','Hull Maintenance','Engine Overhaul','Ordnance Load','C4I Upgrade'][i%5], status:['Complete','Scheduled','In Work'][i%3], date:now})),
        cspt: () => Array.from({length:10}, (_,i) => ({cert_id:'CSPT-'+(8000+i), system:['Aegis BMD','SPY-6','SSDS Mk 2','CIWS Phalanx','MK 41 VLS'][i%5], test:['Integration Test','Certification Run','Calibration Check','SW Load Verify','EMI Test'][i%5], result:['Pass','Conditional','Pending'][i%3], date:now})),
        gcss: () => Array.from({length:12}, (_,i) => ({order_id:'GCSS-'+(9000+i), nsn:'2835-01-'+String(456+i*7)+'-'+String(7890+i*50), item:['Turbine Blade','Filter Assy','Pump Motor','Sensor Unit','Cable Assy'][i%5], qty:Math.floor(Math.random()*20)+1, status:['Filled','Backordered','In Transit'][i%3], branch:['USA','USN','USAF','USMC'][i%4]})),
        dpas: () => Array.from({length:8}, (_,i) => ({asset_id:'DPAS-A-'+(4000+i), description:['Generator Set','Comm Terminal','Test Equipment','Vehicle','Weapon System'][i%5], custodian:'Unit-'+String(i+1), serial:'SN-'+String(10000+i*111), condition:['Serviceable','Unserviceable','In Repair'][i%3], value:Math.floor(Math.random()*500000)+10000})),
        dla_flis: () => Array.from({length:15}, (_,i) => ({nsn:'5998-01-'+String(100+i*17)+'-'+String(1000+i*200), nomenclature:['Microcircuit','Resistor','Capacitor','Connector','Relay'][i%5], cage:'0'+String(7000+i*100), unit_price:(Math.random()*1000+5).toFixed(2), moq:Math.floor(Math.random()*100)+1, status:['Active','Inactive','Standard'][i%3]})),
        navsup: () => Array.from({length:10}, (_,i) => ({doc_id:'NAVSUP-'+(2000+i), nsn:'4320-01-'+String(567+i*13)+'-'+String(8903+i*77), item:['Pump Assembly','Valve Body','Bearing Kit','Gasket Set','Fastener Lot'][i%5], qty:Math.floor(Math.random()*100)+1, status:['Received','Shipped','Backordered'][i%3], uic:'N'+String(40000+i*100), date:now})),
        // ── Army ──
        gcss_army: () => Array.from({length:12}, (_,i) => ({doc_num:'GCSSA-'+(30000+i), nsn:'2530-01-'+String(300+i*9)+'-'+String(4000+i*120), item:['Track Pad','Engine Filter','Transmission Assy','Hydraulic Pump','Radio Set'][i%5], qty:Math.floor(Math.random()*30)+1, status:['Issued','On Hand','Due-In'][i%3], uic:'W'+String(50000+i*100), platform:['M1A2 SEPv3','M2A4 Bradley','Stryker ICV','JLTV','CH-47F'][i%5], date:now})),
        lmp: () => Array.from({length:10}, (_,i) => ({work_order:'LMP-WO-'+(20000+i), depot:['Anniston AD','Letterkenny AD','Red River AD','Tobyhanna AD','Corpus Christi AD'][i%5], system:['M1 Abrams Turret','HMMWV Drivetrain','AH-64 Gearbox','Patriot Radar','Bradley Hull'][i%5], status:['In Work','Complete','Awaiting Parts'][i%3], hours:Math.floor(Math.random()*500)+40, date:now})),
        aesip: () => Array.from({length:8}, (_,i) => ({record_id:'AESIP-'+(40000+i), category:['Personnel','Finance','Logistics','Training','Readiness'][i%5], action:['Transfer','Obligation','Receipt','Cert Update','Assessment'][i%5], status:['Processed','Pending','Error'][i%3], date:now})),
        // ── Air Force ──
        remis: () => Array.from({length:12}, (_,i) => ({wuc:'REMIS-'+(11000+i), aircraft:['F-35A','F-22A','B-21 Raider','KC-46A','C-17A'][i%5], discrepancy:['Engine Vibration','Avionics Fault','Hydraulic Leak','Landing Gear Wear','Radar Degradation'][i%5], action:['Replaced Component','Bench Check','Operational Check','Depot Return','Software Update'][i%5], flying_hours:Math.floor(Math.random()*4000)+200, status:['Closed','Open','Deferred'][i%3], date:now})),
        lims_ev: () => Array.from({length:10}, (_,i) => ({doc_id:'LIMS-'+(15000+i), nsn:'1680-01-'+String(400+i*11)+'-'+String(6000+i*90), item:['Turbine Blade','Actuator Assy','Avionics Module','Fuel Pump','Canopy Seal'][i%5], qty:Math.floor(Math.random()*25)+1, status:['Received','In Transit','Backordered'][i%3], base:['Hill AFB','Tinker AFB','Robins AFB','Wright-Patterson','Eglin AFB'][i%5], date:now})),
        d200a: () => Array.from({length:10}, (_,i) => ({item_id:'D200-'+String(60000+i), nsn:'1560-01-'+String(200+i*13)+'-'+String(3000+i*70), nomenclature:['Wing Spar','Engine Mount','Landing Gear Strut','Flight Control Surface','Fuel Cell'][i%5], demand_rate:(Math.random()*0.05+0.01).toFixed(4), rop:Math.floor(Math.random()*15)+1, roq:Math.floor(Math.random()*20)+5, status:['Stocked','Computed','Review'][i%3]})),
        // ── Marine Corps ──
        gcss_mc: () => Array.from({length:10}, (_,i) => ({doc_num:'GCSSMC-'+(25000+i), nsn:'2350-01-'+String(500+i*8)+'-'+String(7000+i*60), item:['Track Link','Optic Sight','Radio Battery','Armor Plate','Wheel Assembly'][i%5], qty:Math.floor(Math.random()*40)+1, status:['Issued','On Hand','Requisitioned'][i%3], unit:['1st MarDiv','2nd MarDiv','3rd MarDiv','1st MAW','2nd MAW'][i%5], platform:['AAV-P7','LAV-25','M1A1 FEP','AH-1Z','MV-22B'][i%5], date:now})),
        atlass: () => Array.from({length:10}, (_,i) => ({record_id:'ATL-'+(35000+i), aircraft:['AH-1Z Viper','UH-1Y Venom','MV-22B Osprey','CH-53K King Stallion','F-35B'][i%5], action:['Phase Inspection','Component R&R','Engine Change','Avionics Upgrade','Structural Repair'][i%5], flight_hours:Math.floor(Math.random()*2500)+300, status:['Complete','In Work','Scheduled'][i%3], squadron:['HMLA-267','HMLA-169','VMM-163','HMH-461','VMFA-121'][i%5], date:now})),
        // ── Coast Guard ──
        almis: () => Array.from({length:8}, (_,i) => ({record_id:'ALMIS-'+(45000+i), aircraft:['MH-65 Dolphin','MH-60T Jayhawk','HC-130J','HC-144A','C-27J'][i%5], action:['Phase Inspection','Engine Change','Avionics Update','Structural Check','Hoist Maintenance'][i%5], flight_hours:Math.floor(Math.random()*2000)+100, status:['Complete','In Work','Deferred'][i%3], airstation:['Elizabeth City','Kodiak','Clearwater','Sacramento','Mobile'][i%5], date:now})),
        cgone: () => Array.from({length:8}, (_,i) => ({doc_id:'CGONE-'+(50000+i), category:['Supply','Maintenance','Finance','HR','Asset'][i%5], asset:['WMSL 750 Cutter','WPB 87 Patrol','WMSM 270','Buoy Tender','Small Boat'][i%5], action:['Procurement','Work Order','Transfer','Receipt','Disposal'][i%5], status:['Complete','Pending','In Process'][i%3], date:now})),
        // ── Space Force ──
        ussf_lms: () => Array.from({length:8}, (_,i) => ({record_id:'USSF-'+(55000+i), system:['GPS III SV','SBIRS GEO','AEHF Sat','GSSAP','Wideband Global'][i%5], component:['Solar Array','Thruster Module','Comm Transponder','Star Tracker','Reaction Wheel'][i%5], action:['Ground Test','Pre-Launch Check','On-Orbit Anomaly','Component Receipt','Depot Maintenance'][i%5], status:['Nominal','Watch','Anomaly'][i%3], location:['Vandenberg SFB','Cape Canaveral SFS','Schriever SFB','Peterson SFB','Buckley SFB'][i%5], date:now})),
        // ── Joint ──
        piee: () => Array.from({length:10}, (_,i) => ({doc_id:'PIEE-'+(70000+i), contract:'W912HZ-26-C-'+String(1000+i), vendor:['Lockheed Martin','Raytheon','BAE Systems','General Dynamics','L3Harris'][i%5], invoice_amt:Math.floor(Math.random()*500000)+10000, action:['Invoice Submitted','Receiving Report','Acceptance','Payment','Dispute'][i%5], status:['Approved','Pending','Rejected'][i%3], date:now})),
    };
    return (samples[sys] || samples.nserc_ide)();
}

async function anchorDbImport() {
    if (!_dbImportCache.records.length) { showWorkspaceNotification('Import records first'); return; }
    const info = DOD_SYSTEMS_INFO[_dbImportCache.system];
    const branchKey = info.branch || 'JOINT';
    let anchored = 0;
    for (const rec of _dbImportCache.records) {
        const content = JSON.stringify(rec.data);
        const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
        rec.txHash = txHash;
        rec.anchored = true;
        anchored++;
        try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash:rec.hash, record_type:rec.type, tx_hash:txHash, content_preview:content.substring(0,100)})}); } catch(e) {}
        addToVault({hash:rec.hash, txHash, type:rec.type, label:info.name+' Import — '+rec.type.replace(/_/g,' '), branch:branchKey, icon:'🗄', content:content.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:info.name+' Import', fee:0.01, data_source:_dbImportCache.system});
        // Push to sessionRecords so Transaction Log updates
        sessionRecords.push({
            type:rec.type, label:info.name+' Import — '+rec.type.replace(/_/g,' '), icon:'🗄',
            branch:branchKey, hash:rec.hash, txHash, encrypted:false,
            timestamp:new Date().toISOString(), content:content.substring(0,100)
        });
        // Save to localStorage so Metrics & Transactions pages see it
        saveLocalRecord({
            hash:rec.hash, record_type:rec.type, record_label:info.name+' Import — '+rec.type.replace(/_/g,' '),
            branch:branchKey, icon:'🗄', timestamp:new Date().toISOString(),
            timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC',
            fee:0.01, tx_hash:txHash, system:info.name, data_source:_dbImportCache.system
        });
        stats.anchored++; stats.slsFees += 0.01; stats.types.add(rec.type);
    }
    updateStats(); saveStats(); updateTxLog();
    document.getElementById('dbImportAnchored').textContent = anchored;
    showAnchorAnimation(_dbImportCache.records[0].hash, info.name + ' — ' + anchored + ' Records', 'CUI');
    setTimeout(()=>{ document.getElementById('animStatus').textContent = '✅ ' + anchored + ' records anchored to XRPL!'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
    await new Promise(r => setTimeout(r, 3200)); hideAnchorAnimation();
}

function exportDbImport() {
    if (!_dbImportCache.records.length) { showWorkspaceNotification('No records to export'); return; }
    const info = DOD_SYSTEMS_INFO[_dbImportCache.system];
    let csv = 'Index,Source System,Record Type,SHA-256 Hash,Fields,Anchored,TX Hash\n';
    _dbImportCache.records.forEach((r, i) => {
        csv += (i+1)+',"'+info.name+'","'+r.type+'","'+r.hash+'",'+Object.keys(r.data).length+','+(r.anchored?'YES':'No')+','+(r.txHash||'—')+'\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Defense_Import_'+info.name.replace(/[^a-zA-Z0-9]/g,'_')+'_'+new Date().toISOString().split('T')[0]+'.csv'; a.click();
    showWorkspaceNotification('Export complete — '+_dbImportCache.records.length+' record hashes from '+info.name);
}


// ══ SUBMISSION REVIEW & DISCREPANCY ANALYZER ══
function onSubProgramChange() {
    const sel = document.getElementById('subProgram');
    if (!sel || !window.S4_PLATFORMS) return;
    const key = sel.value;
    const plat = S4_PLATFORMS[key];
    if (plat) {
        const branchSel = document.getElementById('subBranch');
        if (branchSel) branchSel.value = plat.b;
    }
}

const SUBMISSION_TYPES = {
    VRSL:'Vendor Recommended Spares List', IUID:'IUID Registry / Serialized List',
    CONFIG_DWG:'Configuration Drawing / Baseline', OUTFITTING:'Outfitting List / Drawing',
    PO_INDEX:'Purchase Order Index', PTD:'Provisioning Technical Data',
    APL:'Allowance Parts List', TECH_MANUAL:'Technical Manual (IETM/TM)',
    MAINT_PLAN:'Maintenance Plan Update', SUPPLY_REQ:'Supply Support Request',
    LSAR:'LSAR / Logistics Data', FRACAS:'FRACAS / Reliability Report',
    CAL_RECORD:'Calibration Record', PHS_T:'Packaging / PHS&T Data',
    TRAIN_EQUIP:'Training Equipment List', SUPPORT_EQUIP:'Support Equipment Recommendation',
    WARRANTY:'Warranty / Guarantee Submission', ECP:'Engineering Change Proposal',
    CDRL:'CDRL Deliverable', BOM:'Bill of Materials', COST_EST:'Cost Estimate / ROM',
    TEST_REPORT:'Test & Evaluation Report', HAZMAT:'HAZMAT / Environmental Data',
    CUSTOM:'Custom Submission Type'
};

let _subCache = { items:[], discrepancies:[], baseline:[], meta:{} };
let _subHistory = JSON.parse(localStorage.getItem('s4_submission_history') || '[]');
let _subFilter = 'all';

function handleSubFileUpload(e) {
    const files = e.target.files;
    if (!files.length) return;
    const file = files[0];
    const reader = new FileReader();
    reader.onload = function(ev) {
        const raw = ev.target.result;
        try {
            if (file.name.endsWith('.json')) {
                _subCache.items = JSON.parse(raw);
            } else if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                _subCache.items = parseCSVSubmission(raw);
            } else {
                _subCache.items = parseCSVSubmission(raw);
            }
            showWorkspaceNotification('Loaded ' + _subCache.items.length + ' records from ' + file.name);
            document.getElementById('subUploadZone').innerHTML = '<i class="fas fa-check-circle" style="font-size:2rem;color:#14f195;display:block;margin-bottom:4px"></i><div style="color:#14f195;font-weight:600">' + file.name + '</div><div style="color:var(--steel);font-size:.78rem">' + _subCache.items.length + ' records loaded</div>';
        } catch(err) {
            showWorkspaceNotification('Error parsing file: ' + err.message);
        }
    };
    reader.readAsText(file);
}

function parseCSVSubmission(raw) {
    const lines = raw.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g,''));
    return lines.slice(1).map(line => {
        const vals = line.split(',').map(v => v.trim().replace(/"/g,''));
        const obj = {};
        headers.forEach((h, i) => { obj[h] = vals[i] || ''; });
        return obj;
    });
}

function generateDemoSubmission(docType) {
    // Realistic dummy data based on actual defense ILS submission patterns
    const VRSL_DATA = [
        {nsn:'5998-01-422-7891',partNumber:'6872843-1',nomenclature:'Circuit Card Assy, Radar Interface',cageCode:'53711',qty:4,unitPrice:12450.00,source:'OEM',leadTime:'120 days',status:'Active'},
        {nsn:'5962-01-389-5523',partNumber:'74A929411-1003',nomenclature:'Semiconductor Device, Signal Processing',cageCode:'80058',qty:12,unitPrice:890.00,source:'OEM',leadTime:'90 days',status:'Active'},
        {nsn:'5905-01-567-3421',partNumber:'MS90451-1',nomenclature:'Resistor, Fixed, Film (MIL-PRF-55342)',cageCode:'06324',qty:200,unitPrice:4.75,source:'DLA',leadTime:'14 days',status:'Active'},
        {nsn:'5961-01-445-8832',partNumber:'M55342K06B10E',nomenclature:'Capacitor, Fixed, Ceramic (MIL-PRF-55681)',cageCode:'19139',qty:150,unitPrice:8.20,source:'DLA',leadTime:'21 days',status:'Active'},
        {nsn:'5950-01-502-9901',partNumber:'TF4SX21ZZM',nomenclature:'Transformer, Power, 400Hz',cageCode:'81349',qty:2,unitPrice:18750.00,source:'OEM',leadTime:'180 days',status:'DMSMS Watch'},
        {nsn:'5945-01-612-4478',partNumber:'K10P-11A15-120',nomenclature:'Relay, Electromagnetic (MIL-PRF-39016)',cageCode:'13499',qty:24,unitPrice:145.00,source:'OEM',leadTime:'45 days',status:'Active'},
        {nsn:'5999-01-478-2201',partNumber:'M83723/75W2226N',nomenclature:'Connector, Plug, Electrical (MIL-DTL-83723)',cageCode:'77820',qty:36,unitPrice:287.50,source:'DLA',leadTime:'30 days',status:'Active'},
        {nsn:'5930-01-539-7712',partNumber:'MS24659-23D',nomenclature:'Switch, Toggle (MIL-DTL-3950)',cageCode:'96214',qty:16,unitPrice:42.00,source:'DLA',leadTime:'14 days',status:'Active'},
        {nsn:'5920-01-401-5567',partNumber:'F02A125V3.15A',nomenclature:'Fuse, Cartridge (MIL-PRF-23419)',cageCode:'35180',qty:100,unitPrice:3.50,source:'DLA',leadTime:'7 days',status:'Active'},
        {nsn:'6210-01-588-9023',partNumber:'MS25010-4',nomenclature:'Indicator, Electrical (MIL-DTL-25010)',cageCode:'81349',qty:8,unitPrice:165.00,source:'OEM',leadTime:'60 days',status:'Active'},
        {nsn:'6145-01-502-3345',partNumber:'M17/94-RG179',nomenclature:'Cable Assy, RF Coaxial (MIL-DTL-17)',cageCode:'14457',qty:20,unitPrice:425.00,source:'OEM',leadTime:'45 days',status:'Active'},
        {nsn:'5963-01-620-1189',partNumber:'5962-0122002HXA',nomenclature:'IC, Digital, ASIC (Custom)',cageCode:'53711',qty:6,unitPrice:4580.00,source:'OEM',leadTime:'240 days',status:'Obsolete'},
        {nsn:'5895-01-478-5501',partNumber:'7400508-123',nomenclature:'Receiver-Transmitter, UHF',cageCode:'80058',qty:2,unitPrice:87500.00,source:'OEM',leadTime:'270 days',status:'Active'},
        {nsn:'4820-01-512-8867',partNumber:'S6164-60037-1',nomenclature:'Valve, Solenoid, Hydraulic',cageCode:'99286',qty:4,unitPrice:6200.00,source:'OEM',leadTime:'90 days',status:'Active'},
        {nsn:'2840-01-489-3345',partNumber:'6859742',nomenclature:'Turbine Module, Gas (LM2500)',cageCode:'00000',qty:1,unitPrice:945000.00,source:'OEM',leadTime:'365 days',status:'Active'},
        {nsn:'3110-01-567-4401',partNumber:'MS21920-40',nomenclature:'Bearing, Roller, Cylindrical',cageCode:'81349',qty:8,unitPrice:890.00,source:'DLA',leadTime:'30 days',status:'Active'},
        {nsn:'5340-01-423-7789',partNumber:'MS29513-236',nomenclature:'Packing, Preformed (O-Ring)',cageCode:'96214',qty:500,unitPrice:2.10,source:'DLA',leadTime:'7 days',status:'Active'},
        {nsn:'4730-01-501-2234',partNumber:'AN924-20D',nomenclature:'Coupling, Hose, Quick Disconnect',cageCode:'35180',qty:12,unitPrice:78.00,source:'DLA',leadTime:'14 days',status:'Active'},
        {nsn:'5331-01-489-5578',partNumber:'NSA-MS29512-08',nomenclature:'Gasket, Metallic',cageCode:'81349',qty:24,unitPrice:165.00,source:'DLA',leadTime:'21 days',status:'Active'},
        {nsn:'4320-01-534-8901',partNumber:'S6164-80012',nomenclature:'Pump, Centrifugal, Seawater Service',cageCode:'99286',qty:2,unitPrice:34500.00,source:'OEM',leadTime:'180 days',status:'Active'},
        {nsn:'6105-01-578-2267',partNumber:'GE-MQ90-1200',nomenclature:'Generator, Ship Service (SSGTG)',cageCode:'00000',qty:1,unitPrice:450000.00,source:'OEM',leadTime:'365 days',status:'Active'},
        {nsn:'5999-01-612-3390',partNumber:'D38999/26WJ61SN',nomenclature:'Connector, Receptacle (MIL-DTL-38999)',cageCode:'77820',qty:48,unitPrice:312.00,source:'DLA',leadTime:'30 days',status:'Active'},
        {nsn:'5962-01-512-8834',partNumber:'SMJ320C50PQM',nomenclature:'Microprocessor, 32-Bit DSP',cageCode:'53711',qty:10,unitPrice:2340.00,source:'OEM',leadTime:'120 days',status:'DMSMS Watch'},
        {nsn:'5910-01-534-2201',partNumber:'M39006/22-0660',nomenclature:'Capacitor, Fixed, Wet Tantalum',cageCode:'19139',qty:30,unitPrice:95.00,source:'DLA',leadTime:'45 days',status:'Active'},
        {nsn:'5945-01-501-3378',partNumber:'MIL-R-39016/48-001',nomenclature:'Relay, Solid State',cageCode:'13499',qty:18,unitPrice:425.00,source:'OEM',leadTime:'60 days',status:'Active'},
        {nsn:'2990-01-489-6612',partNumber:'NAVSEA-STA-074',nomenclature:'Ship Fuel Oil Service System Component Kit',cageCode:'99286',qty:4,unitPrice:8900.00,source:'OEM',leadTime:'90 days',status:'Active'},
        {nsn:'4810-01-556-7834',partNumber:'S6164-40023-2',nomenclature:'Valve, Gate, Seawater',cageCode:'99286',qty:6,unitPrice:5600.00,source:'OEM',leadTime:'120 days',status:'Active'},
        {nsn:'5895-01-567-9023',partNumber:'AN/SPS-73(V)18',nomenclature:'Radar Navigation Display Unit',cageCode:'80058',qty:1,unitPrice:125000.00,source:'OEM',leadTime:'240 days',status:'Active'},
        {nsn:'5820-01-489-1156',partNumber:'RT-1694/U',nomenclature:'Radio Set, VHF/UHF',cageCode:'13499',qty:3,unitPrice:42000.00,source:'OEM',leadTime:'180 days',status:'Active'},
        {nsn:'5999-01-534-4490',partNumber:'M55302/68-B22S',nomenclature:'Connector, Fiber Optic',cageCode:'77820',qty:24,unitPrice:156.00,source:'DLA',leadTime:'30 days',status:'Active'},
    ];

    const IUID_DATA = [
        {uid:'0013E841AF.3501.6872843-1.001',serialNumber:'SN-DDG-RAD-0024',partNumber:'6872843-1',nomenclature:'Circuit Card Assy, Radar Interface',acquisitionCost:12450.00,condition:'New',location:'Norfolk NAVSTA'},
        {uid:'0013E841AF.3501.LM2500-GEN.001',serialNumber:'SN-LM2500-4478',partNumber:'6859742',nomenclature:'Turbine Module, Gas (LM2500)',acquisitionCost:945000.00,condition:'New',location:'Ingalls Shipbuilding'},
        {uid:'0013E841AF.3501.SSGTG.001',serialNumber:'SN-SSGTG-1201',partNumber:'GE-MQ90-1200',nomenclature:'Generator, Ship Service',acquisitionCost:450000.00,condition:'New',location:'Bath Iron Works'},
        {uid:'0013E841AF.3501.NAV-RDR.001',serialNumber:'SN-SPS73-V18-003',partNumber:'AN/SPS-73(V)18',nomenclature:'Radar Navigation Display',acquisitionCost:125000.00,condition:'New',location:'San Diego NAVSTA'},
        {uid:'0013E841AF.3501.RT1694.001',serialNumber:'SN-RADIO-VHF-012',partNumber:'RT-1694/U',nomenclature:'Radio Set VHF/UHF',acquisitionCost:42000.00,condition:'Serviceable',location:'Pearl Harbor'},
        {uid:'0013E841AF.3501.RCVR-TX.001',serialNumber:'SN-UHF-RX-044',partNumber:'7400508-123',nomenclature:'Receiver-Transmitter UHF',acquisitionCost:87500.00,condition:'New',location:'Norfolk NAVSTA'},
        {uid:'0013E841AF.3501.PUMP-SW.001',serialNumber:'SN-PUMP-CEN-008',partNumber:'S6164-80012',nomenclature:'Pump, Centrifugal, Seawater',acquisitionCost:34500.00,condition:'Serviceable',location:'Bremerton'},
        {uid:'0013E841AF.3501.VALVE-SW.001',serialNumber:'SN-VALVE-GT-019',partNumber:'S6164-40023-2',nomenclature:'Valve, Gate, Seawater',acquisitionCost:5600.00,condition:'New',location:'San Diego NAVSTA'},
        {uid:'0013E841AF.3501.SOL-VLV.001',serialNumber:'SN-SOL-HYD-006',partNumber:'S6164-60037-1',nomenclature:'Valve Solenoid Hydraulic',acquisitionCost:6200.00,condition:'Repairable',location:'Mayport'},
        {uid:'0013E841AF.3501.XFMR-PWR.001',serialNumber:'SN-XFMR-400-003',partNumber:'TF4SX21ZZM',nomenclature:'Transformer Power 400Hz',acquisitionCost:18750.00,condition:'New',location:'Norfolk NAVSTA'},
        {uid:'0013E841AF.3501.DSP-PROC.001',serialNumber:'SN-DSP32-010',partNumber:'SMJ320C50PQM',nomenclature:'Microprocessor 32-Bit DSP',acquisitionCost:2340.00,condition:'Serviceable',location:'San Diego NAVSTA'},
        {uid:'0013E841AF.3501.ASIC-CCA.001',serialNumber:'SN-ASIC-CUST-002',partNumber:'5962-0122002HXA',nomenclature:'IC Digital ASIC Custom',acquisitionCost:4580.00,condition:'Repairable',location:'Bremerton'},
    ];

    const CONFIG_DATA = [
        {drawingNumber:'S9086-TX-STM-010/CH-074',revision:'Rev F',title:'NSTM Chapter 074 - Gaskets & Packing',effectivity:'All DDG-51 Class',status:'Released',pages:42,changeNotice:''},
        {drawingNumber:'S9086-TX-STM-010/CH-262',revision:'Rev D',title:'NSTM Chapter 262 - Lubricating Oil',effectivity:'All DDG-51 Class',status:'Released',pages:38,changeNotice:''},
        {drawingNumber:'803-7187231',revision:'Rev C',title:'Main Propulsion System Piping Arrangement',effectivity:'DDG-123 thru DDG-137',status:'Released',pages:12,changeNotice:'ECN-2026-0042'},
        {drawingNumber:'803-7187445',revision:'Rev B',title:'Electrical One-Line Diagram, SSGTG',effectivity:'DDG-128 thru DDG-137',status:'In Review',pages:8,changeNotice:'ECN-2026-0051'},
        {drawingNumber:'803-7188012',revision:'Rev A',title:'Combat System Integration Diagram (AEGIS)',effectivity:'DDG-131 thru DDG-137',status:'Draft',pages:24,changeNotice:''},
        {drawingNumber:'S9086-TX-STM-010/CH-541',revision:'Rev E',title:'NSTM Chapter 541 - Ship Fuel & Fuel Systems',effectivity:'All DDG-51 Class',status:'Released',pages:56,changeNotice:''},
        {drawingNumber:'803-7189901',revision:'Rev B',title:'HVAC Arrangement, Forward Machinery Room',effectivity:'DDG-128 thru DDG-137',status:'Released',pages:6,changeNotice:'ECN-2025-0198'},
        {drawingNumber:'803-7190234',revision:'Rev A',title:'Weapons Elevator Hydraulic System',effectivity:'DDG-131 thru DDG-137',status:'In Review',pages:14,changeNotice:'ECN-2026-0063'},
    ];

    const BOM_DATA = [
        {lineItem:1,partNumber:'6859742',nomenclature:'Turbine Module Gas (LM2500)',qty:4,unitPrice:945000.00,totalPrice:3780000.00,make_buy:'Buy',vendor:'GE Marine'},
        {lineItem:2,partNumber:'GE-MQ90-1200',nomenclature:'Generator Ship Service SSGTG',qty:4,unitPrice:450000.00,totalPrice:1800000.00,make_buy:'Buy',vendor:'GE Marine'},
        {lineItem:3,partNumber:'AN/SPS-73(V)18',nomenclature:'Navigation Radar Display',qty:2,unitPrice:125000.00,totalPrice:250000.00,make_buy:'Buy',vendor:'Raytheon'},
        {lineItem:4,partNumber:'RT-1694/U',nomenclature:'Radio Set VHF/UHF',qty:6,unitPrice:42000.00,totalPrice:252000.00,make_buy:'Buy',vendor:'L3Harris'},
        {lineItem:5,partNumber:'7400508-123',nomenclature:'Receiver-Transmitter UHF',qty:4,unitPrice:87500.00,totalPrice:350000.00,make_buy:'Buy',vendor:'Raytheon'},
        {lineItem:6,partNumber:'S6164-80012',nomenclature:'Pump Centrifugal Seawater',qty:8,unitPrice:34500.00,totalPrice:276000.00,make_buy:'Buy',vendor:'Crane Naval'},
        {lineItem:7,partNumber:'S6164-40023-2',nomenclature:'Valve Gate Seawater',qty:12,unitPrice:5600.00,totalPrice:67200.00,make_buy:'Buy',vendor:'Crane Naval'},
        {lineItem:8,partNumber:'S6164-60037-1',nomenclature:'Valve Solenoid Hydraulic',qty:8,unitPrice:6200.00,totalPrice:49600.00,make_buy:'Buy',vendor:'Moog Inc'},
        {lineItem:9,partNumber:'TF4SX21ZZM',nomenclature:'Transformer Power 400Hz',qty:6,unitPrice:18750.00,totalPrice:112500.00,make_buy:'Buy',vendor:'SL Power'},
        {lineItem:10,partNumber:'6872843-1',nomenclature:'Circuit Card Assy Radar IF',qty:12,unitPrice:12450.00,totalPrice:149400.00,make_buy:'Buy',vendor:'Raytheon'},
        {lineItem:11,partNumber:'SMJ320C50PQM',nomenclature:'Microprocessor 32-Bit DSP',qty:24,unitPrice:2340.00,totalPrice:56160.00,make_buy:'Buy',vendor:'Texas Instruments'},
        {lineItem:12,partNumber:'5962-0122002HXA',nomenclature:'IC Digital ASIC Custom',qty:18,unitPrice:4580.00,totalPrice:82440.00,make_buy:'Make',vendor:'(Manufactured)'},
        {lineItem:13,partNumber:'K10P-11A15-120',nomenclature:'Relay Electromagnetic',qty:48,unitPrice:145.00,totalPrice:6960.00,make_buy:'Buy',vendor:'TE Connectivity'},
        {lineItem:14,partNumber:'D38999/26WJ61SN',nomenclature:'Connector Receptacle',qty:96,unitPrice:312.00,totalPrice:29952.00,make_buy:'Buy',vendor:'Amphenol'},
        {lineItem:15,partNumber:'MS21920-40',nomenclature:'Bearing Roller Cylindrical',qty:16,unitPrice:890.00,totalPrice:14240.00,make_buy:'Buy',vendor:'Timken'},
        {lineItem:16,partNumber:'M83723/75W2226N',nomenclature:'Connector Plug Electrical',qty:72,unitPrice:287.50,totalPrice:20700.00,make_buy:'Buy',vendor:'Glenair'},
        {lineItem:17,partNumber:'NSA-MS29512-08',nomenclature:'Gasket Metallic',qty:200,unitPrice:165.00,totalPrice:33000.00,make_buy:'Buy',vendor:'Garlock'},
        {lineItem:18,partNumber:'M17/94-RG179',nomenclature:'Cable Assy RF Coaxial',qty:40,unitPrice:425.00,totalPrice:17000.00,make_buy:'Buy',vendor:'Times Microwave'},
        {lineItem:19,partNumber:'NAVSEA-STA-074',nomenclature:'Fuel Oil Service Kit',qty:8,unitPrice:8900.00,totalPrice:71200.00,make_buy:'Buy',vendor:'Parker Hannifin'},
        {lineItem:20,partNumber:'MS29513-236',nomenclature:'Packing Preformed O-Ring',qty:1000,unitPrice:2.10,totalPrice:2100.00,make_buy:'Buy',vendor:'Parker Hannifin'},
    ];

    const types = { VRSL: ()=>VRSL_DATA.map(d=>({...d})), IUID: ()=>IUID_DATA.map(d=>({...d})), CONFIG_DWG: ()=>CONFIG_DATA.map(d=>({...d})), BOM: ()=>BOM_DATA.map(d=>({...d})) };
    return (types[docType] || types.VRSL)();
}

function generateDemoBaseline(items, docType) {
    // Generate realistic "previous submission" with specific known differences
    return items.map((item, i) => {
        const prev = {...item};
        // Price was lower in previous submission (OEM raised prices)
        if (i % 4 === 0 && prev.unitPrice) prev.unitPrice = +(prev.unitPrice * 0.82).toFixed(2);
        // Quantity changed (customer adjusted spares depth)
        if (i % 6 === 0 && prev.qty) prev.qty = prev.qty + Math.floor(Math.random()*8)+2;
        // Source changed (was OEM, now aftermarket or vice versa)
        if (i % 8 === 0 && prev.source) prev.source = prev.source === 'OEM' ? 'DLA' : 'OEM';
        // CAGE code changed (different manufacturer in previous)
        if (i % 10 === 0 && prev.cageCode) prev.cageCode = '99999';
        // Status downgraded (was Active, now DMSMS Watch in current)
        if (i % 7 === 0 && prev.status && prev.status !== 'Active') prev.status = 'Active';
        // Lead time increased significantly
        if (i % 5 === 0 && prev.leadTime) { const days = parseInt(prev.leadTime)||60; prev.leadTime = Math.max(14, days - 45) + ' days'; }
        // Drawing revision changed
        if (i % 3 === 0 && prev.revision) { const r = prev.revision.charCodeAt(4); prev.revision = 'Rev ' + String.fromCharCode(Math.max(65, r-1)); }
        // Vendor changed
        if (i % 9 === 0 && prev.vendor) prev.vendor = 'Previous Vendor Inc';
        // Condition changed (IUID)
        if (i % 5 === 0 && prev.condition) prev.condition = prev.condition === 'New' ? 'Serviceable' : 'New';
        return prev;
    });
}

function runSubmissionDemo() {
    const docType = document.getElementById('subDocType').value;
    const items = generateDemoSubmission(docType);
    const baseline = generateDemoBaseline(items, docType);
    // Add 3 items that were in baseline but "removed" in current
    const removed = Array.from({length:3}, (_, i) => ({
        partNumber: 'PN-REMOVED-' + (i+1), nomenclature: 'Discontinued Component ' + (i+1),
        nsn: '0000-00-000-000' + i, unitPrice: +(Math.random()*300+50).toFixed(2), qty: Math.floor(Math.random()*10)+1,
        status: 'Active', source: 'OEM'
    }));
    // Add 4 items that are "new" (not in baseline)
    items.push(...Array.from({length:4}, (_, i) => ({
        partNumber: 'PN-NEW-' + (i+1), nomenclature: 'New Component Added ' + (i+1),
        nsn: '9999-99-999-999' + i, unitPrice: +(Math.random()*1000+100).toFixed(2), qty: Math.floor(Math.random()*20)+1,
        status: 'Active', source: 'Aftermarket', _isNew: true
    })));

    _subCache.items = items;
    _subCache.baseline = [...baseline, ...removed];
    const _subPlat = window.S4_PLATFORMS && S4_PLATFORMS[document.getElementById('subProgram').value];
    _subCache.meta = {
        program: document.getElementById('subProgram').value,
        branch: document.getElementById('subBranch').value || (_subPlat ? _subPlat.b : 'JOINT'),
        docType, vendor: _subPlat ? 'Huntington Ingalls Industries' : 'Demo OEM Vendor',
        timestamp: new Date().toISOString()
    };

    document.getElementById('subUploadZone').innerHTML = '<i class="fas fa-check-circle" style="font-size:2rem;color:#14f195;display:block;margin-bottom:4px"></i><div style="color:#14f195;font-weight:600">Demo ' + (SUBMISSION_TYPES[docType]||docType) + '</div><div style="color:var(--steel);font-size:.78rem">' + items.length + ' current records vs ' + _subCache.baseline.length + ' baseline records loaded</div>';

    runDiscrepancyEngine();
}

function analyzeSubmission() {
    if (!_subCache.items.length) {
        // Check paste data
        const pasteData = document.getElementById('subPasteData').value.trim();
        if (pasteData) {
            try {
                _subCache.items = pasteData.startsWith('[') ? JSON.parse(pasteData) : parseCSVSubmission(pasteData);
            } catch(e) { showWorkspaceNotification('Could not parse pasted data'); return; }
        } else {
            showWorkspaceNotification('Upload a file or paste data first, or click "Run Demo Analysis"');
            return;
        }
    }
    // Generate synthetic baseline if none exists
    if (!_subCache.baseline.length) {
        _subCache.baseline = generateDemoBaseline(_subCache.items, document.getElementById('subDocType').value);
    }
    _subCache.meta = {
        program: document.getElementById('subProgram').value === 'CUSTOM' ? (document.getElementById('subCustomPlatform').value || 'Custom Platform') : document.getElementById('subProgram').value,
        branch: document.getElementById('subBranch').value,
        docType: document.getElementById('subDocType').value === 'CUSTOM' ? (document.getElementById('subCustomDocType').value || 'Custom Type') : document.getElementById('subDocType').value,
        vendor: document.getElementById('subVendor').value || 'Unknown Vendor',
        contractRef: document.getElementById('subContractRef').value || '',
        notes: document.getElementById('subNotes').value || '',
        timestamp: new Date().toISOString()
    };
    runDiscrepancyEngine();
}

function runDiscrepancyEngine() {
    const items = _subCache.items;
    const baseline = _subCache.baseline;
    const discrepancies = [];
    const idKey = items[0] && items[0].partNumber ? 'partNumber' : items[0] && items[0].nsn ? 'nsn' : items[0] && items[0].drawingNumber ? 'drawingNumber' : items[0] && items[0].uid ? 'uid' : items[0] && items[0].lineItem ? 'lineItem' : Object.keys(items[0]||{})[0] || 'id';

    const baselineMap = {};
    baseline.forEach(b => { baselineMap[b[idKey]] = b; });
    const currentMap = {};
    items.forEach(it => { currentMap[it[idKey]] = it; });

    // Check each current item against baseline
    items.forEach(item => {
        const prev = baselineMap[item[idKey]];
        if (!prev) {
            // NEW item not in baseline
            discrepancies.push({
                severity: 'info', category: 'New Component', item: item[idKey],
                field: 'N/A', issue: 'New item not in previous submission',
                previous: '(not present)', current: item.nomenclature || item[idKey],
                impact: item.unitPrice ? '$' + (+item.unitPrice * (item.qty||1)).toFixed(2) + ' added cost' : 'Review required',
                _type: 'new'
            });
            return;
        }
        // Compare fields
        Object.keys(item).forEach(field => {
            if (field.startsWith('_') || field === idKey) return;
            const curVal = String(item[field] || '');
            const prevVal = String(prev[field] || '');
            if (curVal !== prevVal && prevVal) {
                let severity = 'info';
                let impact = '';
                let cat = 'Data Change';

                if (field === 'unitPrice' || field === 'totalPrice' || field === 'acquisitionCost') {
                    const pctChange = prev[field] > 0 ? ((+item[field] - +prev[field]) / +prev[field] * 100) : 0;
                    if (pctChange > 25) { severity = 'critical'; cat = 'Cost Increase'; impact = '+' + pctChange.toFixed(1) + '% ($' + (+item[field] - +prev[field]).toFixed(2) + ' increase)'; }
                    else if (pctChange > 10) { severity = 'warning'; cat = 'Cost Change'; impact = '+' + pctChange.toFixed(1) + '% increase'; }
                    else if (pctChange < -20) { severity = 'warning'; cat = 'Cost Decrease'; impact = pctChange.toFixed(1) + '% (verify accuracy)'; }
                    else { cat = 'Cost Adjustment'; impact = pctChange.toFixed(1) + '% change'; }
                } else if (field === 'source' || field === 'vendor' || field === 'make_buy') {
                    severity = 'warning'; cat = 'Source Change'; impact = 'Vendor/source verification needed';
                } else if (field === 'cageCode') {
                    severity = 'warning'; cat = 'CAGE Code Change'; impact = 'Verify manufacturer identity';
                } else if (field === 'status') {
                    if (curVal === 'Obsolete' || curVal === 'DMSMS Watch') { severity = 'critical'; cat = 'Obsolescence'; impact = 'DMSMS action required'; }
                    else { severity = 'info'; cat = 'Status Change'; impact = 'Review status transition'; }
                } else if (field === 'qty') {
                    const qtyDelta = (+item[field]) - (+prev[field]);
                    if (Math.abs(qtyDelta) > 10) { severity = 'warning'; cat = 'Quantity Change'; impact = (qtyDelta>0?'+':'') + qtyDelta + ' units'; }
                    else { cat = 'Quantity Change'; impact = (qtyDelta>0?'+':'') + qtyDelta + ' units'; }
                } else if (field === 'leadTime') {
                    const curDays = parseInt(curVal) || 0;
                    const prevDays = parseInt(prevVal) || 0;
                    if (curDays > prevDays + 30) { severity = 'warning'; cat = 'Lead Time Increase'; impact = '+' + (curDays-prevDays) + ' days delay risk'; }
                    else { cat = 'Lead Time Change'; }
                } else if (field === 'revision') {
                    cat = 'Revision Change'; severity = 'info'; impact = 'Verify change documentation';
                } else if (field === 'serialNumber' || field === 'uid') {
                    severity = 'warning'; cat = 'Identity Change'; impact = 'IUID traceability verification needed';
                }

                if (severity !== 'info' || Math.random() < 0.5) { // Don't flood with minor changes
                    discrepancies.push({
                        severity, category: cat, item: item[idKey],
                        field, issue: field + ' changed',
                        previous: prevVal, current: curVal, impact, _type: 'change'
                    });
                }
            }
        });
    });

    // Check for REMOVED items (in baseline but not in current)
    baseline.forEach(b => {
        if (!currentMap[b[idKey]]) {
            discrepancies.push({
                severity: 'critical', category: 'Removed Component', item: b[idKey],
                field: 'N/A', issue: 'Item removed from submission — was in previous version',
                previous: b.nomenclature || b[idKey], current: '(removed)',
                impact: b.unitPrice ? 'Lost coverage — $' + (+b.unitPrice * (b.qty||1)).toFixed(2) + ' in spares no longer listed' : 'Coverage gap — verify intentional removal',
                _type: 'removed'
            });
        }
    });

    // Sort: critical first, then warning, then info
    const sevOrder = {critical:0, warning:1, info:2};
    discrepancies.sort((a,b) => (sevOrder[a.severity]||3) - (sevOrder[b.severity]||3));

    _subCache.discrepancies = discrepancies;

    // Update stats
    const newItems = discrepancies.filter(d => d._type === 'new').length;
    const removedItems = discrepancies.filter(d => d._type === 'removed').length;
    const costIssues = discrepancies.filter(d => d.category.includes('Cost')).length;
    const criticals = discrepancies.filter(d => d.severity === 'critical').length;
    let totalCostDelta = 0;
    items.forEach(it => {
        const prev = baselineMap[it[idKey]];
        if (prev && it.unitPrice && prev.unitPrice) {
            totalCostDelta += ((+it.unitPrice * (it.qty||1)) - (+prev.unitPrice * (prev.qty||1)));
        }
        if (!prev && it.unitPrice) totalCostDelta += (+it.unitPrice * (it.qty||1));
    });

    document.getElementById('subTotalItems').textContent = items.length;
    document.getElementById('subNewItems').textContent = newItems;
    document.getElementById('subRemovedItems').textContent = removedItems;
    document.getElementById('subCostDelta').textContent = (totalCostDelta >= 0 ? '+$' : '-$') + Math.abs(totalCostDelta).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',');
    document.getElementById('subDiscrepancies').textContent = discrepancies.length;
    document.getElementById('subRedFlags').textContent = criticals;

    renderDiscrepancyTable(discrepancies);
    generateAiSummary(discrepancies, items, baseline, totalCostDelta);

    // Save to history
    const histEntry = {
        timestamp: new Date().toISOString(),
        meta: _subCache.meta,
        stats: { total: items.length, newItems, removedItems, discrepancies: discrepancies.length, criticals, costDelta: totalCostDelta },
        hash: ''
    };
    sha256(JSON.stringify(histEntry)).then(h => {
        histEntry.hash = h;
        _subHistory.unshift(histEntry);
        if (_subHistory.length > 50) _subHistory = _subHistory.slice(0, 50);
        localStorage.setItem('s4_submission_history', JSON.stringify(_subHistory));
        loadSubmissionHistory();
    });

    showWorkspaceNotification('Analysis complete: ' + discrepancies.length + ' discrepancies found (' + criticals + ' critical)');
}

function renderDiscrepancyTable(discrepancies) {
    const filtered = _subFilter === 'all' ? discrepancies :
        _subFilter === 'critical' ? discrepancies.filter(d=>d.severity==='critical') :
        _subFilter === 'warning' ? discrepancies.filter(d=>d.severity==='warning') :
        _subFilter === 'info' ? discrepancies.filter(d=>d.severity==='info') :
        _subFilter === 'new' ? discrepancies.filter(d=>d._type==='new') :
        _subFilter === 'cost' ? discrepancies.filter(d=>d.category.includes('Cost')) : discrepancies;

    const tbody = document.getElementById('subDiscrepancyTable');
    const sevColors = {critical:'#ff4444', warning:'#ffa500', info:'#00aaff'};
    const sevIcons = {critical:'fa-circle-xmark', warning:'fa-triangle-exclamation', info:'fa-circle-info'};

    tbody.innerHTML = filtered.map(d => '<tr style="border-color:var(--border)">' +
        '<td style="padding:5px 8px;border-color:var(--border);white-space:nowrap"><i class="fas ' + (sevIcons[d.severity]||'fa-circle') + '" style="color:' + (sevColors[d.severity]||'#888') + ';margin-right:4px"></i><span style="color:' + (sevColors[d.severity]||'#888') + ';font-weight:600;text-transform:uppercase;font-size:.7rem">' + d.severity + '</span></td>' +
        '<td style="padding:5px 8px;border-color:var(--border);color:#fff">' + d.category + '</td>' +
        '<td style="padding:5px 8px;border-color:var(--border);font-family:monospace;font-size:.75rem">' + d.item + '</td>' +
        '<td style="padding:5px 8px;border-color:var(--border)">' + d.issue + '</td>' +
        '<td style="padding:5px 8px;border-color:var(--border);color:#888">' + d.previous + '</td>' +
        '<td style="padding:5px 8px;border-color:var(--border);color:#fff">' + d.current + '</td>' +
        '<td style="padding:5px 8px;border-color:var(--border);color:' + (sevColors[d.severity]||'#888') + '">' + (d.impact||'') + '</td>' +
    '</tr>').join('');

    document.getElementById('subResultsContainer').style.display = 'block';
}

function filterDiscrepancies(filter) {
    _subFilter = filter;
    renderDiscrepancyTable(_subCache.discrepancies);
}

function generateAiSummary(discrepancies, items, baseline, costDelta) {
    const criticals = discrepancies.filter(d => d.severity === 'critical');
    const warnings = discrepancies.filter(d => d.severity === 'warning');
    const newItems = discrepancies.filter(d => d._type === 'new');
    const removed = discrepancies.filter(d => d._type === 'removed');
    const costChanges = discrepancies.filter(d => d.category.includes('Cost'));
    const meta = _subCache.meta;

    let summary = '<p><strong>Program:</strong> ' + meta.program + ' | <strong>Branch:</strong> ' + meta.branch + ' | <strong>Document:</strong> ' + (SUBMISSION_TYPES[meta.docType]||meta.docType) + '</p>';
    summary += '<p><strong>Submission from:</strong> ' + (meta.vendor||'Unknown') + ' | <strong>Analyzed:</strong> ' + new Date().toLocaleString() + '</p><hr style="border-color:var(--border);margin:8px 0">';

    if (criticals.length) {
        summary += '<p style="color:#ff4444"><strong>CRITICAL FINDINGS (' + criticals.length + '):</strong></p><ul style="margin:4px 0 8px 16px">';
        criticals.slice(0, 8).forEach(c => { summary += '<li>' + c.category + ': ' + c.item + ' — ' + c.issue + (c.impact ? ' (' + c.impact + ')' : '') + '</li>'; });
        if (criticals.length > 8) summary += '<li>...and ' + (criticals.length - 8) + ' more critical findings</li>';
        summary += '</ul>';
    }
    if (removed.length) {
        summary += '<p style="color:#ff6b6b"><strong>REMOVED COMPONENTS (' + removed.length + '):</strong> Items present in the previous submission are no longer listed. Verify each removal was intentional and that coverage gaps are addressed.</p>';
    }
    if (newItems.length) {
        summary += '<p style="color:#14f195"><strong>NEW COMPONENTS (' + newItems.length + '):</strong> Items added that were not in the previous submission. Verify specifications, pricing, and compatibility.</p>';
    }
    if (costChanges.length) {
        summary += '<p style="color:#c9a84c"><strong>COST IMPACT:</strong> Net cost delta of <strong>' + (costDelta >= 0 ? '+$' : '-$') + Math.abs(costDelta).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g,',') + '</strong> across ' + costChanges.length + ' line items with price changes.</p>';
    }

    summary += '<p style="margin-top:8px"><strong>RECOMMENDATION:</strong> ';
    if (criticals.length > 3) summary += 'This submission requires immediate leadership review. Multiple critical discrepancies detected that could impact program readiness, cost, and schedule.';
    else if (criticals.length > 0) summary += 'Review critical findings with program office before acceptance. Flag cost increases for contracting officer review.';
    else if (warnings.length > 5) summary += 'Multiple warnings detected. Recommend detailed technical review before acceptance.';
    else summary += 'No critical issues detected. Standard review and acceptance procedures apply.';
    summary += '</p>';

    document.getElementById('subAiSummary').style.display = 'block';
    document.getElementById('subAiSummaryText').innerHTML = summary;
}

async function anchorSubmissionReview() {
    if (!_subCache.discrepancies.length) { showWorkspaceNotification('Run an analysis first before anchoring'); return; }
    const meta = _subCache.meta;
    const docTypeLabel = SUBMISSION_TYPES[meta.docType] || meta.docType;
    const text = 'ILIE Analysis | Program: ' + meta.program + ' | Branch: ' + meta.branch +
        ' | Type: ' + docTypeLabel + ' | Vendor: ' + (meta.vendor||'N/A') +
        ' | Items: ' + _subCache.items.length + ' | Discrepancies: ' + _subCache.discrepancies.length +
        ' | Critical: ' + _subCache.discrepancies.filter(d=>d.severity==='critical').length +
        ' | Date: ' + new Date().toISOString();
    const hash = await sha256(text);
    showAnchorAnimation(hash, 'ILIE Analysis — ' + docTypeLabel, 'CUI');
    const txHash = 'TX' + Date.now().toString(16).toUpperCase();
    stats.anchored++; stats.types.add('SUBMISSION_REVIEW'); stats.slsFees += 0.01; updateStats(); saveStats();
    const rec = {hash, type:'SUBMISSION_REVIEW', branch:meta.branch, timestamp:new Date().toISOString(), label:'ILIE Analysis: ' + docTypeLabel, txHash};
    sessionRecords.push(rec);
    saveLocalRecord({hash, record_type:'SUBMISSION_REVIEW', record_label:'ILIE Analysis: ' + docTypeLabel, branch:meta.branch, timestamp:new Date().toISOString(), timestamp_display:new Date().toISOString().replace('T',' ').substring(0,19)+' UTC', fee:0.01, tx_hash:txHash, system:'ILIE'});
    updateTxLog();
    addToVault({hash, txHash, type:'SUBMISSION_REVIEW', label:'ILIE Analysis: ' + docTypeLabel, branch:meta.branch, content:text.substring(0,100), encrypted:false, timestamp:new Date().toISOString(), source:'ILIE', fee:0.01});
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'SUBMISSION_REVIEW', tx_hash:txHash, content_preview:text.substring(0,100)})}); } catch(e) {}
    setTimeout(() => { document.getElementById('animStatus').textContent = 'ILIE analysis anchored — ' + _subCache.discrepancies.length + ' discrepancies recorded on-chain'; document.getElementById('animStatus').style.color = '#14f195'; }, 2200);
}

function exportDiscrepancyReport() {
    if (!_subCache.discrepancies.length) { showWorkspaceNotification('No discrepancy report to export'); return; }
    const meta = _subCache.meta;
    let csv = 'Severity,Category,Item/Part,Field,Issue,Previous Value,Current Value,Impact\n';
    _subCache.discrepancies.forEach(d => {
        csv += '"' + d.severity + '","' + d.category + '","' + d.item + '","' + (d.field||'') + '","' + d.issue + '","' + d.previous + '","' + d.current + '","' + (d.impact||'') + '"\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'Discrepancy_Report_' + (meta.program||'Program') + '_' + (meta.docType||'Review') + '_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    showWorkspaceNotification('Discrepancy report exported — ' + _subCache.discrepancies.length + ' findings');
}

function loadSubmissionHistory() {
    const container = document.getElementById('subHistory');
    if (!container) return;
    if (!_subHistory.length) {
        container.innerHTML = '<div style="color:var(--steel);font-size:.8rem;padding:8px">No submission reviews yet. Run an analysis to start building history.</div>';
        return;
    }
    container.innerHTML = _subHistory.slice(0, 20).map(h => {
        const sevColor = h.stats.criticals > 3 ? '#ff4444' : h.stats.criticals > 0 ? '#ffa500' : '#14f195';
        return '<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 8px;border-bottom:1px solid var(--border);font-size:.78rem">' +
            '<div><span style="color:#fff;font-weight:600">' + (SUBMISSION_TYPES[h.meta.docType]||h.meta.docType) + '</span> <span style="color:var(--steel)">— ' + h.meta.program + ' (' + h.meta.branch + ')</span></div>' +
            '<div style="display:flex;gap:12px;align-items:center">' +
                '<span style="color:' + sevColor + ';font-weight:600">' + h.stats.discrepancies + ' disc. / ' + h.stats.criticals + ' crit.</span>' +
                '<span style="color:var(--steel);font-size:.72rem">' + new Date(h.timestamp).toLocaleDateString() + '</span>' +
                '<span style="color:var(--steel);font-family:monospace;font-size:.68rem" title="' + h.hash + '">' + (h.hash||'').substring(0,8) + '...</span>' +
            '</div>' +
        '</div>';
    }).join('');
}

function clearSubmissionReview() {
    _subCache = { items:[], discrepancies:[], baseline:[], meta:{} };
    _subFilter = 'all';
    document.getElementById('subTotalItems').textContent = '0';
    document.getElementById('subNewItems').textContent = '0';
    document.getElementById('subRemovedItems').textContent = '0';
    document.getElementById('subCostDelta').textContent = '$0';
    document.getElementById('subDiscrepancies').textContent = '0';
    document.getElementById('subRedFlags').textContent = '0';
    document.getElementById('subDiscrepancyTable').innerHTML = '';
    document.getElementById('subResultsContainer').style.display = 'none';
    document.getElementById('subAiSummary').style.display = 'none';
    document.getElementById('subUploadZone').innerHTML = '<i class="fas fa-cloud-upload-alt" style="font-size:2rem;color:#e06c75;margin-bottom:8px;display:block"></i><div style="color:#e06c75;font-weight:600;font-size:.9rem">Upload Submission Data</div><div style="color:var(--steel);font-size:.78rem;margin-top:4px">CSV, Excel (.xlsx), XML, JSON, PDF, or paste data below</div><div style="color:var(--steel);font-size:.72rem;margin-top:2px">Drag & drop or click to browse</div>';
    document.getElementById('subVendor').value = '';
    document.getElementById('subCustomPlatform').value = '';
    document.getElementById('subCustomDocType').value = '';
    document.getElementById('subContractRef').value = '';
    document.getElementById('subNotes').value = '';
    document.getElementById('subPasteData').value = '';
    showWorkspaceNotification('Submission review cleared');
}

// ── Workspace initialization ──
function initHub() {
    setTimeout(() => {
        renderHubActions();
        // Initialize vault badge
        const vaultBadge = document.querySelector('[data-panel="hub-vault"] .notif-badge, [onclick*="hub-vault"] .notif-badge');
        if (s4Vault.length > 0 && vaultBadge) vaultBadge.textContent = s4Vault.length;
    }, 500);
}

document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    renderTypeGrid();
    loadSample('supply');
    initILSEngine();
    // Restore action items from localStorage
    renderHubActions();
    updateNotifBadge();
    // Initialize workspace
    initHub();
    // Set default calendar date
    const calDate = document.getElementById('calEventDate');
    if (calDate) calDate.value = new Date().toISOString().split('T')[0];
    // Show/hide floating AI agent based on active tab
    const aiWrapper = document.getElementById('aiFloatWrapper');
    if (aiWrapper) aiWrapper.style.display = 'none';
    document.querySelectorAll('[data-bs-toggle="pill"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', e => {
            const target = e.target.getAttribute('href');
            if (aiWrapper) aiWrapper.style.display = (target === '#tabILS') ? 'flex' : 'none';
        });
    });
});

</script>
<script src="../s4-assets/s4-background.js"></script>

<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" style="position:fixed;bottom:30px;left:30px;width:45px;height:45px;background:linear-gradient(135deg,#00aaff,#c9a84c);border:none;border-radius:50%;color:#fff;font-size:1.3rem;cursor:pointer;opacity:0;visibility:hidden;transition:all 0.3s;z-index:999;display:flex;align-items:center;justify-content:center;">&uarr;</button>
<script>
// Scroll progress bar
window.addEventListener('scroll', function() {
    var scroll = window.scrollY;
    var height = document.documentElement.scrollHeight - window.innerHeight;
    var bar = document.getElementById('scrollProgress');
    if (bar) bar.style.width = (height > 0 ? (scroll / height * 100) : 0) + '%';
    var btn = document.getElementById('backToTop');
    if (btn) { if (scroll > 400) { btn.style.opacity='1'; btn.style.visibility='visible'; } else { btn.style.opacity='0'; btn.style.visibility='hidden'; } }
});
// Reveal on scroll
var revealObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) { if (entry.isIntersecting) entry.target.classList.add('visible'); });
}, { threshold: 0.1 });
document.querySelectorAll('.reveal-demo').forEach(function(el) { revealObserver.observe(el); });
</script>
</body>
</html>
