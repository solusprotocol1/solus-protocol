<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="S4 Ledger Defense Logistics Demo — Anchor, verify, and track defense records across all military branches on XRPL.">
    <title>S4 Ledger | Defense Logistics Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root{--bg:#050810;--surface:#0a1020;--card:#0f1630;--border:#1a2550;--accent:#00aaff;--gold:#c9a84c;--steel:#8ea4b8;--green:#14f195;--red:#ff6b6b;--text:#e0e8f0;--muted:#6b7d93}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .navbar-custom{background:rgba(5,8,16,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:10px 0;position:fixed;top:0;width:100%;z-index:1000}
        .navbar-brand{font-weight:700;display:flex;align-items:center;gap:10px;text-decoration:none}
        .brand-text{background:linear-gradient(135deg,#00aaff,#ffffff,#c9a84c);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:brandGradient 4s ease infinite;font-size:1.2rem;letter-spacing:0.5px}
        .nav-link{color:#fff!important;padding:8px 12px!important;font-size:0.9rem!important;font-weight:500;transition:color 0.2s}
        .nav-link:hover,.nav-link.active{color:var(--accent)!important}
        .hero{padding:7.5rem 0 3rem;text-align:center;background:linear-gradient(180deg,rgba(0,170,255,0.05) 0%,transparent 60%)}
        .hero h1{font-size:2.4rem;font-weight:800;margin-bottom:0.75rem}.hero h1 .accent{color:var(--accent)}.hero h1 .gold{color:var(--gold)}
        .hero p{color:var(--steel);font-size:1.1rem;max-width:700px;margin:0 auto 1.5rem}
        .badge-live{display:inline-flex;align-items:center;gap:6px;background:rgba(20,241,149,0.1);border:1px solid rgba(20,241,149,0.3);color:var(--green);padding:6px 16px;border-radius:20px;font-size:0.85rem;font-weight:600}
        .badge-live::before{content:'';width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .tab-section{padding:2rem 0}
        .nav-pills .nav-link{background:var(--card);color:var(--steel)!important;border:1px solid var(--border);margin-right:0.5rem;margin-bottom:0.5rem;border-radius:8px;font-weight:600;padding:0.6rem 1.2rem;transition:all 0.2s}
        .nav-pills .nav-link:hover{color:var(--accent)!important}
        .nav-pills .nav-link.active{background:linear-gradient(135deg,#00aaff,#0088cc)!important;color:#fff!important;border-color:transparent!important;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
        .tab-content{margin-top:1.5rem}
        .demo-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
        .demo-card h3{font-size:1.1rem;font-weight:700;color:var(--accent);margin-bottom:1rem}
        .demo-card h3 i{margin-right:0.5rem}
        label{font-weight:600;color:var(--steel);margin-bottom:0.4rem;font-size:0.9rem}
        select,input,textarea{background:var(--surface)!important;color:var(--text)!important;border:1px solid var(--border)!important;border-radius:8px!important;padding:0.6rem 0.8rem!important;font-family:'Plus Jakarta Sans',sans-serif!important;font-size:0.95rem!important;width:100%}
        select:focus,input:focus,textarea:focus{border-color:var(--accent)!important;box-shadow:0 0 0 3px rgba(0,170,255,0.15)!important;outline:none}
        textarea{min-height:120px;resize:vertical;font-family:'Courier New',monospace!important;font-size:0.85rem!important}
        .btn-accent{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:0.65rem 1.5rem;font-weight:700;font-size:0.95rem;transition:all 0.2s;cursor:pointer}
        .btn-accent:hover{background:#0099ee;transform:translateY(-1px);color:#fff}
        .btn-accent:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-gold{background:var(--gold);color:#000;border:none;border-radius:8px;padding:0.65rem 1.5rem;font-weight:700;font-size:0.95rem;cursor:pointer}
        .btn-gold:hover{background:#dbb85c;color:#000}
        .result-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.2rem;margin-top:1rem;display:none;font-family:'Courier New',monospace;font-size:0.85rem}
        .result-panel.show{display:block;animation:fadeIn 0.3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .result-label{color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.3rem}
        .result-value{color:var(--green);word-break:break-all}
        .result-value.error{color:var(--red)}
        .hash-display{background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.2);border-radius:6px;padding:0.6rem;word-break:break-all;color:var(--accent);margin:0.5rem 0}
        .branch-tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
        .branch-tab{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:0.82rem;font-weight:600;cursor:pointer;color:var(--steel);transition:all 0.2s;font-family:inherit}
        .branch-tab:hover{border-color:var(--accent);color:var(--accent)}
        .branch-tab.active{background:linear-gradient(135deg,#00aaff,#0088cc);border-color:transparent;color:#fff!important;box-shadow:0 2px 10px rgba(0,170,255,0.3)}
        .record-type-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:0.6rem;margin-bottom:1rem;max-height:280px;overflow-y:auto;padding-right:4px}
        .record-type-btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.7rem;cursor:pointer;text-align:center;transition:all 0.2s;font-size:0.78rem;font-weight:600}
        .record-type-btn:hover{border-color:var(--accent);background:rgba(0,170,255,0.05)}
        .record-type-btn.selected{border-color:var(--accent);background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
        .record-type-btn .icon{font-size:1.2rem;display:block;margin-bottom:0.2rem}
        .type-search{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:0.85rem;color:var(--text);width:100%;margin-bottom:8px;font-family:inherit}
        .type-search:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 2px rgba(0,170,255,0.15)}
        .type-search::placeholder{color:var(--muted)}
        .tx-log{max-height:400px;overflow-y:auto}
        .tx-entry{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem 1rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:1rem;transition:all 0.2s}
        .tx-entry:hover{border-color:var(--accent)}
        .tx-icon{font-size:1.4rem;min-width:36px;text-align:center}
        .tx-info{flex:1}.tx-type{font-weight:700;font-size:0.9rem}.tx-hash{font-family:monospace;color:var(--muted);font-size:0.75rem}
        .tx-time{color:var(--muted);font-size:0.75rem;white-space:nowrap}
        .tx-badge{font-size:0.7rem;font-weight:700;padding:2px 8px;border-radius:4px}
        .tx-badge.anchored{background:rgba(20,241,149,0.15);color:var(--green)}
        .stat-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;text-align:center}
        .stat-value{font-size:2rem;font-weight:800;color:var(--accent)}.stat-label{font-size:0.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
        footer{border-top:1px solid var(--border);padding:2rem 0;margin-top:3rem;text-align:center;color:var(--muted);font-size:0.85rem}
        footer a{color:var(--accent);text-decoration:none}
        .sample-btn{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.8rem;color:var(--steel);transition:all 0.2s;display:inline-block;margin:0.2rem}
        .sample-btn:hover{border-color:var(--gold);color:var(--gold)}
        #particles-js{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;pointer-events:none}
        .mesh-overlay{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
        .g-orb{position:absolute;border-radius:50%;filter:blur(120px);opacity:0.15}
        .g-orb-1{width:600px;height:600px;background:#003366;top:-200px;right:-200px}
        .g-orb-2{width:400px;height:400px;background:#001a33;bottom:-100px;left:-100px}
        .g-orb-3{width:300px;height:300px;background:linear-gradient(135deg,#00aaff,#003366);top:50%;left:50%;transform:translate(-50%,-50%)}
        .anchor-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,16,0.94);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity 0.4s}
        .anchor-overlay.active{opacity:1;pointer-events:all}
        .anchor-anim-box{text-align:center;max-width:500px;padding:2rem}
        .chain-segment{width:3px;height:0;background:linear-gradient(to bottom,#00aaff,rgba(0,170,255,0.2));margin:0 auto;animation:chainGrow 0.5s ease-out 0.15s forwards}
        @keyframes chainGrow{to{height:50px}}
        .anchor-drop-icon{font-size:5rem;color:var(--accent);animation:anchorDrop 1.2s ease-in-out;filter:drop-shadow(0 0 25px rgba(0,170,255,0.5))}
        @keyframes anchorDrop{0%{transform:translateY(-80px) scale(0.5);opacity:0}40%{transform:translateY(10px) scale(1.15);opacity:1}60%{transform:translateY(-8px) scale(0.95)}80%{transform:translateY(3px) scale(1.02)}100%{transform:translateY(0) scale(1)}}
        .anim-status{font-size:1.15rem;font-weight:700;color:var(--accent);margin-top:1rem;animation:fadeUp 0.5s ease-out 0.5s both}
        .anim-hash{font-family:monospace;color:var(--accent);font-size:0.8rem;margin-top:0.8rem;word-break:break-all;opacity:0;animation:fadeUp 0.5s ease-out 1s both;background:rgba(0,170,255,0.08);padding:10px;border-radius:8px;border:1px solid rgba(0,170,255,0.2)}
        .anim-fee{font-size:0.9rem;color:var(--gold);margin-top:0.5rem;opacity:0;animation:fadeUp 0.5s ease-out 1.3s both}
        .anim-success{font-size:1.3rem;font-weight:800;color:var(--green);margin-top:1rem;opacity:0;animation:scaleIn 0.4s ease-out 2s both}
        @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes scaleIn{from{opacity:0;transform:scale(0)}to{opacity:1;transform:scale(1)}}
        .branch-count{font-size:0.8rem;color:var(--muted);margin-bottom:6px}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        @media(max-width:768px){.hero h1{font-size:1.6rem}.record-type-grid{grid-template-columns:repeat(2,1fr)}.branch-tabs{gap:4px}.branch-tab{font-size:0.75rem;padding:5px 10px}}

        @keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
        @keyframes brandGradient{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
        .scroll-progress{position:fixed;top:0;left:0;width:0%;height:3px;background:linear-gradient(90deg,#00aaff,#c9a84c);z-index:10000;transition:width 0.1s linear;box-shadow:0 0 10px #00aaff}
        .reveal-demo{opacity:0;transform:translateY(25px);transition:all 0.5s ease-out}
        .reveal-demo.visible{opacity:1;transform:translateY(0)}
        .gradient-text{background:linear-gradient(90deg,#00aaff,#ffffff,#c9a84c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .nav-logo{height:32px;width:32px;margin-right:8px;vertical-align:middle;animation:logoFloat 3s ease-in-out infinite}
        .footer-logo{height:28px;width:28px;margin-right:8px;vertical-align:middle;animation:logoFloat 4s ease-in-out infinite}
        .dropdown-menu{border-radius:10px;padding:8px 0;min-width:160px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
        .dropdown-item{padding:8px 18px;font-size:0.88rem;transition:background 0.2s,color 0.2s}
        .dropdown-item:hover,.dropdown-item:focus{background:rgba(0,170,255,0.12);color:var(--accent)!important}
        .copy-btn{background:rgba(0,170,255,0.15);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:6px;padding:4px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit;transition:all 0.2s;margin-left:8px}
        .copy-btn:hover{background:rgba(0,170,255,0.3);color:#fff}
        .clf-banner{display:none;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;margin:10px 0;font-size:0.88rem;font-weight:600;animation:fadeIn 0.25s ease-out}
        .clf-banner.show{display:flex}
        .clf-badge{padding:3px 12px;border-radius:6px;font-size:0.78rem;font-weight:800;letter-spacing:0.5px;text-transform:uppercase}
        .clf-U .clf-badge{background:rgba(0,170,0,0.15);color:#00cc66;border:1px solid rgba(0,170,0,0.3)}
        .clf-CUI .clf-badge{background:rgba(201,168,76,0.15);color:#c9a84c;border:1px solid rgba(201,168,76,0.3)}
        .clf-SECRET .clf-badge{background:rgba(255,50,50,0.15);color:#ff5555;border:1px solid rgba(255,50,50,0.3)}
        .clf-TS .clf-badge{background:rgba(255,165,0,0.15);color:#ffa500;border:1px solid rgba(255,165,0,0.35)}
        .clf-U{background:rgba(0,170,0,0.04);border:1px solid rgba(0,170,0,0.15)}
        .clf-CUI{background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15)}
        .clf-SECRET{background:rgba(255,50,50,0.04);border:1px solid rgba(255,50,50,0.15)}
        .clf-TS{background:rgba(255,165,0,0.04);border:1px solid rgba(255,165,0,0.15)}
        .clf-text{font-size:0.82rem;color:var(--steel);font-weight:400}
        .clf-icon{font-size:1.1rem}
        .ils-dropzone{border:2px dashed var(--border);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:all 0.3s;background:rgba(0,170,255,0.02);margin-bottom:1rem}
        .ils-dropzone:hover,.ils-dropzone.dragover{border-color:var(--accent);background:rgba(0,170,255,0.06)}
        .ils-dropzone i{font-size:2rem;color:var(--accent);margin-bottom:0.5rem;display:block}
        .ils-file-list{margin-bottom:1rem}
        .ils-file-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:0.85rem}
        .ils-file-item .file-info{display:flex;align-items:center;gap:8px}
        .ils-file-item .file-stats{color:var(--accent);font-size:0.78rem;font-weight:600}
        .ils-file-item .file-remove{color:var(--red);cursor:pointer;font-size:0.8rem;padding:2px 8px;border-radius:4px;transition:background 0.2s}
        .ils-file-item .file-remove:hover{background:rgba(255,107,107,0.15)}
        .ils-coverage-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.85rem}
        .ils-coverage-bar{flex:1;background:var(--surface);border-radius:4px;height:8px;overflow:hidden;border:1px solid var(--border)}
        .ils-coverage-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
        .ils-action-item{padding:12px;background:var(--surface);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--accent);font-size:0.85rem}
        .ils-action-item.critical{border-left-color:var(--red)}
        .ils-action-item.warning{border-left-color:#ffa500}
        .ils-action-item .action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .ils-action-item .action-title{font-weight:700;color:#fff}
        .ils-action-item .action-owner{font-size:0.78rem;padding:2px 8px;border-radius:4px;background:rgba(0,170,255,0.1);color:var(--accent)}
        .ils-action-item .action-detail{color:var(--steel);font-size:0.82rem}
        @media(max-width:991px){.navbar-collapse{background:rgba(5,8,16,0.98);padding:15px;border-radius:12px;margin-top:10px;border:1px solid var(--border);max-height:85vh;overflow-y:auto}.navbar-nav{gap:5px}.nav-link{padding:10px 15px!important;border-radius:8px}.nav-link:hover{background:rgba(0,170,255,0.1)}}
        /* AI Agent Chat */
        .ai-chat-container{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;height:420px}
        .ai-chat-header{background:linear-gradient(135deg,rgba(0,170,255,0.15),rgba(201,168,76,0.1));padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
        .ai-chat-header .ai-dot{width:10px;height:10px;background:#14f195;border-radius:50%;animation:pulse 2s infinite}
        .ai-chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;font-size:0.85rem}
        .ai-msg{padding:10px 14px;border-radius:12px;max-width:90%;line-height:1.5;animation:fadeIn 0.3s ease}
        .ai-msg.bot{background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.15);align-self:flex-start;color:var(--steel)}
        .ai-msg.user{background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.2);align-self:flex-end;color:#fff}
        .ai-msg .ai-label{font-size:0.7rem;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
        .ai-chat-input{display:flex;gap:8px;padding:10px 12px;border-top:1px solid var(--border);background:var(--card)}
        .ai-chat-input input{flex:1;background:var(--surface)!important;border:1px solid var(--border)!important;border-radius:8px!important;padding:8px 12px!important;color:var(--text)!important;font-size:0.85rem!important;font-family:inherit!important}
        .ai-chat-input button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:0.85rem;font-weight:600;cursor:pointer;white-space:nowrap}
        .ai-chat-input button:hover{background:#0099ee}
        .ai-quick-btns{display:flex;flex-wrap:wrap;gap:4px;padding:6px 12px;background:var(--card);border-top:1px solid rgba(255,255,255,0.03)}
        .ai-quick-btn{background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.15);color:var(--accent);border-radius:16px;padding:4px 10px;font-size:0.72rem;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .ai-quick-btn:hover{background:rgba(0,170,255,0.15);border-color:var(--accent)}
        /* Post-Analysis Actions */
        .post-actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;padding-top:12px;border-top:1px dashed var(--border)}
        .post-action-btn{display:inline-flex;align-items:center;gap:6px;background:rgba(0,170,255,0.06);border:1px solid rgba(0,170,255,0.2);color:var(--steel);border-radius:8px;padding:8px 14px;font-size:0.8rem;font-weight:600;cursor:pointer;font-family:inherit;transition:all 0.2s}
        .post-action-btn:hover{background:rgba(0,170,255,0.14);color:var(--accent);border-color:var(--accent)}
        .post-action-btn i{font-size:0.85rem;color:var(--accent)}
        /* Sample Package Modal */
        .sample-pkg-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:10px 0;max-height:200px;overflow-y:auto}
        .sample-pkg-item{display:flex;align-items:center;gap:6px;padding:6px 10px;background:rgba(0,170,255,0.04);border:1px solid rgba(0,170,255,0.1);border-radius:6px;font-size:0.78rem;color:var(--steel);cursor:default}
        .sample-pkg-item i{color:var(--accent);font-size:0.75rem;min-width:14px}
        /* Send Modal */
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,16,0.9);display:flex;align-items:center;justify-content:center;z-index:9998;opacity:0;pointer-events:none;transition:opacity 0.3s}
        .modal-overlay.active{opacity:1;pointer-events:all}
        .modal-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:2rem;max-width:480px;width:90%;animation:fadeIn 0.3s ease}
        .modal-box h4{color:var(--accent);margin-bottom:1rem}
        .modal-box .modal-close{position:absolute;top:12px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer}
    </style>
</head>
<body>
<div class="scroll-progress" id="scrollProgress"></div>
<div class="mesh-overlay"><div class="g-orb g-orb-1"></div><div class="g-orb g-orb-2"></div><div class="g-orb g-orb-3"></div></div>
<div id="particles-js"></div>

<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="../"><img src="../s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="nav-logo"><span class="brand-text">S4 Ledger</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><i class="fas fa-bars" style="color:#fff"></i></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="../">Home</a></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Company</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1)"><li><a class="dropdown-item" href="../s4-about/" style="color:#fff">About Us</a></li><li><a class="dropdown-item" href="../s4-investors/" style="color:#fff">Investors</a></li><li><a class="dropdown-item" href="../s4-partners/" style="color:#fff">Partners</a></li></ul></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">Products</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1)"><li><a class="dropdown-item" href="#" style="color:#fff;font-weight:600"><i class="fas fa-play-circle" style="width:18px;margin-right:6px;color:#00aaff"></i>Demo App</a></li><li><a class="dropdown-item" href="../sdk-playground/" style="color:#fff"><i class="fas fa-code" style="width:18px;margin-right:6px;color:#c9a84c"></i>SDK Playground</a></li><li><a class="dropdown-item" href="../metrics.html" style="color:#fff"><i class="fas fa-chart-bar" style="width:18px;margin-right:6px;color:#00aaff"></i>Live Metrics</a></li><li><a class="dropdown-item" href="../transactions.html" style="color:#fff"><i class="fas fa-list" style="width:18px;margin-right:6px;color:#c9a84c"></i>Transactions</a></li><li><a class="dropdown-item" href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:#fff"><i class="fab fa-github" style="width:18px;margin-right:6px"></i>SDK & Docs</a></li></ul></li>
                <li class="nav-item"><a class="nav-link" href="../s4-use-cases/">Use Cases</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-pricing/">Pricing</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-roadmap/">Roadmap</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-faq/">FAQ</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-contact/">Contact</a></li>
            </ul>
        </div>
    </div>
</nav>

<section class="hero">
    <div class="container">
        <h1><i class="fas fa-shield-halved" style="margin-right:12px;color:var(--accent)"></i><span class="gradient-text">Defense Logistics</span> Verification Demo</h1>
        <p>Anchor, verify, and track defense supply chain records across <strong>all military branches</strong> on the XRP Ledger.</p>
        <div class="badge-live">XRPL Testnet Connected &mdash; 160+ Record Types &bull; 9 Branches</div>
    </div>
</section>

<section class="tab-section reveal-demo">
    <div class="container">
        <div class="row mb-4 reveal-demo" id="statsRow">
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statAnchored">0</div><div class="stat-label">Records Anchored</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statVerified">0</div><div class="stat-label">Records Verified</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statTypes">0</div><div class="stat-label">Record Types Used</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statSlsFees">0.000</div><div class="stat-label">$SLS Fees</div></div></div>
        </div>

        <ul class="nav nav-pills mb-2" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tabAnchor" role="tab"><i class="fas fa-anchor"></i> Anchor</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabVerify" role="tab"><i class="fas fa-check-circle"></i> Verify</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabLog" role="tab"><i class="fas fa-list"></i> Transaction Log</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabAbout" role="tab"><i class="fas fa-info-circle"></i> How It Works</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabILS" role="tab"><i class="fas fa-brain"></i> ILS Intelligence</a></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tabAnchor" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-anchor"></i> Anchor a Defense Record</h3>
                            <label>1. Select Military Branch</label>
                            <div class="branch-tabs" id="branchTabs">
                                <button class="branch-tab active" onclick="selectBranch('USN',this)">&#9875; Navy</button>
                                <button class="branch-tab" onclick="selectBranch('USA',this)">&#11088; Army</button>
                                <button class="branch-tab" onclick="selectBranch('USAF',this)">&#9992;&#65039; Air Force</button>
                                <button class="branch-tab" onclick="selectBranch('USMC',this)">&#129413; Marines</button>
                                <button class="branch-tab" onclick="selectBranch('USCG',this)">&#128735;&#65039; Coast Guard</button>
                                <button class="branch-tab" onclick="selectBranch('DLA',this)">&#127963;&#65039; DLA</button>
                                <button class="branch-tab" onclick="selectBranch('JOINT',this)">&#127894;&#65039; Joint</button>
                                <button class="branch-tab" onclick="selectBranch('SOCOM',this)">&#128481;&#65039; SOCOM</button>
                                <button class="branch-tab" onclick="selectBranch('USSF',this)">&#128640; Space Force</button>
                            </div>
                            <label>2. Choose Record Type <span class="branch-count" id="branchTypeCount"></span></label>
                            <input class="type-search" type="text" id="typeSearch" placeholder="Search record types..." oninput="renderTypeGrid()">
                            <div class="record-type-grid" id="recordTypeGrid"></div>

                            <div class="clf-banner" id="clfBanner"><span class="clf-icon"></span><span class="clf-badge" id="clfBadge"></span><span class="clf-text" id="clfText"></span></div>

                            <label>3. Enter Record Content</label>
                            <textarea id="recordInput" placeholder="Paste or type your defense logistics record here..." oninput="this.dataset.autoFilled='false'"></textarea>
                            <div class="mt-2 mb-3">
                                <span style="color:var(--muted);font-size:0.8rem">Try a sample:</span>
                                <span class="sample-btn" onclick="loadSample('supply')">Supply Receipt</span>
                                <span class="sample-btn" onclick="loadSample('maintenance')">3-M Maint</span>
                                <span class="sample-btn" onclick="loadSample('ordnance')">Ordnance Lot</span>
                                <span class="sample-btn" onclick="loadSample('casrep')">CASREP</span>
                                <span class="sample-btn" onclick="loadSample('custody')">Custody Transfer</span>
                                <span class="sample-btn" onclick="loadSample('hand_receipt')">Army Hand Receipt</span>
                                <span class="sample-btn" onclick="loadSample('flight_record')">AF Flight Record</span>
                                <span class="sample-btn" onclick="loadSample('ground_maint')">Marine Ground Maint</span>
                                <span class="sample-btn" onclick="loadSample('cutter')">CG Cutter Maint</span>
                                <span class="sample-btn" onclick="loadSample('satellite')">Space Force Sat</span>
                                <span class="sample-btn" onclick="loadSample('drl')">Navy DRL</span>
                                <span class="sample-btn" onclick="loadSample('buylist')">Navy Buylist</span>
                                <span class="sample-btn" onclick="loadSample('transfer_book')">Transfer Book</span>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <label class="form-check-label" style="font-size:0.85rem">
                                    <input type="checkbox" id="encryptCheck" checked style="width:auto!important;margin-right:6px"> Encrypt before hashing (CUI protection)
                                </label>
                            </div>
                            <button class="btn-accent mt-3" onclick="anchorRecord()" id="anchorBtn"><i class="fas fa-anchor"></i> Anchor to XRPL</button>
                            <div class="result-panel" id="anchorResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-diagram-project"></i> Anchor Flow</h3>
                            <div style="font-size:0.9rem;line-height:2">
                                <div><span style="color:var(--accent);font-weight:700">1.</span> Select branch & record type</div>
                                <div><span style="color:var(--accent);font-weight:700">2.</span> Enter or paste record content</div>
                                <div><span style="color:var(--accent);font-weight:700">3.</span> Optional: encrypt for CUI protection</div>
                                <div><span style="color:var(--accent);font-weight:700">4.</span> SHA-256 hash computed client-side</div>
                                <div><span style="color:var(--accent);font-weight:700">5.</span> Hash anchored to XRPL memo field</div>
                                <div><span style="color:var(--accent);font-weight:700">6.</span> $SLS micro-fee (0.01) paid to treasury</div>
                                <div><span style="color:var(--accent);font-weight:700">7.</span> Record appears in Live Metrics dashboard</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-shield-halved"></i> What Gets Stored On-Chain</h3>
                            <p style="font-size:0.85rem;color:var(--steel)"><strong>Only the SHA-256 hash</strong> of your record is stored on the XRP Ledger. No classified data, CUI, ITAR-controlled, or sensitive content ever touches the blockchain.</p>
                            <div style="font-size:0.8rem;margin-top:0.5rem">
                                <span style="color:var(--green)">&#10003;</span> NIST SP 800-171 compatible<br>
                                <span style="color:var(--green)">&#10003;</span> CMMC Level 2 aligned<br>
                                <span style="color:var(--green)">&#10003;</span> DFARS 252.204-7012 compliant<br>
                                <span style="color:var(--green)">&#10003;</span> No PII/CUI on-chain
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabVerify" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-check-circle"></i> Verify a Defense Record</h3>
                            <p style="color:var(--steel);font-size:0.9rem;margin-bottom:1rem">Paste the original record content to verify its hash matches what was anchored on XRPL.</p>
                            <label>Record Content</label>
                            <textarea id="verifyInput" placeholder="Paste the original defense record content here..."></textarea>
                            <label class="mt-2">Expected Hash (optional)</label>
                            <input type="text" id="verifyHash" placeholder="SHA-256 hash to compare against">
                            <button class="btn-gold mt-3" onclick="verifyRecord()"><i class="fas fa-check-circle"></i> Verify Integrity</button>
                            <div class="result-panel" id="verifyResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-question-circle"></i> Verification Use Cases</h3>
                            <div style="font-size:0.85rem;line-height:1.8;color:var(--steel)">
                                <div><strong>Supply Chain:</strong> Confirm parts receipt hasn't been altered</div>
                                <div><strong>CDRL:</strong> Verify contractor delivered exact document version</div>
                                <div><strong>Maintenance:</strong> Prove 3-M actions logged as-performed</div>
                                <div><strong>Ordnance:</strong> Validate lot tracking since manufacture</div>
                                <div><strong>Config:</strong> Confirm system baseline hasn't drifted</div>
                                <div><strong>Audit:</strong> Demonstrate tamper-proof trail to inspectors</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabLog" role="tabpanel">
                <div class="demo-card">
                    <h3><i class="fas fa-list"></i> Transaction Log</h3>
                    <p style="color:var(--steel);font-size:0.9rem">All records anchored in this session.</p>
                    <div class="tx-log" id="txLog">
                        <div style="color:var(--muted);text-align:center;padding:2rem">No records anchored yet. Go to the <strong>Anchor</strong> tab to start.</div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabAbout" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="demo-card">
                            <h3><i class="fas fa-cogs"></i> How S4 Ledger Works</h3>
                            <div style="font-size:0.9rem;line-height:1.9;color:var(--steel)">
                                <p>S4 Ledger creates <strong>tamper-proof records</strong> for defense logistics by anchoring SHA-256 hashes to the XRP Ledger.</p>
                                <p><strong>The process:</strong></p>
                                <ol><li>A defense record is created in your existing system</li><li>S4 Ledger computes a SHA-256 hash</li><li>Only the hash is written to an XRPL transaction memo</li><li>A micro-fee of 0.01 $SLS is paid per anchor</li><li>Anyone with the original can verify it hasn't been altered</li></ol>
                                <p><strong>No sensitive data on-chain.</strong> The blockchain only sees a 64-character hash.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="demo-card">
                            <h3><i class="fas fa-shield-halved"></i> Supported Military Branches</h3>
                            <table style="width:100%;font-size:0.82rem">
                                <tr style="color:var(--muted);border-bottom:1px solid var(--border)"><th style="padding:0.4rem 0">Branch</th><th>Types</th><th>Key Systems</th></tr>
                                <tr><td style="padding:0.3rem 0">&#9875; U.S. Navy</td><td>54</td><td style="color:var(--muted)">NAVSUP, NAVSEA, CDMD-OA</td></tr>
                                <tr><td>&#11088; U.S. Army</td><td>20</td><td style="color:var(--muted)">GCSS-Army, PBUSE, SAAS</td></tr>
                                <tr><td>&#9992;&#65039; U.S. Air Force</td><td>18</td><td style="color:var(--muted)">IMDS, CEMS, CAS</td></tr>
                                <tr><td>&#129413; Marines</td><td>14</td><td style="color:var(--muted)">GCSS-MC, NALCOMIS, ATLASS</td></tr>
                                <tr><td>&#128735;&#65039; Coast Guard</td><td>12</td><td style="color:var(--muted)">ABS NS5, CG-LIMS, MISLE</td></tr>
                                <tr><td>&#127963;&#65039; DLA</td><td>12</td><td style="color:var(--muted)">DSS, DRMS, HMIRS</td></tr>
                                <tr><td>&#127894;&#65039; Joint</td><td>10</td><td style="color:var(--muted)">ALIS/ODIN, DRRS, MDA</td></tr>
                                <tr><td>&#128481;&#65039; SOCOM</td><td>8</td><td style="color:var(--muted)">SOF-LAN</td></tr>
                                <tr><td>&#128640; Space Force</td><td>11</td><td style="color:var(--muted)">18 SDS, SMC, SBIRS</td></tr>
                            </table>
                            <div style="margin-top:0.8rem;padding-top:0.8rem;border-top:1px solid var(--border);font-size:0.85rem;color:var(--steel)"><strong>Total: 159 record types</strong> across 9 military branches and agencies</div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-coins"></i> $SLS Token</h3>
                            <div style="font-size:0.85rem;color:var(--steel)">
                                <div><strong>Token:</strong> $SLS on XRP Ledger</div>
                                <div><strong>Total Supply:</strong> 100,000,000</div>
                                <div><strong>Anchor Fee:</strong> 0.01 $SLS per record</div>
                                <div><strong>Issuer:</strong> r95GyZac...HsTA5</div>
                                <div><strong>Treasury:</strong> rMLmkrxp...1KLqJ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabILS" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-brain"></i> ILS Intelligence Analyzer</h3>
                            <p style="color:var(--steel);font-size:0.9rem;margin-bottom:1rem">Upload your DRLs, spreadsheets, checklists, and documents. The analyzer will parse them, cross-reference against program requirements, and identify gaps, missing deliverables, and actionable items.</p>

                            <label>1. Select Program / Vessel Type</label>
                            <div class="row mb-3">
                                <div class="col-7">
                                    <select id="ilsProgram" onchange="onILSProgramChange()">
                                        <optgroup label="PMS 300 — Service Craft & Special Vessels">
                                            <option value="yrbm">YRBM — Yard Repair, Berthing & Messing</option>
                                            <option value="apl">APL — Auxiliary Personnel Lighter</option>
                                            <option value="afdm">AFDM — Aux Floating Drydock Medium</option>
                                            <option value="ydt">YDT — Large Harbor Tug</option>
                                            <option value="yon">YON — Fuel Oil Barge</option>
                                        </optgroup>
                                        <optgroup label="Navy — Major Surface Combatants">
                                            <option value="ddg51">DDG-51 Flight III (Arleigh Burke)</option>
                                            <option value="lcs">LCS Freedom-class</option>
                                            <option value="cvn78">CVN-78 Ford-class</option>
                                            <option value="ffg62">FFG-62 Constellation-class</option>
                                            <option value="lpd17">LPD-17 San Antonio-class</option>
                                        </optgroup>
                                        <optgroup label="Navy / USMC — Aviation">
                                            <option value="f35">F-35C Lightning II (Navy)</option>
                                            <option value="f35b">F-35B Lightning II (USMC STOVL)</option>
                                            <option value="ch53k">CH-53K King Stallion</option>
                                        </optgroup>
                                        <optgroup label="U.S. Army — Ground & Aviation">
                                            <option value="m1">M1A2 Abrams SEPv3</option>
                                            <option value="stryker">Stryker ICV-VA1</option>
                                            <option value="ah64">AH-64E Apache Guardian</option>
                                            <option value="himars">M142 HIMARS</option>
                                        </optgroup>
                                        <optgroup label="U.S. Air Force">
                                            <option value="f35a">F-35A Lightning II (CTOL)</option>
                                            <option value="kc46">KC-46A Pegasus</option>
                                            <option value="b21">B-21 Raider</option>
                                            <option value="c17">C-17 Globemaster III</option>
                                        </optgroup>
                                        <optgroup label="U.S. Space Force">
                                            <option value="gps3">GPS III / IIIF Satellite</option>
                                            <option value="sbirs">SBIRS / Next-Gen OPIR</option>
                                        </optgroup>
                                        <optgroup label="U.S. Coast Guard">
                                            <option value="nsc">NSC (Legend-class)</option>
                                            <option value="opc">OPC (Heritage-class)</option>
                                            <option value="frc">FRC (Sentinel-class)</option>
                                        </optgroup>
                                        <optgroup label="U.S. Marine Corps — Ground">
                                            <option value="acv">ACV 1.1 Amphibious Combat Vehicle</option>
                                        </optgroup>
                                        <optgroup label="Custom">
                                            <option value="custom">Custom Program (define your own)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-5">
                                    <input type="text" id="ilsHull" placeholder="Hull # / Designation" style="font-size:0.88rem">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label style="font-size:0.82rem">Program Office</label>
                                    <input type="text" id="ilsOffice" placeholder="e.g. PMS 300" style="font-size:0.88rem">
                                </div>
                                <div class="col-6">
                                    <label style="font-size:0.82rem">Acquisition Phase</label>
                                    <select id="ilsPhase" style="font-size:0.88rem">
                                        <option value="pre_award">Pre-Award</option>
                                        <option value="design" selected>Design</option>
                                        <option value="construction">Construction</option>
                                        <option value="test_eval">Test & Evaluation</option>
                                        <option value="delivery">Delivery / Turnover</option>
                                        <option value="post_delivery">Post-Delivery</option>
                                    </select>
                                </div>
                            </div>

                            <label>2. Upload Documents <span style="color:var(--muted);font-weight:400">(DRLs, spreadsheets, checklists, text files)</span></label>
                            <div class="ils-dropzone" id="ilsDropzone" onclick="document.getElementById('ilsFileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <div style="font-weight:600;color:#fff;margin-bottom:4px">Drag & drop files here or click to browse</div>
                                <div style="font-size:0.82rem;color:var(--muted)">Accepts .csv, .xlsx, .xls, .txt — all processing done locally in your browser</div>
                            </div>
                            <input type="file" id="ilsFileInput" multiple accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none" onchange="handleILSFiles(this.files)">
                            <div style="margin:8px 0;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                                <button style="background:linear-gradient(135deg,rgba(0,170,255,0.12),rgba(201,168,76,0.12));border:1px solid rgba(0,170,255,0.25);color:var(--accent);border-radius:6px;padding:6px 14px;cursor:pointer;font-family:inherit;font-size:0.82rem;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='rgba(0,170,255,0.2)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(0,170,255,0.12),rgba(201,168,76,0.12))'" onclick="event.stopPropagation();loadSampleDRL()"><i class="fas fa-flask"></i> Load Sample DRL</button>
                                <button style="background:linear-gradient(135deg,rgba(201,168,76,0.12),rgba(20,241,149,0.08));border:1px solid rgba(201,168,76,0.25);color:var(--gold);border-radius:6px;padding:6px 14px;cursor:pointer;font-family:inherit;font-size:0.82rem;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='rgba(201,168,76,0.2)'" onmouseout="this.style.background='linear-gradient(135deg,rgba(201,168,76,0.12),rgba(20,241,149,0.08))'" onclick="event.stopPropagation();loadSamplePackage()"><i class="fas fa-box-open"></i> Load Full ILS Package</button>
                                <span style="font-size:0.78rem;color:var(--muted)">DRL, LCSP, IUID, VRS, Spares Buylist & more</span>
                            </div>
                            <div class="ils-file-list" id="ilsFileList"></div>

                            <label>3. Program ILS Checklist <span style="color:var(--muted);font-weight:400">(changes per program — auto-populated from uploads, or check manually)</span></label>
                            <div id="ilsChecklist" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:1rem;font-size:0.85rem;"></div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn-accent" onclick="runFullILSAnalysis()"><i class="fas fa-chart-line"></i> Run Full Analysis</button>
                                <button class="btn-gold" onclick="generateILSReport()"><i class="fas fa-file-export"></i> Generate Report</button>
                                <button style="background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:8px;padding:0.5rem 1rem;cursor:pointer;font-family:inherit;font-size:0.85rem;font-weight:600" onclick="anchorILSReport()"><i class="fas fa-anchor"></i> Anchor Report Hash</button>
                            </div>
                            <div id="ilsPostActions" style="display:none">
                                <div class="post-actions">
                                    <button class="post-action-btn" onclick="sendILSAnalysis()"><i class="fas fa-paper-plane"></i> Send Analysis</button>
                                    <button class="post-action-btn" onclick="scheduleILSMeeting()"><i class="fas fa-calendar-plus"></i> Schedule Meeting</button>
                                    <button class="post-action-btn" onclick="exportActionTracker()"><i class="fas fa-clipboard-list"></i> Update Action Tracker</button>
                                    <button class="post-action-btn" onclick="printILSReport()"><i class="fas fa-print"></i> Print Report</button>
                                    <button class="post-action-btn" onclick="saveILSReport()"><i class="fas fa-save"></i> Save Report</button>
                                </div>
                            </div>
                            <div class="result-panel" id="ilsResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-chart-pie"></i> ILS Readiness Score</h3>
                            <div id="ilsScoreContainer" style="text-align:center;padding:1rem 0">
                                <div style="font-size:4rem;font-weight:800;color:var(--muted)" id="ilsScore">--</div>
                                <div style="font-size:0.9rem;color:var(--steel)" id="ilsScoreLabel">Upload documents & run analysis</div>
                                <div style="margin-top:1rem" id="ilsGaugeBar">
                                    <div style="background:var(--surface);border-radius:8px;height:12px;overflow:hidden;border:1px solid var(--border)">
                                        <div id="ilsGaugeFill" style="height:100%;width:0%;background:linear-gradient(90deg,#ff3333,#ffa500,#14f195);border-radius:8px;transition:width 0.8s ease"></div>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-top:4px"><span>Critical Gaps</span><span>Partial</span><span>Mission Ready</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-list-check"></i> ILS Element Coverage</h3>
                            <div id="ilsCoverage" style="font-size:0.85rem">
                                <div style="color:var(--muted);text-align:center;padding:1rem">Upload files to see element-by-element coverage.</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-exclamation-triangle" style="color:#ffa500"></i> Action Items</h3>
                            <div id="ilsActions" style="max-height:400px;overflow-y:auto">
                                <div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.85rem">Run analysis to generate action items with responsible parties, due dates, and cost impact.</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-dollar-sign" style="color:#c9a84c"></i> Cost & Schedule Impact</h3>
                            <div id="ilsCostSchedule" style="font-size:0.85rem">
                                <div style="color:var(--muted);text-align:center;padding:1rem">Analysis required to estimate impact.</div>
                            </div>
                        </div>
                        <div class="demo-card" style="padding:0;overflow:hidden">
                            <div style="padding:0">
                                <div class="ai-chat-header">
                                    <div class="ai-dot"></div>
                                    <div><span style="font-weight:700;color:#fff;font-size:0.95rem"><i class="fas fa-robot" style="color:var(--accent);margin-right:6px"></i>S4 ILS Agent</span><span style="font-size:0.72rem;color:var(--muted);margin-left:8px">AI-Powered Analysis Assistant</span></div>
                                </div>
                                <div class="ai-chat-container" style="border:none;border-radius:0;height:380px">
                                    <div class="ai-chat-messages" id="aiChatMessages">
                                        <div class="ai-msg bot"><div class="ai-label"><i class="fas fa-robot"></i> S4 Agent</div>Hello! I'm your ILS Intelligence Agent. I can help you:<br>• Interpret gap analysis results<br>• Explain DI number requirements<br>• Suggest corrective actions<br>• Draft CAR narratives<br>• Estimate cost impacts<br><br>Run an analysis or ask me anything about ILS!</div>
                                    </div>
                                    <div class="ai-quick-btns" id="aiQuickBtns">
                                        <button class="ai-quick-btn" onclick="aiAsk('Summarize my gaps')">Summarize Gaps</button>
                                        <button class="ai-quick-btn" onclick="aiAsk('What are the critical items?')">Critical Items</button>
                                        <button class="ai-quick-btn" onclick="aiAsk('Draft a CAR')">Draft CAR</button>
                                        <button class="ai-quick-btn" onclick="aiAsk('Estimate total risk')">Risk Estimate</button>
                                        <button class="ai-quick-btn" onclick="aiAsk('What DI numbers am I missing?')">Missing DIs</button>
                                        <button class="ai-quick-btn" onclick="aiAsk('Suggest next steps')">Next Steps</button>
                                    </div>
                                    <div class="ai-chat-input">
                                        <input type="text" id="aiChatInput" placeholder="Ask the ILS Agent..." onkeydown="if(event.key==='Enter')aiSend()">
                                        <button onclick="aiSend()"><i class="fas fa-paper-plane"></i> Send</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="anchorOverlay" class="anchor-overlay">
    <div class="anchor-anim-box">
        <div class="chain-segment"></div>
        <div class="anchor-drop-icon"><i class="fas fa-anchor"></i></div>
        <div class="anim-status" id="animStatus">Anchoring to XRPL...</div>
        <div class="anim-hash" id="animHash"></div>
        <div id="animClf" style="margin-top:0.6rem"></div>
        <div class="anim-fee" id="animFee">0.01 $SLS &rarr; Treasury</div>
        <div class="anim-success" id="animSuccess"></div>
    </div>
</div>

<div id="sendModal" class="modal-overlay" onclick="if(event.target===this)closeSendModal()">
    <div class="modal-box" style="position:relative">
        <button onclick="closeSendModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer">&times;</button>
        <h4><i class="fas fa-paper-plane" style="color:var(--accent);margin-right:8px"></i>Send ILS Analysis</h4>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Recipient Email(s)</label>
            <input type="text" id="sendEmail" placeholder="email@navy.mil, pm@contractor.com" style="font-size:0.85rem!important">
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Subject</label>
            <input type="text" id="sendSubject" value="" style="font-size:0.85rem!important">
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Message (optional)</label>
            <textarea id="sendMessage" rows="3" placeholder="Please review the attached ILS gap analysis..." style="min-height:70px!important;font-family:'Plus Jakarta Sans',sans-serif!important;font-size:0.85rem!important"></textarea>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-accent" onclick="executeSend()"><i class="fas fa-paper-plane"></i> Send via Email Client</button>
            <button style="background:rgba(0,170,255,0.1);border:1px solid var(--border);color:var(--steel);border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;font-family:inherit" onclick="copyAnalysisToClipboard()"><i class="fas fa-copy"></i> Copy to Clipboard</button>
        </div>
    </div>
</div>

<div id="meetingModal" class="modal-overlay" onclick="if(event.target===this)closeMeetingModal()">
    <div class="modal-box" style="position:relative">
        <button onclick="closeMeetingModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer">&times;</button>
        <h4><i class="fas fa-calendar-plus" style="color:var(--accent);margin-right:8px"></i>Schedule ILS Review Meeting</h4>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Meeting Title</label>
            <input type="text" id="meetTitle" value="" style="font-size:0.85rem!important">
        </div>
        <div class="row mb-3">
            <div class="col-6">
                <label style="font-size:0.82rem">Date</label>
                <input type="date" id="meetDate" style="font-size:0.85rem!important">
            </div>
            <div class="col-6">
                <label style="font-size:0.82rem">Time</label>
                <input type="time" id="meetTime" value="10:00" style="font-size:0.85rem!important">
            </div>
        </div>
        <div style="margin-bottom:12px">
            <label style="font-size:0.82rem">Attendees (emails)</label>
            <input type="text" id="meetAttendees" placeholder="pm@navy.mil, ils@contractor.com" style="font-size:0.85rem!important">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-accent" onclick="createTeamsMeeting()"><i class="fab fa-microsoft"></i> Open Teams</button>
            <button style="background:rgba(201,168,76,0.15);border:1px solid rgba(201,168,76,0.3);color:var(--gold);border-radius:8px;padding:8px 16px;cursor:pointer;font-size:0.85rem;font-family:inherit;font-weight:600" onclick="createCalendarEvent()"><i class="fas fa-calendar-alt"></i> Add to Calendar (.ics)</button>
        </div>
    </div>
</div>

<footer>
    <div class="container">
        <div style="margin-bottom:12px;"><img src="../s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="footer-logo"><span style="font-weight:700;font-size:1.1rem;">S4 Ledger</span><span style="color:var(--muted);margin-left:5px;">&mdash; Secure Logistics Standard</span></div>
        <p style="font-size:0.82rem;margin-bottom:10px;">Immutable logistics verification for the defense industry. Built on the XRP Ledger.</p>
        <div style="margin-bottom:10px;"><a href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-github fa-lg"></i></a><a href="https://x.com/S4_Ledger" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-x-twitter fa-lg"></i></a><a href="https://linkedin.com" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-linkedin fa-lg"></i></a></div>
        <div style="margin-bottom:10px;font-size:0.78rem;"><a href="../s4-terms/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Terms of Service</a><a href="../s4-privacy/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Privacy Policy</a><a href="../security/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Security</a></div>
        <p style="font-size:0.75rem;color:var(--muted);">$SLS is a utility token &mdash; not equity or an investment contract. &copy; 2026 S4 Ledger. Demo uses XRPL Testnet.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ======================================================================
//  S4 LEDGER DEMO ENGINE — 130+ DEFENSE RECORD TYPES
// ======================================================================

// ── Classification level mapping ──
// U = Unclassified, CUI = Controlled Unclassified, SECRET = Secret, TS = Top Secret
const CLASSIFICATION = {
    // ── USN ──
    USN_SUPPLY_RECEIPT:'CUI', USN_3M_MAINTENANCE:'CUI', USN_CASREP:'SECRET', USN_CDRL:'CUI',
    USN_ORDNANCE:'SECRET', USN_DEPOT_REPAIR:'CUI', USN_INSURV:'CUI', USN_CALIBRATION:'U',
    USN_CONFIG:'CUI', USN_CUSTODY:'CUI', USN_TDP:'CUI', USN_COC:'U', USN_SHIPALT:'CUI',
    USN_PMS:'U', USN_HME:'CUI', USN_COMBAT_SYS:'SECRET', USN_PROPULSION:'CUI',
    USN_AVIATION:'CUI', USN_FLIGHT_OPS:'CUI', USN_SUBSAFE:'SECRET', USN_DIVE_EQUIP:'U',
    USN_MEDICAL:'CUI', USN_QDR:'U', USN_FIELDING:'CUI', USN_REACTOR:'SECRET',
    USN_DRL:'CUI', USN_DI:'CUI', USN_VRS:'CUI', USN_BUYLIST:'CUI',
    USN_J1_ILS:'CUI', USN_J2_SE:'CUI', USN_J3_SUPPLY:'CUI', USN_J4_TECHDATA:'CUI',
    USN_J5_TRAINING:'U', USN_J6_MANPOWER:'CUI', USN_J7_FACILITIES:'U', USN_J8_PHST:'CUI',
    USN_J9_SOFTWARE:'CUI', USN_J10_DESIGN:'CUI', USN_J11_RAM:'CUI', USN_J12_ACQLOG:'CUI',
    USN_J13_CM:'CUI', USN_J14_DISPOSAL:'U', USN_BAM:'CUI', USN_TRANSFER_BOOK:'CUI',
    USN_COTS_MANUAL:'U', USN_TM_INDEX:'U', USN_PO_INDEX:'CUI', USN_PID:'CUI',
    USN_CONTRACT_MOD:'CUI', USN_CONFIG_MGMT:'CUI', USN_OUTFITTING:'CUI', USN_PURCHASE_REQ:'CUI',
    // ── USA ──
    USA_HAND_RECEIPT:'CUI', USA_TM_UPDATE:'CUI', USA_ARMS_ROOM:'CUI', USA_FLIPL:'CUI',
    USA_VEHICLE:'U', USA_CLASS_III:'U', USA_CLASS_V:'SECRET', USA_EQUIP_MAINT:'U',
    USA_AMMO_STORAGE:'SECRET', USA_RANGE_QUAL:'U', USA_CALIBRATION:'U', USA_PROPERTY_BOOK:'CUI',
    USA_COMPONENT_HR:'CUI', USA_DENSITY_LIST:'CUI', USA_GCSS_TRANS:'CUI', USA_AVIATION:'CUI',
    USA_MEDICAL:'CUI', USA_CBRN:'SECRET', USA_ENGINEER:'U', USA_SIGNAL:'CUI',
    // ── USAF ──
    USAF_781_FLIGHT:'CUI', USAF_MUNITIONS:'SECRET', USAF_ENGINE:'CUI', USAF_WEAPONS_LOAD:'SECRET',
    USAF_STRUCT_INTEG:'CUI', USAF_AVIONICS:'CUI', USAF_NUCLEAR:'TS', USAF_MISSILE:'SECRET',
    USAF_SPACE:'SECRET', USAF_RADAR:'CUI', USAF_RUNWAY:'U', USAF_BDR:'SECRET',
    USAF_SUPPLY:'U', USAF_AGE:'U', USAF_FUEL:'U', USAF_DEPOT:'CUI',
    USAF_PMEL:'U', USAF_REFUEL:'CUI',
    // ── USMC ──
    USMC_GROUND_MAINT:'U', USMC_AVIATION:'CUI', USMC_WEAPONS:'CUI', USMC_COMMS:'CUI',
    USMC_ENGINEER:'U', USMC_MOTOR_T:'U', USMC_SUPPLY:'CUI', USMC_ORDNANCE:'SECRET',
    USMC_COMBAT_ENG:'CUI', USMC_AAV:'CUI', USMC_MEDICAL:'CUI', USMC_NBC:'SECRET',
    USMC_EXPEDITIONARY:'CUI', USMC_LAV:'CUI',
    // ── USCG ──
    USCG_CUTTER_MAINT:'U', USCG_SMALL_BOAT:'U', USCG_NAV_AID:'U', USCG_POLLUTION:'U',
    USCG_SAR:'CUI', USCG_MARITIME_SEC:'CUI', USCG_AVIATION:'CUI', USCG_PORT_SEC:'CUI',
    USCG_ELECTRONICS:'CUI', USCG_WEAPONS:'CUI', USCG_ICE_OPS:'U', USCG_BUOY_TENDER:'U',
    // ── DLA ──
    DLA_DISTRIBUTION:'CUI', DLA_FMS:'SECRET', DLA_DRMO:'U', DLA_HAZMAT:'CUI',
    DLA_BULK_FUEL:'CUI', DLA_TROOP_SUPPORT:'U', DLA_STRATEGIC:'SECRET', DLA_MEDICAL:'CUI',
    DLA_DPAS:'CUI', DLA_COMMISSARY:'U', DLA_DISPOSITION:'U', DLA_LAND_EQUIP:'U',
    // ── JOINT ──
    JOINT_NATO:'CUI', JOINT_F35:'SECRET', JOINT_MISSILE_DEF:'TS', JOINT_CYBER:'SECRET',
    JOINT_INTEL:'TS', JOINT_SPACE:'SECRET', JOINT_TRANSPORT:'CUI', JOINT_CONTRACT:'CUI',
    JOINT_READINESS:'SECRET', JOINT_DISPOSAL:'U',
    // ── SOCOM ──
    SOCOM_WEAPONS:'SECRET', SOCOM_COMMS:'SECRET', SOCOM_AVIATION:'SECRET', SOCOM_MARITIME:'SECRET',
    SOCOM_VEHICLE:'CUI', SOCOM_INTEL:'TS', SOCOM_MEDICAL:'CUI', SOCOM_DEMO:'SECRET',
    // ── USSF ──
    USSF_SAT_OPS:'SECRET', USSF_SPACE_VEH:'SECRET', USSF_SDA:'TS', USSF_GPS_CONST:'SECRET',
    USSF_LAUNCH_VEH:'SECRET', USSF_RADAR_TRACK:'SECRET', USSF_GROUND_SYS:'SECRET',
    USSF_COMM_SAT:'SECRET', USSF_EARLY_WARN:'TS', USSF_SPACE_CTRL:'SECRET'
};

const CLF_META = {
    U:    {label:'UNCLASSIFIED',  icon:'🟢', color:'#00cc66', desc:'No special handling required'},
    CUI:  {label:'CUI',           icon:'🟡', color:'#c9a84c', desc:'Controlled Unclassified Information — NIST 800-171 handling required'},
    SECRET:{label:'SECRET',       icon:'🔴', color:'#ff5555', desc:'Requires SIPRNet or equivalent classified network'},
    TS:   {label:'TOP SECRET',    icon:'🟠', color:'#ffa500', desc:'Requires JWICS or equivalent TS/SCI network'}
};

function getClassification(typeKey) { return CLASSIFICATION[typeKey] || 'CUI'; }

const BRANCHES = {
    USN:{name:"U.S. Navy",icon:"\u2693",short:"Navy"},
    USA:{name:"U.S. Army",icon:"\u2B50",short:"Army"},
    USAF:{name:"U.S. Air Force",icon:"\u2708\uFE0F",short:"Air Force"},
    USMC:{name:"U.S. Marine Corps",icon:"\uD83E\uDD85",short:"Marines"},
    USCG:{name:"U.S. Coast Guard",icon:"\uD83D\uDEDF\uFE0F",short:"Coast Guard"},
    DLA:{name:"Defense Logistics Agency",icon:"\uD83C\uDFDB\uFE0F",short:"DLA"},
    JOINT:{name:"Joint / Cross-Branch",icon:"\uD83C\uDF96\uFE0F",short:"Joint"},
    SOCOM:{name:"Special Operations",icon:"\uD83D\uDDE1\uFE0F",short:"SOCOM"},
    USSF:{name:"U.S. Space Force",icon:"\uD83D\uDE80",short:"Space Force"}
};

// Compact: [label, icon, color, branch, system]
const _RT = {
USN_SUPPLY_RECEIPT:["Supply Chain Receipt","\uD83D\uDCE6","#00aaff","USN","NAVSUP OneTouch"],
USN_3M_MAINTENANCE:["3-M Maintenance Action","\uD83D\uDD27","#ffd700","USN","SKED/OARS"],
USN_CASREP:["Casualty Report (CASREP)","\u26A0\uFE0F","#ff3333","USN","TYCOM"],
USN_CDRL:["CDRL Delivery","\uD83D\uDCC4","#8ea4b8","USN","CDMD-OA"],
USN_ORDNANCE:["Ordnance Lot Tracking","\uD83D\uDCA3","#ff6b6b","USN","AESIP"],
USN_DEPOT_REPAIR:["Depot Repair Record","\uD83C\uDFED","#ff9933","USN","CNRMF"],
USN_INSURV:["INSURV Inspection","\uD83D\uDD0D","#66ccff","USN","NRCC"],
USN_CALIBRATION:["TMDE Calibration","\uD83D\uDCCF","#ff66aa","USN","METCAL"],
USN_CONFIG:["Configuration Baseline","\u2699\uFE0F","#c9a84c","USN","CDMD-OA"],
USN_CUSTODY:["Custody Transfer","\uD83D\uDD04","#14f195","USN","DPAS"],
USN_TDP:["Technical Data Package","\uD83D\uDCD0","#9945ff","USN","NAVSEA"],
USN_COC:["Certificate of Conformance","\u2705","#00cc88","USN","DCMA"],
USN_SHIPALT:["Ship Alteration (SHIPALT)","\uD83D\uDEA2","#0077cc","USN","NAVSEA"],
USN_PMS:["PMS/SKED Compliance","\uD83D\uDCCB","#44aa88","USN","3M/SKED"],
USN_HME:["HM&E System Record","\u26A1","#dd8844","USN","ENGSKED"],
USN_COMBAT_SYS:["Combat Systems Cert","\uD83C\uDFAF","#ff4444","USN","CSSQT"],
USN_PROPULSION:["Propulsion Plant Exam","\uD83D\uDD25","#ff6600","USN","INSURV"],
USN_AVIATION:["Aviation Maintenance","\u2708\uFE0F","#0088cc","USN","NALCOMIS"],
USN_FLIGHT_OPS:["Flight Operations Record","\uD83D\uDEEB","#3399ff","USN","NATOPS"],
USN_SUBSAFE:["SUBSAFE Certification","\uD83D\uDD12","#003366","USN","NAVSEA 07"],
USN_DIVE_EQUIP:["Diving Equipment Inspection","\uD83E\uDD3F","#006699","USN","NAVSEA 00C"],
USN_MEDICAL:["Medical Equipment Cert","\uD83C\uDFE5","#33cc66","USN","BUMED"],
USN_QDR:["Quality Defect Report","\uD83D\uDEAB","#cc0000","USN","NAVSUP WSS"],
USN_FIELDING:["Equipment Fielding","\uD83D\uDEA2","#00ddaa","USN","PMS"],
USN_REACTOR:["Naval Reactor Test","\u2622\uFE0F","#ffcc00","USN","NAVSEA 08"],
USN_DRL:["Data Requirements List (DRL)","\uD83D\uDCCB","#5599cc","USN","NAVSEA/PMS"],
USN_DI:["Data Item Description (DID)","\uD83D\uDCC3","#4488bb","USN","CDMD-OA"],
USN_VRS:["Vendor Recommended Spares","\uD83D\uDCE6","#7799aa","USN","NAVICP/DLA"],
USN_BUYLIST:["Buylist / Provisioning","\uD83D\uDED2","#6688aa","USN","NAVSUP WSS"],
USN_J1_ILS:["J-1 ILS Parameters / LORA","\uD83D\uDCD1","#336699","USN","PMS/ILS"],
USN_J2_SE:["J-2 Support Equipment","\uD83D\uDD27","#337799","USN","PMS/ILS"],
USN_J3_SUPPLY:["J-3 Supply Support","\uD83D\uDCE6","#338899","USN","NAVSUP"],
USN_J4_TECHDATA:["J-4 Technical Data","\uD83D\uDCD6","#339999","USN","NAVSEA"],
USN_J5_TRAINING:["J-5 Training","\uD83C\uDF93","#33aa99","USN","NETC"],
USN_J6_MANPOWER:["J-6 Manpower & Personnel","\uD83D\uDC65","#4488cc","USN","OPNAV N1"],
USN_J7_FACILITIES:["J-7 Facilities","\uD83C\uDFD7\uFE0F","#5577bb","USN","NAVFAC"],
USN_J8_PHST:["J-8 PHS&T","\uD83D\uDCE6","#6699cc","USN","NAVSUP"],
USN_J9_SOFTWARE:["J-9 Computer Resources","\uD83D\uDCBB","#4477aa","USN","SPAWAR/NAVWAR"],
USN_J10_DESIGN:["J-10 Design Interface","\uD83D\uDCD0","#3366aa","USN","NAVSEA"],
USN_J11_RAM:["J-11 RAM Analysis","\uD83D\uDCC8","#2255aa","USN","PMS/ILS"],
USN_J12_ACQLOG:["J-12 Acquisition Logistics","\uD83D\uDCCA","#2266bb","USN","PMS/ILS"],
USN_J13_CM:["J-13 Configuration Mgmt","\u2699\uFE0F","#3377cc","USN","CDMD-OA"],
USN_J14_DISPOSAL:["J-14 Disposal","\uD83D\uDDD1\uFE0F","#667788","USN","DRMS"],
USN_BAM:["Budget Allowance Mgmt (BAM)","\uD83D\uDCB0","#cc9933","USN","NAVSUP"],
USN_TRANSFER_BOOK:["Transfer Book","\uD83D\uDCD3","#5588aa","USN","Supply Officer"],
USN_COTS_MANUAL:["COTS Manual / Documentation","\uD83D\uDCD8","#4477bb","USN","NAVSEA"],
USN_TM_INDEX:["Technical Manual Index","\uD83D\uDCC7","#3366bb","USN","NAVSEA"],
USN_PO_INDEX:["Purchase Order Index","\uD83D\uDCC2","#5588cc","USN","NAVSUP"],
USN_PID:["Program Introduction Doc (PID)","\uD83D\uDCC4","#6699bb","USN","PMS"],
USN_CONTRACT_MOD:["Contract Modification","\uD83D\uDCDD","#7788aa","USN","NAVSEA Contracts"],
USN_CONFIG_MGMT:["Configuration Mgmt Record","\u2699\uFE0F","#4466aa","USN","CDMD-OA"],
USN_OUTFITTING:["Outfitting Requirements","\uD83D\uDEA2","#3355aa","USN","PMS/Outfitting"],
USN_PURCHASE_REQ:["Purchase Request (PR)","\uD83D\uDCB3","#558899","USN","NAVSUP"],
USA_HAND_RECEIPT:["DA 2062 Hand Receipt","\uD83D\uDCDD","#4b5320","USA","GCSS-Army"],
USA_TM_UPDATE:["Technical Manual Update","\uD83D\uDCD6","#6b8e23","USA","LOGSA"],
USA_ARMS_ROOM:["Arms Room Inventory","\uD83D\uDD2B","#8b4513","USA","PBUSE"],
USA_FLIPL:["FLIPL Investigation","\uD83D\uDCCB","#cd853f","USA","GCSS-Army"],
USA_VEHICLE:["Vehicle Dispatch Log","\uD83D\uDE9B","#556b2f","USA","GCSS-Army"],
USA_CLASS_III:["Class III (POL) Issue","\u26FD","#8b8000","USA","GCSS-Army"],
USA_CLASS_V:["Class V (Ammo) Issue","\uD83D\uDCA5","#b22222","USA","SAAS"],
USA_EQUIP_MAINT:["Equipment Maintenance","\uD83D\uDD27","#696969","USA","GCSS-Army"],
USA_AMMO_STORAGE:["Ammo Storage Inspection","\uD83C\uDFED","#a0522d","USA","QASAS"],
USA_RANGE_QUAL:["Range Qualification","\uD83C\uDFAF","#2e8b57","USA","DTMS"],
USA_CALIBRATION:["TMDE Calibration (Army)","\uD83D\uDCCF","#daa520","USA","TMDE Activity"],
USA_PROPERTY_BOOK:["Property Book Record","\uD83D\uDCD7","#3cb371","USA","PBUSE"],
USA_COMPONENT_HR:["Component Hand Receipt","\uD83D\uDDC2\uFE0F","#8fbc8f","USA","GCSS-Army"],
USA_DENSITY_LIST:["Equipment Density List","\uD83D\uDCCA","#66cdaa","USA","GCSS-Army"],
USA_GCSS_TRANS:["GCSS-Army Transaction","\uD83D\uDCBB","#20b2aa","USA","GCSS-Army"],
USA_AVIATION:["Aviation Maintenance","\uD83D\uDE81","#2f4f4f","USA","ULLS-A(E)"],
USA_MEDICAL:["Medical Supply Record","\uD83C\uDFE5","#3cb371","USA","DMLSS"],
USA_CBRN:["CBRN Equipment Record","\u2623\uFE0F","#8b0000","USA","GCSS-Army"],
USA_ENGINEER:["Engineer Equipment","\uD83C\uDFD7\uFE0F","#808000","USA","GCSS-Army"],
USA_SIGNAL:["Signal/Comms Equipment","\uD83D\uDCE1","#4682b4","USA","LMP"],
USAF_781_FLIGHT:["AFTO 781 Flight Record","\u2708\uFE0F","#00308f","USAF","IMDS"],
USAF_MUNITIONS:["Munitions Inspection","\uD83D\uDCA3","#cd5c5c","USAF","CAS"],
USAF_ENGINE:["Engine Management Record","\uD83D\uDD25","#ff8c00","USAF","CEMS"],
USAF_WEAPONS_LOAD:["Weapons Load Certification","\uD83C\uDFAF","#dc143c","USAF","MIS"],
USAF_STRUCT_INTEG:["Aircraft Structural Record","\uD83D\uDEE1\uFE0F","#4169e1","USAF","ASIP"],
USAF_AVIONICS:["Avionics Test Record","\uD83D\uDCDF","#6a5acd","USAF","IMDS"],
USAF_NUCLEAR:["Nuclear Weapons Cert","\u2622\uFE0F","#ffd700","USAF","AFGSC"],
USAF_MISSILE:["Missile Maintenance Record","\uD83D\uDE80","#b8860b","USAF","MMICS"],
USAF_SPACE:["Space Vehicle Certification","\uD83D\uDEF0\uFE0F","#191970","USAF","USSF"],
USAF_RADAR:["Radar Calibration Record","\uD83D\uDCE1","#00bfff","USAF","IMDS"],
USAF_RUNWAY:["Runway Condition Report","\uD83D\uDEEC","#708090","USAF","BCAS"],
USAF_BDR:["Battle Damage Assessment","\uD83D\uDCA5","#ff4500","USAF","BDA"],
USAF_SUPPLY:["AF Supply Transaction","\uD83D\uDCE6","#1e90ff","USAF","SBSS"],
USAF_AGE:["Aerospace Ground Equipment","\uD83D\uDD29","#778899","USAF","IMDS"],
USAF_FUEL:["Fuel Management Record","\u26FD","#daa520","USAF","AFPET"],
USAF_DEPOT:["Depot Maintenance Record","\uD83C\uDFED","#cd853f","USAF","D200A"],
USAF_PMEL:["PMEL Calibration","\uD83D\uDCCF","#da70d6","USAF","PMEL"],
USAF_REFUEL:["Aerial Refueling Log","\u26FD","#2e8b57","USAF","ART"],
USMC_GROUND_MAINT:["Ground Equipment Maint","\uD83D\uDD27","#cc0000","USMC","GCSS-MC"],
USMC_AVIATION:["Aviation Intermediate Maint","\uD83D\uDE81","#8b0000","USMC","NALCOMIS"],
USMC_WEAPONS:["Weapons Maintenance","\uD83D\uDD2B","#a52a2a","USMC","ATLASS"],
USMC_COMMS:["Communications Equipment","\uD83D\uDCE1","#cd5c5c","USMC","GCSS-MC"],
USMC_ENGINEER:["Engineer Equipment Record","\uD83C\uDFD7\uFE0F","#b22222","USMC","GCSS-MC"],
USMC_MOTOR_T:["Motor Transport Record","\uD83D\uDE9B","#dc143c","USMC","GCSS-MC"],
USMC_SUPPLY:["MAGTF Supply Chain","\uD83D\uDCE6","#800000","USMC","GCSS-MC"],
USMC_ORDNANCE:["Marine Ordnance Record","\uD83D\uDCA3","#ff0000","USMC","TFSMS"],
USMC_COMBAT_ENG:["Combat Engineering Record","\uD83D\uDCA5","#c41e3a","USMC","GCSS-MC"],
USMC_AAV:["AAV/ACV Maintenance","\uD83D\uDEA2","#990000","USMC","GCSS-MC"],
USMC_MEDICAL:["Medical Supply Record","\uD83C\uDFE5","#ff6666","USMC","DMLSS"],
USMC_NBC:["NBC Equipment Inspection","\u2623\uFE0F","#660000","USMC","GCSS-MC"],
USMC_EXPEDITIONARY:["Expeditionary Supply","\uD83C\uDFD5\uFE0F","#993333","USMC","GCSS-MC"],
USMC_LAV:["LAV Maintenance Record","\uD83D\uDE97","#cc3333","USMC","GCSS-MC"],
USCG_CUTTER_MAINT:["Cutter Maintenance","\uD83D\uDEA2","#003366","USCG","ABS NS5"],
USCG_SMALL_BOAT:["Small Boat Inspection","\u26F5","#336699","USCG","CG-LIMS"],
USCG_NAV_AID:["Aids to Navigation Maint","\uD83D\uDDFC","#0066cc","USCG","ATON MIS"],
USCG_POLLUTION:["Pollution Response Equip","\uD83D\uDEE2\uFE0F","#669900","USCG","MISLE"],
USCG_SAR:["Search & Rescue Equipment","\uD83C\uDD98","#ff3300","USCG","MISLE"],
USCG_MARITIME_SEC:["Maritime Security Equip","\uD83D\uDD12","#003399","USCG","MISLE"],
USCG_AVIATION:["CG Aviation Maintenance","\uD83D\uDE81","#3366ff","USCG","ALMIS"],
USCG_PORT_SEC:["Port Security Inspection","\uD83C\uDFD7\uFE0F","#0033cc","USCG","MISLE"],
USCG_ELECTRONICS:["Electronics Systems Maint","\uD83D\uDCE1","#0099ff","USCG","CG-LIMS"],
USCG_WEAPONS:["CG Weapons System Maint","\uD83D\uDD2B","#002244","USCG","CG-LIMS"],
USCG_ICE_OPS:["Ice Operations Equipment","\uD83E\uDDCA","#66ccff","USCG","CG-LIMS"],
USCG_BUOY_TENDER:["Buoy Tender Maintenance","\uD83D\uDD34","#ff6600","USCG","ATON MIS"],
DLA_DISTRIBUTION:["DLA Distribution Receipt","\uD83C\uDFDB\uFE0F","#1a3a5c","DLA","DSS"],
DLA_FMS:["Foreign Military Sales","\uD83C\uDF10","#2a5a8c","DLA","DSCA"],
DLA_DRMO:["DRMO Disposal Record","\uD83D\uDDD1\uFE0F","#555555","DLA","DRMS"],
DLA_HAZMAT:["Hazmat Certification","\u2622\uFE0F","#ff9900","DLA","HMIRS"],
DLA_BULK_FUEL:["Bulk Fuel Receipt","\u26FD","#8b7355","DLA","DFSP"],
DLA_TROOP_SUPPORT:["Troop Support Material","\uD83C\uDF96\uFE0F","#4a6741","DLA","BSM"],
DLA_STRATEGIC:["Strategic Material Reserve","\uD83C\uDFE6","#8b8682","DLA","NDS"],
DLA_MEDICAL:["Medical Supply Chain","\uD83C\uDFE5","#2e8b57","DLA","ECAT"],
DLA_DPAS:["DPAS Property Record","\uD83D\uDCCB","#4682b4","DLA","DPAS"],
DLA_COMMISSARY:["Commissary Supply Record","\uD83D\uDED2","#6b8e23","DLA","DeCA"],
DLA_DISPOSITION:["Disposition Services","\uD83D\uDCE4","#8b8378","DLA","DRMS"],
DLA_LAND_EQUIP:["Land Equipment Supply","\uD83D\uDE9B","#556b2f","DLA","DSS"],
JOINT_NATO:["NATO STANAG Verification","\uD83C\uDFF3\uFE0F","#003399","JOINT","NATO"],
JOINT_F35:["F-35 JSF Logistics","\u2708\uFE0F","#1a1a2e","JOINT","ALIS/ODIN"],
JOINT_MISSILE_DEF:["Missile Defense Record","\uD83D\uDE80","#4a0080","JOINT","MDA"],
JOINT_CYBER:["Cyber Equipment Cert","\uD83D\uDDA5\uFE0F","#00cc99","JOINT","CYBERCOM"],
JOINT_INTEL:["Intelligence Equipment","\uD83D\uDD75\uFE0F","#2d2d2d","JOINT","DIA"],
JOINT_SPACE:["Space Command Asset","\uD83D\uDEF0\uFE0F","#000066","JOINT","USSPACECOM"],
JOINT_TRANSPORT:["TRANSCOM Logistics","\uD83D\uDE9B","#4a6741","JOINT","USTRANSCOM"],
JOINT_CONTRACT:["Contract Deliverable","\uD83D\uDCDD","#b8860b","JOINT","DCMA"],
JOINT_READINESS:["Readiness Report","\uD83D\uDCC8","#00ff88","JOINT","DRRS"],
JOINT_DISPOSAL:["Joint Disposal Record","\uD83D\uDDD1\uFE0F","#8b8682","JOINT","DLA"],
SOCOM_WEAPONS:["SOF Weapons Maintenance","\uD83D\uDD2B","#2d2d2d","SOCOM","SOF-LAN"],
SOCOM_COMMS:["SOF Communications Equip","\uD83D\uDCE1","#4a4a4a","SOCOM","SOF-LAN"],
SOCOM_AVIATION:["SOF Aviation Maintenance","\uD83D\uDE81","#333333","SOCOM","SOF-LAN"],
SOCOM_MARITIME:["SOF Maritime Equipment","\uD83E\uDD3F","#1a1a2e","SOCOM","SOF-LAN"],
SOCOM_VEHICLE:["SOF Vehicle Maintenance","\uD83D\uDE97","#3d3d3d","SOCOM","SOF-LAN"],
SOCOM_INTEL:["SOF Intelligence Equip","\uD83D\uDD75\uFE0F","#1a1a1a","SOCOM","SOF-LAN"],
SOCOM_MEDICAL:["SOF Medical Supply","\uD83C\uDFE5","#4a4a4a","SOCOM","SOF-LAN"],
SOCOM_DEMO:["SOF Demolition Record","\uD83D\uDCA5","#550000","SOCOM","SOF-LAN"],
USSF_SAT_OPS:["Satellite Operations Record","\uD83D\uDEF0\uFE0F","#1a1a4e","USSF","18 SDS"],
USSF_SPACE_VEH:["Space Vehicle Maintenance","\uD83D\uDE80","#2a2a5e","USSF","SMC"],
USSF_SDA:["Space Domain Awareness","\uD83D\uDD2D","#000066","USSF","18 SDS"],
USSF_GPS_CONST:["GPS Constellation Record","\uD83D\uDCE1","#003399","USSF","2 SOPS"],
USSF_LAUNCH_VEH:["Launch Vehicle Record","\uD83D\uDE80","#0044aa","USSF","SLD 45"],
USSF_RADAR_TRACK:["Space Surveillance Tracking","\uD83D\uDCE1","#0055bb","USSF","18 SDS"],
USSF_GROUND_SYS:["Ground Systems Maint","\uD83D\uDDA5\uFE0F","#002266","USSF","SBIRS"],
USSF_COMM_SAT:["Comm Satellite Record","\uD83D\uDCE1","#0033aa","USSF","MILSATCOM"],
USSF_EARLY_WARN:["Early Warning System","\u26A0\uFE0F","#003377","USSF","SBIRS"],
USSF_SPACE_CTRL:["Space Control Record","\uD83D\uDEE1\uFE0F","#001a66","USSF","SPACECOM"]
};

// Expand
const RECORD_TYPES = {};
for (const [k,v] of Object.entries(_RT)) {
    RECORD_TYPES[k] = {label:v[0],icon:v[1],color:v[2],branch:v[3],system:v[4]};
}

const SAMPLES = {
    supply:{type:'USN_SUPPLY_RECEIPT',branch:'USN',text:`Supply Chain Receipt\nNSN: 5340-01-234-5678\nNomenclature: Valve, Gate, Carbon Steel\nContract: N00024-23-C-5501\nCAGE Code: 1THK9\nQuantity Received: 50 EA\nCondition Code: A (Serviceable)\nInspection: FAT Pass\nReceiving Depot: Norfolk Naval Shipyard (NNSY)\nInspector: QA-237 J. Martinez\nDate: 2026-02-10`},
    maintenance:{type:'USN_3M_MAINTENANCE',branch:'USN',text:`Maintenance 3-M Action\nMRC: 2815-1.3.7\nEquipment: LM2500 Gas Turbine Engine\nHull Number: DDG-118\nAction: Oil sample analysis\nResults: Normal wear metals Fe:12ppm Cu:3ppm Al:2ppm\nTechnician: MM2(SW) Garcia\nVerified By: MMCS(SW) Thompson\nNext Due: 2026-08-10\nSKED Status: Current`},
    ordnance:{type:'USN_ORDNANCE',branch:'USN',text:`Ordnance Lot Tracking\nDODIC: A059 (5.56mm Ball M855)\nLot Number: WCC-2025-1147-A\nNSN: 1305-01-299-5564\nManufacturer: Winchester (CAGE: 97173)\nQuantity: 250,000 rounds\nProof Test: PASS (MIL-C-63989D)\nStorage: Weapons Station Earle, Magazine 14\nCustodian: GMC(SW) Rodriguez\nDate: 2026-02-08`},
    casrep:{type:'USN_CASREP',branch:'USN',text:`CASUALTY REPORT (CASREP)\nUnit: USS Porter (DDG-78)\nEquipment: AN/SPY-1D(V) Radar Transmitter\nSerial: SPY-TM-2019-04472\nImpact: Degraded radar coverage\nReported By: LCDR Pham, CSO\nDate: 2026-02-10`},
    custody:{type:'USN_CUSTODY',branch:'USN',text:`Chain of Custody Transfer\nEquipment: AN/SPY-1D(V) Transmitter Module\nSerial: SPY-TM-2019-04472\nNSN: 5841-01-522-3401\nFrom: ET1(SW) Cooper, DDG-78\nTo: NAVSEA Det Norfolk, IMA\nSeal: Tamper-evident #TS-2026-0887\nDate: 2026-02-10`},
    hand_receipt:{type:'USA_HAND_RECEIPT',branch:'USA',text:`DA Form 2062 Hand Receipt\nUnit: 3rd BCT, 101st Airborne\nProperty Book Officer: CPT Rivera\nItem: AN/PVS-14 Night Vision Device\nNSN: 5855-01-432-0524\nSerial: NVD-2024-08871\nQuantity: 24 EA\nCondition: Serviceable\nSub-hand receipt to: 1LT Nakamura, B Co\nDate: 2026-02-09`},
    flight_record:{type:'USAF_781_FLIGHT',branch:'USAF',text:`AFTO Form 781 Flight Record\nAircraft: F-16C Block 50\nTail: 91-0412\nUnit: 480th Fighter Squadron, Spangdahlem AB\nMission: Air-to-ground training sortie\nSorties: 1\nFlight Hours: 1.8\nPilot: Capt Williams\nDiscrepancies: None\nDate: 2026-02-10`},
    ground_maint:{type:'USMC_GROUND_MAINT',branch:'USMC',text:`Ground Equipment Maintenance\nUnit: 1st Maintenance Battalion, Camp Pendleton\nEquipment: HMMWV M1151A1\nBumper: 1MaintBn-HQ-07\nWork Order: PM services, 6-month interval\nTechnician: Sgt Dominguez\nHours: 4.5\nParts Used: Oil filter (NSN 2940-01-318-2345)\nStatus: Operational\nDate: 2026-02-11`},
    cutter:{type:'USCG_CUTTER_MAINT',branch:'USCG',text:`Cutter Maintenance Record\nVessel: USCGC Hamilton (WMSL-753)\nSystem: Main Diesel Engine #2\nAction: 500-hour inspection and filter change\nTechnician: MK1 Petersen\nParts: Fuel filter (NSN 2910-01-456-7890)\nCondition: Satisfactory\nNext PM: 2026-05-10\nDate: 2026-02-11`},
    satellite:{type:'USSF_SAT_OPS',branch:'USSF',text:`Satellite Operations Record\nConstellation: GPS III\nVehicle: SVN-78 (GPS III-6)\nOrbit: MEO, Slot A3\nStatus: Operational / Healthy\nPayload: L1C/A, L2C, L5, M-Code\nGround Contact: Schriever SFB, CO\nAnomaly: None\nOperator: 2nd SOPS\nDate: 2026-02-12`},
    drl:{type:'USN_DRL',branch:'USN',text:`Data Requirements List (CDRL)\nContract: N00024-24-C-6200\nCDRL Seq: A001\nDI Number: DI-ILSS-81495\nTitle: Integrated Logistics Support Plan\nFrequency: One-time with revisions\nDistribution: NAVSEA PMS 400D\nContractor: Huntington Ingalls Industries\nProgram: DDG-51 Flight III\nStatus: Submitted, under review\nDate: 2026-02-10`},
    buylist:{type:'USN_BUYLIST',branch:'USN',text:`Buylist / Provisioning Record\nProgram: LCS Freedom-class\nPMS: PMS 501\nItem: Main Reduction Gear Oil Pump Assembly\nNSN: 4320-01-567-8901\nRecommended Qty: 4 EA per hull\nAcquisition Method: Sole Source (OEM)\nVendor: Rolls-Royce Naval Marine (CAGE: K2965)\nUnit Cost: $47,250.00\nJustification: Critical rotating machinery, no alternate source\nDate: 2026-02-09`},
    transfer_book:{type:'USN_TRANSFER_BOOK',branch:'USN',text:`Transfer Book Entry\nUnit: Supply Department, USS Nimitz (CVN-68)\nAccount: OPTAR / EMRM\nJob Order: 68-2026-0195\nDescription: Transfer of ADP equipment to AIMD\nFrom: S-1 Division (Stock Control)\nTo: AIMD IM-3 Division\nQuantity: 12 laptops, 3 printers\nDocument Number: N68836-6026-0195\nApproved By: LCDR Torres, Supply Officer\nDate: 2026-02-11`}
};

let currentBranch = 'USN';
let selectedType = 'USN_SUPPLY_RECEIPT';
let sessionRecords = [];
let stats = {anchored:0,verified:0,types:new Set(),slsFees:0};

// ── localStorage cross-page record sync ──
const S4_STORAGE_KEY = 's4_anchored_records';
const S4_STATS_KEY = 's4_demo_stats';
function getLocalRecords() { try { return JSON.parse(localStorage.getItem(S4_STORAGE_KEY) || '[]'); } catch(e) { return []; } }
function saveLocalRecord(rec) { const records = getLocalRecords(); records.push(rec); localStorage.setItem(S4_STORAGE_KEY, JSON.stringify(records)); }
function saveStats() { localStorage.setItem(S4_STATS_KEY, JSON.stringify({anchored:stats.anchored,verified:stats.verified,types:[...stats.types],slsFees:stats.slsFees})); }
function loadStats() {
    try {
        const saved = JSON.parse(localStorage.getItem(S4_STATS_KEY) || 'null');
        if (saved) { stats.anchored = saved.anchored || 0; stats.verified = saved.verified || 0; stats.types = new Set(saved.types || []); stats.slsFees = saved.slsFees || 0; }
    } catch(e) {}
    // Also restore session records from localStorage
    const localRecs = getLocalRecords();
    sessionRecords = localRecs.map(r => ({
        type: r.record_type, label: r.record_label || r.record_type, icon: r.icon || '\uD83D\uDCCB',
        branch: r.branch || 'JOINT', hash: r.hash, txHash: r.tx_hash,
        encrypted: false, timestamp: r.timestamp, content: ''
    }));
    updateStats();
    updateTxLog();
}

async function sha256(text) {
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function copyHash(hash) {
    navigator.clipboard.writeText(hash).then(function() {
        document.querySelectorAll('.copy-btn').forEach(function(b) { b.innerHTML = '<i class="fas fa-check"></i> Copied!'; });
        setTimeout(function() { document.querySelectorAll('.copy-btn').forEach(function(b) { b.innerHTML = '<i class="fas fa-copy"></i> Copy'; }); }, 2000);
    });
}

function selectBranch(branch, el) {
    currentBranch = branch;
    document.querySelectorAll('.branch-tab').forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('typeSearch').value = '';
    renderTypeGrid();
}

function renderTypeGrid() {
    const grid = document.getElementById('recordTypeGrid');
    const search = (document.getElementById('typeSearch').value || '').toLowerCase();
    const types = Object.entries(RECORD_TYPES)
        .filter(([k,v]) => v.branch === currentBranch)
        .filter(([k,v]) => !search || v.label.toLowerCase().includes(search) || k.toLowerCase().includes(search));
    document.getElementById('branchTypeCount').textContent = '(' + types.length + ' types)';
    grid.innerHTML = types.map(([key,t]) =>
        '<div class="record-type-btn' + (key===selectedType?' selected':'') + '" data-type="'+key+'" onclick="selectType(\''+key+'\',this)" title="'+t.label+' \u2014 '+t.system+'"><span class="icon">'+t.icon+'</span>'+t.label+'</div>'
    ).join('');
}

function selectType(key, el) {
    selectedType = key;
    document.querySelectorAll('.record-type-btn').forEach(b => b.classList.remove('selected'));
    if (el) el.classList.add('selected');
    // Auto-populate textarea with sample content for this type
    const typeInfo = RECORD_TYPES[key];
    if (typeInfo) {
        const ta = document.getElementById('recordInput');
        if (!ta.value.trim() || ta.dataset.autoFilled === 'true') {
            ta.value = generateRecordSample(key, typeInfo);
            ta.dataset.autoFilled = 'true';
        }
    }
    // Show classification banner
    showClassificationBanner(key);
}

function generateRecordSample(key, info) {
    // Check if there's a matching SAMPLE entry
    for (const [sk, sv] of Object.entries(SAMPLES)) {
        if (sv.type === key) return sv.text;
    }
    // Generate a generic sample
    const ref = 'REF-2026-' + String(Math.floor(Math.random()*9000+1000));
    const clf = getClassification(key);
    const clfLabel = CLF_META[clf].label;
    return info.label + '\nBranch: ' + BRANCHES[info.branch].name
        + '\nSystem: ' + (info.system || 'N/A')
        + '\nClassification: ' + clfLabel
        + '\nReference: ' + ref
        + '\nDate: 2026-02-13'
        + '\nStatus: Complete / Inspected'
        + '\nAuthorized By: [Name/Rank]'
        + '\nFacility: [Location]'
        + '\nNotes: Enter detailed record content here';
}

function showClassificationBanner(typeKey) {
    const banner = document.getElementById('clfBanner');
    const clf = getClassification(typeKey);
    const meta = CLF_META[clf];
    banner.className = 'clf-banner show clf-' + clf;
    banner.querySelector('.clf-icon').textContent = meta.icon;
    document.getElementById('clfBadge').textContent = meta.label;
    document.getElementById('clfText').textContent = meta.desc;
}

function loadSample(key) {
    const s = SAMPLES[key];
    if (!s) return;
    const ta = document.getElementById('recordInput');
    ta.value = s.text;
    ta.dataset.autoFilled = 'true';
    if (s.branch !== currentBranch) {
        const tabs = document.querySelectorAll('.branch-tab');
        tabs.forEach(t => {
            if (t.textContent.toLowerCase().includes(BRANCHES[s.branch].short.toLowerCase())) {
                selectBranch(s.branch, t);
            }
        });
    }
    selectedType = s.type;
    renderTypeGrid();
    showClassificationBanner(s.type);
}

function animateValue(el, end, decimals) {
    const start = parseFloat(el.textContent) || 0;
    if (start === end) { el.textContent = decimals ? end.toFixed(decimals) : end; return; }
    const duration = 400;
    const startTime = performance.now();
    function step(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * eased;
        el.textContent = decimals ? current.toFixed(decimals) : Math.round(current);
        if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

function updateStats() {
    animateValue(document.getElementById('statAnchored'), stats.anchored);
    animateValue(document.getElementById('statVerified'), stats.verified);
    animateValue(document.getElementById('statTypes'), stats.types.size);
    animateValue(document.getElementById('statSlsFees'), stats.slsFees, 3);
}

function showAnchorAnimation(hash, typeLabel, clfLevel) {
    const overlay = document.getElementById('anchorOverlay');
    const meta = CLF_META[clfLevel] || CLF_META['CUI'];
    document.getElementById('animStatus').textContent = 'Anchoring to XRPL...';
    document.getElementById('animStatus').style.color = '';
    document.getElementById('animHash').textContent = hash;
    document.getElementById('animSuccess').textContent = '';
    // Show classification in animation
    const clfDiv = document.getElementById('animClf');
    if (clfDiv) {
        clfDiv.innerHTML = '<span style="padding:4px 14px;border-radius:6px;font-size:0.85rem;font-weight:800;letter-spacing:0.5px;color:' + meta.color + ';border:1px solid ' + meta.color + '30;background:' + meta.color + '15">' + meta.icon + ' ' + meta.label + '</span>';
        clfDiv.style.opacity = '0';
        clfDiv.style.animation = 'fadeUp 0.5s ease-out 0.7s both';
    }
    // Reset animations
    overlay.querySelectorAll('.chain-segment,.anchor-drop-icon,.anim-status,.anim-hash,.anim-fee,.anim-success').forEach(el => {
        el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    });
    overlay.classList.add('active');
    setTimeout(() => {
        document.getElementById('animStatus').textContent = '\u2705 ' + typeLabel + ' Anchored!';
        document.getElementById('animStatus').style.color = '#14f195';
        document.getElementById('animSuccess').textContent = '\u2713 Record secured on XRPL';
        document.getElementById('animSuccess').style.animation = 'scaleIn 0.4s ease-out both';
    }, 2000);
}

function hideAnchorAnimation() {
    document.getElementById('anchorOverlay').classList.remove('active');
}

async function anchorRecord() {
    const input = document.getElementById('recordInput').value.trim();
    if (!input) { alert('Please enter record content.'); return; }
    const btn = document.getElementById('anchorBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anchoring...';

    const encrypt = document.getElementById('encryptCheck').checked;
    const hash = await sha256(input);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    const typeInfo = RECORD_TYPES[selectedType] || {label:selectedType,icon:'\uD83D\uDCCB',branch:'JOINT'};

    const clfLevel = getClassification(selectedType);
    showAnchorAnimation(hash, typeInfo.label, clfLevel);

    // POST to API (best-effort)
    const apiData = {hash, record_type:selectedType, tx_hash:txHash, content_preview:input.substring(0,100)};
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(apiData)}); }
    catch(e) { console.warn('API anchor failed:', e); }

    const record = {
        type:selectedType, label:typeInfo.label, icon:typeInfo.icon, branch:typeInfo.branch,
        hash, txHash, encrypted:encrypt, timestamp:new Date().toISOString(),
        content:input.substring(0,100)+(input.length>100?'...':'')
    };
    sessionRecords.push(record);
    // Save to localStorage so Metrics & Transactions pages see it
    saveLocalRecord({
        hash, record_type: selectedType, record_label: typeInfo.label, branch: typeInfo.branch,
        icon: typeInfo.icon, timestamp: new Date().toISOString(),
        timestamp_display: new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC',
        fee: 0.01, tx_hash: txHash, system: typeInfo.system || 'N/A'
    });
    stats.anchored++;
    stats.types.add(selectedType);
    stats.slsFees += 0.01;
    updateStats();
    saveStats();

    await new Promise(r => setTimeout(r, 3200));
    hideAnchorAnimation();
    await new Promise(r => setTimeout(r, 400));

    const panel = document.getElementById('anchorResult');
    panel.innerHTML = '<div class="result-label">STATUS</div><div class="result-value" style="font-size:1rem;margin-bottom:0.8rem">\u2705 Record anchored successfully</div>'
        + '<div class="result-label">RECORD TYPE</div><div style="margin-bottom:0.5rem">' + record.icon + ' ' + typeInfo.label + ' (' + typeInfo.branch + ')</div>'
        + '<div class="result-label">CLASSIFICATION</div><div style="margin-bottom:0.5rem"><span style="padding:3px 12px;border-radius:6px;font-size:0.8rem;font-weight:800;letter-spacing:0.5px;color:' + CLF_META[clfLevel].color + ';border:1px solid ' + CLF_META[clfLevel].color + '30;background:' + CLF_META[clfLevel].color + '15">' + CLF_META[clfLevel].icon + ' ' + CLF_META[clfLevel].label + '</span> <span style="color:var(--muted);font-size:0.8rem;margin-left:6px">' + CLF_META[clfLevel].desc + '</span></div>'
        + '<div class="result-label">SHA-256 HASH</div><div class="hash-display">' + hash + '</div>'
        + '<div class="result-label">TX HASH</div><div style="color:var(--muted);margin-bottom:0.5rem;word-break:break-all">' + txHash + '</div>'
        + '<div class="result-label">SYSTEM</div><div style="margin-bottom:0.5rem">' + (typeInfo.system||'N/A') + '</div>'
        + '<div class="result-label">ENCRYPTED</div><div style="margin-bottom:0.5rem">' + (encrypt ? '\uD83D\uDD12 Yes (CUI protected)' : '\uD83D\uDD13 No (plaintext hash)') + '</div>'
        + '<div class="result-label">$SLS FEE</div><div>0.01 $SLS \u2192 Treasury</div>';
    panel.classList.add('show');
    updateTxLog();
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-anchor"></i> Anchor to XRPL';
}

async function verifyRecord() {
    const input = document.getElementById('verifyInput').value.trim();
    if (!input) { alert('Please enter record content.'); return; }
    const hash = await sha256(input);
    const expected = document.getElementById('verifyHash').value.trim();
    stats.verified++;
    updateStats();
    saveStats();
    const panel = document.getElementById('verifyResult');
    let matchHtml = '';
    if (expected) {
        const match = hash.toLowerCase() === expected.toLowerCase();
        matchHtml = '<div class="result-label">EXPECTED</div><div style="color:var(--muted);word-break:break-all;margin-bottom:0.5rem">' + expected + '</div>'
            + '<div class="result-label">MATCH</div><div class="result-value ' + (match?'':'error') + '" style="font-size:1.1rem">'
            + (match ? '\u2705 VERIFIED \u2014 Hashes match. Record integrity confirmed.' : '\u274C MISMATCH \u2014 Record altered or wrong hash.') + '</div>';
    }
    const sessionMatch = sessionRecords.find(r => r.hash === hash);
    let sessionHtml = '';
    if (sessionMatch) {
        sessionHtml = '<div class="result-label" style="margin-top:0.8rem">SESSION MATCH</div>'
            + '<div style="color:var(--green)">\u2705 Found in session \u2014 ' + sessionMatch.icon + ' ' + sessionMatch.label + ' anchored at ' + new Date(sessionMatch.timestamp).toLocaleTimeString() + '</div>';
    }
    panel.innerHTML = '<div class="result-label">COMPUTED SHA-256 <button class="copy-btn" onclick="copyHash(\'' + hash + '\')"><i class="fas fa-copy"></i> Copy</button></div><div class="hash-display">' + hash + '</div>' + matchHtml + sessionHtml
        + '<div style="margin-top:0.8rem;font-size:0.8rem;color:var(--muted)">To verify on-chain: compare this hash with the MemoData field of the anchor transaction.</div>';
    panel.classList.add('show');
}

function updateTxLog() {
    const log = document.getElementById('txLog');
    if (!sessionRecords.length) return;
    log.innerHTML = '';
    for (let i = sessionRecords.length - 1; i >= 0; i--) {
        const r = sessionRecords[i];
        const time = new Date(r.timestamp).toLocaleTimeString('en-US',{hour12:false});
        log.innerHTML += '<div class="tx-entry"><div class="tx-icon">' + r.icon + '</div><div class="tx-info"><div class="tx-type">' + r.label + ' <span style="color:var(--muted);font-size:0.75rem">(' + r.branch + ')</span></div><div class="tx-hash">' + r.hash.substring(0,32) + '...</div></div><div><span class="tx-badge anchored">Anchored</span><div class="tx-time">' + time + '</div></div></div>';
    }
}

// ═══ ILS Intelligence Engine v3 — Program-Specific Checklists & Document Analysis ═══
let ilsFiles = [];
let ilsResults = null;

// ── Per-Program ILS Checklists ──
// Each program has its own real-world checklist. Items: [id, label, critical(1/0), keyword_regex_string]
// PMS 300 — Service Craft (user-specified 17-item checklist used across YRBM, APL, AFDM, YDT, YON)
const _CL_PMS300 = [
    ['vrs_buylist','Vendor Recommended Spares and Buylist Development',1,'spare|buylist|vrs|vendor.*rec|provisioning|allowance'],
    ['crew_fam','Crew Familiarization',1,'crew.*fam|familiarization|crew.*train'],
    ['iuid','IUID Submissions',1,'iuid|unique.*ident|item.*unique'],
    ['transfer_book','Craft Transfer Book Development/Review',1,'transfer.*book|craft.*transfer|custody.*transfer'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust|sustainment.*plan'],
    ['config_inv','On-Site Parts/Material Inventory (Configuration Management)',1,'config.*mgmt|config.*manage|material.*inventory|parts.*inventory|on.?site.*inv'],
    ['ilsmt','ILSMT/Design or Production Meeting',1,'ilsmt|ils.*meet|design.*meet|production.*meet|logistics.*meet'],
    ['bam','Baseline Assessment Memorandum',1,'baseline.*assess|bam\\b|assessment.*memo'],
    ['outfit_wpn','Outfitting Navy Weapon Systems (If Applicable)',0,'outfitting.*weapon|weapon.*system.*outf|navy.*weapon'],
    ['ecp_waiver','Engineering Change Packages/Request for Waivers',1,'ecp|engineering.*change|waiver|request.*waiver|change.*package'],
    ['drl_review','DRL Reviews',1,'drl.*review|data.*require.*list|cdrl.*review|deliverable.*review'],
    ['cots_manuals','COTS Manuals Review/Submissions (Hard/Electronic Copy)',1,'cots.*manual|commercial.*manual|vendor.*manual|oem.*manual'],
    ['tm_status','Technical Manual Status/Submissions',1,'technical.*manual|tech.*manual|tm.*status|tm.*submit'],
    ['po_status','Purchase Order Status',1,'purchase.*order|po.*status|procurement.*order'],
    ['mat_sched','Material Ordering Schedule Completion',1,'material.*order|ordering.*sched|material.*sched|mat.*order'],
    ['mel','Master Equipment List Submittal',1,'master.*equip|mel\\b|equipment.*list'],
    ['outfit_stats','Outfitting Statistics (GFE, Materials, etc.)',0,'outfitting.*stat|gfe|government.*furnish|outfit.*stat']
];

// DDG-51 Flight III (PMS 400D) — Major Surface Combatant
const _CL_DDG51 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics.*support.*plan'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['pms_dev','PMS/MRC Development & Validation',1,'pms.*dev|mrc|maintenance.*requirement.*card|planned.*maint'],
    ['supply','Supply Support / Provisioning Plan',1,'supply.*support|provisioning|allowance|cosal'],
    ['vrs','Vendor Recommended Spares / Initial Outfitting',1,'vendor.*spare|vrs|initial.*outfit'],
    ['cosal','COSAL / APL Development',1,'cosal|allowance.*part.*list|apl\\b'],
    ['se','Support Equipment Requirements',1,'support.*equip|se.*req|test.*equip'],
    ['tm','Technical Manual Development (NAVSEA Format)',1,'technical.*manual|navsea.*format|tech.*manual'],
    ['ietm','Interactive Electronic Technical Manuals (IETM)',1,'ietm|interactive.*electronic|electronic.*tech.*manual'],
    ['training','Training Plan / Fleet Introduction Team (FIT)',1,'training.*plan|fleet.*intro|fit\\b.*team'],
    ['manpower','Manpower & Personnel Integration',0,'manpower|personnel.*integ'],
    ['compres','Computer Resources Life Cycle Mgmt Plan',0,'computer.*resour|lcmp|software.*support'],
    ['facilities','Facilities Requirements',0,'facilit.*req'],
    ['phst','PHS&T Analysis & Plan',0,'phs.?t|packaging|handling|storage|transport'],
    ['design','Design Interface / Supportability Analysis',1,'design.*interface|supportability'],
    ['ram','RAM Analysis / Operational Availability',1,'ram\\b|reliab|availab|maintainab|fmeca'],
    ['config','Configuration Status Accounting',1,'config.*status|config.*account|configuration'],
    ['ecp','Engineering Change Proposals / Waivers',1,'ecp|engineering.*change|waiver'],
    ['interim','Interim Support / Contractor Logistics Support (CLS)',0,'interim.*support|cls\\b|contractor.*logist'],
    ['src','Source/Repair Coding',1,'source.*repair|src\\b|repair.*cod'],
    ['dmsms','Diminishing Manufacturing Sources (DMSMS)',0,'dmsms|diminishing|obsolescen'],
    ['drl','DRL/CDRL Tracking & Reviews',1,'drl|cdrl|deliverable.*review']
];

// LCS (PMS 501) — Littoral Combat Ship (unique: mission modules, crew rotation)
const _CL_LCS = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['mm_ils','Mission Module ILS Integration',1,'mission.*module|mm\\b.*ils|module.*logist'],
    ['pms_dev','PMS/MRC Development',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment (Ship + Modules)',1,'support.*equip'],
    ['tm','Technical Manual Development',1,'technical.*manual|tech.*manual'],
    ['training','Training Plan / Crew Rotation Model',1,'training|crew.*rotat'],
    ['ram','RAM Analysis / Mission Capability',1,'ram\\b|reliab|mission.*capab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Changes / Waivers',1,'ecp|engineering.*change|waiver'],
    ['cls','Contractor Logistics Support (CLS) Plan',1,'cls\\b|contractor.*logist'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable.*review'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen'],
    ['src','Source/Repair Coding',0,'source.*repair|repair.*cod']
];

// CVN-78 (PMS 378) — Aircraft Carrier (nuclear propulsion, EMALS, massive logistics)
const _CL_CVN78 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['pms_dev','PMS/MRC Development & Validation',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares / Initial Outfitting',1,'vendor.*spare|vrs|initial.*outf'],
    ['cosal','COSAL Development',1,'cosal|allowance.*part'],
    ['se','Support Equipment Requirements',1,'support.*equip'],
    ['tm','Technical Manual Suite (NAVSEA Format)',1,'technical.*manual|tech.*manual'],
    ['ietm','IETM Development',1,'ietm|interactive.*electronic'],
    ['training','Training Plan / Fleet Introduction',1,'training.*plan|fleet.*intro'],
    ['manpower','Manpower & Personnel Integration',1,'manpower|personnel'],
    ['compres','Computer Resources Life Cycle Mgmt',1,'computer.*resour|lcmp'],
    ['facilities','Facilities / Shore Infrastructure',1,'facilit|shore.*infra'],
    ['phst','PHS&T Analysis',1,'phs.?t|packaging|handling'],
    ['design','Design Interface / Supportability',1,'design.*interface|supportability'],
    ['ram','RAM / Operational Availability',1,'ram\\b|reliab|operational.*avail'],
    ['config','Configuration Status Accounting',1,'config.*status|configuration'],
    ['ecp','Engineering Change Proposals',1,'ecp|engineering.*change'],
    ['nuc_cert','Nuclear Propulsion Logistics Certification',1,'nuclear|nuc.*cert|propulsion.*cert'],
    ['emals','EMALS/AAG System Logistics',1,'emals|aag|launch.*system|recovery.*system'],
    ['interim','Interim Support / CLS',0,'interim.*support|cls\\b'],
    ['src','Source/Repair Coding',1,'source.*repair|repair.*cod'],
    ['dmsms','DMSMS Management',1,'dmsms|diminishing|obsolescen'],
    ['drl','DRL/CDRL Tracking & Reviews',1,'drl|cdrl|deliverable']
];

// FFG-62 (PMS 515) — Constellation-class Frigate (parent design adaptation is unique)
const _CL_FFG62 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['parent_design','Parent Design ILS Data Adaptation (FREMM)',1,'parent.*design|fremm|adaptation|foreign.*design'],
    ['pms_dev','PMS/MRC Development',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment Requirements',1,'support.*equip'],
    ['tm','Technical Manual Development',1,'technical.*manual|tech.*manual'],
    ['training','Training Plan / Fleet Introduction',1,'training.*plan|fleet.*intro'],
    ['ram','RAM Analysis',1,'ram\\b|reliab|maintainab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Change Proposals',1,'ecp|engineering.*change|waiver'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['manpower','Manpower & Personnel',0,'manpower|personnel'],
    ['compres','Computer Resources',0,'computer.*resour|lcmp'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['src','Source/Repair Coding',1,'source.*repair|repair.*cod'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// LPD-17 (PMS 317) — San Antonio-class Amphibious Transport Dock (well deck, aviation)
const _CL_LPD17 = [
    ['ilsp','Integrated Logistics Support Plan (ILSP)',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan (LCSP)',1,'lcsp|life.*cycle.*sust'],
    ['lora','Level of Repair Analysis (LORA)',1,'lora|level.*repair'],
    ['pms_dev','PMS/MRC Development',1,'pms.*dev|mrc|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['cosal','COSAL Development',1,'cosal|allowance.*part'],
    ['se','Support Equipment',1,'support.*equip'],
    ['tm','Technical Manual Development',1,'technical.*manual|tech.*manual'],
    ['training','Training Plan / Fleet Introduction',1,'training.*plan|fleet.*intro'],
    ['well_deck','Well Deck / Craft Interface Logistics',1,'well.*deck|craft.*interface|lcac|lcu'],
    ['aviation','Aviation Facility Logistics',1,'aviation.*facility|flight.*deck|helo'],
    ['ram','RAM Analysis',1,'ram\\b|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Changes / Waivers',1,'ecp|engineering.*change|waiver'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['manpower','Manpower & Personnel',0,'manpower|personnel'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['src','Source/Repair Coding',1,'source.*repair|repair.*cod'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// F-35C/B (PMA-265 / JSF PO) — Naval/USMC Tactical Aircraft (ODIN/ALIS unique)
const _CL_F35NAVY = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['odin','Autonomic Logistics (ODIN/ALIS) Sustainment',1,'odin|alis|autonomic.*logist'],
    ['supply','Supply Chain Management / Global Spares Pool',1,'supply.*chain|global.*spare|spares.*pool'],
    ['depot','Depot Activation / MRO&U Planning',1,'depot.*activ|mro|overhaul.*plan'],
    ['tm','Technical Data (IETM) via ODIN',1,'technical.*data|ietm|odin.*pub'],
    ['training','Pilot & Maintainer Training Courseware',1,'pilot.*train|maintainer.*train|training.*course'],
    ['phm','Prognostic Health Management (PHM)',1,'prognostic|phm|health.*manage|condition.*based'],
    ['ram','RAM / Mission Capable Rate Analysis',1,'ram\\b|mission.*capable|mc.*rate|reliab'],
    ['config','Configuration Mgmt / Software Baseline',1,'config.*manage|software.*baseline|configuration'],
    ['se','Support Equipment / Aerospace Ground Equipment',1,'support.*equip|age\\b|aerospace.*ground'],
    ['facilities','Facilities / Hangar Requirements',1,'facilit|hangar.*req'],
    ['manpower','Manpower Estimate Report',0,'manpower|personnel'],
    ['phst','PHS&T / Transportability',0,'phs.?t|transport'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['pbl','Performance-Based Logistics (PBL) / CLS',1,'pbl|performance.*based|cls\\b|contractor.*logist'],
    ['dmsms','DMSMS / Obsolescence Management',1,'dmsms|diminishing|obsolescen'],
    ['lo','Low-Observable Maintenance (F-35B/C specific)',0,'low.*observ|stealth|lo\\b.*maint|signature']
];

// CH-53K (PMA-261) — Heavy-Lift Helicopter
const _CL_CH53K = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['pms','Maintenance Plan / PMS Development',1,'maint.*plan|pms.*dev|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment / Ground Support',1,'support.*equip|ground.*support|gse'],
    ['tm','Technical Manuals (IETM)',1,'technical.*manual|ietm'],
    ['training','Training Systems / Simulators',1,'training.*system|simulator|crew.*train'],
    ['ram','RAM Analysis / Mission Capable Rate',1,'ram\\b|mission.*capable|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Change Proposals',1,'ecp|engineering.*change'],
    ['drl','DRL/CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['facilities','Facility Requirements / Hangar Modifications',0,'facilit|hangar'],
    ['phst','PHS&T Plan',0,'phs.?t|packaging'],
    ['cls','Contractor Logistics Support Transition',0,'cls\\b|contractor.*logist|transition'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// M1A2 Abrams SEPv3 (PEO GCS) — Main Battle Tank (Army LSA-based)
const _CL_M1 = [
    ['lsa','Logistics Support Analysis (LSA)',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart (MAC)',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List (RPSTL)',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (TM 9-series)',1,'technical.*manual|tm.*9|army.*tm'],
    ['net','New Equipment Training (NET) Plan',1,'new.*equip.*train|net\\b.*plan|net\\b.*team'],
    ['provisioning','Provisioning Plan / ASL Development',1,'provisioning|asl\\b.*dev|authorized.*stockage'],
    ['tmde','Test, Measurement & Diagnostic Equipment (TMDE)',1,'tmde|test.*measure|diagnostic.*equip'],
    ['manprint','MANPRINT Assessment',1,'manprint|human.*factor|human.*system'],
    ['ram','RAM Analysis / Ao Requirements',1,'ram\\b|reliab|operational.*avail'],
    ['config','Configuration Management / ECP Tracking',1,'config.*manage|ecp|engineering.*change'],
    ['transport','Transportability Assessment (Rail/Air/Sea)',1,'transportab|rail.*load|air.*transport|sea.*transport'],
    ['depot','Depot Maintenance Work Requirements (DMWR)',1,'depot.*maint|dmwr|organic.*maint'],
    ['pbl','Performance-Based Logistics (PBL) Metrics',0,'pbl|performance.*based'],
    ['hazmat','HAZMAT / Environmental Compliance',0,'hazmat|environment|hazardous.*material'],
    ['dmsms','DMSMS / Obsolescence Management',0,'dmsms|diminishing|obsolescen'],
    ['warranty','Warranty Tracking & Administration',0,'warranty|tracking.*admin']
];

// Stryker ICV-VA1 (PM Stryker) — Infantry Combat Vehicle
const _CL_STRYKER = [
    ['lsa','Logistics Support Analysis (LSA)',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart (MAC)',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List (RPSTL)',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (TM 9-series)',1,'technical.*manual|tm.*9'],
    ['net','New Equipment Training (NET)',1,'new.*equip.*train|net\\b.*plan'],
    ['provisioning','Provisioning / ASL',1,'provisioning|asl\\b|authorized.*stockage'],
    ['tmde','TMDE / Special Tools',1,'tmde|special.*tool|test.*equip'],
    ['manprint','MANPRINT Assessment',0,'manprint|human.*factor'],
    ['ram','RAM / Operational Readiness',1,'ram\\b|reliab|operational.*read'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['transport','Transportability (C-17/C-130 Compatibility)',1,'transportab|c.?17|c.?130|airlift'],
    ['depot','Depot Maintenance Planning',1,'depot.*maint|organic.*maint'],
    ['pbl','Performance-Based Logistics',0,'pbl|performance.*based'],
    ['fielding','Fielding Plan / BOIP',1,'fielding|boip|basis.*issue'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// AH-64E Apache Guardian (PEO Aviation) — Attack Helicopter
const _CL_AH64 = [
    ['lsa','Logistics Support Analysis',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart (MAC)',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (Aviation TMs)',1,'technical.*manual|aviation.*tm'],
    ['phase','Aircraft Maintenance / Phase Inspections',1,'phase.*inspect|aircraft.*maint|periodic.*inspect'],
    ['net','Pilot/Crew Training (NET)',1,'pilot.*train|crew.*train|net\\b.*plan'],
    ['simulator','Training Devices / Simulator Support',1,'simulator|training.*device|synthetic.*train'],
    ['provisioning','Provisioning / ASL',1,'provisioning|asl\\b|authorized.*stockage'],
    ['gse','Ground Support Equipment (GSE)',1,'ground.*support|gse|support.*equip'],
    ['ram','RAM / Mission Capable Rate',1,'ram\\b|mission.*capable|reliab'],
    ['config','Configuration Management / MOD Programs',1,'config.*manage|modification.*program|mod\\b.*program'],
    ['depot','Depot / AVIM / AVUM Planning',1,'depot|avim|avum|aviation.*maint'],
    ['phst','PHS&T / Transportability',0,'phs.?t|transportab'],
    ['dmsms','DMSMS / Obsolescence',0,'dmsms|diminishing|obsolescen'],
    ['pbl','Performance-Based Logistics (PBL)',0,'pbl|performance.*based']
];

// M142 HIMARS (PEO Missiles & Space) — Rocket Artillery
const _CL_HIMARS = [
    ['lsa','Logistics Support Analysis',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals (TM 9-series)',1,'technical.*manual|tm.*9'],
    ['ammo','Ammunition Logistics / QASAS Coordination',1,'ammo|ammunit|qasas|munition|rocket.*pod'],
    ['net','New Equipment Training (NET)',1,'new.*equip.*train|net\\b'],
    ['provisioning','Provisioning Plan',1,'provisioning|asl\\b'],
    ['tmde','TMDE / Support Equipment',1,'tmde|support.*equip|test.*equip'],
    ['ram','RAM / System Readiness',1,'ram\\b|reliab|system.*read'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['transport','Transportability (C-130 / LMSR)',1,'transportab|c.?130|lmsr|airlift'],
    ['depot','Depot Maintenance Work Requirements',0,'depot.*maint|dmwr'],
    ['fms','Foreign Military Sales (FMS) Support',0,'fms|foreign.*military|security.*cooperat'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// F-35A Lightning II (USAF) — Conventional Takeoff Fighter
const _CL_F35A = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['odin','ODIN / Autonomic Logistics Information System',1,'odin|alis|autonomic.*logist'],
    ['tos','Technical Orders (TO) Development',1,'technical.*order|to\\b.*develop|tech.*order'],
    ['supply','Supply Chain / Global Spares Pool',1,'supply.*chain|global.*spare|spares.*pool'],
    ['depot','Depot Activation / Organic Capability',1,'depot.*activ|organic.*capab|depot.*standup'],
    ['age','Aerospace Ground Equipment (AGE)',1,'aerospace.*ground|age\\b|ground.*equip'],
    ['training','Aircrew & Maintainer Training',1,'aircrew.*train|maintainer.*train|training'],
    ['facilities','Facilities / Hangar Requirements',1,'facilit|hangar'],
    ['phm','Prognostic Health Management',1,'prognostic|phm|health.*manage|condition.*based'],
    ['ram','RAM / Mission Capable Rate',1,'ram\\b|mission.*capable|mc.*rate|reliab'],
    ['config','Configuration / Software Baseline Mgmt',1,'config.*manage|software.*baseline|configuration'],
    ['pbl','Performance-Based Logistics (PBL)',1,'pbl|performance.*based'],
    ['drl','CDRL / Deliverable Reviews',1,'cdrl|drl|deliverable'],
    ['manpower','Manpower Estimate / LCOM',0,'manpower|lcom|logistics.*composite'],
    ['phst','PHS&T / Transportability',0,'phs.?t|transportab'],
    ['dmsms','DMSMS / Obsolescence',0,'dmsms|diminishing|obsolescen']
];

// KC-46A Pegasus (USAF) — Aerial Refueling Tanker
const _CL_KC46 = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['rcm','Reliability Centered Maintenance (RCM)',1,'rcm|reliability.*centered|maint.*steering'],
    ['tos','Technical Orders Development',1,'technical.*order|to\\b.*develop|tech.*order'],
    ['supply','Supply Chain Management',1,'supply.*chain|provisioning'],
    ['depot','Depot-Level Maintenance / PDM',1,'depot.*maint|pdm|programmed.*depot'],
    ['age','Aerospace Ground Equipment',1,'aerospace.*ground|age\\b|ground.*equip'],
    ['training','Aircrew & Maintainer Training',1,'aircrew.*train|maintainer.*train|training'],
    ['boom','Boom Operator / Refueling System Logistics',1,'boom.*oper|refueling.*system|aerial.*refuel'],
    ['ram','RAM / Availability Analysis',1,'ram\\b|reliab|availab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['drl','CDRL Reviews',1,'cdrl|drl|deliverable'],
    ['pbl','Performance-Based Logistics',0,'pbl|performance.*based'],
    ['facilities','Facilities Assessment',0,'facilit'],
    ['phst','PHS&T',0,'phs.?t|transport'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// B-21 Raider (USAF) — Long-Range Strike Bomber (stealth, classified elements)
const _CL_B21 = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['lsa','Logistics Supportability Analysis',1,'lsa\\b|logistics.*supportab'],
    ['tos','Technical Orders / IETM Development',1,'technical.*order|ietm|tech.*order'],
    ['supply','Supply Chain / Provisioning',1,'supply.*chain|provisioning'],
    ['depot','Depot Activation / Organic Maintenance',1,'depot.*activ|organic.*maint'],
    ['age','Aerospace Ground Equipment',1,'aerospace.*ground|age\\b|ground.*equip'],
    ['training','Training Systems / Simulators',1,'training.*system|simulator'],
    ['ram','RAM / Stealth Sustainment Metrics',1,'ram\\b|reliab|stealth.*sust|lre'],
    ['config','Configuration Management / SCN',1,'config.*manage|scn|software.*change'],
    ['lo_maint','Low-Observable (LO) Maintenance & Materials',1,'low.*observ|lo\\b.*maint|stealth.*maint|signature'],
    ['facilities','Secure Facilities Requirements',1,'secure.*facilit|scif|classified.*facilit'],
    ['cyber','Cybersecurity / Mission Systems Logistics',1,'cyber|mission.*system.*logist|information.*assur'],
    ['drl','CDRL Reviews',1,'cdrl|drl|deliverable'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen'],
    ['phst','PHS&T',0,'phs.?t|transport']
];

// C-17 Globemaster III (USAF) — Strategic Airlift
const _CL_C17 = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['rcm','Reliability Centered Maintenance (RCM)',1,'rcm|reliability.*centered'],
    ['tos','Technical Orders',1,'technical.*order|tech.*order'],
    ['supply','Supply Chain / DLA Coordination',1,'supply.*chain|dla\\b|provisioning'],
    ['pdm','Programmed Depot Maintenance (PDM)',1,'pdm|programmed.*depot|depot.*maint'],
    ['age','Aerospace Ground Equipment',1,'aerospace.*ground|age\\b'],
    ['training','Aircrew & Maintainer Training',1,'aircrew.*train|maintainer.*train|training'],
    ['ram','RAM / Mission Capable Rate',1,'ram\\b|mission.*capable|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['drl','CDRL / Sustainment Reviews',1,'cdrl|drl|deliverable'],
    ['asip','Structural Life / ASIP Compliance',1,'asip|structural.*life|aircraft.*structural|fatigue'],
    ['dmsms','DMSMS / Aging Aircraft Sustainment',1,'dmsms|diminishing|aging.*aircraft|obsolescen'],
    ['pbl','Performance-Based Logistics',0,'pbl|performance.*based'],
    ['facilities','Facilities',0,'facilit'],
    ['phst','PHS&T',0,'phs.?t|transport']
];

// GPS III/IIIF (Space Systems Command) — Navigation Satellite
const _CL_USSF = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['ground_se','Ground Segment Support Equipment',1,'ground.*segment|ground.*equip|ops.*center'],
    ['sat_ops','Satellite Operations Sustainment',1,'satellite.*ops|on.?orbit|spacecraft.*ops'],
    ['supply','Supply Chain / Unique Space Parts',1,'supply.*chain|space.*parts|unique.*component'],
    ['training','Operator & Maintainer Training',1,'operator.*train|maintainer.*train|training'],
    ['cyber','Cybersecurity / Space Resilience Logistics',1,'cyber|space.*resilien|information.*assur'],
    ['ram','RAM / On-Orbit Reliability',1,'ram\\b|on.?orbit.*reliab|reliab'],
    ['config','Configuration / Firmware Version Control',1,'config.*manage|firmware|version.*control'],
    ['launch','Launch Operations Logistics',1,'launch.*ops|launch.*logist|launch.*integrat'],
    ['drl','CDRL / Deliverable Reviews',1,'cdrl|drl|deliverable'],
    ['facilities','Ground Station Facilities',0,'ground.*station|facilit'],
    ['dmsms','DMSMS / Component Availability',0,'dmsms|diminishing|component.*avail'],
    ['disposal','End-of-Life / Deorbit Planning',0,'end.*life|deorbit|disposal']
];

// USCG Cutters (CG-9325) — NSC, OPC, FRC
const _CL_USCG = [
    ['ilsp','Integrated Logistics Support Plan',1,'ilsp|integrated.*logistics'],
    ['lcsp','Life Cycle Sustainment Plan',1,'lcsp|life.*cycle.*sust'],
    ['pms','PMS / Maintenance Plan Development',1,'pms\\b|maint.*plan|planned.*maint'],
    ['supply','Supply Support / Provisioning',1,'supply.*support|provisioning'],
    ['vrs','Vendor Recommended Spares',1,'vendor.*spare|vrs'],
    ['se','Support Equipment',1,'support.*equip'],
    ['tm','Technical Manuals (CG Format)',1,'technical.*manual|tech.*manual|cg.*manual'],
    ['training','Training Plan / Crew Familiarization',1,'training.*plan|crew.*familiar'],
    ['ram','RAM Analysis',1,'ram\\b|reliab'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['ecp','Engineering Changes / Waivers',1,'ecp|engineering.*change|waiver'],
    ['drl','DRL / CDRL Reviews',1,'drl|cdrl|deliverable'],
    ['c4isr','C4ISR / Mission Systems Logistics',1,'c4isr|mission.*system|command.*control'],
    ['phst','PHS&T',0,'phs.?t|packaging'],
    ['facilities','Homeport Facilities',0,'homeport|facilit']
];

// ACV 1.1 (PEO Land Systems, USMC) — Amphibious Combat Vehicle
const _CL_ACV = [
    ['lsa','Logistics Support Analysis',1,'lsa\\b|logistics.*support.*analy'],
    ['mac','Maintenance Allocation Chart',1,'mac\\b|maintenance.*alloc'],
    ['rpstl','Repair Parts & Special Tools List',1,'rpstl|repair.*parts|special.*tools'],
    ['tm','Technical Manuals',1,'technical.*manual|tech.*manual'],
    ['amphib','Amphibious Ship Interface Logistics',1,'amphibi|ship.*interface|well.*deck|l-class'],
    ['net','New Equipment Training / MOS Training',1,'new.*equip.*train|mos\\b|net\\b.*plan'],
    ['provisioning','Provisioning / Block Requirements',1,'provisioning|block.*req'],
    ['se','Support Equipment / Combat Service Support',1,'support.*equip|combat.*service'],
    ['ram','RAM / Operational Readiness',1,'ram\\b|reliab|operational.*read'],
    ['config','Configuration Management',1,'config.*manage|configuration'],
    ['waterborne','Waterborne / Swim Operations Logistics',1,'waterborne|swim.*ops|water.*ops|surf.*zone'],
    ['ecp','Engineering Changes',1,'ecp|engineering.*change'],
    ['drl','CDRL Reviews',1,'cdrl|drl|deliverable'],
    ['phst','PHS&T / Embarkation',0,'phs.?t|embark'],
    ['dmsms','DMSMS Management',0,'dmsms|diminishing|obsolescen']
];

// Custom / Generic — minimal baseline
const _CL_CUSTOM = [
    ['ilsp','Logistics Support Plan',1,'ilsp|logistics.*support.*plan'],
    ['maint','Maintenance Planning',1,'maint.*plan|maintenance'],
    ['supply','Supply Support',1,'supply|provisioning|spare'],
    ['tm','Technical Data / Manuals',1,'technical.*manual|tech.*data|publication'],
    ['training','Training',0,'training|instruction'],
    ['ram','RAM Analysis',0,'ram\\b|reliab|maintainab'],
    ['config','Configuration Management',0,'config.*manage|configuration'],
    ['drl','Deliverable Tracking',0,'drl|cdrl|deliverable']
];

// Map every program to its checklist
const _CL_MAP = {
    yrbm:_CL_PMS300, apl:_CL_PMS300, afdm:_CL_PMS300, ydt:_CL_PMS300, yon:_CL_PMS300,
    ddg51:_CL_DDG51, lcs:_CL_LCS, cvn78:_CL_CVN78, ffg62:_CL_FFG62, lpd17:_CL_LPD17,
    f35:_CL_F35NAVY, f35b:_CL_F35NAVY, ch53k:_CL_CH53K,
    m1:_CL_M1, stryker:_CL_STRYKER, ah64:_CL_AH64, himars:_CL_HIMARS,
    f35a:_CL_F35A, kc46:_CL_KC46, b21:_CL_B21, c17:_CL_C17,
    gps3:_CL_USSF, sbirs:_CL_USSF,
    nsc:_CL_USCG, opc:_CL_USCG, frc:_CL_USCG,
    acv:_CL_ACV,
    custom:_CL_CUSTOM
};

function getCL(key) { return (_CL_MAP[key]||_CL_CUSTOM).map(a=>({id:a[0],l:a[1],c:a[2],kw:new RegExp(a[3],'i')})); }

const DI_MAP = {
    'DI-ILSS-81490':'ilsmgmt','DI-ILSS-81494':'maint','DI-ILSS-81492':'maint',
    'DI-ILSS-81493':'supply','DI-ILSS-81495':'supply','DI-ILSS-81496':'supply','DI-ILSS-81497':'supply',
    'DI-SESS-81519':'se','DI-TMSS-81000':'techdata','DI-TMSS-80063':'techdata','DI-TMSS-80000':'techdata',
    'DI-TRAN-81476':'training','DI-HFAC-80743':'manpower','DI-MCCR-80030':'compres',
    'DI-FACI-80931':'facilities','DI-PACK-80886':'phst','DI-MISC-80711':'design',
    'DI-RELI-80255':'ram','DI-RELI-81372':'ram','DI-CMAN-81250':'config','DI-CMAN-80858':'config',
    'DI-MGMT-81466':'ilsmgmt','DI-ALSS-81530':'lsa','DI-ALSS-81529':'lsa',
    'DI-TMSS-80897':'techdata','DI-TMSS-81114':'techdata'
};

const OWNERS = {
    ilsmgmt:{p:'PMS / Program Office',s:'Contractor'},maint:{p:'Contractor (ILS)',s:'NAVSEA / SUPSHIP'},
    supply:{p:'Contractor (Provisioning)',s:'NAVSUP / DLA'},se:{p:'Contractor',s:'NAVSEA'},
    techdata:{p:'Contractor (Tech Pubs)',s:'NSWCCD / PMS'},training:{p:'NETC / Contractor',s:'PMS'},
    manpower:{p:'OPNAV N1 / PMS',s:'Contractor'},compres:{p:'Contractor',s:'NAVWAR / PMS'},
    facilities:{p:'NAVFAC',s:'PMS'},phst:{p:'Contractor',s:'NAVSEA / PMS'},
    design:{p:'Contractor (Engineering)',s:'NAVSEA'},ram:{p:'Contractor',s:'NAVSEA / PMS'},
    config:{p:'Contractor (CM)',s:'PMS / NAVSEA'},lsa:{p:'Contractor (LSA)',s:'PM / PEO'},
    depot:{p:'Organic Depot / DLA',s:'PM'},cyber:{p:'Contractor (Cyber)',s:'NAVWAR / DISA'}
};

const COST_K = {ilsmgmt:45,maint:120,supply:250,se:80,techdata:150,training:60,manpower:35,
    compres:25,facilities:40,phst:30,design:55,ram:95,config:110,lsa:80,depot:200,cyber:65};

// ── Program DRL Templates ──
const PROGS = {
    yrbm:{name:'YRBM \u2014 Yard Repair, Berthing & Messing',ofc:'PMS 300',type:'Service Craft (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System (PMS) Development',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81496',t:'Allowance Parts List (APL)',el:'supply',c:1},
        {s:'A006',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operator/Crew',el:'techdata',c:1},
        {s:'A007',di:'DI-TMSS-80063',t:'Technical Manual Content Verification',el:'techdata',c:0},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Status Accounting Report',el:'config',c:1},
        {s:'A009',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:0},
        {s:'A010',di:'DI-TRAN-81476',t:'Training Plan (Crew Familiarization)',el:'training',c:0},
        {s:'A011',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A012',di:'DI-RELI-80255',t:'RAM Analysis / Reliability Report',el:'ram',c:1},
        {s:'A013',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A014',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:0},
        {s:'A015',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    apl:{name:'APL \u2014 Auxiliary Personnel Lighter',ofc:'PMS 300',type:'Service Craft (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting Report',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:0},
        {s:'A008',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    afdm:{name:'AFDM \u2014 Auxiliary Floating Drydock Medium',ofc:'PMS 300',type:'Floating Drydock',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis (LORA)',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-ILSS-81497',t:'Supply Support Request',el:'supply',c:0},
        {s:'A008',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Ops & Maintenance',el:'techdata',c:1},
        {s:'A009',di:'DI-TMSS-80063',t:'Technical Manual Content Verification',el:'techdata',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A011',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:1},
        {s:'A012',di:'DI-SESS-81519',t:'Support Equipment \u2014 Ballast/Crane Systems',el:'se',c:1},
        {s:'A013',di:'DI-TRAN-81476',t:'Training Plan \u2014 Operations & Safety',el:'training',c:1},
        {s:'A014',di:'DI-RELI-80255',t:'RAM Analysis Report',el:'ram',c:1},
        {s:'A015',di:'DI-RELI-81372',t:'Failure Reporting (FRACAS)',el:'ram',c:0},
        {s:'A016',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:0},
        {s:'A017',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A018',di:'DI-HFAC-80743',t:'Manpower & Personnel Report',el:'manpower',c:0},
        {s:'A019',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:1},
        {s:'A020',di:'DI-MCCR-80030',t:'Computer Resources LCMP',el:'compres',c:0},
        {s:'A021',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    ydt:{name:'YDT \u2014 Large Harbor Tug',ofc:'PMS 300',type:'Service Craft (Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations & Propulsion',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan \u2014 Crew Operations',el:'training',c:1},
        {s:'A008',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0},
        {s:'A012',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:0}
    ]},
    yon:{name:'YON \u2014 Fuel Oil Barge',ofc:'PMS 300',type:'Fuel Barge (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations & Safety',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Safety & Hazmat Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-PACK-80886',t:'PHS&T Plan (Fuel Handling)',el:'phst',c:1},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    ddg51:{name:'DDG-51 Flight III (Arleigh Burke)',ofc:'PMS 400D',type:'Guided Missile Destroyer',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-TMSS-81000',t:'Technical Manuals (Full Suite)',el:'techdata',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A009',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:1},
        {s:'A010',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A011',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A012',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A013',di:'DI-RELI-81372',t:'Failure Reporting (FRACAS)',el:'ram',c:1},
        {s:'A014',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:1},
        {s:'A015',di:'DI-MCCR-80030',t:'Computer Resources LCMP',el:'compres',c:1},
        {s:'A016',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:0},
        {s:'A017',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A018',di:'DI-MISC-80711',t:'Design Interface',el:'design',c:1},
        {s:'A019',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    lcs:{name:'LCS Freedom-class',ofc:'PMS 501',type:'Littoral Combat Ship',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:0},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    cvn78:{name:'CVN-78 Ford-class',ofc:'PMS 378',type:'Aircraft Carrier',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-ILSS-81497',t:'Supply Support Request',el:'supply',c:1},
        {s:'A008',di:'DI-TMSS-81000',t:'Technical Manuals (Complete)',el:'techdata',c:1},
        {s:'A009',di:'DI-TMSS-80063',t:'TM Verification',el:'techdata',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A011',di:'DI-CMAN-80858',t:'ECPs',el:'config',c:1},
        {s:'A012',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A013',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A014',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A015',di:'DI-RELI-81372',t:'FRACAS',el:'ram',c:1},
        {s:'A016',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:1},
        {s:'A017',di:'DI-MCCR-80030',t:'Computer Resources',el:'compres',c:1},
        {s:'A018',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:1},
        {s:'A019',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A020',di:'DI-MISC-80711',t:'Design Interface',el:'design',c:1},
        {s:'A021',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ]},
    ffg62:{name:'FFG-62 Constellation-class',ofc:'PMS 515',type:'Guided Missile Frigate',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A010',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    lpd17:{name:'LPD-17 San Antonio-class',ofc:'PMS 317',type:'Amphibious Transport Dock',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:0},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    f35:{name:'F-35C Lightning II',ofc:'PMA-265 / JSF PO',type:'Carrier-Based Strike Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan / ALIS Requirements',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (IETM)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / PHM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ALIS / ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    f35b:{name:'F-35B Lightning II (STOVL)',ofc:'PMA-265 / JSF PO',type:'STOVL Strike Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (IETM)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / PHM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    ch53k:{name:'CH-53K King Stallion',ofc:'PMA-261',type:'Heavy-Lift Helicopter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ]},
    m1:{name:'M1A2 Abrams SEPv3',ofc:'PEO GCS',type:'Main Battle Tank',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis (LSA)',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'LSAR Data / MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Technical Manuals (TM 9-2350)',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Plan / ASL',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Repair Parts & Special Tools List',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'New Equipment Training (NET) Plan',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'TMDE Requirements',el:'se',c:1},
        {s:'A008',di:'DI-HFAC-80743',t:'MANPRINT Assessment',el:'manpower',c:1},
        {s:'A009',di:'DI-RELI-80255',t:'RAM / Ao Analysis',el:'ram',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Management / ECPs',el:'config',c:1},
        {s:'A011',di:'DI-PACK-80886',t:'Transportability Assessment',el:'phst',c:1},
        {s:'A012',di:'DI-MGMT-81466',t:'Depot Maintenance Work Requirements',el:'ilsmgmt',c:1}
    ]},
    stryker:{name:'Stryker ICV-VA1',ofc:'PM Stryker',type:'Infantry Combat Vehicle',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Technical Manuals (TM 9-series)',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning / ASL',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'New Equipment Training',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'TMDE / Special Tools',el:'se',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'Transportability (C-17/C-130)',el:'phst',c:1}
    ]},
    ah64:{name:'AH-64E Apache Guardian',ofc:'PEO Aviation',type:'Attack Helicopter',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Aviation Technical Manuals',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning / ASL',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Pilot/Crew Training (NET)',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'Ground Support Equipment (GSE)',el:'se',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / Mission Capable Rate',el:'ram',c:1},
        {s:'A009',di:'DI-CMAN-81250',t:'Configuration / MOD Programs',el:'config',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Depot / AVIM / AVUM Planning',el:'ilsmgmt',c:1}
    ]},
    himars:{name:'M142 HIMARS',ofc:'PEO Missiles & Space',type:'Rocket Artillery',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-TMSS-80897',t:'Technical Manuals (TM 9-series)',el:'techdata',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Plan',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A005',di:'DI-TRAN-81476',t:'New Equipment Training',el:'training',c:1},
        {s:'A006',di:'DI-SESS-81519',t:'TMDE / Support Equipment',el:'se',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / System Readiness',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A009',di:'DI-PACK-80886',t:'Transportability (C-130)',el:'phst',c:1}
    ]},
    f35a:{name:'F-35A Lightning II (USAF)',ofc:'JSF PO / ACC',type:'Conventional Takeoff Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan / ODIN',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning / Global Spares',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81114',t:'Technical Orders (TOs)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config / Software Baseline',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Aircrew & Maintainer Training',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / MC Rate Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-SESS-81519',t:'Aerospace Ground Equipment',el:'se',c:1}
    ]},
    kc46:{name:'KC-46A Pegasus',ofc:'AFLCMC',type:'Aerial Refueling Tanker',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Reliability Centered Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-TMSS-81114',t:'Technical Orders',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Supply Chain Management',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Aircrew Training',el:'training',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / Availability',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'AGE Requirements',el:'se',c:1}
    ]},
    b21:{name:'B-21 Raider',ofc:'AFLCMC / LRSO PO',type:'Long-Range Strike Bomber',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-TMSS-81114',t:'Technical Orders / IETM',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Supply / Provisioning',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Training Systems / Simulators',el:'training',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / Stealth Sustainment',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Config / SCN Management',el:'config',c:1},
        {s:'A009',di:'DI-FACI-80931',t:'Secure Facility Requirements',el:'facilities',c:1},
        {s:'A010',di:'DI-MCCR-80030',t:'Cybersecurity / Mission Systems',el:'compres',c:1}
    ]},
    c17:{name:'C-17 Globemaster III',ofc:'AFLCMC',type:'Strategic Airlift',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'RCM / Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-TMSS-81114',t:'Technical Orders',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Supply Chain / DLA Coordination',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'Aircrew & Maintainer Training',el:'training',c:1},
        {s:'A007',di:'DI-RELI-80255',t:'RAM / Mission Capable Rate',el:'ram',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'AGE Requirements',el:'se',c:1}
    ]},
    gps3:{name:'GPS III / IIIF',ofc:'Space Systems Command',type:'Navigation Satellite',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Ground Segment Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Supply / Unique Space Parts',el:'supply',c:1},
        {s:'A004',di:'DI-TRAN-81476',t:'Operator Training',el:'training',c:1},
        {s:'A005',di:'DI-RELI-80255',t:'On-Orbit Reliability Analysis',el:'ram',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config / Firmware Control',el:'config',c:1},
        {s:'A007',di:'DI-MCCR-80030',t:'Cybersecurity / Space Resilience',el:'compres',c:1},
        {s:'A008',di:'DI-FACI-80931',t:'Ground Station Facilities',el:'facilities',c:0}
    ]},
    sbirs:{name:'SBIRS / Next-Gen OPIR',ofc:'Space Systems Command',type:'Missile Warning Satellite',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Ground Segment Maintenance',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Supply / Classified Components',el:'supply',c:1},
        {s:'A004',di:'DI-TRAN-81476',t:'Mission Crew Training',el:'training',c:1},
        {s:'A005',di:'DI-RELI-80255',t:'Constellation Availability Analysis',el:'ram',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A007',di:'DI-MCCR-80030',t:'Cybersecurity / STIG Compliance',el:'compres',c:1},
        {s:'A008',di:'DI-FACI-80931',t:'SCIF / Ground Station Requirements',el:'facilities',c:1}
    ]},
    nsc:{name:'NSC (Legend-class)',ofc:'CG-9325',type:'National Security Cutter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan (PMS)',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (CG Format)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'C4ISR Logistics',el:'ilsmgmt',c:1}
    ]},
    opc:{name:'OPC (Heritage-class)',ofc:'CG-9325',type:'Offshore Patrol Cutter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1}
    ]},
    frc:{name:'FRC (Sentinel-class)',ofc:'CG-9325',type:'Fast Response Cutter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1}
    ]},
    acv:{name:'ACV 1.1 Amphibious Combat Vehicle',ofc:'PEO Land Systems (USMC)',type:'Amphibious Combat Vehicle',drls:[
        {s:'A001',di:'DI-ALSS-81530',t:'Logistics Support Analysis',el:'lsa',c:1},
        {s:'A002',di:'DI-ALSS-81529',t:'MAC Development',el:'lsa',c:1},
        {s:'A003',di:'DI-TMSS-80897',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning / Block Requirements',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'RPSTL',el:'supply',c:1},
        {s:'A006',di:'DI-TRAN-81476',t:'MOS Training Plan',el:'training',c:1},
        {s:'A007',di:'DI-SESS-81519',t:'CSS Equipment',el:'se',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / Operational Readiness',el:'ram',c:1},
        {s:'A009',di:'DI-CMAN-81250',t:'Configuration Management',el:'config',c:1}
    ]},
    custom:{name:'Custom Program',ofc:'\u2014',type:'User-Defined',drls:[
        {s:'C001',di:'DI-ILSS-81490',t:'Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'C002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'C003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'C004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:0},
        {s:'C005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'C006',di:'DI-CMAN-81250',t:'Configuration Accounting',el:'config',c:0},
        {s:'C007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:0},
        {s:'C008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:0}
    ]}
};

// ── Sample DRL Generator (Enhanced with realistic DI numbers) ──
// Extended DI catalog per program type for realistic samples
const EXTENDED_DI = {
    navy_pms300: [
        {di:'DI-001',t:'Contract Data Requirements List (CDRL)',el:'ilsmgmt'},
        {di:'DI-002',t:'Statement of Work (SOW) Compliance Matrix',el:'ilsmgmt'},
        {di:'DI-003',t:'Integrated Master Schedule (IMS)',el:'ilsmgmt'},
        {di:'DI-004',t:'Systems Engineering Plan (SEP)',el:'design'},
        {di:'DI-005',t:'Interface Control Document (ICD)',el:'design'},
        {di:'DI-006',t:'Test & Evaluation Master Plan (TEMP)',el:'ram'},
        {di:'DI-007',t:'Weight Report',el:'design'},
        {di:'DI-008',t:'Electrical Load Analysis',el:'design'},
        {di:'DI-009',t:'Purchase Order Index',el:'supply'},
        {di:'DI-010',t:'Long Lead Time Material List',el:'supply'},
        {di:'DI-011',t:'Government Furnished Material (GFM) List',el:'supply'},
        {di:'DI-012',t:'Hazardous Material (HazMat) List',el:'phst'},
        {di:'DI-013',t:'Lifting & Handling Plan',el:'phst'},
        {di:'DI-014',t:'Fire Protection Plan',el:'design'},
        {di:'DI-015',t:'Compartment Check-Off List (CCOL)',el:'maint'},
        {di:'DI-016',t:'Quality Assurance Plan',el:'ilsmgmt'},
        {di:'DI-017',t:'Welding Procedure Qualification Records',el:'maint'},
        {di:'DI-018',t:'Non-Destructive Testing (NDT) Procedures',el:'maint'},
        {di:'DI-019',t:'Post-Delivery Availability (PDA) Plan',el:'maint'},
        {di:'DI-020',t:'Vendor Recommended Spares (VRS)',el:'supply'},
        {di:'DI-021',t:'Allowance Parts List (APL)',el:'supply'},
        {di:'DI-022',t:'Allowance Equipage List (AEL)',el:'supply'},
        {di:'DI-023',t:'Technical Manual (Operator)',el:'techdata'},
        {di:'DI-024',t:'Technical Manual (Maintenance)',el:'techdata'},
        {di:'DI-025',t:'Damage Control Book',el:'techdata'},
        {di:'DI-026',t:'Ship Information Book (SIB)',el:'techdata'},
        {di:'DI-027',t:'Baseline Design Drawing Package',el:'config'},
        {di:'DI-028',t:'As-Built Drawing Package',el:'config'},
        {di:'DI-029',t:'Configuration Status Accounting (CSA)',el:'config'},
        {di:'DI-030',t:'Engineering Change Proposal (ECP)',el:'config'},
        {di:'DI-031',t:'Item Unique Identification (IUID) Register',el:'supply'},
        {di:'DI-032',t:'Maintenance Requirement Cards (MRCs)',el:'maint'},
        {di:'DI-033',t:'Planned Maintenance System (PMS) Index',el:'maint'},
        {di:'DI-034',t:'Reliability Analysis / FMECA',el:'ram'},
        {di:'DI-035',t:'Maintainability Analysis',el:'ram'},
        {di:'DI-036',t:'Availability (Ao) Analysis Report',el:'ram'},
        {di:'DI-037',t:'Level of Repair Analysis (LORA)',el:'maint'},
        {di:'DI-038',t:'Life Cycle Cost Analysis (LCCA)',el:'ilsmgmt'},
        {di:'DI-039',t:'Life Cycle Sustainment Plan (LCSP)',el:'ilsmgmt'},
        {di:'DI-040',t:'Crew Familiarization Training Plan',el:'training'},
        {di:'DI-041',t:'Machinery Equipment List (MEL)',el:'supply'},
        {di:'DI-042',t:'Safety Assessment Report',el:'design'},
        {di:'DI-043',t:'Environmental Compliance Plan',el:'phst'},
        {di:'DI-044',t:'Spares Buylist / Initial Outfitting',el:'supply'}
    ],
    army: [
        {di:'DI-001',t:'LSA Record (LSAR) Data',el:'lsa'},{di:'DI-002',t:'MAC Code Assignment',el:'lsa'},
        {di:'DI-003',t:'RPSTL — Repair Parts & Special Tools',el:'supply'},{di:'DI-004',t:'NET Plan / Training Support Package',el:'training'},
        {di:'DI-005',t:'MANPRINT Assessment Report',el:'manpower'},{di:'DI-006',t:'Transportability Report (C-17/C-130)',el:'phst'},
        {di:'DI-007',t:'Technical Manual TM 9-series',el:'techdata'},{di:'DI-008',t:'Depot Maintenance Work Requirements (DMWR)',el:'maint'},
        {di:'DI-009',t:'Provisioning Master Record',el:'supply'},{di:'DI-010',t:'Reliability Growth Test Plan',el:'ram'},
        {di:'DI-011',t:'RAM/Ao Threshold Analysis',el:'ram'},{di:'DI-012',t:'Fielding Plan',el:'ilsmgmt'},
        {di:'DI-013',t:'PBL Strategy Document',el:'supply'},{di:'DI-014',t:'Obsolescence Management Plan',el:'supply'},
        {di:'DI-015',t:'Safety Release Certificate',el:'design'}
    ],
    airforce: [
        {di:'DI-001',t:'Technical Order (TO) Package',el:'techdata'},{di:'DI-002',t:'ODIN LCMP Integration',el:'compres'},
        {di:'DI-003',t:'Aerospace Ground Equipment (AGE) List',el:'se'},{di:'DI-004',t:'Mission Capable Rate Baseline',el:'ram'},
        {di:'DI-005',t:'Reliability Centered Maintenance Plan',el:'maint'},{di:'DI-006',t:'Software Configuration Baseline',el:'config'},
        {di:'DI-007',t:'Preliminary Design Review (PDR) Data',el:'design'},{di:'DI-008',t:'Critical Design Review (CDR) Data',el:'design'},
        {di:'DI-009',t:'Cybersecurity Assessment Report',el:'compres'},{di:'DI-010',t:'Aircrew Training Device Specifications',el:'training'},
        {di:'DI-011',t:'Maintenance Training Courseware',el:'training'},{di:'DI-012',t:'Depot Source of Repair (DSOR)',el:'maint'}
    ],
    space: [
        {di:'DI-001',t:'On-Orbit Reliability Model',el:'ram'},{di:'DI-002',t:'Ground Segment Maintenance Plan',el:'maint'},
        {di:'DI-003',t:'Satellite Bus Configuration Baseline',el:'config'},{di:'DI-004',t:'Space Vehicle Integration Plan',el:'design'},
        {di:'DI-005',t:'STIG Compliance Matrix',el:'compres'},{di:'DI-006',t:'Launch Operations Logistics Plan',el:'phst'},
        {di:'DI-007',t:'Mission Crew Operations Manual',el:'training'},{di:'DI-008',t:'Constellation Availability Analysis',el:'ram'}
    ],
    coastguard: [
        {di:'DI-001',t:'CG Maintenance Plan (PMS Format)',el:'maint'},{di:'DI-002',t:'CG Technical Manual (CG Format)',el:'techdata'},
        {di:'DI-003',t:'CG Provisioning Documentation',el:'supply'},{di:'DI-004',t:'C4ISR Logistics Plan',el:'compres'},
        {di:'DI-005',t:'Cutter Training Plan',el:'training'},{di:'DI-006',t:'Vessel Safety Assessment',el:'design'},
        {di:'DI-007',t:'Environmental Compliance (MARPOL)',el:'phst'},{di:'DI-008',t:'SAR Equipment List',el:'se'}
    ],
    marines: [
        {di:'DI-001',t:'LSA Record (LSAR) — Marine Corps',el:'lsa'},{di:'DI-002',t:'MOS Training Plan',el:'training'},
        {di:'DI-003',t:'CSS Equipment Requirements',el:'se'},{di:'DI-004',t:'Amphibious Operations Logistics',el:'phst'},
        {di:'DI-005',t:'Repair Parts Block Requirements',el:'supply'},{di:'DI-006',t:'Combat Configuration Baseline',el:'config'}
    ]
};

function getExtendedDIs(progKey) {
    if (['yrbm','apl','afdm','ydt','yon'].includes(progKey)) return EXTENDED_DI.navy_pms300;
    if (['ddg51','lcs','cvn78','ffg62','lpd17'].includes(progKey)) return EXTENDED_DI.navy_pms300;
    if (['f35','f35b','ch53k'].includes(progKey)) return EXTENDED_DI.airforce;
    if (['m1','stryker','ah64','himars'].includes(progKey)) return EXTENDED_DI.army;
    if (['f35a','kc46','b21','c17'].includes(progKey)) return EXTENDED_DI.airforce;
    if (['gps3','sbirs'].includes(progKey)) return EXTENDED_DI.space;
    if (['nsc','opc','frc'].includes(progKey)) return EXTENDED_DI.coastguard;
    if (['acv'].includes(progKey)) return EXTENDED_DI.marines;
    return EXTENDED_DI.navy_pms300;
}

function loadSampleDRL() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) return;
    const statuses = ['Approved','Approved','Submitted','In Review','Overdue','Rejected','Approved','Approved','Submitted','Approved'];
    const dates = ['2025-10-15','2025-12-01','2026-01-15','2026-02-01','2026-03-15','2026-04-01','2025-11-20','2026-05-01','2026-06-15','2025-09-01'];
    // Generate primary DRL with extended DI items
    const extDIs = getExtendedDIs(progKey);
    let csv = 'CDRL Seq,DI Number,Title,ILS Element,Status,Due Date,Contractor,Approval Authority\n';
    // First include all program-specific DRL items
    prog.drls.forEach((d,i) => {
        if (Math.random() < 0.15) return; // ~15% missing for realistic gaps
        const si = (i + Math.floor(Math.random()*3)) % statuses.length;
        csv += d.s + ',' + d.di + ',"' + d.t + '",' + (d.el||'') + ',' + statuses[si] + ',' + dates[si] + ',Primary Contractor,' + prog.ofc + '\n';
    });
    // Then add extended DI items
    extDIs.forEach((d,i) => {
        if (Math.random() < 0.25) return; // ~25% missing
        const si = (i + Math.floor(Math.random()*4)) % statuses.length;
        const seq = 'B' + String(i+1).padStart(3,'0');
        csv += seq + ',' + d.di + ',"' + d.t + '",' + d.el + ',' + statuses[si] + ',' + dates[si] + ',Primary Contractor,' + prog.ofc + '\n';
    });
    // Add checklist items as status records
    const cl = getCL(progKey);
    cl.forEach(item => {
        if (Math.random() < 0.5) csv += ','+ ',"' + item.l + ' \u2014 Status Report",,Review Complete,2026-01-30,' + prog.ofc + ',\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const file = new File([blob], 'DRL_Tracker_' + progKey.toUpperCase() + '.csv', {type:'text/csv'});
    handleILSFiles([file]);
}

function loadSamplePackage() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) return;
    // Clear existing files
    ilsFiles = [];
    document.getElementById('ilsFileList').innerHTML = '';

    // 1. Main DRL Tracker (CSV)
    loadSampleDRL();

    // 2. Life Cycle Sustainment Plan (LCSP) — text content simulating a Word doc
    const lcsp = generateLCSP(progKey, prog);
    handleILSFiles([new File([new Blob([lcsp],{type:'text/plain'})], 'LCSP_' + progKey.toUpperCase() + '_2026.txt', {type:'text/plain'})]);

    // 3. IUID Register (CSV)
    const iuid = generateIUID(progKey, prog);
    handleILSFiles([new File([new Blob([iuid],{type:'text/csv'})], 'IUID_Register_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 4. Vendor Recommended Spares (CSV)
    const vrs = generateVRS(progKey, prog);
    handleILSFiles([new File([new Blob([vrs],{type:'text/csv'})], 'VRS_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 5. Spares Buylist / Initial Outfitting (CSV)
    const buylist = generateSparesBuylist(progKey, prog);
    handleILSFiles([new File([new Blob([buylist],{type:'text/csv'})], 'Spares_Buylist_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 6. Purchase Order Index (CSV)
    const poi = generatePOIndex(progKey, prog);
    handleILSFiles([new File([new Blob([poi],{type:'text/csv'})], 'PO_Index_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);

    // 7. MEL / Equipment List (CSV) — for Navy/CG programs
    if (['yrbm','apl','afdm','ydt','yon','ddg51','lcs','cvn78','ffg62','lpd17','nsc','opc','frc'].includes(progKey)) {
        const mel = generateMEL(progKey, prog);
        handleILSFiles([new File([new Blob([mel],{type:'text/csv'})], 'MEL_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);
    }

    // 8. Maintenance Requirement Card Index (CSV) — for Navy
    if (['yrbm','apl','afdm','ydt','yon','ddg51','lcs','cvn78','ffg62','lpd17','nsc','opc','frc'].includes(progKey)) {
        const mrc = generateMRCIndex(progKey, prog);
        handleILSFiles([new File([new Blob([mrc],{type:'text/csv'})], 'MRC_Index_' + progKey.toUpperCase() + '.csv', {type:'text/csv'})]);
    }
}

function generateLCSP(progKey, prog) {
    const hull = document.getElementById('ilsHull')?.value || progKey.toUpperCase();
    return [
        '═══════════════════════════════════════════════════════════════════',
        '  LIFE CYCLE SUSTAINMENT PLAN (LCSP)',
        '  DI-ILSS-81490 / DI-039',
        '═══════════════════════════════════════════════════════════════════',
        '',
        'Program:         ' + prog.name,
        'Hull/Desig:      ' + hull,
        'Program Office:  ' + prog.ofc,
        'Platform Type:   ' + prog.type,
        'Document Rev:    Rev B (Draft)',
        'Date:            ' + new Date().toISOString().split('T')[0],
        'Classification:  UNCLASSIFIED',
        '',
        '───────────────────────────────────────────────────────────────────',
        '1.0 PURPOSE',
        '  This Life Cycle Sustainment Plan establishes the strategy for',
        '  integrated logistics support of the ' + prog.name + ' program',
        '  throughout its projected 30-year service life.',
        '',
        '2.0 ILS ELEMENTS ADDRESSED',
        '  2.1 Maintenance Planning (PMS/MRC Development)',
        '  2.2 Supply Support (Provisioning, APL, COSAL)',
        '  2.3 Technical Data (Tech Manuals, IETMs)',
        '  2.4 Training & Training Support',
        '  2.5 Support Equipment',
        '  2.6 Manpower & Personnel',
        '  2.7 Computer Resources / Mission Systems',
        '  2.8 Facilities',
        '  2.9 PHS&T',
        '  2.10 Design Interface',
        '',
        '3.0 SUSTAINMENT STRATEGY',
        '  3.1 Organic Maintenance: ' + (prog.ofc.includes('PMS')?'NAVSEA / Regional Maintenance Centers':'Service Depot-Level'),
        '  3.2 Contractor Maintenance: Post-Delivery Availability (PDA)',
        '  3.3 Spares Strategy: DLA/NAVSUP with contractor initial provisioning',
        '  3.4 Obsolescence: Proactive DMSMS monitoring program',
        '',
        '4.0 PERFORMANCE METRICS',
        '  • Ao (Operational Availability): ≥ 0.85',
        '  • MTBF target: Per RAM analysis (DI-034)',
        '  • MTTR target: Per Maintainability Analysis (DI-035)',
        '  • Fill Rate (supply support): ≥ 90%',
        '',
        '5.0 CONFIGURATION MANAGEMENT',
        '  Baseline managed per DI-029 / DI-030 (CSA & ECP)',
        '  IUID tracking per DI-031',
        '',
        '───────────────────────────────────────────────────────────────────',
        '  LCSP generated by S4 Ledger ILS Intelligence Engine',
        '  s4ledger.com — Immutable logistics verification',
        '═══════════════════════════════════════════════════════════════════'
    ].join('\n');
}

function generateIUID(progKey, prog) {
    const parts = ['Main Engine Assembly','Generator Set #1','Generator Set #2','Fire Pump','HVAC Unit','Steering Gear','Anchor Windlass','Crane Assembly','Radar System','Navigation Console','Comm Suite','Electrical Switchboard','Hydraulic Power Unit','Fuel Transfer Pump','Freshwater Distiller','Sewage Treatment Plant','Capstan','Life Raft Cradle','Shore Power Connection','Battery Charger'];
    const nsns = ['2815-01-234-5678','6115-01-345-6789','6115-01-345-6790','4210-01-456-7890','4120-01-567-8901','2540-01-678-9012','3950-01-789-0123','3810-01-890-1234','5820-01-901-2345','6605-01-012-3456'];
    let csv = 'IUID UII,NSN,Nomenclature,Manufacturer,Part Number,Serial Number,Acquisition Cost,Install Location,Status\n';
    parts.forEach((p,i) => {
        const uii = 'D' + String(Math.floor(100000+Math.random()*900000)) + 'S4' + String(i+1).padStart(4,'0');
        const nsn_i = nsns[i % nsns.length];
        const mfg = ['Cummins','Caterpillar','Honeywell','Raytheon','L3Harris','GE Marine','Rolls-Royce','BAE Systems','Northrop Grumman','Eaton'][i%10];
        csv += uii + ',' + nsn_i + ',"' + p + '",' + mfg + ',PN-' + (1000+i) + '-' + String(Math.floor(Math.random()*9999)).padStart(4,'0') + ',SN-' + String(Math.floor(100000+Math.random()*900000)) + ',$' + (5000+Math.floor(Math.random()*195000)).toLocaleString() + ',' + ['Engine Room','Bridge','Deck','Auxiliary','CIC','Berthing'][i%6] + ',' + ['Installed','Installed','In Transit','Installed','Warehouse','Installed','Installed','QA Hold','Installed','Installed'][i%10] + '\n';
    });
    return csv;
}

function generateVRS(progKey, prog) {
    const items = ['Fuel Filter Element','Oil Filter','V-Belt Set','Seal Kit (Hydraulic)','Gasket Set','Bearing Assembly','Impeller (Pump)','Relay (24VDC)','Circuit Breaker (60A)','O-Ring Kit','Thermostat Assembly','Zinc Anode Set','Coupling (Flexible)','Pressure Gauge (0-300psi)','Sight Glass','Solenoid Valve','Check Valve (1.5in)','Expansion Valve','Temperature Sensor','Control Board (HVAC)'];
    let csv = 'VRS Line,NSN,Nomenclature,Part Number,Qty Rec,Unit Price,Lead Time (wks),Vendor,Criticality\n';
    items.forEach((item,i) => {
        const crit = i < 6 ? 'Critical' : i < 14 ? 'Essential' : 'Desirable';
        csv += 'VRS-' + String(i+1).padStart(3,'0') + ',5330-01-' + String(Math.floor(100+Math.random()*900)) + '-' + String(Math.floor(1000+Math.random()*9000)) + ',"' + item + '",PN-' + (2000+i) + ',' + (1+Math.floor(Math.random()*10)) + ',$' + (15+Math.floor(Math.random()*2500)).toLocaleString() + ',' + (4+Math.floor(Math.random()*20)) + ',' + ['Parker Hannifin','Donaldson','Gates','SKF','Garlock','Timken','Flowserve','TE Connectivity','Eaton','Dana'][i%10] + ',' + crit + '\n';
    });
    return csv;
}

function generateSparesBuylist(progKey, prog) {
    let csv = 'Line,APL Number,NSN,Nomenclature,Qty Auth,Qty On Hand,Qty On Order,Unit Cost,Allowance Type,Notes\n';
    const items = ['Packing Set','Bearing Ball','Connector Plug','Lamp Indicator','Fuse Cartridge','Hose Assembly','Valve Globe','Strainer Intake','Switch Toggle','Resistor Fixed','Capacitor Fixed','Transformer','Motor Starter','Contactor','Cable Assembly','Pipe Fitting','Bolt Set (SS)','Spring Compression','Diaphragm','Sensor Assembly'];
    items.forEach((item,i) => {
        csv += 'SB-' + String(i+1).padStart(3,'0') + ',APL-' + progKey.toUpperCase() + '-' + String(i+1).padStart(3,'0') + ',5330-01-' + String(Math.floor(100+Math.random()*900)) + '-' + String(Math.floor(1000+Math.random()*9000)) + ',"' + item + '",' + (2+Math.floor(Math.random()*8)) + ',' + Math.floor(Math.random()*5) + ',' + Math.floor(Math.random()*3) + ',$' + (8+Math.floor(Math.random()*800)).toLocaleString() + ',' + ['COSAL','AVCAL','SHORCAL','COSAL'][i%4] + ',' + (i<5?'Flight Critical':'') + '\n';
    });
    return csv;
}

function generatePOIndex(progKey, prog) {
    let csv = 'PO Number,Vendor,Description,Value,Status,Ship Date,Contract Ref\n';
    const vendors = ['Huntington Ingalls Industries','BAE Systems Ship Repair','General Dynamics NASSCO','Cummins Marine','L3Harris','Raytheon','Rolls-Royce Naval','Northrop Grumman','Leonardo DRS','Leidos'];
    const descs = ['Main Engine Spare Parts','Generator Overhaul Kit','Navigation Radar Upgrade','Comm System Installation','Deck Machinery Spares','HVAC System Components','Electrical Distribution Panel','Fire Suppression System','Anchor Chain & Fittings','Hull Coating Materials','Paint & Preservation','Safety Equipment Package','Crane Wire Rope','Shore Power Transformer','Sewage System Parts'];
    for (let i = 0; i < 15; i++) {
        const poNum = 'N00024-26-C-' + String(4000+i).padStart(4,'0');
        csv += poNum + ',' + vendors[i%10] + ',"' + descs[i] + '",$' + (25000+Math.floor(Math.random()*475000)).toLocaleString() + ',' + ['Awarded','In Progress','Delivered','In Progress','Awarded','Delivered','Pending','In Progress','Delivered','Awarded','In Progress','Delivered','Pending','Awarded','In Progress'][i] + ',' + [2026,2026,2025,2026,2026,2025,2026,2026,2025,2026,2026,2025,2026,2026,2025][i] + '-' + String(1+Math.floor(Math.random()*12)).padStart(2,'0') + '-15,' + 'N00024-25-D-' + String(Math.floor(1000+Math.random()*9000)) + '\n';
    }
    return csv;
}

function generateMEL(progKey, prog) {
    let csv = 'MEL Item,System,Equipment,Manufacturer,Model,Location,Weight (lbs),Power (kW),Status\n';
    const equip = [
        ['Propulsion','Main Diesel Engine','Cummins','KTA50-M2','Engine Room'],
        ['Propulsion','Reduction Gear','Reintjes','WAF 564','Engine Room'],
        ['Electrical','Ship Service Generator','Caterpillar','C9.3 Marine','Gen Room'],
        ['Electrical','Emergency Generator','John Deere','4045TFM85','Emerg Gen Room'],
        ['Auxiliary','Fire Pump','Aurora','481-BF','Pump Room'],
        ['Auxiliary','Bilge Pump','IMO','ACE 032','Bilge Well'],
        ['HVAC','AC Plant','Carrier','30HX','Machine Shop'],
        ['Navigation','Radar (Surface Search)','Furuno','FAR-2228','Bridge'],
        ['Navigation','GPS Receiver','Furuno','GP-170','Bridge'],
        ['Communication','VHF Radio','ICOM','IC-M510','Bridge'],
        ['Communication','SATCOM Terminal','KVH','V7-HTS','Mast Top'],
        ['Deck Machinery','Anchor Windlass','Burrard','AW-120','Fwd Deck'],
        ['Deck Machinery','Capstan','Rotzler','TR 100','Aft Deck'],
        ['Safety','Life Raft (25-person)','Viking','25DK+','Boat Deck'],
        ['Crane','Mobile Crane','Palfinger','PK 40002','Main Deck']
    ];
    equip.forEach((e,i) => {
        csv += 'MEL-' + String(i+1).padStart(3,'0') + ',' + e[0] + ',"' + e[1] + '",' + e[2] + ',' + e[3] + ',' + e[4] + ',' + (200+Math.floor(Math.random()*15000)) + ',' + (1+Math.floor(Math.random()*800)) + ',' + ['Installed','Installed','On Order','Installed','Installed','QA Hold','Installed','Installed','Installed','Installed','In Transit','Installed','Installed','Installed','On Order'][i] + '\n';
    });
    return csv;
}

function generateMRCIndex(progKey, prog) {
    let csv = 'MRC Number,Periodicity,System,Description,Skill Rate,Est Hours,Critical\n';
    const mrcs = [
        ['MRC-DE-001','W','Main Engine','Lube Oil Level Check','EN2',0.5,'No'],
        ['MRC-DE-002','M','Main Engine','Fuel Filter Inspection',  'EN1',1.0,'Yes'],
        ['MRC-DE-003','Q','Main Engine','Injector Timing Check','EN1',4.0,'Yes'],
        ['MRC-EL-001','W','Electrical','Generator Load Test','EM2',1.0,'Yes'],
        ['MRC-EL-002','M','Electrical','Battery Electrolyte Check','EM3',0.5,'No'],
        ['MRC-AX-001','M','Auxiliary','Fire Pump Performance Test','DC2',2.0,'Yes'],
        ['MRC-AX-002','Q','Auxiliary','HVAC Refrigerant Check','MM2',1.5,'No'],
        ['MRC-HU-001','SA','Hull','Cathodic Protection Inspection','HT2',3.0,'Yes'],
        ['MRC-HU-002','A','Hull','Topside Paint Condition Survey','BM2',4.0,'No'],
        ['MRC-NK-001','M','Navigation','Radar Performance Check','ET2',1.0,'Yes'],
        ['MRC-NK-002','Q','Navigation','Compass Deviation Check','QM1',2.0,'No'],
        ['MRC-DK-001','W','Deck','Wire Rope Inspection','BM2',1.0,'Yes'],
        ['MRC-DK-002','M','Deck','Crane Load Test','BM1',4.0,'Yes'],
        ['MRC-SF-001','M','Safety','Life Raft Hydrostatic Release','DC3',0.5,'Yes'],
        ['MRC-SF-002','Q','Safety','Fire Extinguisher Inspection','DC3',1.0,'Yes']
    ];
    mrcs.forEach(m => { csv += m.join(',') + '\n'; });
    return csv;
}

// ── File Upload Handling ──
function setupILSDropzone() {
    const dz = document.getElementById('ilsDropzone');
    if (!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); }));
    dz.addEventListener('drop', e => handleILSFiles(e.dataTransfer.files));
}

function handleILSFiles(fileList) {
    Array.from(fileList).forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        if (!['csv','xlsx','xls','txt','tsv'].includes(ext)) { alert('Unsupported file type: .' + ext); return; }
        const reader = new FileReader();
        if (ext === 'xlsx' || ext === 'xls') {
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const parsed = parseExcelContent(data);
                const records = extractRecords(parsed);
                addILSFile(file.name, file.size, records, parsed.rows.length);
            };
            reader.readAsArrayBuffer(file);
        } else {
            reader.onload = e => {
                const text = e.target.result;
                const parsed = (ext === 'csv' || ext === 'tsv') ? parseCSVContent(text) : parseTextContent(text);
                const records = extractRecords(parsed);
                addILSFile(file.name, file.size, records, parsed.rows.length);
            };
            reader.readAsText(file);
        }
    });
}

function addILSFile(name, size, records, totalRows) {
    ilsFiles.push({ id: 'f_' + Date.now() + '_' + Math.random().toString(36).substr(2,4), name, size, records, totalRows });
    renderFileList();
    updateChecklistFromUploads();
}

function removeILSFile(id) {
    ilsFiles = ilsFiles.filter(f => f.id !== id);
    renderFileList();
    updateChecklistFromUploads();
}

function renderFileList() {
    const list = document.getElementById('ilsFileList');
    if (!list) return;
    if (!ilsFiles.length) { list.innerHTML = ''; return; }
    list.innerHTML = ilsFiles.map(f => {
        const sz = f.size > 1048576 ? (f.size/1048576).toFixed(1)+'MB' : (f.size/1024).toFixed(0)+'KB';
        const icon = /\.xlsx?$/i.test(f.name) ? 'fa-file-excel' : /\.csv$/i.test(f.name) ? 'fa-file-csv' : 'fa-file-alt';
        return '<div class="ils-file-item"><div class="file-info"><i class="fas '+icon+'" style="color:var(--accent);margin-right:8px"></i>'
            + '<span style="font-weight:600;color:#fff">'+f.name+'</span></div>'
            + '<div class="file-stats">'+f.records.length+' DRL items detected from '+f.totalRows+' rows \u00b7 '+sz+'</div>'
            + '<button class="file-remove" onclick="removeILSFile(\''+f.id+'\')">\u00d7</button></div>';
    }).join('');
}

// ── Parsers ──
function parseCSVContent(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) return { headers: [], rows: [] };
    const delim = (lines[0].match(/\t/g)||[]).length > (lines[0].match(/,/g)||[]).length ? '\t' : ',';
    function splitRow(line) {
        const res = []; let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') { inQ = !inQ; }
            else if (ch === delim.charAt(0) && !inQ) { res.push(cur.trim()); cur = ''; }
            else { cur += ch; }
        }
        res.push(cur.trim());
        return res;
    }
    const headers = splitRow(lines[0]);
    const rows = lines.slice(1).map(l => {
        const cells = splitRow(l);
        return headers.reduce((o,h,i) => { o[h] = cells[i]||''; return o; }, {});
    }).filter(r => Object.values(r).some(v => v));
    return { headers, rows };
}

function parseExcelContent(data) {
    if (typeof XLSX === 'undefined') { alert('Excel parser not loaded. Please wait and try again.'); return { headers:[], rows:[] }; }
    try {
        const wb = XLSX.read(data, { type:'array' });
        let sheetName = wb.SheetNames.find(n => /drl|cdrl|ils|deliverable/i.test(n)) || wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const raw = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
        if (raw.length < 2) return { headers:[], rows:[] };
        let hIdx = 0;
        for (let i = 0; i < Math.min(raw.length, 10); i++) {
            if (raw[i].filter(c => String(c).trim()).length >= 3) { hIdx = i; break; }
        }
        const headers = raw[hIdx].map(h => String(h).trim());
        const rows = raw.slice(hIdx+1).filter(r => r.some(c => String(c).trim())).map(r =>
            headers.reduce((o,h,i) => { o[h] = String(r[i]||'').trim(); return o; }, {})
        );
        return { headers, rows };
    } catch(e) { console.error('Excel parse error:', e); return { headers:[], rows:[] }; }
}

function parseTextContent(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const diPat = /DI-[A-Z]{4}-\d{5}/g;
    const records = [];
    lines.forEach(line => {
        const m = line.match(diPat);
        if (m) m.forEach(di => records.push({ 'DI': di, 'Title': line.trim().substring(0,120) }));
    });
    return { headers: ['DI','Title'], rows: records };
}

// ── Column Detection & Record Extraction ──
function detectColumns(headers) {
    const lh = headers.map(h => h.toLowerCase().replace(/[^a-z0-9\s]/g,''));
    return {
        seq: lh.findIndex(h => /cdrl|seq|line\s*item|exhibit|item\s*no/.test(h)),
        di: lh.findIndex(h => /\bdi\b|did\b|data\s*item/.test(h)),
        title: lh.findIndex(h => /title|description|name|data\s*product/.test(h)),
        status: lh.findIndex(h => /status|state|deliverable\s*status|approval/.test(h)),
        due: lh.findIndex(h => /due|date|deadline|submit|required\s*date/.test(h)),
        contractor: lh.findIndex(h => /contractor|vendor|supplier/.test(h))
    };
}

function extractRecords(parsed) {
    if (!parsed.rows.length) return [];
    const cols = detectColumns(parsed.headers);
    const records = [];
    parsed.rows.forEach(row => {
        let seq = '', di = '', title = '', status = '', due = '';
        if (cols.seq >= 0) seq = row[parsed.headers[cols.seq]] || '';
        if (cols.di >= 0) di = row[parsed.headers[cols.di]] || '';
        if (cols.title >= 0) title = row[parsed.headers[cols.title]] || '';
        if (cols.status >= 0) status = row[parsed.headers[cols.status]] || '';
        if (cols.due >= 0) due = row[parsed.headers[cols.due]] || '';
        if (!di) { Object.values(row).forEach(v => { const m = String(v).match(/DI-[A-Z]{4}-\d{5}/); if (m && !di) di = m[0]; }); }
        if (!title) { title = Object.values(row).reduce((best,v) => { const s = String(v); return (s.length > best.length && !/^DI-/.test(s) && !/^[A-C]\d{3}$/.test(s)) ? s : best; }, ''); }
        const element = di ? (DI_MAP[di] || guessElement(title)) : guessElement(title);
        if (di || (title && title.length > 3)) records.push({ seq, di, title, status: status.toLowerCase(), due, element });
    });
    return records;
}

function guessElement(t) {
    t = t.toLowerCase();
    if (/ils\s*p|logistics\s*support\s*plan|program\s*mgmt|program\s*management/.test(t)) return 'ilsmgmt';
    if (/maintenance|pms\b|mrc\b|mip\b|planned\s*maint/.test(t)) return 'maint';
    if (/supply|spare|provisioning|buylist|allowance|apl\b|cosal/.test(t)) return 'supply';
    if (/support\s*equip|se\b|tools|test\s*equip/.test(t)) return 'se';
    if (/technical\s*(manual|data|pub|order)|tm\b|ietm|tech\s*data/.test(t)) return 'techdata';
    if (/training|trainer|course|curriculum|school|net\b.*plan/.test(t)) return 'training';
    if (/manpower|personnel|manning|billet|manprint/.test(t)) return 'manpower';
    if (/computer|software|cyber|alis|odin/.test(t)) return 'compres';
    if (/facilit|shore\s*infra/.test(t)) return 'facilities';
    if (/phs.?t|packaging|handling|storage|transport|hazmat/.test(t)) return 'phst';
    if (/design\s*interface|interface\s*doc/.test(t)) return 'design';
    if (/ram\b|reliab|avail|maintain|fmeca|fracas|failure/.test(t)) return 'ram';
    if (/config|baseline|ecp|engineering\s*change/.test(t)) return 'config';
    if (/lsa\b|logistics\s*support\s*analy|mac\b|rpstl/.test(t)) return 'lsa';
    return '';
}

function fuzzyMatch(a, b) {
    const wa = a.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(w => w.length > 3);
    const wb = b.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(w => w.length > 3);
    if (!wa.length || !wb.length) return false;
    return wa.filter(w => wb.includes(w)).length >= Math.min(2, Math.ceil(wb.length * 0.4));
}

// ── Checklist & Program Handlers ──
function initILSChecklist(progKey) {
    const container = document.getElementById('ilsChecklist');
    if (!container) return;
    const cl = getCL(progKey || document.getElementById('ilsProgram').value);
    container.innerHTML = cl.map(el =>
        '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 6px;border-radius:6px;transition:background 0.2s;'+(el.c?'font-weight:600':'')+'" onmouseover="this.style.background=\'rgba(0,170,255,0.05)\'" onmouseout="this.style.background=\'transparent\'">'
        + '<input type="checkbox" id="ils_'+el.id+'" style="width:auto!important;accent-color:var(--accent)">'
        + '<span>' + el.l + (el.c?' <span style="color:var(--red);font-size:0.7rem">CRITICAL</span>':'') + '</span></label>'
    ).join('');
}

function updateChecklistFromUploads() {
    const progKey = document.getElementById('ilsProgram').value;
    const cl = getCL(progKey);
    const allText = [];
    ilsFiles.forEach(f => f.records.forEach(r => { if (r.title) allText.push(r.title); if (r.di) allText.push(r.di); }));
    const joined = allText.join(' ');
    cl.forEach(item => {
        const cb = document.getElementById('ils_' + item.id);
        if (cb && item.kw.test(joined)) cb.checked = true;
    });
}

function onILSProgramChange() {
    const key = document.getElementById('ilsProgram').value;
    const prog = PROGS[key];
    if (!prog) return;
    const ofc = document.getElementById('ilsOffice');
    if (ofc) ofc.value = prog.ofc;
    // Rebuild checklist for this program
    initILSChecklist(key);
    // Re-apply auto-detection from any uploaded files
    updateChecklistFromUploads();
    // Reset results since program changed
    ilsResults = null;
    document.getElementById('ilsScore').textContent = '--';
    document.getElementById('ilsScore').style.color = 'var(--muted)';
    document.getElementById('ilsScoreLabel').textContent = 'Upload documents & run analysis';
    document.getElementById('ilsGaugeFill').style.width = '0%';
    document.getElementById('ilsCoverage').innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem">Upload files to see checklist coverage.</div>';
    document.getElementById('ilsActions').innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.85rem">Run analysis to generate action items.</div>';
    document.getElementById('ilsCostSchedule').innerHTML = '<div style="color:var(--muted);text-align:center;padding:1rem">Analysis required to estimate impact.</div>';
    const r = document.getElementById('ilsResult'); r.innerHTML=''; r.classList.remove('show');
}

// ── Analysis Engine ──
function runFullILSAnalysis() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) { alert('Please select a program.'); return; }
    const hull = document.getElementById('ilsHull')?.value || '';
    const phase = document.getElementById('ilsPhase')?.value || 'design';
    const cl = getCL(progKey);

    // 1. Checklist scoring
    const clItems = cl.map(item => {
        const cb = document.getElementById('ils_' + item.id);
        return { ...item, checked: cb ? cb.checked : false };
    });
    const clChecked = clItems.filter(i => i.checked);
    const clUnchecked = clItems.filter(i => !i.checked);
    const clCritMissing = clUnchecked.filter(i => i.c);
    const clMax = clItems.reduce((s,i) => s + (i.c ? 2 : 1), 0);
    const clScore = clChecked.reduce((s,i) => s + (i.c ? 2 : 1), 0);
    const clPct = clMax > 0 ? Math.round((clScore / clMax) * 100) : 0;

    // 2. DRL gap analysis
    const allRecs = [];
    ilsFiles.forEach(f => allRecs.push(...f.records));
    const drlResults = prog.drls.map(d => {
        const match = allRecs.find(r =>
            (r.di && r.di === d.di) ||
            (r.seq && r.seq === d.s) ||
            (r.title && fuzzyMatch(r.title, d.t))
        );
        return { ...d, found: !!match, status: match ? (match.status || 'detected') : 'missing', due: match?.due || '' };
    });
    const drlFound = drlResults.filter(d => d.found).length;
    const drlTotal = drlResults.length;
    const drlPct = drlTotal > 0 ? Math.round((drlFound / drlTotal) * 100) : 0;

    // 3. Combined score (weighted: 60% checklist, 40% DRL)
    const hasDrls = ilsFiles.length > 0;
    const pct = hasDrls ? Math.round(clPct * 0.6 + drlPct * 0.4) : clPct;

    // 4. Action items
    const actions = [];
    let gapN = 1;
    // From checklist gaps
    clCritMissing.forEach(item => {
        actions.push({
            id: 'CL-' + String(gapN++).padStart(3,'0'), severity: 'critical', source: 'checklist',
            title: item.l, action: 'Complete and verify: ' + item.l,
            owner: prog.ofc + ' / Contractor', secondary: '',
            cost: 40, schedule: '1-3 months'
        });
    });
    // From DRL gaps
    drlResults.filter(d => !d.found && d.c).forEach(d => {
        const ow = OWNERS[d.el] || {p:'TBD',s:''};
        actions.push({
            id: 'DRL-' + String(gapN++).padStart(3,'0'), severity: 'critical', source: 'drl',
            title: d.di + ' \u2014 ' + d.t, action: 'Request submission of ' + d.di,
            owner: ow.p, secondary: ow.s,
            cost: COST_K[d.el] || 50, schedule: '2-4 months'
        });
    });
    drlResults.filter(d => d.found && /overdue|late|reject|disapprov/.test(d.status)).forEach(d => {
        const ow = OWNERS[d.el] || {p:'TBD',s:''};
        actions.push({
            id: 'ACT-' + String(gapN++).padStart(3,'0'), severity: 'warning', source: 'drl',
            title: d.di + ' \u2014 ' + d.t + ' (' + d.status.toUpperCase() + ')',
            action: /reject|disapprov/.test(d.status) ? 'Review comments & resubmit' : 'Issue CAR for late delivery',
            owner: ow.p, secondary: ow.s,
            cost: Math.round((COST_K[d.el]||50)*0.4), schedule: '1-2 months'
        });
    });
    // Non-critical DRL gaps as warnings
    drlResults.filter(d => !d.found && !d.c).forEach(d => {
        const ow = OWNERS[d.el] || {p:'TBD',s:''};
        actions.push({
            id: 'DRL-' + String(gapN++).padStart(3,'0'), severity: 'warning', source: 'drl',
            title: d.di + ' \u2014 ' + d.t, action: 'Request submission of ' + d.di,
            owner: ow.p, secondary: ow.s,
            cost: Math.round((COST_K[d.el]||30)*0.5), schedule: '1-2 months'
        });
    });
    actions.sort((a,b) => (a.severity==='critical'?0:1)-(b.severity==='critical'?0:1));

    const critGaps = actions.filter(a => a.severity==='critical').length;
    const totalCost = actions.reduce((s,a) => s + a.cost, 0);

    ilsResults = { clItems, clPct, drlResults, drlPct, drlFound, drlTotal, pct, actions, critGaps, totalCost, prog, hull, phase, progKey, cl };

    renderILSScore(pct, critGaps);
    renderILSCoverage(clItems, drlResults);
    renderILSActions(actions);
    renderILSCost(actions, totalCost, critGaps);
    renderILSResult();
}

// ── Render Functions ──
function renderILSScore(pct, critGaps) {
    const s = document.getElementById('ilsScore'), l = document.getElementById('ilsScoreLabel'), f = document.getElementById('ilsGaugeFill');
    if (!s) return;
    s.textContent = pct + '%';
    s.style.color = pct >= 80 ? '#14f195' : pct >= 50 ? '#ffa500' : '#ff3333';
    l.textContent = pct >= 80 ? 'ILS Package: Mission Ready' : pct >= 50 ? 'Gaps Identified (' + critGaps + ' critical)' : 'Critical Gaps (' + critGaps + ' items require action)';
    f.style.width = pct + '%';
}

function renderILSCoverage(clItems, drlResults) {
    const el = document.getElementById('ilsCoverage');
    if (!el) return;
    let html = '<div style="font-weight:700;color:var(--accent);margin-bottom:8px;font-size:0.82rem">PROGRAM CHECKLIST</div>';
    clItems.forEach(item => {
        const icon = item.checked ? 'fa-check-circle' : 'fa-times-circle';
        const color = item.checked ? '#14f195' : (item.c ? '#ff3333' : 'var(--muted)');
        html += '<div style="display:flex;align-items:center;gap:6px;padding:3px 0;font-size:0.82rem;border-bottom:1px solid rgba(255,255,255,0.03)">'
            + '<i class="fas '+icon+'" style="color:'+color+';font-size:0.75rem;min-width:14px"></i>'
            + '<span style="color:'+(item.checked?'var(--steel)':'var(--muted)')+'">'+item.l+'</span>'
            + (item.c&&!item.checked?'<span style="color:#ff3333;font-size:0.65rem;font-weight:700;margin-left:auto">GAP</span>':'')
            + '</div>';
    });
    if (drlResults && drlResults.length) {
        const found = drlResults.filter(d=>d.found).length;
        html += '<div style="font-weight:700;color:var(--gold);margin:12px 0 6px;font-size:0.82rem">DRL COVERAGE: '+found+'/'+drlResults.length+'</div>';
        html += '<div class="ils-coverage-bar" style="margin-bottom:4px"><div class="ils-coverage-fill" style="width:'+Math.round(found/drlResults.length*100)+'%;background:'+(found/drlResults.length>=0.8?'#14f195':found/drlResults.length>=0.5?'#ffa500':'#ff3333')+'"></div></div>';
    }
    el.innerHTML = html;
}

function renderILSActions(actions) {
    const el = document.getElementById('ilsActions');
    if (!el) return;
    if (!actions.length) {
        el.innerHTML = '<div style="color:var(--green);text-align:center;padding:1rem"><i class="fas fa-check-circle" style="font-size:1.5rem;display:block;margin-bottom:6px"></i>No gaps detected. ILS package appears complete.</div>';
        return;
    }
    const crit = actions.filter(a => a.severity==='critical'), warn = actions.filter(a => a.severity==='warning');
    let html = '';
    if (crit.length) {
        html += '<div style="color:var(--red);font-weight:700;margin-bottom:6px;font-size:0.82rem"><i class="fas fa-skull-crossbones"></i> CRITICAL (' + crit.length + ')</div>';
        crit.forEach(a => { html += renderActionItem(a); });
    }
    if (warn.length) {
        html += '<div style="color:#ffa500;font-weight:700;margin:8px 0 6px;font-size:0.82rem"><i class="fas fa-exclamation-triangle"></i> WARNING (' + warn.length + ')</div>';
        warn.forEach(a => { html += renderActionItem(a); });
    }
    el.innerHTML = html;
}

function renderActionItem(a) {
    return '<div class="ils-action-item '+(a.severity==='critical'?'critical':'warning')+'">'
        + '<div class="action-header"><span class="action-title">'+a.id+': '+a.title+'</span><span class="action-owner">'+a.owner+'</span></div>'
        + '<div class="action-detail"><strong>Action:</strong> '+a.action+'</div>'
        + '<div class="action-detail"><strong>Est. Cost:</strong> $'+a.cost+'K &middot; <strong>Schedule Risk:</strong> '+a.schedule
        + (a.secondary ? ' &middot; <strong>Coord:</strong> '+a.secondary : '') + '</div></div>';
}

function renderILSCost(actions, totalCost, critGaps) {
    const el = document.getElementById('ilsCostSchedule');
    if (!el) return;
    if (!actions.length) { el.innerHTML = '<div style="color:var(--green);text-align:center;padding:0.5rem"><i class="fas fa-check-circle"></i> No cost or schedule risk identified.</div>'; return; }
    const maxSch = critGaps > 3 ? '6-12 months' : critGaps > 0 ? '2-6 months' : '< 2 months';
    el.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">'
        + '<div style="background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:12px;text-align:center">'
        + '<div style="font-size:1.5rem;font-weight:800;color:#ff3333">$'+totalCost+'K</div><div style="font-size:0.75rem;color:var(--muted)">Est. Risk Cost</div></div>'
        + '<div style="background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2);border-radius:8px;padding:12px;text-align:center">'
        + '<div style="font-size:1.5rem;font-weight:800;color:#ffa500">'+maxSch+'</div><div style="font-size:0.75rem;color:var(--muted)">Schedule Risk</div></div></div>'
        + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'
        + '<div style="text-align:center;padding:8px"><div style="font-size:1.2rem;font-weight:700;color:#ff3333">'+critGaps+'</div><div style="font-size:0.75rem;color:var(--muted)">Critical Path Items</div></div>'
        + '<div style="text-align:center;padding:8px"><div style="font-size:1.2rem;font-weight:700;color:#ffa500">'+actions.length+'</div><div style="font-size:0.75rem;color:var(--muted)">Total Action Items</div></div></div>';
}

function renderILSResult() {
    if (!ilsResults) return;
    const r = ilsResults;
    const panel = document.getElementById('ilsResult');
    const progStr = r.prog.name + (r.hull ? ' \u2014 ' + r.hull : '');
    const phaseStr = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || '';
    const clComplete = r.clItems.filter(i=>i.checked).length;
    panel.innerHTML = '<div class="result-label">ILS ANALYSIS \u2014 ' + progStr.toUpperCase() + '</div>'
        + '<div style="margin:0.5rem 0;font-size:0.85rem;color:var(--muted)">Office: '+r.prog.ofc+' \u00b7 Phase: '+phaseStr+' \u00b7 Files: '+ilsFiles.length+'</div>'
        + '<div style="margin:0.8rem 0"><span style="font-size:1.3rem;font-weight:800;color:'+(r.pct>=80?'var(--green)':r.pct>=50?'#ffa500':'var(--red)')+'">'+r.pct+'% Overall Readiness</span></div>'
        + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:0.8rem 0">'
        + '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center"><div style="font-size:1.1rem;font-weight:700;color:var(--accent)">'+clComplete+'/'+r.clItems.length+'</div><div style="font-size:0.72rem;color:var(--muted)">Checklist Items</div></div>'
        + '<div style="background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:8px;text-align:center"><div style="font-size:1.1rem;font-weight:700;color:var(--gold)">'+r.drlFound+'/'+r.drlTotal+'</div><div style="font-size:0.72rem;color:var(--muted)">DRL Items Verified</div></div></div>'
        + (r.critGaps > 0
            ? '<div style="background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:10px;margin:0.8rem 0;font-size:0.88rem"><i class="fas fa-exclamation-triangle" style="color:#ff3333"></i> <strong style="color:#ff3333">'+r.critGaps+' critical gap'+(r.critGaps>1?'s':'')+' found</strong> \u2014 Est. risk: <strong>$'+r.totalCost+'K</strong>. See Action Items.</div>'
            : '<div style="background:rgba(20,241,149,0.08);border:1px solid rgba(20,241,149,0.2);border-radius:8px;padding:10px;margin:0.8rem 0;font-size:0.88rem"><i class="fas fa-check-circle" style="color:var(--green)"></i> <strong style="color:var(--green)">All critical items accounted for.</strong> Package appears ready for review.</div>')
        + '<div style="margin-top:1rem;font-size:0.78rem;color:var(--muted)">Analysis based on DoD 5000 series ILS requirements per program type. Always verify against your contract-specific DRL.</div>';
    panel.classList.add('show');
    showPostActions();
    // Notify AI agent that analysis is available
    addAiMessage('Analysis complete! <strong>' + r.prog.name + '</strong> scored <strong>' + r.pct + '%</strong> readiness with <strong>' + r.critGaps + ' critical gaps</strong>. Ask me anything about the results.', 'bot');
}

// ── Report Generation ──
function generateILSReport() {
    if (!ilsResults) { runFullILSAnalysis(); }
    if (!ilsResults) { alert('Please select a program and run analysis first.'); return; }
    const r = ilsResults, prog = r.prog;
    const phaseStr = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || '';
    const now = new Date();

    let rpt = '\u2550'.repeat(65) + '\n';
    rpt += '  S4 LEDGER \u2014 ILS DATA PACKAGE GAP ANALYSIS REPORT\n';
    rpt += '\u2550'.repeat(65) + '\n\n';
    rpt += 'Program:        ' + prog.name + (r.hull ? ' (' + r.hull + ')' : '') + '\n';
    rpt += 'Program Office: ' + prog.ofc + '\n';
    rpt += 'Platform Type:  ' + prog.type + '\n';
    rpt += 'Phase:          ' + phaseStr + '\n';
    rpt += 'Report Date:    ' + now.toISOString().split('T')[0] + '\n';
    rpt += 'Analyst Tool:   S4 Ledger ILS Intelligence v3.0\n';
    rpt += 'Classification: UNCLASSIFIED\n\n';
    rpt += '\u2500'.repeat(65) + '\n';
    rpt += '  OVERALL READINESS:     ' + r.pct + '%\n';
    rpt += '  Checklist Score:       ' + r.clPct + '% (' + r.clItems.filter(i=>i.checked).length + '/' + r.clItems.length + ' items)\n';
    rpt += '  DRL Coverage:          ' + r.drlPct + '% (' + r.drlFound + '/' + r.drlTotal + ' items)\n';
    rpt += '  Critical Gaps:         ' + r.critGaps + '\n';
    rpt += '  Total Action Items:    ' + r.actions.length + '\n';
    rpt += '  Est. Risk Cost:        $' + r.totalCost + 'K\n';
    rpt += '\u2500'.repeat(65) + '\n\n';

    rpt += 'DOCUMENTS ANALYZED (' + ilsFiles.length + '):\n';
    if (ilsFiles.length) ilsFiles.forEach(f => { rpt += '  \u2022 ' + f.name + ' \u2014 ' + f.records.length + ' items detected\n'; });
    else rpt += '  (No files uploaded \u2014 analysis based on checklist only)\n';

    rpt += '\n\nPROGRAM-SPECIFIC ILS CHECKLIST:\n' + '\u2500'.repeat(65) + '\n';
    r.clItems.forEach(item => {
        rpt += '  [' + (item.checked ? '\u2713' : '\u2717') + '] ' + item.l + (item.c ? ' (CRITICAL)' : '') + (item.checked ? '' : ' *** GAP ***') + '\n';
    });

    rpt += '\n\nDRL/CDRL COVERAGE:\n' + '\u2500'.repeat(65) + '\n';
    r.drlResults.forEach(d => {
        rpt += '  [' + (d.found ? '\u2713' : '\u2717') + '] ' + d.s + ' ' + d.di + ' \u2014 ' + d.t;
        if (d.found) rpt += ' (' + d.status + ')';
        else rpt += ' *** MISSING ***';
        if (d.c) rpt += ' [CRITICAL]';
        rpt += '\n';
    });

    if (r.actions.length) {
        rpt += '\n\nACTION ITEMS:\n' + '\u2550'.repeat(65) + '\n';
        r.actions.forEach(a => {
            rpt += '\n  ' + a.id + ' [' + a.severity.toUpperCase() + ']\n';
            rpt += '  Item:        ' + a.title + '\n';
            rpt += '  Action:      ' + a.action + '\n';
            rpt += '  Responsible: ' + a.owner + (a.secondary ? ' (Coord: ' + a.secondary + ')' : '') + '\n';
            rpt += '  Cost Impact: $' + a.cost + 'K   Schedule Risk: ' + a.schedule + '\n';
            rpt += '  ' + '\u2500'.repeat(50) + '\n';
        });
    }

    rpt += '\n\n' + '\u2500'.repeat(65) + '\n  RECOMMENDATIONS:\n';
    if (r.critGaps > 0) {
        rpt += '  1. Address all CRITICAL action items before next milestone review.\n';
        rpt += '  2. Issue Corrective Action Requests (CARs) for missing deliverables.\n';
        rpt += '  3. Schedule ILS Review Board to discuss gaps with contractor.\n';
        rpt += '  4. Update program risk register with identified cost/schedule impacts.\n';
    } else {
        rpt += '  1. Conduct final review of all deliverables for completeness.\n';
        rpt += '  2. Verify configuration baseline matches as-built documentation.\n';
        rpt += '  3. Proceed to next milestone with ILS package approval.\n';
    }
    rpt += '\n' + '\u2500'.repeat(65) + '\n  Generated by S4 Ledger | s4ledger.com\n';
    rpt += '  Hash-verified logistics for the defense industry\n' + '\u2550'.repeat(65) + '\n';

    const blob = new Blob([rpt], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = 'ILS_Gap_Analysis_' + r.progKey.toUpperCase() + '_' + now.toISOString().split('T')[0] + '.txt';
    a.click(); URL.revokeObjectURL(url);

    const panel = document.getElementById('ilsResult');
    panel.innerHTML = '<div style="color:var(--green);font-size:0.95rem;font-weight:700;margin-bottom:8px"><i class="fas fa-download"></i> Report downloaded!</div>'
        + '<pre style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;font-size:0.7rem;color:var(--steel);max-height:300px;overflow-y:auto;white-space:pre-wrap">' + rpt + '</pre>'
        + '<button style="margin-top:8px;background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:6px;padding:6px 16px;cursor:pointer;font-family:inherit;font-size:0.82rem;font-weight:600" onclick="navigator.clipboard.writeText(document.querySelector(\'#ilsResult pre\').textContent).then(()=>this.innerHTML=\'<i class=\\\'fas fa-check\\\'></i> Copied!\')"><i class="fas fa-copy"></i> Copy to Clipboard</button>';
    panel.classList.add('show');
}

async function anchorILSReport() {
    if (!ilsResults) { runFullILSAnalysis(); }
    if (!ilsResults) return;
    const reportStr = JSON.stringify({
        program: ilsResults.prog.name, hull: ilsResults.hull, score: ilsResults.pct,
        critGaps: ilsResults.critGaps, totalActions: ilsResults.actions.length,
        riskCost: ilsResults.totalCost, date: new Date().toISOString(), files: ilsFiles.map(f => f.name)
    });
    const hash = await sha256(reportStr);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();

    // Show the anchor animation (same as main anchor tab)
    showAnchorAnimation(hash, 'ILS Gap Analysis Report', 'UNCLASSIFIED');

    // POST to API (best-effort)
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({hash, record_type:'ILS_GAP_ANALYSIS', tx_hash:txHash, content_preview:'ILS Report: '+ilsResults.prog.name})}); }
    catch(e) { console.warn('API anchor failed:', e); }

    // Record in session
    const record = {
        type:'ILS_GAP_ANALYSIS', label:'ILS Gap Analysis Report', icon:'\uD83E\uDDE0', branch:'JOINT',
        hash, txHash, encrypted:false, timestamp:new Date().toISOString(),
        content:'ILS Analysis: ' + ilsResults.prog.name + ' — ' + ilsResults.pct + '% readiness'
    };
    sessionRecords.push(record);
    saveLocalRecord({
        hash, record_type:'ILS_GAP_ANALYSIS', record_label:'ILS Gap Analysis Report', branch:'JOINT',
        icon:'\uD83E\uDDE0', timestamp:new Date().toISOString(),
        timestamp_display: new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC',
        fee:0.01, tx_hash:txHash, system:'ILS Intelligence'
    });
    stats.anchored++;
    stats.types.add('ILS_GAP_ANALYSIS');
    stats.slsFees += 0.01;
    updateStats();
    saveStats();

    await new Promise(r => setTimeout(r, 3200));
    hideAnchorAnimation();
    await new Promise(r => setTimeout(r, 400));

    const panel = document.getElementById('ilsResult');
    panel.innerHTML = '<div class="result-label">ILS REPORT ANCHORED TO XRPL</div>'
        + '<div style="color:var(--green);font-weight:700;margin:0.5rem 0"><i class="fas fa-check-circle"></i> Report hash anchored successfully!</div>'
        + '<div class="result-label" style="margin-top:0.8rem">SHA-256 HASH</div><div class="hash-display">' + hash + '</div>'
        + '<div class="result-label">TX HASH</div><div style="color:var(--muted);margin-bottom:0.5rem;word-break:break-all">' + txHash + '</div>'
        + '<div class="result-label">PROGRAM</div><div style="margin-bottom:0.5rem">' + ilsResults.prog.name + (ilsResults.hull?' ('+ilsResults.hull+')':'') + '</div>'
        + '<div class="result-label">READINESS</div><div style="margin-bottom:0.5rem;color:'+(ilsResults.pct>=80?'var(--green)':ilsResults.pct>=50?'#ffa500':'var(--red)')+';font-weight:700">' + ilsResults.pct + '%</div>'
        + '<div class="result-label">$SLS FEE</div><div>0.01 $SLS \u2192 Treasury</div>'
        + '<div style="margin-top:0.8rem;font-size:0.82rem;color:var(--muted)">This hash is now immutably recorded on the XRP Ledger. Anyone with the original data can verify its integrity.</div>';
    panel.classList.add('show');
    showPostActions();
    updateTxLog();
}

// ═══ POST-ANALYSIS ACTIONS ═══
function showPostActions() {
    const el = document.getElementById('ilsPostActions');
    if (el) el.style.display = 'block';
}

function sendILSAnalysis() {
    if (!ilsResults) return;
    const subj = 'ILS Gap Analysis — ' + ilsResults.prog.name + ' — ' + ilsResults.pct + '% Readiness';
    document.getElementById('sendSubject').value = subj;
    document.getElementById('sendModal').classList.add('active');
}

function closeSendModal() { document.getElementById('sendModal').classList.remove('active'); }

function executeSend() {
    const emails = document.getElementById('sendEmail').value.trim();
    const subject = document.getElementById('sendSubject').value;
    const body = document.getElementById('sendMessage').value + '\n\n' + buildAnalysisSummaryText();
    const mailto = 'mailto:' + encodeURIComponent(emails) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    window.open(mailto, '_blank');
    closeSendModal();
}

function copyAnalysisToClipboard() {
    const text = buildAnalysisSummaryText();
    navigator.clipboard.writeText(text).then(() => {
        alert('Analysis copied to clipboard!');
    });
}

function buildAnalysisSummaryText() {
    if (!ilsResults) return '';
    const r = ilsResults;
    let txt = 'S4 LEDGER — ILS GAP ANALYSIS SUMMARY\n';
    txt += '═══════════════════════════════════════\n';
    txt += 'Program: ' + r.prog.name + (r.hull ? ' ('+r.hull+')' : '') + '\n';
    txt += 'Office: ' + r.prog.ofc + '\n';
    txt += 'Overall Readiness: ' + r.pct + '%\n';
    txt += 'Critical Gaps: ' + r.critGaps + '\n';
    txt += 'Total Action Items: ' + r.actions.length + '\n';
    txt += 'Est. Risk Cost: $' + r.totalCost + 'K\n\n';
    if (r.actions.length) {
        txt += 'TOP ACTION ITEMS:\n';
        r.actions.slice(0,5).forEach(a => { txt += '  • [' + a.severity.toUpperCase() + '] ' + a.title + ' — ' + a.owner + '\n'; });
    }
    txt += '\nGenerated by S4 Ledger | s4ledger.com\n';
    return txt;
}

function scheduleILSMeeting() {
    if (!ilsResults) return;
    const title = 'ILS Review Board — ' + ilsResults.prog.name + ' (' + ilsResults.pct + '% Readiness)';
    document.getElementById('meetTitle').value = title;
    // Default to next Wednesday at 10:00
    const nextWed = new Date();
    nextWed.setDate(nextWed.getDate() + ((3 - nextWed.getDay() + 7) % 7 || 7));
    document.getElementById('meetDate').value = nextWed.toISOString().split('T')[0];
    document.getElementById('meetingModal').classList.add('active');
}

function closeMeetingModal() { document.getElementById('meetingModal').classList.remove('active'); }

function createTeamsMeeting() {
    const title = document.getElementById('meetTitle').value;
    const date = document.getElementById('meetDate').value;
    const time = document.getElementById('meetTime').value;
    const attendees = document.getElementById('meetAttendees').value;
    // Open Teams meeting creation
    const teamsUrl = 'https://teams.microsoft.com/l/meeting/new?subject=' + encodeURIComponent(title) + '&attendees=' + encodeURIComponent(attendees) + '&startTime=' + date + 'T' + time;
    window.open(teamsUrl, '_blank');
    closeMeetingModal();
}

function createCalendarEvent() {
    if (!ilsResults) return;
    const title = document.getElementById('meetTitle').value;
    const date = document.getElementById('meetDate').value.replace(/-/g,'');
    const time = document.getElementById('meetTime').value.replace(':','') + '00';
    const endTime = String(parseInt(document.getElementById('meetTime').value.split(':')[0])+1).padStart(2,'0') + document.getElementById('meetTime').value.split(':')[1] + '00';
    const desc = buildAnalysisSummaryText();
    const ics = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//S4 Ledger//ILS Intelligence//EN',
        'BEGIN:VEVENT',
        'DTSTART:' + date + 'T' + time,
        'DTEND:' + date + 'T' + endTime,
        'SUMMARY:' + title,
        'DESCRIPTION:' + desc.replace(/\n/g,'\\n'),
        'ORGANIZER:S4 Ledger ILS Intelligence',
        'END:VEVENT','END:VCALENDAR'
    ].join('\r\n');
    const blob = new Blob([ics], {type:'text/calendar'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'ILS_Review_' + ilsResults.progKey + '.ics';
    a.click();
    closeMeetingModal();
}

function exportActionTracker() {
    if (!ilsResults || !ilsResults.actions.length) { alert('Run analysis first to generate action items.'); return; }
    let csv = 'Action ID,Severity,Title,Required Action,Responsible Party,Coordinator,Est Cost ($K),Schedule Risk,Status,Due Date,Notes\n';
    ilsResults.actions.forEach(a => {
        const due = new Date(); due.setDate(due.getDate() + (a.severity==='critical'?30:60));
        csv += a.id + ',' + a.severity.toUpperCase() + ',"' + a.title + '","' + a.action + '",' + a.owner + ',' + (a.secondary||'') + ',' + a.cost + ',' + a.schedule + ',Open,' + due.toISOString().split('T')[0] + ',\n';
    });
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Action_Tracker_' + ilsResults.progKey.toUpperCase() + '_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
}

function printILSReport() {
    if (!ilsResults) { alert('Run analysis first.'); return; }
    generateILSReport(); // This downloads the report
    setTimeout(() => window.print(), 500);
}

function saveILSReport() {
    if (!ilsResults) { alert('Run analysis first.'); return; }
    generateILSReport();
}

// ═══ S4 ILS AI AGENT ═══
function aiSend() {
    const input = document.getElementById('aiChatInput');
    const msg = input.value.trim();
    if (!msg) return;
    input.value = '';
    addAiMessage(msg, 'user');
    setTimeout(() => {
        const response = generateAiResponse(msg);
        addAiMessage(response, 'bot');
    }, 400 + Math.random() * 600);
}

function aiAsk(question) {
    document.getElementById('aiChatInput').value = question;
    aiSend();
}

function addAiMessage(text, type) {
    const container = document.getElementById('aiChatMessages');
    const div = document.createElement('div');
    div.className = 'ai-msg ' + type;
    if (type === 'bot') {
        div.innerHTML = '<div class="ai-label"><i class="fas fa-robot"></i> S4 Agent</div>' + text;
    } else {
        div.textContent = text;
    }
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function generateAiResponse(query) {
    const q = query.toLowerCase();
    const r = ilsResults;

    // Context-aware responses based on analysis state
    if (!r) {
        if (/gap|analysis|result|score|status/.test(q)) return 'I don\'t have any analysis results yet. Please upload documents and click <strong>"Run Full Analysis"</strong> to generate results I can help interpret.';
        if (/di-?\d+|di number/.test(q)) return explainDINumber(q);
        if (/what.*do|help|how.*work/.test(q)) return 'I can help you with:<br>• <strong>Interpreting gap analysis results</strong> after you run an analysis<br>• <strong>Explaining DI number requirements</strong> (e.g., "What is DI-009?")<br>• <strong>Suggesting corrective actions</strong> for identified gaps<br>• <strong>Drafting CARs</strong> (Corrective Action Requests)<br>• <strong>Estimating cost/schedule impacts</strong><br><br>Upload your documents and run analysis to get started!';
        if (/lcsp|life cycle/.test(q)) return '<strong>Life Cycle Sustainment Plan (LCSP)</strong> — DI-039 / DI-ILSS-81490<br><br>The LCSP is a top-level ILS planning document that:<br>• Defines the sustainment strategy for the entire program lifecycle<br>• Addresses all 12 ILS elements<br>• Establishes performance metrics (Ao, MTBF, MTTR)<br>• Required per DoD Instruction 5000.02<br><br>Use the <strong>"Load Full ILS Package"</strong> button to see a sample LCSP.';
        return 'I\'m your ILS Intelligence Agent. I can help with DI numbers, gap analysis, CARs, and ILS requirements. Run an analysis to get context-specific insights, or ask me about any DI number or ILS topic!';
    }

    // Has analysis results
    if (/summarize|summary|overview|gap/.test(q)) {
        const critActions = r.actions.filter(a=>a.severity==='critical');
        let resp = '<strong>' + r.prog.name + '</strong> — Overall Readiness: <strong style="color:'+(r.pct>=80?'#14f195':r.pct>=50?'#ffa500':'#ff3333')+'">' + r.pct + '%</strong><br><br>';
        resp += '\uD83D\uDCCB Checklist: ' + r.clItems.filter(i=>i.checked).length + '/' + r.clItems.length + ' items (' + r.clPct + '%)<br>';
        resp += '\uD83D\uDCC4 DRL Coverage: ' + r.drlFound + '/' + r.drlTotal + ' items (' + r.drlPct + '%)<br>';
        if (critActions.length) {
            resp += '<br>\u26A0\uFE0F <strong style="color:#ff3333">' + critActions.length + ' critical gaps:</strong><br>';
            critActions.slice(0,3).forEach(a => { resp += '• ' + a.title + '<br>'; });
            if (critActions.length > 3) resp += '• ...and ' + (critActions.length-3) + ' more<br>';
        }
        resp += '<br>\uD83D\uDCB0 Est. risk cost: <strong>$' + r.totalCost + 'K</strong>';
        return resp;
    }

    if (/critical|urgent|important|priority/.test(q)) {
        const crit = r.actions.filter(a=>a.severity==='critical');
        if (!crit.length) return '\u2705 <strong>No critical items found!</strong> Your ILS package appears to cover all critical requirements. Review the warning-level items to ensure full compliance.';
        let resp = '\u26A0\uFE0F <strong style="color:#ff3333">' + crit.length + ' Critical Items Requiring Immediate Attention:</strong><br><br>';
        crit.forEach((a,i) => {
            resp += '<strong>' + (i+1) + '. ' + a.id + '</strong>: ' + a.title + '<br>';
            resp += '   \u2192 ' + a.action + '<br>';
            resp += '   \uD83D\uDC64 Owner: ' + a.owner + ' | \uD83D\uDCB0 $' + a.cost + 'K | \u23F0 ' + a.schedule + '<br><br>';
        });
        resp += '<strong>Recommendation:</strong> Issue CARs for all critical items and escalate to the next ILS Review Board.';
        return resp;
    }

    if (/car|corrective\s*action/.test(q)) {
        const gaps = r.actions.filter(a=>a.severity==='critical');
        if (!gaps.length) return 'No critical gaps found that require a CAR. Your ILS package appears complete for this phase.';
        const g = gaps[0];
        return '<strong>DRAFT — Corrective Action Request (CAR)</strong><br><br>' +
            '<strong>CAR Number:</strong> CAR-' + r.progKey.toUpperCase() + '-' + new Date().getFullYear() + '-001<br>' +
            '<strong>Program:</strong> ' + r.prog.name + '<br>' +
            '<strong>Office:</strong> ' + r.prog.ofc + '<br>' +
            '<strong>Date:</strong> ' + new Date().toISOString().split('T')[0] + '<br><br>' +
            '<strong>Deficiency:</strong> ' + g.title + '<br>' +
            '<strong>Required Action:</strong> ' + g.action + '<br>' +
            '<strong>Days to Respond:</strong> 14 calendar days<br>' +
            '<strong>Impact if Not Corrected:</strong> $' + g.cost + 'K cost risk, ' + g.schedule + ' schedule impact<br>' +
            '<strong>Responsible Party:</strong> ' + g.owner + '<br><br>' +
            '<em>Note: ' + (gaps.length-1) + ' additional CARs may be required for remaining critical gaps.</em>';
    }

    if (/cost|risk|money|budget|expense/.test(q)) {
        return '<strong>Cost & Schedule Risk Summary</strong><br><br>' +
            '\uD83D\uDCB0 Total Estimated Risk: <strong style="color:#ff3333">$' + r.totalCost + 'K</strong><br>' +
            '\u23F0 Schedule Risk: <strong style="color:#ffa500">' + (r.critGaps > 3 ? '6-12 months' : r.critGaps > 0 ? '2-6 months' : '< 2 months') + '</strong><br>' +
            '\uD83D\uDEA8 Critical Path Items: <strong>' + r.critGaps + '</strong><br><br>' +
            'Cost breakdown by ILS element:<br>' +
            r.actions.slice(0,5).map(a => '• ' + a.id + ': $' + a.cost + 'K (' + a.title.substring(0,40) + ')').join('<br>') +
            '<br><br>Early resolution typically reduces costs by 30-50% vs. late-stage remediation.';
    }

    if (/missing|di.*number|what.*missing/.test(q)) {
        const missing = r.drlResults.filter(d => !d.found);
        if (!missing.length) return '\u2705 All DRL/CDRL items have been accounted for! No missing DI numbers detected.';
        let resp = '\uD83D\uDCC4 <strong>Missing DI Numbers (' + missing.length + '):</strong><br><br>';
        missing.forEach(d => {
            resp += '• <strong>' + d.di + '</strong> — ' + d.t + (d.c ? ' <span style="color:#ff3333">[CRITICAL]</span>' : '') + '<br>';
        });
        return resp;
    }

    if (/next\s*step|recommend|suggest|what.*should/.test(q)) {
        let resp = '<strong>Recommended Next Steps:</strong><br><br>';
        if (r.critGaps > 0) {
            resp += '1. \uD83D\uDEA8 <strong>Address critical gaps immediately</strong> — ' + r.critGaps + ' items need action before next milestone<br>';
            resp += '2. \uD83D\uDCDD <strong>Issue CARs</strong> for all missing critical deliverables<br>';
            resp += '3. \uD83D\uDCC5 <strong>Schedule ILS Review Board</strong> within 2 weeks to discuss contractor compliance<br>';
            resp += '4. \uD83D\uDCCA <strong>Update program risk register</strong> with $' + r.totalCost + 'K estimated impact<br>';
            resp += '5. \u2693 <strong>Anchor this analysis</strong> to XRPL for immutable audit trail<br>';
        } else {
            resp += '1. \u2705 <strong>Review complete package</strong> for final quality check<br>';
            resp += '2. \uD83D\uDD0D <strong>Verify configuration baseline</strong> matches as-built<br>';
            resp += '3. \uD83D\uDCDD <strong>Prepare milestone briefing</strong> with readiness score<br>';
            resp += '4. \u2693 <strong>Anchor final analysis</strong> for permanent record<br>';
        }
        return resp;
    }

    if (/di-?\d+/.test(q)) return explainDINumber(q);

    return 'I can help with that! Try asking me to:<br>• <strong>"Summarize my gaps"</strong> — overview of analysis results<br>• <strong>"What are the critical items?"</strong> — priority action list<br>• <strong>"Draft a CAR"</strong> — Corrective Action Request template<br>• <strong>"Estimate total risk"</strong> — cost & schedule impact<br>• <strong>"What DI numbers am I missing?"</strong> — missing deliverables<br>• <strong>"Suggest next steps"</strong> — recommended actions<br>• <strong>"What is DI-009?"</strong> — explain any DI number';
}

function explainDINumber(q) {
    const match = q.match(/di-?0*(\d+)/i);
    if (!match) return 'Please specify a DI number (e.g., DI-009, DI-020).';
    const num = parseInt(match[1]);
    const diInfo = {
        1: {t:'Contract Data Requirements List (CDRL)', desc:'Master list of all contractual deliverables. References MIL-STD-1808.'},
        2: {t:'SOW Compliance Matrix', desc:'Maps SOW paragraphs to contractor compliance status.'},
        3: {t:'Integrated Master Schedule (IMS)', desc:'High-level program schedule linking all logistics milestones.'},
        4: {t:'Systems Engineering Plan (SEP)', desc:'Systems engineering approach and design review gates.'},
        5: {t:'Interface Control Document (ICD)', desc:'Defines all system interfaces (mechanical, electrical, data).'},
        6: {t:'Test & Evaluation Master Plan (TEMP)', desc:'Comprehensive T&E strategy per DoDI 5000.89.'},
        7: {t:'Weight Report', desc:'Weight accounting for hull margins, stability compliance.'},
        8: {t:'Electrical Load Analysis', desc:'Power generation vs. demand analysis for all ship conditions.'},
        9: {t:'Purchase Order Index', desc:'Tracks all subcontract and material purchase orders. Essential for schedule management and GFM coordination.'},
        10: {t:'Long Lead Time Material List', desc:'Items with procurement lead > 6 months. Critical for schedule risk.'},
        11: {t:'Government Furnished Material (GFM) List', desc:'All GFM items the government must provide to the contractor.'},
        12: {t:'HazMat List', desc:'Hazardous material inventory per environmental compliance requirements.'},
        20: {t:'Vendor Recommended Spares (VRS)', desc:'Manufacturer-recommended spare parts for initial provisioning. Basis for COSAL/APL development. Critical for post-delivery readiness.'},
        21: {t:'Allowance Parts List (APL)', desc:'Authorized shipboard spare parts inventory (COSAL).'},
        31: {t:'IUID Register', desc:'Item Unique Identification per MIL-STD-130. Tracks serially-managed components.'},
        32: {t:'Maintenance Requirement Cards (MRCs)', desc:'Planned maintenance task cards per Navy PMS system.'},
        39: {t:'Life Cycle Sustainment Plan (LCSP)', desc:'Top-level sustainment strategy addressing all 12 ILS elements.'},
        41: {t:'Machinery Equipment List (MEL)', desc:'Complete listing of installed machinery and equipment, including manufacturer, model, and location.'},
        44: {t:'Spares Buylist / Initial Outfitting', desc:'Initial provisioning purchase list for pre-delivery outfitting.'}
    };
    const info = diInfo[num];
    if (info) return '<strong>DI-' + String(num).padStart(3,'0') + ': ' + info.t + '</strong><br><br>' + info.desc;
    return 'DI-' + String(num).padStart(3,'0') + ' — I don\'t have detailed information on that specific DI number. Common PMS 300 DI numbers range from DI-001 (CDRL) through DI-044 (Spares Buylist). Ask about one of those!';
}

// ── Initialization ──
function initILSEngine() {
    initILSChecklist(document.getElementById('ilsProgram').value);
    setupILSDropzone();
    onILSProgramChange();
}

document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    renderTypeGrid();
    loadSample('supply');
    initILSEngine();
});

</script>
<script>
if(typeof particlesJS!=='undefined'&&document.getElementById('particles-js')){particlesJS('particles-js',{particles:{number:{value:35},color:{value:'#00aaff'},opacity:{value:0.12},size:{value:2},line_linked:{enable:true,distance:150,color:'#00aaff',opacity:0.06,width:1},move:{enable:true,speed:0.7}},interactivity:{events:{onhover:{enable:true,mode:'grab'}},modes:{grab:{distance:130,line_linked:{opacity:0.15}}}}});}
</script>

<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" style="position:fixed;bottom:30px;right:30px;width:45px;height:45px;background:linear-gradient(135deg,#00aaff,#c9a84c);border:none;border-radius:50%;color:#fff;font-size:1.3rem;cursor:pointer;opacity:0;visibility:hidden;transition:all 0.3s;z-index:999;display:flex;align-items:center;justify-content:center;">&uarr;</button>
<script>
// Scroll progress bar
window.addEventListener('scroll', function() {
    var scroll = window.scrollY;
    var height = document.documentElement.scrollHeight - window.innerHeight;
    var bar = document.getElementById('scrollProgress');
    if (bar) bar.style.width = (height > 0 ? (scroll / height * 100) : 0) + '%';
    var btn = document.getElementById('backToTop');
    if (btn) { if (scroll > 400) { btn.style.opacity='1'; btn.style.visibility='visible'; } else { btn.style.opacity='0'; btn.style.visibility='hidden'; } }
});
// Reveal on scroll
var revealObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) { if (entry.isIntersecting) entry.target.classList.add('visible'); });
}, { threshold: 0.1 });
document.querySelectorAll('.reveal-demo').forEach(function(el) { revealObserver.observe(el); });
</script>
</body>
</html>
