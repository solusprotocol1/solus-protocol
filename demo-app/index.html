<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="S4 Ledger Defense Logistics Demo — Anchor, verify, and track defense records across all military branches on XRPL.">
    <title>S4 Ledger | Defense Logistics Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root{--bg:#050810;--surface:#0a1020;--card:#0f1630;--border:#1a2550;--accent:#00aaff;--gold:#c9a84c;--steel:#8ea4b8;--green:#14f195;--red:#ff6b6b;--text:#e0e8f0;--muted:#6b7d93}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .navbar-custom{background:rgba(5,8,16,0.95);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:10px 0;position:fixed;top:0;width:100%;z-index:1000}
        .navbar-brand{font-weight:700;display:flex;align-items:center;gap:10px;text-decoration:none}
        .brand-text{background:linear-gradient(135deg,#00aaff,#ffffff,#c9a84c);background-size:300% 300%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:brandGradient 4s ease infinite;font-size:1.2rem;letter-spacing:0.5px}
        .nav-link{color:#fff!important;padding:8px 12px!important;font-size:0.9rem!important;font-weight:500;transition:color 0.2s}
        .nav-link:hover,.nav-link.active{color:var(--accent)!important}
        .hero{padding:7.5rem 0 3rem;text-align:center;background:linear-gradient(180deg,rgba(0,170,255,0.05) 0%,transparent 60%)}
        .hero h1{font-size:2.4rem;font-weight:800;margin-bottom:0.75rem}.hero h1 .accent{color:var(--accent)}.hero h1 .gold{color:var(--gold)}
        .hero p{color:var(--steel);font-size:1.1rem;max-width:700px;margin:0 auto 1.5rem}
        .badge-live{display:inline-flex;align-items:center;gap:6px;background:rgba(20,241,149,0.1);border:1px solid rgba(20,241,149,0.3);color:var(--green);padding:6px 16px;border-radius:20px;font-size:0.85rem;font-weight:600}
        .badge-live::before{content:'';width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
        .tab-section{padding:2rem 0}
        .nav-pills .nav-link{background:var(--card);color:var(--steel)!important;border:1px solid var(--border);margin-right:0.5rem;margin-bottom:0.5rem;border-radius:8px;font-weight:600;padding:0.6rem 1.2rem;transition:all 0.2s}
        .nav-pills .nav-link:hover{color:var(--accent)!important}
        .nav-pills .nav-link.active{background:linear-gradient(135deg,#00aaff,#0088cc)!important;color:#fff!important;border-color:transparent!important;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
        .tab-content{margin-top:1.5rem}
        .demo-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}
        .demo-card h3{font-size:1.1rem;font-weight:700;color:var(--accent);margin-bottom:1rem}
        .demo-card h3 i{margin-right:0.5rem}
        label{font-weight:600;color:var(--steel);margin-bottom:0.4rem;font-size:0.9rem}
        select,input,textarea{background:var(--surface)!important;color:var(--text)!important;border:1px solid var(--border)!important;border-radius:8px!important;padding:0.6rem 0.8rem!important;font-family:'Plus Jakarta Sans',sans-serif!important;font-size:0.95rem!important;width:100%}
        select:focus,input:focus,textarea:focus{border-color:var(--accent)!important;box-shadow:0 0 0 3px rgba(0,170,255,0.15)!important;outline:none}
        textarea{min-height:120px;resize:vertical;font-family:'Courier New',monospace!important;font-size:0.85rem!important}
        .btn-accent{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:0.65rem 1.5rem;font-weight:700;font-size:0.95rem;transition:all 0.2s;cursor:pointer}
        .btn-accent:hover{background:#0099ee;transform:translateY(-1px);color:#fff}
        .btn-accent:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-gold{background:var(--gold);color:#000;border:none;border-radius:8px;padding:0.65rem 1.5rem;font-weight:700;font-size:0.95rem;cursor:pointer}
        .btn-gold:hover{background:#dbb85c;color:#000}
        .result-panel{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:1.2rem;margin-top:1rem;display:none;font-family:'Courier New',monospace;font-size:0.85rem}
        .result-panel.show{display:block;animation:fadeIn 0.3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .result-label{color:var(--muted);font-size:0.75rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:0.3rem}
        .result-value{color:var(--green);word-break:break-all}
        .result-value.error{color:var(--red)}
        .hash-display{background:rgba(0,170,255,0.08);border:1px solid rgba(0,170,255,0.2);border-radius:6px;padding:0.6rem;word-break:break-all;color:var(--accent);margin:0.5rem 0}
        .branch-tabs{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
        .branch-tab{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 14px;font-size:0.82rem;font-weight:600;cursor:pointer;color:var(--steel);transition:all 0.2s;font-family:inherit}
        .branch-tab:hover{border-color:var(--accent);color:var(--accent)}
        .branch-tab.active{background:linear-gradient(135deg,#00aaff,#0088cc);border-color:transparent;color:#fff!important;box-shadow:0 2px 10px rgba(0,170,255,0.3)}
        .record-type-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:0.6rem;margin-bottom:1rem;max-height:280px;overflow-y:auto;padding-right:4px}
        .record-type-btn{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.6rem 0.7rem;cursor:pointer;text-align:center;transition:all 0.2s;font-size:0.78rem;font-weight:600}
        .record-type-btn:hover{border-color:var(--accent);background:rgba(0,170,255,0.05)}
        .record-type-btn.selected{border-color:var(--accent);background:linear-gradient(135deg,#00aaff,#0088cc);color:#fff;box-shadow:0 4px 15px rgba(0,170,255,0.3)}
        .record-type-btn .icon{font-size:1.2rem;display:block;margin-bottom:0.2rem}
        .type-search{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:0.85rem;color:var(--text);width:100%;margin-bottom:8px;font-family:inherit}
        .type-search:focus{border-color:var(--accent);outline:none;box-shadow:0 0 0 2px rgba(0,170,255,0.15)}
        .type-search::placeholder{color:var(--muted)}
        .tx-log{max-height:400px;overflow-y:auto}
        .tx-entry{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0.8rem 1rem;margin-bottom:0.5rem;display:flex;align-items:center;gap:1rem;transition:all 0.2s}
        .tx-entry:hover{border-color:var(--accent)}
        .tx-icon{font-size:1.4rem;min-width:36px;text-align:center}
        .tx-info{flex:1}.tx-type{font-weight:700;font-size:0.9rem}.tx-hash{font-family:monospace;color:var(--muted);font-size:0.75rem}
        .tx-time{color:var(--muted);font-size:0.75rem;white-space:nowrap}
        .tx-badge{font-size:0.7rem;font-weight:700;padding:2px 8px;border-radius:4px}
        .tx-badge.anchored{background:rgba(20,241,149,0.15);color:var(--green)}
        .stat-card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:1.2rem;text-align:center}
        .stat-value{font-size:2rem;font-weight:800;color:var(--accent)}.stat-label{font-size:0.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
        footer{border-top:1px solid var(--border);padding:2rem 0;margin-top:3rem;text-align:center;color:var(--muted);font-size:0.85rem}
        footer a{color:var(--accent);text-decoration:none}
        .sample-btn{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:0.4rem 0.8rem;cursor:pointer;font-size:0.8rem;color:var(--steel);transition:all 0.2s;display:inline-block;margin:0.2rem}
        .sample-btn:hover{border-color:var(--gold);color:var(--gold)}
        #particles-js{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;pointer-events:none}
        .mesh-overlay{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:-1}
        .g-orb{position:absolute;border-radius:50%;filter:blur(120px);opacity:0.15}
        .g-orb-1{width:600px;height:600px;background:#003366;top:-200px;right:-200px}
        .g-orb-2{width:400px;height:400px;background:#001a33;bottom:-100px;left:-100px}
        .g-orb-3{width:300px;height:300px;background:linear-gradient(135deg,#00aaff,#003366);top:50%;left:50%;transform:translate(-50%,-50%)}
        .anchor-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(5,8,16,0.94);display:flex;align-items:center;justify-content:center;z-index:9999;opacity:0;pointer-events:none;transition:opacity 0.4s}
        .anchor-overlay.active{opacity:1;pointer-events:all}
        .anchor-anim-box{text-align:center;max-width:500px;padding:2rem}
        .chain-segment{width:3px;height:0;background:linear-gradient(to bottom,#00aaff,rgba(0,170,255,0.2));margin:0 auto;animation:chainGrow 0.5s ease-out 0.15s forwards}
        @keyframes chainGrow{to{height:50px}}
        .anchor-drop-icon{font-size:5rem;color:var(--accent);animation:anchorDrop 1.2s ease-in-out;filter:drop-shadow(0 0 25px rgba(0,170,255,0.5))}
        @keyframes anchorDrop{0%{transform:translateY(-80px) scale(0.5);opacity:0}40%{transform:translateY(10px) scale(1.15);opacity:1}60%{transform:translateY(-8px) scale(0.95)}80%{transform:translateY(3px) scale(1.02)}100%{transform:translateY(0) scale(1)}}
        .anim-status{font-size:1.15rem;font-weight:700;color:var(--accent);margin-top:1rem;animation:fadeUp 0.5s ease-out 0.5s both}
        .anim-hash{font-family:monospace;color:var(--accent);font-size:0.8rem;margin-top:0.8rem;word-break:break-all;opacity:0;animation:fadeUp 0.5s ease-out 1s both;background:rgba(0,170,255,0.08);padding:10px;border-radius:8px;border:1px solid rgba(0,170,255,0.2)}
        .anim-fee{font-size:0.9rem;color:var(--gold);margin-top:0.5rem;opacity:0;animation:fadeUp 0.5s ease-out 1.3s both}
        .anim-success{font-size:1.3rem;font-weight:800;color:var(--green);margin-top:1rem;opacity:0;animation:scaleIn 0.4s ease-out 2s both}
        @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes scaleIn{from{opacity:0;transform:scale(0)}to{opacity:1;transform:scale(1)}}
        .branch-count{font-size:0.8rem;color:var(--muted);margin-bottom:6px}
        ::-webkit-scrollbar{width:6px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        @media(max-width:768px){.hero h1{font-size:1.6rem}.record-type-grid{grid-template-columns:repeat(2,1fr)}.branch-tabs{gap:4px}.branch-tab{font-size:0.75rem;padding:5px 10px}}

        @keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
        @keyframes brandGradient{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
        .scroll-progress{position:fixed;top:0;left:0;width:0%;height:3px;background:linear-gradient(90deg,#00aaff,#c9a84c);z-index:10000;transition:width 0.1s linear;box-shadow:0 0 10px #00aaff}
        .reveal-demo{opacity:0;transform:translateY(25px);transition:all 0.5s ease-out}
        .reveal-demo.visible{opacity:1;transform:translateY(0)}
        .gradient-text{background:linear-gradient(90deg,#00aaff,#ffffff,#c9a84c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .nav-logo{height:32px;width:32px;margin-right:8px;vertical-align:middle;animation:logoFloat 3s ease-in-out infinite}
        .footer-logo{height:28px;width:28px;margin-right:8px;vertical-align:middle;animation:logoFloat 4s ease-in-out infinite}
        .dropdown-menu{border-radius:10px;padding:8px 0;min-width:160px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
        .dropdown-item{padding:8px 18px;font-size:0.88rem;transition:background 0.2s,color 0.2s}
        .dropdown-item:hover,.dropdown-item:focus{background:rgba(0,170,255,0.12);color:var(--accent)!important}
        .copy-btn{background:rgba(0,170,255,0.15);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:6px;padding:4px 10px;font-size:0.75rem;cursor:pointer;font-family:inherit;transition:all 0.2s;margin-left:8px}
        .copy-btn:hover{background:rgba(0,170,255,0.3);color:#fff}
        .clf-banner{display:none;align-items:center;gap:10px;padding:10px 16px;border-radius:10px;margin:10px 0;font-size:0.88rem;font-weight:600;animation:fadeIn 0.25s ease-out}
        .clf-banner.show{display:flex}
        .clf-badge{padding:3px 12px;border-radius:6px;font-size:0.78rem;font-weight:800;letter-spacing:0.5px;text-transform:uppercase}
        .clf-U .clf-badge{background:rgba(0,170,0,0.15);color:#00cc66;border:1px solid rgba(0,170,0,0.3)}
        .clf-CUI .clf-badge{background:rgba(201,168,76,0.15);color:#c9a84c;border:1px solid rgba(201,168,76,0.3)}
        .clf-SECRET .clf-badge{background:rgba(255,50,50,0.15);color:#ff5555;border:1px solid rgba(255,50,50,0.3)}
        .clf-TS .clf-badge{background:rgba(255,165,0,0.15);color:#ffa500;border:1px solid rgba(255,165,0,0.35)}
        .clf-U{background:rgba(0,170,0,0.04);border:1px solid rgba(0,170,0,0.15)}
        .clf-CUI{background:rgba(201,168,76,0.04);border:1px solid rgba(201,168,76,0.15)}
        .clf-SECRET{background:rgba(255,50,50,0.04);border:1px solid rgba(255,50,50,0.15)}
        .clf-TS{background:rgba(255,165,0,0.04);border:1px solid rgba(255,165,0,0.15)}
        .clf-text{font-size:0.82rem;color:var(--steel);font-weight:400}
        .clf-icon{font-size:1.1rem}
        .ils-dropzone{border:2px dashed var(--border);border-radius:12px;padding:2rem;text-align:center;cursor:pointer;transition:all 0.3s;background:rgba(0,170,255,0.02);margin-bottom:1rem}
        .ils-dropzone:hover,.ils-dropzone.dragover{border-color:var(--accent);background:rgba(0,170,255,0.06)}
        .ils-dropzone i{font-size:2rem;color:var(--accent);margin-bottom:0.5rem;display:block}
        .ils-file-list{margin-bottom:1rem}
        .ils-file-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;font-size:0.85rem}
        .ils-file-item .file-info{display:flex;align-items:center;gap:8px}
        .ils-file-item .file-stats{color:var(--accent);font-size:0.78rem;font-weight:600}
        .ils-file-item .file-remove{color:var(--red);cursor:pointer;font-size:0.8rem;padding:2px 8px;border-radius:4px;transition:background 0.2s}
        .ils-file-item .file-remove:hover{background:rgba(255,107,107,0.15)}
        .ils-coverage-row{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.03);font-size:0.85rem}
        .ils-coverage-bar{flex:1;background:var(--surface);border-radius:4px;height:8px;overflow:hidden;border:1px solid var(--border)}
        .ils-coverage-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
        .ils-action-item{padding:12px;background:var(--surface);border-radius:8px;margin-bottom:8px;border-left:3px solid var(--accent);font-size:0.85rem}
        .ils-action-item.critical{border-left-color:var(--red)}
        .ils-action-item.warning{border-left-color:#ffa500}
        .ils-action-item .action-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .ils-action-item .action-title{font-weight:700;color:#fff}
        .ils-action-item .action-owner{font-size:0.78rem;padding:2px 8px;border-radius:4px;background:rgba(0,170,255,0.1);color:var(--accent)}
        .ils-action-item .action-detail{color:var(--steel);font-size:0.82rem}
        @media(max-width:991px){.navbar-collapse{background:rgba(5,8,16,0.98);padding:15px;border-radius:12px;margin-top:10px;border:1px solid var(--border);max-height:85vh;overflow-y:auto}.navbar-nav{gap:5px}.nav-link{padding:10px 15px!important;border-radius:8px}.nav-link:hover{background:rgba(0,170,255,0.1)}}
    </style>
</head>
<body>
<div class="scroll-progress" id="scrollProgress"></div>
<div class="mesh-overlay"><div class="g-orb g-orb-1"></div><div class="g-orb g-orb-2"></div><div class="g-orb g-orb-3"></div></div>
<div id="particles-js"></div>

<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="../"><img src="../s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="nav-logo"><span class="brand-text">S4 Ledger</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><i class="fas fa-bars" style="color:#fff"></i></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="../">Home</a></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Company</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1)"><li><a class="dropdown-item" href="../s4-about/" style="color:#fff">About Us</a></li><li><a class="dropdown-item" href="../s4-investors/" style="color:#fff">Investors</a></li><li><a class="dropdown-item" href="../s4-partners/" style="color:#fff">Partners</a></li></ul></li>
                <li class="nav-item dropdown"><a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">Products</a><ul class="dropdown-menu" style="background:rgba(5,8,16,0.98);border:1px solid rgba(255,255,255,0.1)"><li><a class="dropdown-item" href="#" style="color:#fff;font-weight:600"><i class="fas fa-play-circle" style="width:18px;margin-right:6px;color:#00aaff"></i>Demo App</a></li><li><a class="dropdown-item" href="../sdk-playground/" style="color:#fff"><i class="fas fa-code" style="width:18px;margin-right:6px;color:#c9a84c"></i>SDK Playground</a></li><li><a class="dropdown-item" href="../metrics.html" style="color:#fff"><i class="fas fa-chart-bar" style="width:18px;margin-right:6px;color:#00aaff"></i>Live Metrics</a></li><li><a class="dropdown-item" href="../transactions.html" style="color:#fff"><i class="fas fa-list" style="width:18px;margin-right:6px;color:#c9a84c"></i>Transactions</a></li><li><a class="dropdown-item" href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:#fff"><i class="fab fa-github" style="width:18px;margin-right:6px"></i>SDK & Docs</a></li></ul></li>
                <li class="nav-item"><a class="nav-link" href="../s4-use-cases/">Use Cases</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-pricing/">Pricing</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-roadmap/">Roadmap</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-faq/">FAQ</a></li>
                <li class="nav-item"><a class="nav-link" href="../s4-contact/">Contact</a></li>
            </ul>
        </div>
    </div>
</nav>

<section class="hero">
    <div class="container">
        <h1><i class="fas fa-shield-halved" style="margin-right:12px;color:var(--accent)"></i><span class="gradient-text">Defense Logistics</span> Verification Demo</h1>
        <p>Anchor, verify, and track defense supply chain records across <strong>all military branches</strong> on the XRP Ledger.</p>
        <div class="badge-live">XRPL Testnet Connected &mdash; 160+ Record Types &bull; 9 Branches</div>
    </div>
</section>

<section class="tab-section reveal-demo">
    <div class="container">
        <div class="row mb-4 reveal-demo" id="statsRow">
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statAnchored">0</div><div class="stat-label">Records Anchored</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statVerified">0</div><div class="stat-label">Records Verified</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statTypes">0</div><div class="stat-label">Record Types Used</div></div></div>
            <div class="col-6 col-md-3 mb-3"><div class="stat-card"><div class="stat-value" id="statSlsFees">0.000</div><div class="stat-label">$SLS Fees</div></div></div>
        </div>

        <ul class="nav nav-pills mb-2" role="tablist">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tabAnchor" role="tab"><i class="fas fa-anchor"></i> Anchor</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabVerify" role="tab"><i class="fas fa-check-circle"></i> Verify</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabLog" role="tab"><i class="fas fa-list"></i> Transaction Log</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabAbout" role="tab"><i class="fas fa-info-circle"></i> How It Works</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tabILS" role="tab"><i class="fas fa-brain"></i> ILS Intelligence</a></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tabAnchor" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-anchor"></i> Anchor a Defense Record</h3>
                            <label>1. Select Military Branch</label>
                            <div class="branch-tabs" id="branchTabs">
                                <button class="branch-tab active" onclick="selectBranch('USN',this)">&#9875; Navy</button>
                                <button class="branch-tab" onclick="selectBranch('USA',this)">&#11088; Army</button>
                                <button class="branch-tab" onclick="selectBranch('USAF',this)">&#9992;&#65039; Air Force</button>
                                <button class="branch-tab" onclick="selectBranch('USMC',this)">&#129413; Marines</button>
                                <button class="branch-tab" onclick="selectBranch('USCG',this)">&#128735;&#65039; Coast Guard</button>
                                <button class="branch-tab" onclick="selectBranch('DLA',this)">&#127963;&#65039; DLA</button>
                                <button class="branch-tab" onclick="selectBranch('JOINT',this)">&#127894;&#65039; Joint</button>
                                <button class="branch-tab" onclick="selectBranch('SOCOM',this)">&#128481;&#65039; SOCOM</button>
                                <button class="branch-tab" onclick="selectBranch('USSF',this)">&#128640; Space Force</button>
                            </div>
                            <label>2. Choose Record Type <span class="branch-count" id="branchTypeCount"></span></label>
                            <input class="type-search" type="text" id="typeSearch" placeholder="Search record types..." oninput="renderTypeGrid()">
                            <div class="record-type-grid" id="recordTypeGrid"></div>

                            <div class="clf-banner" id="clfBanner"><span class="clf-icon"></span><span class="clf-badge" id="clfBadge"></span><span class="clf-text" id="clfText"></span></div>

                            <label>3. Enter Record Content</label>
                            <textarea id="recordInput" placeholder="Paste or type your defense logistics record here..." oninput="this.dataset.autoFilled='false'"></textarea>
                            <div class="mt-2 mb-3">
                                <span style="color:var(--muted);font-size:0.8rem">Try a sample:</span>
                                <span class="sample-btn" onclick="loadSample('supply')">Supply Receipt</span>
                                <span class="sample-btn" onclick="loadSample('maintenance')">3-M Maint</span>
                                <span class="sample-btn" onclick="loadSample('ordnance')">Ordnance Lot</span>
                                <span class="sample-btn" onclick="loadSample('casrep')">CASREP</span>
                                <span class="sample-btn" onclick="loadSample('custody')">Custody Transfer</span>
                                <span class="sample-btn" onclick="loadSample('hand_receipt')">Army Hand Receipt</span>
                                <span class="sample-btn" onclick="loadSample('flight_record')">AF Flight Record</span>
                                <span class="sample-btn" onclick="loadSample('ground_maint')">Marine Ground Maint</span>
                                <span class="sample-btn" onclick="loadSample('cutter')">CG Cutter Maint</span>
                                <span class="sample-btn" onclick="loadSample('satellite')">Space Force Sat</span>
                                <span class="sample-btn" onclick="loadSample('drl')">Navy DRL</span>
                                <span class="sample-btn" onclick="loadSample('buylist')">Navy Buylist</span>
                                <span class="sample-btn" onclick="loadSample('transfer_book')">Transfer Book</span>
                            </div>
                            <div class="d-flex gap-2 align-items-center">
                                <label class="form-check-label" style="font-size:0.85rem">
                                    <input type="checkbox" id="encryptCheck" checked style="width:auto!important;margin-right:6px"> Encrypt before hashing (CUI protection)
                                </label>
                            </div>
                            <button class="btn-accent mt-3" onclick="anchorRecord()" id="anchorBtn"><i class="fas fa-anchor"></i> Anchor to XRPL</button>
                            <div class="result-panel" id="anchorResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-diagram-project"></i> Anchor Flow</h3>
                            <div style="font-size:0.9rem;line-height:2">
                                <div><span style="color:var(--accent);font-weight:700">1.</span> Select branch & record type</div>
                                <div><span style="color:var(--accent);font-weight:700">2.</span> Enter or paste record content</div>
                                <div><span style="color:var(--accent);font-weight:700">3.</span> Optional: encrypt for CUI protection</div>
                                <div><span style="color:var(--accent);font-weight:700">4.</span> SHA-256 hash computed client-side</div>
                                <div><span style="color:var(--accent);font-weight:700">5.</span> Hash anchored to XRPL memo field</div>
                                <div><span style="color:var(--accent);font-weight:700">6.</span> $SLS micro-fee (0.01) paid to treasury</div>
                                <div><span style="color:var(--accent);font-weight:700">7.</span> Record appears in Live Metrics dashboard</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-shield-halved"></i> What Gets Stored On-Chain</h3>
                            <p style="font-size:0.85rem;color:var(--steel)"><strong>Only the SHA-256 hash</strong> of your record is stored on the XRP Ledger. No classified data, CUI, ITAR-controlled, or sensitive content ever touches the blockchain.</p>
                            <div style="font-size:0.8rem;margin-top:0.5rem">
                                <span style="color:var(--green)">&#10003;</span> NIST SP 800-171 compatible<br>
                                <span style="color:var(--green)">&#10003;</span> CMMC Level 2 aligned<br>
                                <span style="color:var(--green)">&#10003;</span> DFARS 252.204-7012 compliant<br>
                                <span style="color:var(--green)">&#10003;</span> No PII/CUI on-chain
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabVerify" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-check-circle"></i> Verify a Defense Record</h3>
                            <p style="color:var(--steel);font-size:0.9rem;margin-bottom:1rem">Paste the original record content to verify its hash matches what was anchored on XRPL.</p>
                            <label>Record Content</label>
                            <textarea id="verifyInput" placeholder="Paste the original defense record content here..."></textarea>
                            <label class="mt-2">Expected Hash (optional)</label>
                            <input type="text" id="verifyHash" placeholder="SHA-256 hash to compare against">
                            <button class="btn-gold mt-3" onclick="verifyRecord()"><i class="fas fa-check-circle"></i> Verify Integrity</button>
                            <div class="result-panel" id="verifyResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-question-circle"></i> Verification Use Cases</h3>
                            <div style="font-size:0.85rem;line-height:1.8;color:var(--steel)">
                                <div><strong>Supply Chain:</strong> Confirm parts receipt hasn't been altered</div>
                                <div><strong>CDRL:</strong> Verify contractor delivered exact document version</div>
                                <div><strong>Maintenance:</strong> Prove 3-M actions logged as-performed</div>
                                <div><strong>Ordnance:</strong> Validate lot tracking since manufacture</div>
                                <div><strong>Config:</strong> Confirm system baseline hasn't drifted</div>
                                <div><strong>Audit:</strong> Demonstrate tamper-proof trail to inspectors</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabLog" role="tabpanel">
                <div class="demo-card">
                    <h3><i class="fas fa-list"></i> Transaction Log</h3>
                    <p style="color:var(--steel);font-size:0.9rem">All records anchored in this session.</p>
                    <div class="tx-log" id="txLog">
                        <div style="color:var(--muted);text-align:center;padding:2rem">No records anchored yet. Go to the <strong>Anchor</strong> tab to start.</div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabAbout" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="demo-card">
                            <h3><i class="fas fa-cogs"></i> How S4 Ledger Works</h3>
                            <div style="font-size:0.9rem;line-height:1.9;color:var(--steel)">
                                <p>S4 Ledger creates <strong>tamper-proof records</strong> for defense logistics by anchoring SHA-256 hashes to the XRP Ledger.</p>
                                <p><strong>The process:</strong></p>
                                <ol><li>A defense record is created in your existing system</li><li>S4 Ledger computes a SHA-256 hash</li><li>Only the hash is written to an XRPL transaction memo</li><li>A micro-fee of 0.01 $SLS is paid per anchor</li><li>Anyone with the original can verify it hasn't been altered</li></ol>
                                <p><strong>No sensitive data on-chain.</strong> The blockchain only sees a 64-character hash.</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="demo-card">
                            <h3><i class="fas fa-shield-halved"></i> Supported Military Branches</h3>
                            <table style="width:100%;font-size:0.82rem">
                                <tr style="color:var(--muted);border-bottom:1px solid var(--border)"><th style="padding:0.4rem 0">Branch</th><th>Types</th><th>Key Systems</th></tr>
                                <tr><td style="padding:0.3rem 0">&#9875; U.S. Navy</td><td>54</td><td style="color:var(--muted)">NAVSUP, NAVSEA, CDMD-OA</td></tr>
                                <tr><td>&#11088; U.S. Army</td><td>20</td><td style="color:var(--muted)">GCSS-Army, PBUSE, SAAS</td></tr>
                                <tr><td>&#9992;&#65039; U.S. Air Force</td><td>18</td><td style="color:var(--muted)">IMDS, CEMS, CAS</td></tr>
                                <tr><td>&#129413; Marines</td><td>14</td><td style="color:var(--muted)">GCSS-MC, NALCOMIS, ATLASS</td></tr>
                                <tr><td>&#128735;&#65039; Coast Guard</td><td>12</td><td style="color:var(--muted)">ABS NS5, CG-LIMS, MISLE</td></tr>
                                <tr><td>&#127963;&#65039; DLA</td><td>12</td><td style="color:var(--muted)">DSS, DRMS, HMIRS</td></tr>
                                <tr><td>&#127894;&#65039; Joint</td><td>10</td><td style="color:var(--muted)">ALIS/ODIN, DRRS, MDA</td></tr>
                                <tr><td>&#128481;&#65039; SOCOM</td><td>8</td><td style="color:var(--muted)">SOF-LAN</td></tr>
                                <tr><td>&#128640; Space Force</td><td>11</td><td style="color:var(--muted)">18 SDS, SMC, SBIRS</td></tr>
                            </table>
                            <div style="margin-top:0.8rem;padding-top:0.8rem;border-top:1px solid var(--border);font-size:0.85rem;color:var(--steel)"><strong>Total: 159 record types</strong> across 9 military branches and agencies</div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-coins"></i> $SLS Token</h3>
                            <div style="font-size:0.85rem;color:var(--steel)">
                                <div><strong>Token:</strong> $SLS on XRP Ledger</div>
                                <div><strong>Total Supply:</strong> 100,000,000</div>
                                <div><strong>Anchor Fee:</strong> 0.01 $SLS per record</div>
                                <div><strong>Issuer:</strong> r95GyZac...HsTA5</div>
                                <div><strong>Treasury:</strong> rMLmkrxp...1KLqJ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tabILS" role="tabpanel">
                <div class="row">
                    <div class="col-lg-7">
                        <div class="demo-card">
                            <h3><i class="fas fa-brain"></i> ILS Intelligence Analyzer</h3>
                            <p style="color:var(--steel);font-size:0.9rem;margin-bottom:1rem">Upload your DRLs, spreadsheets, checklists, and documents. The analyzer will parse them, cross-reference against program requirements, and identify gaps, missing deliverables, and actionable items.</p>

                            <label>1. Select Program / Vessel Type</label>
                            <div class="row mb-3">
                                <div class="col-7">
                                    <select id="ilsProgram" onchange="onILSProgramChange()">
                                        <optgroup label="PMS 300 — Service Craft & Special Vessels">
                                            <option value="yrbm">YRBM — Yard Repair, Berthing & Messing</option>
                                            <option value="apl">APL — Auxiliary Personnel Lighter</option>
                                            <option value="afdm">AFDM — Aux Floating Drydock Medium</option>
                                            <option value="ydt">YDT — Large Harbor Tug</option>
                                            <option value="yon">YON — Fuel Oil Barge</option>
                                        </optgroup>
                                        <optgroup label="Major Programs">
                                            <option value="ddg51">DDG-51 Flight III (Arleigh Burke)</option>
                                            <option value="lcs">LCS Freedom-class</option>
                                            <option value="cvn78">CVN-78 Ford-class</option>
                                            <option value="ffg62">FFG-62 Constellation-class</option>
                                            <option value="lpd17">LPD-17 San Antonio-class</option>
                                        </optgroup>
                                        <optgroup label="Other Branches">
                                            <option value="f35">F-35C Lightning II (Navy/USMC)</option>
                                            <option value="ch53k">CH-53K King Stallion (USMC)</option>
                                            <option value="custom">Custom Program (define your own)</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="col-5">
                                    <input type="text" id="ilsHull" placeholder="Hull # / Designation" style="font-size:0.88rem">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label style="font-size:0.82rem">Program Office</label>
                                    <input type="text" id="ilsOffice" placeholder="e.g. PMS 300" style="font-size:0.88rem">
                                </div>
                                <div class="col-6">
                                    <label style="font-size:0.82rem">Acquisition Phase</label>
                                    <select id="ilsPhase" style="font-size:0.88rem">
                                        <option value="pre_award">Pre-Award</option>
                                        <option value="design" selected>Design</option>
                                        <option value="construction">Construction</option>
                                        <option value="test_eval">Test & Evaluation</option>
                                        <option value="delivery">Delivery / Turnover</option>
                                        <option value="post_delivery">Post-Delivery</option>
                                    </select>
                                </div>
                            </div>

                            <label>2. Upload Documents <span style="color:var(--muted);font-weight:400">(DRLs, spreadsheets, checklists, text files)</span></label>
                            <div class="ils-dropzone" id="ilsDropzone" onclick="document.getElementById('ilsFileInput').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <div style="font-weight:600;color:#fff;margin-bottom:4px">Drag & drop files here or click to browse</div>
                                <div style="font-size:0.82rem;color:var(--muted)">Accepts .csv, .xlsx, .xls, .txt — all processing done locally in your browser</div>
                            </div>
                            <input type="file" id="ilsFileInput" multiple accept=".csv,.xlsx,.xls,.txt,.tsv" style="display:none" onchange="handleILSFiles(this.files)">
                            <div class="ils-file-list" id="ilsFileList"></div>

                            <label>3. ILS Elements Checklist <span style="color:var(--muted);font-weight:400">(auto-populated from uploads, or check manually)</span></label>
                            <div id="ilsChecklist" style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:1rem;font-size:0.85rem;"></div>

                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn-accent" onclick="runFullILSAnalysis()"><i class="fas fa-chart-line"></i> Run Full Analysis</button>
                                <button class="btn-gold" onclick="generateILSReport()"><i class="fas fa-file-export"></i> Generate Report</button>
                                <button style="background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:8px;padding:0.5rem 1rem;cursor:pointer;font-family:inherit;font-size:0.85rem;font-weight:600" onclick="anchorILSReport()"><i class="fas fa-anchor"></i> Anchor Report Hash</button>
                            </div>
                            <div class="result-panel" id="ilsResult"></div>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="demo-card">
                            <h3><i class="fas fa-chart-pie"></i> ILS Readiness Score</h3>
                            <div id="ilsScoreContainer" style="text-align:center;padding:1rem 0">
                                <div style="font-size:4rem;font-weight:800;color:var(--muted)" id="ilsScore">--</div>
                                <div style="font-size:0.9rem;color:var(--steel)" id="ilsScoreLabel">Upload documents & run analysis</div>
                                <div style="margin-top:1rem" id="ilsGaugeBar">
                                    <div style="background:var(--surface);border-radius:8px;height:12px;overflow:hidden;border:1px solid var(--border)">
                                        <div id="ilsGaugeFill" style="height:100%;width:0%;background:linear-gradient(90deg,#ff3333,#ffa500,#14f195);border-radius:8px;transition:width 0.8s ease"></div>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-top:4px"><span>Critical Gaps</span><span>Partial</span><span>Mission Ready</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-list-check"></i> ILS Element Coverage</h3>
                            <div id="ilsCoverage" style="font-size:0.85rem">
                                <div style="color:var(--muted);text-align:center;padding:1rem">Upload files to see element-by-element coverage.</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-exclamation-triangle" style="color:#ffa500"></i> Action Items</h3>
                            <div id="ilsActions" style="max-height:400px;overflow-y:auto">
                                <div style="color:var(--muted);text-align:center;padding:1rem;font-size:0.85rem">Run analysis to generate action items with responsible parties, due dates, and cost impact.</div>
                            </div>
                        </div>
                        <div class="demo-card">
                            <h3><i class="fas fa-dollar-sign" style="color:#c9a84c"></i> Cost & Schedule Impact</h3>
                            <div id="ilsCostSchedule" style="font-size:0.85rem">
                                <div style="color:var(--muted);text-align:center;padding:1rem">Analysis required to estimate impact.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div id="anchorOverlay" class="anchor-overlay">
    <div class="anchor-anim-box">
        <div class="chain-segment"></div>
        <div class="anchor-drop-icon"><i class="fas fa-anchor"></i></div>
        <div class="anim-status" id="animStatus">Anchoring to XRPL...</div>
        <div class="anim-hash" id="animHash"></div>
        <div id="animClf" style="margin-top:0.6rem"></div>
        <div class="anim-fee" id="animFee">0.01 $SLS &rarr; Treasury</div>
        <div class="anim-success" id="animSuccess"></div>
    </div>
</div>

<footer>
    <div class="container">
        <div style="margin-bottom:12px;"><img src="../s4-assets/S4Ledger_logo.png" alt="S4 Ledger" class="footer-logo"><span style="font-weight:700;font-size:1.1rem;">S4 Ledger</span><span style="color:var(--muted);margin-left:5px;">&mdash; Secure Logistics Standard</span></div>
        <p style="font-size:0.82rem;margin-bottom:10px;">Immutable logistics verification for the defense industry. Built on the XRP Ledger.</p>
        <div style="margin-bottom:10px;"><a href="https://github.com/s4ledger/s4-ledger" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-github fa-lg"></i></a><a href="https://x.com/S4_Ledger" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-x-twitter fa-lg"></i></a><a href="https://linkedin.com" target="_blank" style="color:var(--muted);margin:0 10px;text-decoration:none;"><i class="fab fa-linkedin fa-lg"></i></a></div>
        <div style="margin-bottom:10px;font-size:0.78rem;"><a href="../s4-terms/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Terms of Service</a><a href="../s4-privacy/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Privacy Policy</a><a href="../security/" style="color:var(--muted);margin:0 10px;text-decoration:none;">Security</a></div>
        <p style="font-size:0.75rem;color:var(--muted);">$SLS is a utility token &mdash; not equity or an investment contract. &copy; 2026 S4 Ledger. Demo uses XRPL Testnet.</p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ======================================================================
//  S4 LEDGER DEMO ENGINE — 130+ DEFENSE RECORD TYPES
// ======================================================================

// ── Classification level mapping ──
// U = Unclassified, CUI = Controlled Unclassified, SECRET = Secret, TS = Top Secret
const CLASSIFICATION = {
    // ── USN ──
    USN_SUPPLY_RECEIPT:'CUI', USN_3M_MAINTENANCE:'CUI', USN_CASREP:'SECRET', USN_CDRL:'CUI',
    USN_ORDNANCE:'SECRET', USN_DEPOT_REPAIR:'CUI', USN_INSURV:'CUI', USN_CALIBRATION:'U',
    USN_CONFIG:'CUI', USN_CUSTODY:'CUI', USN_TDP:'CUI', USN_COC:'U', USN_SHIPALT:'CUI',
    USN_PMS:'U', USN_HME:'CUI', USN_COMBAT_SYS:'SECRET', USN_PROPULSION:'CUI',
    USN_AVIATION:'CUI', USN_FLIGHT_OPS:'CUI', USN_SUBSAFE:'SECRET', USN_DIVE_EQUIP:'U',
    USN_MEDICAL:'CUI', USN_QDR:'U', USN_FIELDING:'CUI', USN_REACTOR:'SECRET',
    USN_DRL:'CUI', USN_DI:'CUI', USN_VRS:'CUI', USN_BUYLIST:'CUI',
    USN_J1_ILS:'CUI', USN_J2_SE:'CUI', USN_J3_SUPPLY:'CUI', USN_J4_TECHDATA:'CUI',
    USN_J5_TRAINING:'U', USN_J6_MANPOWER:'CUI', USN_J7_FACILITIES:'U', USN_J8_PHST:'CUI',
    USN_J9_SOFTWARE:'CUI', USN_J10_DESIGN:'CUI', USN_J11_RAM:'CUI', USN_J12_ACQLOG:'CUI',
    USN_J13_CM:'CUI', USN_J14_DISPOSAL:'U', USN_BAM:'CUI', USN_TRANSFER_BOOK:'CUI',
    USN_COTS_MANUAL:'U', USN_TM_INDEX:'U', USN_PO_INDEX:'CUI', USN_PID:'CUI',
    USN_CONTRACT_MOD:'CUI', USN_CONFIG_MGMT:'CUI', USN_OUTFITTING:'CUI', USN_PURCHASE_REQ:'CUI',
    // ── USA ──
    USA_HAND_RECEIPT:'CUI', USA_TM_UPDATE:'CUI', USA_ARMS_ROOM:'CUI', USA_FLIPL:'CUI',
    USA_VEHICLE:'U', USA_CLASS_III:'U', USA_CLASS_V:'SECRET', USA_EQUIP_MAINT:'U',
    USA_AMMO_STORAGE:'SECRET', USA_RANGE_QUAL:'U', USA_CALIBRATION:'U', USA_PROPERTY_BOOK:'CUI',
    USA_COMPONENT_HR:'CUI', USA_DENSITY_LIST:'CUI', USA_GCSS_TRANS:'CUI', USA_AVIATION:'CUI',
    USA_MEDICAL:'CUI', USA_CBRN:'SECRET', USA_ENGINEER:'U', USA_SIGNAL:'CUI',
    // ── USAF ──
    USAF_781_FLIGHT:'CUI', USAF_MUNITIONS:'SECRET', USAF_ENGINE:'CUI', USAF_WEAPONS_LOAD:'SECRET',
    USAF_STRUCT_INTEG:'CUI', USAF_AVIONICS:'CUI', USAF_NUCLEAR:'TS', USAF_MISSILE:'SECRET',
    USAF_SPACE:'SECRET', USAF_RADAR:'CUI', USAF_RUNWAY:'U', USAF_BDR:'SECRET',
    USAF_SUPPLY:'U', USAF_AGE:'U', USAF_FUEL:'U', USAF_DEPOT:'CUI',
    USAF_PMEL:'U', USAF_REFUEL:'CUI',
    // ── USMC ──
    USMC_GROUND_MAINT:'U', USMC_AVIATION:'CUI', USMC_WEAPONS:'CUI', USMC_COMMS:'CUI',
    USMC_ENGINEER:'U', USMC_MOTOR_T:'U', USMC_SUPPLY:'CUI', USMC_ORDNANCE:'SECRET',
    USMC_COMBAT_ENG:'CUI', USMC_AAV:'CUI', USMC_MEDICAL:'CUI', USMC_NBC:'SECRET',
    USMC_EXPEDITIONARY:'CUI', USMC_LAV:'CUI',
    // ── USCG ──
    USCG_CUTTER_MAINT:'U', USCG_SMALL_BOAT:'U', USCG_NAV_AID:'U', USCG_POLLUTION:'U',
    USCG_SAR:'CUI', USCG_MARITIME_SEC:'CUI', USCG_AVIATION:'CUI', USCG_PORT_SEC:'CUI',
    USCG_ELECTRONICS:'CUI', USCG_WEAPONS:'CUI', USCG_ICE_OPS:'U', USCG_BUOY_TENDER:'U',
    // ── DLA ──
    DLA_DISTRIBUTION:'CUI', DLA_FMS:'SECRET', DLA_DRMO:'U', DLA_HAZMAT:'CUI',
    DLA_BULK_FUEL:'CUI', DLA_TROOP_SUPPORT:'U', DLA_STRATEGIC:'SECRET', DLA_MEDICAL:'CUI',
    DLA_DPAS:'CUI', DLA_COMMISSARY:'U', DLA_DISPOSITION:'U', DLA_LAND_EQUIP:'U',
    // ── JOINT ──
    JOINT_NATO:'CUI', JOINT_F35:'SECRET', JOINT_MISSILE_DEF:'TS', JOINT_CYBER:'SECRET',
    JOINT_INTEL:'TS', JOINT_SPACE:'SECRET', JOINT_TRANSPORT:'CUI', JOINT_CONTRACT:'CUI',
    JOINT_READINESS:'SECRET', JOINT_DISPOSAL:'U',
    // ── SOCOM ──
    SOCOM_WEAPONS:'SECRET', SOCOM_COMMS:'SECRET', SOCOM_AVIATION:'SECRET', SOCOM_MARITIME:'SECRET',
    SOCOM_VEHICLE:'CUI', SOCOM_INTEL:'TS', SOCOM_MEDICAL:'CUI', SOCOM_DEMO:'SECRET',
    // ── USSF ──
    USSF_SAT_OPS:'SECRET', USSF_SPACE_VEH:'SECRET', USSF_SDA:'TS', USSF_GPS_CONST:'SECRET',
    USSF_LAUNCH_VEH:'SECRET', USSF_RADAR_TRACK:'SECRET', USSF_GROUND_SYS:'SECRET',
    USSF_COMM_SAT:'SECRET', USSF_EARLY_WARN:'TS', USSF_SPACE_CTRL:'SECRET'
};

const CLF_META = {
    U:    {label:'UNCLASSIFIED',  icon:'🟢', color:'#00cc66', desc:'No special handling required'},
    CUI:  {label:'CUI',           icon:'🟡', color:'#c9a84c', desc:'Controlled Unclassified Information — NIST 800-171 handling required'},
    SECRET:{label:'SECRET',       icon:'🔴', color:'#ff5555', desc:'Requires SIPRNet or equivalent classified network'},
    TS:   {label:'TOP SECRET',    icon:'🟠', color:'#ffa500', desc:'Requires JWICS or equivalent TS/SCI network'}
};

function getClassification(typeKey) { return CLASSIFICATION[typeKey] || 'CUI'; }

const BRANCHES = {
    USN:{name:"U.S. Navy",icon:"\u2693",short:"Navy"},
    USA:{name:"U.S. Army",icon:"\u2B50",short:"Army"},
    USAF:{name:"U.S. Air Force",icon:"\u2708\uFE0F",short:"Air Force"},
    USMC:{name:"U.S. Marine Corps",icon:"\uD83E\uDD85",short:"Marines"},
    USCG:{name:"U.S. Coast Guard",icon:"\uD83D\uDEDF\uFE0F",short:"Coast Guard"},
    DLA:{name:"Defense Logistics Agency",icon:"\uD83C\uDFDB\uFE0F",short:"DLA"},
    JOINT:{name:"Joint / Cross-Branch",icon:"\uD83C\uDF96\uFE0F",short:"Joint"},
    SOCOM:{name:"Special Operations",icon:"\uD83D\uDDE1\uFE0F",short:"SOCOM"},
    USSF:{name:"U.S. Space Force",icon:"\uD83D\uDE80",short:"Space Force"}
};

// Compact: [label, icon, color, branch, system]
const _RT = {
USN_SUPPLY_RECEIPT:["Supply Chain Receipt","\uD83D\uDCE6","#00aaff","USN","NAVSUP OneTouch"],
USN_3M_MAINTENANCE:["3-M Maintenance Action","\uD83D\uDD27","#ffd700","USN","SKED/OARS"],
USN_CASREP:["Casualty Report (CASREP)","\u26A0\uFE0F","#ff3333","USN","TYCOM"],
USN_CDRL:["CDRL Delivery","\uD83D\uDCC4","#8ea4b8","USN","CDMD-OA"],
USN_ORDNANCE:["Ordnance Lot Tracking","\uD83D\uDCA3","#ff6b6b","USN","AESIP"],
USN_DEPOT_REPAIR:["Depot Repair Record","\uD83C\uDFED","#ff9933","USN","CNRMF"],
USN_INSURV:["INSURV Inspection","\uD83D\uDD0D","#66ccff","USN","NRCC"],
USN_CALIBRATION:["TMDE Calibration","\uD83D\uDCCF","#ff66aa","USN","METCAL"],
USN_CONFIG:["Configuration Baseline","\u2699\uFE0F","#c9a84c","USN","CDMD-OA"],
USN_CUSTODY:["Custody Transfer","\uD83D\uDD04","#14f195","USN","DPAS"],
USN_TDP:["Technical Data Package","\uD83D\uDCD0","#9945ff","USN","NAVSEA"],
USN_COC:["Certificate of Conformance","\u2705","#00cc88","USN","DCMA"],
USN_SHIPALT:["Ship Alteration (SHIPALT)","\uD83D\uDEA2","#0077cc","USN","NAVSEA"],
USN_PMS:["PMS/SKED Compliance","\uD83D\uDCCB","#44aa88","USN","3M/SKED"],
USN_HME:["HM&E System Record","\u26A1","#dd8844","USN","ENGSKED"],
USN_COMBAT_SYS:["Combat Systems Cert","\uD83C\uDFAF","#ff4444","USN","CSSQT"],
USN_PROPULSION:["Propulsion Plant Exam","\uD83D\uDD25","#ff6600","USN","INSURV"],
USN_AVIATION:["Aviation Maintenance","\u2708\uFE0F","#0088cc","USN","NALCOMIS"],
USN_FLIGHT_OPS:["Flight Operations Record","\uD83D\uDEEB","#3399ff","USN","NATOPS"],
USN_SUBSAFE:["SUBSAFE Certification","\uD83D\uDD12","#003366","USN","NAVSEA 07"],
USN_DIVE_EQUIP:["Diving Equipment Inspection","\uD83E\uDD3F","#006699","USN","NAVSEA 00C"],
USN_MEDICAL:["Medical Equipment Cert","\uD83C\uDFE5","#33cc66","USN","BUMED"],
USN_QDR:["Quality Defect Report","\uD83D\uDEAB","#cc0000","USN","NAVSUP WSS"],
USN_FIELDING:["Equipment Fielding","\uD83D\uDEA2","#00ddaa","USN","PMS"],
USN_REACTOR:["Naval Reactor Test","\u2622\uFE0F","#ffcc00","USN","NAVSEA 08"],
USN_DRL:["Data Requirements List (DRL)","\uD83D\uDCCB","#5599cc","USN","NAVSEA/PMS"],
USN_DI:["Data Item Description (DID)","\uD83D\uDCC3","#4488bb","USN","CDMD-OA"],
USN_VRS:["Vendor Recommended Spares","\uD83D\uDCE6","#7799aa","USN","NAVICP/DLA"],
USN_BUYLIST:["Buylist / Provisioning","\uD83D\uDED2","#6688aa","USN","NAVSUP WSS"],
USN_J1_ILS:["J-1 ILS Parameters / LORA","\uD83D\uDCD1","#336699","USN","PMS/ILS"],
USN_J2_SE:["J-2 Support Equipment","\uD83D\uDD27","#337799","USN","PMS/ILS"],
USN_J3_SUPPLY:["J-3 Supply Support","\uD83D\uDCE6","#338899","USN","NAVSUP"],
USN_J4_TECHDATA:["J-4 Technical Data","\uD83D\uDCD6","#339999","USN","NAVSEA"],
USN_J5_TRAINING:["J-5 Training","\uD83C\uDF93","#33aa99","USN","NETC"],
USN_J6_MANPOWER:["J-6 Manpower & Personnel","\uD83D\uDC65","#4488cc","USN","OPNAV N1"],
USN_J7_FACILITIES:["J-7 Facilities","\uD83C\uDFD7\uFE0F","#5577bb","USN","NAVFAC"],
USN_J8_PHST:["J-8 PHS&T","\uD83D\uDCE6","#6699cc","USN","NAVSUP"],
USN_J9_SOFTWARE:["J-9 Computer Resources","\uD83D\uDCBB","#4477aa","USN","SPAWAR/NAVWAR"],
USN_J10_DESIGN:["J-10 Design Interface","\uD83D\uDCD0","#3366aa","USN","NAVSEA"],
USN_J11_RAM:["J-11 RAM Analysis","\uD83D\uDCC8","#2255aa","USN","PMS/ILS"],
USN_J12_ACQLOG:["J-12 Acquisition Logistics","\uD83D\uDCCA","#2266bb","USN","PMS/ILS"],
USN_J13_CM:["J-13 Configuration Mgmt","\u2699\uFE0F","#3377cc","USN","CDMD-OA"],
USN_J14_DISPOSAL:["J-14 Disposal","\uD83D\uDDD1\uFE0F","#667788","USN","DRMS"],
USN_BAM:["Budget Allowance Mgmt (BAM)","\uD83D\uDCB0","#cc9933","USN","NAVSUP"],
USN_TRANSFER_BOOK:["Transfer Book","\uD83D\uDCD3","#5588aa","USN","Supply Officer"],
USN_COTS_MANUAL:["COTS Manual / Documentation","\uD83D\uDCD8","#4477bb","USN","NAVSEA"],
USN_TM_INDEX:["Technical Manual Index","\uD83D\uDCC7","#3366bb","USN","NAVSEA"],
USN_PO_INDEX:["Purchase Order Index","\uD83D\uDCC2","#5588cc","USN","NAVSUP"],
USN_PID:["Program Introduction Doc (PID)","\uD83D\uDCC4","#6699bb","USN","PMS"],
USN_CONTRACT_MOD:["Contract Modification","\uD83D\uDCDD","#7788aa","USN","NAVSEA Contracts"],
USN_CONFIG_MGMT:["Configuration Mgmt Record","\u2699\uFE0F","#4466aa","USN","CDMD-OA"],
USN_OUTFITTING:["Outfitting Requirements","\uD83D\uDEA2","#3355aa","USN","PMS/Outfitting"],
USN_PURCHASE_REQ:["Purchase Request (PR)","\uD83D\uDCB3","#558899","USN","NAVSUP"],
USA_HAND_RECEIPT:["DA 2062 Hand Receipt","\uD83D\uDCDD","#4b5320","USA","GCSS-Army"],
USA_TM_UPDATE:["Technical Manual Update","\uD83D\uDCD6","#6b8e23","USA","LOGSA"],
USA_ARMS_ROOM:["Arms Room Inventory","\uD83D\uDD2B","#8b4513","USA","PBUSE"],
USA_FLIPL:["FLIPL Investigation","\uD83D\uDCCB","#cd853f","USA","GCSS-Army"],
USA_VEHICLE:["Vehicle Dispatch Log","\uD83D\uDE9B","#556b2f","USA","GCSS-Army"],
USA_CLASS_III:["Class III (POL) Issue","\u26FD","#8b8000","USA","GCSS-Army"],
USA_CLASS_V:["Class V (Ammo) Issue","\uD83D\uDCA5","#b22222","USA","SAAS"],
USA_EQUIP_MAINT:["Equipment Maintenance","\uD83D\uDD27","#696969","USA","GCSS-Army"],
USA_AMMO_STORAGE:["Ammo Storage Inspection","\uD83C\uDFED","#a0522d","USA","QASAS"],
USA_RANGE_QUAL:["Range Qualification","\uD83C\uDFAF","#2e8b57","USA","DTMS"],
USA_CALIBRATION:["TMDE Calibration (Army)","\uD83D\uDCCF","#daa520","USA","TMDE Activity"],
USA_PROPERTY_BOOK:["Property Book Record","\uD83D\uDCD7","#3cb371","USA","PBUSE"],
USA_COMPONENT_HR:["Component Hand Receipt","\uD83D\uDDC2\uFE0F","#8fbc8f","USA","GCSS-Army"],
USA_DENSITY_LIST:["Equipment Density List","\uD83D\uDCCA","#66cdaa","USA","GCSS-Army"],
USA_GCSS_TRANS:["GCSS-Army Transaction","\uD83D\uDCBB","#20b2aa","USA","GCSS-Army"],
USA_AVIATION:["Aviation Maintenance","\uD83D\uDE81","#2f4f4f","USA","ULLS-A(E)"],
USA_MEDICAL:["Medical Supply Record","\uD83C\uDFE5","#3cb371","USA","DMLSS"],
USA_CBRN:["CBRN Equipment Record","\u2623\uFE0F","#8b0000","USA","GCSS-Army"],
USA_ENGINEER:["Engineer Equipment","\uD83C\uDFD7\uFE0F","#808000","USA","GCSS-Army"],
USA_SIGNAL:["Signal/Comms Equipment","\uD83D\uDCE1","#4682b4","USA","LMP"],
USAF_781_FLIGHT:["AFTO 781 Flight Record","\u2708\uFE0F","#00308f","USAF","IMDS"],
USAF_MUNITIONS:["Munitions Inspection","\uD83D\uDCA3","#cd5c5c","USAF","CAS"],
USAF_ENGINE:["Engine Management Record","\uD83D\uDD25","#ff8c00","USAF","CEMS"],
USAF_WEAPONS_LOAD:["Weapons Load Certification","\uD83C\uDFAF","#dc143c","USAF","MIS"],
USAF_STRUCT_INTEG:["Aircraft Structural Record","\uD83D\uDEE1\uFE0F","#4169e1","USAF","ASIP"],
USAF_AVIONICS:["Avionics Test Record","\uD83D\uDCDF","#6a5acd","USAF","IMDS"],
USAF_NUCLEAR:["Nuclear Weapons Cert","\u2622\uFE0F","#ffd700","USAF","AFGSC"],
USAF_MISSILE:["Missile Maintenance Record","\uD83D\uDE80","#b8860b","USAF","MMICS"],
USAF_SPACE:["Space Vehicle Certification","\uD83D\uDEF0\uFE0F","#191970","USAF","USSF"],
USAF_RADAR:["Radar Calibration Record","\uD83D\uDCE1","#00bfff","USAF","IMDS"],
USAF_RUNWAY:["Runway Condition Report","\uD83D\uDEEC","#708090","USAF","BCAS"],
USAF_BDR:["Battle Damage Assessment","\uD83D\uDCA5","#ff4500","USAF","BDA"],
USAF_SUPPLY:["AF Supply Transaction","\uD83D\uDCE6","#1e90ff","USAF","SBSS"],
USAF_AGE:["Aerospace Ground Equipment","\uD83D\uDD29","#778899","USAF","IMDS"],
USAF_FUEL:["Fuel Management Record","\u26FD","#daa520","USAF","AFPET"],
USAF_DEPOT:["Depot Maintenance Record","\uD83C\uDFED","#cd853f","USAF","D200A"],
USAF_PMEL:["PMEL Calibration","\uD83D\uDCCF","#da70d6","USAF","PMEL"],
USAF_REFUEL:["Aerial Refueling Log","\u26FD","#2e8b57","USAF","ART"],
USMC_GROUND_MAINT:["Ground Equipment Maint","\uD83D\uDD27","#cc0000","USMC","GCSS-MC"],
USMC_AVIATION:["Aviation Intermediate Maint","\uD83D\uDE81","#8b0000","USMC","NALCOMIS"],
USMC_WEAPONS:["Weapons Maintenance","\uD83D\uDD2B","#a52a2a","USMC","ATLASS"],
USMC_COMMS:["Communications Equipment","\uD83D\uDCE1","#cd5c5c","USMC","GCSS-MC"],
USMC_ENGINEER:["Engineer Equipment Record","\uD83C\uDFD7\uFE0F","#b22222","USMC","GCSS-MC"],
USMC_MOTOR_T:["Motor Transport Record","\uD83D\uDE9B","#dc143c","USMC","GCSS-MC"],
USMC_SUPPLY:["MAGTF Supply Chain","\uD83D\uDCE6","#800000","USMC","GCSS-MC"],
USMC_ORDNANCE:["Marine Ordnance Record","\uD83D\uDCA3","#ff0000","USMC","TFSMS"],
USMC_COMBAT_ENG:["Combat Engineering Record","\uD83D\uDCA5","#c41e3a","USMC","GCSS-MC"],
USMC_AAV:["AAV/ACV Maintenance","\uD83D\uDEA2","#990000","USMC","GCSS-MC"],
USMC_MEDICAL:["Medical Supply Record","\uD83C\uDFE5","#ff6666","USMC","DMLSS"],
USMC_NBC:["NBC Equipment Inspection","\u2623\uFE0F","#660000","USMC","GCSS-MC"],
USMC_EXPEDITIONARY:["Expeditionary Supply","\uD83C\uDFD5\uFE0F","#993333","USMC","GCSS-MC"],
USMC_LAV:["LAV Maintenance Record","\uD83D\uDE97","#cc3333","USMC","GCSS-MC"],
USCG_CUTTER_MAINT:["Cutter Maintenance","\uD83D\uDEA2","#003366","USCG","ABS NS5"],
USCG_SMALL_BOAT:["Small Boat Inspection","\u26F5","#336699","USCG","CG-LIMS"],
USCG_NAV_AID:["Aids to Navigation Maint","\uD83D\uDDFC","#0066cc","USCG","ATON MIS"],
USCG_POLLUTION:["Pollution Response Equip","\uD83D\uDEE2\uFE0F","#669900","USCG","MISLE"],
USCG_SAR:["Search & Rescue Equipment","\uD83C\uDD98","#ff3300","USCG","MISLE"],
USCG_MARITIME_SEC:["Maritime Security Equip","\uD83D\uDD12","#003399","USCG","MISLE"],
USCG_AVIATION:["CG Aviation Maintenance","\uD83D\uDE81","#3366ff","USCG","ALMIS"],
USCG_PORT_SEC:["Port Security Inspection","\uD83C\uDFD7\uFE0F","#0033cc","USCG","MISLE"],
USCG_ELECTRONICS:["Electronics Systems Maint","\uD83D\uDCE1","#0099ff","USCG","CG-LIMS"],
USCG_WEAPONS:["CG Weapons System Maint","\uD83D\uDD2B","#002244","USCG","CG-LIMS"],
USCG_ICE_OPS:["Ice Operations Equipment","\uD83E\uDDCA","#66ccff","USCG","CG-LIMS"],
USCG_BUOY_TENDER:["Buoy Tender Maintenance","\uD83D\uDD34","#ff6600","USCG","ATON MIS"],
DLA_DISTRIBUTION:["DLA Distribution Receipt","\uD83C\uDFDB\uFE0F","#1a3a5c","DLA","DSS"],
DLA_FMS:["Foreign Military Sales","\uD83C\uDF10","#2a5a8c","DLA","DSCA"],
DLA_DRMO:["DRMO Disposal Record","\uD83D\uDDD1\uFE0F","#555555","DLA","DRMS"],
DLA_HAZMAT:["Hazmat Certification","\u2622\uFE0F","#ff9900","DLA","HMIRS"],
DLA_BULK_FUEL:["Bulk Fuel Receipt","\u26FD","#8b7355","DLA","DFSP"],
DLA_TROOP_SUPPORT:["Troop Support Material","\uD83C\uDF96\uFE0F","#4a6741","DLA","BSM"],
DLA_STRATEGIC:["Strategic Material Reserve","\uD83C\uDFE6","#8b8682","DLA","NDS"],
DLA_MEDICAL:["Medical Supply Chain","\uD83C\uDFE5","#2e8b57","DLA","ECAT"],
DLA_DPAS:["DPAS Property Record","\uD83D\uDCCB","#4682b4","DLA","DPAS"],
DLA_COMMISSARY:["Commissary Supply Record","\uD83D\uDED2","#6b8e23","DLA","DeCA"],
DLA_DISPOSITION:["Disposition Services","\uD83D\uDCE4","#8b8378","DLA","DRMS"],
DLA_LAND_EQUIP:["Land Equipment Supply","\uD83D\uDE9B","#556b2f","DLA","DSS"],
JOINT_NATO:["NATO STANAG Verification","\uD83C\uDFF3\uFE0F","#003399","JOINT","NATO"],
JOINT_F35:["F-35 JSF Logistics","\u2708\uFE0F","#1a1a2e","JOINT","ALIS/ODIN"],
JOINT_MISSILE_DEF:["Missile Defense Record","\uD83D\uDE80","#4a0080","JOINT","MDA"],
JOINT_CYBER:["Cyber Equipment Cert","\uD83D\uDDA5\uFE0F","#00cc99","JOINT","CYBERCOM"],
JOINT_INTEL:["Intelligence Equipment","\uD83D\uDD75\uFE0F","#2d2d2d","JOINT","DIA"],
JOINT_SPACE:["Space Command Asset","\uD83D\uDEF0\uFE0F","#000066","JOINT","USSPACECOM"],
JOINT_TRANSPORT:["TRANSCOM Logistics","\uD83D\uDE9B","#4a6741","JOINT","USTRANSCOM"],
JOINT_CONTRACT:["Contract Deliverable","\uD83D\uDCDD","#b8860b","JOINT","DCMA"],
JOINT_READINESS:["Readiness Report","\uD83D\uDCC8","#00ff88","JOINT","DRRS"],
JOINT_DISPOSAL:["Joint Disposal Record","\uD83D\uDDD1\uFE0F","#8b8682","JOINT","DLA"],
SOCOM_WEAPONS:["SOF Weapons Maintenance","\uD83D\uDD2B","#2d2d2d","SOCOM","SOF-LAN"],
SOCOM_COMMS:["SOF Communications Equip","\uD83D\uDCE1","#4a4a4a","SOCOM","SOF-LAN"],
SOCOM_AVIATION:["SOF Aviation Maintenance","\uD83D\uDE81","#333333","SOCOM","SOF-LAN"],
SOCOM_MARITIME:["SOF Maritime Equipment","\uD83E\uDD3F","#1a1a2e","SOCOM","SOF-LAN"],
SOCOM_VEHICLE:["SOF Vehicle Maintenance","\uD83D\uDE97","#3d3d3d","SOCOM","SOF-LAN"],
SOCOM_INTEL:["SOF Intelligence Equip","\uD83D\uDD75\uFE0F","#1a1a1a","SOCOM","SOF-LAN"],
SOCOM_MEDICAL:["SOF Medical Supply","\uD83C\uDFE5","#4a4a4a","SOCOM","SOF-LAN"],
SOCOM_DEMO:["SOF Demolition Record","\uD83D\uDCA5","#550000","SOCOM","SOF-LAN"],
USSF_SAT_OPS:["Satellite Operations Record","\uD83D\uDEF0\uFE0F","#1a1a4e","USSF","18 SDS"],
USSF_SPACE_VEH:["Space Vehicle Maintenance","\uD83D\uDE80","#2a2a5e","USSF","SMC"],
USSF_SDA:["Space Domain Awareness","\uD83D\uDD2D","#000066","USSF","18 SDS"],
USSF_GPS_CONST:["GPS Constellation Record","\uD83D\uDCE1","#003399","USSF","2 SOPS"],
USSF_LAUNCH_VEH:["Launch Vehicle Record","\uD83D\uDE80","#0044aa","USSF","SLD 45"],
USSF_RADAR_TRACK:["Space Surveillance Tracking","\uD83D\uDCE1","#0055bb","USSF","18 SDS"],
USSF_GROUND_SYS:["Ground Systems Maint","\uD83D\uDDA5\uFE0F","#002266","USSF","SBIRS"],
USSF_COMM_SAT:["Comm Satellite Record","\uD83D\uDCE1","#0033aa","USSF","MILSATCOM"],
USSF_EARLY_WARN:["Early Warning System","\u26A0\uFE0F","#003377","USSF","SBIRS"],
USSF_SPACE_CTRL:["Space Control Record","\uD83D\uDEE1\uFE0F","#001a66","USSF","SPACECOM"]
};

// Expand
const RECORD_TYPES = {};
for (const [k,v] of Object.entries(_RT)) {
    RECORD_TYPES[k] = {label:v[0],icon:v[1],color:v[2],branch:v[3],system:v[4]};
}

const SAMPLES = {
    supply:{type:'USN_SUPPLY_RECEIPT',branch:'USN',text:`Supply Chain Receipt\nNSN: 5340-01-234-5678\nNomenclature: Valve, Gate, Carbon Steel\nContract: N00024-23-C-5501\nCAGE Code: 1THK9\nQuantity Received: 50 EA\nCondition Code: A (Serviceable)\nInspection: FAT Pass\nReceiving Depot: Norfolk Naval Shipyard (NNSY)\nInspector: QA-237 J. Martinez\nDate: 2026-02-10`},
    maintenance:{type:'USN_3M_MAINTENANCE',branch:'USN',text:`Maintenance 3-M Action\nMRC: 2815-1.3.7\nEquipment: LM2500 Gas Turbine Engine\nHull Number: DDG-118\nAction: Oil sample analysis\nResults: Normal wear metals Fe:12ppm Cu:3ppm Al:2ppm\nTechnician: MM2(SW) Garcia\nVerified By: MMCS(SW) Thompson\nNext Due: 2026-08-10\nSKED Status: Current`},
    ordnance:{type:'USN_ORDNANCE',branch:'USN',text:`Ordnance Lot Tracking\nDODIC: A059 (5.56mm Ball M855)\nLot Number: WCC-2025-1147-A\nNSN: 1305-01-299-5564\nManufacturer: Winchester (CAGE: 97173)\nQuantity: 250,000 rounds\nProof Test: PASS (MIL-C-63989D)\nStorage: Weapons Station Earle, Magazine 14\nCustodian: GMC(SW) Rodriguez\nDate: 2026-02-08`},
    casrep:{type:'USN_CASREP',branch:'USN',text:`CASUALTY REPORT (CASREP)\nUnit: USS Porter (DDG-78)\nEquipment: AN/SPY-1D(V) Radar Transmitter\nSerial: SPY-TM-2019-04472\nImpact: Degraded radar coverage\nReported By: LCDR Pham, CSO\nDate: 2026-02-10`},
    custody:{type:'USN_CUSTODY',branch:'USN',text:`Chain of Custody Transfer\nEquipment: AN/SPY-1D(V) Transmitter Module\nSerial: SPY-TM-2019-04472\nNSN: 5841-01-522-3401\nFrom: ET1(SW) Cooper, DDG-78\nTo: NAVSEA Det Norfolk, IMA\nSeal: Tamper-evident #TS-2026-0887\nDate: 2026-02-10`},
    hand_receipt:{type:'USA_HAND_RECEIPT',branch:'USA',text:`DA Form 2062 Hand Receipt\nUnit: 3rd BCT, 101st Airborne\nProperty Book Officer: CPT Rivera\nItem: AN/PVS-14 Night Vision Device\nNSN: 5855-01-432-0524\nSerial: NVD-2024-08871\nQuantity: 24 EA\nCondition: Serviceable\nSub-hand receipt to: 1LT Nakamura, B Co\nDate: 2026-02-09`},
    flight_record:{type:'USAF_781_FLIGHT',branch:'USAF',text:`AFTO Form 781 Flight Record\nAircraft: F-16C Block 50\nTail: 91-0412\nUnit: 480th Fighter Squadron, Spangdahlem AB\nMission: Air-to-ground training sortie\nSorties: 1\nFlight Hours: 1.8\nPilot: Capt Williams\nDiscrepancies: None\nDate: 2026-02-10`},
    ground_maint:{type:'USMC_GROUND_MAINT',branch:'USMC',text:`Ground Equipment Maintenance\nUnit: 1st Maintenance Battalion, Camp Pendleton\nEquipment: HMMWV M1151A1\nBumper: 1MaintBn-HQ-07\nWork Order: PM services, 6-month interval\nTechnician: Sgt Dominguez\nHours: 4.5\nParts Used: Oil filter (NSN 2940-01-318-2345)\nStatus: Operational\nDate: 2026-02-11`},
    cutter:{type:'USCG_CUTTER_MAINT',branch:'USCG',text:`Cutter Maintenance Record\nVessel: USCGC Hamilton (WMSL-753)\nSystem: Main Diesel Engine #2\nAction: 500-hour inspection and filter change\nTechnician: MK1 Petersen\nParts: Fuel filter (NSN 2910-01-456-7890)\nCondition: Satisfactory\nNext PM: 2026-05-10\nDate: 2026-02-11`},
    satellite:{type:'USSF_SAT_OPS',branch:'USSF',text:`Satellite Operations Record\nConstellation: GPS III\nVehicle: SVN-78 (GPS III-6)\nOrbit: MEO, Slot A3\nStatus: Operational / Healthy\nPayload: L1C/A, L2C, L5, M-Code\nGround Contact: Schriever SFB, CO\nAnomaly: None\nOperator: 2nd SOPS\nDate: 2026-02-12`},
    drl:{type:'USN_DRL',branch:'USN',text:`Data Requirements List (CDRL)\nContract: N00024-24-C-6200\nCDRL Seq: A001\nDI Number: DI-ILSS-81495\nTitle: Integrated Logistics Support Plan\nFrequency: One-time with revisions\nDistribution: NAVSEA PMS 400D\nContractor: Huntington Ingalls Industries\nProgram: DDG-51 Flight III\nStatus: Submitted, under review\nDate: 2026-02-10`},
    buylist:{type:'USN_BUYLIST',branch:'USN',text:`Buylist / Provisioning Record\nProgram: LCS Freedom-class\nPMS: PMS 501\nItem: Main Reduction Gear Oil Pump Assembly\nNSN: 4320-01-567-8901\nRecommended Qty: 4 EA per hull\nAcquisition Method: Sole Source (OEM)\nVendor: Rolls-Royce Naval Marine (CAGE: K2965)\nUnit Cost: $47,250.00\nJustification: Critical rotating machinery, no alternate source\nDate: 2026-02-09`},
    transfer_book:{type:'USN_TRANSFER_BOOK',branch:'USN',text:`Transfer Book Entry\nUnit: Supply Department, USS Nimitz (CVN-68)\nAccount: OPTAR / EMRM\nJob Order: 68-2026-0195\nDescription: Transfer of ADP equipment to AIMD\nFrom: S-1 Division (Stock Control)\nTo: AIMD IM-3 Division\nQuantity: 12 laptops, 3 printers\nDocument Number: N68836-6026-0195\nApproved By: LCDR Torres, Supply Officer\nDate: 2026-02-11`}
};

let currentBranch = 'USN';
let selectedType = 'USN_SUPPLY_RECEIPT';
let sessionRecords = [];
let stats = {anchored:0,verified:0,types:new Set(),slsFees:0};

// ── localStorage cross-page record sync ──
const S4_STORAGE_KEY = 's4_anchored_records';
const S4_STATS_KEY = 's4_demo_stats';
function getLocalRecords() { try { return JSON.parse(localStorage.getItem(S4_STORAGE_KEY) || '[]'); } catch(e) { return []; } }
function saveLocalRecord(rec) { const records = getLocalRecords(); records.push(rec); localStorage.setItem(S4_STORAGE_KEY, JSON.stringify(records)); }
function saveStats() { localStorage.setItem(S4_STATS_KEY, JSON.stringify({anchored:stats.anchored,verified:stats.verified,types:[...stats.types],slsFees:stats.slsFees})); }
function loadStats() {
    try {
        const saved = JSON.parse(localStorage.getItem(S4_STATS_KEY) || 'null');
        if (saved) { stats.anchored = saved.anchored || 0; stats.verified = saved.verified || 0; stats.types = new Set(saved.types || []); stats.slsFees = saved.slsFees || 0; }
    } catch(e) {}
    // Also restore session records from localStorage
    const localRecs = getLocalRecords();
    sessionRecords = localRecs.map(r => ({
        type: r.record_type, label: r.record_label || r.record_type, icon: r.icon || '\uD83D\uDCCB',
        branch: r.branch || 'JOINT', hash: r.hash, txHash: r.tx_hash,
        encrypted: false, timestamp: r.timestamp, content: ''
    }));
    updateStats();
    updateTxLog();
}

async function sha256(text) {
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function copyHash(hash) {
    navigator.clipboard.writeText(hash).then(function() {
        document.querySelectorAll('.copy-btn').forEach(function(b) { b.innerHTML = '<i class="fas fa-check"></i> Copied!'; });
        setTimeout(function() { document.querySelectorAll('.copy-btn').forEach(function(b) { b.innerHTML = '<i class="fas fa-copy"></i> Copy'; }); }, 2000);
    });
}

function selectBranch(branch, el) {
    currentBranch = branch;
    document.querySelectorAll('.branch-tab').forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');
    document.getElementById('typeSearch').value = '';
    renderTypeGrid();
}

function renderTypeGrid() {
    const grid = document.getElementById('recordTypeGrid');
    const search = (document.getElementById('typeSearch').value || '').toLowerCase();
    const types = Object.entries(RECORD_TYPES)
        .filter(([k,v]) => v.branch === currentBranch)
        .filter(([k,v]) => !search || v.label.toLowerCase().includes(search) || k.toLowerCase().includes(search));
    document.getElementById('branchTypeCount').textContent = '(' + types.length + ' types)';
    grid.innerHTML = types.map(([key,t]) =>
        '<div class="record-type-btn' + (key===selectedType?' selected':'') + '" data-type="'+key+'" onclick="selectType(\''+key+'\',this)" title="'+t.label+' \u2014 '+t.system+'"><span class="icon">'+t.icon+'</span>'+t.label+'</div>'
    ).join('');
}

function selectType(key, el) {
    selectedType = key;
    document.querySelectorAll('.record-type-btn').forEach(b => b.classList.remove('selected'));
    if (el) el.classList.add('selected');
    // Auto-populate textarea with sample content for this type
    const typeInfo = RECORD_TYPES[key];
    if (typeInfo) {
        const ta = document.getElementById('recordInput');
        if (!ta.value.trim() || ta.dataset.autoFilled === 'true') {
            ta.value = generateRecordSample(key, typeInfo);
            ta.dataset.autoFilled = 'true';
        }
    }
    // Show classification banner
    showClassificationBanner(key);
}

function generateRecordSample(key, info) {
    // Check if there's a matching SAMPLE entry
    for (const [sk, sv] of Object.entries(SAMPLES)) {
        if (sv.type === key) return sv.text;
    }
    // Generate a generic sample
    const ref = 'REF-2026-' + String(Math.floor(Math.random()*9000+1000));
    const clf = getClassification(key);
    const clfLabel = CLF_META[clf].label;
    return info.label + '\nBranch: ' + BRANCHES[info.branch].name
        + '\nSystem: ' + (info.system || 'N/A')
        + '\nClassification: ' + clfLabel
        + '\nReference: ' + ref
        + '\nDate: 2026-02-13'
        + '\nStatus: Complete / Inspected'
        + '\nAuthorized By: [Name/Rank]'
        + '\nFacility: [Location]'
        + '\nNotes: Enter detailed record content here';
}

function showClassificationBanner(typeKey) {
    const banner = document.getElementById('clfBanner');
    const clf = getClassification(typeKey);
    const meta = CLF_META[clf];
    banner.className = 'clf-banner show clf-' + clf;
    banner.querySelector('.clf-icon').textContent = meta.icon;
    document.getElementById('clfBadge').textContent = meta.label;
    document.getElementById('clfText').textContent = meta.desc;
}

function loadSample(key) {
    const s = SAMPLES[key];
    if (!s) return;
    const ta = document.getElementById('recordInput');
    ta.value = s.text;
    ta.dataset.autoFilled = 'true';
    if (s.branch !== currentBranch) {
        const tabs = document.querySelectorAll('.branch-tab');
        tabs.forEach(t => {
            if (t.textContent.toLowerCase().includes(BRANCHES[s.branch].short.toLowerCase())) {
                selectBranch(s.branch, t);
            }
        });
    }
    selectedType = s.type;
    renderTypeGrid();
    showClassificationBanner(s.type);
}

function animateValue(el, end, decimals) {
    const start = parseFloat(el.textContent) || 0;
    if (start === end) { el.textContent = decimals ? end.toFixed(decimals) : end; return; }
    const duration = 400;
    const startTime = performance.now();
    function step(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const current = start + (end - start) * eased;
        el.textContent = decimals ? current.toFixed(decimals) : Math.round(current);
        if (progress < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
}

function updateStats() {
    animateValue(document.getElementById('statAnchored'), stats.anchored);
    animateValue(document.getElementById('statVerified'), stats.verified);
    animateValue(document.getElementById('statTypes'), stats.types.size);
    animateValue(document.getElementById('statSlsFees'), stats.slsFees, 3);
}

function showAnchorAnimation(hash, typeLabel, clfLevel) {
    const overlay = document.getElementById('anchorOverlay');
    const meta = CLF_META[clfLevel] || CLF_META['CUI'];
    document.getElementById('animStatus').textContent = 'Anchoring to XRPL...';
    document.getElementById('animStatus').style.color = '';
    document.getElementById('animHash').textContent = hash;
    document.getElementById('animSuccess').textContent = '';
    // Show classification in animation
    const clfDiv = document.getElementById('animClf');
    if (clfDiv) {
        clfDiv.innerHTML = '<span style="padding:4px 14px;border-radius:6px;font-size:0.85rem;font-weight:800;letter-spacing:0.5px;color:' + meta.color + ';border:1px solid ' + meta.color + '30;background:' + meta.color + '15">' + meta.icon + ' ' + meta.label + '</span>';
        clfDiv.style.opacity = '0';
        clfDiv.style.animation = 'fadeUp 0.5s ease-out 0.7s both';
    }
    // Reset animations
    overlay.querySelectorAll('.chain-segment,.anchor-drop-icon,.anim-status,.anim-hash,.anim-fee,.anim-success').forEach(el => {
        el.style.animation = 'none'; el.offsetHeight; el.style.animation = '';
    });
    overlay.classList.add('active');
    setTimeout(() => {
        document.getElementById('animStatus').textContent = '\u2705 ' + typeLabel + ' Anchored!';
        document.getElementById('animStatus').style.color = '#14f195';
        document.getElementById('animSuccess').textContent = '\u2713 Record secured on XRPL';
        document.getElementById('animSuccess').style.animation = 'scaleIn 0.4s ease-out both';
    }, 2000);
}

function hideAnchorAnimation() {
    document.getElementById('anchorOverlay').classList.remove('active');
}

async function anchorRecord() {
    const input = document.getElementById('recordInput').value.trim();
    if (!input) { alert('Please enter record content.'); return; }
    const btn = document.getElementById('anchorBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Anchoring...';

    const encrypt = document.getElementById('encryptCheck').checked;
    const hash = await sha256(input);
    const txHash = 'TX' + Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join('').toUpperCase();
    const typeInfo = RECORD_TYPES[selectedType] || {label:selectedType,icon:'\uD83D\uDCCB',branch:'JOINT'};

    const clfLevel = getClassification(selectedType);
    showAnchorAnimation(hash, typeInfo.label, clfLevel);

    // POST to API (best-effort)
    const apiData = {hash, record_type:selectedType, tx_hash:txHash, content_preview:input.substring(0,100)};
    try { await fetch('/api/anchor',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(apiData)}); }
    catch(e) { console.warn('API anchor failed:', e); }

    const record = {
        type:selectedType, label:typeInfo.label, icon:typeInfo.icon, branch:typeInfo.branch,
        hash, txHash, encrypted:encrypt, timestamp:new Date().toISOString(),
        content:input.substring(0,100)+(input.length>100?'...':'')
    };
    sessionRecords.push(record);
    // Save to localStorage so Metrics & Transactions pages see it
    saveLocalRecord({
        hash, record_type: selectedType, record_label: typeInfo.label, branch: typeInfo.branch,
        icon: typeInfo.icon, timestamp: new Date().toISOString(),
        timestamp_display: new Date().toISOString().replace('T',' ').substring(0,19) + ' UTC',
        fee: 0.01, tx_hash: txHash, system: typeInfo.system || 'N/A'
    });
    stats.anchored++;
    stats.types.add(selectedType);
    stats.slsFees += 0.01;
    updateStats();
    saveStats();

    await new Promise(r => setTimeout(r, 3200));
    hideAnchorAnimation();
    await new Promise(r => setTimeout(r, 400));

    const panel = document.getElementById('anchorResult');
    panel.innerHTML = '<div class="result-label">STATUS</div><div class="result-value" style="font-size:1rem;margin-bottom:0.8rem">\u2705 Record anchored successfully</div>'
        + '<div class="result-label">RECORD TYPE</div><div style="margin-bottom:0.5rem">' + record.icon + ' ' + typeInfo.label + ' (' + typeInfo.branch + ')</div>'
        + '<div class="result-label">CLASSIFICATION</div><div style="margin-bottom:0.5rem"><span style="padding:3px 12px;border-radius:6px;font-size:0.8rem;font-weight:800;letter-spacing:0.5px;color:' + CLF_META[clfLevel].color + ';border:1px solid ' + CLF_META[clfLevel].color + '30;background:' + CLF_META[clfLevel].color + '15">' + CLF_META[clfLevel].icon + ' ' + CLF_META[clfLevel].label + '</span> <span style="color:var(--muted);font-size:0.8rem;margin-left:6px">' + CLF_META[clfLevel].desc + '</span></div>'
        + '<div class="result-label">SHA-256 HASH</div><div class="hash-display">' + hash + '</div>'
        + '<div class="result-label">TX HASH</div><div style="color:var(--muted);margin-bottom:0.5rem;word-break:break-all">' + txHash + '</div>'
        + '<div class="result-label">SYSTEM</div><div style="margin-bottom:0.5rem">' + (typeInfo.system||'N/A') + '</div>'
        + '<div class="result-label">ENCRYPTED</div><div style="margin-bottom:0.5rem">' + (encrypt ? '\uD83D\uDD12 Yes (CUI protected)' : '\uD83D\uDD13 No (plaintext hash)') + '</div>'
        + '<div class="result-label">$SLS FEE</div><div>0.01 $SLS \u2192 Treasury</div>';
    panel.classList.add('show');
    updateTxLog();
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-anchor"></i> Anchor to XRPL';
}

async function verifyRecord() {
    const input = document.getElementById('verifyInput').value.trim();
    if (!input) { alert('Please enter record content.'); return; }
    const hash = await sha256(input);
    const expected = document.getElementById('verifyHash').value.trim();
    stats.verified++;
    updateStats();
    saveStats();
    const panel = document.getElementById('verifyResult');
    let matchHtml = '';
    if (expected) {
        const match = hash.toLowerCase() === expected.toLowerCase();
        matchHtml = '<div class="result-label">EXPECTED</div><div style="color:var(--muted);word-break:break-all;margin-bottom:0.5rem">' + expected + '</div>'
            + '<div class="result-label">MATCH</div><div class="result-value ' + (match?'':'error') + '" style="font-size:1.1rem">'
            + (match ? '\u2705 VERIFIED \u2014 Hashes match. Record integrity confirmed.' : '\u274C MISMATCH \u2014 Record altered or wrong hash.') + '</div>';
    }
    const sessionMatch = sessionRecords.find(r => r.hash === hash);
    let sessionHtml = '';
    if (sessionMatch) {
        sessionHtml = '<div class="result-label" style="margin-top:0.8rem">SESSION MATCH</div>'
            + '<div style="color:var(--green)">\u2705 Found in session \u2014 ' + sessionMatch.icon + ' ' + sessionMatch.label + ' anchored at ' + new Date(sessionMatch.timestamp).toLocaleTimeString() + '</div>';
    }
    panel.innerHTML = '<div class="result-label">COMPUTED SHA-256 <button class="copy-btn" onclick="copyHash(\'' + hash + '\')"><i class="fas fa-copy"></i> Copy</button></div><div class="hash-display">' + hash + '</div>' + matchHtml + sessionHtml
        + '<div style="margin-top:0.8rem;font-size:0.8rem;color:var(--muted)">To verify on-chain: compare this hash with the MemoData field of the anchor transaction.</div>';
    panel.classList.add('show');
}

function updateTxLog() {
    const log = document.getElementById('txLog');
    if (!sessionRecords.length) return;
    log.innerHTML = '';
    for (let i = sessionRecords.length - 1; i >= 0; i--) {
        const r = sessionRecords[i];
        const time = new Date(r.timestamp).toLocaleTimeString('en-US',{hour12:false});
        log.innerHTML += '<div class="tx-entry"><div class="tx-icon">' + r.icon + '</div><div class="tx-info"><div class="tx-type">' + r.label + ' <span style="color:var(--muted);font-size:0.75rem">(' + r.branch + ')</span></div><div class="tx-hash">' + r.hash.substring(0,32) + '...</div></div><div><span class="tx-badge anchored">Anchored</span><div class="tx-time">' + time + '</div></div></div>';
    }
}

// ═══ ILS Intelligence Engine v2 — Document-Driven Gap Analysis ═══
let ilsFiles = [];
let ilsResults = null;

const ILS_EL = [
    {id:'ilsmgmt',label:'ILS Management / ILSP',crit:true},
    {id:'maint',label:'Maintenance Planning',crit:true},
    {id:'supply',label:'Supply Support',crit:true},
    {id:'se',label:'Support Equipment',crit:false},
    {id:'techdata',label:'Technical Data',crit:true},
    {id:'training',label:'Training & Training Support',crit:false},
    {id:'manpower',label:'Manpower & Personnel',crit:false},
    {id:'compres',label:'Computer Resources',crit:false},
    {id:'facilities',label:'Facilities',crit:false},
    {id:'phst',label:'PHS&T',crit:false},
    {id:'design',label:'Design Interface',crit:false},
    {id:'ram',label:'RAM Analysis',crit:true},
    {id:'config',label:'Configuration Management',crit:true}
];

const DI_MAP = {
    'DI-ILSS-81490':'ilsmgmt','DI-ILSS-81494':'maint','DI-ILSS-81492':'maint',
    'DI-ILSS-81493':'supply','DI-ILSS-81495':'supply','DI-ILSS-81496':'supply','DI-ILSS-81497':'supply',
    'DI-SESS-81519':'se','DI-TMSS-81000':'techdata','DI-TMSS-80063':'techdata','DI-TMSS-80000':'techdata',
    'DI-TRAN-81476':'training','DI-HFAC-80743':'manpower','DI-MCCR-80030':'compres',
    'DI-FACI-80931':'facilities','DI-PACK-80886':'phst','DI-MISC-80711':'design',
    'DI-RELI-80255':'ram','DI-RELI-81372':'ram','DI-CMAN-81250':'config','DI-CMAN-80858':'config',
    'DI-MGMT-81466':'ilsmgmt'
};

const OWNERS = {
    ilsmgmt:{p:'PMS / Program Office',s:'Contractor'},
    maint:{p:'Contractor (ILS)',s:'NAVSEA / SUPSHIP'},
    supply:{p:'Contractor (Provisioning)',s:'NAVSUP / DLA'},
    se:{p:'Contractor',s:'NAVSEA'},
    techdata:{p:'Contractor (Tech Pubs)',s:'NSWCCD / PMS'},
    training:{p:'NETC / Contractor',s:'PMS'},
    manpower:{p:'OPNAV N1 / PMS',s:'Contractor'},
    compres:{p:'Contractor',s:'NAVWAR / PMS'},
    facilities:{p:'NAVFAC',s:'PMS'},
    phst:{p:'Contractor',s:'NAVSEA / PMS'},
    design:{p:'Contractor (Engineering)',s:'NAVSEA'},
    ram:{p:'Contractor',s:'NAVSEA / PMS'},
    config:{p:'Contractor (CM)',s:'PMS / NAVSEA'}
};

const COST_K = {ilsmgmt:45,maint:120,supply:250,se:80,techdata:150,training:60,manpower:35,compres:25,facilities:40,phst:30,design:55,ram:95,config:110};

// ── Program DRL Templates ──
// s=sequence, di=DI number, t=title, el=ILS element, c=critical(1/0)
const PROGS = {
    yrbm:{name:'YRBM \u2014 Yard Repair, Berthing & Messing',ofc:'PMS 300',type:'Service Craft (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System (PMS) Development',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81496',t:'Allowance Parts List (APL)',el:'supply',c:1},
        {s:'A006',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operator/Crew',el:'techdata',c:1},
        {s:'A007',di:'DI-TMSS-80063',t:'Technical Manual Content Verification',el:'techdata',c:0},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Status Accounting Report',el:'config',c:1},
        {s:'A009',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:0},
        {s:'A010',di:'DI-TRAN-81476',t:'Training Plan (Crew Familiarization)',el:'training',c:0},
        {s:'A011',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A012',di:'DI-RELI-80255',t:'RAM Analysis / Reliability Report',el:'ram',c:1},
        {s:'A013',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A014',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:0},
        {s:'A015',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','ram']},
    apl:{name:'APL \u2014 Auxiliary Personnel Lighter',ofc:'PMS 300',type:'Service Craft (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting Report',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:0},
        {s:'A008',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','ram']},
    afdm:{name:'AFDM \u2014 Auxiliary Floating Drydock Medium',ofc:'PMS 300',type:'Floating Drydock',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis (LORA)',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-ILSS-81497',t:'Supply Support Request',el:'supply',c:0},
        {s:'A008',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Ops & Maintenance',el:'techdata',c:1},
        {s:'A009',di:'DI-TMSS-80063',t:'Technical Manual Content Verification',el:'techdata',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A011',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:1},
        {s:'A012',di:'DI-SESS-81519',t:'Support Equipment \u2014 Ballast/Crane Systems',el:'se',c:1},
        {s:'A013',di:'DI-TRAN-81476',t:'Training Plan \u2014 Operations & Safety',el:'training',c:1},
        {s:'A014',di:'DI-RELI-80255',t:'RAM Analysis Report',el:'ram',c:1},
        {s:'A015',di:'DI-RELI-81372',t:'Failure Reporting (FRACAS)',el:'ram',c:0},
        {s:'A016',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:0},
        {s:'A017',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A018',di:'DI-HFAC-80743',t:'Manpower & Personnel Report',el:'manpower',c:0},
        {s:'A019',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:1},
        {s:'A020',di:'DI-MCCR-80030',t:'Computer Resources LCMP',el:'compres',c:0},
        {s:'A021',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','se','techdata','training','ram','config','phst','design']},
    ydt:{name:'YDT \u2014 Large Harbor Tug',ofc:'PMS 300',type:'Service Craft (Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations & Propulsion',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan \u2014 Crew Operations',el:'training',c:1},
        {s:'A008',di:'DI-SESS-81519',t:'Support Equipment Recommendations',el:'se',c:0},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0},
        {s:'A012',di:'DI-MISC-80711',t:'Design Interface Document',el:'design',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','training','ram']},
    yon:{name:'YON \u2014 Fuel Oil Barge',ofc:'PMS 300',type:'Fuel Barge (Non-Self-Propelled)',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Recommended Spares List',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals \u2014 Operations & Safety',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Safety & Hazmat Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-PACK-80886',t:'PHS&T Plan (Fuel Handling)',el:'phst',c:1},
        {s:'A009',di:'DI-RELI-80255',t:'RAM Report',el:'ram',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','training','ram','phst']},
    ddg51:{name:'DDG-51 Flight III (Arleigh Burke)',ofc:'PMS 400D',type:'Guided Missile Destroyer',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-TMSS-81000',t:'Technical Manuals (Full Suite)',el:'techdata',c:1},
        {s:'A008',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A009',di:'DI-CMAN-80858',t:'Engineering Change Proposals',el:'config',c:1},
        {s:'A010',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A011',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A012',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A013',di:'DI-RELI-81372',t:'Failure Reporting (FRACAS)',el:'ram',c:1},
        {s:'A014',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:1},
        {s:'A015',di:'DI-MCCR-80030',t:'Computer Resources LCMP',el:'compres',c:1},
        {s:'A016',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:0},
        {s:'A017',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A018',di:'DI-MISC-80711',t:'Design Interface',el:'design',c:1},
        {s:'A019',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','se','techdata','training','manpower','compres','phst','design','ram','config']},
    lcs:{name:'LCS Freedom-class',ofc:'PMS 501',type:'Littoral Combat Ship',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:0},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','training','ram']},
    cvn78:{name:'CVN-78 Ford-class',ofc:'PMS 378',type:'Aircraft Carrier',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Planned Maintenance System',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81492',t:'Level of Repair Analysis',el:'maint',c:1},
        {s:'A004',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A005',di:'DI-ILSS-81495',t:'Vendor Recommended Spares',el:'supply',c:1},
        {s:'A006',di:'DI-ILSS-81496',t:'Allowance Parts List',el:'supply',c:1},
        {s:'A007',di:'DI-ILSS-81497',t:'Supply Support Request',el:'supply',c:1},
        {s:'A008',di:'DI-TMSS-81000',t:'Technical Manuals (Complete)',el:'techdata',c:1},
        {s:'A009',di:'DI-TMSS-80063',t:'TM Verification',el:'techdata',c:1},
        {s:'A010',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A011',di:'DI-CMAN-80858',t:'ECPs',el:'config',c:1},
        {s:'A012',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A013',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A014',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A015',di:'DI-RELI-81372',t:'FRACAS',el:'ram',c:1},
        {s:'A016',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:1},
        {s:'A017',di:'DI-MCCR-80030',t:'Computer Resources',el:'compres',c:1},
        {s:'A018',di:'DI-FACI-80931',t:'Facilities Requirements',el:'facilities',c:1},
        {s:'A019',di:'DI-PACK-80886',t:'PHS&T Plan',el:'phst',c:1},
        {s:'A020',di:'DI-MISC-80711',t:'Design Interface',el:'design',c:1},
        {s:'A021',di:'DI-MGMT-81466',t:'Program Management Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','se','techdata','training','manpower','compres','facilities','phst','design','ram','config']},
    ffg62:{name:'FFG-62 Constellation-class',ofc:'PMS 515',type:'Guided Missile Frigate',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:1},
        {s:'A010',di:'DI-HFAC-80743',t:'Manpower Report',el:'manpower',c:0},
        {s:'A011',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','se','techdata','training','ram','config']},
    lpd17:{name:'LPD-17 San Antonio-class',ofc:'PMS 317',type:'Amphibious Transport Dock',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Configuration Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-SESS-81519',t:'Support Equipment',el:'se',c:0},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','training','ram','config']},
    f35:{name:'F-35C Lightning II',ofc:'PMA-265 / JSF PO',type:'Carrier-Based Strike Fighter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan / ALIS Requirements',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals (IETM)',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM / PHM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MCCR-80030',t:'ALIS / ODIN LCMP',el:'compres',c:1},
        {s:'A010',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','training','ram','compres']},
    ch53k:{name:'CH-53K King Stallion',ofc:'PMA-261',type:'Heavy-Lift Helicopter',drls:[
        {s:'A001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'A002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'A003',di:'DI-ILSS-81493',t:'Provisioning Technical Documentation',el:'supply',c:1},
        {s:'A004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:1},
        {s:'A005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'A006',di:'DI-CMAN-81250',t:'Config Status Accounting',el:'config',c:1},
        {s:'A007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:1},
        {s:'A008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:1},
        {s:'A009',di:'DI-MGMT-81466',t:'Program Mgmt Plan',el:'ilsmgmt',c:0}
    ],req:['ilsmgmt','maint','supply','techdata','config','training','ram']},
    custom:{name:'Custom Program',ofc:'\u2014',type:'User-Defined',drls:[
        {s:'C001',di:'DI-ILSS-81490',t:'Integrated Logistics Support Plan',el:'ilsmgmt',c:1},
        {s:'C002',di:'DI-ILSS-81494',t:'Maintenance Plan',el:'maint',c:1},
        {s:'C003',di:'DI-ILSS-81493',t:'Provisioning Documentation',el:'supply',c:1},
        {s:'C004',di:'DI-ILSS-81495',t:'Vendor Spares',el:'supply',c:0},
        {s:'C005',di:'DI-TMSS-81000',t:'Technical Manuals',el:'techdata',c:1},
        {s:'C006',di:'DI-CMAN-81250',t:'Configuration Accounting',el:'config',c:0},
        {s:'C007',di:'DI-TRAN-81476',t:'Training Plan',el:'training',c:0},
        {s:'C008',di:'DI-RELI-80255',t:'RAM Analysis',el:'ram',c:0}
    ],req:['ilsmgmt','maint','supply','techdata']}
};

// ── File Upload Handling ──
function setupILSDropzone() {
    const dz = document.getElementById('ilsDropzone');
    if (!dz) return;
    ['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); }));
    dz.addEventListener('drop', e => handleILSFiles(e.dataTransfer.files));
}

function handleILSFiles(fileList) {
    Array.from(fileList).forEach(file => {
        const ext = file.name.split('.').pop().toLowerCase();
        if (!['csv','xlsx','xls','txt','tsv'].includes(ext)) { alert('Unsupported file type: .' + ext); return; }
        const reader = new FileReader();
        if (ext === 'xlsx' || ext === 'xls') {
            reader.onload = e => {
                const data = new Uint8Array(e.target.result);
                const parsed = parseExcelContent(data);
                const records = extractRecords(parsed);
                addILSFile(file.name, file.size, records, parsed.rows.length);
            };
            reader.readAsArrayBuffer(file);
        } else {
            reader.onload = e => {
                const text = e.target.result;
                const parsed = (ext === 'csv' || ext === 'tsv') ? parseCSVContent(text) : parseTextContent(text);
                const records = extractRecords(parsed);
                addILSFile(file.name, file.size, records, parsed.rows.length);
            };
            reader.readAsText(file);
        }
    });
}

function addILSFile(name, size, records, totalRows) {
    ilsFiles.push({ id: 'f_' + Date.now() + '_' + Math.random().toString(36).substr(2,4), name, size, records, totalRows });
    renderFileList();
    updateChecklistFromUploads();
}

function removeILSFile(id) {
    ilsFiles = ilsFiles.filter(f => f.id !== id);
    renderFileList();
    updateChecklistFromUploads();
}

function renderFileList() {
    const list = document.getElementById('ilsFileList');
    if (!list) return;
    if (!ilsFiles.length) { list.innerHTML = ''; return; }
    list.innerHTML = ilsFiles.map(f => {
        const sz = f.size > 1048576 ? (f.size/1048576).toFixed(1)+'MB' : (f.size/1024).toFixed(0)+'KB';
        const icon = /\.xlsx?$/i.test(f.name) ? 'fa-file-excel' : /\.csv$/i.test(f.name) ? 'fa-file-csv' : 'fa-file-alt';
        return '<div class="ils-file-item"><div class="file-info"><i class="fas '+icon+'" style="color:var(--accent);margin-right:8px"></i>'
            + '<span style="font-weight:600;color:#fff">'+f.name+'</span></div>'
            + '<div class="file-stats">'+f.records.length+' DRL items detected from '+f.totalRows+' rows \u00b7 '+sz+'</div>'
            + '<button class="file-remove" onclick="removeILSFile(\''+f.id+'\')">\u00d7</button></div>';
    }).join('');
}

// ── Parsers ──
function parseCSVContent(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    if (lines.length < 2) return { headers: [], rows: [] };
    const delim = (lines[0].match(/\t/g)||[]).length > (lines[0].match(/,/g)||[]).length ? '\t' : ',';
    function splitRow(line) {
        const res = []; let cur = '', inQ = false;
        for (let i = 0; i < line.length; i++) {
            const ch = line[i];
            if (ch === '"') { inQ = !inQ; }
            else if (ch === delim.charAt(0) && !inQ) { res.push(cur.trim()); cur = ''; }
            else { cur += ch; }
        }
        res.push(cur.trim());
        return res;
    }
    const headers = splitRow(lines[0]);
    const rows = lines.slice(1).map(l => {
        const cells = splitRow(l);
        return headers.reduce((o,h,i) => { o[h] = cells[i]||''; return o; }, {});
    }).filter(r => Object.values(r).some(v => v));
    return { headers, rows };
}

function parseExcelContent(data) {
    if (typeof XLSX === 'undefined') { alert('Excel parser not loaded. Please wait and try again.'); return { headers:[], rows:[] }; }
    try {
        const wb = XLSX.read(data, { type:'array' });
        let sheetName = wb.SheetNames.find(n => /drl|cdrl|ils|deliverable/i.test(n)) || wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const raw = XLSX.utils.sheet_to_json(ws, { header:1, defval:'' });
        if (raw.length < 2) return { headers:[], rows:[] };
        let hIdx = 0;
        for (let i = 0; i < Math.min(raw.length, 10); i++) {
            if (raw[i].filter(c => String(c).trim()).length >= 3) { hIdx = i; break; }
        }
        const headers = raw[hIdx].map(h => String(h).trim());
        const rows = raw.slice(hIdx+1).filter(r => r.some(c => String(c).trim())).map(r =>
            headers.reduce((o,h,i) => { o[h] = String(r[i]||'').trim(); return o; }, {})
        );
        return { headers, rows };
    } catch(e) { console.error('Excel parse error:', e); return { headers:[], rows:[] }; }
}

function parseTextContent(text) {
    const lines = text.split(/\r?\n/).filter(l => l.trim());
    const diPat = /DI-[A-Z]{4}-\d{5}/g;
    const records = [];
    lines.forEach(line => {
        const m = line.match(diPat);
        if (m) m.forEach(di => records.push({ 'DI': di, 'Title': line.trim().substring(0,120) }));
    });
    return { headers: ['DI','Title'], rows: records };
}

// ── Column Detection & Record Extraction ──
function detectColumns(headers) {
    const lh = headers.map(h => h.toLowerCase().replace(/[^a-z0-9\s]/g,''));
    return {
        seq: lh.findIndex(h => /cdrl|seq|line\s*item|exhibit|item\s*no/.test(h)),
        di: lh.findIndex(h => /\bdi\b|did\b|data\s*item/.test(h)),
        title: lh.findIndex(h => /title|description|name|data\s*product/.test(h)),
        status: lh.findIndex(h => /status|state|deliverable\s*status|approval/.test(h)),
        due: lh.findIndex(h => /due|date|deadline|submit|required\s*date/.test(h)),
        contractor: lh.findIndex(h => /contractor|vendor|supplier/.test(h))
    };
}

function extractRecords(parsed) {
    if (!parsed.rows.length) return [];
    const cols = detectColumns(parsed.headers);
    const records = [];
    parsed.rows.forEach(row => {
        let seq = '', di = '', title = '', status = '', due = '';
        if (cols.seq >= 0) seq = row[parsed.headers[cols.seq]] || '';
        if (cols.di >= 0) di = row[parsed.headers[cols.di]] || '';
        if (cols.title >= 0) title = row[parsed.headers[cols.title]] || '';
        if (cols.status >= 0) status = row[parsed.headers[cols.status]] || '';
        if (cols.due >= 0) due = row[parsed.headers[cols.due]] || '';
        if (!di) { Object.values(row).forEach(v => { const m = String(v).match(/DI-[A-Z]{4}-\d{5}/); if (m && !di) di = m[0]; }); }
        if (!title) { title = Object.values(row).reduce((best,v) => { const s = String(v); return (s.length > best.length && !/^DI-/.test(s) && !/^[A-C]\d{3}$/.test(s)) ? s : best; }, ''); }
        const element = di ? (DI_MAP[di] || guessElement(title)) : guessElement(title);
        if (di || (title && title.length > 3)) records.push({ seq, di, title, status: status.toLowerCase(), due, element });
    });
    return records;
}

function guessElement(t) {
    t = t.toLowerCase();
    if (/ils\s*p|logistics\s*support\s*plan|program\s*mgmt|program\s*management/.test(t)) return 'ilsmgmt';
    if (/maintenance|pms\b|mrc\b|mip\b|planned\s*maint/.test(t)) return 'maint';
    if (/supply|spare|provisioning|buylist|allowance|apl\b|cosal/.test(t)) return 'supply';
    if (/support\s*equip|se\b|tools|test\s*equip/.test(t)) return 'se';
    if (/technical\s*(manual|data|pub)|tm\b|ietm|tech\s*data/.test(t)) return 'techdata';
    if (/training|trainer|course|curriculum|school/.test(t)) return 'training';
    if (/manpower|personnel|manning|billet/.test(t)) return 'manpower';
    if (/computer|software|cyber|alis|odin/.test(t)) return 'compres';
    if (/facilit|shore\s*infra/.test(t)) return 'facilities';
    if (/phs.?t|packaging|handling|storage|transport|hazmat/.test(t)) return 'phst';
    if (/design\s*interface|interface\s*doc/.test(t)) return 'design';
    if (/ram\b|reliab|avail|maintain|fmeca|fracas|failure/.test(t)) return 'ram';
    if (/config|baseline|ecp|engineering\s*change/.test(t)) return 'config';
    return '';
}

function fuzzyMatch(a, b) {
    const wa = a.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(w => w.length > 3);
    const wb = b.toLowerCase().replace(/[^a-z0-9\s]/g,'').split(/\s+/).filter(w => w.length > 3);
    if (!wa.length || !wb.length) return false;
    return wa.filter(w => wb.includes(w)).length >= Math.min(2, Math.ceil(wb.length * 0.4));
}

// ── Checklist & Program Handlers ──
function updateChecklistFromUploads() {
    const found = new Set();
    ilsFiles.forEach(f => f.records.forEach(r => { if (r.element) found.add(r.element); }));
    ILS_EL.forEach(el => { const cb = document.getElementById('ils_' + el.id); if (cb && found.has(el.id)) cb.checked = true; });
}

function onILSProgramChange() {
    const key = document.getElementById('ilsProgram').value;
    const prog = PROGS[key];
    if (!prog) return;
    const ofc = document.getElementById('ilsOffice');
    if (ofc) ofc.value = prog.ofc;
    ILS_EL.forEach(el => { const cb = document.getElementById('ils_' + el.id); if (cb) cb.checked = prog.req.includes(el.id); });
    updateChecklistFromUploads();
}

// ── Analysis Engine ──
function runFullILSAnalysis() {
    const progKey = document.getElementById('ilsProgram').value;
    const prog = PROGS[progKey];
    if (!prog) { alert('Please select a program.'); return; }
    const hull = document.getElementById('ilsHull')?.value || '';
    const phase = document.getElementById('ilsPhase')?.value || 'design';

    const allRecs = [];
    ilsFiles.forEach(f => allRecs.push(...f.records));
    const manualChecked = new Set();
    ILS_EL.forEach(el => { const cb = document.getElementById('ils_' + el.id); if (cb && cb.checked) manualChecked.add(el.id); });

    const coverage = {};
    ILS_EL.forEach(el => {
        const reqDrls = prog.drls.filter(d => d.el === el.id);
        const foundDrls = reqDrls.map(d => {
            const match = allRecs.find(r =>
                (r.di && r.di === d.di) ||
                (r.seq && r.seq === d.s) ||
                (r.title && fuzzyMatch(r.title, d.t))
            );
            return { ...d, found: !!match, status: match ? (match.status || 'detected') : 'missing', due: match?.due || '' };
        });
        const isReq = prog.req.includes(el.id);
        const present = foundDrls.filter(d => d.found).length;
        const total = foundDrls.length;
        const hasManual = manualChecked.has(el.id);
        const pct = total > 0 ? Math.round((present / total) * 100) : (hasManual ? 50 : 0);
        coverage[el.id] = { required: isReq, total, present, pct, drls: foundDrls, manual: hasManual };
    });

    const actions = [];
    let gapN = 1;
    Object.entries(coverage).forEach(([elId, cov]) => {
        cov.drls.forEach(d => {
            if (!d.found) {
                actions.push({
                    id: 'GAP-' + String(gapN++).padStart(3,'0'), el: elId,
                    elLabel: ILS_EL.find(e=>e.id===elId)?.label, title: d.t, di: d.di, seq: d.s,
                    severity: d.c ? 'critical' : 'warning',
                    owner: OWNERS[elId]?.p||'TBD', secondary: OWNERS[elId]?.s||'',
                    action: 'Request submission of ' + d.di + ' \u2014 ' + d.t,
                    cost: COST_K[elId]||0, schedule: d.c ? '2-4 months' : '1-2 months'
                });
            } else if (/overdue|late|reject|disapprov/.test(d.status)) {
                actions.push({
                    id: 'ACT-' + String(gapN++).padStart(3,'0'), el: elId,
                    elLabel: ILS_EL.find(e=>e.id===elId)?.label, title: d.t + ' \u2014 ' + d.status.toUpperCase(),
                    di: d.di, seq: d.s, severity: d.c ? 'critical' : 'warning',
                    owner: OWNERS[elId]?.p||'TBD', secondary: OWNERS[elId]?.s||'',
                    action: /reject|disapprov/.test(d.status) ? 'Review comments & resubmit '+d.di : 'Issue CAR for late delivery of '+d.di,
                    cost: Math.round((COST_K[elId]||0)*0.5), schedule: d.c ? '1-3 months' : '2-4 weeks'
                });
            }
        });
    });
    actions.sort((a,b) => (a.severity==='critical'?0:1)-(b.severity==='critical'?0:1));

    const reqEls = ILS_EL.filter(e => coverage[e.id]?.required);
    const totalReq = reqEls.reduce((s,e) => s + coverage[e.id].total, 0);
    const foundReq = reqEls.reduce((s,e) => s + coverage[e.id].present, 0);
    const pct = totalReq > 0 ? Math.round((foundReq/totalReq)*100) : 0;
    const critGaps = actions.filter(a => a.severity==='critical').length;
    const totalCost = actions.reduce((s,a) => s + a.cost, 0);

    ilsResults = { coverage, actions, pct, totalReq, foundReq, critGaps, totalCost, prog, hull, phase, progKey };

    renderILSScore(pct, critGaps);
    renderILSCoverage(coverage);
    renderILSActions(actions);
    renderILSCost(actions, totalCost, critGaps);
    renderILSResult();
}

// ── Render Functions ──
function renderILSScore(pct, critGaps) {
    const s = document.getElementById('ilsScore'), l = document.getElementById('ilsScoreLabel'), f = document.getElementById('ilsGaugeFill');
    if (!s) return;
    s.textContent = pct + '%';
    s.style.color = pct >= 80 ? '#14f195' : pct >= 50 ? '#ffa500' : '#ff3333';
    l.textContent = pct >= 80 ? 'ILS Package: Mission Ready' : pct >= 50 ? 'Gaps Identified (' + critGaps + ' critical)' : 'Critical Gaps (' + critGaps + ' items require action)';
    f.style.width = pct + '%';
}

function renderILSCoverage(coverage) {
    const el = document.getElementById('ilsCoverage');
    if (!el) return;
    el.innerHTML = ILS_EL.map(e => {
        const c = coverage[e.id];
        if (!c || (!c.required && !c.total)) return '';
        const color = c.pct >= 80 ? '#14f195' : c.pct >= 40 ? '#ffa500' : '#ff3333';
        const icon = c.pct >= 80 ? 'fa-check-circle' : c.pct >= 40 ? 'fa-exclamation-circle' : 'fa-times-circle';
        return '<div class="ils-coverage-row">'
            + '<div style="display:flex;justify-content:space-between;margin-bottom:3px">'
            + '<span><i class="fas '+icon+'" style="color:'+color+';margin-right:4px;font-size:0.8rem"></i>'+(e.crit?'<strong>':'')+e.label+(e.crit?'</strong>':'')+'</span>'
            + '<span style="color:var(--muted)">'+c.present+'/'+c.total+'</span></div>'
            + '<div class="ils-coverage-bar"><div class="ils-coverage-fill" style="width:'+c.pct+'%;background:'+color+'"></div></div></div>';
    }).filter(Boolean).join('');
}

function renderILSActions(actions) {
    const el = document.getElementById('ilsActions');
    if (!el) return;
    if (!actions.length) {
        el.innerHTML = '<div style="color:var(--green);text-align:center;padding:1rem"><i class="fas fa-check-circle" style="font-size:1.5rem;display:block;margin-bottom:6px"></i>No gaps detected. ILS package appears complete.</div>';
        return;
    }
    const crit = actions.filter(a => a.severity==='critical'), warn = actions.filter(a => a.severity==='warning');
    let html = '';
    if (crit.length) {
        html += '<div style="color:var(--red);font-weight:700;margin-bottom:6px;font-size:0.82rem"><i class="fas fa-skull-crossbones"></i> CRITICAL (' + crit.length + ')</div>';
        html += crit.map(renderActionItem).join('');
    }
    if (warn.length) {
        html += '<div style="color:#ffa500;font-weight:700;margin:8px 0 6px;font-size:0.82rem"><i class="fas fa-exclamation-triangle"></i> WARNING (' + warn.length + ')</div>';
        html += warn.map(renderActionItem).join('');
    }
    el.innerHTML = html;
}

function renderActionItem(a) {
    return '<div class="ils-action-item '+(a.severity==='critical'?'critical':'warning')+'">'
        + '<div class="action-header"><span class="action-title">'+a.id+': '+a.title+'</span><span class="action-owner">'+a.owner+'</span></div>'
        + '<div class="action-detail"><strong>DI:</strong> '+a.di+' &middot; <strong>Action:</strong> '+a.action+'</div>'
        + '<div class="action-detail"><strong>Est. Cost Impact:</strong> $'+a.cost+'K &middot; <strong>Schedule Risk:</strong> '+a.schedule
        + (a.secondary ? ' &middot; <strong>Coord:</strong> '+a.secondary : '') + '</div></div>';
}

function renderILSCost(actions, totalCost, critGaps) {
    const el = document.getElementById('ilsCostSchedule');
    if (!el) return;
    if (!actions.length) { el.innerHTML = '<div style="color:var(--green);text-align:center;padding:0.5rem"><i class="fas fa-check-circle"></i> No cost or schedule risk identified.</div>'; return; }
    const maxSch = critGaps > 3 ? '6-12 months' : critGaps > 0 ? '2-6 months' : '< 2 months';
    el.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">'
        + '<div style="background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:12px;text-align:center">'
        + '<div style="font-size:1.5rem;font-weight:800;color:#ff3333">$'+totalCost+'K</div><div style="font-size:0.75rem;color:var(--muted)">Est. Risk Cost</div></div>'
        + '<div style="background:rgba(255,165,0,0.08);border:1px solid rgba(255,165,0,0.2);border-radius:8px;padding:12px;text-align:center">'
        + '<div style="font-size:1.5rem;font-weight:800;color:#ffa500">'+maxSch+'</div><div style="font-size:0.75rem;color:var(--muted)">Schedule Risk</div></div></div>'
        + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'
        + '<div style="text-align:center;padding:8px"><div style="font-size:1.2rem;font-weight:700;color:#ff3333">'+critGaps+'</div><div style="font-size:0.75rem;color:var(--muted)">Critical Path Items</div></div>'
        + '<div style="text-align:center;padding:8px"><div style="font-size:1.2rem;font-weight:700;color:#ffa500">'+actions.length+'</div><div style="font-size:0.75rem;color:var(--muted)">Total Action Items</div></div></div>';
}

function renderILSResult() {
    if (!ilsResults) return;
    const r = ilsResults;
    const panel = document.getElementById('ilsResult');
    const progStr = r.prog.name + (r.hull ? ' \u2014 ' + r.hull : '');
    const phaseStr = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || '';
    panel.innerHTML = '<div class="result-label">ILS ANALYSIS \u2014 ' + progStr.toUpperCase() + '</div>'
        + '<div style="margin:0.5rem 0;font-size:0.85rem;color:var(--muted)">Office: '+r.prog.ofc+' \u00b7 Phase: '+phaseStr+' \u00b7 Files Analyzed: '+ilsFiles.length+'</div>'
        + '<div style="margin:0.8rem 0"><span style="font-size:1.3rem;font-weight:800;color:'+(r.pct>=80?'var(--green)':r.pct>=50?'#ffa500':'var(--red)')+'">'+r.pct+'% DRL Coverage</span>'
        + '<span style="margin-left:12px;color:var(--muted)">'+r.foundReq+'/'+r.totalReq+' required items verified</span></div>'
        + (r.critGaps > 0
            ? '<div style="background:rgba(255,51,51,0.08);border:1px solid rgba(255,51,51,0.2);border-radius:8px;padding:10px;margin:0.8rem 0;font-size:0.88rem"><i class="fas fa-exclamation-triangle" style="color:#ff3333"></i> <strong style="color:#ff3333">'+r.critGaps+' critical gap'+(r.critGaps>1?'s':'')+' found</strong> \u2014 Estimated risk cost: <strong>$'+r.totalCost+'K</strong>. See Action Items panel for details and responsible parties.</div>'
            : '<div style="background:rgba(20,241,149,0.08);border:1px solid rgba(20,241,149,0.2);border-radius:8px;padding:10px;margin:0.8rem 0;font-size:0.88rem"><i class="fas fa-check-circle" style="color:var(--green)"></i> <strong style="color:var(--green)">All required DRL items accounted for.</strong> Package appears ready for review.</div>')
        + '<div style="margin-top:1rem;font-size:0.78rem;color:var(--muted)">Analysis based on DoD 5000 series ILS requirements per program type. Always verify against your specific contract DRL.</div>';
    panel.classList.add('show');
}

// ── Report Generation ──
function generateILSReport() {
    if (!ilsResults) { runFullILSAnalysis(); }
    if (!ilsResults) { alert('Please select a program and run analysis first.'); return; }
    const r = ilsResults, prog = r.prog;
    const phaseStr = document.getElementById('ilsPhase')?.selectedOptions[0]?.text || '';
    const now = new Date();

    let rpt = '\u2550'.repeat(65) + '\n';
    rpt += '  S4 LEDGER \u2014 ILS DATA PACKAGE GAP ANALYSIS REPORT\n';
    rpt += '\u2550'.repeat(65) + '\n\n';
    rpt += 'Program:        ' + prog.name + (r.hull ? ' (' + r.hull + ')' : '') + '\n';
    rpt += 'Program Office: ' + prog.ofc + '\n';
    rpt += 'Vessel Type:    ' + prog.type + '\n';
    rpt += 'Phase:          ' + phaseStr + '\n';
    rpt += 'Report Date:    ' + now.toISOString().split('T')[0] + '\n';
    rpt += 'Analyst Tool:   S4 Ledger ILS Intelligence v2.0\n';
    rpt += 'Classification: UNCLASSIFIED\n\n';
    rpt += '\u2500'.repeat(65) + '\n';
    rpt += '  OVERALL DRL COVERAGE:  ' + r.pct + '%\n';
    rpt += '  Required Items Found:  ' + r.foundReq + ' / ' + r.totalReq + '\n';
    rpt += '  Critical Gaps:         ' + r.critGaps + '\n';
    rpt += '  Total Action Items:    ' + r.actions.length + '\n';
    rpt += '  Est. Risk Cost:        $' + r.totalCost + 'K\n';
    rpt += '\u2500'.repeat(65) + '\n\n';

    rpt += 'DOCUMENTS ANALYZED (' + ilsFiles.length + '):\n';
    if (ilsFiles.length) ilsFiles.forEach(f => { rpt += '  \u2022 ' + f.name + ' \u2014 ' + f.records.length + ' items detected\n'; });
    else rpt += '  (No files uploaded \u2014 analysis based on manual checklist only)\n';

    rpt += '\n\nILS ELEMENT COVERAGE:\n' + '\u2500'.repeat(65) + '\n';
    ILS_EL.forEach(e => {
        const c = r.coverage[e.id]; if (!c) return;
        const bar = '\u2588'.repeat(Math.round(c.pct/5)) + '\u2591'.repeat(20-Math.round(c.pct/5));
        rpt += '  [' + (c.required?'REQ':'OPT') + '] ' + e.label.padEnd(36) + bar + ' ' + String(c.pct).padStart(3) + '% (' + c.present + '/' + c.total + ')\n';
    });

    if (r.actions.length) {
        rpt += '\n\nACTION ITEMS:\n' + '\u2550'.repeat(65) + '\n';
        r.actions.forEach(a => {
            rpt += '\n  ' + a.id + ' [' + a.severity.toUpperCase() + ']\n';
            rpt += '  Element:     ' + (a.elLabel||'') + '\n';
            rpt += '  DI Number:   ' + a.di + '\n';
            rpt += '  Item:        ' + a.title + '\n';
            rpt += '  Action:      ' + a.action + '\n';
            rpt += '  Responsible: ' + a.owner + (a.secondary ? ' (Coord: ' + a.secondary + ')' : '') + '\n';
            rpt += '  Cost Impact: $' + a.cost + 'K   Schedule Risk: ' + a.schedule + '\n';
            rpt += '  ' + '\u2500'.repeat(50) + '\n';
        });
    } else {
        rpt += '\n\n  \u2713 No action items. All required DRL items accounted for.\n';
    }

    rpt += '\n\n' + '\u2500'.repeat(65) + '\n  RECOMMENDATIONS:\n';
    if (r.critGaps > 0) {
        rpt += '  1. Address all CRITICAL action items before next milestone review.\n';
        rpt += '  2. Issue Corrective Action Requests (CARs) for missing deliverables.\n';
        rpt += '  3. Schedule ILS Review Board to discuss gaps with contractor.\n';
        rpt += '  4. Update program risk register with identified cost/schedule impacts.\n';
    } else {
        rpt += '  1. Conduct final review of all deliverables for completeness.\n';
        rpt += '  2. Verify configuration baseline matches as-built documentation.\n';
        rpt += '  3. Proceed to next milestone with ILS package approval.\n';
    }
    rpt += '\n' + '\u2500'.repeat(65) + '\n  Generated by S4 Ledger | s4ledger.com\n';
    rpt += '  Hash-verified logistics for the defense industry\n' + '\u2550'.repeat(65) + '\n';

    // Download as file
    const blob = new Blob([rpt], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url;
    a.download = 'ILS_Gap_Analysis_' + r.progKey.toUpperCase() + '_' + now.toISOString().split('T')[0] + '.txt';
    a.click(); URL.revokeObjectURL(url);

    const panel = document.getElementById('ilsResult');
    panel.innerHTML = '<div style="color:var(--green);font-size:0.95rem;font-weight:700;margin-bottom:8px"><i class="fas fa-download"></i> Report downloaded!</div>'
        + '<pre style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:1rem;font-size:0.7rem;color:var(--steel);max-height:300px;overflow-y:auto;white-space:pre-wrap">' + rpt + '</pre>'
        + '<button style="margin-top:8px;background:rgba(0,170,255,0.1);border:1px solid rgba(0,170,255,0.3);color:var(--accent);border-radius:6px;padding:6px 16px;cursor:pointer;font-family:inherit;font-size:0.82rem;font-weight:600" onclick="navigator.clipboard.writeText(document.querySelector(\'#ilsResult pre\').textContent).then(()=>this.innerHTML=\'<i class=\\\'fas fa-check\\\'></i> Copied!\')"><i class="fas fa-copy"></i> Copy to Clipboard</button>';
    panel.classList.add('show');
}

async function anchorILSReport() {
    if (!ilsResults) { runFullILSAnalysis(); }
    if (!ilsResults) return;
    const reportStr = JSON.stringify({
        program: ilsResults.prog.name, hull: ilsResults.hull, score: ilsResults.pct,
        critGaps: ilsResults.critGaps, totalActions: ilsResults.actions.length,
        riskCost: ilsResults.totalCost, date: new Date().toISOString(), files: ilsFiles.map(f => f.name)
    });
    const hash = await sha256(reportStr);
    const panel = document.getElementById('ilsResult');
    panel.innerHTML = '<div class="result-label">ILS REPORT HASH ANCHORED</div>'
        + '<div style="color:var(--green);font-weight:700;margin:0.5rem 0"><i class="fas fa-check-circle"></i> Report hash computed & ready for XRPL anchor</div>'
        + '<div class="result-label" style="margin-top:0.8rem">SHA-256 HASH</div><div class="hash-display">' + hash + '</div>'
        + '<div style="margin-top:0.8rem;font-size:0.82rem;color:var(--muted)">This hash verifies the state of your ILS analysis at this point in time. Anchor it to XRPL using the Anchor tab for immutable proof.</div>';
    panel.classList.add('show');
}

// ── Initialization ──
function initILSChecklist() {
    const container = document.getElementById('ilsChecklist');
    if (!container) return;
    container.innerHTML = ILS_EL.map(el =>
        '<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:4px 6px;border-radius:6px;transition:background 0.2s;'+(el.crit?'font-weight:600':'')+'" onmouseover="this.style.background=\'rgba(0,170,255,0.05)\'" onmouseout="this.style.background=\'transparent\'">'
        + '<input type="checkbox" id="ils_'+el.id+'" style="width:auto!important;accent-color:var(--accent)">'
        + '<span>' + el.label + (el.crit?' <span style="color:var(--red);font-size:0.7rem">CRITICAL</span>':'') + '</span></label>'
    ).join('');
}

document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    renderTypeGrid();
    loadSample('supply');
    initILSChecklist();
    setupILSDropzone();
    onILSProgramChange();
});
</script>
<script>
if(typeof particlesJS!=='undefined'&&document.getElementById('particles-js')){particlesJS('particles-js',{particles:{number:{value:35},color:{value:'#00aaff'},opacity:{value:0.12},size:{value:2},line_linked:{enable:true,distance:150,color:'#00aaff',opacity:0.06,width:1},move:{enable:true,speed:0.7}},interactivity:{events:{onhover:{enable:true,mode:'grab'}},modes:{grab:{distance:130,line_linked:{opacity:0.15}}}}});}
</script>

<button id="backToTop" onclick="window.scrollTo({top:0,behavior:'smooth'})" style="position:fixed;bottom:30px;right:30px;width:45px;height:45px;background:linear-gradient(135deg,#00aaff,#c9a84c);border:none;border-radius:50%;color:#fff;font-size:1.3rem;cursor:pointer;opacity:0;visibility:hidden;transition:all 0.3s;z-index:999;display:flex;align-items:center;justify-content:center;">&uarr;</button>
<script>
// Scroll progress bar
window.addEventListener('scroll', function() {
    var scroll = window.scrollY;
    var height = document.documentElement.scrollHeight - window.innerHeight;
    var bar = document.getElementById('scrollProgress');
    if (bar) bar.style.width = (height > 0 ? (scroll / height * 100) : 0) + '%';
    var btn = document.getElementById('backToTop');
    if (btn) { if (scroll > 400) { btn.style.opacity='1'; btn.style.visibility='visible'; } else { btn.style.opacity='0'; btn.style.visibility='hidden'; } }
});
// Reveal on scroll
var revealObserver = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) { if (entry.isIntersecting) entry.target.classList.add('visible'); });
}, { threshold: 0.1 });
document.querySelectorAll('.reveal-demo').forEach(function(el) { revealObserver.observe(el); });
</script>
</body>
</html>
